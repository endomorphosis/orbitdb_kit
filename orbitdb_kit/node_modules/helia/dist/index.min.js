(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.Helia = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var Helia=(()=>{var ZF=Object.create;var e0=Object.defineProperty;var eV=Object.getOwnPropertyDescriptor;var tV=Object.getOwnPropertyNames;var rV=Object.getPrototypeOf,nV=Object.prototype.hasOwnProperty;var Wv=(r=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(r,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):r)(function(r){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+r+'" is not supported')});var st=(r,e)=>()=>(r&&(e=r(r=0)),e);var Y=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),V=(r,e)=>{for(var t in e)e0(r,t,{get:e[t],enumerable:!0})},Yv=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of tV(e))!nV.call(r,s)&&s!==t&&e0(r,s,{get:()=>e[s],enumerable:!(n=eV(e,s))||n.enumerable});return r};var fe=(r,e,t)=>(t=r!=null?ZF(rV(r)):{},Yv(e||!r||!r.__esModule?e0(t,"default",{value:r,enumerable:!0}):t,r)),t0=r=>Yv(e0({},"__esModule",{value:!0}),r);var No=Y((Vue,Qv)=>{"use strict";function jv(r,e){for(let t in e)Object.defineProperty(r,t,{value:e[t],enumerable:!0,configurable:!0});return r}function sV(r,e,t){if(!r||typeof r=="string")throw new TypeError("Please pass an Error to err-code");t||(t={}),typeof e=="object"&&(t=e,e=""),e&&(t.code=e);try{return jv(r,t)}catch{t.message=r.message,t.stack=r.stack;let s=function(){};return s.prototype=Object.create(Object.getPrototypeOf(r)),jv(new s,t)}}Qv.exports=sV});var x3=Y((ffe,f9)=>{var Il=1e3,Tl=Il*60,kl=Tl*60,tc=kl*24,WV=tc*7,YV=tc*365.25;f9.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return jV(r);if(t==="number"&&isFinite(r))return e.long?XV(r):QV(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function jV(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(e){var t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*YV;case"weeks":case"week":case"w":return t*WV;case"days":case"day":case"d":return t*tc;case"hours":case"hour":case"hrs":case"hr":case"h":return t*kl;case"minutes":case"minute":case"mins":case"min":case"m":return t*Tl;case"seconds":case"second":case"secs":case"sec":case"s":return t*Il;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function QV(r){var e=Math.abs(r);return e>=tc?Math.round(r/tc)+"d":e>=kl?Math.round(r/kl)+"h":e>=Tl?Math.round(r/Tl)+"m":e>=Il?Math.round(r/Il)+"s":r+"ms"}function XV(r){var e=Math.abs(r);return e>=tc?s0(r,e,tc,"day"):e>=kl?s0(r,e,kl,"hour"):e>=Tl?s0(r,e,Tl,"minute"):e>=Il?s0(r,e,Il,"second"):r+" ms"}function s0(r,e,t,n){var s=e>=t*1.5;return Math.round(r/t)+" "+n+(s?"s":"")}});var p9=Y((hfe,h9)=>{function JV(r){t.debug=t,t.default=t,t.coerce=c,t.disable=o,t.enable=s,t.enabled=i,t.humanize=x3(),t.destroy=l,Object.keys(r).forEach(u=>{t[u]=r[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let f=0;for(let h=0;h<u.length;h++)f=(f<<5)-f+u.charCodeAt(h),f|=0;return t.colors[Math.abs(f)%t.colors.length]}t.selectColor=e;function t(u){let f,h=null,d,p;function m(...y){if(!m.enabled)return;let b=m,w=Number(new Date),E=w-(f||w);b.diff=E,b.prev=f,b.curr=w,f=w,y[0]=t.coerce(y[0]),typeof y[0]!="string"&&y.unshift("%O");let x=0;y[0]=y[0].replace(/%([a-zA-Z%])/g,(S,A)=>{if(S==="%%")return"%";x++;let _=t.formatters[A];if(typeof _=="function"){let D=y[x];S=_.call(b,D),y.splice(x,1),x--}return S}),t.formatArgs.call(b,y),(b.log||t.log).apply(b,y)}return m.namespace=u,m.useColors=t.useColors(),m.color=t.selectColor(u),m.extend=n,m.destroy=t.destroy,Object.defineProperty(m,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(d!==t.namespaces&&(d=t.namespaces,p=t.enabled(u)),p),set:y=>{h=y}}),typeof t.init=="function"&&t.init(m),m}function n(u,f){let h=t(this.namespace+(typeof f>"u"?":":f)+u);return h.log=this.log,h}function s(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let f,h=(typeof u=="string"?u:"").split(/[\s,]+/),d=h.length;for(f=0;f<d;f++)h[f]&&(u=h[f].replace(/\*/g,".*?"),u[0]==="-"?t.skips.push(new RegExp("^"+u.slice(1)+"$")):t.names.push(new RegExp("^"+u+"$")))}function o(){let u=[...t.names.map(a),...t.skips.map(a).map(f=>"-"+f)].join(",");return t.enable(""),u}function i(u){if(u[u.length-1]==="*")return!0;let f,h;for(f=0,h=t.skips.length;f<h;f++)if(t.skips[f].test(u))return!1;for(f=0,h=t.names.length;f<h;f++)if(t.names[f].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function c(u){return u instanceof Error?u.stack||u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}h9.exports=JV});var i0=Y((mn,o0)=>{mn.formatArgs=eq;mn.save=tq;mn.load=rq;mn.useColors=ZV;mn.storage=nq();mn.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();mn.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function ZV(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function eq(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+o0.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(n=t))}),r.splice(n,0,e)}mn.log=console.debug||console.log||(()=>{});function tq(r){try{r?mn.storage.setItem("debug",r):mn.storage.removeItem("debug")}catch{}}function rq(){let r;try{r=mn.storage.getItem("debug")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function nq(){try{return localStorage}catch{}}o0.exports=p9()(mn);var{formatters:sq}=o0.exports;sq.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var J9=Y((Vde,X9)=>{X9.exports=Q9;var j9=128,BH=127,NH=~BH,LH=Math.pow(2,31);function Q9(r,e,t){e=e||[],t=t||0;for(var n=t;r>=LH;)e[t++]=r&255|j9,r/=128;for(;r&NH;)e[t++]=r&255|j9,r>>>=7;return e[t]=r|0,Q9.bytes=t-n+1,e}});var tx=Y((qde,ex)=>{ex.exports=e4;var OH=128,Z9=127;function e4(r,n){var t=0,n=n||0,s=0,o=n,i,a=r.length;do{if(o>=a)throw e4.bytes=0,new RangeError("Could not decode varint");i=r[o++],t+=s<28?(i&Z9)<<s:(i&Z9)*Math.pow(2,s),s+=7}while(i>=OH);return e4.bytes=o-n,t}});var nx=Y((Hde,rx)=>{var KH=Math.pow(2,7),MH=Math.pow(2,14),UH=Math.pow(2,21),FH=Math.pow(2,28),VH=Math.pow(2,35),qH=Math.pow(2,42),HH=Math.pow(2,49),zH=Math.pow(2,56),$H=Math.pow(2,63);rx.exports=function(r){return r<KH?1:r<MH?2:r<UH?3:r<FH?4:r<VH?5:r<qH?6:r<HH?7:r<zH?8:r<$H?9:10}});var ox=Y((zde,sx)=>{sx.exports={encode:J9(),decode:tx(),encodingLength:nx()}});var cx=Y(($de,ax)=>{"use strict";var ix=ox();ax.exports=r=>{if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");let e=[];for(;r.length>0;){let t=ix.decode(r);e.push(t),r=r.slice(ix.decode.bytes)}return e}});var hx=Y((r0e,fx)=>{fx.exports=t4;var ux=128,GH=127,WH=~GH,YH=Math.pow(2,31);function t4(r,e,t){if(Number.MAX_SAFE_INTEGER&&r>Number.MAX_SAFE_INTEGER)throw t4.bytes=0,new RangeError("Could not encode varint");e=e||[],t=t||0;for(var n=t;r>=YH;)e[t++]=r&255|ux,r/=128;for(;r&WH;)e[t++]=r&255|ux,r>>>=7;return e[t]=r|0,t4.bytes=t-n+1,e}});var mx=Y((n0e,dx)=>{dx.exports=r4;var jH=128,px=127;function r4(r,n){var t=0,n=n||0,s=0,o=n,i,a=r.length;do{if(o>=a||s>49)throw r4.bytes=0,new RangeError("Could not decode varint");i=r[o++],t+=s<28?(i&px)<<s:(i&px)*Math.pow(2,s),s+=7}while(i>=jH);return r4.bytes=o-n,t}});var gx=Y((s0e,yx)=>{var QH=Math.pow(2,7),XH=Math.pow(2,14),JH=Math.pow(2,21),ZH=Math.pow(2,28),ez=Math.pow(2,35),tz=Math.pow(2,42),rz=Math.pow(2,49),nz=Math.pow(2,56),sz=Math.pow(2,63);yx.exports=function(r){return r<QH?1:r<XH?2:r<JH?3:r<ZH?4:r<ez?5:r<tz?6:r<rz?7:r<nz?8:r<sz?9:10}});var wx=Y((o0e,bx)=>{bx.exports={encode:hx(),decode:mx(),encodingLength:gx()}});var Ox=Y((N1e,Lx)=>{"use strict";Lx.exports=function(){return Date.now()}});var Mx=Y((L1e,Kx)=>{"use strict";var _0=Ox(),E4=class{constructor(e,t,n){let s=this;this._started=_0(),this._rescheduled=0,this._scheduled=t,this._args=n,this._triggered=!1,this._timerWrapper=()=>{s._rescheduled>0?(s._scheduled=s._rescheduled-(_0()-s._started),s._schedule(s._scheduled)):(s._triggered=!0,e.apply(null,s._args))},this._timer=setTimeout(this._timerWrapper,t)}reschedule(e){e||(e=this._scheduled);let t=_0();t+e-(this._started+this._scheduled)<0?(clearTimeout(this._timer),this._schedule(e)):this._triggered?this._schedule(e):(this._started=t,this._rescheduled=e)}_schedule(e){this._triggered=!1,this._started=_0(),this._rescheduled=0,this._scheduled=e,this._timer=setTimeout(this._timerWrapper,e)}clear(){clearTimeout(this._timer)}};function Iz(){if(typeof arguments[0]!="function")throw new Error("callback needed");if(typeof arguments[1]!="number")throw new Error("timeout needed");let r;if(arguments.length>0){r=new Array(arguments.length-2);for(var e=0;e<r.length;e++)r[e]=arguments[e+2]}return new E4(arguments[0],arguments[1],r)}Kx.exports=Iz});var Vx=Y((O1e,Fx)=>{"use strict";var{AbortController:Tz}=globalThis,Ux=Mx(),v4=class r extends Tz{constructor(e){super(),this._ms=e,this._timer=Ux(()=>this.abort(),e),Object.setPrototypeOf(this,r.prototype)}abort(){return this._timer.clear(),super.abort()}clear(){this._timer.clear()}reset(){this._timer.clear(),this._timer=Ux(()=>this.abort(),this._ms)}};Fx.exports={TimeoutController:v4}});var T0=Y((G1e,R4)=>{"use strict";var $l=typeof Reflect=="object"?Reflect:null,Gx=$l&&typeof $l.apply=="function"?$l.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},R0;$l&&typeof $l.ownKeys=="function"?R0=$l.ownKeys:Object.getOwnPropertySymbols?R0=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:R0=function(e){return Object.getOwnPropertyNames(e)};function Bz(r){console&&console.warn&&console.warn(r)}var Yx=Number.isNaN||function(e){return e!==e};function ut(){ut.init.call(this)}R4.exports=ut;R4.exports.once=Kz;ut.EventEmitter=ut;ut.prototype._events=void 0;ut.prototype._eventsCount=0;ut.prototype._maxListeners=void 0;var Wx=10;function I0(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(ut,"defaultMaxListeners",{enumerable:!0,get:function(){return Wx},set:function(r){if(typeof r!="number"||r<0||Yx(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");Wx=r}});ut.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};ut.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||Yx(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function jx(r){return r._maxListeners===void 0?ut.defaultMaxListeners:r._maxListeners}ut.prototype.getMaxListeners=function(){return jx(this)};ut.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var s=e==="error",o=this._events;if(o!==void 0)s=s&&o.error===void 0;else if(!s)return!1;if(s){var i;if(t.length>0&&(i=t[0]),i instanceof Error)throw i;var a=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw a.context=i,a}var c=o[e];if(c===void 0)return!1;if(typeof c=="function")Gx(c,this,t);else for(var l=c.length,u=eS(c,l),n=0;n<l;++n)Gx(u[n],this,t);return!0};function Qx(r,e,t,n){var s,o,i;if(I0(t),o=r._events,o===void 0?(o=r._events=Object.create(null),r._eventsCount=0):(o.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),o=r._events),i=o[e]),i===void 0)i=o[e]=t,++r._eventsCount;else if(typeof i=="function"?i=o[e]=n?[t,i]:[i,t]:n?i.unshift(t):i.push(t),s=jx(r),s>0&&i.length>s&&!i.warned){i.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=r,a.type=e,a.count=i.length,Bz(a)}return r}ut.prototype.addListener=function(e,t){return Qx(this,e,t,!1)};ut.prototype.on=ut.prototype.addListener;ut.prototype.prependListener=function(e,t){return Qx(this,e,t,!0)};function Nz(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Xx(r,e,t){var n={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},s=Nz.bind(n);return s.listener=t,n.wrapFn=s,s}ut.prototype.once=function(e,t){return I0(t),this.on(e,Xx(this,e,t)),this};ut.prototype.prependOnceListener=function(e,t){return I0(t),this.prependListener(e,Xx(this,e,t)),this};ut.prototype.removeListener=function(e,t){var n,s,o,i,a;if(I0(t),s=this._events,s===void 0)return this;if(n=s[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(o=-1,i=n.length-1;i>=0;i--)if(n[i]===t||n[i].listener===t){a=n[i].listener,o=i;break}if(o<0)return this;o===0?n.shift():Lz(n,o),n.length===1&&(s[e]=n[0]),s.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};ut.prototype.off=ut.prototype.removeListener;ut.prototype.removeAllListeners=function(e){var t,n,s;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var o=Object.keys(n),i;for(s=0;s<o.length;++s)i=o[s],i!=="removeListener"&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this};function Jx(r,e,t){var n=r._events;if(n===void 0)return[];var s=n[e];return s===void 0?[]:typeof s=="function"?t?[s.listener||s]:[s]:t?Oz(s):eS(s,s.length)}ut.prototype.listeners=function(e){return Jx(this,e,!0)};ut.prototype.rawListeners=function(e){return Jx(this,e,!1)};ut.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):Zx.call(r,e)};ut.prototype.listenerCount=Zx;function Zx(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}ut.prototype.eventNames=function(){return this._eventsCount>0?R0(this._events):[]};function eS(r,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=r[n];return t}function Lz(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function Oz(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function Kz(r,e){return new Promise(function(t,n){function s(i){r.removeListener(e,o),n(i)}function o(){typeof r.removeListener=="function"&&r.removeListener("error",s),t([].slice.call(arguments))}tS(r,e,o,{once:!0}),e!=="error"&&Mz(r,s,{once:!0})})}function Mz(r,e,t){typeof r.on=="function"&&tS(r,"error",e,t)}function tS(r,e,t,n){if(typeof r.on=="function")n.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function s(o){n.once&&r.removeEventListener(e,s),t(o)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}});var mS=Y((pS,dS)=>{"use strict";var c$=Math.exp;pS=dS.exports=function(e){if(typeof e!="number")throw new Error("must provide a timespan to the moving average constructor");if(e<=0)throw new Error("must provide a timespan > 0 to the moving average constructor");let t,n=0,s=0,o=0,i,a={};function c(l,u){return 1-c$(-(l-u)/e)}return a.push=function(u,f){if(i){let h=c(u,i),d=f-t,p=h*d;t=h*f+(1-h)*t,n=(1-h)*(n+d*p),s=Math.sqrt(n),o=t+h*d}else t=f;i=u},a.movingAverage=function(){return t},a.variance=function(){return n},a.deviation=function(){return s},a.forecast=function(){return o},a}});var G_=Y((Sge,t8)=>{"use strict";var rG=Object.prototype.hasOwnProperty,$r="~";function jh(){}Object.create&&(jh.prototype=Object.create(null),new jh().__proto__||($r=!1));function nG(r,e,t){this.fn=r,this.context=e,this.once=t||!1}function $_(r,e,t,n,s){if(typeof t!="function")throw new TypeError("The listener must be a function");var o=new nG(t,n||r,s),i=$r?$r+e:e;return r._events[i]?r._events[i].fn?r._events[i]=[r._events[i],o]:r._events[i].push(o):(r._events[i]=o,r._eventsCount++),r}function t1(r,e){--r._eventsCount===0?r._events=new jh:delete r._events[e]}function Ur(){this._events=new jh,this._eventsCount=0}Ur.prototype.eventNames=function(){var e=[],t,n;if(this._eventsCount===0)return e;for(n in t=this._events)rG.call(t,n)&&e.push($r?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};Ur.prototype.listeners=function(e){var t=$r?$r+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var s=0,o=n.length,i=new Array(o);s<o;s++)i[s]=n[s].fn;return i};Ur.prototype.listenerCount=function(e){var t=$r?$r+e:e,n=this._events[t];return n?n.fn?1:n.length:0};Ur.prototype.emit=function(e,t,n,s,o,i){var a=$r?$r+e:e;if(!this._events[a])return!1;var c=this._events[a],l=arguments.length,u,f;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,s),!0;case 5:return c.fn.call(c.context,t,n,s,o),!0;case 6:return c.fn.call(c.context,t,n,s,o,i),!0}for(f=1,u=new Array(l-1);f<l;f++)u[f-1]=arguments[f];c.fn.apply(c.context,u)}else{var h=c.length,d;for(f=0;f<h;f++)switch(c[f].once&&this.removeListener(e,c[f].fn,void 0,!0),l){case 1:c[f].fn.call(c[f].context);break;case 2:c[f].fn.call(c[f].context,t);break;case 3:c[f].fn.call(c[f].context,t,n);break;case 4:c[f].fn.call(c[f].context,t,n,s);break;default:if(!u)for(d=1,u=new Array(l-1);d<l;d++)u[d-1]=arguments[d];c[f].fn.apply(c[f].context,u)}}return!0};Ur.prototype.on=function(e,t,n){return $_(this,e,t,n,!1)};Ur.prototype.once=function(e,t,n){return $_(this,e,t,n,!0)};Ur.prototype.removeListener=function(e,t,n,s){var o=$r?$r+e:e;if(!this._events[o])return this;if(!t)return t1(this,o),this;var i=this._events[o];if(i.fn)i.fn===t&&(!s||i.once)&&(!n||i.context===n)&&t1(this,o);else{for(var a=0,c=[],l=i.length;a<l;a++)(i[a].fn!==t||s&&!i[a].once||n&&i[a].context!==n)&&c.push(i[a]);c.length?this._events[o]=c.length===1?c[0]:c:t1(this,o)}return this};Ur.prototype.removeAllListeners=function(e){var t;return e?(t=$r?$r+e:e,this._events[t]&&t1(this,t)):(this._events=new jh,this._eventsCount=0),this};Ur.prototype.off=Ur.prototype.removeListener;Ur.prototype.addListener=Ur.prototype.on;Ur.prefixed=$r;Ur.EventEmitter=Ur;typeof t8<"u"&&(t8.exports=Ur)});var cA=Y((g3e,aA)=>{"use strict";aA.exports=fG;function fG(r,e){for(var t=new Array(arguments.length-1),n=0,s=2,o=!0;s<arguments.length;)t[n++]=arguments[s++];return new Promise(function(a,c){t[n]=function(u){if(o)if(o=!1,u)c(u);else{for(var f=new Array(arguments.length-1),h=0;h<f.length;)f[h++]=arguments[h];a.apply(null,f)}};try{r.apply(e||null,t)}catch(l){o&&(o=!1,c(l))}})}});var hA=Y(fA=>{"use strict";var s1=fA;s1.length=function(e){var t=e.length;if(!t)return 0;for(var n=0;--t%4>1&&e.charAt(t)==="=";)++n;return Math.ceil(e.length*3)/4-n};var Zl=new Array(64),uA=new Array(123);for(bs=0;bs<64;)uA[Zl[bs]=bs<26?bs+65:bs<52?bs+71:bs<62?bs-4:bs-59|43]=bs++;var bs;s1.encode=function(e,t,n){for(var s=null,o=[],i=0,a=0,c;t<n;){var l=e[t++];switch(a){case 0:o[i++]=Zl[l>>2],c=(l&3)<<4,a=1;break;case 1:o[i++]=Zl[c|l>>4],c=(l&15)<<2,a=2;break;case 2:o[i++]=Zl[c|l>>6],o[i++]=Zl[l&63],a=0;break}i>8191&&((s||(s=[])).push(String.fromCharCode.apply(String,o)),i=0)}return a&&(o[i++]=Zl[c],o[i++]=61,a===1&&(o[i++]=61)),s?(i&&s.push(String.fromCharCode.apply(String,o.slice(0,i))),s.join("")):String.fromCharCode.apply(String,o.slice(0,i))};var lA="invalid encoding";s1.decode=function(e,t,n){for(var s=n,o=0,i,a=0;a<e.length;){var c=e.charCodeAt(a++);if(c===61&&o>1)break;if((c=uA[c])===void 0)throw Error(lA);switch(o){case 0:i=c,o=1;break;case 1:t[n++]=i<<2|(c&48)>>4,i=c,o=2;break;case 2:t[n++]=(i&15)<<4|(c&60)>>2,i=c,o=3;break;case 3:t[n++]=(i&3)<<6|c,o=0;break}}if(o===1)throw Error(lA);return n-s};s1.test=function(e){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)}});var dA=Y((w3e,pA)=>{"use strict";pA.exports=o1;function o1(){this._listeners={}}o1.prototype.on=function(e,t,n){return(this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:n||this}),this};o1.prototype.off=function(e,t){if(e===void 0)this._listeners={};else if(t===void 0)this._listeners[e]=[];else for(var n=this._listeners[e],s=0;s<n.length;)n[s].fn===t?n.splice(s,1):++s;return this};o1.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var n=[],s=1;s<arguments.length;)n.push(arguments[s++]);for(s=0;s<t.length;)t[s].fn.apply(t[s++].ctx,n)}return this}});var vA=Y((E3e,EA)=>{"use strict";EA.exports=mA(mA);function mA(r){return typeof Float32Array<"u"?function(){var e=new Float32Array([-0]),t=new Uint8Array(e.buffer),n=t[3]===128;function s(c,l,u){e[0]=c,l[u]=t[0],l[u+1]=t[1],l[u+2]=t[2],l[u+3]=t[3]}function o(c,l,u){e[0]=c,l[u]=t[3],l[u+1]=t[2],l[u+2]=t[1],l[u+3]=t[0]}r.writeFloatLE=n?s:o,r.writeFloatBE=n?o:s;function i(c,l){return t[0]=c[l],t[1]=c[l+1],t[2]=c[l+2],t[3]=c[l+3],e[0]}function a(c,l){return t[3]=c[l],t[2]=c[l+1],t[1]=c[l+2],t[0]=c[l+3],e[0]}r.readFloatLE=n?i:a,r.readFloatBE=n?a:i}():function(){function e(n,s,o,i){var a=s<0?1:0;if(a&&(s=-s),s===0)n(1/s>0?0:2147483648,o,i);else if(isNaN(s))n(2143289344,o,i);else if(s>34028234663852886e22)n((a<<31|2139095040)>>>0,o,i);else if(s<11754943508222875e-54)n((a<<31|Math.round(s/1401298464324817e-60))>>>0,o,i);else{var c=Math.floor(Math.log(s)/Math.LN2),l=Math.round(s*Math.pow(2,-c)*8388608)&8388607;n((a<<31|c+127<<23|l)>>>0,o,i)}}r.writeFloatLE=e.bind(null,yA),r.writeFloatBE=e.bind(null,gA);function t(n,s,o){var i=n(s,o),a=(i>>31)*2+1,c=i>>>23&255,l=i&8388607;return c===255?l?NaN:a*(1/0):c===0?a*1401298464324817e-60*l:a*Math.pow(2,c-150)*(l+8388608)}r.readFloatLE=t.bind(null,bA),r.readFloatBE=t.bind(null,wA)}(),typeof Float64Array<"u"?function(){var e=new Float64Array([-0]),t=new Uint8Array(e.buffer),n=t[7]===128;function s(c,l,u){e[0]=c,l[u]=t[0],l[u+1]=t[1],l[u+2]=t[2],l[u+3]=t[3],l[u+4]=t[4],l[u+5]=t[5],l[u+6]=t[6],l[u+7]=t[7]}function o(c,l,u){e[0]=c,l[u]=t[7],l[u+1]=t[6],l[u+2]=t[5],l[u+3]=t[4],l[u+4]=t[3],l[u+5]=t[2],l[u+6]=t[1],l[u+7]=t[0]}r.writeDoubleLE=n?s:o,r.writeDoubleBE=n?o:s;function i(c,l){return t[0]=c[l],t[1]=c[l+1],t[2]=c[l+2],t[3]=c[l+3],t[4]=c[l+4],t[5]=c[l+5],t[6]=c[l+6],t[7]=c[l+7],e[0]}function a(c,l){return t[7]=c[l],t[6]=c[l+1],t[5]=c[l+2],t[4]=c[l+3],t[3]=c[l+4],t[2]=c[l+5],t[1]=c[l+6],t[0]=c[l+7],e[0]}r.readDoubleLE=n?i:a,r.readDoubleBE=n?a:i}():function(){function e(n,s,o,i,a,c){var l=i<0?1:0;if(l&&(i=-i),i===0)n(0,a,c+s),n(1/i>0?0:2147483648,a,c+o);else if(isNaN(i))n(0,a,c+s),n(2146959360,a,c+o);else if(i>17976931348623157e292)n(0,a,c+s),n((l<<31|2146435072)>>>0,a,c+o);else{var u;if(i<22250738585072014e-324)u=i/5e-324,n(u>>>0,a,c+s),n((l<<31|u/4294967296)>>>0,a,c+o);else{var f=Math.floor(Math.log(i)/Math.LN2);f===1024&&(f=1023),u=i*Math.pow(2,-f),n(u*4503599627370496>>>0,a,c+s),n((l<<31|f+1023<<20|u*1048576&1048575)>>>0,a,c+o)}}}r.writeDoubleLE=e.bind(null,yA,0,4),r.writeDoubleBE=e.bind(null,gA,4,0);function t(n,s,o,i,a){var c=n(i,a+s),l=n(i,a+o),u=(l>>31)*2+1,f=l>>>20&2047,h=4294967296*(l&1048575)+c;return f===2047?h?NaN:u*(1/0):f===0?u*5e-324*h:u*Math.pow(2,f-1075)*(h+4503599627370496)}r.readDoubleLE=t.bind(null,bA,0,4),r.readDoubleBE=t.bind(null,wA,4,0)}(),r}function yA(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function gA(r,e,t){e[t]=r>>>24,e[t+1]=r>>>16&255,e[t+2]=r>>>8&255,e[t+3]=r&255}function bA(r,e){return(r[e]|r[e+1]<<8|r[e+2]<<16|r[e+3]<<24)>>>0}function wA(r,e){return(r[e]<<24|r[e+1]<<16|r[e+2]<<8|r[e+3])>>>0}});var xA=Y((exports,module)=>{"use strict";module.exports=inquire;function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(r){}return null}});var _A=Y(SA=>{"use strict";var b8=SA;b8.length=function(e){for(var t=0,n=0,s=0;s<e.length;++s)n=e.charCodeAt(s),n<128?t+=1:n<2048?t+=2:(n&64512)===55296&&(e.charCodeAt(s+1)&64512)===56320?(++s,t+=4):t+=3;return t};b8.read=function(e,t,n){var s=n-t;if(s<1)return"";for(var o=null,i=[],a=0,c;t<n;)c=e[t++],c<128?i[a++]=c:c>191&&c<224?i[a++]=(c&31)<<6|e[t++]&63:c>239&&c<365?(c=((c&7)<<18|(e[t++]&63)<<12|(e[t++]&63)<<6|e[t++]&63)-65536,i[a++]=55296+(c>>10),i[a++]=56320+(c&1023)):i[a++]=(c&15)<<12|(e[t++]&63)<<6|e[t++]&63,a>8191&&((o||(o=[])).push(String.fromCharCode.apply(String,i)),a=0);return o?(a&&o.push(String.fromCharCode.apply(String,i.slice(0,a))),o.join("")):String.fromCharCode.apply(String,i.slice(0,a))};b8.write=function(e,t,n){for(var s=n,o,i,a=0;a<e.length;++a)o=e.charCodeAt(a),o<128?t[n++]=o:o<2048?(t[n++]=o>>6|192,t[n++]=o&63|128):(o&64512)===55296&&((i=e.charCodeAt(a+1))&64512)===56320?(o=65536+((o&1023)<<10)+(i&1023),++a,t[n++]=o>>18|240,t[n++]=o>>12&63|128,t[n++]=o>>6&63|128,t[n++]=o&63|128):(t[n++]=o>>12|224,t[n++]=o>>6&63|128,t[n++]=o&63|128);return n-s}});var RA=Y((x3e,AA)=>{"use strict";AA.exports=hG;function hG(r,e,t){var n=t||8192,s=n>>>1,o=null,i=n;return function(c){if(c<1||c>s)return r(c);i+c>n&&(o=r(n),i=0);var l=e.call(o,i,i+=c);return i&7&&(i=(i|7)+1),l}}});var TA=Y((S3e,IA)=>{"use strict";IA.exports=hr;var ep=Ji();function hr(r,e){this.lo=r>>>0,this.hi=e>>>0}var wc=hr.zero=new hr(0,0);wc.toNumber=function(){return 0};wc.zzEncode=wc.zzDecode=function(){return this};wc.length=function(){return 1};var pG=hr.zeroHash="\0\0\0\0\0\0\0\0";hr.fromNumber=function(e){if(e===0)return wc;var t=e<0;t&&(e=-e);var n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new hr(n,s)};hr.from=function(e){if(typeof e=="number")return hr.fromNumber(e);if(ep.isString(e))if(ep.Long)e=ep.Long.fromString(e);else return hr.fromNumber(parseInt(e,10));return e.low||e.high?new hr(e.low>>>0,e.high>>>0):wc};hr.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=~this.lo+1>>>0,n=~this.hi>>>0;return t||(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296};hr.prototype.toLong=function(e){return ep.Long?new ep.Long(this.lo|0,this.hi|0,!!e):{low:this.lo|0,high:this.hi|0,unsigned:!!e}};var Xi=String.prototype.charCodeAt;hr.fromHash=function(e){return e===pG?wc:new hr((Xi.call(e,0)|Xi.call(e,1)<<8|Xi.call(e,2)<<16|Xi.call(e,3)<<24)>>>0,(Xi.call(e,4)|Xi.call(e,5)<<8|Xi.call(e,6)<<16|Xi.call(e,7)<<24)>>>0)};hr.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)};hr.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this};hr.prototype.zzDecode=function(){var e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this};hr.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}});var Ji=Y(w8=>{"use strict";var ge=w8;ge.asPromise=cA();ge.base64=hA();ge.EventEmitter=dA();ge.float=vA();ge.inquire=xA();ge.utf8=_A();ge.pool=RA();ge.LongBits=TA();ge.isNode=!!(typeof globalThis<"u"&&globalThis&&globalThis.process&&globalThis.process.versions&&globalThis.process.versions.node);ge.global=ge.isNode&&globalThis||typeof window<"u"&&window||typeof self<"u"&&self||w8;ge.emptyArray=Object.freeze?Object.freeze([]):[];ge.emptyObject=Object.freeze?Object.freeze({}):{};ge.isInteger=Number.isInteger||function(e){return typeof e=="number"&&isFinite(e)&&Math.floor(e)===e};ge.isString=function(e){return typeof e=="string"||e instanceof String};ge.isObject=function(e){return e&&typeof e=="object"};ge.isset=ge.isSet=function(e,t){var n=e[t];return n!=null&&e.hasOwnProperty(t)?typeof n!="object"||(Array.isArray(n)?n.length:Object.keys(n).length)>0:!1};ge.Buffer=function(){try{var r=ge.inquire("buffer").Buffer;return r.prototype.utf8Write?r:null}catch{return null}}();ge._Buffer_from=null;ge._Buffer_allocUnsafe=null;ge.newBuffer=function(e){return typeof e=="number"?ge.Buffer?ge._Buffer_allocUnsafe(e):new ge.Array(e):ge.Buffer?ge._Buffer_from(e):typeof Uint8Array>"u"?e:new Uint8Array(e)};ge.Array=typeof Uint8Array<"u"?Uint8Array:Array;ge.Long=ge.global.dcodeIO&&ge.global.dcodeIO.Long||ge.global.Long||ge.inquire("long");ge.key2Re=/^true|false|0|1$/;ge.key32Re=/^-?(?:0|[1-9][0-9]*)$/;ge.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/;ge.longToHash=function(e){return e?ge.LongBits.from(e).toHash():ge.LongBits.zeroHash};ge.longFromHash=function(e,t){var n=ge.LongBits.fromHash(e);return ge.Long?ge.Long.fromBits(n.lo,n.hi,t):n.toNumber(!!t)};function kA(r,e,t){for(var n=Object.keys(e),s=0;s<n.length;++s)(r[n[s]]===void 0||!t)&&(r[n[s]]=e[n[s]]);return r}ge.merge=kA;ge.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)};function DA(r){function e(t,n){if(!(this instanceof e))return new e(t,n);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:new Error().stack||""}),n&&kA(this,n)}return e.prototype=Object.create(Error.prototype,{constructor:{value:e,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return r},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),e}ge.newError=DA;ge.ProtocolError=DA("ProtocolError");ge.oneOfGetter=function(e){for(var t={},n=0;n<e.length;++n)t[e[n]]=1;return function(){for(var s=Object.keys(this),o=s.length-1;o>-1;--o)if(t[s[o]]===1&&this[s[o]]!==void 0&&this[s[o]]!==null)return s[o]}};ge.oneOfSetter=function(e){return function(t){for(var n=0;n<e.length;++n)e[n]!==t&&delete this[e[n]]}};ge.toJSONOptions={longs:String,enums:String,bytes:String,json:!0};ge._configure=function(){var r=ge.Buffer;if(!r){ge._Buffer_from=ge._Buffer_allocUnsafe=null;return}ge._Buffer_from=r.from!==Uint8Array.from&&r.from||function(t,n){return new r(t,n)},ge._Buffer_allocUnsafe=r.allocUnsafe||function(t){return new r(t)}}});var R8=Y((A3e,NA)=>{"use strict";NA.exports=Qe;var Un=Ji(),E8,i1=Un.LongBits,PA=Un.base64,CA=Un.utf8;function tp(r,e,t){this.fn=r,this.len=e,this.next=void 0,this.val=t}function x8(){}function dG(r){this.head=r.head,this.tail=r.tail,this.len=r.len,this.next=r.states}function Qe(){this.len=0,this.head=new tp(x8,0,0),this.tail=this.head,this.states=null}var BA=function(){return Un.Buffer?function(){return(Qe.create=function(){return new E8})()}:function(){return new Qe}};Qe.create=BA();Qe.alloc=function(e){return new Un.Array(e)};Un.Array!==Array&&(Qe.alloc=Un.pool(Qe.alloc,Un.Array.prototype.subarray));Qe.prototype._push=function(e,t,n){return this.tail=this.tail.next=new tp(e,t,n),this.len+=t,this};function S8(r,e,t){e[t]=r&255}function mG(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}function _8(r,e){this.len=r,this.next=void 0,this.val=e}_8.prototype=Object.create(tp.prototype);_8.prototype.fn=mG;Qe.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new _8((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this};Qe.prototype.int32=function(e){return e<0?this._push(A8,10,i1.fromNumber(e)):this.uint32(e)};Qe.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)};function A8(r,e,t){for(;r.hi;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}Qe.prototype.uint64=function(e){var t=i1.from(e);return this._push(A8,t.length(),t)};Qe.prototype.int64=Qe.prototype.uint64;Qe.prototype.sint64=function(e){var t=i1.from(e).zzEncode();return this._push(A8,t.length(),t)};Qe.prototype.bool=function(e){return this._push(S8,1,e?1:0)};function v8(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}Qe.prototype.fixed32=function(e){return this._push(v8,4,e>>>0)};Qe.prototype.sfixed32=Qe.prototype.fixed32;Qe.prototype.fixed64=function(e){var t=i1.from(e);return this._push(v8,4,t.lo)._push(v8,4,t.hi)};Qe.prototype.sfixed64=Qe.prototype.fixed64;Qe.prototype.float=function(e){return this._push(Un.float.writeFloatLE,4,e)};Qe.prototype.double=function(e){return this._push(Un.float.writeDoubleLE,8,e)};var yG=Un.Array.prototype.set?function(e,t,n){t.set(e,n)}:function(e,t,n){for(var s=0;s<e.length;++s)t[n+s]=e[s]};Qe.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this._push(S8,1,0);if(Un.isString(e)){var n=Qe.alloc(t=PA.length(e));PA.decode(e,n,0),e=n}return this.uint32(t)._push(yG,t,e)};Qe.prototype.string=function(e){var t=CA.length(e);return t?this.uint32(t)._push(CA.write,t,e):this._push(S8,1,0)};Qe.prototype.fork=function(){return this.states=new dG(this),this.head=this.tail=new tp(x8,0,0),this.len=0,this};Qe.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new tp(x8,0,0),this.len=0),this};Qe.prototype.ldelim=function(){var e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=e.next,this.tail=t,this.len+=n),this};Qe.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),n=0;e;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t};Qe._configure=function(r){E8=r,Qe.create=BA(),E8._configure()}});var KA=Y((R3e,OA)=>{"use strict";OA.exports=Ys;var LA=R8();(Ys.prototype=Object.create(LA.prototype)).constructor=Ys;var Zi=Ji();function Ys(){LA.call(this)}Ys._configure=function(){Ys.alloc=Zi._Buffer_allocUnsafe,Ys.writeBytesBuffer=Zi.Buffer&&Zi.Buffer.prototype instanceof Uint8Array&&Zi.Buffer.prototype.set.name==="set"?function(e,t,n){t.set(e,n)}:function(e,t,n){if(e.copy)e.copy(t,n,0,e.length);else for(var s=0;s<e.length;)t[n++]=e[s++]}};Ys.prototype.bytes=function(e){Zi.isString(e)&&(e=Zi._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(Ys.writeBytesBuffer,t,e),this};function gG(r,e,t){r.length<40?Zi.utf8.write(r,e,t):e.utf8Write?e.utf8Write(r,t):e.write(r,t)}Ys.prototype.string=function(e){var t=Zi.Buffer.byteLength(e);return this.uint32(t),t&&this._push(gG,t,e),this};Ys._configure()});var k8=Y((I3e,qA)=>{"use strict";qA.exports=Ht;var ws=Ji(),T8,FA=ws.LongBits,bG=ws.utf8;function Es(r,e){return RangeError("index out of range: "+r.pos+" + "+(e||1)+" > "+r.len)}function Ht(r){this.buf=r,this.pos=0,this.len=r.length}var MA=typeof Uint8Array<"u"?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new Ht(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new Ht(e);throw Error("illegal buffer")},VA=function(){return ws.Buffer?function(t){return(Ht.create=function(s){return ws.Buffer.isBuffer(s)?new T8(s):MA(s)})(t)}:MA};Ht.create=VA();Ht.prototype._slice=ws.Array.prototype.subarray||ws.Array.prototype.slice;Ht.prototype.uint32=function(){var e=4294967295;return function(){if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Es(this,10);return e}}();Ht.prototype.int32=function(){return this.uint32()|0};Ht.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(e&1)|0};function I8(){var r=new FA(0,0),e=0;if(this.len-this.pos>4){for(;e<4;++e)if(r.lo=(r.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return r;if(r.lo=(r.lo|(this.buf[this.pos]&127)<<28)>>>0,r.hi=(r.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return r;e=0}else{for(;e<3;++e){if(this.pos>=this.len)throw Es(this);if(r.lo=(r.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return r}return r.lo=(r.lo|(this.buf[this.pos++]&127)<<e*7)>>>0,r}if(this.len-this.pos>4){for(;e<5;++e)if(r.hi=(r.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return r}else for(;e<5;++e){if(this.pos>=this.len)throw Es(this);if(r.hi=(r.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return r}throw Error("invalid varint encoding")}Ht.prototype.bool=function(){return this.uint32()!==0};function a1(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}Ht.prototype.fixed32=function(){if(this.pos+4>this.len)throw Es(this,4);return a1(this.buf,this.pos+=4)};Ht.prototype.sfixed32=function(){if(this.pos+4>this.len)throw Es(this,4);return a1(this.buf,this.pos+=4)|0};function UA(){if(this.pos+8>this.len)throw Es(this,8);return new FA(a1(this.buf,this.pos+=4),a1(this.buf,this.pos+=4))}Ht.prototype.float=function(){if(this.pos+4>this.len)throw Es(this,4);var e=ws.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e};Ht.prototype.double=function(){if(this.pos+8>this.len)throw Es(this,4);var e=ws.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e};Ht.prototype.bytes=function(){var e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw Es(this,e);if(this.pos+=e,Array.isArray(this.buf))return this.buf.slice(t,n);if(t===n){var s=ws.Buffer;return s?s.alloc(0):new this.buf.constructor(0)}return this._slice.call(this.buf,t,n)};Ht.prototype.string=function(){var e=this.bytes();return bG.read(e,0,e.length)};Ht.prototype.skip=function(e){if(typeof e=="number"){if(this.pos+e>this.len)throw Es(this,e);this.pos+=e}else do if(this.pos>=this.len)throw Es(this);while(this.buf[this.pos++]&128);return this};Ht.prototype.skipType=function(r){switch(r){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(r=this.uint32()&7)!==4;)this.skipType(r);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+r+" at offset "+this.pos)}return this};Ht._configure=function(r){T8=r,Ht.create=VA(),T8._configure();var e=ws.Long?"toLong":"toNumber";ws.merge(Ht.prototype,{int64:function(){return I8.call(this)[e](!1)},uint64:function(){return I8.call(this)[e](!0)},sint64:function(){return I8.call(this).zzDecode()[e](!1)},fixed64:function(){return UA.call(this)[e](!0)},sfixed64:function(){return UA.call(this)[e](!1)}})}});var GA=Y((T3e,$A)=>{"use strict";$A.exports=Ec;var zA=k8();(Ec.prototype=Object.create(zA.prototype)).constructor=Ec;var HA=Ji();function Ec(r){zA.call(this,r)}Ec._configure=function(){HA.Buffer&&(Ec.prototype._slice=HA.Buffer.prototype.slice)};Ec.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+e,this.len))};Ec._configure()});var YA=Y((k3e,WA)=>{"use strict";WA.exports=rp;var D8=Ji();(rp.prototype=Object.create(D8.EventEmitter.prototype)).constructor=rp;function rp(r,e,t){if(typeof r!="function")throw TypeError("rpcImpl must be a function");D8.EventEmitter.call(this),this.rpcImpl=r,this.requestDelimited=!!e,this.responseDelimited=!!t}rp.prototype.rpcCall=function r(e,t,n,s,o){if(!s)throw TypeError("request must be specified");var i=this;if(!o)return D8.asPromise(r,i,e,t,n,s);if(!i.rpcImpl){setTimeout(function(){o(Error("already ended"))},0);return}try{return i.rpcImpl(e,t[i.requestDelimited?"encodeDelimited":"encode"](s).finish(),function(c,l){if(c)return i.emit("error",c,e),o(c);if(l===null){i.end(!0);return}if(!(l instanceof n))try{l=n[i.responseDelimited?"decodeDelimited":"decode"](l)}catch(u){return i.emit("error",u,e),o(u)}return i.emit("data",l,e),o(null,l)})}catch(a){i.emit("error",a,e),setTimeout(function(){o(a)},0);return}};rp.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}});var QA=Y(jA=>{"use strict";var wG=jA;wG.Service=YA()});var JA=Y((P3e,XA)=>{"use strict";XA.exports={}});var tR=Y(eR=>{"use strict";var on=eR;on.build="minimal";on.Writer=R8();on.BufferWriter=KA();on.Reader=k8();on.BufferReader=GA();on.util=Ji();on.rpc=QA();on.roots=JA();on.configure=ZA;function ZA(){on.util._configure(),on.Writer._configure(on.BufferWriter),on.Reader._configure(on.BufferReader)}ZA()});var P8=Y((B3e,rR)=>{"use strict";rR.exports=tR()});var aR=Y((iR,np)=>{(function(r,e){typeof define=="function"&&define.amd?define(["protobufjs/minimal"],e):typeof Wv=="function"&&typeof np=="object"&&np&&np.exports&&(np.exports=e(P8()))})(iR,function(r){"use strict";var e=r.Reader,t=r.Writer,n=r.util,s=r.roots.default||(r.roots.default={});return s.RPC=function(){function o(a){if(this.subscriptions=[],this.messages=[],a)for(var c=Object.keys(a),l=0;l<c.length;++l)a[c[l]]!=null&&(this[c[l]]=a[c[l]])}o.prototype.subscriptions=n.emptyArray,o.prototype.messages=n.emptyArray,o.prototype.control=null;var i;return Object.defineProperty(o.prototype,"_control",{get:n.oneOfGetter(i=["control"]),set:n.oneOfSetter(i)}),o.encode=function(c,l){if(l||(l=t.create()),c.subscriptions!=null&&c.subscriptions.length)for(var u=0;u<c.subscriptions.length;++u)s.RPC.SubOpts.encode(c.subscriptions[u],l.uint32(10).fork()).ldelim();if(c.messages!=null&&c.messages.length)for(var u=0;u<c.messages.length;++u)s.RPC.Message.encode(c.messages[u],l.uint32(18).fork()).ldelim();return c.control!=null&&Object.hasOwnProperty.call(c,"control")&&s.RPC.ControlMessage.encode(c.control,l.uint32(26).fork()).ldelim(),l},o.decode=function(c,l){c instanceof e||(c=e.create(c));for(var u=l===void 0?c.len:c.pos+l,f=new s.RPC;c.pos<u;){var h=c.uint32();switch(h>>>3){case 1:f.subscriptions&&f.subscriptions.length||(f.subscriptions=[]),f.subscriptions.push(s.RPC.SubOpts.decode(c,c.uint32()));break;case 2:f.messages&&f.messages.length||(f.messages=[]),f.messages.push(s.RPC.Message.decode(c,c.uint32()));break;case 3:f.control=s.RPC.ControlMessage.decode(c,c.uint32());break;default:c.skipType(h&7);break}}return f},o.fromObject=function(c){if(c instanceof s.RPC)return c;var l=new s.RPC;if(c.subscriptions){if(!Array.isArray(c.subscriptions))throw TypeError(".RPC.subscriptions: array expected");l.subscriptions=[];for(var u=0;u<c.subscriptions.length;++u){if(typeof c.subscriptions[u]!="object")throw TypeError(".RPC.subscriptions: object expected");l.subscriptions[u]=s.RPC.SubOpts.fromObject(c.subscriptions[u])}}if(c.messages){if(!Array.isArray(c.messages))throw TypeError(".RPC.messages: array expected");l.messages=[];for(var u=0;u<c.messages.length;++u){if(typeof c.messages[u]!="object")throw TypeError(".RPC.messages: object expected");l.messages[u]=s.RPC.Message.fromObject(c.messages[u])}}if(c.control!=null){if(typeof c.control!="object")throw TypeError(".RPC.control: object expected");l.control=s.RPC.ControlMessage.fromObject(c.control)}return l},o.toObject=function(c,l){l||(l={});var u={};if((l.arrays||l.defaults)&&(u.subscriptions=[],u.messages=[]),c.subscriptions&&c.subscriptions.length){u.subscriptions=[];for(var f=0;f<c.subscriptions.length;++f)u.subscriptions[f]=s.RPC.SubOpts.toObject(c.subscriptions[f],l)}if(c.messages&&c.messages.length){u.messages=[];for(var f=0;f<c.messages.length;++f)u.messages[f]=s.RPC.Message.toObject(c.messages[f],l)}return c.control!=null&&c.hasOwnProperty("control")&&(u.control=s.RPC.ControlMessage.toObject(c.control,l),l.oneofs&&(u._control="control")),u},o.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},o.SubOpts=function(){function a(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.subscribe=null,a.prototype.topic=null;var c;return Object.defineProperty(a.prototype,"_subscribe",{get:n.oneOfGetter(c=["subscribe"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_topic",{get:n.oneOfGetter(c=["topic"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){return f||(f=t.create()),u.subscribe!=null&&Object.hasOwnProperty.call(u,"subscribe")&&f.uint32(8).bool(u.subscribe),u.topic!=null&&Object.hasOwnProperty.call(u,"topic")&&f.uint32(18).string(u.topic),f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new s.RPC.SubOpts;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.subscribe=u.bool();break;case 2:d.topic=u.string();break;default:u.skipType(p&7);break}}return d},a.fromObject=function(u){if(u instanceof s.RPC.SubOpts)return u;var f=new s.RPC.SubOpts;return u.subscribe!=null&&(f.subscribe=!!u.subscribe),u.topic!=null&&(f.topic=String(u.topic)),f},a.toObject=function(u,f){f||(f={});var h={};return u.subscribe!=null&&u.hasOwnProperty("subscribe")&&(h.subscribe=u.subscribe,f.oneofs&&(h._subscribe="subscribe")),u.topic!=null&&u.hasOwnProperty("topic")&&(h.topic=u.topic,f.oneofs&&(h._topic="topic")),h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),o.Message=function(){function a(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.from=null,a.prototype.data=null,a.prototype.seqno=null,a.prototype.topic="",a.prototype.signature=null,a.prototype.key=null;var c;return Object.defineProperty(a.prototype,"_from",{get:n.oneOfGetter(c=["from"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_data",{get:n.oneOfGetter(c=["data"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_seqno",{get:n.oneOfGetter(c=["seqno"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_signature",{get:n.oneOfGetter(c=["signature"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_key",{get:n.oneOfGetter(c=["key"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){return f||(f=t.create()),u.from!=null&&Object.hasOwnProperty.call(u,"from")&&f.uint32(10).bytes(u.from),u.data!=null&&Object.hasOwnProperty.call(u,"data")&&f.uint32(18).bytes(u.data),u.seqno!=null&&Object.hasOwnProperty.call(u,"seqno")&&f.uint32(26).bytes(u.seqno),f.uint32(34).string(u.topic),u.signature!=null&&Object.hasOwnProperty.call(u,"signature")&&f.uint32(42).bytes(u.signature),u.key!=null&&Object.hasOwnProperty.call(u,"key")&&f.uint32(50).bytes(u.key),f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new s.RPC.Message;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.from=u.bytes();break;case 2:d.data=u.bytes();break;case 3:d.seqno=u.bytes();break;case 4:d.topic=u.string();break;case 5:d.signature=u.bytes();break;case 6:d.key=u.bytes();break;default:u.skipType(p&7);break}}if(!d.hasOwnProperty("topic"))throw n.ProtocolError("missing required 'topic'",{instance:d});return d},a.fromObject=function(u){if(u instanceof s.RPC.Message)return u;var f=new s.RPC.Message;return u.from!=null&&(typeof u.from=="string"?n.base64.decode(u.from,f.from=n.newBuffer(n.base64.length(u.from)),0):u.from.length&&(f.from=u.from)),u.data!=null&&(typeof u.data=="string"?n.base64.decode(u.data,f.data=n.newBuffer(n.base64.length(u.data)),0):u.data.length&&(f.data=u.data)),u.seqno!=null&&(typeof u.seqno=="string"?n.base64.decode(u.seqno,f.seqno=n.newBuffer(n.base64.length(u.seqno)),0):u.seqno.length&&(f.seqno=u.seqno)),u.topic!=null&&(f.topic=String(u.topic)),u.signature!=null&&(typeof u.signature=="string"?n.base64.decode(u.signature,f.signature=n.newBuffer(n.base64.length(u.signature)),0):u.signature.length&&(f.signature=u.signature)),u.key!=null&&(typeof u.key=="string"?n.base64.decode(u.key,f.key=n.newBuffer(n.base64.length(u.key)),0):u.key.length&&(f.key=u.key)),f},a.toObject=function(u,f){f||(f={});var h={};return f.defaults&&(h.topic=""),u.from!=null&&u.hasOwnProperty("from")&&(h.from=f.bytes===String?n.base64.encode(u.from,0,u.from.length):f.bytes===Array?Array.prototype.slice.call(u.from):u.from,f.oneofs&&(h._from="from")),u.data!=null&&u.hasOwnProperty("data")&&(h.data=f.bytes===String?n.base64.encode(u.data,0,u.data.length):f.bytes===Array?Array.prototype.slice.call(u.data):u.data,f.oneofs&&(h._data="data")),u.seqno!=null&&u.hasOwnProperty("seqno")&&(h.seqno=f.bytes===String?n.base64.encode(u.seqno,0,u.seqno.length):f.bytes===Array?Array.prototype.slice.call(u.seqno):u.seqno,f.oneofs&&(h._seqno="seqno")),u.topic!=null&&u.hasOwnProperty("topic")&&(h.topic=u.topic),u.signature!=null&&u.hasOwnProperty("signature")&&(h.signature=f.bytes===String?n.base64.encode(u.signature,0,u.signature.length):f.bytes===Array?Array.prototype.slice.call(u.signature):u.signature,f.oneofs&&(h._signature="signature")),u.key!=null&&u.hasOwnProperty("key")&&(h.key=f.bytes===String?n.base64.encode(u.key,0,u.key.length):f.bytes===Array?Array.prototype.slice.call(u.key):u.key,f.oneofs&&(h._key="key")),h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),o.ControlMessage=function(){function a(c){if(this.ihave=[],this.iwant=[],this.graft=[],this.prune=[],c)for(var l=Object.keys(c),u=0;u<l.length;++u)c[l[u]]!=null&&(this[l[u]]=c[l[u]])}return a.prototype.ihave=n.emptyArray,a.prototype.iwant=n.emptyArray,a.prototype.graft=n.emptyArray,a.prototype.prune=n.emptyArray,a.encode=function(l,u){if(u||(u=t.create()),l.ihave!=null&&l.ihave.length)for(var f=0;f<l.ihave.length;++f)s.RPC.ControlIHave.encode(l.ihave[f],u.uint32(10).fork()).ldelim();if(l.iwant!=null&&l.iwant.length)for(var f=0;f<l.iwant.length;++f)s.RPC.ControlIWant.encode(l.iwant[f],u.uint32(18).fork()).ldelim();if(l.graft!=null&&l.graft.length)for(var f=0;f<l.graft.length;++f)s.RPC.ControlGraft.encode(l.graft[f],u.uint32(26).fork()).ldelim();if(l.prune!=null&&l.prune.length)for(var f=0;f<l.prune.length;++f)s.RPC.ControlPrune.encode(l.prune[f],u.uint32(34).fork()).ldelim();return u},a.decode=function(l,u){l instanceof e||(l=e.create(l));for(var f=u===void 0?l.len:l.pos+u,h=new s.RPC.ControlMessage;l.pos<f;){var d=l.uint32();switch(d>>>3){case 1:h.ihave&&h.ihave.length||(h.ihave=[]),h.ihave.push(s.RPC.ControlIHave.decode(l,l.uint32()));break;case 2:h.iwant&&h.iwant.length||(h.iwant=[]),h.iwant.push(s.RPC.ControlIWant.decode(l,l.uint32()));break;case 3:h.graft&&h.graft.length||(h.graft=[]),h.graft.push(s.RPC.ControlGraft.decode(l,l.uint32()));break;case 4:h.prune&&h.prune.length||(h.prune=[]),h.prune.push(s.RPC.ControlPrune.decode(l,l.uint32()));break;default:l.skipType(d&7);break}}return h},a.fromObject=function(l){if(l instanceof s.RPC.ControlMessage)return l;var u=new s.RPC.ControlMessage;if(l.ihave){if(!Array.isArray(l.ihave))throw TypeError(".RPC.ControlMessage.ihave: array expected");u.ihave=[];for(var f=0;f<l.ihave.length;++f){if(typeof l.ihave[f]!="object")throw TypeError(".RPC.ControlMessage.ihave: object expected");u.ihave[f]=s.RPC.ControlIHave.fromObject(l.ihave[f])}}if(l.iwant){if(!Array.isArray(l.iwant))throw TypeError(".RPC.ControlMessage.iwant: array expected");u.iwant=[];for(var f=0;f<l.iwant.length;++f){if(typeof l.iwant[f]!="object")throw TypeError(".RPC.ControlMessage.iwant: object expected");u.iwant[f]=s.RPC.ControlIWant.fromObject(l.iwant[f])}}if(l.graft){if(!Array.isArray(l.graft))throw TypeError(".RPC.ControlMessage.graft: array expected");u.graft=[];for(var f=0;f<l.graft.length;++f){if(typeof l.graft[f]!="object")throw TypeError(".RPC.ControlMessage.graft: object expected");u.graft[f]=s.RPC.ControlGraft.fromObject(l.graft[f])}}if(l.prune){if(!Array.isArray(l.prune))throw TypeError(".RPC.ControlMessage.prune: array expected");u.prune=[];for(var f=0;f<l.prune.length;++f){if(typeof l.prune[f]!="object")throw TypeError(".RPC.ControlMessage.prune: object expected");u.prune[f]=s.RPC.ControlPrune.fromObject(l.prune[f])}}return u},a.toObject=function(l,u){u||(u={});var f={};if((u.arrays||u.defaults)&&(f.ihave=[],f.iwant=[],f.graft=[],f.prune=[]),l.ihave&&l.ihave.length){f.ihave=[];for(var h=0;h<l.ihave.length;++h)f.ihave[h]=s.RPC.ControlIHave.toObject(l.ihave[h],u)}if(l.iwant&&l.iwant.length){f.iwant=[];for(var h=0;h<l.iwant.length;++h)f.iwant[h]=s.RPC.ControlIWant.toObject(l.iwant[h],u)}if(l.graft&&l.graft.length){f.graft=[];for(var h=0;h<l.graft.length;++h)f.graft[h]=s.RPC.ControlGraft.toObject(l.graft[h],u)}if(l.prune&&l.prune.length){f.prune=[];for(var h=0;h<l.prune.length;++h)f.prune[h]=s.RPC.ControlPrune.toObject(l.prune[h],u)}return f},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),o.ControlIHave=function(){function a(l){if(this.messageIDs=[],l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.topicID=null,a.prototype.messageIDs=n.emptyArray;var c;return Object.defineProperty(a.prototype,"_topicID",{get:n.oneOfGetter(c=["topicID"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){if(f||(f=t.create()),u.topicID!=null&&Object.hasOwnProperty.call(u,"topicID")&&f.uint32(10).string(u.topicID),u.messageIDs!=null&&u.messageIDs.length)for(var h=0;h<u.messageIDs.length;++h)f.uint32(18).bytes(u.messageIDs[h]);return f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new s.RPC.ControlIHave;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.topicID=u.string();break;case 2:d.messageIDs&&d.messageIDs.length||(d.messageIDs=[]),d.messageIDs.push(u.bytes());break;default:u.skipType(p&7);break}}return d},a.fromObject=function(u){if(u instanceof s.RPC.ControlIHave)return u;var f=new s.RPC.ControlIHave;if(u.topicID!=null&&(f.topicID=String(u.topicID)),u.messageIDs){if(!Array.isArray(u.messageIDs))throw TypeError(".RPC.ControlIHave.messageIDs: array expected");f.messageIDs=[];for(var h=0;h<u.messageIDs.length;++h)typeof u.messageIDs[h]=="string"?n.base64.decode(u.messageIDs[h],f.messageIDs[h]=n.newBuffer(n.base64.length(u.messageIDs[h])),0):u.messageIDs[h].length&&(f.messageIDs[h]=u.messageIDs[h])}return f},a.toObject=function(u,f){f||(f={});var h={};if((f.arrays||f.defaults)&&(h.messageIDs=[]),u.topicID!=null&&u.hasOwnProperty("topicID")&&(h.topicID=u.topicID,f.oneofs&&(h._topicID="topicID")),u.messageIDs&&u.messageIDs.length){h.messageIDs=[];for(var d=0;d<u.messageIDs.length;++d)h.messageIDs[d]=f.bytes===String?n.base64.encode(u.messageIDs[d],0,u.messageIDs[d].length):f.bytes===Array?Array.prototype.slice.call(u.messageIDs[d]):u.messageIDs[d]}return h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),o.ControlIWant=function(){function a(c){if(this.messageIDs=[],c)for(var l=Object.keys(c),u=0;u<l.length;++u)c[l[u]]!=null&&(this[l[u]]=c[l[u]])}return a.prototype.messageIDs=n.emptyArray,a.encode=function(l,u){if(u||(u=t.create()),l.messageIDs!=null&&l.messageIDs.length)for(var f=0;f<l.messageIDs.length;++f)u.uint32(10).bytes(l.messageIDs[f]);return u},a.decode=function(l,u){l instanceof e||(l=e.create(l));for(var f=u===void 0?l.len:l.pos+u,h=new s.RPC.ControlIWant;l.pos<f;){var d=l.uint32();switch(d>>>3){case 1:h.messageIDs&&h.messageIDs.length||(h.messageIDs=[]),h.messageIDs.push(l.bytes());break;default:l.skipType(d&7);break}}return h},a.fromObject=function(l){if(l instanceof s.RPC.ControlIWant)return l;var u=new s.RPC.ControlIWant;if(l.messageIDs){if(!Array.isArray(l.messageIDs))throw TypeError(".RPC.ControlIWant.messageIDs: array expected");u.messageIDs=[];for(var f=0;f<l.messageIDs.length;++f)typeof l.messageIDs[f]=="string"?n.base64.decode(l.messageIDs[f],u.messageIDs[f]=n.newBuffer(n.base64.length(l.messageIDs[f])),0):l.messageIDs[f].length&&(u.messageIDs[f]=l.messageIDs[f])}return u},a.toObject=function(l,u){u||(u={});var f={};if((u.arrays||u.defaults)&&(f.messageIDs=[]),l.messageIDs&&l.messageIDs.length){f.messageIDs=[];for(var h=0;h<l.messageIDs.length;++h)f.messageIDs[h]=u.bytes===String?n.base64.encode(l.messageIDs[h],0,l.messageIDs[h].length):u.bytes===Array?Array.prototype.slice.call(l.messageIDs[h]):l.messageIDs[h]}return f},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),o.ControlGraft=function(){function a(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.topicID=null;var c;return Object.defineProperty(a.prototype,"_topicID",{get:n.oneOfGetter(c=["topicID"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){return f||(f=t.create()),u.topicID!=null&&Object.hasOwnProperty.call(u,"topicID")&&f.uint32(10).string(u.topicID),f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new s.RPC.ControlGraft;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.topicID=u.string();break;default:u.skipType(p&7);break}}return d},a.fromObject=function(u){if(u instanceof s.RPC.ControlGraft)return u;var f=new s.RPC.ControlGraft;return u.topicID!=null&&(f.topicID=String(u.topicID)),f},a.toObject=function(u,f){f||(f={});var h={};return u.topicID!=null&&u.hasOwnProperty("topicID")&&(h.topicID=u.topicID,f.oneofs&&(h._topicID="topicID")),h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),o.ControlPrune=function(){function a(l){if(this.peers=[],l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.topicID=null,a.prototype.peers=n.emptyArray,a.prototype.backoff=null;var c;return Object.defineProperty(a.prototype,"_topicID",{get:n.oneOfGetter(c=["topicID"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_backoff",{get:n.oneOfGetter(c=["backoff"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){if(f||(f=t.create()),u.topicID!=null&&Object.hasOwnProperty.call(u,"topicID")&&f.uint32(10).string(u.topicID),u.peers!=null&&u.peers.length)for(var h=0;h<u.peers.length;++h)s.RPC.PeerInfo.encode(u.peers[h],f.uint32(18).fork()).ldelim();return u.backoff!=null&&Object.hasOwnProperty.call(u,"backoff")&&f.uint32(24).uint64(u.backoff),f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new s.RPC.ControlPrune;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.topicID=u.string();break;case 2:d.peers&&d.peers.length||(d.peers=[]),d.peers.push(s.RPC.PeerInfo.decode(u,u.uint32()));break;case 3:d.backoff=u.uint64();break;default:u.skipType(p&7);break}}return d},a.fromObject=function(u){if(u instanceof s.RPC.ControlPrune)return u;var f=new s.RPC.ControlPrune;if(u.topicID!=null&&(f.topicID=String(u.topicID)),u.peers){if(!Array.isArray(u.peers))throw TypeError(".RPC.ControlPrune.peers: array expected");f.peers=[];for(var h=0;h<u.peers.length;++h){if(typeof u.peers[h]!="object")throw TypeError(".RPC.ControlPrune.peers: object expected");f.peers[h]=s.RPC.PeerInfo.fromObject(u.peers[h])}}return u.backoff!=null&&(n.Long?(f.backoff=n.Long.fromValue(u.backoff)).unsigned=!0:typeof u.backoff=="string"?f.backoff=parseInt(u.backoff,10):typeof u.backoff=="number"?f.backoff=u.backoff:typeof u.backoff=="object"&&(f.backoff=new n.LongBits(u.backoff.low>>>0,u.backoff.high>>>0).toNumber(!0))),f},a.toObject=function(u,f){f||(f={});var h={};if((f.arrays||f.defaults)&&(h.peers=[]),u.topicID!=null&&u.hasOwnProperty("topicID")&&(h.topicID=u.topicID,f.oneofs&&(h._topicID="topicID")),u.peers&&u.peers.length){h.peers=[];for(var d=0;d<u.peers.length;++d)h.peers[d]=s.RPC.PeerInfo.toObject(u.peers[d],f)}return u.backoff!=null&&u.hasOwnProperty("backoff")&&(typeof u.backoff=="number"?h.backoff=f.longs===String?String(u.backoff):u.backoff:h.backoff=f.longs===String?n.Long.prototype.toString.call(u.backoff):f.longs===Number?new n.LongBits(u.backoff.low>>>0,u.backoff.high>>>0).toNumber(!0):u.backoff,f.oneofs&&(h._backoff="backoff")),h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),o.PeerInfo=function(){function a(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.peerID=null,a.prototype.signedPeerRecord=null;var c;return Object.defineProperty(a.prototype,"_peerID",{get:n.oneOfGetter(c=["peerID"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_signedPeerRecord",{get:n.oneOfGetter(c=["signedPeerRecord"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){return f||(f=t.create()),u.peerID!=null&&Object.hasOwnProperty.call(u,"peerID")&&f.uint32(10).bytes(u.peerID),u.signedPeerRecord!=null&&Object.hasOwnProperty.call(u,"signedPeerRecord")&&f.uint32(18).bytes(u.signedPeerRecord),f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new s.RPC.PeerInfo;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.peerID=u.bytes();break;case 2:d.signedPeerRecord=u.bytes();break;default:u.skipType(p&7);break}}return d},a.fromObject=function(u){if(u instanceof s.RPC.PeerInfo)return u;var f=new s.RPC.PeerInfo;return u.peerID!=null&&(typeof u.peerID=="string"?n.base64.decode(u.peerID,f.peerID=n.newBuffer(n.base64.length(u.peerID)),0):u.peerID.length&&(f.peerID=u.peerID)),u.signedPeerRecord!=null&&(typeof u.signedPeerRecord=="string"?n.base64.decode(u.signedPeerRecord,f.signedPeerRecord=n.newBuffer(n.base64.length(u.signedPeerRecord)),0):u.signedPeerRecord.length&&(f.signedPeerRecord=u.signedPeerRecord)),f},a.toObject=function(u,f){f||(f={});var h={};return u.peerID!=null&&u.hasOwnProperty("peerID")&&(h.peerID=f.bytes===String?n.base64.encode(u.peerID,0,u.peerID.length):f.bytes===Array?Array.prototype.slice.call(u.peerID):u.peerID,f.oneofs&&(h._peerID="peerID")),u.signedPeerRecord!=null&&u.hasOwnProperty("signedPeerRecord")&&(h.signedPeerRecord=f.bytes===String?n.base64.encode(u.signedPeerRecord,0,u.signedPeerRecord.length):f.bytes===Array?Array.prototype.slice.call(u.signedPeerRecord):u.signedPeerRecord,f.oneofs&&(h._signedPeerRecord="signedPeerRecord")),h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),o}(),s})});var bR=Y((Z3e,gR)=>{"use strict";function Pt(r,t){var t=t||{};this._capacity=t.capacity,this._head=0,this._tail=0,Array.isArray(r)?this._fromArray(r):(this._capacityMask=3,this._list=new Array(4))}Pt.prototype.peekAt=function(e){var t=e;if(t===(t|0)){var n=this.size();if(!(t>=n||t<-n))return t<0&&(t+=n),t=this._head+t&this._capacityMask,this._list[t]}};Pt.prototype.get=function(e){return this.peekAt(e)};Pt.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]};Pt.prototype.peekFront=function(){return this.peek()};Pt.prototype.peekBack=function(){return this.peekAt(-1)};Object.defineProperty(Pt.prototype,"length",{get:function(){return this.size()}});Pt.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Pt.prototype.unshift=function(e){if(arguments.length===0)return this.size();var t=this._list.length;return this._head=this._head-1+t&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Pt.prototype.shift=function(){var e=this._head;if(e!==this._tail){var t=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),t}};Pt.prototype.push=function(e){if(arguments.length===0)return this.size();var t=this._tail;return this._list[t]=e,this._tail=t+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Pt.prototype.pop=function(){var e=this._tail;if(e!==this._head){var t=this._list.length;this._tail=e-1+t&this._capacityMask;var n=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=t>>>2&&this._shrinkArray(),n}};Pt.prototype.removeOne=function(e){var t=e;if(t===(t|0)&&this._head!==this._tail){var n=this.size(),s=this._list.length;if(!(t>=n||t<-n)){t<0&&(t+=n),t=this._head+t&this._capacityMask;var o=this._list[t],i;if(e<n/2){for(i=e;i>0;i--)this._list[t]=this._list[t=t-1+s&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+s&this._capacityMask}else{for(i=n-1-e;i>0;i--)this._list[t]=this._list[t=t+1+s&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+s&this._capacityMask}return o}}};Pt.prototype.remove=function(e,t){var n=e,s,o=t;if(n===(n|0)&&this._head!==this._tail){var i=this.size(),a=this._list.length;if(!(n>=i||n<-i||t<1)){if(n<0&&(n+=i),t===1||!t)return s=new Array(1),s[0]=this.removeOne(n),s;if(n===0&&n+t>=i)return s=this.toArray(),this.clear(),s;n+t>i&&(t=i-n);var c;for(s=new Array(t),c=0;c<t;c++)s[c]=this._list[this._head+n+c&this._capacityMask];if(n=this._head+n&this._capacityMask,e+t===i){for(this._tail=this._tail-t+a&this._capacityMask,c=t;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(e===0){for(this._head=this._head+t+a&this._capacityMask,c=t-1;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(n<i/2){for(this._head=this._head+e+t+a&this._capacityMask,c=e;c>0;c--)this.unshift(this._list[n=n-1+a&this._capacityMask]);for(n=this._head-1+a&this._capacityMask;o>0;)this._list[n=n-1+a&this._capacityMask]=void 0,o--;e<0&&(this._tail=n)}else{for(this._tail=n,n=n+t+a&this._capacityMask,c=i-(t+e);c>0;c--)this.push(this._list[n++]);for(n=this._tail;o>0;)this._list[n=n+1+a&this._capacityMask]=void 0,o--}return this._head<2&&this._tail>1e4&&this._tail<=a>>>2&&this._shrinkArray(),s}}};Pt.prototype.splice=function(e,t){var n=e;if(n===(n|0)){var s=this.size();if(n<0&&(n+=s),!(n>s))if(arguments.length>2){var o,i,a,c=arguments.length,l=this._list.length,u=2;if(!s||n<s/2){for(i=new Array(n),o=0;o<n;o++)i[o]=this._list[this._head+o&this._capacityMask];for(t===0?(a=[],n>0&&(this._head=this._head+n+l&this._capacityMask)):(a=this.remove(n,t),this._head=this._head+n+l&this._capacityMask);c>u;)this.unshift(arguments[--c]);for(o=n;o>0;o--)this.unshift(i[o-1])}else{i=new Array(s-(n+t));var f=i.length;for(o=0;o<f;o++)i[o]=this._list[this._head+n+t+o&this._capacityMask];for(t===0?(a=[],n!=s&&(this._tail=this._head+n+l&this._capacityMask)):(a=this.remove(n,t),this._tail=this._tail-f+l&this._capacityMask);u<c;)this.push(arguments[u++]);for(o=0;o<f;o++)this.push(i[o])}return a}else return this.remove(n,t)}};Pt.prototype.clear=function(){this._list=new Array(this._list.length),this._head=0,this._tail=0};Pt.prototype.isEmpty=function(){return this._head===this._tail};Pt.prototype.toArray=function(){return this._copyArray(!1)};Pt.prototype._fromArray=function(e){var t=e.length,n=this._nextPowerOf2(t);this._list=new Array(n),this._capacityMask=n-1,this._tail=t;for(var s=0;s<t;s++)this._list[s]=e[s]};Pt.prototype._copyArray=function(e,t){var n=this._list,s=n.length,o=this.length;if(t=t|o,t==o&&this._head<this._tail)return this._list.slice(this._head,this._tail);var i=new Array(t),a=0,c;if(e||this._head>this._tail){for(c=this._head;c<s;c++)i[a++]=n[c];for(c=0;c<this._tail;c++)i[a++]=n[c]}else for(c=this._head;c<this._tail;c++)i[a++]=n[c];return i};Pt.prototype._growArray=function(){if(this._head!=0){var e=this._copyArray(!0,this._list.length<<1);this._tail=this._list.length,this._head=0,this._list=e}else this._tail=this._list.length,this._list.length<<=1;this._capacityMask=this._capacityMask<<1|1};Pt.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1};Pt.prototype._nextPowerOf2=function(e){var t=Math.log(e)/Math.log(2),n=1<<t+1;return Math.max(n,4)};gR.exports=Pt});var Ge=Y((I4e,vR)=>{vR.exports={options:{usePureJavaScript:!1}}});var _R=Y((T4e,SR)=>{var N8={};SR.exports=N8;var xR={};N8.encode=function(r,e,t){if(typeof e!="string")throw new TypeError('"alphabet" must be a string.');if(t!==void 0&&typeof t!="number")throw new TypeError('"maxline" must be a number.');var n="";if(!(r instanceof Uint8Array))n=LG(r,e);else{var s=0,o=e.length,i=e.charAt(0),a=[0];for(s=0;s<r.length;++s){for(var c=0,l=r[s];c<a.length;++c)l+=a[c]<<8,a[c]=l%o,l=l/o|0;for(;l>0;)a.push(l%o),l=l/o|0}for(s=0;r[s]===0&&s<r.length-1;++s)n+=i;for(s=a.length-1;s>=0;--s)n+=e[a[s]]}if(t){var u=new RegExp(".{1,"+t+"}","g");n=n.match(u).join(`\r
`)}return n};N8.decode=function(r,e){if(typeof r!="string")throw new TypeError('"input" must be a string.');if(typeof e!="string")throw new TypeError('"alphabet" must be a string.');var t=xR[e];if(!t){t=xR[e]=[];for(var n=0;n<e.length;++n)t[e.charCodeAt(n)]=n}r=r.replace(/\s/g,"");for(var s=e.length,o=e.charAt(0),i=[0],n=0;n<r.length;n++){var a=t[r.charCodeAt(n)];if(a===void 0)return;for(var c=0,l=a;c<i.length;++c)l+=i[c]*s,i[c]=l&255,l>>=8;for(;l>0;)i.push(l&255),l>>=8}for(var u=0;r[u]===o&&u<r.length-1;++u)i.push(0);return typeof Buffer<"u"?Buffer.from(i.reverse()):new Uint8Array(i.reverse())};function LG(r,e){var t=0,n=e.length,s=e.charAt(0),o=[0];for(t=0;t<r.length();++t){for(var i=0,a=r.at(t);i<o.length;++i)a+=o[i]<<8,o[i]=a%n,a=a/n|0;for(;a>0;)o.push(a%n),a=a/n|0}var c="";for(t=0;r.at(t)===0&&t<r.length()-1;++t)c+=s;for(t=o.length-1;t>=0;--t)c+=e[o[t]];return c}});var Kt=Y((k4e,TR)=>{var AR=Ge(),RR=_R(),I=TR.exports=AR.util=AR.util||{};(function(){if(typeof process<"u"&&process.nextTick&&!process.browser){I.nextTick=process.nextTick,typeof setImmediate=="function"?I.setImmediate=setImmediate:I.setImmediate=I.nextTick;return}if(typeof setImmediate=="function"){I.setImmediate=function(){return setImmediate.apply(void 0,arguments)},I.nextTick=function(a){return setImmediate(a)};return}if(I.setImmediate=function(a){setTimeout(a,0)},typeof window<"u"&&typeof window.postMessage=="function"){let a=function(c){if(c.source===window&&c.data===r){c.stopPropagation();var l=e.slice();e.length=0,l.forEach(function(u){u()})}};var i=a,r="forge.setImmediate",e=[];I.setImmediate=function(c){e.push(c),e.length===1&&window.postMessage(r,"*")},window.addEventListener("message",a,!0)}if(typeof MutationObserver<"u"){var t=Date.now(),n=!0,s=document.createElement("div"),e=[];new MutationObserver(function(){var c=e.slice();e.length=0,c.forEach(function(l){l()})}).observe(s,{attributes:!0});var o=I.setImmediate;I.setImmediate=function(c){Date.now()-t>15?(t=Date.now(),o(c)):(e.push(c),e.length===1&&s.setAttribute("a",n=!n))}}I.nextTick=I.setImmediate})();I.isNodejs=typeof process<"u"&&process.versions&&process.versions.node;I.globalScope=function(){return I.isNodejs?globalThis:typeof self>"u"?window:self}();I.isArray=Array.isArray||function(r){return Object.prototype.toString.call(r)==="[object Array]"};I.isArrayBuffer=function(r){return typeof ArrayBuffer<"u"&&r instanceof ArrayBuffer};I.isArrayBufferView=function(r){return r&&I.isArrayBuffer(r.buffer)&&r.byteLength!==void 0};function ip(r){if(!(r===8||r===16||r===24||r===32))throw new Error("Only 8, 16, 24, or 32 bits supported: "+r)}I.ByteBuffer=L8;function L8(r){if(this.data="",this.read=0,typeof r=="string")this.data=r;else if(I.isArrayBuffer(r)||I.isArrayBufferView(r))if(typeof Buffer<"u"&&r instanceof Buffer)this.data=r.toString("binary");else{var e=new Uint8Array(r);try{this.data=String.fromCharCode.apply(null,e)}catch{for(var t=0;t<e.length;++t)this.putByte(e[t])}}else(r instanceof L8||typeof r=="object"&&typeof r.data=="string"&&typeof r.read=="number")&&(this.data=r.data,this.read=r.read);this._constructedStringLength=0}I.ByteStringBuffer=L8;var OG=4096;I.ByteStringBuffer.prototype._optimizeConstructedString=function(r){this._constructedStringLength+=r,this._constructedStringLength>OG&&(this.data.substr(0,1),this._constructedStringLength=0)};I.ByteStringBuffer.prototype.length=function(){return this.data.length-this.read};I.ByteStringBuffer.prototype.isEmpty=function(){return this.length()<=0};I.ByteStringBuffer.prototype.putByte=function(r){return this.putBytes(String.fromCharCode(r))};I.ByteStringBuffer.prototype.fillWithByte=function(r,e){r=String.fromCharCode(r);for(var t=this.data;e>0;)e&1&&(t+=r),e>>>=1,e>0&&(r+=r);return this.data=t,this._optimizeConstructedString(e),this};I.ByteStringBuffer.prototype.putBytes=function(r){return this.data+=r,this._optimizeConstructedString(r.length),this};I.ByteStringBuffer.prototype.putString=function(r){return this.putBytes(I.encodeUtf8(r))};I.ByteStringBuffer.prototype.putInt16=function(r){return this.putBytes(String.fromCharCode(r>>8&255)+String.fromCharCode(r&255))};I.ByteStringBuffer.prototype.putInt24=function(r){return this.putBytes(String.fromCharCode(r>>16&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r&255))};I.ByteStringBuffer.prototype.putInt32=function(r){return this.putBytes(String.fromCharCode(r>>24&255)+String.fromCharCode(r>>16&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r&255))};I.ByteStringBuffer.prototype.putInt16Le=function(r){return this.putBytes(String.fromCharCode(r&255)+String.fromCharCode(r>>8&255))};I.ByteStringBuffer.prototype.putInt24Le=function(r){return this.putBytes(String.fromCharCode(r&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r>>16&255))};I.ByteStringBuffer.prototype.putInt32Le=function(r){return this.putBytes(String.fromCharCode(r&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r>>16&255)+String.fromCharCode(r>>24&255))};I.ByteStringBuffer.prototype.putInt=function(r,e){ip(e);var t="";do e-=8,t+=String.fromCharCode(r>>e&255);while(e>0);return this.putBytes(t)};I.ByteStringBuffer.prototype.putSignedInt=function(r,e){return r<0&&(r+=2<<e-1),this.putInt(r,e)};I.ByteStringBuffer.prototype.putBuffer=function(r){return this.putBytes(r.getBytes())};I.ByteStringBuffer.prototype.getByte=function(){return this.data.charCodeAt(this.read++)};I.ByteStringBuffer.prototype.getInt16=function(){var r=this.data.charCodeAt(this.read)<<8^this.data.charCodeAt(this.read+1);return this.read+=2,r};I.ByteStringBuffer.prototype.getInt24=function(){var r=this.data.charCodeAt(this.read)<<16^this.data.charCodeAt(this.read+1)<<8^this.data.charCodeAt(this.read+2);return this.read+=3,r};I.ByteStringBuffer.prototype.getInt32=function(){var r=this.data.charCodeAt(this.read)<<24^this.data.charCodeAt(this.read+1)<<16^this.data.charCodeAt(this.read+2)<<8^this.data.charCodeAt(this.read+3);return this.read+=4,r};I.ByteStringBuffer.prototype.getInt16Le=function(){var r=this.data.charCodeAt(this.read)^this.data.charCodeAt(this.read+1)<<8;return this.read+=2,r};I.ByteStringBuffer.prototype.getInt24Le=function(){var r=this.data.charCodeAt(this.read)^this.data.charCodeAt(this.read+1)<<8^this.data.charCodeAt(this.read+2)<<16;return this.read+=3,r};I.ByteStringBuffer.prototype.getInt32Le=function(){var r=this.data.charCodeAt(this.read)^this.data.charCodeAt(this.read+1)<<8^this.data.charCodeAt(this.read+2)<<16^this.data.charCodeAt(this.read+3)<<24;return this.read+=4,r};I.ByteStringBuffer.prototype.getInt=function(r){ip(r);var e=0;do e=(e<<8)+this.data.charCodeAt(this.read++),r-=8;while(r>0);return e};I.ByteStringBuffer.prototype.getSignedInt=function(r){var e=this.getInt(r),t=2<<r-2;return e>=t&&(e-=t<<1),e};I.ByteStringBuffer.prototype.getBytes=function(r){var e;return r?(r=Math.min(this.length(),r),e=this.data.slice(this.read,this.read+r),this.read+=r):r===0?e="":(e=this.read===0?this.data:this.data.slice(this.read),this.clear()),e};I.ByteStringBuffer.prototype.bytes=function(r){return typeof r>"u"?this.data.slice(this.read):this.data.slice(this.read,this.read+r)};I.ByteStringBuffer.prototype.at=function(r){return this.data.charCodeAt(this.read+r)};I.ByteStringBuffer.prototype.setAt=function(r,e){return this.data=this.data.substr(0,this.read+r)+String.fromCharCode(e)+this.data.substr(this.read+r+1),this};I.ByteStringBuffer.prototype.last=function(){return this.data.charCodeAt(this.data.length-1)};I.ByteStringBuffer.prototype.copy=function(){var r=I.createBuffer(this.data);return r.read=this.read,r};I.ByteStringBuffer.prototype.compact=function(){return this.read>0&&(this.data=this.data.slice(this.read),this.read=0),this};I.ByteStringBuffer.prototype.clear=function(){return this.data="",this.read=0,this};I.ByteStringBuffer.prototype.truncate=function(r){var e=Math.max(0,this.length()-r);return this.data=this.data.substr(this.read,e),this.read=0,this};I.ByteStringBuffer.prototype.toHex=function(){for(var r="",e=this.read;e<this.data.length;++e){var t=this.data.charCodeAt(e);t<16&&(r+="0"),r+=t.toString(16)}return r};I.ByteStringBuffer.prototype.toString=function(){return I.decodeUtf8(this.bytes())};function KG(r,e){e=e||{},this.read=e.readOffset||0,this.growSize=e.growSize||1024;var t=I.isArrayBuffer(r),n=I.isArrayBufferView(r);if(t||n){t?this.data=new DataView(r):this.data=new DataView(r.buffer,r.byteOffset,r.byteLength),this.write="writeOffset"in e?e.writeOffset:this.data.byteLength;return}this.data=new DataView(new ArrayBuffer(0)),this.write=0,r!=null&&this.putBytes(r),"writeOffset"in e&&(this.write=e.writeOffset)}I.DataBuffer=KG;I.DataBuffer.prototype.length=function(){return this.write-this.read};I.DataBuffer.prototype.isEmpty=function(){return this.length()<=0};I.DataBuffer.prototype.accommodate=function(r,e){if(this.length()>=r)return this;e=Math.max(e||this.growSize,r);var t=new Uint8Array(this.data.buffer,this.data.byteOffset,this.data.byteLength),n=new Uint8Array(this.length()+e);return n.set(t),this.data=new DataView(n.buffer),this};I.DataBuffer.prototype.putByte=function(r){return this.accommodate(1),this.data.setUint8(this.write++,r),this};I.DataBuffer.prototype.fillWithByte=function(r,e){this.accommodate(e);for(var t=0;t<e;++t)this.data.setUint8(r);return this};I.DataBuffer.prototype.putBytes=function(r,e){if(I.isArrayBufferView(r)){var t=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),n=t.byteLength-t.byteOffset;this.accommodate(n);var s=new Uint8Array(this.data.buffer,this.write);return s.set(t),this.write+=n,this}if(I.isArrayBuffer(r)){var t=new Uint8Array(r);this.accommodate(t.byteLength);var s=new Uint8Array(this.data.buffer);return s.set(t,this.write),this.write+=t.byteLength,this}if(r instanceof I.DataBuffer||typeof r=="object"&&typeof r.read=="number"&&typeof r.write=="number"&&I.isArrayBufferView(r.data)){var t=new Uint8Array(r.data.byteLength,r.read,r.length());this.accommodate(t.byteLength);var s=new Uint8Array(r.data.byteLength,this.write);return s.set(t),this.write+=t.byteLength,this}if(r instanceof I.ByteStringBuffer&&(r=r.data,e="binary"),e=e||"binary",typeof r=="string"){var o;if(e==="hex")return this.accommodate(Math.ceil(r.length/2)),o=new Uint8Array(this.data.buffer,this.write),this.write+=I.binary.hex.decode(r,o,this.write),this;if(e==="base64")return this.accommodate(Math.ceil(r.length/4)*3),o=new Uint8Array(this.data.buffer,this.write),this.write+=I.binary.base64.decode(r,o,this.write),this;if(e==="utf8"&&(r=I.encodeUtf8(r),e="binary"),e==="binary"||e==="raw")return this.accommodate(r.length),o=new Uint8Array(this.data.buffer,this.write),this.write+=I.binary.raw.decode(o),this;if(e==="utf16")return this.accommodate(r.length*2),o=new Uint16Array(this.data.buffer,this.write),this.write+=I.text.utf16.encode(o),this;throw new Error("Invalid encoding: "+e)}throw Error("Invalid parameter: "+r)};I.DataBuffer.prototype.putBuffer=function(r){return this.putBytes(r),r.clear(),this};I.DataBuffer.prototype.putString=function(r){return this.putBytes(r,"utf16")};I.DataBuffer.prototype.putInt16=function(r){return this.accommodate(2),this.data.setInt16(this.write,r),this.write+=2,this};I.DataBuffer.prototype.putInt24=function(r){return this.accommodate(3),this.data.setInt16(this.write,r>>8&65535),this.data.setInt8(this.write,r>>16&255),this.write+=3,this};I.DataBuffer.prototype.putInt32=function(r){return this.accommodate(4),this.data.setInt32(this.write,r),this.write+=4,this};I.DataBuffer.prototype.putInt16Le=function(r){return this.accommodate(2),this.data.setInt16(this.write,r,!0),this.write+=2,this};I.DataBuffer.prototype.putInt24Le=function(r){return this.accommodate(3),this.data.setInt8(this.write,r>>16&255),this.data.setInt16(this.write,r>>8&65535,!0),this.write+=3,this};I.DataBuffer.prototype.putInt32Le=function(r){return this.accommodate(4),this.data.setInt32(this.write,r,!0),this.write+=4,this};I.DataBuffer.prototype.putInt=function(r,e){ip(e),this.accommodate(e/8);do e-=8,this.data.setInt8(this.write++,r>>e&255);while(e>0);return this};I.DataBuffer.prototype.putSignedInt=function(r,e){return ip(e),this.accommodate(e/8),r<0&&(r+=2<<e-1),this.putInt(r,e)};I.DataBuffer.prototype.getByte=function(){return this.data.getInt8(this.read++)};I.DataBuffer.prototype.getInt16=function(){var r=this.data.getInt16(this.read);return this.read+=2,r};I.DataBuffer.prototype.getInt24=function(){var r=this.data.getInt16(this.read)<<8^this.data.getInt8(this.read+2);return this.read+=3,r};I.DataBuffer.prototype.getInt32=function(){var r=this.data.getInt32(this.read);return this.read+=4,r};I.DataBuffer.prototype.getInt16Le=function(){var r=this.data.getInt16(this.read,!0);return this.read+=2,r};I.DataBuffer.prototype.getInt24Le=function(){var r=this.data.getInt8(this.read)^this.data.getInt16(this.read+1,!0)<<8;return this.read+=3,r};I.DataBuffer.prototype.getInt32Le=function(){var r=this.data.getInt32(this.read,!0);return this.read+=4,r};I.DataBuffer.prototype.getInt=function(r){ip(r);var e=0;do e=(e<<8)+this.data.getInt8(this.read++),r-=8;while(r>0);return e};I.DataBuffer.prototype.getSignedInt=function(r){var e=this.getInt(r),t=2<<r-2;return e>=t&&(e-=t<<1),e};I.DataBuffer.prototype.getBytes=function(r){var e;return r?(r=Math.min(this.length(),r),e=this.data.slice(this.read,this.read+r),this.read+=r):r===0?e="":(e=this.read===0?this.data:this.data.slice(this.read),this.clear()),e};I.DataBuffer.prototype.bytes=function(r){return typeof r>"u"?this.data.slice(this.read):this.data.slice(this.read,this.read+r)};I.DataBuffer.prototype.at=function(r){return this.data.getUint8(this.read+r)};I.DataBuffer.prototype.setAt=function(r,e){return this.data.setUint8(r,e),this};I.DataBuffer.prototype.last=function(){return this.data.getUint8(this.write-1)};I.DataBuffer.prototype.copy=function(){return new I.DataBuffer(this)};I.DataBuffer.prototype.compact=function(){if(this.read>0){var r=new Uint8Array(this.data.buffer,this.read),e=new Uint8Array(r.byteLength);e.set(r),this.data=new DataView(e),this.write-=this.read,this.read=0}return this};I.DataBuffer.prototype.clear=function(){return this.data=new DataView(new ArrayBuffer(0)),this.read=this.write=0,this};I.DataBuffer.prototype.truncate=function(r){return this.write=Math.max(0,this.length()-r),this.read=Math.min(this.read,this.write),this};I.DataBuffer.prototype.toHex=function(){for(var r="",e=this.read;e<this.data.byteLength;++e){var t=this.data.getUint8(e);t<16&&(r+="0"),r+=t.toString(16)}return r};I.DataBuffer.prototype.toString=function(r){var e=new Uint8Array(this.data,this.read,this.length());if(r=r||"utf8",r==="binary"||r==="raw")return I.binary.raw.encode(e);if(r==="hex")return I.binary.hex.encode(e);if(r==="base64")return I.binary.base64.encode(e);if(r==="utf8")return I.text.utf8.decode(e);if(r==="utf16")return I.text.utf16.decode(e);throw new Error("Invalid encoding: "+r)};I.createBuffer=function(r,e){return e=e||"raw",r!==void 0&&e==="utf8"&&(r=I.encodeUtf8(r)),new I.ByteBuffer(r)};I.fillString=function(r,e){for(var t="";e>0;)e&1&&(t+=r),e>>>=1,e>0&&(r+=r);return t};I.xorBytes=function(r,e,t){for(var n="",s="",o="",i=0,a=0;t>0;--t,++i)s=r.charCodeAt(i)^e.charCodeAt(i),a>=10&&(n+=o,o="",a=0),o+=String.fromCharCode(s),++a;return n+=o,n};I.hexToBytes=function(r){var e="",t=0;for(r.length&!0&&(t=1,e+=String.fromCharCode(parseInt(r[0],16)));t<r.length;t+=2)e+=String.fromCharCode(parseInt(r.substr(t,2),16));return e};I.bytesToHex=function(r){return I.createBuffer(r).toHex()};I.int32ToBytes=function(r){return String.fromCharCode(r>>24&255)+String.fromCharCode(r>>16&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r&255)};var ta="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",ra=[62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,64,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51],IR="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";I.encode64=function(r,e){for(var t="",n="",s,o,i,a=0;a<r.length;)s=r.charCodeAt(a++),o=r.charCodeAt(a++),i=r.charCodeAt(a++),t+=ta.charAt(s>>2),t+=ta.charAt((s&3)<<4|o>>4),isNaN(o)?t+="==":(t+=ta.charAt((o&15)<<2|i>>6),t+=isNaN(i)?"=":ta.charAt(i&63)),e&&t.length>e&&(n+=t.substr(0,e)+`\r
`,t=t.substr(e));return n+=t,n};I.decode64=function(r){r=r.replace(/[^A-Za-z0-9\+\/\=]/g,"");for(var e="",t,n,s,o,i=0;i<r.length;)t=ra[r.charCodeAt(i++)-43],n=ra[r.charCodeAt(i++)-43],s=ra[r.charCodeAt(i++)-43],o=ra[r.charCodeAt(i++)-43],e+=String.fromCharCode(t<<2|n>>4),s!==64&&(e+=String.fromCharCode((n&15)<<4|s>>2),o!==64&&(e+=String.fromCharCode((s&3)<<6|o)));return e};I.encodeUtf8=function(r){return unescape(encodeURIComponent(r))};I.decodeUtf8=function(r){return decodeURIComponent(escape(r))};I.binary={raw:{},hex:{},base64:{},base58:{},baseN:{encode:RR.encode,decode:RR.decode}};I.binary.raw.encode=function(r){return String.fromCharCode.apply(null,r)};I.binary.raw.decode=function(r,e,t){var n=e;n||(n=new Uint8Array(r.length)),t=t||0;for(var s=t,o=0;o<r.length;++o)n[s++]=r.charCodeAt(o);return e?s-t:n};I.binary.hex.encode=I.bytesToHex;I.binary.hex.decode=function(r,e,t){var n=e;n||(n=new Uint8Array(Math.ceil(r.length/2))),t=t||0;var s=0,o=t;for(r.length&1&&(s=1,n[o++]=parseInt(r[0],16));s<r.length;s+=2)n[o++]=parseInt(r.substr(s,2),16);return e?o-t:n};I.binary.base64.encode=function(r,e){for(var t="",n="",s,o,i,a=0;a<r.byteLength;)s=r[a++],o=r[a++],i=r[a++],t+=ta.charAt(s>>2),t+=ta.charAt((s&3)<<4|o>>4),isNaN(o)?t+="==":(t+=ta.charAt((o&15)<<2|i>>6),t+=isNaN(i)?"=":ta.charAt(i&63)),e&&t.length>e&&(n+=t.substr(0,e)+`\r
`,t=t.substr(e));return n+=t,n};I.binary.base64.decode=function(r,e,t){var n=e;n||(n=new Uint8Array(Math.ceil(r.length/4)*3)),r=r.replace(/[^A-Za-z0-9\+\/\=]/g,""),t=t||0;for(var s,o,i,a,c=0,l=t;c<r.length;)s=ra[r.charCodeAt(c++)-43],o=ra[r.charCodeAt(c++)-43],i=ra[r.charCodeAt(c++)-43],a=ra[r.charCodeAt(c++)-43],n[l++]=s<<2|o>>4,i!==64&&(n[l++]=(o&15)<<4|i>>2,a!==64&&(n[l++]=(i&3)<<6|a));return e?l-t:n.subarray(0,l)};I.binary.base58.encode=function(r,e){return I.binary.baseN.encode(r,IR,e)};I.binary.base58.decode=function(r,e){return I.binary.baseN.decode(r,IR,e)};I.text={utf8:{},utf16:{}};I.text.utf8.encode=function(r,e,t){r=I.encodeUtf8(r);var n=e;n||(n=new Uint8Array(r.length)),t=t||0;for(var s=t,o=0;o<r.length;++o)n[s++]=r.charCodeAt(o);return e?s-t:n};I.text.utf8.decode=function(r){return I.decodeUtf8(String.fromCharCode.apply(null,r))};I.text.utf16.encode=function(r,e,t){var n=e;n||(n=new Uint8Array(r.length*2));var s=new Uint16Array(n.buffer);t=t||0;for(var o=t,i=t,a=0;a<r.length;++a)s[i++]=r.charCodeAt(a),o+=2;return e?o-t:n};I.text.utf16.decode=function(r){return String.fromCharCode.apply(null,new Uint16Array(r.buffer))};I.deflate=function(r,e,t){if(e=I.decode64(r.deflate(I.encode64(e)).rval),t){var n=2,s=e.charCodeAt(1);s&32&&(n=6),e=e.substring(n,e.length-4)}return e};I.inflate=function(r,e,t){var n=r.inflate(I.encode64(e)).rval;return n===null?null:I.decode64(n)};var O8=function(r,e,t){if(!r)throw new Error("WebStorage not available.");var n;if(t===null?n=r.removeItem(e):(t=I.encode64(JSON.stringify(t)),n=r.setItem(e,t)),typeof n<"u"&&n.rval!==!0){var s=new Error(n.error.message);throw s.id=n.error.id,s.name=n.error.name,s}},K8=function(r,e){if(!r)throw new Error("WebStorage not available.");var t=r.getItem(e);if(r.init)if(t.rval===null){if(t.error){var n=new Error(t.error.message);throw n.id=t.error.id,n.name=t.error.name,n}t=null}else t=t.rval;return t!==null&&(t=JSON.parse(I.decode64(t))),t},MG=function(r,e,t,n){var s=K8(r,e);s===null&&(s={}),s[t]=n,O8(r,e,s)},UG=function(r,e,t){var n=K8(r,e);return n!==null&&(n=t in n?n[t]:null),n},FG=function(r,e,t){var n=K8(r,e);if(n!==null&&t in n){delete n[t];var s=!0;for(var o in n){s=!1;break}s&&(n=null),O8(r,e,n)}},VG=function(r,e){O8(r,e,null)},y1=function(r,e,t){var n=null;typeof t>"u"&&(t=["web","flash"]);var s,o=!1,i=null;for(var a in t){s=t[a];try{if(s==="flash"||s==="both"){if(e[0]===null)throw new Error("Flash local storage not available.");n=r.apply(this,e),o=s==="flash"}(s==="web"||s==="both")&&(e[0]=localStorage,n=r.apply(this,e),o=!0)}catch(c){i=c}if(o)break}if(!o)throw i;return n};I.setItem=function(r,e,t,n,s){y1(MG,arguments,s)};I.getItem=function(r,e,t,n){return y1(UG,arguments,n)};I.removeItem=function(r,e,t,n){y1(FG,arguments,n)};I.clearItems=function(r,e,t){y1(VG,arguments,t)};I.isEmpty=function(r){for(var e in r)if(r.hasOwnProperty(e))return!1;return!0};I.format=function(r){for(var e=/%./g,t,n,s=0,o=[],i=0;t=e.exec(r);){n=r.substring(i,e.lastIndex-2),n.length>0&&o.push(n),i=e.lastIndex;var a=t[0][1];switch(a){case"s":case"o":s<arguments.length?o.push(arguments[s+++1]):o.push("<?>");break;case"%":o.push("%");break;default:o.push("<%"+a+"?>")}}return o.push(r.substring(i)),o.join("")};I.formatNumber=function(r,e,t,n){var s=r,o=isNaN(e=Math.abs(e))?2:e,i=t===void 0?",":t,a=n===void 0?".":n,c=s<0?"-":"",l=parseInt(s=Math.abs(+s||0).toFixed(o),10)+"",u=l.length>3?l.length%3:0;return c+(u?l.substr(0,u)+a:"")+l.substr(u).replace(/(\d{3})(?=\d)/g,"$1"+a)+(o?i+Math.abs(s-l).toFixed(o).slice(2):"")};I.formatSize=function(r){return r>=1073741824?r=I.formatNumber(r/1073741824,2,".","")+" GiB":r>=1048576?r=I.formatNumber(r/1048576,2,".","")+" MiB":r>=1024?r=I.formatNumber(r/1024,0)+" KiB":r=I.formatNumber(r,0)+" bytes",r};I.bytesFromIP=function(r){return r.indexOf(".")!==-1?I.bytesFromIPv4(r):r.indexOf(":")!==-1?I.bytesFromIPv6(r):null};I.bytesFromIPv4=function(r){if(r=r.split("."),r.length!==4)return null;for(var e=I.createBuffer(),t=0;t<r.length;++t){var n=parseInt(r[t],10);if(isNaN(n))return null;e.putByte(n)}return e.getBytes()};I.bytesFromIPv6=function(r){var e=0;r=r.split(":").filter(function(i){return i.length===0&&++e,!0});for(var t=(8-r.length+e)*2,n=I.createBuffer(),s=0;s<8;++s){if(!r[s]||r[s].length===0){n.fillWithByte(0,t),t=0;continue}var o=I.hexToBytes(r[s]);o.length<2&&n.putByte(0),n.putBytes(o)}return n.getBytes()};I.bytesToIP=function(r){return r.length===4?I.bytesToIPv4(r):r.length===16?I.bytesToIPv6(r):null};I.bytesToIPv4=function(r){if(r.length!==4)return null;for(var e=[],t=0;t<r.length;++t)e.push(r.charCodeAt(t));return e.join(".")};I.bytesToIPv6=function(r){if(r.length!==16)return null;for(var e=[],t=[],n=0,s=0;s<r.length;s+=2){for(var o=I.bytesToHex(r[s]+r[s+1]);o[0]==="0"&&o!=="0";)o=o.substr(1);if(o==="0"){var i=t[t.length-1],a=e.length;!i||a!==i.end+1?t.push({start:a,end:a}):(i.end=a,i.end-i.start>t[n].end-t[n].start&&(n=t.length-1))}e.push(o)}if(t.length>0){var c=t[n];c.end-c.start>0&&(e.splice(c.start,c.end-c.start+1,""),c.start===0&&e.unshift(""),c.end===7&&e.push(""))}return e.join(":")};I.estimateCores=function(r,e){if(typeof r=="function"&&(e=r,r={}),r=r||{},"cores"in I&&!r.update)return e(null,I.cores);if(typeof navigator<"u"&&"hardwareConcurrency"in navigator&&navigator.hardwareConcurrency>0)return I.cores=navigator.hardwareConcurrency,e(null,I.cores);if(typeof Worker>"u")return I.cores=1,e(null,I.cores);if(typeof Blob>"u")return I.cores=2,e(null,I.cores);var t=URL.createObjectURL(new Blob(["(",function(){self.addEventListener("message",function(i){for(var a=Date.now(),c=a+4;Date.now()<c;);self.postMessage({st:a,et:c})})}.toString(),")()"],{type:"application/javascript"}));n([],5,16);function n(i,a,c){if(a===0){var l=Math.floor(i.reduce(function(u,f){return u+f},0)/i.length);return I.cores=Math.max(1,l),URL.revokeObjectURL(t),e(null,I.cores)}s(c,function(u,f){i.push(o(c,f)),n(i,a-1,c)})}function s(i,a){for(var c=[],l=[],u=0;u<i;++u){var f=new Worker(t);f.addEventListener("message",function(h){if(l.push(h.data),l.length===i){for(var d=0;d<i;++d)c[d].terminate();a(null,l)}}),c.push(f)}for(var u=0;u<i;++u)c[u].postMessage(u)}function o(i,a){for(var c=[],l=0;l<i;++l)for(var u=a[l],f=c[l]=[],h=0;h<i;++h)if(l!==h){var d=a[h];(u.st>d.st&&u.st<d.et||d.st>u.st&&d.st<u.et)&&f.push(h)}return c.reduce(function(p,m){return Math.max(p,m.length)},0)}}});var U8=Y((D4e,kR)=>{var pr=Ge();Kt();kR.exports=pr.cipher=pr.cipher||{};pr.cipher.algorithms=pr.cipher.algorithms||{};pr.cipher.createCipher=function(r,e){var t=r;if(typeof t=="string"&&(t=pr.cipher.getAlgorithm(t),t&&(t=t())),!t)throw new Error("Unsupported algorithm: "+r);return new pr.cipher.BlockCipher({algorithm:t,key:e,decrypt:!1})};pr.cipher.createDecipher=function(r,e){var t=r;if(typeof t=="string"&&(t=pr.cipher.getAlgorithm(t),t&&(t=t())),!t)throw new Error("Unsupported algorithm: "+r);return new pr.cipher.BlockCipher({algorithm:t,key:e,decrypt:!0})};pr.cipher.registerAlgorithm=function(r,e){r=r.toUpperCase(),pr.cipher.algorithms[r]=e};pr.cipher.getAlgorithm=function(r){return r=r.toUpperCase(),r in pr.cipher.algorithms?pr.cipher.algorithms[r]:null};var M8=pr.cipher.BlockCipher=function(r){this.algorithm=r.algorithm,this.mode=this.algorithm.mode,this.blockSize=this.mode.blockSize,this._finish=!1,this._input=null,this.output=null,this._op=r.decrypt?this.mode.decrypt:this.mode.encrypt,this._decrypt=r.decrypt,this.algorithm.initialize(r)};M8.prototype.start=function(r){r=r||{};var e={};for(var t in r)e[t]=r[t];e.decrypt=this._decrypt,this._finish=!1,this._input=pr.util.createBuffer(),this.output=r.output||pr.util.createBuffer(),this.mode.start(e)};M8.prototype.update=function(r){for(r&&this._input.putBuffer(r);!this._op.call(this.mode,this._input,this.output,this._finish)&&!this._finish;);this._input.compact()};M8.prototype.finish=function(r){r&&(this.mode.name==="ECB"||this.mode.name==="CBC")&&(this.mode.pad=function(t){return r(this.blockSize,t,!1)},this.mode.unpad=function(t){return r(this.blockSize,t,!0)});var e={};return e.decrypt=this._decrypt,e.overflow=this._input.length()%this.blockSize,!(!this._decrypt&&this.mode.pad&&!this.mode.pad(this._input,e)||(this._finish=!0,this.update(),this._decrypt&&this.mode.unpad&&!this.mode.unpad(this.output,e))||this.mode.afterFinish&&!this.mode.afterFinish(this.output,e))}});var V8=Y((P4e,DR)=>{var dr=Ge();Kt();dr.cipher=dr.cipher||{};var Me=DR.exports=dr.cipher.modes=dr.cipher.modes||{};Me.ecb=function(r){r=r||{},this.name="ECB",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=new Array(this._ints),this._outBlock=new Array(this._ints)};Me.ecb.prototype.start=function(r){};Me.ecb.prototype.encrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=r.getInt32();this.cipher.encrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._outBlock[n])};Me.ecb.prototype.decrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=r.getInt32();this.cipher.decrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._outBlock[n])};Me.ecb.prototype.pad=function(r,e){var t=r.length()===this.blockSize?this.blockSize:this.blockSize-r.length();return r.fillWithByte(t,t),!0};Me.ecb.prototype.unpad=function(r,e){if(e.overflow>0)return!1;var t=r.length(),n=r.at(t-1);return n>this.blockSize<<2?!1:(r.truncate(n),!0)};Me.cbc=function(r){r=r||{},this.name="CBC",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=new Array(this._ints),this._outBlock=new Array(this._ints)};Me.cbc.prototype.start=function(r){if(r.iv===null){if(!this._prev)throw new Error("Invalid IV parameter.");this._iv=this._prev.slice(0)}else if("iv"in r)this._iv=g1(r.iv,this.blockSize),this._prev=this._iv.slice(0);else throw new Error("Invalid IV parameter.")};Me.cbc.prototype.encrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=this._prev[n]^r.getInt32();this.cipher.encrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._outBlock[n]);this._prev=this._outBlock};Me.cbc.prototype.decrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=r.getInt32();this.cipher.decrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._prev[n]^this._outBlock[n]);this._prev=this._inBlock.slice(0)};Me.cbc.prototype.pad=function(r,e){var t=r.length()===this.blockSize?this.blockSize:this.blockSize-r.length();return r.fillWithByte(t,t),!0};Me.cbc.prototype.unpad=function(r,e){if(e.overflow>0)return!1;var t=r.length(),n=r.at(t-1);return n>this.blockSize<<2?!1:(r.truncate(n),!0)};Me.cfb=function(r){r=r||{},this.name="CFB",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=null,this._outBlock=new Array(this._ints),this._partialBlock=new Array(this._ints),this._partialOutput=dr.util.createBuffer(),this._partialBytes=0};Me.cfb.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");this._iv=g1(r.iv,this.blockSize),this._inBlock=this._iv.slice(0),this._partialBytes=0};Me.cfb.prototype.encrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var s=0;s<this._ints;++s)this._inBlock[s]=r.getInt32()^this._outBlock[s],e.putInt32(this._inBlock[s]);return}var o=(this.blockSize-n)%this.blockSize;o>0&&(o=this.blockSize-o),this._partialOutput.clear();for(var s=0;s<this._ints;++s)this._partialBlock[s]=r.getInt32()^this._outBlock[s],this._partialOutput.putInt32(this._partialBlock[s]);if(o>0)r.read-=this.blockSize;else for(var s=0;s<this._ints;++s)this._inBlock[s]=this._partialBlock[s];if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),o>0&&!t)return e.putBytes(this._partialOutput.getBytes(o-this._partialBytes)),this._partialBytes=o,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0};Me.cfb.prototype.decrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var s=0;s<this._ints;++s)this._inBlock[s]=r.getInt32(),e.putInt32(this._inBlock[s]^this._outBlock[s]);return}var o=(this.blockSize-n)%this.blockSize;o>0&&(o=this.blockSize-o),this._partialOutput.clear();for(var s=0;s<this._ints;++s)this._partialBlock[s]=r.getInt32(),this._partialOutput.putInt32(this._partialBlock[s]^this._outBlock[s]);if(o>0)r.read-=this.blockSize;else for(var s=0;s<this._ints;++s)this._inBlock[s]=this._partialBlock[s];if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),o>0&&!t)return e.putBytes(this._partialOutput.getBytes(o-this._partialBytes)),this._partialBytes=o,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0};Me.ofb=function(r){r=r||{},this.name="OFB",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=null,this._outBlock=new Array(this._ints),this._partialOutput=dr.util.createBuffer(),this._partialBytes=0};Me.ofb.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");this._iv=g1(r.iv,this.blockSize),this._inBlock=this._iv.slice(0),this._partialBytes=0};Me.ofb.prototype.encrypt=function(r,e,t){var n=r.length();if(r.length()===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var s=0;s<this._ints;++s)e.putInt32(r.getInt32()^this._outBlock[s]),this._inBlock[s]=this._outBlock[s];return}var o=(this.blockSize-n)%this.blockSize;o>0&&(o=this.blockSize-o),this._partialOutput.clear();for(var s=0;s<this._ints;++s)this._partialOutput.putInt32(r.getInt32()^this._outBlock[s]);if(o>0)r.read-=this.blockSize;else for(var s=0;s<this._ints;++s)this._inBlock[s]=this._outBlock[s];if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),o>0&&!t)return e.putBytes(this._partialOutput.getBytes(o-this._partialBytes)),this._partialBytes=o,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0};Me.ofb.prototype.decrypt=Me.ofb.prototype.encrypt;Me.ctr=function(r){r=r||{},this.name="CTR",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=null,this._outBlock=new Array(this._ints),this._partialOutput=dr.util.createBuffer(),this._partialBytes=0};Me.ctr.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");this._iv=g1(r.iv,this.blockSize),this._inBlock=this._iv.slice(0),this._partialBytes=0};Me.ctr.prototype.encrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize)for(var s=0;s<this._ints;++s)e.putInt32(r.getInt32()^this._outBlock[s]);else{var o=(this.blockSize-n)%this.blockSize;o>0&&(o=this.blockSize-o),this._partialOutput.clear();for(var s=0;s<this._ints;++s)this._partialOutput.putInt32(r.getInt32()^this._outBlock[s]);if(o>0&&(r.read-=this.blockSize),this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),o>0&&!t)return e.putBytes(this._partialOutput.getBytes(o-this._partialBytes)),this._partialBytes=o,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0}b1(this._inBlock)};Me.ctr.prototype.decrypt=Me.ctr.prototype.encrypt;Me.gcm=function(r){r=r||{},this.name="GCM",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=new Array(this._ints),this._outBlock=new Array(this._ints),this._partialOutput=dr.util.createBuffer(),this._partialBytes=0,this._R=3774873600};Me.gcm.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");var e=dr.util.createBuffer(r.iv);this._cipherLength=0;var t;if("additionalData"in r?t=dr.util.createBuffer(r.additionalData):t=dr.util.createBuffer(),"tagLength"in r?this._tagLength=r.tagLength:this._tagLength=128,this._tag=null,r.decrypt&&(this._tag=dr.util.createBuffer(r.tag).getBytes(),this._tag.length!==this._tagLength/8))throw new Error("Authentication tag does not match tag length.");this._hashBlock=new Array(this._ints),this.tag=null,this._hashSubkey=new Array(this._ints),this.cipher.encrypt([0,0,0,0],this._hashSubkey),this.componentBits=4,this._m=this.generateHashTable(this._hashSubkey,this.componentBits);var n=e.length();if(n===12)this._j0=[e.getInt32(),e.getInt32(),e.getInt32(),1];else{for(this._j0=[0,0,0,0];e.length()>0;)this._j0=this.ghash(this._hashSubkey,this._j0,[e.getInt32(),e.getInt32(),e.getInt32(),e.getInt32()]);this._j0=this.ghash(this._hashSubkey,this._j0,[0,0].concat(F8(n*8)))}this._inBlock=this._j0.slice(0),b1(this._inBlock),this._partialBytes=0,t=dr.util.createBuffer(t),this._aDataLength=F8(t.length()*8);var s=t.length()%this.blockSize;for(s&&t.fillWithByte(0,this.blockSize-s),this._s=[0,0,0,0];t.length()>0;)this._s=this.ghash(this._hashSubkey,this._s,[t.getInt32(),t.getInt32(),t.getInt32(),t.getInt32()])};Me.gcm.prototype.encrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var s=0;s<this._ints;++s)e.putInt32(this._outBlock[s]^=r.getInt32());this._cipherLength+=this.blockSize}else{var o=(this.blockSize-n)%this.blockSize;o>0&&(o=this.blockSize-o),this._partialOutput.clear();for(var s=0;s<this._ints;++s)this._partialOutput.putInt32(r.getInt32()^this._outBlock[s]);if(o<=0||t){if(t){var i=n%this.blockSize;this._cipherLength+=i,this._partialOutput.truncate(this.blockSize-i)}else this._cipherLength+=this.blockSize;for(var s=0;s<this._ints;++s)this._outBlock[s]=this._partialOutput.getInt32();this._partialOutput.read-=this.blockSize}if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),o>0&&!t)return r.read-=this.blockSize,e.putBytes(this._partialOutput.getBytes(o-this._partialBytes)),this._partialBytes=o,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0}this._s=this.ghash(this._hashSubkey,this._s,this._outBlock),b1(this._inBlock)};Me.gcm.prototype.decrypt=function(r,e,t){var n=r.length();if(n<this.blockSize&&!(t&&n>0))return!0;this.cipher.encrypt(this._inBlock,this._outBlock),b1(this._inBlock),this._hashBlock[0]=r.getInt32(),this._hashBlock[1]=r.getInt32(),this._hashBlock[2]=r.getInt32(),this._hashBlock[3]=r.getInt32(),this._s=this.ghash(this._hashSubkey,this._s,this._hashBlock);for(var s=0;s<this._ints;++s)e.putInt32(this._outBlock[s]^this._hashBlock[s]);n<this.blockSize?this._cipherLength+=n%this.blockSize:this._cipherLength+=this.blockSize};Me.gcm.prototype.afterFinish=function(r,e){var t=!0;e.decrypt&&e.overflow&&r.truncate(this.blockSize-e.overflow),this.tag=dr.util.createBuffer();var n=this._aDataLength.concat(F8(this._cipherLength*8));this._s=this.ghash(this._hashSubkey,this._s,n);var s=[];this.cipher.encrypt(this._j0,s);for(var o=0;o<this._ints;++o)this.tag.putInt32(this._s[o]^s[o]);return this.tag.truncate(this.tag.length()%(this._tagLength/8)),e.decrypt&&this.tag.bytes()!==this._tag&&(t=!1),t};Me.gcm.prototype.multiply=function(r,e){for(var t=[0,0,0,0],n=e.slice(0),s=0;s<128;++s){var o=r[s/32|0]&1<<31-s%32;o&&(t[0]^=n[0],t[1]^=n[1],t[2]^=n[2],t[3]^=n[3]),this.pow(n,n)}return t};Me.gcm.prototype.pow=function(r,e){for(var t=r[3]&1,n=3;n>0;--n)e[n]=r[n]>>>1|(r[n-1]&1)<<31;e[0]=r[0]>>>1,t&&(e[0]^=this._R)};Me.gcm.prototype.tableMultiply=function(r){for(var e=[0,0,0,0],t=0;t<32;++t){var n=t/8|0,s=r[n]>>>(7-t%8)*4&15,o=this._m[t][s];e[0]^=o[0],e[1]^=o[1],e[2]^=o[2],e[3]^=o[3]}return e};Me.gcm.prototype.ghash=function(r,e,t){return e[0]^=t[0],e[1]^=t[1],e[2]^=t[2],e[3]^=t[3],this.tableMultiply(e)};Me.gcm.prototype.generateHashTable=function(r,e){for(var t=8/e,n=4*t,s=16*t,o=new Array(s),i=0;i<s;++i){var a=[0,0,0,0],c=i/n|0,l=(n-1-i%n)*e;a[c]=1<<e-1<<l,o[i]=this.generateSubHashTable(this.multiply(a,r),e)}return o};Me.gcm.prototype.generateSubHashTable=function(r,e){var t=1<<e,n=t>>>1,s=new Array(t);s[n]=r.slice(0);for(var o=n>>>1;o>0;)this.pow(s[2*o],s[o]=[]),o>>=1;for(o=2;o<n;){for(var i=1;i<o;++i){var a=s[o],c=s[i];s[o+i]=[a[0]^c[0],a[1]^c[1],a[2]^c[2],a[3]^c[3]]}o*=2}for(s[0]=[0,0,0,0],o=n+1;o<t;++o){var l=s[o^n];s[o]=[r[0]^l[0],r[1]^l[1],r[2]^l[2],r[3]^l[3]]}return s};function g1(r,e){if(typeof r=="string"&&(r=dr.util.createBuffer(r)),dr.util.isArray(r)&&r.length>4){var t=r;r=dr.util.createBuffer();for(var n=0;n<t.length;++n)r.putByte(t[n])}if(r.length()<e)throw new Error("Invalid IV length; got "+r.length()+" bytes and expected "+e+" bytes.");if(!dr.util.isArray(r)){for(var s=[],o=e/4,n=0;n<o;++n)s.push(r.getInt32());r=s}return r}function b1(r){r[r.length-1]=r[r.length-1]+1&4294967295}function F8(r){return[r/4294967296|0,r&4294967295]}});var E1=Y((C4e,NR)=>{var mt=Ge();U8();V8();Kt();NR.exports=mt.aes=mt.aes||{};mt.aes.startEncrypting=function(r,e,t,n){var s=w1({key:r,output:t,decrypt:!1,mode:n});return s.start(e),s};mt.aes.createEncryptionCipher=function(r,e){return w1({key:r,output:null,decrypt:!1,mode:e})};mt.aes.startDecrypting=function(r,e,t,n){var s=w1({key:r,output:t,decrypt:!0,mode:n});return s.start(e),s};mt.aes.createDecryptionCipher=function(r,e){return w1({key:r,output:null,decrypt:!0,mode:e})};mt.aes.Algorithm=function(r,e){z8||CR();var t=this;t.name=r,t.mode=new e({blockSize:16,cipher:{encrypt:function(n,s){return H8(t._w,n,s,!1)},decrypt:function(n,s){return H8(t._w,n,s,!0)}}}),t._init=!1};mt.aes.Algorithm.prototype.initialize=function(r){if(!this._init){var e=r.key,t;if(typeof e=="string"&&(e.length===16||e.length===24||e.length===32))e=mt.util.createBuffer(e);else if(mt.util.isArray(e)&&(e.length===16||e.length===24||e.length===32)){t=e,e=mt.util.createBuffer();for(var n=0;n<t.length;++n)e.putByte(t[n])}if(!mt.util.isArray(e)){t=e,e=[];var s=t.length();if(s===16||s===24||s===32){s=s>>>2;for(var n=0;n<s;++n)e.push(t.getInt32())}}if(!mt.util.isArray(e)||!(e.length===4||e.length===6||e.length===8))throw new Error("Invalid key parameter.");var o=this.mode.name,i=["CFB","OFB","CTR","GCM"].indexOf(o)!==-1;this._w=BR(e,r.decrypt&&!i),this._init=!0}};mt.aes._expandKey=function(r,e){return z8||CR(),BR(r,e)};mt.aes._updateBlock=H8;ou("AES-ECB",mt.cipher.modes.ecb);ou("AES-CBC",mt.cipher.modes.cbc);ou("AES-CFB",mt.cipher.modes.cfb);ou("AES-OFB",mt.cipher.modes.ofb);ou("AES-CTR",mt.cipher.modes.ctr);ou("AES-GCM",mt.cipher.modes.gcm);function ou(r,e){var t=function(){return new mt.aes.Algorithm(r,e)};mt.cipher.registerAlgorithm(r,t)}var z8=!1,su=4,jr,q8,PR,vc,xs;function CR(){z8=!0,PR=[0,1,2,4,8,16,32,64,128,27,54];for(var r=new Array(256),e=0;e<128;++e)r[e]=e<<1,r[e+128]=e+128<<1^283;jr=new Array(256),q8=new Array(256),vc=new Array(4),xs=new Array(4);for(var e=0;e<4;++e)vc[e]=new Array(256),xs[e]=new Array(256);for(var t=0,n=0,s,o,i,a,c,l,u,e=0;e<256;++e){a=n^n<<1^n<<2^n<<3^n<<4,a=a>>8^a&255^99,jr[t]=a,q8[a]=t,c=r[a],s=r[t],o=r[s],i=r[o],l=c<<24^a<<16^a<<8^(a^c),u=(s^o^i)<<24^(t^i)<<16^(t^o^i)<<8^(t^s^i);for(var f=0;f<4;++f)vc[f][t]=l,xs[f][a]=u,l=l<<24|l>>>8,u=u<<24|u>>>8;t===0?t=n=1:(t=s^r[r[r[s^i]]],n^=r[r[n]])}}function BR(r,e){for(var t=r.slice(0),n,s=1,o=t.length,i=o+6+1,a=su*i,c=o;c<a;++c)n=t[c-1],c%o===0?(n=jr[n>>>16&255]<<24^jr[n>>>8&255]<<16^jr[n&255]<<8^jr[n>>>24]^PR[s]<<24,s++):o>6&&c%o===4&&(n=jr[n>>>24]<<24^jr[n>>>16&255]<<16^jr[n>>>8&255]<<8^jr[n&255]),t[c]=t[c-o]^n;if(e){var l,u=xs[0],f=xs[1],h=xs[2],d=xs[3],p=t.slice(0);a=t.length;for(var c=0,m=a-su;c<a;c+=su,m-=su)if(c===0||c===a-su)p[c]=t[m],p[c+1]=t[m+3],p[c+2]=t[m+2],p[c+3]=t[m+1];else for(var y=0;y<su;++y)l=t[m+y],p[c+(3&-y)]=u[jr[l>>>24]]^f[jr[l>>>16&255]]^h[jr[l>>>8&255]]^d[jr[l&255]];t=p}return t}function H8(r,e,t,n){var s=r.length/4-1,o,i,a,c,l;n?(o=xs[0],i=xs[1],a=xs[2],c=xs[3],l=q8):(o=vc[0],i=vc[1],a=vc[2],c=vc[3],l=jr);var u,f,h,d,p,m,y;u=e[0]^r[0],f=e[n?3:1]^r[1],h=e[2]^r[2],d=e[n?1:3]^r[3];for(var b=3,w=1;w<s;++w)p=o[u>>>24]^i[f>>>16&255]^a[h>>>8&255]^c[d&255]^r[++b],m=o[f>>>24]^i[h>>>16&255]^a[d>>>8&255]^c[u&255]^r[++b],y=o[h>>>24]^i[d>>>16&255]^a[u>>>8&255]^c[f&255]^r[++b],d=o[d>>>24]^i[u>>>16&255]^a[f>>>8&255]^c[h&255]^r[++b],u=p,f=m,h=y;t[0]=l[u>>>24]<<24^l[f>>>16&255]<<16^l[h>>>8&255]<<8^l[d&255]^r[++b],t[n?3:1]=l[f>>>24]<<24^l[h>>>16&255]<<16^l[d>>>8&255]<<8^l[u&255]^r[++b],t[2]=l[h>>>24]<<24^l[d>>>16&255]<<16^l[u>>>8&255]<<8^l[f&255]^r[++b],t[n?1:3]=l[d>>>24]<<24^l[u>>>16&255]<<16^l[f>>>8&255]<<8^l[h&255]^r[++b]}function w1(r){r=r||{};var e=(r.mode||"CBC").toUpperCase(),t="AES-"+e,n;r.decrypt?n=mt.cipher.createDecipher(t,r.key):n=mt.cipher.createCipher(t,r.key);var s=n.start;return n.start=function(o,i){var a=null;i instanceof mt.util.ByteBuffer&&(a=i,i={}),i=i||{},i.output=a,i.iv=o,s.call(n,i)},n}});var v1=Y(($4e,OR)=>{var ap=Ge();ap.pki=ap.pki||{};var $8=OR.exports=ap.pki.oids=ap.oids=ap.oids||{};function z(r,e){$8[r]=e,$8[e]=r}function it(r,e){$8[r]=e}z("1.2.840.113549.1.1.1","rsaEncryption");z("1.2.840.113549.1.1.4","md5WithRSAEncryption");z("1.2.840.113549.1.1.5","sha1WithRSAEncryption");z("1.2.840.113549.1.1.7","RSAES-OAEP");z("1.2.840.113549.1.1.8","mgf1");z("1.2.840.113549.1.1.9","pSpecified");z("1.2.840.113549.1.1.10","RSASSA-PSS");z("1.2.840.113549.1.1.11","sha256WithRSAEncryption");z("1.2.840.113549.1.1.12","sha384WithRSAEncryption");z("1.2.840.113549.1.1.13","sha512WithRSAEncryption");z("1.3.101.112","EdDSA25519");z("1.2.840.10040.4.3","dsa-with-sha1");z("1.3.14.3.2.7","desCBC");z("1.3.14.3.2.26","sha1");z("1.3.14.3.2.29","sha1WithRSASignature");z("2.16.840.1.101.3.4.2.1","sha256");z("2.16.840.1.101.3.4.2.2","sha384");z("2.16.840.1.101.3.4.2.3","sha512");z("2.16.840.1.101.3.4.2.4","sha224");z("2.16.840.1.101.3.4.2.5","sha512-224");z("2.16.840.1.101.3.4.2.6","sha512-256");z("1.2.840.113549.2.2","md2");z("1.2.840.113549.2.5","md5");z("1.2.840.113549.1.7.1","data");z("1.2.840.113549.1.7.2","signedData");z("1.2.840.113549.1.7.3","envelopedData");z("1.2.840.113549.1.7.4","signedAndEnvelopedData");z("1.2.840.113549.1.7.5","digestedData");z("1.2.840.113549.1.7.6","encryptedData");z("1.2.840.113549.1.9.1","emailAddress");z("1.2.840.113549.1.9.2","unstructuredName");z("1.2.840.113549.1.9.3","contentType");z("1.2.840.113549.1.9.4","messageDigest");z("1.2.840.113549.1.9.5","signingTime");z("1.2.840.113549.1.9.6","counterSignature");z("1.2.840.113549.1.9.7","challengePassword");z("1.2.840.113549.1.9.8","unstructuredAddress");z("1.2.840.113549.1.9.14","extensionRequest");z("1.2.840.113549.1.9.20","friendlyName");z("1.2.840.113549.1.9.21","localKeyId");z("1.2.840.113549.1.9.22.1","x509Certificate");z("1.2.840.113549.1.12.10.1.1","keyBag");z("1.2.840.113549.1.12.10.1.2","pkcs8ShroudedKeyBag");z("1.2.840.113549.1.12.10.1.3","certBag");z("1.2.840.113549.1.12.10.1.4","crlBag");z("1.2.840.113549.1.12.10.1.5","secretBag");z("1.2.840.113549.1.12.10.1.6","safeContentsBag");z("1.2.840.113549.1.5.13","pkcs5PBES2");z("1.2.840.113549.1.5.12","pkcs5PBKDF2");z("1.2.840.113549.1.12.1.1","pbeWithSHAAnd128BitRC4");z("1.2.840.113549.1.12.1.2","pbeWithSHAAnd40BitRC4");z("1.2.840.113549.1.12.1.3","pbeWithSHAAnd3-KeyTripleDES-CBC");z("1.2.840.113549.1.12.1.4","pbeWithSHAAnd2-KeyTripleDES-CBC");z("1.2.840.113549.1.12.1.5","pbeWithSHAAnd128BitRC2-CBC");z("1.2.840.113549.1.12.1.6","pbewithSHAAnd40BitRC2-CBC");z("1.2.840.113549.2.7","hmacWithSHA1");z("1.2.840.113549.2.8","hmacWithSHA224");z("1.2.840.113549.2.9","hmacWithSHA256");z("1.2.840.113549.2.10","hmacWithSHA384");z("1.2.840.113549.2.11","hmacWithSHA512");z("1.2.840.113549.3.7","des-EDE3-CBC");z("2.16.840.1.101.3.4.1.2","aes128-CBC");z("2.16.840.1.101.3.4.1.22","aes192-CBC");z("2.16.840.1.101.3.4.1.42","aes256-CBC");z("2.5.4.3","commonName");z("2.5.4.4","surname");z("2.5.4.5","serialNumber");z("2.5.4.6","countryName");z("2.5.4.7","localityName");z("2.5.4.8","stateOrProvinceName");z("2.5.4.9","streetAddress");z("2.5.4.10","organizationName");z("2.5.4.11","organizationalUnitName");z("2.5.4.12","title");z("2.5.4.13","description");z("2.5.4.15","businessCategory");z("2.5.4.17","postalCode");z("2.5.4.42","givenName");z("1.3.6.1.4.1.311.60.2.1.2","jurisdictionOfIncorporationStateOrProvinceName");z("1.3.6.1.4.1.311.60.2.1.3","jurisdictionOfIncorporationCountryName");z("2.16.840.1.113730.1.1","nsCertType");z("2.16.840.1.113730.1.13","nsComment");it("2.5.29.1","authorityKeyIdentifier");it("2.5.29.2","keyAttributes");it("2.5.29.3","certificatePolicies");it("2.5.29.4","keyUsageRestriction");it("2.5.29.5","policyMapping");it("2.5.29.6","subtreesConstraint");it("2.5.29.7","subjectAltName");it("2.5.29.8","issuerAltName");it("2.5.29.9","subjectDirectoryAttributes");it("2.5.29.10","basicConstraints");it("2.5.29.11","nameConstraints");it("2.5.29.12","policyConstraints");it("2.5.29.13","basicConstraints");z("2.5.29.14","subjectKeyIdentifier");z("2.5.29.15","keyUsage");it("2.5.29.16","privateKeyUsagePeriod");z("2.5.29.17","subjectAltName");z("2.5.29.18","issuerAltName");z("2.5.29.19","basicConstraints");it("2.5.29.20","cRLNumber");it("2.5.29.21","cRLReason");it("2.5.29.22","expirationDate");it("2.5.29.23","instructionCode");it("2.5.29.24","invalidityDate");it("2.5.29.25","cRLDistributionPoints");it("2.5.29.26","issuingDistributionPoint");it("2.5.29.27","deltaCRLIndicator");it("2.5.29.28","issuingDistributionPoint");it("2.5.29.29","certificateIssuer");it("2.5.29.30","nameConstraints");z("2.5.29.31","cRLDistributionPoints");z("2.5.29.32","certificatePolicies");it("2.5.29.33","policyMappings");it("2.5.29.34","policyConstraints");z("2.5.29.35","authorityKeyIdentifier");it("2.5.29.36","policyConstraints");z("2.5.29.37","extKeyUsage");it("2.5.29.46","freshestCRL");it("2.5.29.54","inhibitAnyPolicy");z("1.3.6.1.4.1.11129.2.4.2","timestampList");z("1.3.6.1.5.5.7.1.1","authorityInfoAccess");z("1.3.6.1.5.5.7.3.1","serverAuth");z("1.3.6.1.5.5.7.3.2","clientAuth");z("1.3.6.1.5.5.7.3.3","codeSigning");z("1.3.6.1.5.5.7.3.4","emailProtection");z("1.3.6.1.5.5.7.3.8","timeStamping")});var xc=Y((G4e,MR)=>{var gt=Ge();Kt();v1();var ne=MR.exports=gt.asn1=gt.asn1||{};ne.Class={UNIVERSAL:0,APPLICATION:64,CONTEXT_SPECIFIC:128,PRIVATE:192};ne.Type={NONE:0,BOOLEAN:1,INTEGER:2,BITSTRING:3,OCTETSTRING:4,NULL:5,OID:6,ODESC:7,EXTERNAL:8,REAL:9,ENUMERATED:10,EMBEDDED:11,UTF8:12,ROID:13,SEQUENCE:16,SET:17,PRINTABLESTRING:19,IA5STRING:22,UTCTIME:23,GENERALIZEDTIME:24,BMPSTRING:30};ne.create=function(r,e,t,n,s){if(gt.util.isArray(n)){for(var o=[],i=0;i<n.length;++i)n[i]!==void 0&&o.push(n[i]);n=o}var a={tagClass:r,type:e,constructed:t,composed:t||gt.util.isArray(n),value:n};return s&&"bitStringContents"in s&&(a.bitStringContents=s.bitStringContents,a.original=ne.copy(a)),a};ne.copy=function(r,e){var t;if(gt.util.isArray(r)){t=[];for(var n=0;n<r.length;++n)t.push(ne.copy(r[n],e));return t}return typeof r=="string"?r:(t={tagClass:r.tagClass,type:r.type,constructed:r.constructed,composed:r.composed,value:ne.copy(r.value,e)},e&&!e.excludeBitStringContents&&(t.bitStringContents=r.bitStringContents),t)};ne.equals=function(r,e,t){if(gt.util.isArray(r)){if(!gt.util.isArray(e)||r.length!==e.length)return!1;for(var n=0;n<r.length;++n)if(!ne.equals(r[n],e[n]))return!1;return!0}if(typeof r!=typeof e)return!1;if(typeof r=="string")return r===e;var s=r.tagClass===e.tagClass&&r.type===e.type&&r.constructed===e.constructed&&r.composed===e.composed&&ne.equals(r.value,e.value);return t&&t.includeBitStringContents&&(s=s&&r.bitStringContents===e.bitStringContents),s};ne.getBerValueLength=function(r){var e=r.getByte();if(e!==128){var t,n=e&128;return n?t=r.getInt((e&127)<<3):t=e,t}};function cp(r,e,t){if(t>e){var n=new Error("Too few bytes to parse DER.");throw n.available=r.length(),n.remaining=e,n.requested=t,n}}var $G=function(r,e){var t=r.getByte();if(e--,t!==128){var n,s=t&128;if(!s)n=t;else{var o=t&127;cp(r,e,o),n=r.getInt(o<<3)}if(n<0)throw new Error("Negative length: "+n);return n}};ne.fromDer=function(r,e){e===void 0&&(e={strict:!0,parseAllBytes:!0,decodeBitStrings:!0}),typeof e=="boolean"&&(e={strict:e,parseAllBytes:!0,decodeBitStrings:!0}),"strict"in e||(e.strict=!0),"parseAllBytes"in e||(e.parseAllBytes=!0),"decodeBitStrings"in e||(e.decodeBitStrings=!0),typeof r=="string"&&(r=gt.util.createBuffer(r));var t=r.length(),n=x1(r,r.length(),0,e);if(e.parseAllBytes&&r.length()!==0){var s=new Error("Unparsed DER bytes remain after ASN.1 parsing.");throw s.byteCount=t,s.remaining=r.length(),s}return n};function x1(r,e,t,n){var s;cp(r,e,2);var o=r.getByte();e--;var i=o&192,a=o&31;s=r.length();var c=$G(r,e);if(e-=s-r.length(),c!==void 0&&c>e){if(n.strict){var l=new Error("Too few bytes to read ASN.1 value.");throw l.available=r.length(),l.remaining=e,l.requested=c,l}c=e}var u,f,h=(o&32)===32;if(h)if(u=[],c===void 0)for(;;){if(cp(r,e,2),r.bytes(2)==="\0\0"){r.getBytes(2),e-=2;break}s=r.length(),u.push(x1(r,e,t+1,n)),e-=s-r.length()}else for(;c>0;)s=r.length(),u.push(x1(r,c,t+1,n)),e-=s-r.length(),c-=s-r.length();if(u===void 0&&i===ne.Class.UNIVERSAL&&a===ne.Type.BITSTRING&&(f=r.bytes(c)),u===void 0&&n.decodeBitStrings&&i===ne.Class.UNIVERSAL&&a===ne.Type.BITSTRING&&c>1){var d=r.read,p=e,m=0;if(a===ne.Type.BITSTRING&&(cp(r,e,1),m=r.getByte(),e--),m===0)try{s=r.length();var y={strict:!0,decodeBitStrings:!0},b=x1(r,e,t+1,y),w=s-r.length();e-=w,a==ne.Type.BITSTRING&&w++;var E=b.tagClass;w===c&&(E===ne.Class.UNIVERSAL||E===ne.Class.CONTEXT_SPECIFIC)&&(u=[b])}catch{}u===void 0&&(r.read=d,e=p)}if(u===void 0){if(c===void 0){if(n.strict)throw new Error("Non-constructed ASN.1 object of indefinite length.");c=e}if(a===ne.Type.BMPSTRING)for(u="";c>0;c-=2)cp(r,e,2),u+=String.fromCharCode(r.getInt16()),e-=2;else u=r.getBytes(c),e-=c}var x=f===void 0?null:{bitStringContents:f};return ne.create(i,a,h,u,x)}ne.toDer=function(r){var e=gt.util.createBuffer(),t=r.tagClass|r.type,n=gt.util.createBuffer(),s=!1;if("bitStringContents"in r&&(s=!0,r.original&&(s=ne.equals(r,r.original))),s)n.putBytes(r.bitStringContents);else if(r.composed){r.constructed?t|=32:n.putByte(0);for(var o=0;o<r.value.length;++o)r.value[o]!==void 0&&n.putBuffer(ne.toDer(r.value[o]))}else if(r.type===ne.Type.BMPSTRING)for(var o=0;o<r.value.length;++o)n.putInt16(r.value.charCodeAt(o));else r.type===ne.Type.INTEGER&&r.value.length>1&&(r.value.charCodeAt(0)===0&&!(r.value.charCodeAt(1)&128)||r.value.charCodeAt(0)===255&&(r.value.charCodeAt(1)&128)===128)?n.putBytes(r.value.substr(1)):n.putBytes(r.value);if(e.putByte(t),n.length()<=127)e.putByte(n.length()&127);else{var i=n.length(),a="";do a+=String.fromCharCode(i&255),i=i>>>8;while(i>0);e.putByte(a.length|128);for(var o=a.length-1;o>=0;--o)e.putByte(a.charCodeAt(o))}return e.putBuffer(n),e};ne.oidToDer=function(r){var e=r.split("."),t=gt.util.createBuffer();t.putByte(40*parseInt(e[0],10)+parseInt(e[1],10));for(var n,s,o,i,a=2;a<e.length;++a){n=!0,s=[],o=parseInt(e[a],10);do i=o&127,o=o>>>7,n||(i|=128),s.push(i),n=!1;while(o>0);for(var c=s.length-1;c>=0;--c)t.putByte(s[c])}return t};ne.derToOid=function(r){var e;typeof r=="string"&&(r=gt.util.createBuffer(r));var t=r.getByte();e=Math.floor(t/40)+"."+t%40;for(var n=0;r.length()>0;)t=r.getByte(),n=n<<7,t&128?n+=t&127:(e+="."+(n+t),n=0);return e};ne.utcTimeToDate=function(r){var e=new Date,t=parseInt(r.substr(0,2),10);t=t>=50?1900+t:2e3+t;var n=parseInt(r.substr(2,2),10)-1,s=parseInt(r.substr(4,2),10),o=parseInt(r.substr(6,2),10),i=parseInt(r.substr(8,2),10),a=0;if(r.length>11){var c=r.charAt(10),l=10;c!=="+"&&c!=="-"&&(a=parseInt(r.substr(10,2),10),l+=2)}if(e.setUTCFullYear(t,n,s),e.setUTCHours(o,i,a,0),l&&(c=r.charAt(l),c==="+"||c==="-")){var u=parseInt(r.substr(l+1,2),10),f=parseInt(r.substr(l+4,2),10),h=u*60+f;h*=6e4,c==="+"?e.setTime(+e-h):e.setTime(+e+h)}return e};ne.generalizedTimeToDate=function(r){var e=new Date,t=parseInt(r.substr(0,4),10),n=parseInt(r.substr(4,2),10)-1,s=parseInt(r.substr(6,2),10),o=parseInt(r.substr(8,2),10),i=parseInt(r.substr(10,2),10),a=parseInt(r.substr(12,2),10),c=0,l=0,u=!1;r.charAt(r.length-1)==="Z"&&(u=!0);var f=r.length-5,h=r.charAt(f);if(h==="+"||h==="-"){var d=parseInt(r.substr(f+1,2),10),p=parseInt(r.substr(f+4,2),10);l=d*60+p,l*=6e4,h==="+"&&(l*=-1),u=!0}return r.charAt(14)==="."&&(c=parseFloat(r.substr(14),10)*1e3),u?(e.setUTCFullYear(t,n,s),e.setUTCHours(o,i,a,c),e.setTime(+e+l)):(e.setFullYear(t,n,s),e.setHours(o,i,a,c)),e};ne.dateToUtcTime=function(r){if(typeof r=="string")return r;var e="",t=[];t.push((""+r.getUTCFullYear()).substr(2)),t.push(""+(r.getUTCMonth()+1)),t.push(""+r.getUTCDate()),t.push(""+r.getUTCHours()),t.push(""+r.getUTCMinutes()),t.push(""+r.getUTCSeconds());for(var n=0;n<t.length;++n)t[n].length<2&&(e+="0"),e+=t[n];return e+="Z",e};ne.dateToGeneralizedTime=function(r){if(typeof r=="string")return r;var e="",t=[];t.push(""+r.getUTCFullYear()),t.push(""+(r.getUTCMonth()+1)),t.push(""+r.getUTCDate()),t.push(""+r.getUTCHours()),t.push(""+r.getUTCMinutes()),t.push(""+r.getUTCSeconds());for(var n=0;n<t.length;++n)t[n].length<2&&(e+="0"),e+=t[n];return e+="Z",e};ne.integerToDer=function(r){var e=gt.util.createBuffer();if(r>=-128&&r<128)return e.putSignedInt(r,8);if(r>=-32768&&r<32768)return e.putSignedInt(r,16);if(r>=-8388608&&r<8388608)return e.putSignedInt(r,24);if(r>=-2147483648&&r<2147483648)return e.putSignedInt(r,32);var t=new Error("Integer too large; max is 32-bits.");throw t.integer=r,t};ne.derToInteger=function(r){typeof r=="string"&&(r=gt.util.createBuffer(r));var e=r.length()*8;if(e>32)throw new Error("Integer too large; max is 32-bits.");return r.getSignedInt(e)};ne.validate=function(r,e,t,n){var s=!1;if((r.tagClass===e.tagClass||typeof e.tagClass>"u")&&(r.type===e.type||typeof e.type>"u"))if(r.constructed===e.constructed||typeof e.constructed>"u"){if(s=!0,e.value&&gt.util.isArray(e.value))for(var o=0,i=0;s&&i<e.value.length;++i)s=e.value[i].optional||!1,r.value[o]&&(s=ne.validate(r.value[o],e.value[i],t,n),s?++o:e.value[i].optional&&(s=!0)),!s&&n&&n.push("["+e.name+'] Tag class "'+e.tagClass+'", type "'+e.type+'" expected value length "'+e.value.length+'", got "'+r.value.length+'"');if(s&&t&&(e.capture&&(t[e.capture]=r.value),e.captureAsn1&&(t[e.captureAsn1]=r),e.captureBitStringContents&&"bitStringContents"in r&&(t[e.captureBitStringContents]=r.bitStringContents),e.captureBitStringValue&&"bitStringContents"in r)){var a;if(r.bitStringContents.length<2)t[e.captureBitStringValue]="";else{var c=r.bitStringContents.charCodeAt(0);if(c!==0)throw new Error("captureBitStringValue only supported for zero unused bits");t[e.captureBitStringValue]=r.bitStringContents.slice(1)}}}else n&&n.push("["+e.name+'] Expected constructed "'+e.constructed+'", got "'+r.constructed+'"');else n&&(r.tagClass!==e.tagClass&&n.push("["+e.name+'] Expected tag class "'+e.tagClass+'", got "'+r.tagClass+'"'),r.type!==e.type&&n.push("["+e.name+'] Expected type "'+e.type+'", got "'+r.type+'"'));return s};var KR=/[^\\u0000-\\u00ff]/;ne.prettyPrint=function(r,e,t){var n="";e=e||0,t=t||2,e>0&&(n+=`
`);for(var s="",o=0;o<e*t;++o)s+=" ";switch(n+=s+"Tag: ",r.tagClass){case ne.Class.UNIVERSAL:n+="Universal:";break;case ne.Class.APPLICATION:n+="Application:";break;case ne.Class.CONTEXT_SPECIFIC:n+="Context-Specific:";break;case ne.Class.PRIVATE:n+="Private:";break}if(r.tagClass===ne.Class.UNIVERSAL)switch(n+=r.type,r.type){case ne.Type.NONE:n+=" (None)";break;case ne.Type.BOOLEAN:n+=" (Boolean)";break;case ne.Type.INTEGER:n+=" (Integer)";break;case ne.Type.BITSTRING:n+=" (Bit string)";break;case ne.Type.OCTETSTRING:n+=" (Octet string)";break;case ne.Type.NULL:n+=" (Null)";break;case ne.Type.OID:n+=" (Object Identifier)";break;case ne.Type.ODESC:n+=" (Object Descriptor)";break;case ne.Type.EXTERNAL:n+=" (External or Instance of)";break;case ne.Type.REAL:n+=" (Real)";break;case ne.Type.ENUMERATED:n+=" (Enumerated)";break;case ne.Type.EMBEDDED:n+=" (Embedded PDV)";break;case ne.Type.UTF8:n+=" (UTF8)";break;case ne.Type.ROID:n+=" (Relative Object Identifier)";break;case ne.Type.SEQUENCE:n+=" (Sequence)";break;case ne.Type.SET:n+=" (Set)";break;case ne.Type.PRINTABLESTRING:n+=" (Printable String)";break;case ne.Type.IA5String:n+=" (IA5String (ASCII))";break;case ne.Type.UTCTIME:n+=" (UTC time)";break;case ne.Type.GENERALIZEDTIME:n+=" (Generalized time)";break;case ne.Type.BMPSTRING:n+=" (BMP String)";break}else n+=r.type;if(n+=`
`,n+=s+"Constructed: "+r.constructed+`
`,r.composed){for(var i=0,a="",o=0;o<r.value.length;++o)r.value[o]!==void 0&&(i+=1,a+=ne.prettyPrint(r.value[o],e+1,t),o+1<r.value.length&&(a+=","));n+=s+"Sub values: "+i+a}else{if(n+=s+"Value: ",r.type===ne.Type.OID){var c=ne.derToOid(r.value);n+=c,gt.pki&&gt.pki.oids&&c in gt.pki.oids&&(n+=" ("+gt.pki.oids[c]+") ")}if(r.type===ne.Type.INTEGER)try{n+=ne.derToInteger(r.value)}catch{n+="0x"+gt.util.bytesToHex(r.value)}else if(r.type===ne.Type.BITSTRING){if(r.value.length>1?n+="0x"+gt.util.bytesToHex(r.value.slice(1)):n+="(none)",r.value.length>0){var l=r.value.charCodeAt(0);l==1?n+=" (1 unused bit shown)":l>1&&(n+=" ("+l+" unused bits shown)")}}else if(r.type===ne.Type.OCTETSTRING)KR.test(r.value)||(n+="("+r.value+") "),n+="0x"+gt.util.bytesToHex(r.value);else if(r.type===ne.Type.UTF8)try{n+=gt.util.decodeUtf8(r.value)}catch(u){if(u.message==="URI malformed")n+="0x"+gt.util.bytesToHex(r.value)+" (malformed UTF8)";else throw u}else r.type===ne.Type.PRINTABLESTRING||r.type===ne.Type.IA5String?n+=r.value:KR.test(r.value)?n+="0x"+gt.util.bytesToHex(r.value):r.value.length===0?n+="[null]":n+=r.value}return n}});var VR=Y((W4e,FR)=>{var xt=Ge();U8();V8();Kt();FR.exports=xt.des=xt.des||{};xt.des.startEncrypting=function(r,e,t,n){var s=S1({key:r,output:t,decrypt:!1,mode:n||(e===null?"ECB":"CBC")});return s.start(e),s};xt.des.createEncryptionCipher=function(r,e){return S1({key:r,output:null,decrypt:!1,mode:e})};xt.des.startDecrypting=function(r,e,t,n){var s=S1({key:r,output:t,decrypt:!0,mode:n||(e===null?"ECB":"CBC")});return s.start(e),s};xt.des.createDecryptionCipher=function(r,e){return S1({key:r,output:null,decrypt:!0,mode:e})};xt.des.Algorithm=function(r,e){var t=this;t.name=r,t.mode=new e({blockSize:8,cipher:{encrypt:function(n,s){return UR(t._keys,n,s,!1)},decrypt:function(n,s){return UR(t._keys,n,s,!0)}}}),t._init=!1};xt.des.Algorithm.prototype.initialize=function(r){if(!this._init){var e=xt.util.createBuffer(r.key);if(this.name.indexOf("3DES")===0&&e.length()!==24)throw new Error("Invalid Triple-DES key size: "+e.length()*8);this._keys=eW(e),this._init=!0}};js("DES-ECB",xt.cipher.modes.ecb);js("DES-CBC",xt.cipher.modes.cbc);js("DES-CFB",xt.cipher.modes.cfb);js("DES-OFB",xt.cipher.modes.ofb);js("DES-CTR",xt.cipher.modes.ctr);js("3DES-ECB",xt.cipher.modes.ecb);js("3DES-CBC",xt.cipher.modes.cbc);js("3DES-CFB",xt.cipher.modes.cfb);js("3DES-OFB",xt.cipher.modes.ofb);js("3DES-CTR",xt.cipher.modes.ctr);function js(r,e){var t=function(){return new xt.des.Algorithm(r,e)};xt.cipher.registerAlgorithm(r,t)}var GG=[16843776,0,65536,16843780,16842756,66564,4,65536,1024,16843776,16843780,1024,16778244,16842756,16777216,4,1028,16778240,16778240,66560,66560,16842752,16842752,16778244,65540,16777220,16777220,65540,0,1028,66564,16777216,65536,16843780,4,16842752,16843776,16777216,16777216,1024,16842756,65536,66560,16777220,1024,4,16778244,66564,16843780,65540,16842752,16778244,16777220,1028,66564,16843776,1028,16778240,16778240,0,65540,66560,0,16842756],WG=[-2146402272,-2147450880,32768,1081376,1048576,32,-2146435040,-2147450848,-2147483616,-2146402272,-2146402304,-2147483648,-2147450880,1048576,32,-2146435040,1081344,1048608,-2147450848,0,-2147483648,32768,1081376,-2146435072,1048608,-2147483616,0,1081344,32800,-2146402304,-2146435072,32800,0,1081376,-2146435040,1048576,-2147450848,-2146435072,-2146402304,32768,-2146435072,-2147450880,32,-2146402272,1081376,32,32768,-2147483648,32800,-2146402304,1048576,-2147483616,1048608,-2147450848,-2147483616,1048608,1081344,0,-2147450880,32800,-2147483648,-2146435040,-2146402272,1081344],YG=[520,134349312,0,134348808,134218240,0,131592,134218240,131080,134217736,134217736,131072,134349320,131080,134348800,520,134217728,8,134349312,512,131584,134348800,134348808,131592,134218248,131584,131072,134218248,8,134349320,512,134217728,134349312,134217728,131080,520,131072,134349312,134218240,0,512,131080,134349320,134218240,134217736,512,0,134348808,134218248,131072,134217728,134349320,8,131592,131584,134217736,134348800,134218248,520,134348800,131592,8,134348808,131584],jG=[8396801,8321,8321,128,8396928,8388737,8388609,8193,0,8396800,8396800,8396929,129,0,8388736,8388609,1,8192,8388608,8396801,128,8388608,8193,8320,8388737,1,8320,8388736,8192,8396928,8396929,129,8388736,8388609,8396800,8396929,129,0,0,8396800,8320,8388736,8388737,1,8396801,8321,8321,128,8396929,129,1,8192,8388609,8193,8396928,8388737,8193,8320,8388608,8396801,128,8388608,8192,8396928],QG=[256,34078976,34078720,1107296512,524288,256,1073741824,34078720,1074266368,524288,33554688,1074266368,1107296512,1107820544,524544,1073741824,33554432,1074266112,1074266112,0,1073742080,1107820800,1107820800,33554688,1107820544,1073742080,0,1107296256,34078976,33554432,1107296256,524544,524288,1107296512,256,33554432,1073741824,34078720,1107296512,1074266368,33554688,1073741824,1107820544,34078976,1074266368,256,33554432,1107820544,1107820800,524544,1107296256,1107820800,34078720,0,1074266112,1107296256,524544,33554688,1073742080,524288,0,1074266112,34078976,1073742080],XG=[536870928,541065216,16384,541081616,541065216,16,541081616,4194304,536887296,4210704,4194304,536870928,4194320,536887296,536870912,16400,0,4194320,536887312,16384,4210688,536887312,16,541065232,541065232,0,4210704,541081600,16400,4210688,541081600,536870912,536887296,16,541065232,4210688,541081616,4194304,16400,536870928,4194304,536887296,536870912,16400,536870928,541081616,4210688,541065216,4210704,541081600,0,541065232,16,16384,541065216,4210704,16384,4194320,536887312,0,541081600,536870912,4194320,536887312],JG=[2097152,69206018,67110914,0,2048,67110914,2099202,69208064,69208066,2097152,0,67108866,2,67108864,69206018,2050,67110912,2099202,2097154,67110912,67108866,69206016,69208064,2097154,69206016,2048,2050,69208066,2099200,2,67108864,2099200,67108864,2099200,2097152,67110914,67110914,69206018,69206018,2,2097154,67108864,67110912,2097152,69208064,2050,2099202,69208064,2050,67108866,69208066,69206016,2099200,0,2,69208066,0,2099202,69206016,2048,67108866,67110912,2048,2097154],ZG=[268439616,4096,262144,268701760,268435456,268439616,64,268435456,262208,268697600,268701760,266240,268701696,266304,4096,64,268697600,268435520,268439552,4160,266240,262208,268697664,268701696,4160,0,0,268697664,268435520,268439552,266304,262144,266304,262144,268701696,4096,64,268697664,4096,266304,268439552,64,268435520,268697600,268697664,268435456,262144,268439616,0,268701760,262208,268435520,268697600,268439552,268439616,0,268701760,266240,266240,4160,4160,262208,268435456,268701696];function eW(r){for(var e=[0,4,536870912,536870916,65536,65540,536936448,536936452,512,516,536871424,536871428,66048,66052,536936960,536936964],t=[0,1,1048576,1048577,67108864,67108865,68157440,68157441,256,257,1048832,1048833,67109120,67109121,68157696,68157697],n=[0,8,2048,2056,16777216,16777224,16779264,16779272,0,8,2048,2056,16777216,16777224,16779264,16779272],s=[0,2097152,134217728,136314880,8192,2105344,134225920,136323072,131072,2228224,134348800,136445952,139264,2236416,134356992,136454144],o=[0,262144,16,262160,0,262144,16,262160,4096,266240,4112,266256,4096,266240,4112,266256],i=[0,1024,32,1056,0,1024,32,1056,33554432,33555456,33554464,33555488,33554432,33555456,33554464,33555488],a=[0,268435456,524288,268959744,2,268435458,524290,268959746,0,268435456,524288,268959744,2,268435458,524290,268959746],c=[0,65536,2048,67584,536870912,536936448,536872960,536938496,131072,196608,133120,198656,537001984,537067520,537004032,537069568],l=[0,262144,0,262144,2,262146,2,262146,33554432,33816576,33554432,33816576,33554434,33816578,33554434,33816578],u=[0,268435456,8,268435464,0,268435456,8,268435464,1024,268436480,1032,268436488,1024,268436480,1032,268436488],f=[0,32,0,32,1048576,1048608,1048576,1048608,8192,8224,8192,8224,1056768,1056800,1056768,1056800],h=[0,16777216,512,16777728,2097152,18874368,2097664,18874880,67108864,83886080,67109376,83886592,69206016,85983232,69206528,85983744],d=[0,4096,134217728,134221824,524288,528384,134742016,134746112,16,4112,134217744,134221840,524304,528400,134742032,134746128],p=[0,4,256,260,0,4,256,260,1,5,257,261,1,5,257,261],m=r.length()>8?3:1,y=[],b=[0,0,1,1,1,1,1,1,0,1,1,1,1,1,1,0],w=0,E,x=0;x<m;x++){var v=r.getInt32(),S=r.getInt32();E=(v>>>4^S)&252645135,S^=E,v^=E<<4,E=(S>>>-16^v)&65535,v^=E,S^=E<<-16,E=(v>>>2^S)&858993459,S^=E,v^=E<<2,E=(S>>>-16^v)&65535,v^=E,S^=E<<-16,E=(v>>>1^S)&1431655765,S^=E,v^=E<<1,E=(S>>>8^v)&16711935,v^=E,S^=E<<8,E=(v>>>1^S)&1431655765,S^=E,v^=E<<1,E=v<<8|S>>>20&240,v=S<<24|S<<8&16711680|S>>>8&65280|S>>>24&240,S=E;for(var A=0;A<b.length;++A){b[A]?(v=v<<2|v>>>26,S=S<<2|S>>>26):(v=v<<1|v>>>27,S=S<<1|S>>>27),v&=-15,S&=-15;var _=e[v>>>28]|t[v>>>24&15]|n[v>>>20&15]|s[v>>>16&15]|o[v>>>12&15]|i[v>>>8&15]|a[v>>>4&15],D=c[S>>>28]|l[S>>>24&15]|u[S>>>20&15]|f[S>>>16&15]|h[S>>>12&15]|d[S>>>8&15]|p[S>>>4&15];E=(D>>>16^_)&65535,y[w++]=_^E,y[w++]=D^E<<16}}return y}function UR(r,e,t,n){var s=r.length===32?3:9,o;s===3?o=n?[30,-2,-2]:[0,32,2]:o=n?[94,62,-2,32,64,2,30,-2,-2]:[0,32,2,62,30,-2,64,96,2];var i,a=e[0],c=e[1];i=(a>>>4^c)&252645135,c^=i,a^=i<<4,i=(a>>>16^c)&65535,c^=i,a^=i<<16,i=(c>>>2^a)&858993459,a^=i,c^=i<<2,i=(c>>>8^a)&16711935,a^=i,c^=i<<8,i=(a>>>1^c)&1431655765,c^=i,a^=i<<1,a=a<<1|a>>>31,c=c<<1|c>>>31;for(var l=0;l<s;l+=3){for(var u=o[l+1],f=o[l+2],h=o[l];h!=u;h+=f){var d=c^r[h],p=(c>>>4|c<<28)^r[h+1];i=a,a=c,c=i^(WG[d>>>24&63]|jG[d>>>16&63]|XG[d>>>8&63]|ZG[d&63]|GG[p>>>24&63]|YG[p>>>16&63]|QG[p>>>8&63]|JG[p&63])}i=a,a=c,c=i}a=a>>>1|a<<31,c=c>>>1|c<<31,i=(a>>>1^c)&1431655765,c^=i,a^=i<<1,i=(c>>>8^a)&16711935,a^=i,c^=i<<8,i=(c>>>2^a)&858993459,a^=i,c^=i<<2,i=(a>>>16^c)&65535,c^=i,a^=i<<16,i=(a>>>4^c)&252645135,c^=i,a^=i<<4,t[0]=a,t[1]=c}function S1(r){r=r||{};var e=(r.mode||"CBC").toUpperCase(),t="DES-"+e,n;r.decrypt?n=xt.cipher.createDecipher(t,r.key):n=xt.cipher.createCipher(t,r.key);var s=n.start;return n.start=function(o,i){var a=null;i instanceof xt.util.ByteBuffer&&(a=i,i={}),i=i||{},i.output=a,i.iv=o,s.call(n,i)},n}});var Sc=Y((Y4e,qR)=>{var _1=Ge();qR.exports=_1.md=_1.md||{};_1.md.algorithms=_1.md.algorithms||{}});var zR=Y((j4e,HR)=>{var zo=Ge();Sc();Kt();var tW=HR.exports=zo.hmac=zo.hmac||{};tW.create=function(){var r=null,e=null,t=null,n=null,s={};return s.start=function(o,i){if(o!==null)if(typeof o=="string")if(o=o.toLowerCase(),o in zo.md.algorithms)e=zo.md.algorithms[o].create();else throw new Error('Unknown hash algorithm "'+o+'"');else e=o;if(i===null)i=r;else{if(typeof i=="string")i=zo.util.createBuffer(i);else if(zo.util.isArray(i)){var a=i;i=zo.util.createBuffer();for(var c=0;c<a.length;++c)i.putByte(a[c])}var l=i.length();l>e.blockLength&&(e.start(),e.update(i.bytes()),i=e.digest()),t=zo.util.createBuffer(),n=zo.util.createBuffer(),l=i.length();for(var c=0;c<l;++c){var a=i.at(c);t.putByte(54^a),n.putByte(92^a)}if(l<e.blockLength)for(var a=e.blockLength-l,c=0;c<a;++c)t.putByte(54),n.putByte(92);r=i,t=t.bytes(),n=n.bytes()}e.start(),e.update(t)},s.update=function(o){e.update(o)},s.getMac=function(){var o=e.digest().bytes();return e.start(),e.update(n),e.update(o),e.digest()},s.digest=s.getMac,s}});var A1=Y(()=>{});var G8=Y((J4e,$R)=>{var Qr=Ge();zR();Sc();Kt();var rW=Qr.pkcs5=Qr.pkcs5||{},$o;Qr.util.isNodejs&&!Qr.options.usePureJavaScript&&($o=A1());$R.exports=Qr.pbkdf2=rW.pbkdf2=function(r,e,t,n,s,o){if(typeof s=="function"&&(o=s,s=null),Qr.util.isNodejs&&!Qr.options.usePureJavaScript&&$o.pbkdf2&&(s===null||typeof s!="object")&&($o.pbkdf2Sync.length>4||!s||s==="sha1"))return typeof s!="string"&&(s="sha1"),r=Buffer.from(r,"binary"),e=Buffer.from(e,"binary"),o?$o.pbkdf2Sync.length===4?$o.pbkdf2(r,e,t,n,function(E,x){if(E)return o(E);o(null,x.toString("binary"))}):$o.pbkdf2(r,e,t,n,s,function(E,x){if(E)return o(E);o(null,x.toString("binary"))}):$o.pbkdf2Sync.length===4?$o.pbkdf2Sync(r,e,t,n).toString("binary"):$o.pbkdf2Sync(r,e,t,n,s).toString("binary");if((typeof s>"u"||s===null)&&(s="sha1"),typeof s=="string"){if(!(s in Qr.md.algorithms))throw new Error("Unknown hash algorithm: "+s);s=Qr.md[s].create()}var i=s.digestLength;if(n>4294967295*i){var a=new Error("Derived key is too long.");if(o)return o(a);throw a}var c=Math.ceil(n/i),l=n-(c-1)*i,u=Qr.hmac.create();u.start(s,r);var f="",h,d,p;if(!o){for(var m=1;m<=c;++m){u.start(null,null),u.update(e),u.update(Qr.util.int32ToBytes(m)),h=p=u.digest().getBytes();for(var y=2;y<=t;++y)u.start(null,null),u.update(p),d=u.digest().getBytes(),h=Qr.util.xorBytes(h,d,i),p=d;f+=m<c?h:h.substr(0,l)}return f}var m=1,y;function b(){if(m>c)return o(null,f);u.start(null,null),u.update(e),u.update(Qr.util.int32ToBytes(m)),h=p=u.digest().getBytes(),y=2,w()}function w(){if(y<=t)return u.start(null,null),u.update(p),d=u.digest().getBytes(),h=Qr.util.xorBytes(h,d,i),p=d,++y,Qr.util.setImmediate(w);f+=m<c?h:h.substr(0,l),++m,b()}b()}});var YR=Y((Z4e,WR)=>{var I1=Ge();Kt();var GR=WR.exports=I1.pem=I1.pem||{};GR.encode=function(r,e){e=e||{};var t="-----BEGIN "+r.type+`-----\r
`,n;if(r.procType&&(n={name:"Proc-Type",values:[String(r.procType.version),r.procType.type]},t+=R1(n)),r.contentDomain&&(n={name:"Content-Domain",values:[r.contentDomain]},t+=R1(n)),r.dekInfo&&(n={name:"DEK-Info",values:[r.dekInfo.algorithm]},r.dekInfo.parameters&&n.values.push(r.dekInfo.parameters),t+=R1(n)),r.headers)for(var s=0;s<r.headers.length;++s)t+=R1(r.headers[s]);return r.procType&&(t+=`\r
`),t+=I1.util.encode64(r.body,e.maxline||64)+`\r
`,t+="-----END "+r.type+`-----\r
`,t};GR.decode=function(r){for(var e=[],t=/\s*-----BEGIN ([A-Z0-9- ]+)-----\r?\n?([\x21-\x7e\s]+?(?:\r?\n\r?\n))?([:A-Za-z0-9+\/=\s]+?)-----END \1-----/g,n=/([\x21-\x7e]+):\s*([\x21-\x7e\s^:]+)/,s=/\r?\n/,o;o=t.exec(r),!!o;){var i=o[1];i==="NEW CERTIFICATE REQUEST"&&(i="CERTIFICATE REQUEST");var a={type:i,procType:null,contentDomain:null,dekInfo:null,headers:[],body:I1.util.decode64(o[3])};if(e.push(a),!!o[2]){for(var c=o[2].split(s),l=0;o&&l<c.length;){for(var u=c[l].replace(/\s+$/,""),f=l+1;f<c.length;++f){var h=c[f];if(!/\s/.test(h[0]))break;u+=h,l=f}if(o=u.match(n),o){for(var d={name:o[1],values:[]},p=o[2].split(","),m=0;m<p.length;++m)d.values.push(nW(p[m]));if(a.procType)if(!a.contentDomain&&d.name==="Content-Domain")a.contentDomain=p[0]||"";else if(!a.dekInfo&&d.name==="DEK-Info"){if(d.values.length===0)throw new Error('Invalid PEM formatted message. The "DEK-Info" header must have at least one subfield.');a.dekInfo={algorithm:p[0],parameters:p[1]||null}}else a.headers.push(d);else{if(d.name!=="Proc-Type")throw new Error('Invalid PEM formatted message. The first encapsulated header must be "Proc-Type".');if(d.values.length!==2)throw new Error('Invalid PEM formatted message. The "Proc-Type" header must have two subfields.');a.procType={version:p[0],type:p[1]}}}++l}if(a.procType==="ENCRYPTED"&&!a.dekInfo)throw new Error('Invalid PEM formatted message. The "DEK-Info" header must be present if "Proc-Type" is "ENCRYPTED".')}}if(e.length===0)throw new Error("Invalid PEM formatted message.");return e};function R1(r){for(var e=r.name+": ",t=[],n=function(c,l){return" "+l},s=0;s<r.values.length;++s)t.push(r.values[s].replace(/^(\S+\r\n)/,n));e+=t.join(",")+`\r
`;for(var o=0,i=-1,s=0;s<e.length;++s,++o)if(o>65&&i!==-1){var a=e[i];a===","?(++i,e=e.substr(0,i)+`\r
 `+e.substr(i)):e=e.substr(0,i)+`\r
`+a+e.substr(i+1),o=s-i-1,i=-1,++s}else(e[s]===" "||e[s]==="	"||e[s]===",")&&(i=s);return e}function nW(r){return r.replace(/^\s+/,"")}});var eI=Y((e8e,ZR)=>{var Qs=Ge();Sc();Kt();var QR=ZR.exports=Qs.sha256=Qs.sha256||{};Qs.md.sha256=Qs.md.algorithms.sha256=QR;QR.create=function(){XR||sW();var r=null,e=Qs.util.createBuffer(),t=new Array(64),n={algorithm:"sha256",blockLength:64,digestLength:32,messageLength:0,fullMessageLength:null,messageLengthSize:8};return n.start=function(){n.messageLength=0,n.fullMessageLength=n.messageLength64=[];for(var s=n.messageLengthSize/4,o=0;o<s;++o)n.fullMessageLength.push(0);return e=Qs.util.createBuffer(),r={h0:1779033703,h1:3144134277,h2:1013904242,h3:2773480762,h4:1359893119,h5:2600822924,h6:528734635,h7:1541459225},n},n.start(),n.update=function(s,o){o==="utf8"&&(s=Qs.util.encodeUtf8(s));var i=s.length;n.messageLength+=i,i=[i/4294967296>>>0,i>>>0];for(var a=n.fullMessageLength.length-1;a>=0;--a)n.fullMessageLength[a]+=i[1],i[1]=i[0]+(n.fullMessageLength[a]/4294967296>>>0),n.fullMessageLength[a]=n.fullMessageLength[a]>>>0,i[0]=i[1]/4294967296>>>0;return e.putBytes(s),jR(r,t,e),(e.read>2048||e.length()===0)&&e.compact(),n},n.digest=function(){var s=Qs.util.createBuffer();s.putBytes(e.bytes());var o=n.fullMessageLength[n.fullMessageLength.length-1]+n.messageLengthSize,i=o&n.blockLength-1;s.putBytes(W8.substr(0,n.blockLength-i));for(var a,c,l=n.fullMessageLength[0]*8,u=0;u<n.fullMessageLength.length-1;++u)a=n.fullMessageLength[u+1]*8,c=a/4294967296>>>0,l+=c,s.putInt32(l>>>0),l=a>>>0;s.putInt32(l);var f={h0:r.h0,h1:r.h1,h2:r.h2,h3:r.h3,h4:r.h4,h5:r.h5,h6:r.h6,h7:r.h7};jR(f,t,s);var h=Qs.util.createBuffer();return h.putInt32(f.h0),h.putInt32(f.h1),h.putInt32(f.h2),h.putInt32(f.h3),h.putInt32(f.h4),h.putInt32(f.h5),h.putInt32(f.h6),h.putInt32(f.h7),h},n};var W8=null,XR=!1,JR=null;function sW(){W8="\x80",W8+=Qs.util.fillString("\0",64),JR=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],XR=!0}function jR(r,e,t){for(var n,s,o,i,a,c,l,u,f,h,d,p,m,y,b,w=t.length();w>=64;){for(l=0;l<16;++l)e[l]=t.getInt32();for(;l<64;++l)n=e[l-2],n=(n>>>17|n<<15)^(n>>>19|n<<13)^n>>>10,s=e[l-15],s=(s>>>7|s<<25)^(s>>>18|s<<14)^s>>>3,e[l]=n+e[l-7]+s+e[l-16]|0;for(u=r.h0,f=r.h1,h=r.h2,d=r.h3,p=r.h4,m=r.h5,y=r.h6,b=r.h7,l=0;l<64;++l)i=(p>>>6|p<<26)^(p>>>11|p<<21)^(p>>>25|p<<7),a=y^p&(m^y),o=(u>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),c=u&f|h&(u^f),n=b+i+a+JR[l]+e[l],s=o+c,b=y,y=m,m=p,p=d+n>>>0,d=h,h=f,f=u,u=n+s>>>0;r.h0=r.h0+u|0,r.h1=r.h1+f|0,r.h2=r.h2+h|0,r.h3=r.h3+d|0,r.h4=r.h4+p|0,r.h5=r.h5+m|0,r.h6=r.h6+y|0,r.h7=r.h7+b|0,w-=64}}});var rI=Y((t8e,tI)=>{var Xs=Ge();Kt();var T1=null;Xs.util.isNodejs&&!Xs.options.usePureJavaScript&&!process.versions["node-webkit"]&&(T1=A1());var oW=tI.exports=Xs.prng=Xs.prng||{};oW.create=function(r){for(var e={plugin:r,key:null,seed:null,time:null,reseeds:0,generated:0,keyBytes:""},t=r.md,n=new Array(32),s=0;s<32;++s)n[s]=t.create();e.pools=n,e.pool=0,e.generate=function(l,u){if(!u)return e.generateSync(l);var f=e.plugin.cipher,h=e.plugin.increment,d=e.plugin.formatKey,p=e.plugin.formatSeed,m=Xs.util.createBuffer();e.key=null,y();function y(b){if(b)return u(b);if(m.length()>=l)return u(null,m.getBytes(l));if(e.generated>1048575&&(e.key=null),e.key===null)return Xs.util.nextTick(function(){o(y)});var w=f(e.key,e.seed);e.generated+=w.length,m.putBytes(w),e.key=d(f(e.key,h(e.seed))),e.seed=p(f(e.key,e.seed)),Xs.util.setImmediate(y)}},e.generateSync=function(l){var u=e.plugin.cipher,f=e.plugin.increment,h=e.plugin.formatKey,d=e.plugin.formatSeed;e.key=null;for(var p=Xs.util.createBuffer();p.length()<l;){e.generated>1048575&&(e.key=null),e.key===null&&i();var m=u(e.key,e.seed);e.generated+=m.length,p.putBytes(m),e.key=h(u(e.key,f(e.seed))),e.seed=d(u(e.key,e.seed))}return p.getBytes(l)};function o(l){if(e.pools[0].messageLength>=32)return a(),l();var u=32-e.pools[0].messageLength<<5;e.seedFile(u,function(f,h){if(f)return l(f);e.collect(h),a(),l()})}function i(){if(e.pools[0].messageLength>=32)return a();var l=32-e.pools[0].messageLength<<5;e.collect(e.seedFileSync(l)),a()}function a(){e.reseeds=e.reseeds===4294967295?0:e.reseeds+1;var l=e.plugin.md.create();l.update(e.keyBytes);for(var u=1,f=0;f<32;++f)e.reseeds%u===0&&(l.update(e.pools[f].digest().getBytes()),e.pools[f].start()),u=u<<1;e.keyBytes=l.digest().getBytes(),l.start(),l.update(e.keyBytes);var h=l.digest().getBytes();e.key=e.plugin.formatKey(e.keyBytes),e.seed=e.plugin.formatSeed(h),e.generated=0}function c(l){var u=null,f=Xs.util.globalScope,h=f.crypto||f.msCrypto;h&&h.getRandomValues&&(u=function(v){return h.getRandomValues(v)});var d=Xs.util.createBuffer();if(u)for(;d.length()<l;){var p=Math.max(1,Math.min(l-d.length(),65536)/4),m=new Uint32Array(Math.floor(p));try{u(m);for(var y=0;y<m.length;++y)d.putInt32(m[y])}catch(v){if(!(typeof QuotaExceededError<"u"&&v instanceof QuotaExceededError))throw v}}if(d.length()<l)for(var b,w,E,x=Math.floor(Math.random()*65536);d.length()<l;){w=16807*(x&65535),b=16807*(x>>16),w+=(b&32767)<<16,w+=b>>15,w=(w&2147483647)+(w>>31),x=w&4294967295;for(var y=0;y<3;++y)E=x>>>(y<<3),E^=Math.floor(Math.random()*256),d.putByte(E&255)}return d.getBytes(l)}return T1?(e.seedFile=function(l,u){T1.randomBytes(l,function(f,h){if(f)return u(f);u(null,h.toString())})},e.seedFileSync=function(l){return T1.randomBytes(l).toString()}):(e.seedFile=function(l,u){try{u(null,c(l))}catch(f){u(f)}},e.seedFileSync=c),e.collect=function(l){for(var u=l.length,f=0;f<u;++f)e.pools[e.pool].update(l.substr(f,1)),e.pool=e.pool===31?0:e.pool+1},e.collectInt=function(l,u){for(var f="",h=0;h<u;h+=8)f+=String.fromCharCode(l>>h&255);e.collect(f)},e.registerWorker=function(l){if(l===self)e.seedFile=function(f,h){function d(p){var m=p.data;m.forge&&m.forge.prng&&(self.removeEventListener("message",d),h(m.forge.prng.err,m.forge.prng.bytes))}self.addEventListener("message",d),self.postMessage({forge:{prng:{needed:f}}})};else{var u=function(f){var h=f.data;h.forge&&h.forge.prng&&e.seedFile(h.forge.prng.needed,function(d,p){l.postMessage({forge:{prng:{err:d,bytes:p}}})})};l.addEventListener("message",u)}},e}});var lp=Y((r8e,Y8)=>{var mr=Ge();E1();eI();rI();Kt();(function(){if(mr.random&&mr.random.getBytes){Y8.exports=mr.random;return}(function(r){var e={},t=new Array(4),n=mr.util.createBuffer();e.formatKey=function(f){var h=mr.util.createBuffer(f);return f=new Array(4),f[0]=h.getInt32(),f[1]=h.getInt32(),f[2]=h.getInt32(),f[3]=h.getInt32(),mr.aes._expandKey(f,!1)},e.formatSeed=function(f){var h=mr.util.createBuffer(f);return f=new Array(4),f[0]=h.getInt32(),f[1]=h.getInt32(),f[2]=h.getInt32(),f[3]=h.getInt32(),f},e.cipher=function(f,h){return mr.aes._updateBlock(f,h,t,!1),n.putInt32(t[0]),n.putInt32(t[1]),n.putInt32(t[2]),n.putInt32(t[3]),n.getBytes()},e.increment=function(f){return++f[3],f},e.md=mr.md.sha256;function s(){var f=mr.prng.create(e);return f.getBytes=function(h,d){return f.generate(h,d)},f.getBytesSync=function(h){return f.generate(h)},f}var o=s(),i=null,a=mr.util.globalScope,c=a.crypto||a.msCrypto;if(c&&c.getRandomValues&&(i=function(f){return c.getRandomValues(f)}),mr.options.usePureJavaScript||!mr.util.isNodejs&&!i){if(typeof window>"u"||window.document,o.collectInt(+new Date,32),typeof navigator<"u"){var l="";for(var u in navigator)try{typeof navigator[u]=="string"&&(l+=navigator[u])}catch{}o.collect(l),l=null}r&&(r().mousemove(function(f){o.collectInt(f.clientX,16),o.collectInt(f.clientY,16)}),r().keypress(function(f){o.collectInt(f.charCode,8)}))}if(!mr.random)mr.random=o;else for(var u in o)mr.random[u]=o[u];mr.random.createInstance=s,Y8.exports=mr.random})(typeof jQuery<"u"?jQuery:null)})()});var iI=Y((n8e,oI)=>{var cn=Ge();Kt();var j8=[217,120,249,196,25,221,181,237,40,233,253,121,74,160,216,157,198,126,55,131,43,118,83,142,98,76,100,136,68,139,251,162,23,154,89,245,135,179,79,19,97,69,109,141,9,129,125,50,189,143,64,235,134,183,123,11,240,149,33,34,92,107,78,130,84,214,101,147,206,96,178,28,115,86,192,20,167,140,241,220,18,117,202,31,59,190,228,209,66,61,212,48,163,60,182,38,111,191,14,218,70,105,7,87,39,242,29,155,188,148,67,3,248,17,199,246,144,239,62,231,6,195,213,47,200,102,30,215,8,232,234,222,128,82,238,247,132,170,114,172,53,77,106,42,150,26,210,113,90,21,73,116,75,159,208,94,4,24,164,236,194,224,65,110,15,81,203,204,36,145,175,80,161,244,112,57,153,124,58,133,35,184,180,122,252,2,54,91,37,85,151,49,45,93,250,152,227,138,146,174,5,223,41,16,103,108,186,201,211,0,230,207,225,158,168,44,99,22,1,63,88,226,137,169,13,56,52,27,171,51,255,176,187,72,12,95,185,177,205,46,197,243,219,71,229,165,156,119,10,166,32,104,254,127,193,173],nI=[1,2,3,5],iW=function(r,e){return r<<e&65535|(r&65535)>>16-e},aW=function(r,e){return(r&65535)>>e|r<<16-e&65535};oI.exports=cn.rc2=cn.rc2||{};cn.rc2.expandKey=function(r,e){typeof r=="string"&&(r=cn.util.createBuffer(r)),e=e||128;var t=r,n=r.length(),s=e,o=Math.ceil(s/8),i=255>>(s&7),a;for(a=n;a<128;a++)t.putByte(j8[t.at(a-1)+t.at(a-n)&255]);for(t.setAt(128-o,j8[t.at(128-o)&i]),a=127-o;a>=0;a--)t.setAt(a,j8[t.at(a+1)^t.at(a+o)]);return t};var sI=function(r,e,t){var n=!1,s=null,o=null,i=null,a,c,l,u,f=[];for(r=cn.rc2.expandKey(r,e),l=0;l<64;l++)f.push(r.getInt16Le());t?(a=function(p){for(l=0;l<4;l++)p[l]+=f[u]+(p[(l+3)%4]&p[(l+2)%4])+(~p[(l+3)%4]&p[(l+1)%4]),p[l]=iW(p[l],nI[l]),u++},c=function(p){for(l=0;l<4;l++)p[l]+=f[p[(l+3)%4]&63]}):(a=function(p){for(l=3;l>=0;l--)p[l]=aW(p[l],nI[l]),p[l]-=f[u]+(p[(l+3)%4]&p[(l+2)%4])+(~p[(l+3)%4]&p[(l+1)%4]),u--},c=function(p){for(l=3;l>=0;l--)p[l]-=f[p[(l+3)%4]&63]});var h=function(p){var m=[];for(l=0;l<4;l++){var y=s.getInt16Le();i!==null&&(t?y^=i.getInt16Le():i.putInt16Le(y)),m.push(y&65535)}u=t?0:63;for(var b=0;b<p.length;b++)for(var w=0;w<p[b][0];w++)p[b][1](m);for(l=0;l<4;l++)i!==null&&(t?i.putInt16Le(m[l]):m[l]^=i.getInt16Le()),o.putInt16Le(m[l])},d=null;return d={start:function(p,m){p&&typeof p=="string"&&(p=cn.util.createBuffer(p)),n=!1,s=cn.util.createBuffer(),o=m||new cn.util.createBuffer,i=p,d.output=o},update:function(p){for(n||s.putBuffer(p);s.length()>=8;)h([[5,a],[1,c],[6,a],[1,c],[5,a]])},finish:function(p){var m=!0;if(t)if(p)m=p(8,s,!t);else{var y=s.length()===8?8:8-s.length();s.fillWithByte(y,y)}if(m&&(n=!0,d.update()),!t&&(m=s.length()===0,m))if(p)m=p(8,o,!t);else{var b=o.length(),w=o.at(b-1);w>b?m=!1:o.truncate(w)}return m}},d};cn.rc2.startEncrypting=function(r,e,t){var n=cn.rc2.createEncryptionCipher(r,128);return n.start(e,t),n};cn.rc2.createEncryptionCipher=function(r,e){return sI(r,e,!0)};cn.rc2.startDecrypting=function(r,e,t){var n=cn.rc2.createDecryptionCipher(r,128);return n.start(e,t),n};cn.rc2.createDecryptionCipher=function(r,e){return sI(r,e,!1)}});var fp=Y((s8e,dI)=>{var Q8=Ge();dI.exports=Q8.jsbn=Q8.jsbn||{};var Go,cW=0xdeadbeefcafe,aI=(cW&16777215)==15715070;function H(r,e,t){this.data=[],r!=null&&(typeof r=="number"?this.fromNumber(r,e,t):e==null&&typeof r!="string"?this.fromString(r,256):this.fromString(r,e))}Q8.jsbn.BigInteger=H;function Xe(){return new H(null)}function lW(r,e,t,n,s,o){for(;--o>=0;){var i=e*this.data[r++]+t.data[n]+s;s=Math.floor(i/67108864),t.data[n++]=i&67108863}return s}function uW(r,e,t,n,s,o){for(var i=e&32767,a=e>>15;--o>=0;){var c=this.data[r]&32767,l=this.data[r++]>>15,u=a*c+l*i;c=i*c+((u&32767)<<15)+t.data[n]+(s&1073741823),s=(c>>>30)+(u>>>15)+a*l+(s>>>30),t.data[n++]=c&1073741823}return s}function cI(r,e,t,n,s,o){for(var i=e&16383,a=e>>14;--o>=0;){var c=this.data[r]&16383,l=this.data[r++]>>14,u=a*c+l*i;c=i*c+((u&16383)<<14)+t.data[n]+s,s=(c>>28)+(u>>14)+a*l,t.data[n++]=c&268435455}return s}typeof navigator>"u"?(H.prototype.am=cI,Go=28):aI&&navigator.appName=="Microsoft Internet Explorer"?(H.prototype.am=uW,Go=30):aI&&navigator.appName!="Netscape"?(H.prototype.am=lW,Go=26):(H.prototype.am=cI,Go=28);H.prototype.DB=Go;H.prototype.DM=(1<<Go)-1;H.prototype.DV=1<<Go;var X8=52;H.prototype.FV=Math.pow(2,X8);H.prototype.F1=X8-Go;H.prototype.F2=2*Go-X8;var fW="0123456789abcdefghijklmnopqrstuvwxyz",k1=new Array,iu,Fn;iu=48;for(Fn=0;Fn<=9;++Fn)k1[iu++]=Fn;iu=97;for(Fn=10;Fn<36;++Fn)k1[iu++]=Fn;iu=65;for(Fn=10;Fn<36;++Fn)k1[iu++]=Fn;function lI(r){return fW.charAt(r)}function uI(r,e){var t=k1[r.charCodeAt(e)];return t??-1}function hW(r){for(var e=this.t-1;e>=0;--e)r.data[e]=this.data[e];r.t=this.t,r.s=this.s}function pW(r){this.t=1,this.s=r<0?-1:0,r>0?this.data[0]=r:r<-1?this.data[0]=r+this.DV:this.t=0}function na(r){var e=Xe();return e.fromInt(r),e}function dW(r,e){var t;if(e==16)t=4;else if(e==8)t=3;else if(e==256)t=8;else if(e==2)t=1;else if(e==32)t=5;else if(e==4)t=2;else{this.fromRadix(r,e);return}this.t=0,this.s=0;for(var n=r.length,s=!1,o=0;--n>=0;){var i=t==8?r[n]&255:uI(r,n);if(i<0){r.charAt(n)=="-"&&(s=!0);continue}s=!1,o==0?this.data[this.t++]=i:o+t>this.DB?(this.data[this.t-1]|=(i&(1<<this.DB-o)-1)<<o,this.data[this.t++]=i>>this.DB-o):this.data[this.t-1]|=i<<o,o+=t,o>=this.DB&&(o-=this.DB)}t==8&&r[0]&128&&(this.s=-1,o>0&&(this.data[this.t-1]|=(1<<this.DB-o)-1<<o)),this.clamp(),s&&H.ZERO.subTo(this,this)}function mW(){for(var r=this.s&this.DM;this.t>0&&this.data[this.t-1]==r;)--this.t}function yW(r){if(this.s<0)return"-"+this.negate().toString(r);var e;if(r==16)e=4;else if(r==8)e=3;else if(r==2)e=1;else if(r==32)e=5;else if(r==4)e=2;else return this.toRadix(r);var t=(1<<e)-1,n,s=!1,o="",i=this.t,a=this.DB-i*this.DB%e;if(i-- >0)for(a<this.DB&&(n=this.data[i]>>a)>0&&(s=!0,o=lI(n));i>=0;)a<e?(n=(this.data[i]&(1<<a)-1)<<e-a,n|=this.data[--i]>>(a+=this.DB-e)):(n=this.data[i]>>(a-=e)&t,a<=0&&(a+=this.DB,--i)),n>0&&(s=!0),s&&(o+=lI(n));return s?o:"0"}function gW(){var r=Xe();return H.ZERO.subTo(this,r),r}function bW(){return this.s<0?this.negate():this}function wW(r){var e=this.s-r.s;if(e!=0)return e;var t=this.t;if(e=t-r.t,e!=0)return this.s<0?-e:e;for(;--t>=0;)if((e=this.data[t]-r.data[t])!=0)return e;return 0}function D1(r){var e=1,t;return(t=r>>>16)!=0&&(r=t,e+=16),(t=r>>8)!=0&&(r=t,e+=8),(t=r>>4)!=0&&(r=t,e+=4),(t=r>>2)!=0&&(r=t,e+=2),(t=r>>1)!=0&&(r=t,e+=1),e}function EW(){return this.t<=0?0:this.DB*(this.t-1)+D1(this.data[this.t-1]^this.s&this.DM)}function vW(r,e){var t;for(t=this.t-1;t>=0;--t)e.data[t+r]=this.data[t];for(t=r-1;t>=0;--t)e.data[t]=0;e.t=this.t+r,e.s=this.s}function xW(r,e){for(var t=r;t<this.t;++t)e.data[t-r]=this.data[t];e.t=Math.max(this.t-r,0),e.s=this.s}function SW(r,e){var t=r%this.DB,n=this.DB-t,s=(1<<n)-1,o=Math.floor(r/this.DB),i=this.s<<t&this.DM,a;for(a=this.t-1;a>=0;--a)e.data[a+o+1]=this.data[a]>>n|i,i=(this.data[a]&s)<<t;for(a=o-1;a>=0;--a)e.data[a]=0;e.data[o]=i,e.t=this.t+o+1,e.s=this.s,e.clamp()}function _W(r,e){e.s=this.s;var t=Math.floor(r/this.DB);if(t>=this.t){e.t=0;return}var n=r%this.DB,s=this.DB-n,o=(1<<n)-1;e.data[0]=this.data[t]>>n;for(var i=t+1;i<this.t;++i)e.data[i-t-1]|=(this.data[i]&o)<<s,e.data[i-t]=this.data[i]>>n;n>0&&(e.data[this.t-t-1]|=(this.s&o)<<s),e.t=this.t-t,e.clamp()}function AW(r,e){for(var t=0,n=0,s=Math.min(r.t,this.t);t<s;)n+=this.data[t]-r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;if(r.t<this.t){for(n-=r.s;t<this.t;)n+=this.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;t<r.t;)n-=r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n-=r.s}e.s=n<0?-1:0,n<-1?e.data[t++]=this.DV+n:n>0&&(e.data[t++]=n),e.t=t,e.clamp()}function RW(r,e){var t=this.abs(),n=r.abs(),s=t.t;for(e.t=s+n.t;--s>=0;)e.data[s]=0;for(s=0;s<n.t;++s)e.data[s+t.t]=t.am(0,n.data[s],e,s,0,t.t);e.s=0,e.clamp(),this.s!=r.s&&H.ZERO.subTo(e,e)}function IW(r){for(var e=this.abs(),t=r.t=2*e.t;--t>=0;)r.data[t]=0;for(t=0;t<e.t-1;++t){var n=e.am(t,e.data[t],r,2*t,0,1);(r.data[t+e.t]+=e.am(t+1,2*e.data[t],r,2*t+1,n,e.t-t-1))>=e.DV&&(r.data[t+e.t]-=e.DV,r.data[t+e.t+1]=1)}r.t>0&&(r.data[r.t-1]+=e.am(t,e.data[t],r,2*t,0,1)),r.s=0,r.clamp()}function TW(r,e,t){var n=r.abs();if(!(n.t<=0)){var s=this.abs();if(s.t<n.t){e?.fromInt(0),t!=null&&this.copyTo(t);return}t==null&&(t=Xe());var o=Xe(),i=this.s,a=r.s,c=this.DB-D1(n.data[n.t-1]);c>0?(n.lShiftTo(c,o),s.lShiftTo(c,t)):(n.copyTo(o),s.copyTo(t));var l=o.t,u=o.data[l-1];if(u!=0){var f=u*(1<<this.F1)+(l>1?o.data[l-2]>>this.F2:0),h=this.FV/f,d=(1<<this.F1)/f,p=1<<this.F2,m=t.t,y=m-l,b=e??Xe();for(o.dlShiftTo(y,b),t.compareTo(b)>=0&&(t.data[t.t++]=1,t.subTo(b,t)),H.ONE.dlShiftTo(l,b),b.subTo(o,o);o.t<l;)o.data[o.t++]=0;for(;--y>=0;){var w=t.data[--m]==u?this.DM:Math.floor(t.data[m]*h+(t.data[m-1]+p)*d);if((t.data[m]+=o.am(0,w,t,y,0,l))<w)for(o.dlShiftTo(y,b),t.subTo(b,t);t.data[m]<--w;)t.subTo(b,t)}e!=null&&(t.drShiftTo(l,e),i!=a&&H.ZERO.subTo(e,e)),t.t=l,t.clamp(),c>0&&t.rShiftTo(c,t),i<0&&H.ZERO.subTo(t,t)}}}function kW(r){var e=Xe();return this.abs().divRemTo(r,null,e),this.s<0&&e.compareTo(H.ZERO)>0&&r.subTo(e,e),e}function _c(r){this.m=r}function DW(r){return r.s<0||r.compareTo(this.m)>=0?r.mod(this.m):r}function PW(r){return r}function CW(r){r.divRemTo(this.m,null,r)}function BW(r,e,t){r.multiplyTo(e,t),this.reduce(t)}function NW(r,e){r.squareTo(e),this.reduce(e)}_c.prototype.convert=DW;_c.prototype.revert=PW;_c.prototype.reduce=CW;_c.prototype.mulTo=BW;_c.prototype.sqrTo=NW;function LW(){if(this.t<1)return 0;var r=this.data[0];if(!(r&1))return 0;var e=r&3;return e=e*(2-(r&15)*e)&15,e=e*(2-(r&255)*e)&255,e=e*(2-((r&65535)*e&65535))&65535,e=e*(2-r*e%this.DV)%this.DV,e>0?this.DV-e:-e}function Ac(r){this.m=r,this.mp=r.invDigit(),this.mpl=this.mp&32767,this.mph=this.mp>>15,this.um=(1<<r.DB-15)-1,this.mt2=2*r.t}function OW(r){var e=Xe();return r.abs().dlShiftTo(this.m.t,e),e.divRemTo(this.m,null,e),r.s<0&&e.compareTo(H.ZERO)>0&&this.m.subTo(e,e),e}function KW(r){var e=Xe();return r.copyTo(e),this.reduce(e),e}function MW(r){for(;r.t<=this.mt2;)r.data[r.t++]=0;for(var e=0;e<this.m.t;++e){var t=r.data[e]&32767,n=t*this.mpl+((t*this.mph+(r.data[e]>>15)*this.mpl&this.um)<<15)&r.DM;for(t=e+this.m.t,r.data[t]+=this.m.am(0,n,r,e,0,this.m.t);r.data[t]>=r.DV;)r.data[t]-=r.DV,r.data[++t]++}r.clamp(),r.drShiftTo(this.m.t,r),r.compareTo(this.m)>=0&&r.subTo(this.m,r)}function UW(r,e){r.squareTo(e),this.reduce(e)}function FW(r,e,t){r.multiplyTo(e,t),this.reduce(t)}Ac.prototype.convert=OW;Ac.prototype.revert=KW;Ac.prototype.reduce=MW;Ac.prototype.mulTo=FW;Ac.prototype.sqrTo=UW;function VW(){return(this.t>0?this.data[0]&1:this.s)==0}function qW(r,e){if(r>4294967295||r<1)return H.ONE;var t=Xe(),n=Xe(),s=e.convert(this),o=D1(r)-1;for(s.copyTo(t);--o>=0;)if(e.sqrTo(t,n),(r&1<<o)>0)e.mulTo(n,s,t);else{var i=t;t=n,n=i}return e.revert(t)}function HW(r,e){var t;return r<256||e.isEven()?t=new _c(e):t=new Ac(e),this.exp(r,t)}H.prototype.copyTo=hW;H.prototype.fromInt=pW;H.prototype.fromString=dW;H.prototype.clamp=mW;H.prototype.dlShiftTo=vW;H.prototype.drShiftTo=xW;H.prototype.lShiftTo=SW;H.prototype.rShiftTo=_W;H.prototype.subTo=AW;H.prototype.multiplyTo=RW;H.prototype.squareTo=IW;H.prototype.divRemTo=TW;H.prototype.invDigit=LW;H.prototype.isEven=VW;H.prototype.exp=qW;H.prototype.toString=yW;H.prototype.negate=gW;H.prototype.abs=bW;H.prototype.compareTo=wW;H.prototype.bitLength=EW;H.prototype.mod=kW;H.prototype.modPowInt=HW;H.ZERO=na(0);H.ONE=na(1);function zW(){var r=Xe();return this.copyTo(r),r}function $W(){if(this.s<0){if(this.t==1)return this.data[0]-this.DV;if(this.t==0)return-1}else{if(this.t==1)return this.data[0];if(this.t==0)return 0}return(this.data[1]&(1<<32-this.DB)-1)<<this.DB|this.data[0]}function GW(){return this.t==0?this.s:this.data[0]<<24>>24}function WW(){return this.t==0?this.s:this.data[0]<<16>>16}function YW(r){return Math.floor(Math.LN2*this.DB/Math.log(r))}function jW(){return this.s<0?-1:this.t<=0||this.t==1&&this.data[0]<=0?0:1}function QW(r){if(r==null&&(r=10),this.signum()==0||r<2||r>36)return"0";var e=this.chunkSize(r),t=Math.pow(r,e),n=na(t),s=Xe(),o=Xe(),i="";for(this.divRemTo(n,s,o);s.signum()>0;)i=(t+o.intValue()).toString(r).substr(1)+i,s.divRemTo(n,s,o);return o.intValue().toString(r)+i}function XW(r,e){this.fromInt(0),e==null&&(e=10);for(var t=this.chunkSize(e),n=Math.pow(e,t),s=!1,o=0,i=0,a=0;a<r.length;++a){var c=uI(r,a);if(c<0){r.charAt(a)=="-"&&this.signum()==0&&(s=!0);continue}i=e*i+c,++o>=t&&(this.dMultiply(n),this.dAddOffset(i,0),o=0,i=0)}o>0&&(this.dMultiply(Math.pow(e,o)),this.dAddOffset(i,0)),s&&H.ZERO.subTo(this,this)}function JW(r,e,t){if(typeof e=="number")if(r<2)this.fromInt(1);else for(this.fromNumber(r,t),this.testBit(r-1)||this.bitwiseTo(H.ONE.shiftLeft(r-1),J8,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(e);)this.dAddOffset(2,0),this.bitLength()>r&&this.subTo(H.ONE.shiftLeft(r-1),this);else{var n=new Array,s=r&7;n.length=(r>>3)+1,e.nextBytes(n),s>0?n[0]&=(1<<s)-1:n[0]=0,this.fromString(n,256)}}function ZW(){var r=this.t,e=new Array;e[0]=this.s;var t=this.DB-r*this.DB%8,n,s=0;if(r-- >0)for(t<this.DB&&(n=this.data[r]>>t)!=(this.s&this.DM)>>t&&(e[s++]=n|this.s<<this.DB-t);r>=0;)t<8?(n=(this.data[r]&(1<<t)-1)<<8-t,n|=this.data[--r]>>(t+=this.DB-8)):(n=this.data[r]>>(t-=8)&255,t<=0&&(t+=this.DB,--r)),n&128&&(n|=-256),s==0&&(this.s&128)!=(n&128)&&++s,(s>0||n!=this.s)&&(e[s++]=n);return e}function eY(r){return this.compareTo(r)==0}function tY(r){return this.compareTo(r)<0?this:r}function rY(r){return this.compareTo(r)>0?this:r}function nY(r,e,t){var n,s,o=Math.min(r.t,this.t);for(n=0;n<o;++n)t.data[n]=e(this.data[n],r.data[n]);if(r.t<this.t){for(s=r.s&this.DM,n=o;n<this.t;++n)t.data[n]=e(this.data[n],s);t.t=this.t}else{for(s=this.s&this.DM,n=o;n<r.t;++n)t.data[n]=e(s,r.data[n]);t.t=r.t}t.s=e(this.s,r.s),t.clamp()}function sY(r,e){return r&e}function oY(r){var e=Xe();return this.bitwiseTo(r,sY,e),e}function J8(r,e){return r|e}function iY(r){var e=Xe();return this.bitwiseTo(r,J8,e),e}function fI(r,e){return r^e}function aY(r){var e=Xe();return this.bitwiseTo(r,fI,e),e}function hI(r,e){return r&~e}function cY(r){var e=Xe();return this.bitwiseTo(r,hI,e),e}function lY(){for(var r=Xe(),e=0;e<this.t;++e)r.data[e]=this.DM&~this.data[e];return r.t=this.t,r.s=~this.s,r}function uY(r){var e=Xe();return r<0?this.rShiftTo(-r,e):this.lShiftTo(r,e),e}function fY(r){var e=Xe();return r<0?this.lShiftTo(-r,e):this.rShiftTo(r,e),e}function hY(r){if(r==0)return-1;var e=0;return r&65535||(r>>=16,e+=16),r&255||(r>>=8,e+=8),r&15||(r>>=4,e+=4),r&3||(r>>=2,e+=2),r&1||++e,e}function pY(){for(var r=0;r<this.t;++r)if(this.data[r]!=0)return r*this.DB+hY(this.data[r]);return this.s<0?this.t*this.DB:-1}function dY(r){for(var e=0;r!=0;)r&=r-1,++e;return e}function mY(){for(var r=0,e=this.s&this.DM,t=0;t<this.t;++t)r+=dY(this.data[t]^e);return r}function yY(r){var e=Math.floor(r/this.DB);return e>=this.t?this.s!=0:(this.data[e]&1<<r%this.DB)!=0}function gY(r,e){var t=H.ONE.shiftLeft(r);return this.bitwiseTo(t,e,t),t}function bY(r){return this.changeBit(r,J8)}function wY(r){return this.changeBit(r,hI)}function EY(r){return this.changeBit(r,fI)}function vY(r,e){for(var t=0,n=0,s=Math.min(r.t,this.t);t<s;)n+=this.data[t]+r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;if(r.t<this.t){for(n+=r.s;t<this.t;)n+=this.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;t<r.t;)n+=r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n+=r.s}e.s=n<0?-1:0,n>0?e.data[t++]=n:n<-1&&(e.data[t++]=this.DV+n),e.t=t,e.clamp()}function xY(r){var e=Xe();return this.addTo(r,e),e}function SY(r){var e=Xe();return this.subTo(r,e),e}function _Y(r){var e=Xe();return this.multiplyTo(r,e),e}function AY(r){var e=Xe();return this.divRemTo(r,e,null),e}function RY(r){var e=Xe();return this.divRemTo(r,null,e),e}function IY(r){var e=Xe(),t=Xe();return this.divRemTo(r,e,t),new Array(e,t)}function TY(r){this.data[this.t]=this.am(0,r-1,this,0,0,this.t),++this.t,this.clamp()}function kY(r,e){if(r!=0){for(;this.t<=e;)this.data[this.t++]=0;for(this.data[e]+=r;this.data[e]>=this.DV;)this.data[e]-=this.DV,++e>=this.t&&(this.data[this.t++]=0),++this.data[e]}}function up(){}function pI(r){return r}function DY(r,e,t){r.multiplyTo(e,t)}function PY(r,e){r.squareTo(e)}up.prototype.convert=pI;up.prototype.revert=pI;up.prototype.mulTo=DY;up.prototype.sqrTo=PY;function CY(r){return this.exp(r,new up)}function BY(r,e,t){var n=Math.min(this.t+r.t,e);for(t.s=0,t.t=n;n>0;)t.data[--n]=0;var s;for(s=t.t-this.t;n<s;++n)t.data[n+this.t]=this.am(0,r.data[n],t,n,0,this.t);for(s=Math.min(r.t,e);n<s;++n)this.am(0,r.data[n],t,n,0,e-n);t.clamp()}function NY(r,e,t){--e;var n=t.t=this.t+r.t-e;for(t.s=0;--n>=0;)t.data[n]=0;for(n=Math.max(e-this.t,0);n<r.t;++n)t.data[this.t+n-e]=this.am(e-n,r.data[n],t,0,0,this.t+n-e);t.clamp(),t.drShiftTo(1,t)}function au(r){this.r2=Xe(),this.q3=Xe(),H.ONE.dlShiftTo(2*r.t,this.r2),this.mu=this.r2.divide(r),this.m=r}function LY(r){if(r.s<0||r.t>2*this.m.t)return r.mod(this.m);if(r.compareTo(this.m)<0)return r;var e=Xe();return r.copyTo(e),this.reduce(e),e}function OY(r){return r}function KY(r){for(r.drShiftTo(this.m.t-1,this.r2),r.t>this.m.t+1&&(r.t=this.m.t+1,r.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);r.compareTo(this.r2)<0;)r.dAddOffset(1,this.m.t+1);for(r.subTo(this.r2,r);r.compareTo(this.m)>=0;)r.subTo(this.m,r)}function MY(r,e){r.squareTo(e),this.reduce(e)}function UY(r,e,t){r.multiplyTo(e,t),this.reduce(t)}au.prototype.convert=LY;au.prototype.revert=OY;au.prototype.reduce=KY;au.prototype.mulTo=UY;au.prototype.sqrTo=MY;function FY(r,e){var t=r.bitLength(),n,s=na(1),o;if(t<=0)return s;t<18?n=1:t<48?n=3:t<144?n=4:t<768?n=5:n=6,t<8?o=new _c(e):e.isEven()?o=new au(e):o=new Ac(e);var i=new Array,a=3,c=n-1,l=(1<<n)-1;if(i[1]=o.convert(this),n>1){var u=Xe();for(o.sqrTo(i[1],u);a<=l;)i[a]=Xe(),o.mulTo(u,i[a-2],i[a]),a+=2}var f=r.t-1,h,d=!0,p=Xe(),m;for(t=D1(r.data[f])-1;f>=0;){for(t>=c?h=r.data[f]>>t-c&l:(h=(r.data[f]&(1<<t+1)-1)<<c-t,f>0&&(h|=r.data[f-1]>>this.DB+t-c)),a=n;!(h&1);)h>>=1,--a;if((t-=a)<0&&(t+=this.DB,--f),d)i[h].copyTo(s),d=!1;else{for(;a>1;)o.sqrTo(s,p),o.sqrTo(p,s),a-=2;a>0?o.sqrTo(s,p):(m=s,s=p,p=m),o.mulTo(p,i[h],s)}for(;f>=0&&!(r.data[f]&1<<t);)o.sqrTo(s,p),m=s,s=p,p=m,--t<0&&(t=this.DB-1,--f)}return o.revert(s)}function VY(r){var e=this.s<0?this.negate():this.clone(),t=r.s<0?r.negate():r.clone();if(e.compareTo(t)<0){var n=e;e=t,t=n}var s=e.getLowestSetBit(),o=t.getLowestSetBit();if(o<0)return e;for(s<o&&(o=s),o>0&&(e.rShiftTo(o,e),t.rShiftTo(o,t));e.signum()>0;)(s=e.getLowestSetBit())>0&&e.rShiftTo(s,e),(s=t.getLowestSetBit())>0&&t.rShiftTo(s,t),e.compareTo(t)>=0?(e.subTo(t,e),e.rShiftTo(1,e)):(t.subTo(e,t),t.rShiftTo(1,t));return o>0&&t.lShiftTo(o,t),t}function qY(r){if(r<=0)return 0;var e=this.DV%r,t=this.s<0?r-1:0;if(this.t>0)if(e==0)t=this.data[0]%r;else for(var n=this.t-1;n>=0;--n)t=(e*t+this.data[n])%r;return t}function HY(r){var e=r.isEven();if(this.isEven()&&e||r.signum()==0)return H.ZERO;for(var t=r.clone(),n=this.clone(),s=na(1),o=na(0),i=na(0),a=na(1);t.signum()!=0;){for(;t.isEven();)t.rShiftTo(1,t),e?((!s.isEven()||!o.isEven())&&(s.addTo(this,s),o.subTo(r,o)),s.rShiftTo(1,s)):o.isEven()||o.subTo(r,o),o.rShiftTo(1,o);for(;n.isEven();)n.rShiftTo(1,n),e?((!i.isEven()||!a.isEven())&&(i.addTo(this,i),a.subTo(r,a)),i.rShiftTo(1,i)):a.isEven()||a.subTo(r,a),a.rShiftTo(1,a);t.compareTo(n)>=0?(t.subTo(n,t),e&&s.subTo(i,s),o.subTo(a,o)):(n.subTo(t,n),e&&i.subTo(s,i),a.subTo(o,a))}if(n.compareTo(H.ONE)!=0)return H.ZERO;if(a.compareTo(r)>=0)return a.subtract(r);if(a.signum()<0)a.addTo(r,a);else return a;return a.signum()<0?a.add(r):a}var Ss=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509],zY=(1<<26)/Ss[Ss.length-1];function $Y(r){var e,t=this.abs();if(t.t==1&&t.data[0]<=Ss[Ss.length-1]){for(e=0;e<Ss.length;++e)if(t.data[0]==Ss[e])return!0;return!1}if(t.isEven())return!1;for(e=1;e<Ss.length;){for(var n=Ss[e],s=e+1;s<Ss.length&&n<zY;)n*=Ss[s++];for(n=t.modInt(n);e<s;)if(n%Ss[e++]==0)return!1}return t.millerRabin(r)}function GY(r){var e=this.subtract(H.ONE),t=e.getLowestSetBit();if(t<=0)return!1;for(var n=e.shiftRight(t),s=WY(),o,i=0;i<r;++i){do o=new H(this.bitLength(),s);while(o.compareTo(H.ONE)<=0||o.compareTo(e)>=0);var a=o.modPow(n,this);if(a.compareTo(H.ONE)!=0&&a.compareTo(e)!=0){for(var c=1;c++<t&&a.compareTo(e)!=0;)if(a=a.modPowInt(2,this),a.compareTo(H.ONE)==0)return!1;if(a.compareTo(e)!=0)return!1}}return!0}function WY(){return{nextBytes:function(r){for(var e=0;e<r.length;++e)r[e]=Math.floor(Math.random()*256)}}}H.prototype.chunkSize=YW;H.prototype.toRadix=QW;H.prototype.fromRadix=XW;H.prototype.fromNumber=JW;H.prototype.bitwiseTo=nY;H.prototype.changeBit=gY;H.prototype.addTo=vY;H.prototype.dMultiply=TY;H.prototype.dAddOffset=kY;H.prototype.multiplyLowerTo=BY;H.prototype.multiplyUpperTo=NY;H.prototype.modInt=qY;H.prototype.millerRabin=GY;H.prototype.clone=zW;H.prototype.intValue=$W;H.prototype.byteValue=GW;H.prototype.shortValue=WW;H.prototype.signum=jW;H.prototype.toByteArray=ZW;H.prototype.equals=eY;H.prototype.min=tY;H.prototype.max=rY;H.prototype.and=oY;H.prototype.or=iY;H.prototype.xor=aY;H.prototype.andNot=cY;H.prototype.not=lY;H.prototype.shiftLeft=uY;H.prototype.shiftRight=fY;H.prototype.getLowestSetBit=pY;H.prototype.bitCount=mY;H.prototype.testBit=yY;H.prototype.setBit=bY;H.prototype.clearBit=wY;H.prototype.flipBit=EY;H.prototype.add=xY;H.prototype.subtract=SY;H.prototype.multiply=_Y;H.prototype.divide=AY;H.prototype.remainder=RY;H.prototype.divideAndRemainder=IY;H.prototype.modPow=FY;H.prototype.modInverse=HY;H.prototype.pow=CY;H.prototype.gcd=VY;H.prototype.isProbablePrime=$Y});var wI=Y((o8e,bI)=>{var Js=Ge();Sc();Kt();var yI=bI.exports=Js.sha1=Js.sha1||{};Js.md.sha1=Js.md.algorithms.sha1=yI;yI.create=function(){gI||YY();var r=null,e=Js.util.createBuffer(),t=new Array(80),n={algorithm:"sha1",blockLength:64,digestLength:20,messageLength:0,fullMessageLength:null,messageLengthSize:8};return n.start=function(){n.messageLength=0,n.fullMessageLength=n.messageLength64=[];for(var s=n.messageLengthSize/4,o=0;o<s;++o)n.fullMessageLength.push(0);return e=Js.util.createBuffer(),r={h0:1732584193,h1:4023233417,h2:2562383102,h3:271733878,h4:3285377520},n},n.start(),n.update=function(s,o){o==="utf8"&&(s=Js.util.encodeUtf8(s));var i=s.length;n.messageLength+=i,i=[i/4294967296>>>0,i>>>0];for(var a=n.fullMessageLength.length-1;a>=0;--a)n.fullMessageLength[a]+=i[1],i[1]=i[0]+(n.fullMessageLength[a]/4294967296>>>0),n.fullMessageLength[a]=n.fullMessageLength[a]>>>0,i[0]=i[1]/4294967296>>>0;return e.putBytes(s),mI(r,t,e),(e.read>2048||e.length()===0)&&e.compact(),n},n.digest=function(){var s=Js.util.createBuffer();s.putBytes(e.bytes());var o=n.fullMessageLength[n.fullMessageLength.length-1]+n.messageLengthSize,i=o&n.blockLength-1;s.putBytes(Z8.substr(0,n.blockLength-i));for(var a,c,l=n.fullMessageLength[0]*8,u=0;u<n.fullMessageLength.length-1;++u)a=n.fullMessageLength[u+1]*8,c=a/4294967296>>>0,l+=c,s.putInt32(l>>>0),l=a>>>0;s.putInt32(l);var f={h0:r.h0,h1:r.h1,h2:r.h2,h3:r.h3,h4:r.h4};mI(f,t,s);var h=Js.util.createBuffer();return h.putInt32(f.h0),h.putInt32(f.h1),h.putInt32(f.h2),h.putInt32(f.h3),h.putInt32(f.h4),h},n};var Z8=null,gI=!1;function YY(){Z8="\x80",Z8+=Js.util.fillString("\0",64),gI=!0}function mI(r,e,t){for(var n,s,o,i,a,c,l,u,f=t.length();f>=64;){for(s=r.h0,o=r.h1,i=r.h2,a=r.h3,c=r.h4,u=0;u<16;++u)n=t.getInt32(),e[u]=n,l=a^o&(i^a),n=(s<<5|s>>>27)+l+c+1518500249+n,c=a,a=i,i=(o<<30|o>>>2)>>>0,o=s,s=n;for(;u<20;++u)n=e[u-3]^e[u-8]^e[u-14]^e[u-16],n=n<<1|n>>>31,e[u]=n,l=a^o&(i^a),n=(s<<5|s>>>27)+l+c+1518500249+n,c=a,a=i,i=(o<<30|o>>>2)>>>0,o=s,s=n;for(;u<32;++u)n=e[u-3]^e[u-8]^e[u-14]^e[u-16],n=n<<1|n>>>31,e[u]=n,l=o^i^a,n=(s<<5|s>>>27)+l+c+1859775393+n,c=a,a=i,i=(o<<30|o>>>2)>>>0,o=s,s=n;for(;u<40;++u)n=e[u-6]^e[u-16]^e[u-28]^e[u-32],n=n<<2|n>>>30,e[u]=n,l=o^i^a,n=(s<<5|s>>>27)+l+c+1859775393+n,c=a,a=i,i=(o<<30|o>>>2)>>>0,o=s,s=n;for(;u<60;++u)n=e[u-6]^e[u-16]^e[u-28]^e[u-32],n=n<<2|n>>>30,e[u]=n,l=o&i|a&(o^i),n=(s<<5|s>>>27)+l+c+2400959708+n,c=a,a=i,i=(o<<30|o>>>2)>>>0,o=s,s=n;for(;u<80;++u)n=e[u-6]^e[u-16]^e[u-28]^e[u-32],n=n<<2|n>>>30,e[u]=n,l=o^i^a,n=(s<<5|s>>>27)+l+c+3395469782+n,c=a,a=i,i=(o<<30|o>>>2)>>>0,o=s,s=n;r.h0=r.h0+s|0,r.h1=r.h1+o|0,r.h2=r.h2+i|0,r.h3=r.h3+a|0,r.h4=r.h4+c|0,f-=64}}});var xI=Y((i8e,vI)=>{var Zs=Ge();Kt();lp();wI();var EI=vI.exports=Zs.pkcs1=Zs.pkcs1||{};EI.encode_rsa_oaep=function(r,e,t){var n,s,o,i;typeof t=="string"?(n=t,s=arguments[3]||void 0,o=arguments[4]||void 0):t&&(n=t.label||void 0,s=t.seed||void 0,o=t.md||void 0,t.mgf1&&t.mgf1.md&&(i=t.mgf1.md)),o?o.start():o=Zs.md.sha1.create(),i||(i=o);var a=Math.ceil(r.n.bitLength()/8),c=a-2*o.digestLength-2;if(e.length>c){var l=new Error("RSAES-OAEP input message length is too long.");throw l.length=e.length,l.maxLength=c,l}n||(n=""),o.update(n,"raw");for(var u=o.digest(),f="",h=c-e.length,d=0;d<h;d++)f+="\0";var p=u.getBytes()+f+""+e;if(!s)s=Zs.random.getBytes(o.digestLength);else if(s.length!==o.digestLength){var l=new Error("Invalid RSAES-OAEP seed. The seed length must match the digest length.");throw l.seedLength=s.length,l.digestLength=o.digestLength,l}var m=P1(s,a-o.digestLength-1,i),y=Zs.util.xorBytes(p,m,p.length),b=P1(y,o.digestLength,i),w=Zs.util.xorBytes(s,b,s.length);return"\0"+w+y};EI.decode_rsa_oaep=function(r,e,t){var n,s,o;typeof t=="string"?(n=t,s=arguments[3]||void 0):t&&(n=t.label||void 0,s=t.md||void 0,t.mgf1&&t.mgf1.md&&(o=t.mgf1.md));var i=Math.ceil(r.n.bitLength()/8);if(e.length!==i){var y=new Error("RSAES-OAEP encoded message length is invalid.");throw y.length=e.length,y.expectedLength=i,y}if(s===void 0?s=Zs.md.sha1.create():s.start(),o||(o=s),i<2*s.digestLength+2)throw new Error("RSAES-OAEP key is too short for the hash function.");n||(n=""),s.update(n,"raw");for(var a=s.digest().getBytes(),c=e.charAt(0),l=e.substring(1,s.digestLength+1),u=e.substring(1+s.digestLength),f=P1(u,s.digestLength,o),h=Zs.util.xorBytes(l,f,l.length),d=P1(h,i-s.digestLength-1,o),p=Zs.util.xorBytes(u,d,u.length),m=p.substring(0,s.digestLength),y=c!=="\0",b=0;b<s.digestLength;++b)y|=a.charAt(b)!==m.charAt(b);for(var w=1,E=s.digestLength,x=s.digestLength;x<p.length;x++){var v=p.charCodeAt(x),S=v&1^1,A=w?65534:0;y|=v&A,w=w&S,E+=w}if(y||p.charCodeAt(E)!==1)throw new Error("Invalid RSAES-OAEP padding.");return p.substring(E+1)};function P1(r,e,t){t||(t=Zs.md.sha1.create());for(var n="",s=Math.ceil(e/t.digestLength),o=0;o<s;++o){var i=String.fromCharCode(o>>24&255,o>>16&255,o>>8&255,o&255);t.start(),t.update(r+i),n+=t.digest().getBytes()}return n.substring(0,e)}});var SI=Y((a8e,e5)=>{var sa=Ge();Kt();fp();lp();(function(){if(sa.prime){e5.exports=sa.prime;return}var r=e5.exports=sa.prime=sa.prime||{},e=sa.jsbn.BigInteger,t=[6,4,2,4,2,4,6,2],n=new e(null);n.fromInt(30);var s=function(f,h){return f|h};r.generateProbablePrime=function(f,h,d){typeof h=="function"&&(d=h,h={}),h=h||{};var p=h.algorithm||"PRIMEINC";typeof p=="string"&&(p={name:p}),p.options=p.options||{};var m=h.prng||sa.random,y={nextBytes:function(b){for(var w=m.getBytesSync(b.length),E=0;E<b.length;++E)b[E]=w.charCodeAt(E)}};if(p.name==="PRIMEINC")return o(f,y,p.options,d);throw new Error("Invalid prime generation algorithm: "+p.name)};function o(f,h,d,p){return"workers"in d?c(f,h,d,p):i(f,h,d,p)}function i(f,h,d,p){var m=l(f,h),y=0,b=u(m.bitLength());"millerRabinTests"in d&&(b=d.millerRabinTests);var w=10;"maxBlockTime"in d&&(w=d.maxBlockTime),a(m,f,h,y,b,w,p)}function a(f,h,d,p,m,y,b){var w=+new Date;do{if(f.bitLength()>h&&(f=l(h,d)),f.isProbablePrime(m))return b(null,f);f.dAddOffset(t[p++%8],0)}while(y<0||+new Date-w<y);sa.util.setImmediate(function(){a(f,h,d,p,m,y,b)})}function c(f,h,d,p){if(typeof Worker>"u")return i(f,h,d,p);var m=l(f,h),y=d.workers,b=d.workLoad||100,w=b*30/8,E=d.workerScript||"forge/prime.worker.js";if(y===-1)return sa.util.estimateCores(function(v,S){v&&(S=2),y=S-1,x()});x();function x(){y=Math.max(1,y);for(var v=[],S=0;S<y;++S)v[S]=new Worker(E);for(var A=y,S=0;S<y;++S)v[S].addEventListener("message",D);var _=!1;function D(K){if(!_){--A;var O=K.data;if(O.found){for(var F=0;F<v.length;++F)v[F].terminate();return _=!0,p(null,new e(O.prime,16))}m.bitLength()>f&&(m=l(f,h));var W=m.toString(16);K.target.postMessage({hex:W,workLoad:b}),m.dAddOffset(w,0)}}}}function l(f,h){var d=new e(f,h),p=f-1;return d.testBit(p)||d.bitwiseTo(e.ONE.shiftLeft(p),s,d),d.dAddOffset(31-d.mod(n).byteValue(),0),d}function u(f){return f<=100?27:f<=150?18:f<=200?15:f<=250?12:f<=300?9:f<=350?8:f<=400?7:f<=500?6:f<=600?5:f<=800?4:f<=1250?3:2}})()});var cu=Y((c8e,DI)=>{var be=Ge();xc();fp();v1();xI();SI();lp();Kt();typeof We>"u"&&(We=be.jsbn.BigInteger);var We,t5=be.util.isNodejs?A1():null,C=be.asn1,Vn=be.util;be.pki=be.pki||{};DI.exports=be.pki.rsa=be.rsa=be.rsa||{};var Ae=be.pki,jY=[6,4,2,4,2,4,6,2],QY={name:"PrivateKeyInfo",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"PrivateKeyInfo.version",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyVersion"},{name:"PrivateKeyInfo.privateKeyAlgorithm",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:C.Class.UNIVERSAL,type:C.Type.OID,constructed:!1,capture:"privateKeyOid"}]},{name:"PrivateKeyInfo",tagClass:C.Class.UNIVERSAL,type:C.Type.OCTETSTRING,constructed:!1,capture:"privateKey"}]},XY={name:"RSAPrivateKey",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"RSAPrivateKey.version",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyVersion"},{name:"RSAPrivateKey.modulus",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyModulus"},{name:"RSAPrivateKey.publicExponent",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyPublicExponent"},{name:"RSAPrivateKey.privateExponent",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyPrivateExponent"},{name:"RSAPrivateKey.prime1",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyPrime1"},{name:"RSAPrivateKey.prime2",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyPrime2"},{name:"RSAPrivateKey.exponent1",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyExponent1"},{name:"RSAPrivateKey.exponent2",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyExponent2"},{name:"RSAPrivateKey.coefficient",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyCoefficient"}]},JY={name:"RSAPublicKey",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"RSAPublicKey.modulus",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"publicKeyModulus"},{name:"RSAPublicKey.exponent",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"publicKeyExponent"}]},ZY=be.pki.rsa.publicKeyValidator={name:"SubjectPublicKeyInfo",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,captureAsn1:"subjectPublicKeyInfo",value:[{name:"SubjectPublicKeyInfo.AlgorithmIdentifier",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:C.Class.UNIVERSAL,type:C.Type.OID,constructed:!1,capture:"publicKeyOid"}]},{name:"SubjectPublicKeyInfo.subjectPublicKey",tagClass:C.Class.UNIVERSAL,type:C.Type.BITSTRING,constructed:!1,value:[{name:"SubjectPublicKeyInfo.subjectPublicKey.RSAPublicKey",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,optional:!0,captureAsn1:"rsaPublicKey"}]}]},ej={name:"DigestInfo",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"DigestInfo.DigestAlgorithm",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"DigestInfo.DigestAlgorithm.algorithmIdentifier",tagClass:C.Class.UNIVERSAL,type:C.Type.OID,constructed:!1,capture:"algorithmIdentifier"},{name:"DigestInfo.DigestAlgorithm.parameters",tagClass:C.Class.UNIVERSAL,type:C.Type.NULL,capture:"parameters",optional:!0,constructed:!1}]},{name:"DigestInfo.digest",tagClass:C.Class.UNIVERSAL,type:C.Type.OCTETSTRING,constructed:!1,capture:"digest"}]},tj=function(r){var e;if(r.algorithm in Ae.oids)e=Ae.oids[r.algorithm];else{var t=new Error("Unknown message digest algorithm.");throw t.algorithm=r.algorithm,t}var n=C.oidToDer(e).getBytes(),s=C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[]),o=C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[]);o.value.push(C.create(C.Class.UNIVERSAL,C.Type.OID,!1,n)),o.value.push(C.create(C.Class.UNIVERSAL,C.Type.NULL,!1,""));var i=C.create(C.Class.UNIVERSAL,C.Type.OCTETSTRING,!1,r.digest().getBytes());return s.value.push(o),s.value.push(i),C.toDer(s).getBytes()},TI=function(r,e,t){if(t)return r.modPow(e.e,e.n);if(!e.p||!e.q)return r.modPow(e.d,e.n);e.dP||(e.dP=e.d.mod(e.p.subtract(We.ONE))),e.dQ||(e.dQ=e.d.mod(e.q.subtract(We.ONE))),e.qInv||(e.qInv=e.q.modInverse(e.p));var n;do n=new We(be.util.bytesToHex(be.random.getBytes(e.n.bitLength()/8)),16);while(n.compareTo(e.n)>=0||!n.gcd(e.n).equals(We.ONE));r=r.multiply(n.modPow(e.e,e.n)).mod(e.n);for(var s=r.mod(e.p).modPow(e.dP,e.p),o=r.mod(e.q).modPow(e.dQ,e.q);s.compareTo(o)<0;)s=s.add(e.p);var i=s.subtract(o).multiply(e.qInv).mod(e.p).multiply(e.q).add(o);return i=i.multiply(n.modInverse(e.n)).mod(e.n),i};Ae.rsa.encrypt=function(r,e,t){var n=t,s,o=Math.ceil(e.n.bitLength()/8);t!==!1&&t!==!0?(n=t===2,s=kI(r,e,t)):(s=be.util.createBuffer(),s.putBytes(r));for(var i=new We(s.toHex(),16),a=TI(i,e,n),c=a.toString(16),l=be.util.createBuffer(),u=o-Math.ceil(c.length/2);u>0;)l.putByte(0),--u;return l.putBytes(be.util.hexToBytes(c)),l.getBytes()};Ae.rsa.decrypt=function(r,e,t,n){var s=Math.ceil(e.n.bitLength()/8);if(r.length!==s){var o=new Error("Encrypted message length is invalid.");throw o.length=r.length,o.expected=s,o}var i=new We(be.util.createBuffer(r).toHex(),16);if(i.compareTo(e.n)>=0)throw new Error("Encrypted message is invalid.");for(var a=TI(i,e,t),c=a.toString(16),l=be.util.createBuffer(),u=s-Math.ceil(c.length/2);u>0;)l.putByte(0),--u;return l.putBytes(be.util.hexToBytes(c)),n!==!1?C1(l.getBytes(),e,t):l.getBytes()};Ae.rsa.createKeyPairGenerationState=function(r,e,t){typeof r=="string"&&(r=parseInt(r,10)),r=r||2048,t=t||{};var n=t.prng||be.random,s={nextBytes:function(a){for(var c=n.getBytesSync(a.length),l=0;l<a.length;++l)a[l]=c.charCodeAt(l)}},o=t.algorithm||"PRIMEINC",i;if(o==="PRIMEINC")i={algorithm:o,state:0,bits:r,rng:s,eInt:e||65537,e:new We(null),p:null,q:null,qBits:r>>1,pBits:r-(r>>1),pqState:0,num:null,keys:null},i.e.fromInt(i.eInt);else throw new Error("Invalid key generation algorithm: "+o);return i};Ae.rsa.stepKeyPairGenerationState=function(r,e){"algorithm"in r||(r.algorithm="PRIMEINC");var t=new We(null);t.fromInt(30);for(var n=0,s=function(f,h){return f|h},o=+new Date,i,a=0;r.keys===null&&(e<=0||a<e);){if(r.state===0){var c=r.p===null?r.pBits:r.qBits,l=c-1;r.pqState===0?(r.num=new We(c,r.rng),r.num.testBit(l)||r.num.bitwiseTo(We.ONE.shiftLeft(l),s,r.num),r.num.dAddOffset(31-r.num.mod(t).byteValue(),0),n=0,++r.pqState):r.pqState===1?r.num.bitLength()>c?r.pqState=0:r.num.isProbablePrime(nj(r.num.bitLength()))?++r.pqState:r.num.dAddOffset(jY[n++%8],0):r.pqState===2?r.pqState=r.num.subtract(We.ONE).gcd(r.e).compareTo(We.ONE)===0?3:0:r.pqState===3&&(r.pqState=0,r.p===null?r.p=r.num:r.q=r.num,r.p!==null&&r.q!==null&&++r.state,r.num=null)}else if(r.state===1)r.p.compareTo(r.q)<0&&(r.num=r.p,r.p=r.q,r.q=r.num),++r.state;else if(r.state===2)r.p1=r.p.subtract(We.ONE),r.q1=r.q.subtract(We.ONE),r.phi=r.p1.multiply(r.q1),++r.state;else if(r.state===3)r.phi.gcd(r.e).compareTo(We.ONE)===0?++r.state:(r.p=null,r.q=null,r.state=0);else if(r.state===4)r.n=r.p.multiply(r.q),r.n.bitLength()===r.bits?++r.state:(r.q=null,r.state=0);else if(r.state===5){var u=r.e.modInverse(r.phi);r.keys={privateKey:Ae.rsa.setPrivateKey(r.n,r.e,u,r.p,r.q,u.mod(r.p1),u.mod(r.q1),r.q.modInverse(r.p)),publicKey:Ae.rsa.setPublicKey(r.n,r.e)}}i=+new Date,a+=i-o,o=i}return r.keys!==null};Ae.rsa.generateKeyPair=function(r,e,t,n){if(arguments.length===1?typeof r=="object"?(t=r,r=void 0):typeof r=="function"&&(n=r,r=void 0):arguments.length===2?typeof r=="number"?typeof e=="function"?(n=e,e=void 0):typeof e!="number"&&(t=e,e=void 0):(t=r,n=e,r=void 0,e=void 0):arguments.length===3&&(typeof e=="number"?typeof t=="function"&&(n=t,t=void 0):(n=t,t=e,e=void 0)),t=t||{},r===void 0&&(r=t.bits||2048),e===void 0&&(e=t.e||65537),!be.options.usePureJavaScript&&!t.prng&&r>=256&&r<=16384&&(e===65537||e===3)){if(n){if(_I("generateKeyPair"))return t5.generateKeyPair("rsa",{modulusLength:r,publicExponent:e,publicKeyEncoding:{type:"spki",format:"pem"},privateKeyEncoding:{type:"pkcs8",format:"pem"}},function(a,c,l){if(a)return n(a);n(null,{privateKey:Ae.privateKeyFromPem(l),publicKey:Ae.publicKeyFromPem(c)})});if(AI("generateKey")&&AI("exportKey"))return Vn.globalScope.crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:II(e),hash:{name:"SHA-256"}},!0,["sign","verify"]).then(function(a){return Vn.globalScope.crypto.subtle.exportKey("pkcs8",a.privateKey)}).then(void 0,function(a){n(a)}).then(function(a){if(a){var c=Ae.privateKeyFromAsn1(C.fromDer(be.util.createBuffer(a)));n(null,{privateKey:c,publicKey:Ae.setRsaPublicKey(c.n,c.e)})}});if(RI("generateKey")&&RI("exportKey")){var s=Vn.globalScope.msCrypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:II(e),hash:{name:"SHA-256"}},!0,["sign","verify"]);s.oncomplete=function(a){var c=a.target.result,l=Vn.globalScope.msCrypto.subtle.exportKey("pkcs8",c.privateKey);l.oncomplete=function(u){var f=u.target.result,h=Ae.privateKeyFromAsn1(C.fromDer(be.util.createBuffer(f)));n(null,{privateKey:h,publicKey:Ae.setRsaPublicKey(h.n,h.e)})},l.onerror=function(u){n(u)}},s.onerror=function(a){n(a)};return}}else if(_I("generateKeyPairSync")){var o=t5.generateKeyPairSync("rsa",{modulusLength:r,publicExponent:e,publicKeyEncoding:{type:"spki",format:"pem"},privateKeyEncoding:{type:"pkcs8",format:"pem"}});return{privateKey:Ae.privateKeyFromPem(o.privateKey),publicKey:Ae.publicKeyFromPem(o.publicKey)}}}var i=Ae.rsa.createKeyPairGenerationState(r,e,t);if(!n)return Ae.rsa.stepKeyPairGenerationState(i,0),i.keys;rj(i,t,n)};Ae.setRsaPublicKey=Ae.rsa.setPublicKey=function(r,e){var t={n:r,e};return t.encrypt=function(n,s,o){if(typeof s=="string"?s=s.toUpperCase():s===void 0&&(s="RSAES-PKCS1-V1_5"),s==="RSAES-PKCS1-V1_5")s={encode:function(a,c,l){return kI(a,c,2).getBytes()}};else if(s==="RSA-OAEP"||s==="RSAES-OAEP")s={encode:function(a,c){return be.pkcs1.encode_rsa_oaep(c,a,o)}};else if(["RAW","NONE","NULL",null].indexOf(s)!==-1)s={encode:function(a){return a}};else if(typeof s=="string")throw new Error('Unsupported encryption scheme: "'+s+'".');var i=s.encode(n,t,!0);return Ae.rsa.encrypt(i,t,!0)},t.verify=function(n,s,o,i){typeof o=="string"?o=o.toUpperCase():o===void 0&&(o="RSASSA-PKCS1-V1_5"),i===void 0&&(i={_parseAllDigestBytes:!0}),"_parseAllDigestBytes"in i||(i._parseAllDigestBytes=!0),o==="RSASSA-PKCS1-V1_5"?o={verify:function(c,l){l=C1(l,t,!0);var u=C.fromDer(l,{parseAllBytes:i._parseAllDigestBytes}),f={},h=[];if(!C.validate(u,ej,f,h)){var d=new Error("ASN.1 object does not contain a valid RSASSA-PKCS1-v1_5 DigestInfo value.");throw d.errors=h,d}var p=C.derToOid(f.algorithmIdentifier);if(!(p===be.oids.md2||p===be.oids.md5||p===be.oids.sha1||p===be.oids.sha224||p===be.oids.sha256||p===be.oids.sha384||p===be.oids.sha512||p===be.oids["sha512-224"]||p===be.oids["sha512-256"])){var d=new Error("Unknown RSASSA-PKCS1-v1_5 DigestAlgorithm identifier.");throw d.oid=p,d}if((p===be.oids.md2||p===be.oids.md5)&&!("parameters"in f))throw new Error("ASN.1 object does not contain a valid RSASSA-PKCS1-v1_5 DigestInfo value. Missing algorithm identifer NULL parameters.");return c===f.digest}}:(o==="NONE"||o==="NULL"||o===null)&&(o={verify:function(c,l){return l=C1(l,t,!0),c===l}});var a=Ae.rsa.decrypt(s,t,!0,!1);return o.verify(n,a,t.n.bitLength())},t};Ae.setRsaPrivateKey=Ae.rsa.setPrivateKey=function(r,e,t,n,s,o,i,a){var c={n:r,e,d:t,p:n,q:s,dP:o,dQ:i,qInv:a};return c.decrypt=function(l,u,f){typeof u=="string"?u=u.toUpperCase():u===void 0&&(u="RSAES-PKCS1-V1_5");var h=Ae.rsa.decrypt(l,c,!1,!1);if(u==="RSAES-PKCS1-V1_5")u={decode:C1};else if(u==="RSA-OAEP"||u==="RSAES-OAEP")u={decode:function(d,p){return be.pkcs1.decode_rsa_oaep(p,d,f)}};else if(["RAW","NONE","NULL",null].indexOf(u)!==-1)u={decode:function(d){return d}};else throw new Error('Unsupported encryption scheme: "'+u+'".');return u.decode(h,c,!1)},c.sign=function(l,u){var f=!1;typeof u=="string"&&(u=u.toUpperCase()),u===void 0||u==="RSASSA-PKCS1-V1_5"?(u={encode:tj},f=1):(u==="NONE"||u==="NULL"||u===null)&&(u={encode:function(){return l}},f=1);var h=u.encode(l,c.n.bitLength());return Ae.rsa.encrypt(h,c,f)},c};Ae.wrapRsaPrivateKey=function(r){return C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,C.integerToDer(0).getBytes()),C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.OID,!1,C.oidToDer(Ae.oids.rsaEncryption).getBytes()),C.create(C.Class.UNIVERSAL,C.Type.NULL,!1,"")]),C.create(C.Class.UNIVERSAL,C.Type.OCTETSTRING,!1,C.toDer(r).getBytes())])};Ae.privateKeyFromAsn1=function(r){var e={},t=[];if(C.validate(r,QY,e,t)&&(r=C.fromDer(be.util.createBuffer(e.privateKey))),e={},t=[],!C.validate(r,XY,e,t)){var n=new Error("Cannot read private key. ASN.1 object does not contain an RSAPrivateKey.");throw n.errors=t,n}var s,o,i,a,c,l,u,f;return s=be.util.createBuffer(e.privateKeyModulus).toHex(),o=be.util.createBuffer(e.privateKeyPublicExponent).toHex(),i=be.util.createBuffer(e.privateKeyPrivateExponent).toHex(),a=be.util.createBuffer(e.privateKeyPrime1).toHex(),c=be.util.createBuffer(e.privateKeyPrime2).toHex(),l=be.util.createBuffer(e.privateKeyExponent1).toHex(),u=be.util.createBuffer(e.privateKeyExponent2).toHex(),f=be.util.createBuffer(e.privateKeyCoefficient).toHex(),Ae.setRsaPrivateKey(new We(s,16),new We(o,16),new We(i,16),new We(a,16),new We(c,16),new We(l,16),new We(u,16),new We(f,16))};Ae.privateKeyToAsn1=Ae.privateKeyToRSAPrivateKey=function(r){return C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,C.integerToDer(0).getBytes()),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,eo(r.n)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,eo(r.e)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,eo(r.d)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,eo(r.p)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,eo(r.q)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,eo(r.dP)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,eo(r.dQ)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,eo(r.qInv))])};Ae.publicKeyFromAsn1=function(r){var e={},t=[];if(C.validate(r,ZY,e,t)){var n=C.derToOid(e.publicKeyOid);if(n!==Ae.oids.rsaEncryption){var s=new Error("Cannot read public key. Unknown OID.");throw s.oid=n,s}r=e.rsaPublicKey}if(t=[],!C.validate(r,JY,e,t)){var s=new Error("Cannot read public key. ASN.1 object does not contain an RSAPublicKey.");throw s.errors=t,s}var o=be.util.createBuffer(e.publicKeyModulus).toHex(),i=be.util.createBuffer(e.publicKeyExponent).toHex();return Ae.setRsaPublicKey(new We(o,16),new We(i,16))};Ae.publicKeyToAsn1=Ae.publicKeyToSubjectPublicKeyInfo=function(r){return C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.OID,!1,C.oidToDer(Ae.oids.rsaEncryption).getBytes()),C.create(C.Class.UNIVERSAL,C.Type.NULL,!1,"")]),C.create(C.Class.UNIVERSAL,C.Type.BITSTRING,!1,[Ae.publicKeyToRSAPublicKey(r)])])};Ae.publicKeyToRSAPublicKey=function(r){return C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,eo(r.n)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,eo(r.e))])};function kI(r,e,t){var n=be.util.createBuffer(),s=Math.ceil(e.n.bitLength()/8);if(r.length>s-11){var o=new Error("Message is too long for PKCS#1 v1.5 padding.");throw o.length=r.length,o.max=s-11,o}n.putByte(0),n.putByte(t);var i=s-3-r.length,a;if(t===0||t===1){a=t===0?0:255;for(var c=0;c<i;++c)n.putByte(a)}else for(;i>0;){for(var l=0,u=be.random.getBytes(i),c=0;c<i;++c)a=u.charCodeAt(c),a===0?++l:n.putByte(a);i=l}return n.putByte(0),n.putBytes(r),n}function C1(r,e,t,n){var s=Math.ceil(e.n.bitLength()/8),o=be.util.createBuffer(r),i=o.getByte(),a=o.getByte();if(i!==0||t&&a!==0&&a!==1||!t&&a!=2||t&&a===0&&typeof n>"u")throw new Error("Encryption block is invalid.");var c=0;if(a===0){c=s-3-n;for(var l=0;l<c;++l)if(o.getByte()!==0)throw new Error("Encryption block is invalid.")}else if(a===1)for(c=0;o.length()>1;){if(o.getByte()!==255){--o.read;break}++c}else if(a===2)for(c=0;o.length()>1;){if(o.getByte()===0){--o.read;break}++c}var u=o.getByte();if(u!==0||c!==s-3-o.length())throw new Error("Encryption block is invalid.");return o.getBytes()}function rj(r,e,t){typeof e=="function"&&(t=e,e={}),e=e||{};var n={algorithm:{name:e.algorithm||"PRIMEINC",options:{workers:e.workers||2,workLoad:e.workLoad||100,workerScript:e.workerScript}}};"prng"in e&&(n.prng=e.prng),s();function s(){o(r.pBits,function(a,c){if(a)return t(a);if(r.p=c,r.q!==null)return i(a,r.q);o(r.qBits,i)})}function o(a,c){be.prime.generateProbablePrime(a,n,c)}function i(a,c){if(a)return t(a);if(r.q=c,r.p.compareTo(r.q)<0){var l=r.p;r.p=r.q,r.q=l}if(r.p.subtract(We.ONE).gcd(r.e).compareTo(We.ONE)!==0){r.p=null,s();return}if(r.q.subtract(We.ONE).gcd(r.e).compareTo(We.ONE)!==0){r.q=null,o(r.qBits,i);return}if(r.p1=r.p.subtract(We.ONE),r.q1=r.q.subtract(We.ONE),r.phi=r.p1.multiply(r.q1),r.phi.gcd(r.e).compareTo(We.ONE)!==0){r.p=r.q=null,s();return}if(r.n=r.p.multiply(r.q),r.n.bitLength()!==r.bits){r.q=null,o(r.qBits,i);return}var u=r.e.modInverse(r.phi);r.keys={privateKey:Ae.rsa.setPrivateKey(r.n,r.e,u,r.p,r.q,u.mod(r.p1),u.mod(r.q1),r.q.modInverse(r.p)),publicKey:Ae.rsa.setPublicKey(r.n,r.e)},t(null,r.keys)}}function eo(r){var e=r.toString(16);e[0]>="8"&&(e="00"+e);var t=be.util.hexToBytes(e);return t.length>1&&(t.charCodeAt(0)===0&&!(t.charCodeAt(1)&128)||t.charCodeAt(0)===255&&(t.charCodeAt(1)&128)===128)?t.substr(1):t}function nj(r){return r<=100?27:r<=150?18:r<=200?15:r<=250?12:r<=300?9:r<=350?8:r<=400?7:r<=500?6:r<=600?5:r<=800?4:r<=1250?3:2}function _I(r){return be.util.isNodejs&&typeof t5[r]=="function"}function AI(r){return typeof Vn.globalScope<"u"&&typeof Vn.globalScope.crypto=="object"&&typeof Vn.globalScope.crypto.subtle=="object"&&typeof Vn.globalScope.crypto.subtle[r]=="function"}function RI(r){return typeof Vn.globalScope<"u"&&typeof Vn.globalScope.msCrypto=="object"&&typeof Vn.globalScope.msCrypto.subtle=="object"&&typeof Vn.globalScope.msCrypto.subtle[r]=="function"}function II(r){for(var e=be.util.hexToBytes(r.toString(16)),t=new Uint8Array(e.length),n=0;n<e.length;++n)t[n]=e.charCodeAt(n);return t}});var r5=Y((l8e,LI)=>{var ie=Ge();E1();xc();VR();Sc();v1();G8();YR();lp();iI();cu();Kt();typeof PI>"u"&&(PI=ie.jsbn.BigInteger);var PI,M=ie.asn1,Be=ie.pki=ie.pki||{};LI.exports=Be.pbe=ie.pbe=ie.pbe||{};var Rc=Be.oids,sj={name:"EncryptedPrivateKeyInfo",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedPrivateKeyInfo.encryptionAlgorithm",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:M.Class.UNIVERSAL,type:M.Type.OID,constructed:!1,capture:"encryptionOid"},{name:"AlgorithmIdentifier.parameters",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,captureAsn1:"encryptionParams"}]},{name:"EncryptedPrivateKeyInfo.encryptedData",tagClass:M.Class.UNIVERSAL,type:M.Type.OCTETSTRING,constructed:!1,capture:"encryptedData"}]},oj={name:"PBES2Algorithms",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.keyDerivationFunc",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.keyDerivationFunc.oid",tagClass:M.Class.UNIVERSAL,type:M.Type.OID,constructed:!1,capture:"kdfOid"},{name:"PBES2Algorithms.params",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.params.salt",tagClass:M.Class.UNIVERSAL,type:M.Type.OCTETSTRING,constructed:!1,capture:"kdfSalt"},{name:"PBES2Algorithms.params.iterationCount",tagClass:M.Class.UNIVERSAL,type:M.Type.INTEGER,constructed:!1,capture:"kdfIterationCount"},{name:"PBES2Algorithms.params.keyLength",tagClass:M.Class.UNIVERSAL,type:M.Type.INTEGER,constructed:!1,optional:!0,capture:"keyLength"},{name:"PBES2Algorithms.params.prf",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,optional:!0,value:[{name:"PBES2Algorithms.params.prf.algorithm",tagClass:M.Class.UNIVERSAL,type:M.Type.OID,constructed:!1,capture:"prfOid"}]}]}]},{name:"PBES2Algorithms.encryptionScheme",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.encryptionScheme.oid",tagClass:M.Class.UNIVERSAL,type:M.Type.OID,constructed:!1,capture:"encOid"},{name:"PBES2Algorithms.encryptionScheme.iv",tagClass:M.Class.UNIVERSAL,type:M.Type.OCTETSTRING,constructed:!1,capture:"encIv"}]}]},ij={name:"pkcs-12PbeParams",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"pkcs-12PbeParams.salt",tagClass:M.Class.UNIVERSAL,type:M.Type.OCTETSTRING,constructed:!1,capture:"salt"},{name:"pkcs-12PbeParams.iterations",tagClass:M.Class.UNIVERSAL,type:M.Type.INTEGER,constructed:!1,capture:"iterations"}]};Be.encryptPrivateKeyInfo=function(r,e,t){t=t||{},t.saltSize=t.saltSize||8,t.count=t.count||2048,t.algorithm=t.algorithm||"aes128",t.prfAlgorithm=t.prfAlgorithm||"sha1";var n=ie.random.getBytesSync(t.saltSize),s=t.count,o=M.integerToDer(s),i,a,c;if(t.algorithm.indexOf("aes")===0||t.algorithm==="des"){var l,u,f;switch(t.algorithm){case"aes128":i=16,l=16,u=Rc["aes128-CBC"],f=ie.aes.createEncryptionCipher;break;case"aes192":i=24,l=16,u=Rc["aes192-CBC"],f=ie.aes.createEncryptionCipher;break;case"aes256":i=32,l=16,u=Rc["aes256-CBC"],f=ie.aes.createEncryptionCipher;break;case"des":i=8,l=8,u=Rc.desCBC,f=ie.des.createEncryptionCipher;break;default:var h=new Error("Cannot encrypt private key. Unknown encryption algorithm.");throw h.algorithm=t.algorithm,h}var d="hmacWith"+t.prfAlgorithm.toUpperCase(),p=NI(d),m=ie.pkcs5.pbkdf2(e,n,s,i,p),y=ie.random.getBytesSync(l),b=f(m);b.start(y),b.update(M.toDer(r)),b.finish(),c=b.output.getBytes();var w=aj(n,o,i,d);a=M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OID,!1,M.oidToDer(Rc.pkcs5PBES2).getBytes()),M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OID,!1,M.oidToDer(Rc.pkcs5PBKDF2).getBytes()),w]),M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OID,!1,M.oidToDer(u).getBytes()),M.create(M.Class.UNIVERSAL,M.Type.OCTETSTRING,!1,y)])])])}else if(t.algorithm==="3des"){i=24;var E=new ie.util.ByteBuffer(n),m=Be.pbe.generatePkcs12Key(e,E,1,s,i),y=Be.pbe.generatePkcs12Key(e,E,2,s,i),b=ie.des.createEncryptionCipher(m);b.start(y),b.update(M.toDer(r)),b.finish(),c=b.output.getBytes(),a=M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OID,!1,M.oidToDer(Rc["pbeWithSHAAnd3-KeyTripleDES-CBC"]).getBytes()),M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OCTETSTRING,!1,n),M.create(M.Class.UNIVERSAL,M.Type.INTEGER,!1,o.getBytes())])])}else{var h=new Error("Cannot encrypt private key. Unknown encryption algorithm.");throw h.algorithm=t.algorithm,h}var x=M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[a,M.create(M.Class.UNIVERSAL,M.Type.OCTETSTRING,!1,c)]);return x};Be.decryptPrivateKeyInfo=function(r,e){var t=null,n={},s=[];if(!M.validate(r,sj,n,s)){var o=new Error("Cannot read encrypted private key. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw o.errors=s,o}var i=M.derToOid(n.encryptionOid),a=Be.pbe.getCipher(i,n.encryptionParams,e),c=ie.util.createBuffer(n.encryptedData);return a.update(c),a.finish()&&(t=M.fromDer(a.output)),t};Be.encryptedPrivateKeyToPem=function(r,e){var t={type:"ENCRYPTED PRIVATE KEY",body:M.toDer(r).getBytes()};return ie.pem.encode(t,{maxline:e})};Be.encryptedPrivateKeyFromPem=function(r){var e=ie.pem.decode(r)[0];if(e.type!=="ENCRYPTED PRIVATE KEY"){var t=new Error('Could not convert encrypted private key from PEM; PEM header type is "ENCRYPTED PRIVATE KEY".');throw t.headerType=e.type,t}if(e.procType&&e.procType.type==="ENCRYPTED")throw new Error("Could not convert encrypted private key from PEM; PEM is encrypted.");return M.fromDer(e.body)};Be.encryptRsaPrivateKey=function(r,e,t){if(t=t||{},!t.legacy){var n=Be.wrapRsaPrivateKey(Be.privateKeyToAsn1(r));return n=Be.encryptPrivateKeyInfo(n,e,t),Be.encryptedPrivateKeyToPem(n)}var s,o,i,a;switch(t.algorithm){case"aes128":s="AES-128-CBC",i=16,o=ie.random.getBytesSync(16),a=ie.aes.createEncryptionCipher;break;case"aes192":s="AES-192-CBC",i=24,o=ie.random.getBytesSync(16),a=ie.aes.createEncryptionCipher;break;case"aes256":s="AES-256-CBC",i=32,o=ie.random.getBytesSync(16),a=ie.aes.createEncryptionCipher;break;case"3des":s="DES-EDE3-CBC",i=24,o=ie.random.getBytesSync(8),a=ie.des.createEncryptionCipher;break;case"des":s="DES-CBC",i=8,o=ie.random.getBytesSync(8),a=ie.des.createEncryptionCipher;break;default:var c=new Error('Could not encrypt RSA private key; unsupported encryption algorithm "'+t.algorithm+'".');throw c.algorithm=t.algorithm,c}var l=ie.pbe.opensslDeriveBytes(e,o.substr(0,8),i),u=a(l);u.start(o),u.update(M.toDer(Be.privateKeyToAsn1(r))),u.finish();var f={type:"RSA PRIVATE KEY",procType:{version:"4",type:"ENCRYPTED"},dekInfo:{algorithm:s,parameters:ie.util.bytesToHex(o).toUpperCase()},body:u.output.getBytes()};return ie.pem.encode(f)};Be.decryptRsaPrivateKey=function(r,e){var t=null,n=ie.pem.decode(r)[0];if(n.type!=="ENCRYPTED PRIVATE KEY"&&n.type!=="PRIVATE KEY"&&n.type!=="RSA PRIVATE KEY"){var s=new Error('Could not convert private key from PEM; PEM header type is not "ENCRYPTED PRIVATE KEY", "PRIVATE KEY", or "RSA PRIVATE KEY".');throw s.headerType=s,s}if(n.procType&&n.procType.type==="ENCRYPTED"){var o,i;switch(n.dekInfo.algorithm){case"DES-CBC":o=8,i=ie.des.createDecryptionCipher;break;case"DES-EDE3-CBC":o=24,i=ie.des.createDecryptionCipher;break;case"AES-128-CBC":o=16,i=ie.aes.createDecryptionCipher;break;case"AES-192-CBC":o=24,i=ie.aes.createDecryptionCipher;break;case"AES-256-CBC":o=32,i=ie.aes.createDecryptionCipher;break;case"RC2-40-CBC":o=5,i=function(f){return ie.rc2.createDecryptionCipher(f,40)};break;case"RC2-64-CBC":o=8,i=function(f){return ie.rc2.createDecryptionCipher(f,64)};break;case"RC2-128-CBC":o=16,i=function(f){return ie.rc2.createDecryptionCipher(f,128)};break;default:var s=new Error('Could not decrypt private key; unsupported encryption algorithm "'+n.dekInfo.algorithm+'".');throw s.algorithm=n.dekInfo.algorithm,s}var a=ie.util.hexToBytes(n.dekInfo.parameters),c=ie.pbe.opensslDeriveBytes(e,a.substr(0,8),o),l=i(c);if(l.start(a),l.update(ie.util.createBuffer(n.body)),l.finish())t=l.output.getBytes();else return t}else t=n.body;return n.type==="ENCRYPTED PRIVATE KEY"?t=Be.decryptPrivateKeyInfo(M.fromDer(t),e):t=M.fromDer(t),t!==null&&(t=Be.privateKeyFromAsn1(t)),t};Be.pbe.generatePkcs12Key=function(r,e,t,n,s,o){var i,a;if(typeof o>"u"||o===null){if(!("sha1"in ie.md))throw new Error('"sha1" hash algorithm unavailable.');o=ie.md.sha1.create()}var c=o.digestLength,l=o.blockLength,u=new ie.util.ByteBuffer,f=new ie.util.ByteBuffer;if(r!=null){for(a=0;a<r.length;a++)f.putInt16(r.charCodeAt(a));f.putInt16(0)}var h=f.length(),d=e.length(),p=new ie.util.ByteBuffer;p.fillWithByte(t,l);var m=l*Math.ceil(d/l),y=new ie.util.ByteBuffer;for(a=0;a<m;a++)y.putByte(e.at(a%d));var b=l*Math.ceil(h/l),w=new ie.util.ByteBuffer;for(a=0;a<b;a++)w.putByte(f.at(a%h));var E=y;E.putBuffer(w);for(var x=Math.ceil(s/c),v=1;v<=x;v++){var S=new ie.util.ByteBuffer;S.putBytes(p.bytes()),S.putBytes(E.bytes());for(var A=0;A<n;A++)o.start(),o.update(S.getBytes()),S=o.digest();var _=new ie.util.ByteBuffer;for(a=0;a<l;a++)_.putByte(S.at(a%c));var D=Math.ceil(d/l)+Math.ceil(h/l),K=new ie.util.ByteBuffer;for(i=0;i<D;i++){var O=new ie.util.ByteBuffer(E.getBytes(l)),F=511;for(a=_.length()-1;a>=0;a--)F=F>>8,F+=_.at(a)+O.at(a),O.setAt(a,F&255);K.putBuffer(O)}E=K,u.putBuffer(S)}return u.truncate(u.length()-s),u};Be.pbe.getCipher=function(r,e,t){switch(r){case Be.oids.pkcs5PBES2:return Be.pbe.getCipherForPBES2(r,e,t);case Be.oids["pbeWithSHAAnd3-KeyTripleDES-CBC"]:case Be.oids["pbewithSHAAnd40BitRC2-CBC"]:return Be.pbe.getCipherForPKCS12PBE(r,e,t);default:var n=new Error("Cannot read encrypted PBE data block. Unsupported OID.");throw n.oid=r,n.supportedOids=["pkcs5PBES2","pbeWithSHAAnd3-KeyTripleDES-CBC","pbewithSHAAnd40BitRC2-CBC"],n}};Be.pbe.getCipherForPBES2=function(r,e,t){var n={},s=[];if(!M.validate(e,oj,n,s)){var o=new Error("Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw o.errors=s,o}if(r=M.derToOid(n.kdfOid),r!==Be.oids.pkcs5PBKDF2){var o=new Error("Cannot read encrypted private key. Unsupported key derivation function OID.");throw o.oid=r,o.supportedOids=["pkcs5PBKDF2"],o}if(r=M.derToOid(n.encOid),r!==Be.oids["aes128-CBC"]&&r!==Be.oids["aes192-CBC"]&&r!==Be.oids["aes256-CBC"]&&r!==Be.oids["des-EDE3-CBC"]&&r!==Be.oids.desCBC){var o=new Error("Cannot read encrypted private key. Unsupported encryption scheme OID.");throw o.oid=r,o.supportedOids=["aes128-CBC","aes192-CBC","aes256-CBC","des-EDE3-CBC","desCBC"],o}var i=n.kdfSalt,a=ie.util.createBuffer(n.kdfIterationCount);a=a.getInt(a.length()<<3);var c,l;switch(Be.oids[r]){case"aes128-CBC":c=16,l=ie.aes.createDecryptionCipher;break;case"aes192-CBC":c=24,l=ie.aes.createDecryptionCipher;break;case"aes256-CBC":c=32,l=ie.aes.createDecryptionCipher;break;case"des-EDE3-CBC":c=24,l=ie.des.createDecryptionCipher;break;case"desCBC":c=8,l=ie.des.createDecryptionCipher;break}var u=BI(n.prfOid),f=ie.pkcs5.pbkdf2(t,i,a,c,u),h=n.encIv,d=l(f);return d.start(h),d};Be.pbe.getCipherForPKCS12PBE=function(r,e,t){var n={},s=[];if(!M.validate(e,ij,n,s)){var o=new Error("Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw o.errors=s,o}var i=ie.util.createBuffer(n.salt),a=ie.util.createBuffer(n.iterations);a=a.getInt(a.length()<<3);var c,l,u;switch(r){case Be.oids["pbeWithSHAAnd3-KeyTripleDES-CBC"]:c=24,l=8,u=ie.des.startDecrypting;break;case Be.oids["pbewithSHAAnd40BitRC2-CBC"]:c=5,l=8,u=function(m,y){var b=ie.rc2.createDecryptionCipher(m,40);return b.start(y,null),b};break;default:var o=new Error("Cannot read PKCS #12 PBE data block. Unsupported OID.");throw o.oid=r,o}var f=BI(n.prfOid),h=Be.pbe.generatePkcs12Key(t,i,1,a,c,f);f.start();var d=Be.pbe.generatePkcs12Key(t,i,2,a,l,f);return u(h,d)};Be.pbe.opensslDeriveBytes=function(r,e,t,n){if(typeof n>"u"||n===null){if(!("md5"in ie.md))throw new Error('"md5" hash algorithm unavailable.');n=ie.md.md5.create()}e===null&&(e="");for(var s=[CI(n,r+e)],o=16,i=1;o<t;++i,o+=16)s.push(CI(n,s[i-1]+r+e));return s.join("").substr(0,t)};function CI(r,e){return r.start().update(e).digest().getBytes()}function BI(r){var e;if(!r)e="hmacWithSHA1";else if(e=Be.oids[M.derToOid(r)],!e){var t=new Error("Unsupported PRF OID.");throw t.oid=r,t.supported=["hmacWithSHA1","hmacWithSHA224","hmacWithSHA256","hmacWithSHA384","hmacWithSHA512"],t}return NI(e)}function NI(r){var e=ie.md;switch(r){case"hmacWithSHA224":e=ie.md.sha512;case"hmacWithSHA1":case"hmacWithSHA256":case"hmacWithSHA384":case"hmacWithSHA512":r=r.substr(8).toLowerCase();break;default:var t=new Error("Unsupported PRF algorithm.");throw t.algorithm=r,t.supported=["hmacWithSHA1","hmacWithSHA224","hmacWithSHA256","hmacWithSHA384","hmacWithSHA512"],t}if(!e||!(r in e))throw new Error("Unknown hash algorithm: "+r);return e[r].create()}function aj(r,e,t,n){var s=M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OCTETSTRING,!1,r),M.create(M.Class.UNIVERSAL,M.Type.INTEGER,!1,e.getBytes())]);return n!=="hmacWithSHA1"&&s.value.push(M.create(M.Class.UNIVERSAL,M.Type.INTEGER,!1,ie.util.hexToBytes(t.toString(16))),M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OID,!1,M.oidToDer(Be.oids[n]).getBytes()),M.create(M.Class.UNIVERSAL,M.Type.NULL,!1,"")])),s}});var A5=Y((O5e,yT)=>{var Et=Ge();Sc();Kt();var bp=yT.exports=Et.sha512=Et.sha512||{};Et.md.sha512=Et.md.algorithms.sha512=bp;var dT=Et.sha384=Et.sha512.sha384=Et.sha512.sha384||{};dT.create=function(){return bp.create("SHA-384")};Et.md.sha384=Et.md.algorithms.sha384=dT;Et.sha512.sha256=Et.sha512.sha256||{create:function(){return bp.create("SHA-512/256")}};Et.md["sha512/256"]=Et.md.algorithms["sha512/256"]=Et.sha512.sha256;Et.sha512.sha224=Et.sha512.sha224||{create:function(){return bp.create("SHA-512/224")}};Et.md["sha512/224"]=Et.md.algorithms["sha512/224"]=Et.sha512.sha224;bp.create=function(r){if(mT||bQ(),typeof r>"u"&&(r="SHA-512"),!(r in Cc))throw new Error("Invalid SHA-512 algorithm: "+r);for(var e=Cc[r],t=null,n=Et.util.createBuffer(),s=new Array(80),o=0;o<80;++o)s[o]=new Array(2);var i=64;switch(r){case"SHA-384":i=48;break;case"SHA-512/256":i=32;break;case"SHA-512/224":i=28;break}var a={algorithm:r.replace("-","").toLowerCase(),blockLength:128,digestLength:i,messageLength:0,fullMessageLength:null,messageLengthSize:16};return a.start=function(){a.messageLength=0,a.fullMessageLength=a.messageLength128=[];for(var c=a.messageLengthSize/4,l=0;l<c;++l)a.fullMessageLength.push(0);n=Et.util.createBuffer(),t=new Array(e.length);for(var l=0;l<e.length;++l)t[l]=e[l].slice(0);return a},a.start(),a.update=function(c,l){l==="utf8"&&(c=Et.util.encodeUtf8(c));var u=c.length;a.messageLength+=u,u=[u/4294967296>>>0,u>>>0];for(var f=a.fullMessageLength.length-1;f>=0;--f)a.fullMessageLength[f]+=u[1],u[1]=u[0]+(a.fullMessageLength[f]/4294967296>>>0),a.fullMessageLength[f]=a.fullMessageLength[f]>>>0,u[0]=u[1]/4294967296>>>0;return n.putBytes(c),pT(t,s,n),(n.read>2048||n.length()===0)&&n.compact(),a},a.digest=function(){var c=Et.util.createBuffer();c.putBytes(n.bytes());var l=a.fullMessageLength[a.fullMessageLength.length-1]+a.messageLengthSize,u=l&a.blockLength-1;c.putBytes(S5.substr(0,a.blockLength-u));for(var f,h,d=a.fullMessageLength[0]*8,p=0;p<a.fullMessageLength.length-1;++p)f=a.fullMessageLength[p+1]*8,h=f/4294967296>>>0,d+=h,c.putInt32(d>>>0),d=f>>>0;c.putInt32(d);for(var m=new Array(t.length),p=0;p<t.length;++p)m[p]=t[p].slice(0);pT(m,s,c);var y=Et.util.createBuffer(),b;r==="SHA-512"?b=m.length:r==="SHA-384"?b=m.length-2:b=m.length-4;for(var p=0;p<b;++p)y.putInt32(m[p][0]),(p!==b-1||r!=="SHA-512/224")&&y.putInt32(m[p][1]);return y},a};var S5=null,mT=!1,_5=null,Cc=null;function bQ(){S5="\x80",S5+=Et.util.fillString("\0",128),_5=[[1116352408,3609767458],[1899447441,602891725],[3049323471,3964484399],[3921009573,2173295548],[961987163,4081628472],[1508970993,3053834265],[2453635748,2937671579],[2870763221,3664609560],[3624381080,2734883394],[310598401,1164996542],[607225278,1323610764],[1426881987,3590304994],[1925078388,4068182383],[2162078206,991336113],[2614888103,633803317],[3248222580,3479774868],[3835390401,2666613458],[4022224774,944711139],[264347078,2341262773],[604807628,2007800933],[770255983,1495990901],[1249150122,1856431235],[1555081692,3175218132],[1996064986,2198950837],[2554220882,3999719339],[2821834349,766784016],[2952996808,2566594879],[3210313671,3203337956],[3336571891,1034457026],[3584528711,2466948901],[113926993,3758326383],[338241895,168717936],[666307205,1188179964],[773529912,1546045734],[1294757372,1522805485],[1396182291,2643833823],[1695183700,2343527390],[1986661051,1014477480],[2177026350,1206759142],[2456956037,344077627],[2730485921,1290863460],[2820302411,3158454273],[3259730800,3505952657],[3345764771,106217008],[3516065817,3606008344],[3600352804,1432725776],[4094571909,1467031594],[275423344,851169720],[430227734,3100823752],[506948616,1363258195],[659060556,3750685593],[883997877,3785050280],[958139571,3318307427],[1322822218,3812723403],[1537002063,2003034995],[1747873779,3602036899],[1955562222,1575990012],[2024104815,1125592928],[2227730452,2716904306],[2361852424,442776044],[2428436474,593698344],[2756734187,3733110249],[3204031479,2999351573],[3329325298,3815920427],[3391569614,3928383900],[3515267271,566280711],[3940187606,3454069534],[4118630271,4000239992],[116418474,1914138554],[174292421,2731055270],[289380356,3203993006],[460393269,320620315],[685471733,587496836],[852142971,1086792851],[1017036298,365543100],[1126000580,2618297676],[1288033470,3409855158],[1501505948,4234509866],[1607167915,987167468],[1816402316,1246189591]],Cc={},Cc["SHA-512"]=[[1779033703,4089235720],[3144134277,2227873595],[1013904242,4271175723],[2773480762,1595750129],[1359893119,2917565137],[2600822924,725511199],[528734635,4215389547],[1541459225,327033209]],Cc["SHA-384"]=[[3418070365,3238371032],[1654270250,914150663],[2438529370,812702999],[355462360,4144912697],[1731405415,4290775857],[2394180231,1750603025],[3675008525,1694076839],[1203062813,3204075428]],Cc["SHA-512/256"]=[[573645204,4230739756],[2673172387,3360449730],[596883563,1867755857],[2520282905,1497426621],[2519219938,2827943907],[3193839141,1401305490],[721525244,746961066],[246885852,2177182882]],Cc["SHA-512/224"]=[[2352822216,424955298],[1944164710,2312950998],[502970286,855612546],[1738396948,1479516111],[258812777,2077511080],[2011393907,79989058],[1067287976,1780299464],[286451373,2446758561]],mT=!0}function pT(r,e,t){for(var n,s,o,i,a,c,l,u,f,h,d,p,m,y,b,w,E,x,v,S,A,_,D,K,O,F,W,ce,B,N,L,U,k,G,Q,se=t.length();se>=128;){for(B=0;B<16;++B)e[B][0]=t.getInt32()>>>0,e[B][1]=t.getInt32()>>>0;for(;B<80;++B)U=e[B-2],N=U[0],L=U[1],n=((N>>>19|L<<13)^(L>>>29|N<<3)^N>>>6)>>>0,s=((N<<13|L>>>19)^(L<<3|N>>>29)^(N<<26|L>>>6))>>>0,G=e[B-15],N=G[0],L=G[1],o=((N>>>1|L<<31)^(N>>>8|L<<24)^N>>>7)>>>0,i=((N<<31|L>>>1)^(N<<24|L>>>8)^(N<<25|L>>>7))>>>0,k=e[B-7],Q=e[B-16],L=s+k[1]+i+Q[1],e[B][0]=n+k[0]+o+Q[0]+(L/4294967296>>>0)>>>0,e[B][1]=L>>>0;for(m=r[0][0],y=r[0][1],b=r[1][0],w=r[1][1],E=r[2][0],x=r[2][1],v=r[3][0],S=r[3][1],A=r[4][0],_=r[4][1],D=r[5][0],K=r[5][1],O=r[6][0],F=r[6][1],W=r[7][0],ce=r[7][1],B=0;B<80;++B)l=((A>>>14|_<<18)^(A>>>18|_<<14)^(_>>>9|A<<23))>>>0,u=((A<<18|_>>>14)^(A<<14|_>>>18)^(_<<23|A>>>9))>>>0,f=(O^A&(D^O))>>>0,h=(F^_&(K^F))>>>0,a=((m>>>28|y<<4)^(y>>>2|m<<30)^(y>>>7|m<<25))>>>0,c=((m<<4|y>>>28)^(y<<30|m>>>2)^(y<<25|m>>>7))>>>0,d=(m&b|E&(m^b))>>>0,p=(y&w|x&(y^w))>>>0,L=ce+u+h+_5[B][1]+e[B][1],n=W+l+f+_5[B][0]+e[B][0]+(L/4294967296>>>0)>>>0,s=L>>>0,L=c+p,o=a+d+(L/4294967296>>>0)>>>0,i=L>>>0,W=O,ce=F,O=D,F=K,D=A,K=_,L=S+s,A=v+n+(L/4294967296>>>0)>>>0,_=L>>>0,v=E,S=x,E=b,x=w,b=m,w=y,L=s+i,m=n+o+(L/4294967296>>>0)>>>0,y=L>>>0;L=r[0][1]+y,r[0][0]=r[0][0]+m+(L/4294967296>>>0)>>>0,r[0][1]=L>>>0,L=r[1][1]+w,r[1][0]=r[1][0]+b+(L/4294967296>>>0)>>>0,r[1][1]=L>>>0,L=r[2][1]+x,r[2][0]=r[2][0]+E+(L/4294967296>>>0)>>>0,r[2][1]=L>>>0,L=r[3][1]+S,r[3][0]=r[3][0]+v+(L/4294967296>>>0)>>>0,r[3][1]=L>>>0,L=r[4][1]+_,r[4][0]=r[4][0]+A+(L/4294967296>>>0)>>>0,r[4][1]=L>>>0,L=r[5][1]+K,r[5][0]=r[5][0]+D+(L/4294967296>>>0)>>>0,r[5][1]=L>>>0,L=r[6][1]+F,r[6][0]=r[6][0]+O+(L/4294967296>>>0)>>>0,r[6][1]=L>>>0,L=r[7][1]+ce,r[7][0]=r[7][0]+W+(L/4294967296>>>0)>>>0,r[7][1]=L>>>0,se-=128}}});var wk=Y(_u=>{"use strict";var aJ="[object ArrayBuffer]",ni=class r{static isArrayBuffer(e){return Object.prototype.toString.call(e)===aJ}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){let n=r.toUint8Array(e),s=r.toUint8Array(t);if(n.length!==s.byteLength)return!1;for(let o=0;o<n.length;o++)if(n[o]!==s[o])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(let i of t)n+=i.byteLength;let s=new Uint8Array(n),o=0;for(let i of t){let a=this.toUint8Array(i);s.set(a,o),o+=a.length}return e[e.length-1]instanceof Function?this.toView(s,e[e.length-1]):s.buffer}},c6="string",cJ=/^[0-9a-f]+$/i,lJ=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,uJ=/^[a-zA-Z0-9-_]+$/,e2=class{static fromString(e){let t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n.buffer}static toString(e){let t=ni.toUint8Array(e),n="";for(let o=0;o<t.length;o++)n+=String.fromCharCode(t[o]);return decodeURIComponent(escape(n))}},Gn=class{static toString(e,t=!1){let n=ni.toArrayBuffer(e),s=new DataView(n),o="";for(let i=0;i<n.byteLength;i+=2){let a=s.getUint16(i,t);o+=String.fromCharCode(a)}return o}static fromString(e,t=!1){let n=new ArrayBuffer(e.length*2),s=new DataView(n);for(let o=0;o<e.length;o++)s.setUint16(o*2,e.charCodeAt(o),t);return n}},t2=class r{static isHex(e){return typeof e===c6&&cJ.test(e)}static isBase64(e){return typeof e===c6&&lJ.test(e)}static isBase64Url(e){return typeof e===c6&&uJ.test(e)}static ToString(e,t="utf8"){let n=ni.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return Gn.toString(n,!0);case"utf16":case"utf16be":return Gn.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return Gn.fromString(e,!0);case"utf16":case"utf16be":return Gn.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){let t=ni.toUint8Array(e);if(typeof btoa<"u"){let n=this.ToString(t,"binary");return btoa(n)}else return Buffer.from(t).toString("base64")}static FromBase64(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=r.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return e2.fromString(e);case"utf16":case"utf16be":return Gn.fromString(e);case"utf16le":case"usc2":return Gn.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=r.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return e2.toString(e);case"utf16":case"utf16be":return Gn.toString(e);case"utf16le":case"usc2":return Gn.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){let t=e.length,n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);return n.buffer}static ToBinary(e){let t=ni.toUint8Array(e),n="";for(let s=0;s<t.length;s++)n+=String.fromCharCode(t[s]);return n}static ToHex(e){let t=ni.toUint8Array(e),n="",s=t.length;for(let o=0;o<s;o++){let i=t[o];i<16&&(n+="0"),n+=i.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);let n=new Uint8Array(t.length/2);for(let s=0;s<t.length;s=s+2){let o=t.slice(s,s+2);n[s/2]=parseInt(o,16)}return n.buffer}static ToUtf16String(e,t=!1){return Gn.toString(e,t)}static FromUtf16String(e,t=!1){return Gn.fromString(e,t)}static Base64Padding(e){let t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}};t2.DEFAULT_UTF8_ENCODING="utf8";function fJ(r,...e){let t=arguments[0];for(let n=1;n<arguments.length;n++){let s=arguments[n];for(let o in s)t[o]=s[o]}return t}function hJ(...r){let e=r.map(s=>s.byteLength).reduce((s,o)=>s+o),t=new Uint8Array(e),n=0;return r.map(s=>new Uint8Array(s)).forEach(s=>{for(let o of s)t[n++]=o}),t.buffer}function pJ(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let s=0;s<r.byteLength;s++)if(t[s]!==n[s])return!1;return!0}_u.BufferSourceConverter=ni;_u.Convert=t2;_u.assign=fJ;_u.combine=hJ;_u.isEqual=pJ});var _m=Y((TIe,Lb)=>{var IIe=function(){typeof Lb<"u"&&(Lb.exports=m);var r=86400,e=3200,t=146097*e/400,n=r*t,s=1e3*n,o=864e13,i=4294967296,a=1e6,c="000000000",l=Math.trunc||function(_){var D=_-_%1;return D==0&&(_<0||_===0&&1/_!=1/0)?-0:D},u=m.prototype,f=(m.fromDate=function(_){return new m(+_)},m.fromInt64BE=x(0,1,2,3,0,4),m.fromInt64LE=x(3,2,1,0,4,0),m.fromString=function(O){var D,K=new m,O=(O+="").replace(/^\s*[+\-]?\d+/,function(W){var W=+W,ce=1970+(W-1970)%400;return K.year=W-ce,ce}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(F,W,ce){return W<0&&(ce*=-1),D=6e4*(60*+W+ +ce),""}).replace(/\.\d+$/,function(F){return K.nano=+(F+c).substr(1,9),""}).split(/\D+/);if(1<O.length?O[1]--:O[1]=0,K.time=D=Date.UTC.apply(Date,O)-(D||0),isNaN(D))throw new TypeError("Invalid Date");return y(K)},m.fromTimeT=function(_){return w(_,0)},u.year=0,u.time=0,u.nano=0,u.addNano=function(_){return this.nano+=+_||0,this},u.getNano=function(){var _=y(this);return(_.time%1e3*a+ +_.nano+1e9)%1e9},u.getTimeT=function(){var D=y(this),_=Math.floor(D.time/1e3),D=D.year;return D&&(_+=D*t*r/e),_},u.getYear=function(){return this.toDate().getUTCFullYear()+this.year},u.toDate=function(){return b(y(this).time)},u.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},u.toString=function(_){var D=this,K=D.toDate(),O={H:function(){return S(K.getUTCHours())},L:function(){return A(K.getUTCMilliseconds(),3)},M:function(){return S(K.getUTCMinutes())},N:function(){return A(D.getNano(),9)},S:function(){return S(K.getUTCSeconds())},Y:function(){var F=D.getYear();return 999999<F?"+"+F:9999<F?"+"+A(F,6):0<=F?A(F,4):-999999<=F?"-"+A(-F,6):F},a:function(){return d[K.getUTCDay()]},b:function(){return h[K.getUTCMonth()]},d:function(){return S(K.getUTCDate())},e:function(){return function(F){return(9<F?"":" ")+(0|F)}(K.getUTCDate())},m:function(){return S(K.getUTCMonth()+1)}};return function F(W){return W.replace(/%./g,function(ce){var N=ce[1],B=p[N],N=O[N];return B?F(B):N?N():ce})}(_||f)},u.writeInt64BE=E(0,1,2,3,0,4),u.writeInt64LE=E(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),h=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],d=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],p={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return m;function m(_,D,K){var O=this;if(!(O instanceof m))return new m(_,D,K);O.time=+_||0,O.nano=+D||0,O.year=+K||0,y(O)}function y(_){var D,K,O,F=_.year,W=_.time,ce=_.nano,B=((ce<0||a<=ce)&&(ce-=(K=Math.floor(ce/a))*a,W+=K,K=1),F%e);return(W<-o||o<W||B)&&((D=l(W/s))&&(F+=D*e,W-=D*s),(O=b(W)).setUTCFullYear(B+O.getUTCFullYear()),O=(W=+O)+(D=l((F-=B)/e))*s,D&&-o<=O&&O<=o&&(F-=D*e,W=O),K=1),K&&(_.year=F,_.time=W,_.nano=ce),_}function b(_){var D=new Date(0);return D.setTime(_),D}function w(F,O){F=+F||0;var K=l((O=(O|0)*i)/n)+l(F/n),O=O%n+F%n,F=l(O/n);return F&&(K+=F,O-=F*n),new m(1e3*O,0,K*e)}function E(_,D,K,O,F,W){return function(B,N){var U=y(this);B=B||new Array(8),v(B,N|=0);var k=Math.floor(U.time/1e3),U=U.year*(t*r/e),L=l(U/i)+l(k/i),U=U%i+k%i,k=Math.floor(U/i);return k&&(L+=k,U-=k*i),ce(B,N+F,L),ce(B,N+W,U),B};function ce(B,N,L){B[N+_]=L>>24&255,B[N+D]=L>>16&255,B[N+K]=L>>8&255,B[N+O]=255&L}}function x(_,D,K,O,F,W){return function(B,N){v(B,N|=0);var L=ce(B,N+F);return w(ce(B,N+W),L)};function ce(B,N){return 16777216*B[N+_]+(B[N+D]<<16|B[N+K]<<8|B[N+O])}}function v(_,D){if(_=_&&_.length,_==null)throw new TypeError("Invalid Buffer");if(_<D+8)throw new RangeError("Out of range")}function S(_){return(9<_?"":"0")+(0|_)}function A(_,D){return(c+(0|_)).substr(-D)}}()});var LB=Y(yd=>{(function(){var r,e,t,n,s,o,i,a;a=function(c){var l,u,f,h;return l=(c&255<<24)>>>24,u=(c&255<<16)>>>16,f=(c&65280)>>>8,h=c&255,[l,u,f,h].join(".")},i=function(c){var l,u,f,h,d,p;for(l=[],f=h=0;h<=3&&c.length!==0;f=++h){if(f>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}p=e(c),d=p[0],u=p[1],c=c.substring(u),l.push(d)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),o=t("a"),s=t("A"),e=function(c){var l,u,f,h,d;for(h=0,l=10,u="9",f=0,c.length>1&&c[f]==="0"&&(c[f+1]==="x"||c[f+1]==="X"?(f+=2,l=16):"0"<=c[f+1]&&c[f+1]<="9"&&(f++,l=8,u="7")),d=f;f<c.length;){if("0"<=c[f]&&c[f]<=u)h=h*l+(t(c[f])-n)>>>0;else if(l===16)if("a"<=c[f]&&c[f]<="f")h=h*l+(10+t(c[f])-o)>>>0;else if("A"<=c[f]&&c[f]<="F")h=h*l+(10+t(c[f])-s)>>>0;else break;else break;if(h>4294967295)throw new Error("too large");f++}if(f===d)throw new Error("empty octet");return[h,f]},r=function(){function c(l,u){var f,h,d,p;if(typeof l!="string")throw new Error("Missing `net' parameter");if(u||(p=l.split("/",2),l=p[0],u=p[1]),u||(u=32),typeof u=="string"&&u.indexOf(".")>-1){try{this.maskLong=i(u)}catch(m){throw f=m,new Error("Invalid mask: "+u)}for(h=d=32;d>=0;h=--d)if(this.maskLong===4294967295<<32-h>>>0){this.bitmask=h;break}}else if(u||u===0)this.bitmask=parseInt(u,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(i(l)&this.maskLong)>>>0}catch(m){throw f=m,new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+u);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(i(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var u,f,h;for(h=i(this.first),f=i(this.last),u=0;h<=f;)l(a(h),h,u),u++,h++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),yd.ip2long=i,yd.long2ip=a,yd.Netmask=r}).call(yd)});var UB=Y((MB,jm)=>{(function(r){"use strict";let e="(0?\\d+|0x[a-f0-9]+)",t={fourOctet:new RegExp(`^${e}\\.${e}\\.${e}\\.${e}$`,"i"),threeOctet:new RegExp(`^${e}\\.${e}\\.${e}$`,"i"),twoOctet:new RegExp(`^${e}\\.${e}$`,"i"),longValue:new RegExp(`^${e}$`,"i")},n=new RegExp("^0[0-7]+$","i"),s=new RegExp("^0x[a-f0-9]+$","i"),o="%[0-9a-z]{1,}",i="(?:[0-9a-f]+::?)+",a={zoneIndex:new RegExp(o,"i"),native:new RegExp(`^(::)?(${i})?([0-9a-f]+)?(::)?(${o})?$`,"i"),deprecatedTransitional:new RegExp(`^(?:::)(${e}\\.${e}\\.${e}\\.${e}(${o})?)$`,"i"),transitional:new RegExp(`^((?:${i})|(?:::)(?:${i})?)${e}\\.${e}\\.${e}\\.${e}(${o})?$`,"i")};function c(d,p){if(d.indexOf("::")!==d.lastIndexOf("::"))return null;let m=0,y=-1,b=(d.match(a.zoneIndex)||[])[0],w,E;for(b&&(b=b.substring(1),d=d.replace(/%.+$/,""));(y=d.indexOf(":",y+1))>=0;)m++;if(d.substr(0,2)==="::"&&m--,d.substr(-2,2)==="::"&&m--,m>p)return null;for(E=p-m,w=":";E--;)w+="0:";return d=d.replace("::",w),d[0]===":"&&(d=d.slice(1)),d[d.length-1]===":"&&(d=d.slice(0,-1)),p=function(){let x=d.split(":"),v=[];for(let S=0;S<x.length;S++)v.push(parseInt(x[S],16));return v}(),{parts:p,zoneId:b}}function l(d,p,m,y){if(d.length!==p.length)throw new Error("ipaddr: cannot match CIDR for objects with different lengths");let b=0,w;for(;y>0;){if(w=m-y,w<0&&(w=0),d[b]>>w!==p[b]>>w)return!1;y-=m,b+=1}return!0}function u(d){if(s.test(d))return parseInt(d,16);if(d[0]==="0"&&!isNaN(parseInt(d[1],10))){if(n.test(d))return parseInt(d,8);throw new Error(`ipaddr: cannot parse ${d} as octal`)}return parseInt(d,10)}function f(d,p){for(;d.length<p;)d=`0${d}`;return d}let h={};h.IPv4=function(){function d(p){if(p.length!==4)throw new Error("ipaddr: ipv4 octet count should be 4");let m,y;for(m=0;m<p.length;m++)if(y=p[m],!(0<=y&&y<=255))throw new Error("ipaddr: ipv4 octet should fit in 8 bits");this.octets=p}return d.prototype.SpecialRanges={unspecified:[[new d([0,0,0,0]),8]],broadcast:[[new d([255,255,255,255]),32]],multicast:[[new d([224,0,0,0]),4]],linkLocal:[[new d([169,254,0,0]),16]],loopback:[[new d([127,0,0,0]),8]],carrierGradeNat:[[new d([100,64,0,0]),10]],private:[[new d([10,0,0,0]),8],[new d([172,16,0,0]),12],[new d([192,168,0,0]),16]],reserved:[[new d([192,0,0,0]),24],[new d([192,0,2,0]),24],[new d([192,88,99,0]),24],[new d([198,18,0,0]),15],[new d([198,51,100,0]),24],[new d([203,0,113,0]),24],[new d([240,0,0,0]),4]]},d.prototype.kind=function(){return"ipv4"},d.prototype.match=function(p,m){let y;if(m===void 0&&(y=p,p=y[0],m=y[1]),p.kind()!=="ipv4")throw new Error("ipaddr: cannot match ipv4 address with non-ipv4 one");return l(this.octets,p.octets,8,m)},d.prototype.prefixLengthFromSubnetMask=function(){let p=0,m=!1,y={0:8,128:7,192:6,224:5,240:4,248:3,252:2,254:1,255:0},b,w,E;for(b=3;b>=0;b-=1)if(w=this.octets[b],w in y){if(E=y[w],m&&E!==0)return null;E!==8&&(m=!0),p+=E}else return null;return 32-p},d.prototype.range=function(){return h.subnetMatch(this,this.SpecialRanges)},d.prototype.toByteArray=function(){return this.octets.slice(0)},d.prototype.toIPv4MappedAddress=function(){return h.IPv6.parse(`::ffff:${this.toString()}`)},d.prototype.toNormalizedString=function(){return this.toString()},d.prototype.toString=function(){return this.octets.join(".")},d}(),h.IPv4.broadcastAddressFromCIDR=function(d){try{let p=this.parseCIDR(d),m=p[0].toByteArray(),y=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),b=[],w=0;for(;w<4;)b.push(parseInt(m[w],10)|parseInt(y[w],10)^255),w++;return new this(b)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},h.IPv4.isIPv4=function(d){return this.parser(d)!==null},h.IPv4.isValid=function(d){try{return new this(this.parser(d)),!0}catch{return!1}},h.IPv4.isValidFourPartDecimal=function(d){return!!(h.IPv4.isValid(d)&&d.match(/^(0|[1-9]\d*)(\.(0|[1-9]\d*)){3}$/))},h.IPv4.networkAddressFromCIDR=function(d){let p,m,y,b,w;try{for(p=this.parseCIDR(d),y=p[0].toByteArray(),w=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),b=[],m=0;m<4;)b.push(parseInt(y[m],10)&parseInt(w[m],10)),m++;return new this(b)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},h.IPv4.parse=function(d){let p=this.parser(d);if(p===null)throw new Error("ipaddr: string is not formatted like an IPv4 Address");return new this(p)},h.IPv4.parseCIDR=function(d){let p;if(p=d.match(/^(.+)\/(\d+)$/)){let m=parseInt(p[2]);if(m>=0&&m<=32){let y=[this.parse(p[1]),m];return Object.defineProperty(y,"toString",{value:function(){return this.join("/")}}),y}}throw new Error("ipaddr: string is not formatted like an IPv4 CIDR range")},h.IPv4.parser=function(d){let p,m,y;if(p=d.match(t.fourOctet))return function(){let b=p.slice(1,6),w=[];for(let E=0;E<b.length;E++)m=b[E],w.push(u(m));return w}();if(p=d.match(t.longValue)){if(y=u(p[1]),y>4294967295||y<0)throw new Error("ipaddr: address outside defined range");return function(){let b=[],w;for(w=0;w<=24;w+=8)b.push(y>>w&255);return b}().reverse()}else return(p=d.match(t.twoOctet))?function(){let b=p.slice(1,4),w=[];if(y=u(b[1]),y>16777215||y<0)throw new Error("ipaddr: address outside defined range");return w.push(u(b[0])),w.push(y>>16&255),w.push(y>>8&255),w.push(y&255),w}():(p=d.match(t.threeOctet))?function(){let b=p.slice(1,5),w=[];if(y=u(b[2]),y>65535||y<0)throw new Error("ipaddr: address outside defined range");return w.push(u(b[0])),w.push(u(b[1])),w.push(y>>8&255),w.push(y&255),w}():null},h.IPv4.subnetMaskFromPrefixLength=function(d){if(d=parseInt(d),d<0||d>32)throw new Error("ipaddr: invalid IPv4 prefix length");let p=[0,0,0,0],m=0,y=Math.floor(d/8);for(;m<y;)p[m]=255,m++;return y<4&&(p[y]=Math.pow(2,d%8)-1<<8-d%8),new this(p)},h.IPv6=function(){function d(p,m){let y,b;if(p.length===16)for(this.parts=[],y=0;y<=14;y+=2)this.parts.push(p[y]<<8|p[y+1]);else if(p.length===8)this.parts=p;else throw new Error("ipaddr: ipv6 part count should be 8 or 16");for(y=0;y<this.parts.length;y++)if(b=this.parts[y],!(0<=b&&b<=65535))throw new Error("ipaddr: ipv6 part should fit in 16 bits");m&&(this.zoneId=m)}return d.prototype.SpecialRanges={unspecified:[new d([0,0,0,0,0,0,0,0]),128],linkLocal:[new d([65152,0,0,0,0,0,0,0]),10],multicast:[new d([65280,0,0,0,0,0,0,0]),8],loopback:[new d([0,0,0,0,0,0,0,1]),128],uniqueLocal:[new d([64512,0,0,0,0,0,0,0]),7],ipv4Mapped:[new d([0,0,0,0,0,65535,0,0]),96],rfc6145:[new d([0,0,0,0,65535,0,0,0]),96],rfc6052:[new d([100,65435,0,0,0,0,0,0]),96],"6to4":[new d([8194,0,0,0,0,0,0,0]),16],teredo:[new d([8193,0,0,0,0,0,0,0]),32],reserved:[[new d([8193,3512,0,0,0,0,0,0]),32]],benchmarking:[new d([8193,2,0,0,0,0,0,0]),48],amt:[new d([8193,3,0,0,0,0,0,0]),32],as112v6:[new d([8193,4,274,0,0,0,0,0]),48],deprecated:[new d([8193,16,0,0,0,0,0,0]),28],orchid2:[new d([8193,32,0,0,0,0,0,0]),28]},d.prototype.isIPv4MappedAddress=function(){return this.range()==="ipv4Mapped"},d.prototype.kind=function(){return"ipv6"},d.prototype.match=function(p,m){let y;if(m===void 0&&(y=p,p=y[0],m=y[1]),p.kind()!=="ipv6")throw new Error("ipaddr: cannot match ipv6 address with non-ipv6 one");return l(this.parts,p.parts,16,m)},d.prototype.prefixLengthFromSubnetMask=function(){let p=0,m=!1,y={0:16,32768:15,49152:14,57344:13,61440:12,63488:11,64512:10,65024:9,65280:8,65408:7,65472:6,65504:5,65520:4,65528:3,65532:2,65534:1,65535:0},b,w;for(let E=7;E>=0;E-=1)if(b=this.parts[E],b in y){if(w=y[b],m&&w!==0)return null;w!==16&&(m=!0),p+=w}else return null;return 128-p},d.prototype.range=function(){return h.subnetMatch(this,this.SpecialRanges)},d.prototype.toByteArray=function(){let p,m=[],y=this.parts;for(let b=0;b<y.length;b++)p=y[b],m.push(p>>8),m.push(p&255);return m},d.prototype.toFixedLengthString=function(){let p=function(){let y=[];for(let b=0;b<this.parts.length;b++)y.push(f(this.parts[b].toString(16),4));return y}.call(this).join(":"),m="";return this.zoneId&&(m=`%${this.zoneId}`),p+m},d.prototype.toIPv4Address=function(){if(!this.isIPv4MappedAddress())throw new Error("ipaddr: trying to convert a generic ipv6 address to ipv4");let p=this.parts.slice(-2),m=p[0],y=p[1];return new h.IPv4([m>>8,m&255,y>>8,y&255])},d.prototype.toNormalizedString=function(){let p=function(){let y=[];for(let b=0;b<this.parts.length;b++)y.push(this.parts[b].toString(16));return y}.call(this).join(":"),m="";return this.zoneId&&(m=`%${this.zoneId}`),p+m},d.prototype.toRFC5952String=function(){let p=/((^|:)(0(:|$)){2,})/g,m=this.toNormalizedString(),y=0,b=-1,w;for(;w=p.exec(m);)w[0].length>b&&(y=w.index,b=w[0].length);return b<0?m:`${m.substring(0,y)}::${m.substring(y+b)}`},d.prototype.toString=function(){return this.toRFC5952String()},d}(),h.IPv6.broadcastAddressFromCIDR=function(d){try{let p=this.parseCIDR(d),m=p[0].toByteArray(),y=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),b=[],w=0;for(;w<16;)b.push(parseInt(m[w],10)|parseInt(y[w],10)^255),w++;return new this(b)}catch(p){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${p})`)}},h.IPv6.isIPv6=function(d){return this.parser(d)!==null},h.IPv6.isValid=function(d){if(typeof d=="string"&&d.indexOf(":")===-1)return!1;try{let p=this.parser(d);return new this(p.parts,p.zoneId),!0}catch{return!1}},h.IPv6.networkAddressFromCIDR=function(d){let p,m,y,b,w;try{for(p=this.parseCIDR(d),y=p[0].toByteArray(),w=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),b=[],m=0;m<16;)b.push(parseInt(y[m],10)&parseInt(w[m],10)),m++;return new this(b)}catch(E){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${E})`)}},h.IPv6.parse=function(d){let p=this.parser(d);if(p.parts===null)throw new Error("ipaddr: string is not formatted like an IPv6 Address");return new this(p.parts,p.zoneId)},h.IPv6.parseCIDR=function(d){let p,m,y;if((m=d.match(/^(.+)\/(\d+)$/))&&(p=parseInt(m[2]),p>=0&&p<=128))return y=[this.parse(m[1]),p],Object.defineProperty(y,"toString",{value:function(){return this.join("/")}}),y;throw new Error("ipaddr: string is not formatted like an IPv6 CIDR range")},h.IPv6.parser=function(d){let p,m,y,b,w,E;if(y=d.match(a.deprecatedTransitional))return this.parser(`::ffff:${y[1]}`);if(a.native.test(d))return c(d,8);if((y=d.match(a.transitional))&&(E=y[6]||"",p=c(y[1].slice(0,-1)+E,6),p.parts)){for(w=[parseInt(y[2]),parseInt(y[3]),parseInt(y[4]),parseInt(y[5])],m=0;m<w.length;m++)if(b=w[m],!(0<=b&&b<=255))return null;return p.parts.push(w[0]<<8|w[1]),p.parts.push(w[2]<<8|w[3]),{parts:p.parts,zoneId:p.zoneId}}return null},h.IPv6.subnetMaskFromPrefixLength=function(d){if(d=parseInt(d),d<0||d>128)throw new Error("ipaddr: invalid IPv6 prefix length");let p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],m=0,y=Math.floor(d/8);for(;m<y;)p[m]=255,m++;return y<16&&(p[y]=Math.pow(2,d%8)-1<<8-d%8),new this(p)},h.fromByteArray=function(d){let p=d.length;if(p===4)return new h.IPv4(d);if(p===16)return new h.IPv6(d);throw new Error("ipaddr: the binary input is neither an IPv6 nor IPv4 address")},h.isValid=function(d){return h.IPv6.isValid(d)||h.IPv4.isValid(d)},h.parse=function(d){if(h.IPv6.isValid(d))return h.IPv6.parse(d);if(h.IPv4.isValid(d))return h.IPv4.parse(d);throw new Error("ipaddr: the address has neither IPv6 nor IPv4 format")},h.parseCIDR=function(d){try{return h.IPv6.parseCIDR(d)}catch{try{return h.IPv4.parseCIDR(d)}catch{throw new Error("ipaddr: the address has neither IPv6 nor IPv4 CIDR format")}}},h.process=function(d){let p=this.parse(d);return p.kind()==="ipv6"&&p.isIPv4MappedAddress()?p.toIPv4Address():p},h.subnetMatch=function(d,p,m){let y,b,w,E;m==null&&(m="unicast");for(b in p)if(Object.prototype.hasOwnProperty.call(p,b)){for(w=p[b],w[0]&&!(w[0]instanceof Array)&&(w=[w]),y=0;y<w.length;y++)if(E=w[y],d.kind()===E[0].kind()&&d.match.apply(d,E))return b}return m},typeof jm<"u"&&jm.exports?jm.exports=h:r.ipaddr=h})(MB)});var aL=Y((gKe,iL)=>{function vse(){return!!(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron||typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent.indexOf("Electron")>=0)}iL.exports=vse});var sO=Y((BFe,nO)=>{nO.exports=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function s(o,i){t[o]=i,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(o){return t[o]!==void 0||n[o]!==void 0},remove:function(o){t[o]!==void 0&&(t[o]=void 0),n[o]!==void 0&&(n[o]=void 0)},get:function(o){var i=t[o];if(i!==void 0)return i;if((i=n[o])!==void 0)return s(o,i),i},set:function(o,i){t[o]!==void 0?t[o]=i:s(o,i)},clear:function(){t=Object.create(null),n=Object.create(null)}}}});var FO=Y((Dze,UO)=>{"use strict";UO.exports=r=>{if(Object.prototype.toString.call(r)!=="[object Object]")return!1;let e=Object.getPrototypeOf(r);return e===null||e===Object.prototype}});var GO=Y((zO,$O)=>{"use strict";var Zy=FO(),{hasOwnProperty:qO}=Object.prototype,{propertyIsEnumerable:nie}=Object,Vf=(r,e,t)=>Object.defineProperty(r,e,{value:t,writable:!0,enumerable:!0,configurable:!0}),sie=zO,VO={concatArrays:!1,ignoreUndefined:!1},eg=r=>{let e=[];for(let t in r)qO.call(r,t)&&e.push(t);if(Object.getOwnPropertySymbols){let t=Object.getOwnPropertySymbols(r);for(let n of t)nie.call(r,n)&&e.push(n)}return e};function qf(r){return Array.isArray(r)?oie(r):Zy(r)?iie(r):r}function oie(r){let e=r.slice(0,0);return eg(r).forEach(t=>{Vf(e,t,qf(r[t]))}),e}function iie(r){let e=Object.getPrototypeOf(r)===null?Object.create(null):{};return eg(r).forEach(t=>{Vf(e,t,qf(r[t]))}),e}var HO=(r,e,t,n)=>(t.forEach(s=>{typeof e[s]>"u"&&n.ignoreUndefined||(s in r&&r[s]!==Object.getPrototypeOf(r)?Vf(r,s,t7(r[s],e[s],n)):Vf(r,s,qf(e[s])))}),r),aie=(r,e,t)=>{let n=r.slice(0,0),s=0;return[r,e].forEach(o=>{let i=[];for(let a=0;a<o.length;a++)qO.call(o,a)&&(i.push(String(a)),o===r?Vf(n,s++,o[a]):Vf(n,s++,qf(o[a])));n=HO(n,o,eg(o).filter(a=>!i.includes(a)),t)}),n};function t7(r,e,t){return t.concatArrays&&Array.isArray(r)&&Array.isArray(e)?aie(r,e,t):!Zy(e)||!Zy(r)?qf(e):HO(r,e,eg(e),t)}$O.exports=function(...r){let e=t7(qf(VO),this!==sie&&this||{},VO),t={_:{}};for(let n of r)if(n!==void 0){if(!Zy(n))throw new TypeError("`"+n+"` is not an Option Object");t=t7(t,{_:n},e)}return t._}});var jO=Y((Cze,YO)=>{"use strict";function cie(r){return r>=55296&&r<=56319}function lie(r){return r>=56320&&r<=57343}YO.exports=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var s=t.length,o=0,i,a,c=0;c<s;c+=1){if(i=t.charCodeAt(c),a=t[c],cie(i)&&lie(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),o+=e(a),o===n)return t.slice(0,c+1);if(o>n)return t.slice(0,c-a.length+1)}return t}});var XO=Y((Bze,QO)=>{"use strict";function uie(r){return r>=55296&&r<=56319}function fie(r){return r>=56320&&r<=57343}QO.exports=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,s=null,o=null,i=0;i<t;i++)s=e.charCodeAt(i),fie(s)?o!=null&&uie(o)?n+=1:n+=3:s<=127?n+=1:s>=128&&s<=2047?n+=2:s>=2048&&s<=65535&&(n+=3),o=s;return n}});var ZO=Y((Nze,JO)=>{"use strict";var hie=jO(),pie=XO();JO.exports=hie.bind(null,pie)});var rK=Y((Lze,tK)=>{"use strict";var die=ZO(),mie=/[\/\?<>\\:\*\|"]/g,yie=/[\x00-\x1f\x80-\x9f]/g,gie=/^\.+$/,bie=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,wie=/[\. ]+$/;function eK(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(mie,e).replace(yie,e).replace(gie,e).replace(bie,e).replace(wie,e);return die(t,255)}tK.exports=function(r,e){var t=e&&e.replacement||"",n=eK(r,t);return t===""?n:eK(n,"")}});var LK=Y((eje,NK)=>{"use strict";function dae(r){if(r.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),t=0;t<e.length;t++)e[t]=255;for(var n=0;n<r.length;n++){var s=r.charAt(n),o=s.charCodeAt(0);if(e[o]!==255)throw new TypeError(s+" is ambiguous");e[o]=n}var i=r.length,a=r.charAt(0),c=Math.log(i)/Math.log(256),l=Math.log(256)/Math.log(i);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,m=0,y=0,b=d.length;y!==b&&d[y]===0;)y++,p++;for(var w=(b-y)*l+1>>>0,E=new Uint8Array(w);y!==b;){for(var x=d[y],v=0,S=w-1;(x!==0||v<m)&&S!==-1;S--,v++)x+=256*E[S]>>>0,E[S]=x%i>>>0,x=x/i>>>0;if(x!==0)throw new Error("Non-zero carry");m=v,y++}for(var A=w-m;A!==w&&E[A]===0;)A++;for(var _=a.repeat(p);A<w;++A)_+=r.charAt(E[A]);return _}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var m=0,y=0;d[p]===a;)m++,p++;for(var b=(d.length-p)*c+1>>>0,w=new Uint8Array(b);d[p];){var E=e[d.charCodeAt(p)];if(E===255)return;for(var x=0,v=b-1;(E!==0||x<y)&&v!==-1;v--,x++)E+=i*w[v]>>>0,w[v]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=x,p++}if(d[p]!==" "){for(var S=b-y;S!==b&&w[S]===0;)S++;for(var A=new Uint8Array(m+(b-S)),_=m;S!==b;)A[_++]=w[S++];return A}}}function h(d){var p=f(d);if(p)return p;throw new Error("Non-base"+i+" character")}return{encode:u,decodeUnsafe:f,decode:h}}NK.exports=dae});var yg=Y((tje,OK)=>{"use strict";var mae=new TextDecoder,yae=r=>mae.decode(r),gae=new TextEncoder,bae=r=>gae.encode(r);function wae(r,e){let t=new Uint8Array(e),n=0;for(let s of r)t.set(s,n),n+=s.length;return t}OK.exports={decodeText:yae,encodeText:bae,concat:wae}});var MK=Y((rje,KK)=>{"use strict";var{encodeText:Eae}=yg(),S7=class{constructor(e,t,n,s){this.name=e,this.code=t,this.codeBuf=Eae(this.code),this.alphabet=s,this.codec=n(s)}encode(e){return this.codec.encode(e)}decode(e){for(let t of e)if(this.alphabet&&this.alphabet.indexOf(t)<0)throw new Error(`invalid character '${t}' in '${e}'`);return this.codec.decode(e)}};KK.exports=S7});var FK=Y((nje,UK)=>{"use strict";var vae=(r,e,t)=>{let n={};for(let l=0;l<e.length;++l)n[e[l]]=l;let s=r.length;for(;r[s-1]==="=";)--s;let o=new Uint8Array(s*t/8|0),i=0,a=0,c=0;for(let l=0;l<s;++l){let u=n[r[l]];if(u===void 0)throw new SyntaxError("Invalid character "+r[l]);a=a<<t|u,i+=t,i>=8&&(i-=8,o[c++]=255&a>>i)}if(i>=t||255&a<<8-i)throw new SyntaxError("Unexpected end of data");return o},xae=(r,e,t)=>{let n=e[e.length-1]==="=",s=(1<<t)-1,o="",i=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],i+=8;i>t;)i-=t,o+=e[s&a>>i];if(i&&(o+=e[s&a<<t-i]),n)for(;o.length*t&7;)o+="=";return o},Sae=r=>e=>({encode(t){return xae(t,e,r)},decode(t){return vae(t,e,r)}});UK.exports={rfc4648:Sae}});var zK=Y((sje,HK)=>{"use strict";var Vd=LK(),_ae=MK(),{rfc4648:Dr}=FK(),{decodeText:Aae,encodeText:Rae}=yg(),Iae=()=>({encode:Aae,decode:Rae}),VK=[["identity","\0",Iae,""],["base2","0",Dr(1),"01"],["base8","7",Dr(3),"01234567"],["base10","9",Vd,"0123456789"],["base16","f",Dr(4),"0123456789abcdef"],["base16upper","F",Dr(4),"0123456789ABCDEF"],["base32hex","v",Dr(5),"0123456789abcdefghijklmnopqrstuv"],["base32hexupper","V",Dr(5),"0123456789ABCDEFGHIJKLMNOPQRSTUV"],["base32hexpad","t",Dr(5),"0123456789abcdefghijklmnopqrstuv="],["base32hexpadupper","T",Dr(5),"0123456789ABCDEFGHIJKLMNOPQRSTUV="],["base32","b",Dr(5),"abcdefghijklmnopqrstuvwxyz234567"],["base32upper","B",Dr(5),"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"],["base32pad","c",Dr(5),"abcdefghijklmnopqrstuvwxyz234567="],["base32padupper","C",Dr(5),"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567="],["base32z","h",Dr(5),"ybndrfg8ejkmcpqxot1uwisza345h769"],["base36","k",Vd,"0123456789abcdefghijklmnopqrstuvwxyz"],["base36upper","K",Vd,"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"],["base58btc","z",Vd,"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"],["base58flickr","Z",Vd,"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"],["base64","m",Dr(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"],["base64pad","M",Dr(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="],["base64url","u",Dr(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"],["base64urlpad","U",Dr(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_="]],qK=VK.reduce((r,e)=>(r[e[0]]=new _ae(e[0],e[1],e[2],e[3]),r),{}),Tae=VK.reduce((r,e)=>(r[e[1]]=qK[e[0]],r),{});HK.exports={names:qK,codes:Tae}});var WK=Y((Pi,GK)=>{"use strict";var jf=zK(),{encodeText:kae,decodeText:gg,concat:$K}=yg();function Dae(r,e){if(!e)throw new Error("requires an encoded Uint8Array");let{name:t,codeBuf:n}=ml(r);return Nae(t,e),$K([n,e],n.length+e.length)}function Pae(r,e){let t=ml(r),n=kae(t.encode(e));return $K([t.codeBuf,n],t.codeBuf.length+n.length)}function Cae(r){r instanceof Uint8Array&&(r=gg(r));let e=r[0];return["f","F","v","V","t","T","b","B","c","C","h","k","K"].includes(e)&&(r=r.toLowerCase()),ml(r[0]).decode(r.substring(1))}function Bae(r){if(r instanceof Uint8Array&&(r=gg(r)),Object.prototype.toString.call(r)!=="[object String]")return!1;try{return ml(r[0]).name}catch{return!1}}function Nae(r,e){ml(r).decode(gg(e))}function ml(r){if(Object.prototype.hasOwnProperty.call(jf.names,r))return jf.names[r];if(Object.prototype.hasOwnProperty.call(jf.codes,r))return jf.codes[r];throw new Error(`Unsupported encoding: ${r}`)}function Lae(r){return r instanceof Uint8Array&&(r=gg(r)),ml(r[0])}Pi=GK.exports=Dae;Pi.encode=Pae;Pi.decode=Cae;Pi.isEncoded=Bae;Pi.encoding=ml;Pi.encodingFromData=Lae;var Oae=Object.freeze(jf.names),Kae=Object.freeze(jf.codes);Pi.names=Oae;Pi.codes=Kae});var XK=Y((oje,QK)=>{QK.exports=jK;var YK=128,Mae=127,Uae=~Mae,Fae=Math.pow(2,31);function jK(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Fae;)e[t++]=r&255|YK,r/=128;for(;r&Uae;)e[t++]=r&255|YK,r>>>=7;return e[t]=r|0,jK.bytes=t-n+1,e}});var eM=Y((ije,ZK)=>{ZK.exports=_7;var Vae=128,JK=127;function _7(r,n){var t=0,n=n||0,s=0,o=n,i,a=r.length;do{if(o>=a)throw _7.bytes=0,new RangeError("Could not decode varint");i=r[o++],t+=s<28?(i&JK)<<s:(i&JK)*Math.pow(2,s),s+=7}while(i>=Vae);return _7.bytes=o-n,t}});var rM=Y((aje,tM)=>{var qae=Math.pow(2,7),Hae=Math.pow(2,14),zae=Math.pow(2,21),$ae=Math.pow(2,28),Gae=Math.pow(2,35),Wae=Math.pow(2,42),Yae=Math.pow(2,49),jae=Math.pow(2,56),Qae=Math.pow(2,63);tM.exports=function(r){return r<qae?1:r<Hae?2:r<zae?3:r<$ae?4:r<Gae?5:r<Wae?6:r<Yae?7:r<jae?8:r<Qae?9:10}});var sM=Y((cje,nM)=>{nM.exports={encode:XK(),decode:eM(),encodingLength:rM()}});var iM=Y((lje,oM)=>{"use strict";var Xae=Object.freeze({identity:0,sha1:17,"sha2-256":18,"sha2-512":19,"sha3-512":20,"sha3-384":21,"sha3-256":22,"sha3-224":23,"shake-128":24,"shake-256":25,"keccak-224":26,"keccak-256":27,"keccak-384":28,"keccak-512":29,blake3:30,"murmur3-128":34,"murmur3-32":35,"dbl-sha2-256":86,md4:212,md5:213,bmt:214,"sha2-256-trunc254-padded":4114,"ripemd-128":4178,"ripemd-160":4179,"ripemd-256":4180,"ripemd-320":4181,x11:4352,kangarootwelve:7425,"sm3-256":21325,"blake2b-8":45569,"blake2b-16":45570,"blake2b-24":45571,"blake2b-32":45572,"blake2b-40":45573,"blake2b-48":45574,"blake2b-56":45575,"blake2b-64":45576,"blake2b-72":45577,"blake2b-80":45578,"blake2b-88":45579,"blake2b-96":45580,"blake2b-104":45581,"blake2b-112":45582,"blake2b-120":45583,"blake2b-128":45584,"blake2b-136":45585,"blake2b-144":45586,"blake2b-152":45587,"blake2b-160":45588,"blake2b-168":45589,"blake2b-176":45590,"blake2b-184":45591,"blake2b-192":45592,"blake2b-200":45593,"blake2b-208":45594,"blake2b-216":45595,"blake2b-224":45596,"blake2b-232":45597,"blake2b-240":45598,"blake2b-248":45599,"blake2b-256":45600,"blake2b-264":45601,"blake2b-272":45602,"blake2b-280":45603,"blake2b-288":45604,"blake2b-296":45605,"blake2b-304":45606,"blake2b-312":45607,"blake2b-320":45608,"blake2b-328":45609,"blake2b-336":45610,"blake2b-344":45611,"blake2b-352":45612,"blake2b-360":45613,"blake2b-368":45614,"blake2b-376":45615,"blake2b-384":45616,"blake2b-392":45617,"blake2b-400":45618,"blake2b-408":45619,"blake2b-416":45620,"blake2b-424":45621,"blake2b-432":45622,"blake2b-440":45623,"blake2b-448":45624,"blake2b-456":45625,"blake2b-464":45626,"blake2b-472":45627,"blake2b-480":45628,"blake2b-488":45629,"blake2b-496":45630,"blake2b-504":45631,"blake2b-512":45632,"blake2s-8":45633,"blake2s-16":45634,"blake2s-24":45635,"blake2s-32":45636,"blake2s-40":45637,"blake2s-48":45638,"blake2s-56":45639,"blake2s-64":45640,"blake2s-72":45641,"blake2s-80":45642,"blake2s-88":45643,"blake2s-96":45644,"blake2s-104":45645,"blake2s-112":45646,"blake2s-120":45647,"blake2s-128":45648,"blake2s-136":45649,"blake2s-144":45650,"blake2s-152":45651,"blake2s-160":45652,"blake2s-168":45653,"blake2s-176":45654,"blake2s-184":45655,"blake2s-192":45656,"blake2s-200":45657,"blake2s-208":45658,"blake2s-216":45659,"blake2s-224":45660,"blake2s-232":45661,"blake2s-240":45662,"blake2s-248":45663,"blake2s-256":45664,"skein256-8":45825,"skein256-16":45826,"skein256-24":45827,"skein256-32":45828,"skein256-40":45829,"skein256-48":45830,"skein256-56":45831,"skein256-64":45832,"skein256-72":45833,"skein256-80":45834,"skein256-88":45835,"skein256-96":45836,"skein256-104":45837,"skein256-112":45838,"skein256-120":45839,"skein256-128":45840,"skein256-136":45841,"skein256-144":45842,"skein256-152":45843,"skein256-160":45844,"skein256-168":45845,"skein256-176":45846,"skein256-184":45847,"skein256-192":45848,"skein256-200":45849,"skein256-208":45850,"skein256-216":45851,"skein256-224":45852,"skein256-232":45853,"skein256-240":45854,"skein256-248":45855,"skein256-256":45856,"skein512-8":45857,"skein512-16":45858,"skein512-24":45859,"skein512-32":45860,"skein512-40":45861,"skein512-48":45862,"skein512-56":45863,"skein512-64":45864,"skein512-72":45865,"skein512-80":45866,"skein512-88":45867,"skein512-96":45868,"skein512-104":45869,"skein512-112":45870,"skein512-120":45871,"skein512-128":45872,"skein512-136":45873,"skein512-144":45874,"skein512-152":45875,"skein512-160":45876,"skein512-168":45877,"skein512-176":45878,"skein512-184":45879,"skein512-192":45880,"skein512-200":45881,"skein512-208":45882,"skein512-216":45883,"skein512-224":45884,"skein512-232":45885,"skein512-240":45886,"skein512-248":45887,"skein512-256":45888,"skein512-264":45889,"skein512-272":45890,"skein512-280":45891,"skein512-288":45892,"skein512-296":45893,"skein512-304":45894,"skein512-312":45895,"skein512-320":45896,"skein512-328":45897,"skein512-336":45898,"skein512-344":45899,"skein512-352":45900,"skein512-360":45901,"skein512-368":45902,"skein512-376":45903,"skein512-384":45904,"skein512-392":45905,"skein512-400":45906,"skein512-408":45907,"skein512-416":45908,"skein512-424":45909,"skein512-432":45910,"skein512-440":45911,"skein512-448":45912,"skein512-456":45913,"skein512-464":45914,"skein512-472":45915,"skein512-480":45916,"skein512-488":45917,"skein512-496":45918,"skein512-504":45919,"skein512-512":45920,"skein1024-8":45921,"skein1024-16":45922,"skein1024-24":45923,"skein1024-32":45924,"skein1024-40":45925,"skein1024-48":45926,"skein1024-56":45927,"skein1024-64":45928,"skein1024-72":45929,"skein1024-80":45930,"skein1024-88":45931,"skein1024-96":45932,"skein1024-104":45933,"skein1024-112":45934,"skein1024-120":45935,"skein1024-128":45936,"skein1024-136":45937,"skein1024-144":45938,"skein1024-152":45939,"skein1024-160":45940,"skein1024-168":45941,"skein1024-176":45942,"skein1024-184":45943,"skein1024-192":45944,"skein1024-200":45945,"skein1024-208":45946,"skein1024-216":45947,"skein1024-224":45948,"skein1024-232":45949,"skein1024-240":45950,"skein1024-248":45951,"skein1024-256":45952,"skein1024-264":45953,"skein1024-272":45954,"skein1024-280":45955,"skein1024-288":45956,"skein1024-296":45957,"skein1024-304":45958,"skein1024-312":45959,"skein1024-320":45960,"skein1024-328":45961,"skein1024-336":45962,"skein1024-344":45963,"skein1024-352":45964,"skein1024-360":45965,"skein1024-368":45966,"skein1024-376":45967,"skein1024-384":45968,"skein1024-392":45969,"skein1024-400":45970,"skein1024-408":45971,"skein1024-416":45972,"skein1024-424":45973,"skein1024-432":45974,"skein1024-440":45975,"skein1024-448":45976,"skein1024-456":45977,"skein1024-464":45978,"skein1024-472":45979,"skein1024-480":45980,"skein1024-488":45981,"skein1024-496":45982,"skein1024-504":45983,"skein1024-512":45984,"skein1024-520":45985,"skein1024-528":45986,"skein1024-536":45987,"skein1024-544":45988,"skein1024-552":45989,"skein1024-560":45990,"skein1024-568":45991,"skein1024-576":45992,"skein1024-584":45993,"skein1024-592":45994,"skein1024-600":45995,"skein1024-608":45996,"skein1024-616":45997,"skein1024-624":45998,"skein1024-632":45999,"skein1024-640":46e3,"skein1024-648":46001,"skein1024-656":46002,"skein1024-664":46003,"skein1024-672":46004,"skein1024-680":46005,"skein1024-688":46006,"skein1024-696":46007,"skein1024-704":46008,"skein1024-712":46009,"skein1024-720":46010,"skein1024-728":46011,"skein1024-736":46012,"skein1024-744":46013,"skein1024-752":46014,"skein1024-760":46015,"skein1024-768":46016,"skein1024-776":46017,"skein1024-784":46018,"skein1024-792":46019,"skein1024-800":46020,"skein1024-808":46021,"skein1024-816":46022,"skein1024-824":46023,"skein1024-832":46024,"skein1024-840":46025,"skein1024-848":46026,"skein1024-856":46027,"skein1024-864":46028,"skein1024-872":46029,"skein1024-880":46030,"skein1024-888":46031,"skein1024-896":46032,"skein1024-904":46033,"skein1024-912":46034,"skein1024-920":46035,"skein1024-928":46036,"skein1024-936":46037,"skein1024-944":46038,"skein1024-952":46039,"skein1024-960":46040,"skein1024-968":46041,"skein1024-976":46042,"skein1024-984":46043,"skein1024-992":46044,"skein1024-1000":46045,"skein1024-1008":46046,"skein1024-1016":46047,"skein1024-1024":46048,"poseidon-bls12_381-a2-fc1":46081,"poseidon-bls12_381-a2-fc1-sc":46082});oM.exports={names:Xae}});function Jae(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var o=r.charAt(s),i=o.charCodeAt(0);if(t[i]!==255)throw new TypeError(o+" is ambiguous");t[i]=s}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function f(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var m=0,y=0,b=0,w=p.length;b!==w&&p[b]===0;)b++,m++;for(var E=(w-b)*u+1>>>0,x=new Uint8Array(E);b!==w;){for(var v=p[b],S=0,A=E-1;(v!==0||S<y)&&A!==-1;A--,S++)v+=256*x[A]>>>0,x[A]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");y=S,b++}for(var _=E-y;_!==E&&x[_]===0;)_++;for(var D=c.repeat(m);_<E;++_)D+=r.charAt(x[_]);return D}function h(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var m=0;if(p[m]!==" "){for(var y=0,b=0;p[m]===c;)y++,m++;for(var w=(p.length-m)*l+1>>>0,E=new Uint8Array(w);p[m];){var x=t[p.charCodeAt(m)];if(x===255)return;for(var v=0,S=w-1;(x!==0||v<b)&&S!==-1;S--,v++)x+=a*E[S]>>>0,E[S]=x%256>>>0,x=x/256>>>0;if(x!==0)throw new Error("Non-zero carry");b=v,m++}if(p[m]!==" "){for(var A=w-b;A!==w&&E[A]===0;)A++;for(var _=new Uint8Array(y+(w-A)),D=y;A!==w;)_[D++]=E[A++];return _}}}function d(p){var m=h(p);if(m)return m;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:h,decode:d}}var Zae,ece,aM,cM=st(()=>{Zae=Jae,ece=Zae,aM=ece});var fje,lM,Ci,uM,fM,Ga=st(()=>{fje=new Uint8Array(0),lM=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Ci=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},uM=r=>new TextEncoder().encode(r),fM=r=>new TextDecoder().decode(r)});var A7,R7,I7,pM,T7,Qf,Wa,tce,rce,qt,Vs=st(()=>{cM();Ga();A7=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},R7=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return pM(this,e)}},I7=class{constructor(e){this.decoders=e}or(e){return pM(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},pM=(r,e)=>new I7({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}}),T7=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new A7(e,t,n),this.decoder=new R7(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},Qf=({name:r,prefix:e,encode:t,decode:n})=>new T7(r,e,t,n),Wa=({prefix:r,name:e,alphabet:t})=>{let{encode:n,decode:s}=aM(t,e);return Qf({prefix:r,name:e,encode:n,decode:o=>Ci(s(o))})},tce=(r,e,t,n)=>{let s={};for(let u=0;u<e.length;++u)s[e[u]]=u;let o=r.length;for(;r[o-1]==="=";)--o;let i=new Uint8Array(o*t/8|0),a=0,c=0,l=0;for(let u=0;u<o;++u){let f=s[r[u]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|f,a+=t,a>=8&&(a-=8,i[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return i},rce=(r,e,t)=>{let n=e[e.length-1]==="=",s=(1<<t)-1,o="",i=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],i+=8;i>t;)i-=t,o+=e[s&a>>i];if(i&&(o+=e[s&a<<t-i]),n)for(;o.length*t&7;)o+="=";return o},qt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Qf({prefix:e,name:r,encode(s){return rce(s,n,t)},decode(s){return tce(s,n,t,r)}})});var k7={};V(k7,{identity:()=>nce});var nce,dM=st(()=>{Vs();Ga();nce=Qf({prefix:"\0",name:"identity",encode:r=>fM(r),decode:r=>uM(r)})});var D7={};V(D7,{base2:()=>sce});var sce,mM=st(()=>{Vs();sce=qt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1})});var P7={};V(P7,{base8:()=>oce});var oce,yM=st(()=>{Vs();oce=qt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3})});var C7={};V(C7,{base10:()=>ice});var ice,gM=st(()=>{Vs();ice=Wa({prefix:"9",name:"base10",alphabet:"0123456789"})});var B7={};V(B7,{base16:()=>ace,base16upper:()=>cce});var ace,cce,bM=st(()=>{Vs();ace=qt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),cce=qt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4})});var N7={};V(N7,{base32:()=>Xf,base32hex:()=>hce,base32hexpad:()=>dce,base32hexpadupper:()=>mce,base32hexupper:()=>pce,base32pad:()=>uce,base32padupper:()=>fce,base32upper:()=>lce,base32z:()=>yce});var Xf,lce,uce,fce,hce,pce,dce,mce,yce,L7=st(()=>{Vs();Xf=qt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),lce=qt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),uce=qt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),fce=qt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),hce=qt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),pce=qt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),dce=qt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),mce=qt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),yce=qt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5})});var O7={};V(O7,{base36:()=>gce,base36upper:()=>bce});var gce,bce,wM=st(()=>{Vs();gce=Wa({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),bce=Wa({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"})});var K7={};V(K7,{base58btc:()=>ko,base58flickr:()=>wce});var ko,wce,M7=st(()=>{Vs();ko=Wa({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),wce=Wa({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"})});var U7={};V(U7,{base64:()=>Ece,base64pad:()=>vce,base64url:()=>xce,base64urlpad:()=>Sce});var Ece,vce,xce,Sce,EM=st(()=>{Vs();Ece=qt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),vce=qt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),xce=qt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Sce=qt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6})});var F7={};V(F7,{base256emoji:()=>Tce});function Rce(r){return r.reduce((e,t)=>(e+=_ce[t],e),"")}function Ice(r){let e=[];for(let t of r){let n=Ace[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}var vM,_ce,Ace,Tce,xM=st(()=>{Vs();vM=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),_ce=vM.reduce((r,e,t)=>(r[t]=e,r),[]),Ace=vM.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);Tce=Qf({prefix:"\u{1F680}",name:"base256emoji",encode:Rce,decode:Ice})});function AM(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Cce;)e[t++]=r&255|SM,r/=128;for(;r&Pce;)e[t++]=r&255|SM,r>>>=7;return e[t]=r|0,AM.bytes=t-n+1,e}function V7(r,n){var t=0,n=n||0,s=0,o=n,i,a=r.length;do{if(o>=a)throw V7.bytes=0,new RangeError("Could not decode varint");i=r[o++],t+=s<28?(i&_M)<<s:(i&_M)*Math.pow(2,s),s+=7}while(i>=Nce);return V7.bytes=o-n,t}var kce,SM,Dce,Pce,Cce,Bce,Nce,_M,Lce,Oce,Kce,Mce,Uce,Fce,Vce,qce,Hce,zce,$ce,Gce,qd,RM=st(()=>{kce=AM,SM=128,Dce=127,Pce=~Dce,Cce=Math.pow(2,31);Bce=V7,Nce=128,_M=127;Lce=Math.pow(2,7),Oce=Math.pow(2,14),Kce=Math.pow(2,21),Mce=Math.pow(2,28),Uce=Math.pow(2,35),Fce=Math.pow(2,42),Vce=Math.pow(2,49),qce=Math.pow(2,56),Hce=Math.pow(2,63),zce=function(r){return r<Lce?1:r<Oce?2:r<Kce?3:r<Mce?4:r<Uce?5:r<Fce?6:r<Vce?7:r<qce?8:r<Hce?9:10},$ce={encode:kce,decode:Bce,encodingLength:zce},Gce=$ce,qd=Gce});var Hd,Jf,Zf,wg=st(()=>{RM();Hd=(r,e=0)=>[qd.decode(r,e),qd.decode.bytes],Jf=(r,e,t=0)=>(qd.encode(r,e,t),e),Zf=r=>qd.encodingLength(r)});var yl,IM,TM,eh,$d=st(()=>{Ga();wg();yl=(r,e)=>{let t=e.byteLength,n=Zf(r),s=n+Zf(t),o=new Uint8Array(s+t);return Jf(r,o,0),Jf(t,o,n),o.set(e,s),new eh(r,t,e,o)},IM=r=>{let e=Ci(r),[t,n]=Hd(e),[s,o]=Hd(e.subarray(n)),i=e.subarray(n+o);if(i.byteLength!==s)throw new Error("Incorrect length");return new eh(t,s,i,e)},TM=(r,e)=>r===e?!0:r.code===e.code&&r.size===e.size&&lM(r.bytes,e.bytes),eh=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}}});var H7,q7,z7=st(()=>{$d();H7=({name:r,code:e,encode:t})=>new q7(r,e,t),q7=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?yl(this.code,t):t.then(n=>yl(this.code,n))}else throw Error("Unknown type, must be binary type")}}});var $7={};V($7,{sha256:()=>Wce,sha512:()=>Yce});var DM,Wce,Yce,PM=st(()=>{z7();DM=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Wce=H7({name:"sha2-256",code:18,encode:DM("SHA-256")}),Yce=H7({name:"sha2-512",code:19,encode:DM("SHA-512")})});var G7={};V(G7,{identity:()=>Xce});var CM,jce,BM,Qce,Xce,NM=st(()=>{Ga();$d();CM=0,jce="identity",BM=Ci,Qce=r=>yl(CM,BM(r)),Xce={code:CM,name:jce,encode:BM,digest:Qce}});var LM=st(()=>{Ga()});var Cje,Bje,OM=st(()=>{Cje=new TextEncoder,Bje=new TextDecoder});var xg,ele,tle,rle,Gd,nle,KM,MM,Eg,vg,sle,ole,ile,UM=st(()=>{wg();$d();M7();L7();Ga();xg=class r{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this.byteOffset=s.byteOffset,this.byteLength=s.byteLength,this.asCID=this,this._baseCache=new Map,Object.defineProperties(this,{byteOffset:vg,byteLength:vg,code:Eg,version:Eg,multihash:Eg,bytes:Eg,_baseCache:vg,asCID:vg})}toV0(){switch(this.version){case 0:return this;default:{let{code:e,multihash:t}=this;if(e!==Gd)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==nle)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=yl(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}equals(e){return e&&this.code===e.code&&this.version===e.version&&TM(this.multihash,e.multihash)}toString(e){let{bytes:t,version:n,_baseCache:s}=this;switch(n){case 0:return tle(t,s,e||ko.encoder);default:return rle(t,s,e||Xf.encoder)}}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID("+this.toString()+")"}static isCID(e){return ole(/^0\.0/,ile),!!(e&&(e[MM]||e.asCID===e))}get toBaseEncodedString(){throw new Error("Deprecated, use .toString()")}get codec(){throw new Error('"codec" property is deprecated, use integer "code" property instead')}get buffer(){throw new Error("Deprecated .buffer property, use .bytes to get Uint8Array instead")}get multibaseName(){throw new Error('"multibaseName" property is deprecated')}get prefix(){throw new Error('"prefix" property is deprecated')}static asCID(e){if(e instanceof r)return e;if(e!=null&&e.asCID===e){let{version:t,code:n,multihash:s,bytes:o}=e;return new r(t,n,s,o||KM(t,n,s.bytes))}else if(e!=null&&e[MM]===!0){let{version:t,multihash:n,code:s}=e,o=IM(n);return r.create(t,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");switch(e){case 0:{if(t!==Gd)throw new Error(`Version 0 CID must use dag-pb (code: ${Gd}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let s=KM(e,t,n.bytes);return new r(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,Gd,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,s=Ci(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");let o=s.subarray(t.multihashSize-t.digestSize),i=new eh(t.multihashCode,t.digestSize,o,s);return[t.version===0?r.createV0(i):r.createV1(t.codec,i),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[f,h]=Hd(e.subarray(t));return t+=h,f},s=n(),o=Gd;if(s===18?(s=0,t=0):s===1&&(o=n()),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);let i=t,a=n(),c=n(),l=t+c,u=l-i;return{version:s,codec:o,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){let[n,s]=ele(e,t),o=r.decode(s);return o._baseCache.set(n,e),o}},ele=(r,e)=>{switch(r[0]){case"Q":{let t=e||ko;return[ko.prefix,t.decode(`${ko.prefix}${r}`)]}case ko.prefix:{let t=e||ko;return[ko.prefix,t.decode(r)]}case Xf.prefix:{let t=e||Xf;return[Xf.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},tle=(r,e,t)=>{let{prefix:n}=t;if(n!==ko.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let s=e.get(n);if(s==null){let o=t.encode(r).slice(1);return e.set(n,o),o}else return s},rle=(r,e,t)=>{let{prefix:n}=t,s=e.get(n);if(s==null){let o=t.encode(r);return e.set(n,o),o}else return s},Gd=112,nle=18,KM=(r,e,t)=>{let n=Zf(r),s=n+Zf(e),o=new Uint8Array(s+t.byteLength);return Jf(r,o,0),Jf(e,o,n),o.set(t,s),o},MM=Symbol.for("@ipld/js-cid/CID"),Eg={writable:!1,configurable:!1,enumerable:!0},vg={writable:!1,enumerable:!1,configurable:!1},sle="0.0.0-dev",ole=(r,e)=>{if(r.test(sle))console.warn(e);else throw new Error(e)},ile=`CID.isCID(v) is deprecated and will be removed in the next major release.
Following code pattern:

if (CID.isCID(value)) {
  doSomethingWithCID(value)
}

Is replaced with:

const cid = CID.asCID(value)
if (cid) {
  // Make sure to use cid instead of value
  doSomethingWithCID(cid)
}
`});var FM=st(()=>{UM();wg();Ga();z7();$d()});var W7,Vje,VM=st(()=>{dM();mM();yM();gM();bM();L7();wM();M7();EM();xM();PM();NM();LM();OM();FM();W7={...k7,...D7,...P7,...C7,...B7,...N7,...O7,...K7,...U7,...F7},Vje={...$7,...G7}});function th(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}var Sg=st(()=>{});function _g(r=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?th(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}var Y7=st(()=>{Sg()});function HM(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var qM,j7,ale,Ag,Q7=st(()=>{VM();Y7();qM=HM("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),j7=HM("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=_g(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),ale={utf8:qM,"utf-8":qM,hex:W7.base16,latin1:j7,ascii:j7,binary:j7,...W7},Ag=ale});var zM={};V(zM,{toString:()=>cle});function cle(r,e="utf8"){let t=Ag[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):t.encoder.encode(r).substring(1)}var $M=st(()=>{Q7()});var GM={};V(GM,{fromString:()=>lle});function lle(r,e="utf8"){let t=Ag[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?th(globalThis.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}var WM=st(()=>{Q7();Sg()});var YM={};V(YM,{concat:()=>ule});function ule(r,e){e||(e=r.reduce((s,o)=>s+o.length,0));let t=_g(e),n=0;for(let s of r)t.set(s,n),n+=s.length;return th(t)}var jM=st(()=>{Y7();Sg()});var J7=Y((eQe,tU)=>{"use strict";var QM=WK(),rh=sM(),{names:Wd}=iM(),{toString:Rg}=($M(),t0(zM)),{fromString:fle}=(WM(),t0(GM)),{concat:hle}=(jM(),t0(YM)),nh={};for(let r in Wd){let e=r;nh[Wd[e]]=e}Object.freeze(nh);function ple(r){if(!(r instanceof Uint8Array))throw new Error("must be passed a Uint8Array");return Rg(r,"base16")}function dle(r){return fle(r,"base16")}function mle(r){if(!(r instanceof Uint8Array))throw new Error("must be passed a Uint8Array");return Rg(QM.encode("base58btc",r)).slice(1)}function yle(r){let e=r instanceof Uint8Array?Rg(r):r;return QM.decode("z"+e)}function XM(r){if(!(r instanceof Uint8Array))throw new Error("multihash must be a Uint8Array");if(r.length<2)throw new Error("multihash too short. must be > 2 bytes.");let e=rh.decode(r);if(!ZM(e))throw new Error(`multihash unknown function code: 0x${e.toString(16)}`);r=r.slice(rh.decode.bytes);let t=rh.decode(r);if(t<0)throw new Error(`multihash invalid length: ${t}`);if(r=r.slice(rh.decode.bytes),r.length!==t)throw new Error(`multihash length inconsistent: 0x${Rg(r,"base16")}`);return{code:e,name:nh[e],length:t,digest:r}}function gle(r,e,t){if(!r||e===void 0)throw new Error("multihash encode requires at least two args: digest, code");let n=JM(e);if(!(r instanceof Uint8Array))throw new Error("digest should be a Uint8Array");if(t==null&&(t=r.length),t&&r.length!==t)throw new Error("digest length should be equal to specified length.");let s=rh.encode(n),o=rh.encode(t);return hle([s,o,r],s.length+o.length+r.length)}function JM(r){let e=r;if(typeof r=="string"){if(Wd[r]===void 0)throw new Error(`Unrecognized hash function named: ${r}`);e=Wd[r]}if(typeof e!="number")throw new Error(`Hash function code should be a number. Got: ${e}`);if(nh[e]===void 0&&!X7(e))throw new Error(`Unrecognized function code: ${e}`);return e}function X7(r){return r>0&&r<16}function ZM(r){return!!(X7(r)||nh[r])}function eU(r){XM(r)}function ble(r){return eU(r),r.subarray(0,2)}tU.exports={names:Wd,codes:nh,toHexString:ple,fromHexString:dle,toB58String:mle,fromB58String:yle,decode:XM,encode:gle,coerceCode:JM,isAppCode:X7,validate:eU,prefix:ble,isValidCode:ZM}});var bU=Y(Dg=>{"use strict";Object.defineProperty(Dg,"__esModule",{value:!0});var rv=class{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;let t={value:e,done:!1};if(this.pullQueue.length){let n=this.pullQueue.shift();n&&n.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(let e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(let t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{let t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{let t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,s)=>{this.pullQueue.push({resolve:n,reject:s})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}},kg=class{constructor(e,{highWaterMark:t=100,lowWaterMark:n=1}={}){let s=new rv;s.highWaterMark=t,s.lowWaterMark=n,s.removeCallback=e({push:o=>s.push(o),stop:()=>s.stop(),fail:o=>s.fail(o),on:(o,i)=>{s.eventHandlers[o]=i}})||(()=>{}),this[Symbol.asyncIterator]=()=>s[Symbol.asyncIterator](),Object.freeze(this)}};Dg.EventIterator=kg;Dg.default=kg});var wU=Y(Yd=>{"use strict";Object.defineProperty(Yd,"__esModule",{value:!0});var nv=bU();Yd.EventIterator=nv.EventIterator;function Rle(r,e,t){return new nv.EventIterator(({push:n})=>(this.addEventListener(r,n,e),()=>this.removeEventListener(r,n,e)),t)}Yd.subscribe=Rle;Yd.default=nv.EventIterator});var PF=Y(($et,DF)=>{"use strict";DF.exports=kF;var yue=x3(),Qa=kF.prototype,gue=new Date%1e9;function bue(){return(Math.random()*1e9>>>0)+gue++}function kF(r){r=r||{},this.id=r.id||bue(),this.max=r.max||1/0,this.items=r.items||[],this._lookup={},this.size=this.items.length,this.lastModified=new Date(r.lastModified||new Date);for(var e,t,n=this.items.length;n--;)e=this.items[n],t=new Date(e.expires)-new Date,this._lookup[e.key]=e,t>0?this.expire(e.key,t):t<=0&&this.delete(e.key)}Qa.has=function(r){return r in this._lookup};Qa.get=function(r){if(!this.has(r))return null;var e=this._lookup[r];return e.refresh&&this.expire(r,e.refresh),this.items.splice(this.items.indexOf(e),1),this.items.push(e),e.value};Qa.meta=function(r){if(!this.has(r))return null;var e=this._lookup[r];return"meta"in e?e.meta:null};Qa.set=function(r,e,t){var n=this._lookup[r],s=this._lookup[r]={key:r,value:e};return this.lastModified=new Date,n?(clearTimeout(n.timeout),this.items.splice(this.items.indexOf(n),1,s)):(this.size>=this.max&&this.delete(this.items[0].key),this.items.push(s),this.size++),t&&("ttl"in t&&this.expire(r,t.ttl),"meta"in t&&(s.meta=t.meta),t.refresh&&(s.refresh=t.ttl)),this};Qa.delete=function(r){var e=this._lookup[r];return e?(this.lastModified=new Date,this.items.splice(this.items.indexOf(e),1),clearTimeout(e.timeout),delete this._lookup[r],this.size--,this):!1};Qa.expire=function(r,e){var t=e||0,n=this._lookup[r];if(!n)return this;if(typeof t=="string"&&(t=yue(e)),typeof t!="number")throw new TypeError("Expiration time must be a string or number.");return clearTimeout(n.timeout),n.timeout=setTimeout(this.delete.bind(this,n.key),t),n.expires=Number(new Date)+t,this};Qa.clear=function(){for(var r=this.items.length;r--;)this.delete(this.items[r].key);return this};Qa.toJSON=function(){for(var r=new Array(this.items.length),e,t=r.length;t--;)e=this.items[t],r[t]={key:e.key,meta:e.meta,value:e.value,expires:e.expires,refresh:e.refresh};return{id:this.id,max:isFinite(this.max)?this.max:void 0,lastModified:this.lastModified,items:r}}});var Uue={};V(Uue,{createHelia:()=>Kue,libp2pDefaults:()=>Lg});var Sl={};V(Sl,{abortedError:()=>lV,closeFailedError:()=>iV,deleteFailedError:()=>Jv,getFailedError:()=>aV,hasFailedError:()=>cV,notFoundError:()=>bh,openFailedError:()=>oV,putFailedError:()=>Xv});var Lo=fe(No(),1);function oV(r){return r=r??new Error("Open failed"),(0,Lo.default)(r,"ERR_OPEN_FAILED")}function iV(r){return r=r??new Error("Close failed"),(0,Lo.default)(r,"ERR_CLOSE_FAILED")}function Xv(r){return r=r??new Error("Put failed"),(0,Lo.default)(r,"ERR_PUT_FAILED")}function aV(r){return r=r??new Error("Get failed"),(0,Lo.default)(r,"ERR_GET_FAILED")}function Jv(r){return r=r??new Error("Delete failed"),(0,Lo.default)(r,"ERR_DELETE_FAILED")}function cV(r){return r=r??new Error("Has failed"),(0,Lo.default)(r,"ERR_HAS_FAILED")}function bh(r){return r=r??new Error("Not Found"),(0,Lo.default)(r,"ERR_NOT_FOUND")}function lV(r){return r=r??new Error("Aborted"),(0,Lo.default)(r,"ERR_ABORTED")}var Za=class{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(let{cid:n,block:s}of e)await this.put(n,s,t),yield n}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(let n of e)yield{cid:n,block:await this.get(n,t)}}async delete(e,t){await Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(let n of e)await this.delete(n,t),yield n}async*getAll(e){throw new Error(".getAll is not implemented")}};var y3={};V(y3,{base32:()=>nr,base32hex:()=>bV,base32hexpad:()=>EV,base32hexpadupper:()=>vV,base32hexupper:()=>wV,base32pad:()=>yV,base32padupper:()=>gV,base32upper:()=>mV,base32z:()=>xV});var Hue=new Uint8Array(0);function Zv(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function Oo(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function e9(r){return new TextEncoder().encode(r)}function t9(r){return new TextDecoder().decode(r)}function uV(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var o=r.charAt(s),i=o.charCodeAt(0);if(t[i]!==255)throw new TypeError(o+" is ambiguous");t[i]=s}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function f(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var m=0,y=0,b=0,w=p.length;b!==w&&p[b]===0;)b++,m++;for(var E=(w-b)*u+1>>>0,x=new Uint8Array(E);b!==w;){for(var v=p[b],S=0,A=E-1;(v!==0||S<y)&&A!==-1;A--,S++)v+=256*x[A]>>>0,x[A]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");y=S,b++}for(var _=E-y;_!==E&&x[_]===0;)_++;for(var D=c.repeat(m);_<E;++_)D+=r.charAt(x[_]);return D}function h(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var m=0;if(p[m]!==" "){for(var y=0,b=0;p[m]===c;)y++,m++;for(var w=(p.length-m)*l+1>>>0,E=new Uint8Array(w);p[m];){var x=t[p.charCodeAt(m)];if(x===255)return;for(var v=0,S=w-1;(x!==0||v<b)&&S!==-1;S--,v++)x+=a*E[S]>>>0,E[S]=x%256>>>0,x=x/256>>>0;if(x!==0)throw new Error("Non-zero carry");b=v,m++}if(p[m]!==" "){for(var A=w-b;A!==w&&E[A]===0;)A++;for(var _=new Uint8Array(y+(w-A)),D=y;A!==w;)_[D++]=E[A++];return _}}}function d(p){var m=h(p);if(m)return m;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:h,decode:d}}var fV=uV,hV=fV,n9=hV;var h3=class{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},p3=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return s9(this,e)}},d3=class{decoders;constructor(e){this.decoders=e}or(e){return s9(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function s9(r,e){return new d3({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}var m3=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new h3(e,t,n),this.decoder=new p3(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function _l({name:r,prefix:e,encode:t,decode:n}){return new m3(r,e,t,n)}function Mi({name:r,prefix:e,alphabet:t}){let{encode:n,decode:s}=n9(t,r);return _l({prefix:e,name:r,encode:n,decode:o=>Oo(s(o))})}function pV(r,e,t,n){let s={};for(let u=0;u<e.length;++u)s[e[u]]=u;let o=r.length;for(;r[o-1]==="=";)--o;let i=new Uint8Array(o*t/8|0),a=0,c=0,l=0;for(let u=0;u<o;++u){let f=s[r[u]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|f,a+=t,a>=8&&(a-=8,i[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return i}function dV(r,e,t){let n=e[e.length-1]==="=",s=(1<<t)-1,o="",i=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],i+=8;i>t;)i-=t,o+=e[s&a>>i];if(i!==0&&(o+=e[s&a<<t-i]),n)for(;o.length*t&7;)o+="=";return o}function Nt({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return _l({prefix:e,name:r,encode(s){return dV(s,n,t)},decode(s){return pV(s,n,t,r)}})}var nr=Nt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),mV=Nt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),yV=Nt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),gV=Nt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),bV=Nt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),wV=Nt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),EV=Nt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),vV=Nt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),xV=Nt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var g3={};V(g3,{base58btc:()=>Fe,base58flickr:()=>SV});var Fe=Mi({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),SV=Mi({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var cs={};V(cs,{Digest:()=>ec,create:()=>as,decode:()=>qs,equals:()=>w3});var _V=a9,o9=128,AV=127,RV=~AV,IV=Math.pow(2,31);function a9(r,e,t){e=e||[],t=t||0;for(var n=t;r>=IV;)e[t++]=r&255|o9,r/=128;for(;r&RV;)e[t++]=r&255|o9,r>>>=7;return e[t]=r|0,a9.bytes=t-n+1,e}var TV=b3,kV=128,i9=127;function b3(r,n){var t=0,n=n||0,s=0,o=n,i,a=r.length;do{if(o>=a)throw b3.bytes=0,new RangeError("Could not decode varint");i=r[o++],t+=s<28?(i&i9)<<s:(i&i9)*Math.pow(2,s),s+=7}while(i>=kV);return b3.bytes=o-n,t}var DV=Math.pow(2,7),PV=Math.pow(2,14),CV=Math.pow(2,21),BV=Math.pow(2,28),NV=Math.pow(2,35),LV=Math.pow(2,42),OV=Math.pow(2,49),KV=Math.pow(2,56),MV=Math.pow(2,63),UV=function(r){return r<DV?1:r<PV?2:r<CV?3:r<BV?4:r<NV?5:r<LV?6:r<OV?7:r<KV?8:r<MV?9:10},FV={encode:_V,decode:TV,encodingLength:UV},VV=FV,wh=VV;function Eh(r,e=0){return[wh.decode(r,e),wh.decode.bytes]}function Al(r,e,t=0){return wh.encode(r,e,t),e}function Rl(r){return wh.encodingLength(r)}function as(r,e){let t=e.byteLength,n=Rl(r),s=n+Rl(t),o=new Uint8Array(s+t);return Al(r,o,0),Al(t,o,n),o.set(e,s),new ec(r,t,e,o)}function qs(r){let e=Oo(r),[t,n]=Eh(e),[s,o]=Eh(e.subarray(n)),i=e.subarray(n+o);if(i.byteLength!==s)throw new Error("Incorrect length");return new ec(t,s,i,e)}function w3(r,e){if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Zv(r.bytes,t.bytes)}}var ec=class{code;size;digest;bytes;constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function c9(r,e){let{bytes:t,version:n}=r;switch(n){case 0:return HV(t,E3(r),e??Fe.encoder);default:return zV(t,E3(r),e??nr.encoder)}}var l9=new WeakMap;function E3(r){let e=l9.get(r);if(e==null){let t=new Map;return l9.set(r,t),t}return e}var Ve=class r{code;version;multihash;bytes;"/";constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==vh)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==$V)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=as(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n!=null&&e.code===n.code&&e.version===n.version&&w3(e.multihash,n.multihash)}toString(e){return c9(this,e)}toJSON(){return{"/":c9(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:s,multihash:o,bytes:i}=t;return new r(n,s,o,i??u9(n,s,o.bytes))}else if(t[GV]===!0){let{version:n,multihash:s,code:o}=t,i=qs(s);return r.create(n,o,i)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==vh)throw new Error(`Version 0 CID must use dag-pb (code: ${vh}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let s=u9(e,t,n.bytes);return new r(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,vh,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,s=Oo(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");let o=s.subarray(t.multihashSize-t.digestSize),i=new ec(t.multihashCode,t.digestSize,o,s);return[t.version===0?r.createV0(i):r.createV1(t.codec,i),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[f,h]=Eh(e.subarray(t));return t+=h,f},s=n(),o=vh;if(s===18?(s=0,t=0):o=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);let i=t,a=n(),c=n(),l=t+c,u=l-i;return{version:s,codec:o,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){let[n,s]=qV(e,t),o=r.decode(s);if(o.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return E3(o).set(n,e),o}};function qV(r,e){switch(r[0]){case"Q":{let t=e??Fe;return[Fe.prefix,t.decode(`${Fe.prefix}${r}`)]}case Fe.prefix:{let t=e??Fe;return[Fe.prefix,t.decode(r)]}case nr.prefix:{let t=e??nr;return[nr.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function HV(r,e,t){let{prefix:n}=t;if(n!==Fe.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let s=e.get(n);if(s==null){let o=t.encode(r).slice(1);return e.set(n,o),o}else return s}function zV(r,e,t){let{prefix:n}=t,s=e.get(n);if(s==null){let o=t.encode(r);return e.set(n,o),o}else return s}var vh=112,$V=18;function u9(r,e,t){let n=Rl(r),s=n+Rl(e),o=new Uint8Array(s+t.byteLength);return Al(r,o,0),Al(e,o,n),o.set(t,s),o}var GV=Symbol.for("@ipld/js-cid/CID");var n0=85;var xh=class extends Za{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set(nr.encode(e.multihash.bytes),t),e}get(e){let t=this.data.get(nr.encode(e.multihash.bytes));if(t==null)throw bh();return t}has(e){return this.data.has(nr.encode(e.multihash.bytes))}async delete(e){this.data.delete(nr.encode(e.multihash.bytes))}async*getAll(){for(let[e,t]of this.data.entries())yield{cid:Ve.createV1(n0,qs(nr.decode(e))),block:t}}};var yn=fe(i0(),1);var _3={};V(_3,{base64:()=>qe,base64pad:()=>oq,base64url:()=>S3,base64urlpad:()=>iq});var qe=Nt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),oq=Nt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),S3=Nt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),iq=Nt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});yn.default.formatters.b=r=>r==null?"undefined":Fe.baseEncode(r);yn.default.formatters.t=r=>r==null?"undefined":nr.baseEncode(r);yn.default.formatters.m=r=>r==null?"undefined":qe.baseEncode(r);yn.default.formatters.p=r=>r==null?"undefined":r.toString();yn.default.formatters.c=r=>r==null?"undefined":r.toString();yn.default.formatters.k=r=>r==null?"undefined":r.toString();yn.default.formatters.a=r=>r==null?"undefined":r.toString();function aq(r){let e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function Dl(){return{forComponent(r){return ls(r)}}}function ls(r){let e=aq(`${r}:trace`);return yn.default.enabled(`${r}:trace`)&&yn.default.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=(0,yn.default)(`${r}:trace`)),Object.assign((0,yn.default)(r),{error:(0,yn.default)(`${r}:error`),trace:e})}function cq(r){return r[Symbol.asyncIterator]!=null}function lq(r){if(cq(r))return(async()=>{for await(let e of r);})();for(let e of r);}var Nn=lq;function uq(r){let[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:s=>{n.push(s)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}var Pl=uq;function fq(r){return r[Symbol.asyncIterator]!=null}function hq(r,e){if(fq(r))return async function*(){for await(let a of r)await e(a)&&(yield a)}();let t=Pl(r),{value:n,done:s}=t.next();if(s===!0)return function*(){}();let o=e(n);if(typeof o.then=="function")return async function*(){await o&&(yield n);for await(let a of t)await e(a)&&(yield a)}();let i=e;return function*(){o===!0&&(yield n);for(let a of t)i(a)&&(yield a)}()}var us=hq;function xe(){let r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}var a0=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},Cl=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new a0(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new a0(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var A3=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function Tt(r={}){return pq(t=>{let n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function pq(r,e){e=e??{};let t=e.onEnd,n=new Cl,s,o,i,a=xe(),c=async()=>{try{return n.isEmpty()?i?{done:!0}:await new Promise((y,b)=>{o=w=>{o=null,n.push(w);try{y(r(n))}catch(E){b(E)}return s}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=xe()})}},l=y=>o!=null?o(y):(n.push(y),s),u=y=>(n=new Cl,o!=null?o({error:y}):(n.push({error:y}),s)),f=y=>{if(i)return s;if(e?.objectMode!==!0&&y?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:y})},h=y=>i?s:(i=!0,y!=null?u(y):l({done:!0})),d=()=>(n=new Cl,h(),{done:!0}),p=y=>(h(y),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:d,throw:p,push:f,end:h,get readableLength(){return n.size},onEmpty:async y=>{let b=y?.signal;if(b?.throwIfAborted(),n.isEmpty())return;let w,E;b!=null&&(w=new Promise((x,v)=>{E=()=>{v(new A3)},b.addEventListener("abort",E)}));try{await Promise.race([a.promise,w])}finally{E!=null&&b!=null&&b?.removeEventListener("abort",E)}}},t==null)return s;let m=s;return s={[Symbol.asyncIterator](){return this},next(){return m.next()},throw(y){return m.throw(y),t!=null&&(t(y),t=void 0),{done:!0}},return(){return m.return(),t!=null&&(t(),t=void 0),{done:!0}},push:f,end(y){return m.end(y),t!=null&&(t(y),t=void 0),s},get readableLength(){return m.readableLength},onEmpty:y=>m.onEmpty(y)},s}function dq(r){return r[Symbol.asyncIterator]!=null}function mq(...r){let e=[];for(let t of r)dq(t)||e.push(t);return e.length===r.length?function*(){for(let t of e)yield*t}():async function*(){let t=Tt({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(r.map(async n=>{for await(let s of n)t.push(s)})),t.end()}catch(n){t.end(n)}}),yield*t}()}var fs=mq;var Mfe=ls("blockstore:core:tiered");var qfe={...Sl};var d9=fe(No(),1);function c0(r){return r=r??new Error("Not Found"),(0,d9.default)(r,"ERR_NOT_FOUND")}function Hs(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}var R3={};V(R3,{base10:()=>yq});var yq=Mi({prefix:"9",name:"base10",alphabet:"0123456789"});var I3={};V(I3,{base16:()=>gq,base16upper:()=>bq});var gq=Nt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),bq=Nt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var T3={};V(T3,{base2:()=>wq});var wq=Nt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var k3={};V(k3,{base256emoji:()=>_q});var m9=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),Eq=m9.reduce((r,e,t)=>(r[t]=e,r),[]),vq=m9.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function xq(r){return r.reduce((e,t)=>(e+=Eq[t],e),"")}function Sq(r){let e=[];for(let t of r){let n=vq[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}var _q=_l({prefix:"\u{1F680}",name:"base256emoji",encode:xq,decode:Sq});var D3={};V(D3,{base36:()=>Ui,base36upper:()=>Aq});var Ui=Mi({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Aq=Mi({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var P3={};V(P3,{base8:()=>Rq});var Rq=Nt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var C3={};V(C3,{identity:()=>Iq});var Iq=_l({prefix:"\0",name:"identity",encode:r=>t9(r),decode:r=>e9(r)});var nhe=new TextEncoder,she=new TextDecoder;var y9=512;var B3={};V(B3,{identity:()=>Lt});var b9=0,Tq="identity",w9=Oo;function kq(r){return as(b9,w9(r))}var Lt={code:b9,name:Tq,encode:w9,digest:kq};var K3={};V(K3,{sha256:()=>$,sha512:()=>O3});function L3({name:r,code:e,encode:t}){return new N3(r,e,t)}var N3=class{name;code;encode;constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?as(this.code,t):t.then(n=>as(this.code,n))}else throw Error("Unknown type, must be binary type")}};function v9(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}var $=L3({name:"sha2-256",code:18,encode:v9("SHA-256")}),O3=L3({name:"sha2-512",code:19,encode:v9("SHA-512")});var Ln={...C3,...T3,...P3,...R3,...I3,...y3,...D3,...g3,..._3,...k3},yhe={...K3,...B3};function Pe(r=0){return globalThis.Buffer?.alloc!=null?Hs(globalThis.Buffer.alloc(r)):new Uint8Array(r)}function kt(r=0){return globalThis.Buffer?.allocUnsafe!=null?Hs(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function S9(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var x9=S9("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),M3=S9("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=kt(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),Dq={utf8:x9,"utf-8":x9,hex:Ln.base16,latin1:M3,ascii:M3,binary:M3,...Ln},l0=Dq;function R(r,e="utf8"){let t=l0[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?Hs(globalThis.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}function T(r,e="utf8"){let t=l0[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):t.encoder.encode(r).substring(1)}var Ko="/",_9=new TextEncoder().encode(Ko),u0=_9[0],ct=class r{_buf;constructor(e,t){if(typeof e=="string")this._buf=R(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==u0)throw new Error("Invalid key")}toString(e="utf8"){return T(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new r(e.join(Ko))}static random(){return new r(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new r(e):typeof e.uint8Array=="function"?new r(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=_9),this._buf[0]!==u0){let e=new Uint8Array(this._buf.byteLength+1);e.fill(u0,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===u0;)this._buf=this._buf.subarray(0,-1)}less(e){let t=this.list(),n=e.list();for(let s=0;s<t.length;s++){if(n.length<s+1)return!1;let o=t[s],i=n[s];if(o<i)return!0;if(o>i)return!1}return t.length<n.length}reverse(){return r.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Ko).slice(1)}type(){return Pq(this.baseNamespace())}name(){return Cq(this.baseNamespace())}instance(e){return new r(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(Ko)||(e+=Ko),e+=this.type(),new r(e)}parent(){let e=this.list();return e.length===1?new r(Ko):new r(e.slice(0,-1).join(Ko))}child(e){return this.toString()===Ko?e:e.toString()===Ko?this:new r(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return r.withNamespaces([...this.namespaces(),...Bq(e.map(t=>t.namespaces()))])}};function Pq(r){let e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function Cq(r){let e=r.split(":");return e[e.length-1]}function Bq(r){return[].concat(...r)}var A9="SHARDING";function Lq(r){return r[Symbol.asyncIterator]!=null}function Oq(r){if(Lq(r))return(async()=>{let t=[];for await(let n of r)t.push(n);return t})();let e=[];for(let t of r)e.push(t);return e}var _h=Oq;function Kq(r){return r[Symbol.asyncIterator]!=null}function Mq(r,e){return Kq(r)?async function*(){yield*(await _h(r)).sort(e)}():function*(){yield*_h(r).sort(e)}()}var f0=Mq;function Uq(r){return r[Symbol.asyncIterator]!=null}function Fq(r,e){return Uq(r)?async function*(){let t=0;if(!(e<1)){for await(let n of r)if(yield n,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(let n of r)if(yield n,t++,t===e)return}}()}var Fi=Fq;var Mo=class{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(let{key:n,value:s}of e)await this.put(n,s,t),yield n}async*getMany(e,t={}){for await(let n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(let n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await Nn(this.putMany(e,n)),e=[],await Nn(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){let s=e.prefix;n=us(n,o=>o.key.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,o)=>us(s,o),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,o)=>f0(s,o),n)),e.offset!=null){let s=0,o=e.offset;n=us(n,()=>s++>=o)}return e.limit!=null&&(n=Fi(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){let s=e.prefix;n=us(n,o=>o.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,o)=>us(s,o),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,o)=>f0(s,o),n)),e.offset!=null){let s=e.offset,o=0;n=us(n,()=>o++>=s)}return e.limit!=null&&(n=Fi(n,e.limit)),n}};var rc=class extends Mo{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set(e.toString(),t),e}get(e){let t=this.data.get(e.toString());if(t==null)throw c0();return t}has(e){return this.data.has(e.toString())}delete(e){this.data.delete(e.toString())}*_all(){for(let[e,t]of this.data.entries())yield{key:new ct(e),value:t}}*_allKeys(){for(let e of this.data.keys())yield new ct(e)}};function Vq(r){return r[Symbol.asyncIterator]!=null}function qq(r,e){if(Vq(r))return async function*(){for await(let a of r)yield e(a)}();let t=Pl(r),{value:n,done:s}=t.next();if(s===!0)return function*(){}();let o=e(n);if(typeof o.then=="function")return async function*(){yield await o;for await(let a of t)yield e(a)}();let i=e;return function*(){yield o;for(let a of t)yield i(a)}()}var hs=qq;function lt(r,...e){if(r==null)throw new Error("Empty pipeline");if(U3(r)){let n=r;r=()=>n.source}else if(I9(r)||R9(r)){let n=r;r=()=>n}let t=[r,...e];if(t.length>1&&U3(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)U3(t[n])&&(t[n]=zq(t[n]));return Hq(...t)}var Hq=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},R9=r=>r?.[Symbol.asyncIterator]!=null,I9=r=>r?.[Symbol.iterator]!=null,U3=r=>r==null?!1:r.sink!=null&&r.source!=null,zq=r=>e=>{let t=r.sink(e);if(t?.then!=null){let n=Tt({objectMode:!0});t.then(()=>{n.end()},i=>{n.end(i)});let s,o=r.source;if(R9(o))s=async function*(){yield*o,n.end()};else if(I9(o))s=function*(){yield*o,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return fs(n,s())}return r.source};var ape=new ct(A9);var wpe=ls("datastore:core:tiered");function ur(r){let e=new globalThis.AbortController;function t(){e.abort();for(let o of r)o?.removeEventListener!=null&&o.removeEventListener("abort",t)}for(let o of r){if(o?.aborted===!0){t();break}o?.addEventListener!=null&&o.addEventListener("abort",t)}function n(){for(let o of r)o?.removeEventListener!=null&&o.removeEventListener("abort",t)}let s=e.signal;return s.clear=n,s}function Wq(r){return r[Symbol.asyncIterator]!=null}function k9(r){return r?.then!=null}function Yq(r,e){if(Wq(r))return async function*(){for await(let a of r){let c=e(a);k9(c)&&await c,yield a}}();let t=Pl(r),{value:n,done:s}=t.next();if(s===!0)return function*(){}();if(typeof e(n)?.then=="function")return async function*(){yield n;for await(let a of t){let c=e(a);k9(c)&&await c,yield a}}();let i=e;return function*(){yield n;for(let a of t)i(a),yield a}()}var nc=Yq;var z3={};V(z3,{base32:()=>Nl,base32hex:()=>nH,base32hexpad:()=>oH,base32hexpadupper:()=>iH,base32hexupper:()=>sH,base32pad:()=>tH,base32padupper:()=>rH,base32upper:()=>eH,base32z:()=>aH});function jq(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var o=r.charAt(s),i=o.charCodeAt(0);if(t[i]!==255)throw new TypeError(o+" is ambiguous");t[i]=s}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function f(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var m=0,y=0,b=0,w=p.length;b!==w&&p[b]===0;)b++,m++;for(var E=(w-b)*u+1>>>0,x=new Uint8Array(E);b!==w;){for(var v=p[b],S=0,A=E-1;(v!==0||S<y)&&A!==-1;A--,S++)v+=256*x[A]>>>0,x[A]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");y=S,b++}for(var _=E-y;_!==E&&x[_]===0;)_++;for(var D=c.repeat(m);_<E;++_)D+=r.charAt(x[_]);return D}function h(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var m=0;if(p[m]!==" "){for(var y=0,b=0;p[m]===c;)y++,m++;for(var w=(p.length-m)*l+1>>>0,E=new Uint8Array(w);p[m];){var x=t[p.charCodeAt(m)];if(x===255)return;for(var v=0,S=w-1;(x!==0||v<b)&&S!==-1;S--,v++)x+=a*E[S]>>>0,E[S]=x%256>>>0,x=x/256>>>0;if(x!==0)throw new Error("Non-zero carry");b=v,m++}if(p[m]!==" "){for(var A=w-b;A!==w&&E[A]===0;)A++;for(var _=new Uint8Array(y+(w-A)),D=y;A!==w;)_[D++]=E[A++];return _}}}function d(p){var m=h(p);if(m)return m;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:h,decode:d}}var Qq=jq,Xq=Qq,D9=Xq;var Fpe=new Uint8Array(0);var P9=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Uo=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var C9=r=>new TextEncoder().encode(r),B9=r=>new TextDecoder().decode(r);var F3=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},V3=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return L9(this,e)}},q3=class{constructor(e){this.decoders=e}or(e){return L9(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},L9=(r,e)=>new q3({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}}),H3=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new F3(e,t,n),this.decoder=new V3(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},Bl=({name:r,prefix:e,encode:t,decode:n})=>new H3(r,e,t,n),Vi=({prefix:r,name:e,alphabet:t})=>{let{encode:n,decode:s}=D9(t,e);return Bl({prefix:r,name:e,encode:n,decode:o=>Uo(s(o))})},Jq=(r,e,t,n)=>{let s={};for(let u=0;u<e.length;++u)s[e[u]]=u;let o=r.length;for(;r[o-1]==="=";)--o;let i=new Uint8Array(o*t/8|0),a=0,c=0,l=0;for(let u=0;u<o;++u){let f=s[r[u]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|f,a+=t,a>=8&&(a-=8,i[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return i},Zq=(r,e,t)=>{let n=e[e.length-1]==="=",s=(1<<t)-1,o="",i=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],i+=8;i>t;)i-=t,o+=e[s&a>>i];if(i&&(o+=e[s&a<<t-i]),n)for(;o.length*t&7;)o+="=";return o},Ot=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Bl({prefix:e,name:r,encode(s){return Zq(s,n,t)},decode(s){return Jq(s,n,t,r)}});var Nl=Ot({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),eH=Ot({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),tH=Ot({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),rH=Ot({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),nH=Ot({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),sH=Ot({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),oH=Ot({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),iH=Ot({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),aH=Ot({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var $3={};V($3,{base58btc:()=>Je,base58flickr:()=>cH});var Je=Vi({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),cH=Vi({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var lH=M9,O9=128,uH=127,fH=~uH,hH=Math.pow(2,31);function M9(r,e,t){e=e||[],t=t||0;for(var n=t;r>=hH;)e[t++]=r&255|O9,r/=128;for(;r&fH;)e[t++]=r&255|O9,r>>>=7;return e[t]=r|0,M9.bytes=t-n+1,e}var pH=G3,dH=128,K9=127;function G3(r,n){var t=0,n=n||0,s=0,o=n,i,a=r.length;do{if(o>=a)throw G3.bytes=0,new RangeError("Could not decode varint");i=r[o++],t+=s<28?(i&K9)<<s:(i&K9)*Math.pow(2,s),s+=7}while(i>=dH);return G3.bytes=o-n,t}var mH=Math.pow(2,7),yH=Math.pow(2,14),gH=Math.pow(2,21),bH=Math.pow(2,28),wH=Math.pow(2,35),EH=Math.pow(2,42),vH=Math.pow(2,49),xH=Math.pow(2,56),SH=Math.pow(2,63),_H=function(r){return r<mH?1:r<yH?2:r<gH?3:r<bH?4:r<wH?5:r<EH?6:r<vH?7:r<xH?8:r<SH?9:10},AH={encode:lH,decode:pH,encodingLength:_H},RH=AH,Ah=RH;var Rh=(r,e=0)=>[Ah.decode(r,e),Ah.decode.bytes],Ll=(r,e,t=0)=>(Ah.encode(r,e,t),e),Ol=r=>Ah.encodingLength(r);var sc=(r,e)=>{let t=e.byteLength,n=Ol(r),s=n+Ol(t),o=new Uint8Array(s+t);return Ll(r,o,0),Ll(t,o,n),o.set(e,s),new Kl(r,t,e,o)},U9=r=>{let e=Uo(r),[t,n]=Rh(e),[s,o]=Rh(e.subarray(n)),i=e.subarray(n+o);if(i.byteLength!==s)throw new Error("Incorrect length");return new Kl(t,s,i,e)},F9=(r,e)=>{if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&P9(r.bytes,t.bytes)}},Kl=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};var V9=(r,e)=>{let{bytes:t,version:n}=r;switch(n){case 0:return TH(t,W3(r),e||Je.encoder);default:return kH(t,W3(r),e||Nl.encoder)}};var q9=new WeakMap,W3=r=>{let e=q9.get(r);if(e==null){let t=new Map;return q9.set(r,t),t}return e},Er=class r{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==Th)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==DH)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=sc(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n&&e.code===n.code&&e.version===n.version&&F9(e.multihash,n.multihash)}toString(e){return V9(this,e)}toJSON(){return{"/":V9(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:s,multihash:o,bytes:i}=t;return new r(n,s,o,i||H9(n,s,o.bytes))}else if(t[PH]===!0){let{version:n,multihash:s,code:o}=t,i=U9(s);return r.create(n,o,i)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Th)throw new Error(`Version 0 CID must use dag-pb (code: ${Th}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let s=H9(e,t,n.bytes);return new r(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,Th,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,s=Uo(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");let o=s.subarray(t.multihashSize-t.digestSize),i=new Kl(t.multihashCode,t.digestSize,o,s);return[t.version===0?r.createV0(i):r.createV1(t.codec,i),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[f,h]=Rh(e.subarray(t));return t+=h,f},s=n(),o=Th;if(s===18?(s=0,t=0):o=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);let i=t,a=n(),c=n(),l=t+c,u=l-i;return{version:s,codec:o,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){let[n,s]=IH(e,t),o=r.decode(s);if(o.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return W3(o).set(n,e),o}},IH=(r,e)=>{switch(r[0]){case"Q":{let t=e||Je;return[Je.prefix,t.decode(`${Je.prefix}${r}`)]}case Je.prefix:{let t=e||Je;return[Je.prefix,t.decode(r)]}case Nl.prefix:{let t=e||Nl;return[Nl.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},TH=(r,e,t)=>{let{prefix:n}=t;if(n!==Je.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let s=e.get(n);if(s==null){let o=t.encode(r).slice(1);return e.set(n,o),o}else return s},kH=(r,e,t)=>{let{prefix:n}=t,s=e.get(n);if(s==null){let o=t.encode(r);return e.set(n,o),o}else return s},Th=112,DH=18,H9=(r,e,t)=>{let n=Ol(r),s=n+Ol(e),o=new Uint8Array(s+t.byteLength);return Ll(r,o,0),Ll(e,o,n),o.set(t,s),o},PH=Symbol.for("@ipld/js-cid/CID");var Y3=class extends Map{metric;constructor(e){super();let{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function zs(r){let{name:e,metrics:t}=r,n;return t!=null?n=new Y3({name:e,metrics:t}):n=new Map,n}var z9=Symbol.for("@libp2p/connection");var kh=Symbol.for("@libp2p/content-routing");var oc=Symbol.for("@libp2p/peer-discovery");var j3=Symbol.for("@libp2p/peer-id");function Ml(r){return r!=null&&!!r[j3]}var Dh=Symbol.for("@libp2p/peer-routing");var $9="keep-alive";var ic="StrictSign",Ul="StrictNoSign",zr;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(zr||(zr={}));var $s=Symbol.for("@libp2p/transport");var qi;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(qi||(qi={}));var ps=class r extends Error{code;type;constructor(e="The operation was aborted"){super(e),this.code=r.code,this.type=r.type}static code="ABORT_ERR";static type="aborted"},g=class extends Error{code;props;constructor(e,t,n){super(e),this.code=t,this.name=n?.name??"CodeError",this.props=n??{}}},p0=class extends AggregateError{code;props;constructor(e,t,n,s){super(e,t),this.code=n,this.name=s?.name??"AggregateCodeError",this.props=s??{}}};var Fo="ERR_TIMEOUT";var G9="ERR_NOT_FOUND",ac="ERR_INVALID_MESSAGE";var je=class extends EventTarget{#e=new Map;listenerCount(e){let t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let s=this.#e.get(e);s==null&&(s=[],this.#e.set(e,s)),s.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let s=this.#e.get(e);s!=null&&(s=s.filter(({callback:o})=>o!==t),this.#e.set(e,s))}dispatchEvent(e){let t=super.dispatchEvent(e),n=this.#e.get(e.type);return n==null||(n=n.filter(({once:s})=>!s),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new Dt(e,t))}},Q3=class extends Event{detail;constructor(e,t){super(e,t),this.detail=t?.detail}},Dt=globalThis.CustomEvent??Q3;var Ze=(r,...e)=>{try{[...e]}catch{}};function d0(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function Fl(...r){let e=[];for(let t of r)d0(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function Vl(...r){let e=[];for(let t of r)d0(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}var Z3={};V(Z3,{sha256:()=>Ph,sha512:()=>CH});var J3=({name:r,code:e,encode:t})=>new X3(r,e,t),X3=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?sc(this.code,t):t.then(n=>sc(this.code,n))}else throw Error("Unknown type, must be binary type")}};var Y9=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Ph=J3({name:"sha2-256",code:18,encode:Y9("SHA-256")}),CH=J3({name:"sha2-512",code:19,encode:Y9("SHA-512")});var kx=fe(cx(),1);function lx(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}var cc=class{_refCounter;cid;priority;wantType;constructor(e,t,n){this._refCounter=1,this.cid=e,this.priority=t??1,this.wantType=n}inc(){this._refCounter+=1}dec(){this._refCounter=Math.max(0,this._refCounter-1)}hasRefs(){return this._refCounter>0}get[Symbol.toStringTag](){return`WantlistEntry <key: ${this.cid.toString(Je)}, priority: ${this.priority}, refs: ${this._refCounter}>`}equals(e){return this._refCounter===e._refCounter&&this.cid.equals(e.cid)&&this.priority===e.priority&&this.wantType===e.wantType}};var Hi=class{entry;cancel;sendDontHave;constructor(e,t,n,s,o){this.entry=new cc(e,t,n),this.cancel=!!s,this.sendDontHave=!!o}get cid(){return this.entry.cid}set cid(e){this.entry.cid=e}get priority(){return this.entry.priority}set priority(e){this.entry.priority=e}get wantType(){return this.entry.wantType}set wantType(e){this.entry.wantType=e}get[Symbol.toStringTag](){return`BitswapMessageEntry ${this.cid.toString(Je)} <cancel: ${this.cancel}, priority: ${this.priority}>`}equals(e){return this.cancel===e.cancel&&this.sendDontHave===e.sendDontHave&&this.wantType===e.wantType&&this.entry.equals(e.entry)}};var On=(r,e)=>{let t=["bitswap"];return e!=null&&t.push(e),r!=null&&t.push(`${r.toString().slice(0,8)}`),ls(t.join(":"))};var m0=(r,e)=>{if(r.size!==e.size)return!1;for(let[t,n]of r){let s=e.get(t);if(s===void 0||n instanceof Uint8Array&&s instanceof Uint8Array&&!lx(n,s)||n instanceof Hi&&s instanceof Hi&&!n.equals(s))return!1}return!0};var Ch=fe(wx(),1);function oz(r){let e=new Uint8Array(r.reduce((n,s)=>n+Ch.default.encodingLength(s),0)),t=0;for(let n of r)e=Ch.encode(n,e,t),t+=Ch.default.encodingLength(n);return e}var Ex=oz;var n4=new Float32Array([-0]),zi=new Uint8Array(n4.buffer);function vx(r,e,t){n4[0]=r,e[t]=zi[0],e[t+1]=zi[1],e[t+2]=zi[2],e[t+3]=zi[3]}function xx(r,e){return zi[0]=r[e],zi[1]=r[e+1],zi[2]=r[e+2],zi[3]=r[e+3],n4[0]}var s4=new Float64Array([-0]),Lr=new Uint8Array(s4.buffer);function Sx(r,e,t){s4[0]=r,e[t]=Lr[0],e[t+1]=Lr[1],e[t+2]=Lr[2],e[t+3]=Lr[3],e[t+4]=Lr[4],e[t+5]=Lr[5],e[t+6]=Lr[6],e[t+7]=Lr[7]}function _x(r,e){return Lr[0]=r[e],Lr[1]=r[e+1],Lr[2]=r[e+2],Lr[3]=r[e+3],Lr[4]=r[e+4],Lr[5]=r[e+5],Lr[6]=r[e+6],Lr[7]=r[e+7],s4[0]}var iz=BigInt(Number.MAX_SAFE_INTEGER),az=BigInt(Number.MIN_SAFE_INTEGER),tn=class r{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return lc;if(e<iz&&e>az)return this.fromNumber(Number(e));let t=e<0n;t&&(e=-e);let n=e>>32n,s=e-(n<<32n);return t&&(n=~n|0n,s=~s|0n,++s>Ax&&(s=0n,++n>Ax&&(n=0n))),new r(Number(s),Number(n))}static fromNumber(e){if(e===0)return lc;let t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new r(n,s)}static from(e){return typeof e=="number"?r.fromNumber(e):typeof e=="bigint"?r.fromBigInt(e):typeof e=="string"?r.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new r(e.low>>>0,e.high>>>0):lc}},lc=new tn(0,0);lc.toBigInt=function(){return 0n};lc.zzEncode=lc.zzDecode=function(){return this};lc.length=function(){return 1};var Ax=4294967296n;function Rx(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function Ix(r,e,t){if(t-e<1)return"";let s,o=[],i=0,a;for(;e<t;)a=r[e++],a<128?o[i++]=a:a>191&&a<224?o[i++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,o[i++]=55296+(a>>10),o[i++]=56320+(a&1023)):o[i++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,i>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,o)),i=0);return s!=null?(i>0&&s.push(String.fromCharCode.apply(String,o.slice(0,i))),s.join("")):String.fromCharCode.apply(String,o.slice(0,i))}function o4(r,e,t){let n=t,s,o;for(let i=0;i<r.length;++i)s=r.charCodeAt(i),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((o=r.charCodeAt(i+1))&64512)===56320?(s=65536+((s&1023)<<10)+(o&1023),++i,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-n}function ds(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function y0(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}var i4=class{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,ds(this,10);return e}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw ds(this,4);return y0(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw ds(this,4);return y0(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw ds(this,4);let e=xx(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw ds(this,4);let e=_x(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw ds(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){let e=this.bytes();return Ix(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw ds(this,e);this.pos+=e}else do if(this.pos>=this.len)throw ds(this);while(this.buf[this.pos++]&128);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new tn(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw ds(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw ds(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw ds(this,8);let e=y0(this.buf,this.pos+=4),t=y0(this.buf,this.pos+=4);return new tn(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){return this.readLongVarint().toNumber(!0)}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function a4(r){return new i4(r instanceof Uint8Array?r:r.subarray())}function J(r,e){let t=a4(r);return e.decode(t)}function c4(r){let e=r??8192,t=e>>>1,n,s=e;return function(i){if(i<1||i>t)return kt(i);s+i>e&&(n=kt(e),s=0);let a=n.subarray(s,s+=i);return s&7&&(s=(s|7)+1),a}}var uc=class{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}};function l4(){}var f4=class{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},cz=c4();function lz(r){return globalThis.Buffer!=null?kt(r):cz(r)}var Lh=class{len;head;tail;states;constructor(){this.len=0,this.head=new uc(l4,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new uc(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new h4((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(Bh,10,tn.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=tn.fromBigInt(e);return this._push(Bh,t.length(),t)}uint64Number(e){let t=tn.fromNumber(e);return this._push(Bh,t.length(),t)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=tn.fromBigInt(e).zzEncode();return this._push(Bh,t.length(),t)}sint64Number(e){let t=tn.fromNumber(e).zzEncode();return this._push(Bh,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(u4,1,e?1:0)}fixed32(e){return this._push(Nh,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=tn.fromBigInt(e);return this._push(Nh,4,t.lo)._push(Nh,4,t.hi)}fixed64Number(e){let t=tn.fromNumber(e);return this._push(Nh,4,t.lo)._push(Nh,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(vx,4,e)}double(e){return this._push(Sx,8,e)}bytes(e){let t=e.length>>>0;return t===0?this._push(u4,1,0):this.uint32(t)._push(fz,t,e)}string(e){let t=Rx(e);return t!==0?this.uint32(t)._push(o4,t,e):this._push(u4,1,0)}fork(){return this.states=new f4(this),this.head=this.tail=new uc(l4,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new uc(l4,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next,t=lz(this.len),n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}};function u4(r,e,t){e[t]=r&255}function uz(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}var h4=class extends uc{next;constructor(e,t){super(uz,e,t),this.next=void 0}};function Bh(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function Nh(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function fz(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(Lh.prototype.bytes=function(r){let e=r.length>>>0;return this.uint32(e),e>0&&this._push(hz,e,r),this},Lh.prototype.string=function(r){let e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(pz,e,r),this});function hz(r,e,t){e.set(r,t)}function pz(r,e,t){r.length<40?o4(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(R(r),t)}function p4(){return new Lh}function Z(r,e){let t=p4();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var ql;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(ql||(ql={}));function g0(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function Te(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}let t=function(o,i){let a=e(o);i.int32(a)},n=function(o){let i=o.int32();return e(i)};return g0("enum",ql.VARINT,t,n)}function ee(r,e){return g0("message",ql.LENGTH_DELIMITED,r,e)}var Oh=class extends Error{code;constructor(e,t,n){super(e,n),this.code=t}};var rn;(function(r){let e;(function(a){let c;(function(h){h.Block="Block",h.Have="Have"})(c=a.WantType||(a.WantType={}));let l;(function(h){h[h.Block=0]="Block",h[h.Have=1]="Have"})(l||(l={})),function(h){h.codec=()=>Te(l)}(c=a.WantType||(a.WantType={}));let u;(function(h){let d;h.codec=()=>(d==null&&(d=ee((p,m,y={})=>{y.lengthDelimited!==!1&&m.fork(),p.block!=null&&p.block.byteLength>0&&(m.uint32(10),m.bytes(p.block)),p.priority!=null&&p.priority!==0&&(m.uint32(16),m.int32(p.priority)),p.cancel!=null&&p.cancel!==!1&&(m.uint32(24),m.bool(p.cancel)),p.wantType!=null&&l[p.wantType]!==0&&(m.uint32(32),r.Wantlist.WantType.codec().encode(p.wantType,m)),p.sendDontHave!=null&&p.sendDontHave!==!1&&(m.uint32(40),m.bool(p.sendDontHave)),y.lengthDelimited!==!1&&m.ldelim()},(p,m)=>{let y={block:new Uint8Array(0),priority:0,cancel:!1,wantType:c.Block,sendDontHave:!1},b=m==null?p.len:p.pos+m;for(;p.pos<b;){let w=p.uint32();switch(w>>>3){case 1:y.block=p.bytes();break;case 2:y.priority=p.int32();break;case 3:y.cancel=p.bool();break;case 4:y.wantType=r.Wantlist.WantType.codec().decode(p);break;case 5:y.sendDontHave=p.bool();break;default:p.skipType(w&7);break}}return y})),d),h.encode=p=>Z(p,h.codec()),h.decode=p=>J(p,h.codec())})(u=a.Entry||(a.Entry={}));let f;a.codec=()=>(f==null&&(f=ee((h,d,p={})=>{if(p.lengthDelimited!==!1&&d.fork(),h.entries!=null)for(let m of h.entries)d.uint32(10),r.Wantlist.Entry.codec().encode(m,d);h.full!=null&&h.full!==!1&&(d.uint32(16),d.bool(h.full)),p.lengthDelimited!==!1&&d.ldelim()},(h,d)=>{let p={entries:[],full:!1},m=d==null?h.len:h.pos+d;for(;h.pos<m;){let y=h.uint32();switch(y>>>3){case 1:p.entries.push(r.Wantlist.Entry.codec().decode(h,h.uint32()));break;case 2:p.full=h.bool();break;default:h.skipType(y&7);break}}return p})),f),a.encode=h=>Z(h,a.codec()),a.decode=h=>J(h,a.codec())})(e=r.Wantlist||(r.Wantlist={}));let t;(function(a){let c;a.codec=()=>(c==null&&(c=ee((l,u,f={})=>{f.lengthDelimited!==!1&&u.fork(),l.prefix!=null&&l.prefix.byteLength>0&&(u.uint32(10),u.bytes(l.prefix)),l.data!=null&&l.data.byteLength>0&&(u.uint32(18),u.bytes(l.data)),f.lengthDelimited!==!1&&u.ldelim()},(l,u)=>{let f={prefix:new Uint8Array(0),data:new Uint8Array(0)},h=u==null?l.len:l.pos+u;for(;l.pos<h;){let d=l.uint32();switch(d>>>3){case 1:f.prefix=l.bytes();break;case 2:f.data=l.bytes();break;default:l.skipType(d&7);break}}return f})),c),a.encode=l=>Z(l,a.codec()),a.decode=l=>J(l,a.codec())})(t=r.Block||(r.Block={}));let n;(function(a){a.Have="Have",a.DontHave="DontHave"})(n=r.BlockPresenceType||(r.BlockPresenceType={}));let s;(function(a){a[a.Have=0]="Have",a[a.DontHave=1]="DontHave"})(s||(s={})),function(a){a.codec=()=>Te(s)}(n=r.BlockPresenceType||(r.BlockPresenceType={}));let o;(function(a){let c;a.codec=()=>(c==null&&(c=ee((l,u,f={})=>{f.lengthDelimited!==!1&&u.fork(),l.cid!=null&&l.cid.byteLength>0&&(u.uint32(10),u.bytes(l.cid)),l.type!=null&&s[l.type]!==0&&(u.uint32(16),r.BlockPresenceType.codec().encode(l.type,u)),f.lengthDelimited!==!1&&u.ldelim()},(l,u)=>{let f={cid:new Uint8Array(0),type:n.Have},h=u==null?l.len:l.pos+u;for(;l.pos<h;){let d=l.uint32();switch(d>>>3){case 1:f.cid=l.bytes();break;case 2:f.type=r.BlockPresenceType.codec().decode(l);break;default:l.skipType(d&7);break}}return f})),c),a.encode=l=>Z(l,a.codec()),a.decode=l=>J(l,a.codec())})(o=r.BlockPresence||(r.BlockPresence={}));let i;r.codec=()=>(i==null&&(i=ee((a,c,l={})=>{if(l.lengthDelimited!==!1&&c.fork(),a.wantlist!=null&&(c.uint32(10),r.Wantlist.codec().encode(a.wantlist,c)),a.blocks!=null)for(let u of a.blocks)c.uint32(18),c.bytes(u);if(a.payload!=null)for(let u of a.payload)c.uint32(26),r.Block.codec().encode(u,c);if(a.blockPresences!=null)for(let u of a.blockPresences)c.uint32(34),r.BlockPresence.codec().encode(u,c);a.pendingBytes!=null&&a.pendingBytes!==0&&(c.uint32(40),c.int32(a.pendingBytes)),l.lengthDelimited!==!1&&c.ldelim()},(a,c)=>{let l={blocks:[],payload:[],blockPresences:[],pendingBytes:0},u=c==null?a.len:a.pos+c;for(;a.pos<u;){let f=a.uint32();switch(f>>>3){case 1:l.wantlist=r.Wantlist.codec().decode(a,a.uint32());break;case 2:l.blocks.push(a.bytes());break;case 3:l.payload.push(r.Block.codec().decode(a,a.uint32()));break;case 4:l.blockPresences.push(r.BlockPresence.codec().decode(a,a.uint32()));break;case 5:l.pendingBytes=a.int32();break;default:a.skipType(f&7);break}}return l})),i),r.encode=a=>Z(a,r.codec()),r.decode=a=>J(a,r.codec())})(rn||(rn={}));var Or=class r{static Entry=Hi;static WantType={Block:rn.Wantlist.WantType.Block,Have:rn.Wantlist.WantType.Have};static BlockPresenceType={Have:rn.BlockPresenceType.Have,DontHave:rn.BlockPresenceType.DontHave};static deserialize=async(e,t)=>{let n=rn.decode(e),s=n.wantlist?.full===!0,o=new r(s);return n.wantlist?.entries.forEach(i=>{if(i.block==null)return;let a=Er.decode(i.block);o.addEntry(a,i.priority??0,i.wantType,!!i.cancel,!!i.sendDontHave)}),n.blockPresences.forEach(i=>{if(i.cid==null)return;let a=Er.decode(i.cid);i.type===r.BlockPresenceType.Have?o.addHave(a):o.addDontHave(a)}),n.blocks.length>0?(await Promise.all(n.blocks.map(async i=>{let a=await Ph.digest(i),c=Er.createV0(a);o.addBlock(c,i)})),o):(n.payload.length>0&&(await Promise.all(n.payload.map(async i=>{if(i.prefix==null||i.data==null)return;let a=(0,kx.default)(i.prefix),c=a[0],l=a[1],u=a[2],f=u===Ph.code?Ph:await t?.getHasher(u);if(f==null)throw new g("Unknown hash algorithm","ERR_UNKNOWN_HASH_ALG");let h=await f.digest(i.data),d=Er.create(c,l,h);o.addBlock(d,i.data)})),o.setPendingBytes(n.pendingBytes)),o)};static blockPresenceSize=e=>e.bytes.length+1;full;wantlist;blocks;blockPresences;pendingBytes;constructor(e){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}get empty(){return this.blocks.size===0&&this.wantlist.size===0&&this.blockPresences.size===0}addEntry(e,t,n,s,o){n==null&&(n=r.WantType.Block);let i=e.toString(Je),a=this.wantlist.get(i);a!=null?(a.wantType===n&&(a.priority=t),s===!0&&(a.cancel=!!s),o===!0&&(a.sendDontHave=!!o),n===r.WantType.Block&&a.wantType===r.WantType.Have&&(a.wantType=n)):this.wantlist.set(i,new Hi(e,t,n,s,o))}addBlock(e,t){let n=e.toString(Je);this.blocks.set(n,t)}addHave(e){let t=e.toString(Je);this.blockPresences.has(t)||this.blockPresences.set(t,r.BlockPresenceType.Have)}addDontHave(e){let t=e.toString(Je);this.blockPresences.has(t)||this.blockPresences.set(t,r.BlockPresenceType.DontHave)}cancel(e){let t=e.toString(Je);this.wantlist.delete(t),this.addEntry(e,0,r.WantType.Block,!0,!1)}setPendingBytes(e){this.pendingBytes=e}serializeToBitswap100(){return rn.encode({wantlist:{entries:Array.from(this.wantlist.values()).map(e=>({block:e.cid.bytes,priority:Number(e.priority),cancel:!!e.cancel,wantType:rn.Wantlist.WantType.Block,sendDontHave:!1})),full:!!this.full},blocks:Array.from(this.blocks.values())})}serializeToBitswap110(){let e={wantlist:{entries:Array.from(this.wantlist.values()).map(t=>({block:t.cid.bytes,priority:Number(t.priority),wantType:t.wantType,cancel:!!t.cancel,sendDontHave:!!t.sendDontHave})),full:!!this.full},blockPresences:[],payload:[],pendingBytes:this.pendingBytes,blocks:[]};for(let[t,n]of this.blocks.entries()){let s=Er.parse(t),o=s.version,i=s.code,a=s.multihash.code,c=s.multihash.digest.length,l=Ex([o,i,a,c]);e.payload.push({prefix:l,data:n})}for(let[t,n]of this.blockPresences)e.blockPresences.push({cid:Er.parse(t).bytes,type:n});return this.pendingBytes>0&&(e.pendingBytes=this.pendingBytes),rn.encode(e)}equals(e){return!(this.full!==e.full||this.pendingBytes!==e.pendingBytes||!m0(this.wantlist,e.wantlist)||!m0(this.blocks,e.blocks)||!m0(this.blockPresences,e.blockPresences))}get[Symbol.toStringTag](){let e=Array.from(this.wantlist.keys()),t=Array.from(this.blocks.keys());return`BitswapMessage <full: ${this.full}, list: ${e}, blocks: ${t}>`}};var Dx={Block:rn.Wantlist.WantType.Block,Have:rn.Wantlist.WantType.Have},dz=(r,e)=>Array.prototype.slice.call(e,0).sort((t,n)=>{let s=r(t),o=r(n);return s<o?-1:s>o?1:0}),$i=class{static Entry=cc;set;_stats;constructor(e,t){this.set=t!=null?zs({name:"ipfs_bitswap_wantlist",metrics:t.metrics}):new Map,this._stats=e}get length(){return this.set.size}add(e,t,n){let s=e.toString(Je),o=this.set.get(s);o!=null?(o.inc(),o.priority=t,o.wantType===Dx.Have&&n===Dx.Block&&(o.wantType=n)):(this.set.set(s,new cc(e,t,n)),this._stats!=null&&this._stats.push(void 0,"wantListSize",1))}remove(e){let t=e.toString(Je),n=this.set.get(t);n!=null&&(n.dec(),!n.hasRefs()&&(this.set.delete(t),this._stats!=null&&this._stats.push(void 0,"wantListSize",-1)))}removeForce(e){this.set.has(e)&&this.set.delete(e)}forEach(e){this.set.forEach(e)}entries(){return this.set.entries()}sortedEntries(){return new Map(dz(e=>e[1].key,Array.from(this.set.entries())))}contains(e){let t=e.toString(Je);return this.set.has(t)}get(e){let t=e.toString(Je);return this.set.get(t)}};var b0=class{partner;wantlist;exchangeCount;accounting;lastExchange;constructor(e){this.partner=e,this.wantlist=new $i,this.exchangeCount=0,this.accounting={bytesSent:0,bytesRecv:0}}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesRecv+=e}wants(e,t,n){this.wantlist.add(e,t,n)}cancelWant(e){this.wantlist.remove(e)}wantlistContains(e){return this.wantlist.get(e)}debtRatio(){return this.accounting.bytesSent/(this.accounting.bytesRecv+1)}};var Kh=class extends Map{_cmp;_keys;constructor(e,t){super(),this._cmp=t??this._defaultSort,this._keys=[];for(let[n,s]of e??[])this.set(n,s)}update(e){if(e<0||e>=this._keys.length)return;let t=this._keys[e];this._keys.splice(e,1);let n=this._find(t);this._keys.splice(n,0,t)}set(e,t){if(this.has(e)){let s=this.indexOf(e);this._keys.splice(s,1)}super.set(e,t);let n=this._find(e);return this._keys.splice(n,0,e),this}clear(){super.clear(),this._keys=[]}delete(e){if(!this.has(e))return!1;let t=this.indexOf(e);return this._keys.splice(t,1),super.delete(e)}indexOf(e){if(!this.has(e))return-1;let t=this._find(e);if(this._keys[t]===e)return t;for(let n=1;n<this._keys.length;n++){if(this._keys[t+n]===e)return t+n;if(this._keys[t-n]===e)return t-n}return-1}_find(e){let t=0,n=this._keys.length;for(;t<n;){let s=t+n>>>1,o=this._kCmp(this._keys[s],e);if(o<0)t=s+1;else if(o>0)n=s;else return s}return t}*keys(){for(let e of this._keys)yield e}*values(){for(let e of this._keys)yield this.get(e)}*entries(){for(let e of this._keys)yield[e,this.get(e)]}*[Symbol.iterator](){yield*this.entries()}forEach(e,t=this){if(e!=null)for(let n of this._keys){let s=this.get(n);if(s==null)throw new Error("Value cannot be undefined");e.apply(t,[[n,s]])}}_defaultSort(e,t){return e[0]<t[0]?-1:t[0]<e[0]?1:0}_kCmp(e,t){return this._cmp([e,this.get(e)],[t,this.get(t)])}};var mz={hasNewInfo(){return!1},merge(){}},w0=class{_taskMerger;_byPeer;constructor(e=mz){this._taskMerger=e,this._byPeer=new Kh([],E0.compare)}pushTasks(e,t){let n=this._byPeer.get(e.toString());n==null&&(n=new E0(e,this._taskMerger)),n.pushTasks(t),this._byPeer.set(e.toString(),n)}popTasks(e){let t=this._head();if(t===void 0)return{tasks:[],pendingSize:0};let{tasks:n,pendingSize:s}=t.popTasks(e);if(n.length===0)return{tasks:n,pendingSize:s};let o=t.peerId;return t.isIdle()?this._byPeer.delete(o.toString()):this._byPeer.update(0),{peerId:o,tasks:n,pendingSize:s}}_head(){if(this._byPeer.size!==0)for(let[,e]of this._byPeer)return e}remove(e,t){this._byPeer.get(t.toString())?.remove(e)}tasksDone(e,t){let n=this._byPeer.get(e.toString());if(n==null)return;let s=this._byPeer.indexOf(e.toString());for(let o of t)n.taskDone(o);this._byPeer.update(s)}},E0=class{peerId;_taskMerger;_activeTotalSize;_pending;_active;constructor(e,t){this.peerId=e,this._taskMerger=t,this._activeTotalSize=0,this._pending=new d4,this._active=new Set}pushTasks(e){for(let t of e)this._pushTask(t)}_pushTask(e){if(!this._taskHasMoreInfoThanActiveTasks(e))return;let t=this._pending.get(e.topic);if(t!=null){e.priority>t.priority&&this._pending.updatePriority(e.topic,e.priority),this._taskMerger.merge(e,t);return}this._pending.add(e)}_taskHasMoreInfoThanActiveTasks(e){let t=[];for(let n of this._active)n.topic===e.topic&&t.push(n);return t.length===0?!0:this._taskMerger.hasNewInfo(e,t)}popTasks(e){let t=0,n=[],s=this._pending.tasks();for(let o=0;o<s.length&&t<e;o++){let i=s[o];n.push(i),t+=i.size,this._pending.delete(i.topic),this._activeTotalSize+=i.size,this._active.add(i)}return{tasks:n,pendingSize:this._pending.totalSize}}taskDone(e){this._active.has(e)&&(this._activeTotalSize-=e.size,this._active.delete(e))}remove(e){this._pending.delete(e)}isIdle(){return this._pending.length===0&&this._active.size===0}static compare(e,t){return e[1]._pending.length===0?1:t[1]._pending.length===0?-1:e[1]._activeTotalSize===t[1]._activeTotalSize?t[1]._pending.length-e[1]._pending.length:e[1]._activeTotalSize-t[1]._activeTotalSize}},d4=class{_tasks;constructor(){this._tasks=new Kh([],this._compare)}get length(){return this._tasks.size}get totalSize(){return[...this._tasks.values()].reduce((e,t)=>e+t.task.size,0)}get(e){return this._tasks?.get(e)?.task}add(e){this._tasks.set(e.topic,{created:Date.now(),task:e})}delete(e){this._tasks.delete(e)}tasks(){return[...this._tasks.values()].map(e=>e.task)}updatePriority(e,t){let n=this._tasks.get(e);if(n==null)return;let s=this._tasks.indexOf(e);n.task.priority=t,this._tasks.update(s)}_compare(e,t){return e[1].task.priority===t[1].task.priority?e[1].created-t[1].created:t[1].task.priority-e[1].task.priority}};var Px={hasNewInfo(r,e){let t=!1,n=!1;for(let s of e)s.data.haveBlock&&(t=!0),s.data.isWantBlock&&(n=!0);return!!(!n&&r.data.isWantBlock||!t&&r.data.haveBlock)},merge(r,e){let t=r.data,n=e.data;!n.haveBlock&&t.haveBlock&&(n.haveBlock=t.haveBlock,n.blockSize=t.blockSize),!n.isWantBlock&&t.isWantBlock&&(n.isWantBlock=!0,(!n.haveBlock||t.haveBlock)&&(n.haveBlock=t.haveBlock,e.size=r.size)),n.isWantBlock&&n.haveBlock&&(e.size=n.blockSize)}};var Cx=Or.WantType,yz=16*1024,gz=1024,v0=class{_log;blockstore;network;_stats;_opts;ledgerMap;_running;_requestQueue;constructor(e,t,n,s,o,i={}){this._log=On(e,"engine"),this.blockstore=t,this.network=n,this._stats=s,this._opts=this._processOpts(i),this.ledgerMap=zs({name:"ipfs_bitswap_ledger_map",metrics:o.metrics}),this._running=!1,this._requestQueue=new w0(Px)}_processOpts(e){return{maxSizeReplaceHasWithBlock:gz,targetMessageSize:yz,...e}}_scheduleProcessTasks(){setTimeout(()=>{this._processTasks().catch(e=>{this._log.error("error processing stats",e)})})}async _processTasks(){if(!this._running)return;let{peerId:e,tasks:t,pendingSize:n}=this._requestQueue.popTasks(this._opts.targetMessageSize);if(t.length===0)return;let s=new Or(!1);s.setPendingBytes(n);let o=[],i=new Map;for(let c of t){let l=Er.parse(c.topic);c.data.haveBlock?c.data.isWantBlock?(o.push(l),i.set(c.topic,c.data)):s.addHave(l):s.addDontHave(l)}let a=await this._getBlocks(o);for(let[c,l]of i){let u=Er.parse(c),f=a.get(c);f!=null?s.addBlock(u,f):l.sendDontHave&&s.addDontHave(u)}if(s.empty){e!=null&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks();return}try{e!=null&&await this.network.sendMessage(e,s);for(let[c,l]of a.entries())e!=null&&this.messageSent(e,Er.parse(c),l)}catch(c){this._log.error(c)}e!=null&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks()}wantlistForPeer(e){let t=e.toString(),n=this.ledgerMap.get(t);return n!=null?n.wantlist.sortedEntries():new Map}ledgerForPeer(e){let t=e.toString(),n=this.ledgerMap.get(t);if(n!=null)return{peer:n.partner,value:n.debtRatio(),sent:n.accounting.bytesSent,recv:n.accounting.bytesRecv,exchanged:n.exchangeCount}}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.partner)}receivedBlocks(e){if(e.length!==0){for(let t of this.ledgerMap.values())for(let{cid:n,block:s}of e){let o=t.wantlistContains(n);if(o==null)continue;let i=s.length,a=this._sendAsBlock(o.wantType,i),c=i;a||(c=Or.blockPresenceSize(o.cid)),this._requestQueue.pushTasks(t.partner,[{topic:o.cid.toString(Je),priority:o.priority,size:c,data:{blockSize:i,isWantBlock:a,haveBlock:!0,sendDontHave:!1}}])}this._scheduleProcessTasks()}}async messageReceived(e,t){let n=this._findOrCreate(e);if(t.empty)return;if(t.full&&(n.wantlist=new $i),this._updateBlockAccounting(t.blocks,n),t.wantlist.size===0){this._scheduleProcessTasks();return}let s=[],o=[];t.wantlist.forEach(i=>{i.cancel?(n.cancelWant(i.cid),s.push(i.cid)):(n.wants(i.cid,i.priority,i.wantType),o.push(i))}),this._cancelWants(e,s),await this._addWants(e,o),this._scheduleProcessTasks()}_cancelWants(e,t){for(let n of t)this._requestQueue.remove(n.toString(Je),e)}async _addWants(e,t){let n=await this._getBlockSizes(t.map(o=>o.cid)),s=[];for(let o of t){let i=o.cid.toString(Je),a=n.get(i);if(a==null)o.sendDontHave&&s.push({topic:i,priority:o.priority,size:Or.blockPresenceSize(o.cid),data:{isWantBlock:o.wantType===Cx.Block,blockSize:0,haveBlock:!1,sendDontHave:o.sendDontHave}});else{let c=this._sendAsBlock(o.wantType,a),l=a;c||(l=Or.blockPresenceSize(o.cid)),s.push({topic:i,priority:o.priority,size:l,data:{isWantBlock:c,blockSize:a,haveBlock:!0,sendDontHave:o.sendDontHave}})}this._requestQueue.pushTasks(e,s)}}_sendAsBlock(e,t){return e===Cx.Block||t<=this._opts.maxSizeReplaceHasWithBlock}async _getBlockSizes(e){let t=await this._getBlocks(e);return new Map([...t].map(([n,s])=>[n,s.length]))}async _getBlocks(e){let t=new Map;return await Promise.all(e.map(async n=>{try{let s=await this.blockstore.get(n);t.set(n.toString(Je),s)}catch(s){s.code!=="ERR_NOT_FOUND"&&this._log.error("failed to query blockstore for %s: %s",n,s)}})),t}_updateBlockAccounting(e,t){for(let n of e.values())this._log("got block (%s bytes)",n.length),t.receivedBytes(n.length)}messageSent(e,t,n){let s=this._findOrCreate(e);s.sentBytes(n.length),s.wantlist.remove(t)}numBytesSentTo(e){return this._findOrCreate(e).accounting.bytesSent}numBytesReceivedFrom(e){return this._findOrCreate(e).accounting.bytesRecv}peerDisconnected(e){this.ledgerMap.delete(e.toString())}_findOrCreate(e){let t=e.toString(),n=this.ledgerMap.get(t);if(n!=null)return n;let s=new b0(e);return this.ledgerMap.set(t,s),this._stats!=null&&this._stats.push(t,"peerCount",1),s}start(){this._running=!0}stop(){this._running=!1}};var bz=Math.pow(2,7),wz=Math.pow(2,14),Ez=Math.pow(2,21),m4=Math.pow(2,28),y4=Math.pow(2,35),g4=Math.pow(2,42),b4=Math.pow(2,49),ot=128,Kr=127;function Jt(r){if(r<bz)return 1;if(r<wz)return 2;if(r<Ez)return 3;if(r<m4)return 4;if(r<y4)return 5;if(r<g4)return 6;if(r<b4)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function vz(r,e,t=0){switch(Jt(r)){case 8:e[t++]=r&255|ot,r/=128;case 7:e[t++]=r&255|ot,r/=128;case 6:e[t++]=r&255|ot,r/=128;case 5:e[t++]=r&255|ot,r/=128;case 4:e[t++]=r&255|ot,r>>>=7;case 3:e[t++]=r&255|ot,r>>>=7;case 2:e[t++]=r&255|ot,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function xz(r,e,t=0){switch(Jt(r)){case 8:e.set(t++,r&255|ot),r/=128;case 7:e.set(t++,r&255|ot),r/=128;case 6:e.set(t++,r&255|ot),r/=128;case 5:e.set(t++,r&255|ot),r/=128;case 4:e.set(t++,r&255|ot),r>>>=7;case 3:e.set(t++,r&255|ot),r>>>=7;case 2:e.set(t++,r&255|ot),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function Sz(r,e){let t=r[e],n=0;if(n+=t&Kr,t<ot||(t=r[e+1],n+=(t&Kr)<<7,t<ot)||(t=r[e+2],n+=(t&Kr)<<14,t<ot)||(t=r[e+3],n+=(t&Kr)<<21,t<ot)||(t=r[e+4],n+=(t&Kr)*m4,t<ot)||(t=r[e+5],n+=(t&Kr)*y4,t<ot)||(t=r[e+6],n+=(t&Kr)*g4,t<ot)||(t=r[e+7],n+=(t&Kr)*b4,t<ot))return n;throw new RangeError("Could not decode varint")}function _z(r,e){let t=r.get(e),n=0;if(n+=t&Kr,t<ot||(t=r.get(e+1),n+=(t&Kr)<<7,t<ot)||(t=r.get(e+2),n+=(t&Kr)<<14,t<ot)||(t=r.get(e+3),n+=(t&Kr)<<21,t<ot)||(t=r.get(e+4),n+=(t&Kr)*m4,t<ot)||(t=r.get(e+5),n+=(t&Kr)*y4,t<ot)||(t=r.get(e+6),n+=(t&Kr)*g4,t<ot)||(t=r.get(e+7),n+=(t&Kr)*b4,t<ot))return n;throw new RangeError("Could not decode varint")}function Zt(r,e,t=0){return e==null&&(e=kt(Jt(r))),e instanceof Uint8Array?vz(r,e,t):xz(r,e,t)}function gn(r,e=0){return r instanceof Uint8Array?Sz(r,e):_z(r,e)}function le(r,e){if(globalThis.Buffer!=null)return Hs(globalThis.Buffer.concat(r,e));e==null&&(e=r.reduce((s,o)=>s+o.length,0));let t=kt(e),n=0;for(let s of r)t.set(s,n),n+=s.length;return Hs(t)}function q(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}var Nx=Symbol.for("@achingbrain/uint8arraylist");function Bx(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let n of r){let s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function Hl(r){return!!r?.[Nx]}var ke=class r{bufs;length;[Nx]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(Hl(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(Hl(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=Bx(this.bufs,e);return t.buf[t.index]}set(e,t){let n=Bx(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(Hl(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){let{bufs:n,length:s}=this._subList(e,t);return le(n,s)}subarray(e,t){let{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:le(n,s)}sublist(e,t){let{bufs:n,length:s}=this._subList(e,t),o=new r;return o.length=s,o.bufs=[...n],o}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};let n=[],s=0;for(let o=0;o<this.bufs.length;o++){let i=this.bufs[o],a=s,c=a+i.byteLength;if(s=c,e>=c)continue;let l=e>=a&&e<c,u=t>a&&t<=c;if(l&&u){if(e===a&&t===c){n.push(i);break}let f=e-a;n.push(i.subarray(f,f+(t-e)));break}if(l){if(e===0){n.push(i);continue}n.push(i.subarray(e-a));continue}if(u){if(t===c){n.push(i);break}n.push(i.subarray(0,t-a));break}n.push(i)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!Hl(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;let s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");let o=256,i=new Int32Array(o);for(let f=0;f<o;f++)i[f]=-1;for(let f=0;f<s;f++)i[n[f]]=f;let a=i,c=this.byteLength-n.byteLength,l=n.byteLength-1,u;for(let f=t;f<=c;f+=u){u=0;for(let h=l;h>=0;h--){let d=this.get(f+h);if(n[h]!==d){u=Math.max(1,h-a[d]);break}}if(u===0)return f}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let n=kt(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){let s=Pe(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){let s=Pe(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){let s=Pe(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let n=kt(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){let s=Pe(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){let s=Pe(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){let s=Pe(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){let s=Pe(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){let s=Pe(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof r)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!q(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let n=new r;return n.bufs=e,t==null&&(t=e.reduce((s,o)=>s+o.byteLength,0)),n.length=t,n}};function x0(r){return r[Symbol.asyncIterator]!=null}var S0=r=>{let e=Jt(r),t=kt(e);return Zt(r,t),S0.bytes=e,t};S0.bytes=0;function sr(r,e){e=e??{};let t=e.lengthEncoder??S0;function*n(s){let o=t(s.byteLength);o instanceof Uint8Array?yield o:yield*o,s instanceof Uint8Array?yield s:yield*s}return x0(r)?async function*(){for await(let s of r)yield*n(s)}():function*(){for(let s of r)yield*n(s)}()}sr.single=(r,e)=>{e=e??{};let t=e.lengthEncoder??S0;return new ke(t(r.byteLength),r)};var zl=fe(No(),1);var Az=8,Rz=1024*1024*4,fc;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(fc||(fc={}));var w4=r=>{let e=gn(r);return w4.bytes=Jt(e),e};w4.bytes=0;function Mr(r,e){let t=new ke,n=fc.LENGTH,s=-1,o=e?.lengthDecoder??w4,i=e?.maxLengthLength??Az,a=e?.maxDataLength??Rz;function*c(){for(;t.byteLength>0;){if(n===fc.LENGTH)try{if(s=o(t),s<0)throw(0,zl.default)(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(s>a)throw(0,zl.default)(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");let l=o.bytes;t.consume(l),e?.onLength!=null&&e.onLength(s),n=fc.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>i)throw(0,zl.default)(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw l}if(n===fc.DATA){if(t.byteLength<s)break;let l=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(l),yield l,n=fc.LENGTH}}}return x0(r)?async function*(){for await(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw(0,zl.default)(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw(0,zl.default)(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}Mr.fromReader=(r,e)=>{let t=1,n=async function*(){for(;;)try{let{done:o,value:i}=await r.next(t);if(o===!0)return;i!=null&&(yield i)}catch(o){if(o.code==="ERR_UNDER_READ")return{done:!0,value:null};throw o}finally{t=1}}();return Mr(n,{...e??{},onLength:o=>{t=o}})};var $e=class extends Event{constructor(e,t){super(e),this.detail=t}};var $x=fe(Vx(),1);var qx=Math.pow(2,31)-1,Hx=1e3,zx=1;var S4="/ipfs/bitswap/1.0.0",_4="/ipfs/bitswap/1.1.0",A4="/ipfs/bitswap/1.2.0",Dz=1024,Pz=1024,Cz=3e4,A0=class{_log;_libp2p;_bitswap;_protocols;_stats;_running;_hashLoader;_maxInboundStreams;_maxOutboundStreams;_incomingStreamTimeout;_registrarIds;constructor(e,t,n,s={}){this._log=On(e.peerId,"network"),this._libp2p=e,this._bitswap=t,this._protocols=[S4],s.b100Only!==!0&&(this._protocols.unshift(_4),this._protocols.unshift(A4)),this._stats=n,this._running=!1,this._onPeerConnect=this._onPeerConnect.bind(this),this._onPeerDisconnect=this._onPeerDisconnect.bind(this),this._onConnection=this._onConnection.bind(this),this._hashLoader=s.hashLoader??{async getHasher(){throw new Error("Not implemented")}},this._maxInboundStreams=s.maxInboundStreams??Dz,this._maxOutboundStreams=s.maxOutboundStreams??Pz,this._incomingStreamTimeout=s.incomingStreamTimeout??Cz}async start(){this._running=!0,await this._libp2p.handle(this._protocols,this._onConnection,{maxInboundStreams:this._maxInboundStreams,maxOutboundStreams:this._maxOutboundStreams});let e={onConnect:this._onPeerConnect,onDisconnect:this._onPeerDisconnect};this._registrarIds=[];for(let t of this._protocols)this._registrarIds.push(await this._libp2p.register(t,e));this._libp2p.getConnections().forEach(t=>{this._onPeerConnect(t.remotePeer)})}async stop(){if(this._running=!1,await this._libp2p.unhandle(this._protocols),this._registrarIds!=null){for(let e of this._registrarIds)this._libp2p.unregister(e);this._registrarIds=[]}}_onConnection(e){if(!this._running)return;let{stream:t,connection:n}=e,s=new $x.TimeoutController(this._incomingStreamTimeout);Promise.resolve().then(async()=>{this._log("incoming new bitswap %s connection from %p",t.protocol,n.remotePeer);let o=()=>{t.abort(new g("Incoming Bitswap stream timed out","ERR_TIMEOUT"))},i=AbortSignal.timeout(this._incomingStreamTimeout);i.addEventListener("abort",o),await lt(t,a=>Mr(a),async a=>{for await(let c of a){try{let l=await Or.deserialize(c.subarray(),this._hashLoader);await this._bitswap._receiveMessage(n.remotePeer,l)}catch(l){this._bitswap._receiveError(l);break}i.removeEventListener("abort",o),i=AbortSignal.timeout(this._incomingStreamTimeout),i.addEventListener("abort",o)}}),await t.close({signal:i})}).catch(o=>{this._log(o),t.abort(o)}).finally(()=>{s.clear()})}_onPeerConnect(e){this._bitswap._onPeerConnected(e)}_onPeerDisconnect(e){this._bitswap._onPeerDisconnected(e)}findProviders(e,t={}){return t.onProgress?.(new $e("bitswap:network:find-providers",e)),this._libp2p.contentRouting.findProviders(e,t)}async findAndConnect(e,t){await Nn(Fi(hs(this.findProviders(e,t),async n=>this.connectTo(n.id,t).catch(s=>{this._log.error(s)})),3)).catch(n=>{this._log.error(n)})}async provide(e,t={}){t.onProgress?.(new $e("bitswap:network:provide",e)),await this._libp2p.contentRouting.provide(e,t)}async sendMessage(e,t,n={}){if(!this._running)throw new Error("network isn't running");let s=e.toString();this._log("sendMessage to %s",s,t),n.onProgress?.(new $e("bitswap:network:send-wantlist",e)),await this._writeMessage(e,t,n),this._updateSentStats(e,t.blocks)}async connectTo(e,t={}){if(!this._running)throw new Error("network isn't running");return t.onProgress?.(new $e("bitswap:network:dial",e)),this._libp2p.dial(e,t)}_updateSentStats(e,t){let n=e.toString();if(this._stats!=null){for(let s of t.values())this._stats.push(n,"dataSent",s.length);this._stats.push(n,"blocksSent",t.size)}}async _writeMessage(e,t,n={}){let s=await this._libp2p.dialProtocol(e,[A4,_4,S4]);try{let o;switch(s.protocol){case S4:o=t.serializeToBitswap100();break;case _4:case A4:o=t.serializeToBitswap110();break;default:throw new Error(`Unknown protocol: ${s.protocol}`)}await lt([o],i=>sr(i),s),await s.close()}catch(o){n.onProgress?.(new $e("bitswap:network:send-wantlist:error",{peer:e,error:o})),this._log(o),s.abort(o)}}};var hS=fe(T0(),1);var I4={};V(I4,{base10:()=>Uz});var Uz=Vi({prefix:"9",name:"base10",alphabet:"0123456789"});var T4={};V(T4,{base16:()=>Fz,base16upper:()=>Vz});var Fz=Ot({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Vz=Ot({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var k4={};V(k4,{base2:()=>qz});var qz=Ot({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var D4={};V(D4,{base256emoji:()=>Wz});var rS=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),Hz=rS.reduce((r,e,t)=>(r[t]=e,r),[]),zz=rS.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function $z(r){return r.reduce((e,t)=>(e+=Hz[t],e),"")}function Gz(r){let e=[];for(let t of r){let n=zz[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}var Wz=Bl({prefix:"\u{1F680}",name:"base256emoji",encode:$z,decode:Gz});var P4={};V(P4,{base36:()=>Yz,base36upper:()=>jz});var Yz=Vi({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),jz=Vi({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var C4={};V(C4,{base64:()=>Qz,base64pad:()=>Xz,base64url:()=>Jz,base64urlpad:()=>Zz});var Qz=Ot({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Xz=Ot({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Jz=Ot({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Zz=Ot({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var B4={};V(B4,{base8:()=>e$});var e$=Ot({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var N4={};V(N4,{identity:()=>t$});var t$=Bl({prefix:"\0",name:"identity",encode:r=>B9(r),decode:r=>C9(r)});var r2e=new TextEncoder,n2e=new TextDecoder;var L4={};V(L4,{identity:()=>i$});var nS=0,s$="identity",sS=Uo,o$=r=>sc(nS,sS(r)),i$={code:nS,name:s$,encode:sS,digest:o$};var O4={...N4,...k4,...B4,...I4,...T4,...z3,...P4,...$3,...C4,...D4},u2e={...Z3,...L4};function oS(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}function iS(r=0){return globalThis.Buffer?.allocUnsafe!=null?oS(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function cS(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var aS=cS("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),K4=cS("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=iS(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),a$={utf8:aS,"utf-8":aS,hex:O4.base16,latin1:K4,ascii:K4,binary:K4,...O4},lS=a$;function M4(r,e="utf8"){let t=lS[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):t.encoder.encode(r).substring(1)}var uS=r=>`unwant:${M4(r.multihash.bytes,"base64")}`,fS=r=>`block:${M4(r.multihash.bytes,"base64")}`,k0=class extends hS.EventEmitter{_log;constructor(e){super(),this.setMaxListeners(Hx),this._log=On(e,"notif")}hasBlock(e,t){let n=fS(e);this._log(n),this.emit(n,t)}async wantBlock(e,t={}){if(e==null)throw new Error("Not a valid cid");let n=fS(e),s=uS(e);return this._log(`wantBlock:${e}`),new Promise((o,i)=>{let a=()=>{this.removeListener(n,c),t.onProgress?.(new $e("bitswap:want-block:unwant",e)),i(new Error(`Block for ${e} unwanted`))},c=l=>{this.removeListener(s,a),t.onProgress?.(new $e("bitswap:want-block:block",e)),o(l)};this.once(s,a),this.once(n,c),t.signal?.addEventListener("abort",()=>{this.removeListener(n,c),this.removeListener(s,a),i(new Error(`Want for ${e} aborted`))})})}unwantBlock(e){let t=uS(e);this._log(t),this.emit(t)}};var bS=fe(T0(),1);var yS=fe(T0(),1),U4=fe(mS(),1),Uh=class extends yS.EventEmitter{_options;_queue;_stats;_frequencyLastTime;_frequencyAccumulators;_movingAverages;_enabled;_timeout;constructor(e,t){super(),this._options=t,this._queue=[],this._stats={},this._frequencyLastTime=Date.now(),this._frequencyAccumulators={},this._movingAverages={},this._update=this._update.bind(this),e.forEach(n=>{this._stats[n]=BigInt(0),this._movingAverages[n]={},this._options.movingAverageIntervals.forEach(s=>{(this._movingAverages[n][s]=(0,U4.default)(s)).push(this._frequencyLastTime,0)})}),this._enabled=this._options.enabled}enable(){this._enabled=!0}disable(){this._enabled=!1}stop(){this._timeout!=null&&clearTimeout(this._timeout)}get snapshot(){return Object.assign({},this._stats)}get movingAverages(){return Object.assign({},this._movingAverages)}push(e,t){this._enabled&&(this._queue.push([e,t,Date.now()]),this._resetComputeTimeout())}_resetComputeTimeout(){this._timeout!=null&&clearTimeout(this._timeout),this._timeout=setTimeout(this._update,this._nextTimeout())}_nextTimeout(){let e=this._queue.length/this._options.computeThrottleMaxQueueSize;return Math.max(this._options.computeThrottleTimeout*(1-e),0)}_update(){if(this._timeout=void 0,this._queue.length>0){let e;for(;this._queue.length>0;){let t=e=this._queue.shift();t!=null&&this._applyOp(t)}e!=null&&this._updateFrequency(e[2]),this.emit("update",this._stats)}}_updateFrequency(e){let t=e-this._frequencyLastTime;t>0&&Object.keys(this._stats).forEach(n=>{this._updateFrequencyFor(n,t,e)}),this._frequencyLastTime=e}_updateFrequencyFor(e,t,n){let s=this._frequencyAccumulators[e]??0;this._frequencyAccumulators[e]=0;let o=s/t*1e3,i=this._movingAverages[e];i==null&&(i=this._movingAverages[e]={}),this._options.movingAverageIntervals.forEach(a=>{let c=i[a];c==null&&(c=i[a]=(0,U4.default)(a)),c.push(n,o)})}_applyOp(e){let t=e[0],n=e[1];if(typeof n!="number")throw new Error(`invalid increment number: ${n}`);Object.prototype.hasOwnProperty.call(this._stats,t)||(this._stats[t]=BigInt(0)),this._stats[t]=BigInt(this._stats[t])+BigInt(n),this._frequencyAccumulators[t]==null&&(this._frequencyAccumulators[t]=0),this._frequencyAccumulators[t]+=n}};var gS={enabled:!1,computeThrottleTimeout:1e3,computeThrottleMaxQueueSize:1e3,movingAverageIntervals:[60*1e3,5*60*1e3,15*60*1e3]},D0=class extends bS.EventEmitter{_initialCounters;_options;_enabled;_global;_peers;constructor(e,t=[],n=gS){super();let s=Object.assign({},gS,n);if(typeof s.computeThrottleTimeout!="number")throw new Error("need computeThrottleTimeout");if(typeof s.computeThrottleMaxQueueSize!="number")throw new Error("need computeThrottleMaxQueueSize");this._initialCounters=t,this._options=s,this._enabled=this._options.enabled,this._global=new Uh(t,s),this._global.on("update",o=>this.emit("update",o)),this._peers=zs({name:"ipfs_bitswap_stats_peers",metrics:e.metrics})}enable(){this._enabled=!0,this._options.enabled=!0,this._global.enable()}disable(){this._enabled=!1,this._options.enabled=!1,this._global.disable()}stop(){this._enabled=!1,this._global.stop();for(let e of this._peers)e[1].stop()}get snapshot(){return this._global.snapshot}get movingAverages(){return this._global.movingAverages}forPeer(e){let t=e.toString();return this._peers.get(t)}push(e,t,n){if(this._enabled&&(this._global.push(t,n),e!=null)){let s=this._peers.get(e);s==null&&(s=new Uh(this._initialCounters,this._options),this._peers.set(e,s)),s.push(t,n)}}disconnected(e){let t=e.toString(),n=this._peers.get(t);n!=null&&(n.stop(),this._peers.delete(t))}};var wS=l$;function l$(r,e,t){var n=null,s=null,o=function(){n&&(clearTimeout(n),s=null,n=null)},i=function(){var c=s;o(),c&&c()},a=function(){if(!e)return r.apply(this,arguments);var c=this,l=arguments,u=t&&!n;if(o(),s=function(){r.apply(c,l)},n=setTimeout(function(){if(n=null,!u){var f=s;return s=null,f()}},e),u)return s()};return a.cancel=o,a.flush=i,a}var P0=class{peerId;refcnt;network;_entries;_log;constructor(e,t,n){this.peerId=t,this.network=n,this.refcnt=1,this._entries=[],this._log=On(e,"msgqueue"),this.sendEntries=wS(this.sendEntries.bind(this),zx)}addMessage(e,t={}){e.empty||this.send(e,t)}addEntries(e,t={}){this._entries=this._entries.concat(e),this.sendEntries(t)}sendEntries(e={}){if(this._entries.length===0)return;let t=new Or(!1);this._entries.forEach(n=>{n.cancel===!0?t.cancel(n.cid):t.addEntry(n.cid,n.priority)}),this._entries=[],this.addMessage(t,e)}async send(e,t={}){try{await this.network.connectTo(this.peerId,t)}catch(n){this._log.error("cant connect to peer %p: %s",this.peerId,n.message);return}this._log("sending message to peer %p",this.peerId),this.network.sendMessage(this.peerId,e,t).catch(n=>{this._log.error("send error",n)})}};var C0=class{peers;wantlist;network;_peerId;_log;constructor(e,t,n,s){this.peers=zs({name:"ipfs_bitswap_want_manager_peers",metrics:s.metrics}),this.wantlist=new $i(n,s),this.network=t,this._peerId=e,this._log=On(e,"want")}_addEntries(e,t,n,s={}){let o=e.map((i,a)=>new Or.Entry(i,qx-a,Or.WantType.Block,t));o.forEach(i=>{i.cancel?n===!0?this.wantlist.removeForce(i.cid.toString(Je)):this.wantlist.remove(i.cid):(this._log("adding to wantlist"),this.wantlist.add(i.cid,i.priority))});for(let i of this.peers.values())i.addEntries(o,s)}_startPeerHandler(e){let t=this.peers.get(e.toString());if(t!=null){t.refcnt++;return}t=new P0(this._peerId,e,this.network);let n=new Or(!0);for(let s of this.wantlist.entries())n.addEntry(s[1].cid,s[1].priority);return t.addMessage(n),this.peers.set(e.toString(),t),t}_stopPeerHandler(e){let t=this.peers.get(e.toString());t!=null&&(t.refcnt--,!(t.refcnt>0)&&this.peers.delete(e.toString()))}wantBlocks(e,t={}){this._addEntries(e,!1,!1,t),t.signal?.addEventListener("abort",()=>{this.cancelWants(e)})}unwantBlocks(e){this._log("unwant blocks: %s",e.length),this._addEntries(e,!0,!0)}cancelWants(e){this._log("cancel wants: %s",e.length),this._addEntries(e,!0)}connectedPeers(){return Array.from(this.peers.keys())}connected(e){this._startPeerHandler(e)}disconnected(e){this._stopPeerHandler(e)}start(){}stop(){this.peers.forEach(e=>{this.disconnected(e.peerId)})}};var u$={async getHasher(){throw new Error("Not implemented")}},f$={maxInboundStreams:1024,maxOutboundStreams:1024,incomingStreamTimeout:3e4,hashLoader:u$,statsEnabled:!1,statsComputeThrottleTimeout:1e3,statsComputeThrottleMaxQueueSize:1e3},h$=["blocksReceived","dataReceived","dupBlksReceived","dupDataReceived","blocksSent","dataSent","providesBufferLength","wantListLength","peerCount"],B0=class{_libp2p;_log;stats;network;blockstore;engine;wm;notifications;started;constructor(e,t,n={}){this._libp2p=e,this._log=On(this.peerId),n=Object.assign({},f$,n),this.stats=new D0(e,h$,{enabled:n.statsEnabled,computeThrottleTimeout:n.statsComputeThrottleTimeout,computeThrottleMaxQueueSize:n.statsComputeThrottleMaxQueueSize}),this.network=new A0(e,this,this.stats,{hashLoader:n.hashLoader,maxInboundStreams:n.maxInboundStreams,maxOutboundStreams:n.maxOutboundStreams,incomingStreamTimeout:n.incomingStreamTimeout}),this.blockstore=t,this.engine=new v0(this.peerId,t,this.network,this.stats,e),this.wm=new C0(this.peerId,this.network,this.stats,e),this.notifications=new k0(this.peerId),this.started=!1}isStarted(){return this.started}get peerId(){return this._libp2p.peerId}async _receiveMessage(e,t){try{await this.engine.messageReceived(e,t)}catch{this._log("failed to receive message",t)}if(t.blocks.size===0)return;let n=[];for(let[s,o]of t.blocks.entries()){let i=Er.parse(s);n.push({wasWanted:this.wm.wantlist.contains(i),cid:i,data:o})}this.wm.cancelWants(n.filter(({wasWanted:s})=>s).map(({cid:s})=>s)),await Promise.all(n.map(async({cid:s,wasWanted:o,data:i})=>{await this._handleReceivedBlock(e,s,i,o)}))}async _handleReceivedBlock(e,t,n,s){this._log("received block");let o=await this.blockstore.has(t);this._updateReceiveCounters(e.toString(),t,n,o),s&&await this.put(t,n)}_updateReceiveCounters(e,t,n,s){this.stats.push(e,"blocksReceived",1),this.stats.push(e,"dataReceived",n.length),s&&(this.stats.push(e,"dupBlksReceived",1),this.stats.push(e,"dupDataReceived",n.length))}_receiveError(e){this._log.error("ReceiveError",e)}_onPeerConnected(e){this.wm.connected(e)}_onPeerDisconnected(e){this.wm.disconnected(e),this.engine.peerDisconnected(e),this.stats.disconnected(e)}enableStats(){this.stats.enable()}disableStats(){this.stats.disable()}wantlistForPeer(e,t){return this.engine.wantlistForPeer(e)}ledgerForPeer(e){return this.engine.ledgerForPeer(e)}async want(e,t={}){let n=async(c,l)=>(this.wm.wantBlocks([c],l),this.notifications.wantBlock(c,l)),s=!1,o=async(c,l)=>{try{return await this.blockstore.get(c,l)}catch(u){if(u.code!=="ERR_NOT_FOUND")throw u;return s||(s=!0,this.network.findAndConnect(c,l).catch(f=>{this._log.error(f)})),await n(c,l)}},i=new AbortController,a=ur([i.signal,t.signal]);try{return await Promise.race([this.notifications.wantBlock(e,{...t,signal:a}),o(e,{...t,signal:a})])}finally{i.abort(),a.clear()}}unwant(e){let t=Array.isArray(e)?e:[e];this.wm.unwantBlocks(t),t.forEach(n=>{this.notifications.unwantBlock(n)})}cancelWants(e){this.wm.cancelWants(Array.isArray(e)?e:[e])}async put(e,t,n){await this.blockstore.put(e,t),this.notify(e,t)}async*putMany(e,t){yield*this.blockstore.putMany(nc(e,({cid:n,block:s})=>{this.notify(n,s)}),t)}notify(e,t,n={}){this.notifications.hasBlock(e,t),this.engine.receivedBlocks([{cid:e,block:t}]),this.network.provide(e,n).catch(s=>{this._log.error("Failed to provide: %s",s.message)})}getWantlist(){return this.wm.wantlist.entries()}get peers(){return this.engine.peers()}async start(){this.wm.start(),await this.network.start(),this.engine.start(),this.started=!0}async stop(){this.stats.stop(),this.wm.stop(),await this.network.stop(),this.engine.stop(),this.started=!1}};var ES=(r,e,t={})=>new B0(r,e,t);var F4=class{bitswap;started;constructor(e,t={}){let{libp2p:n,blockstore:s,hashers:o}=e;this.bitswap=ES(n,s,{hashLoader:{getHasher:async i=>{let a=o.find(c=>c.code===i||c.name===i);if(a!=null)return a;throw new Error(`Could not load hasher for code/name "${i}"`)}},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}announce(e,t,n){this.bitswap.notify(e,t,n)}async retrieve(e,{validateFn:t,...n}={}){return this.bitswap.want(e,n)}};function V4(r={}){return e=>new F4(e,r)}var N0=class{url;#e=0;#t=0;#r=0;#i=0;constructor(e){this.url=e instanceof URL?e:new URL(e)}async getRawBlock(e,t){let n=this.url;if(n.pathname=`/ipfs/${e.toString()}`,n.search="?format=raw",t?.aborted===!0)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);try{this.#e++;let s=await fetch(n.toString(),{signal:t,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"});if(!s.ok)throw this.#t++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);return this.#i++,new Uint8Array(await s.arrayBuffer())}catch{throw t?.aborted===!0?new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(this.#t++,new Error(`unable to fetch raw block for CID ${e}`))}}reliability(){return this.#e===0?1:this.#r>0?-1/0:this.#i/(this.#e+this.#t*3)}incrementInvalidBlocks(){this.#r++}};var L0=class{gateways;log;constructor(e,t={}){this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.gateways=(t.gateways??vS).map(n=>new N0(n))}async retrieve(e,t={}){let n=this.gateways.sort((o,i)=>i.reliability()-o.reliability()),s=[];for(let o of n){this.log("getting block for %c from %s",e,o.url);try{let i=await o.getRawBlock(e,t.signal);this.log.trace("got block for %c from %s",e,o.url);try{await t.validateFn?.(i)}catch(a){throw this.log.error("failed to validate block for %c from %s",e,o.url,a),o.incrementInvalidBlocks(),new Error(`unable to validate block for CID ${e} from gateway ${o.url}`)}return i}catch(i){if(this.log.error("failed to get block for %c from %s",e,o.url,i),i instanceof Error?s.push(i):s.push(new Error(`unable to fetch raw block for CID ${e} from gateway ${o.url}`)),t.signal?.aborted===!0){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,o.url);break}}}throw new AggregateError(s,`unable to fetch raw block for CID ${e} from any gateway`)}};var vS=["https://dweb.link","https://cf-ipfs.com","https://4everland.io"];function q4(r={}){return e=>new L0(e,r)}function p$(r){return typeof r.retrieve=="function"}function d$(r){return typeof r.announce=="function"}var Fh=class{child;blockRetrievers;blockAnnouncers;hashers;started;log;constructor(e,t){this.log=e.logger.forComponent("helia:networked-storage"),this.child=e.blockstore,this.blockRetrievers=(t.blockBrokers??[]).filter(p$),this.blockAnnouncers=(t.blockBrokers??[]).filter(d$),this.hashers=t.hashers??[],this.started=!1}isStarted(){return this.started}async start(){await Fl(this.child,...new Set([...this.blockRetrievers,...this.blockAnnouncers])),this.started=!0}async stop(){await Vl(this.child,...new Set([...this.blockRetrievers,...this.blockAnnouncers])),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){return await this.child.has(e)?(n.onProgress?.(new $e("blocks:put:duplicate",e)),e):(n.onProgress?.(new $e("blocks:put:providers:notify",e)),this.blockAnnouncers.forEach(s=>{s.announce(e,t,n)}),n.onProgress?.(new $e("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){let n=us(e,async({cid:o})=>{let i=await this.child.has(o);return i&&t.onProgress?.(new $e("blocks:put-many:duplicate",o)),!i}),s=nc(n,({cid:o,block:i})=>{t.onProgress?.(new $e("blocks:put-many:providers:notify",o)),this.blockAnnouncers.forEach(a=>{a.announce(o,i,t)})});t.onProgress?.(new $e("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(s,t)}async get(e,t={}){if(t.offline!==!0&&!await this.child.has(e)){t.onProgress?.(new $e("blocks:get:providers:get",e));let n=await xS(e,this.blockRetrievers,this.hashers,{...t,log:this.log});return t.onProgress?.(new $e("blocks:get:blockstore:put",e)),await this.child.put(e,n,t),t.onProgress?.(new $e("blocks:get:providers:notify",e)),this.blockAnnouncers.forEach(s=>{s.announce(e,n,t)}),n}return t.onProgress?.(new $e("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new $e("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(nc(e,async n=>{if(t.offline!==!0&&!await this.child.has(n)){t.onProgress?.(new $e("blocks:get-many:providers:get",n));let s=await xS(n,this.blockRetrievers,this.hashers,{...t,log:this.log});t.onProgress?.(new $e("blocks:get-many:blockstore:put",n)),await this.child.put(n,s,t),t.onProgress?.(new $e("blocks:get-many:providers:notify",n)),this.blockAnnouncers.forEach(o=>{o.announce(n,s,t)})}}))}async delete(e,t={}){t.onProgress?.(new $e("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new $e("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(let n of e)yield n}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new $e("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}},m$=(r,e)=>{let t=e.find(n=>n.code===r.multihash.code);if(t==null)throw new g(`No hasher configured for multihash code 0x${r.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`,"ERR_UNKNOWN_HASH_ALG");return async n=>{let s=await t.digest(n);if(!q(s.digest,r.multihash.digest))throw new g("Hash of downloaded block did not match multihash from passed CID","ERR_HASH_MISMATCH")}};async function xS(r,e,t,n){let s=m$(r,t),o=new AbortController,i=ur([o.signal,n.signal]);try{return await Promise.any(e.map(async a=>{try{let c=!1,l=await a.retrieve(r,{...n,signal:i,validateFn:async u=>{await s(u),c=!0}});return c||await s(l),l}catch(c){throw n.log.error("could not retrieve verified block for %c",r,c),c}}))}finally{i.clear()}}var H4=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.name="AbortError",this.code=t??"ABORT_ERR"}};async function O0(r,e,t,n){let s=new H4(n?.errorMessage,n?.errorCode);return t?.aborted===!0?Promise.reject(s):new Promise((o,i)=>{let a=l=>{n?.filter?.(l)!==!1&&(r.removeEventListener(e,a),t?.removeEventListener("abort",c),o(l))},c=()=>{r.removeEventListener(e,a),t?.removeEventListener("abort",c),i(s)};r.addEventListener(e,a),t?.addEventListener("abort",c)})}var K0=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.name="AbortError",this.code=t??"ABORT_ERR"}};async function nn(r,e,t){if(e==null)return r;if(e.aborted)return Promise.reject(new K0(t?.errorMessage,t?.errorCode));let n,s=new K0(t?.errorMessage,t?.errorCode);try{return await Promise.race([r,new Promise((o,i)=>{n=()=>{i(s)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}var M0=class{deferred;signal;where;constructor(e,t){this.signal=t,this.deferred=xe(),this.where=e,this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(new ps)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function y$(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var U0=class{id;fn;options;priority;recipients;status;timeline;controller;constructor(e,t,n=0){this.id=y$(),this.status="queued",this.fn=e,this.priority=n,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,Ze(1/0,this.controller.signal),this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&this.controller.abort(new ps)}async join(e={}){let t=new M0(new Error("where").stack,e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await nn(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.signal?.removeEventListener("abort",this.onAbort)})}};function g$(r,e,t){let n=0,s=r.length;for(;s>0;){let o=Math.trunc(s/2),i=n+o;t(r[i],e)<=0?(n=++i,s-=o+1):s=o}return n}var qo=class extends je{concurrency;queue;pending;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.queue=[]}tryToStartAnother(){if(this.size===0)return queueMicrotask(()=>{this.safeDispatchEvent("empty")}),this.running===0&&queueMicrotask(()=>{this.safeDispatchEvent("idle")}),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){if(this.queue[this.size-1]?.priority>=e.priority){this.queue.push(e);return}let t=g$(this.queue,e,(n,s)=>s.priority-n.priority);this.queue.splice(t,0,e)}async add(e,t){t?.signal?.throwIfAborted();let n=new U0(e,t,t?.priority),s=n.join(t).then(o=>(this.safeDispatchEvent("completed",{detail:o}),o)).catch(o=>{throw this.safeDispatchEvent("error",{detail:o}),o});return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),s}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new ps)}),this.clear()}async onEmpty(e){this.size!==0&&await O0(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await O0(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await O0(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=Tt({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},s=c=>{c.detail!=null&&t.push(c.detail)},o=c=>{n(c.detail)},i=()=>{n()},a=()=>{n(new g("Queue aborted","ERR_QUEUE_ABORTED"))};this.addEventListener("completed",s),this.addEventListener("error",o),this.addEventListener("idle",i),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("completed",s),this.removeEventListener("error",o),this.removeEventListener("idle",i),e?.signal?.removeEventListener("abort",a),n()}}};var b$=["string","number","bigint","symbol"],w$=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function SS(r){if(r===null)return"null";if(r===void 0)return"undefined";if(r===!0||r===!1)return"boolean";let e=typeof r;if(b$.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(r))return"Array";if(E$(r))return"Buffer";let t=v$(r);return t||"Object"}function E$(r){return r&&r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer.call(null,r)}function v$(r){let e=Object.prototype.toString.call(r).slice(8,-1);if(w$.includes(e))return e}var P=class{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}};P.uint=new P(0,"uint",!0);P.negint=new P(1,"negint",!0);P.bytes=new P(2,"bytes",!0);P.string=new P(3,"string",!0);P.array=new P(4,"array",!1);P.map=new P(5,"map",!1);P.tag=new P(6,"tag",!1);P.float=new P(7,"float",!0);P.false=new P(7,"false",!0);P.true=new P(7,"true",!0);P.null=new P(7,"null",!0);P.undefined=new P(7,"undefined",!0);P.break=new P(7,"break",!0);var j=class{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}};var Gl=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",x$=new TextDecoder,S$=new TextEncoder;function F0(r){return Gl&&globalThis.Buffer.isBuffer(r)}function Vh(r){return r instanceof Uint8Array?F0(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r:Uint8Array.from(r)}var IS=Gl?(r,e,t)=>t-e>64?globalThis.Buffer.from(r.subarray(e,t)).toString("utf8"):AS(r,e,t):(r,e,t)=>t-e>64?x$.decode(r.subarray(e,t)):AS(r,e,t),V0=Gl?r=>r.length>64?globalThis.Buffer.from(r):_S(r):r=>r.length>64?S$.encode(r):_S(r),Gs=r=>Uint8Array.from(r),Wl=Gl?(r,e,t)=>F0(r)?new Uint8Array(r.subarray(e,t)):r.slice(e,t):(r,e,t)=>r.slice(e,t),TS=Gl?(r,e)=>(r=r.map(t=>t instanceof Uint8Array?t:globalThis.Buffer.from(t)),Vh(globalThis.Buffer.concat(r,e))):(r,e)=>{let t=new Uint8Array(e),n=0;for(let s of r)n+s.length>t.length&&(s=s.subarray(0,t.length-n)),t.set(s,n),n+=s.length;return t},kS=Gl?r=>globalThis.Buffer.allocUnsafe(r):r=>new Uint8Array(r);function DS(r,e){if(F0(r)&&F0(e))return r.compare(e);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function _S(r){let e=[],t=0;for(let n=0;n<r.length;n++){let s=r.charCodeAt(n);s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&n+1<r.length&&(r.charCodeAt(n+1)&64512)===56320?(s=65536+((s&1023)<<10)+(r.charCodeAt(++n)&1023),e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128)}return e}function AS(r,e,t){let n=[];for(;e<t;){let s=r[e],o=null,i=s>239?4:s>223?3:s>191?2:1;if(e+i<=t){let a,c,l,u;switch(i){case 1:s<128&&(o=s);break;case 2:a=r[e+1],(a&192)===128&&(u=(s&31)<<6|a&63,u>127&&(o=u));break;case 3:a=r[e+1],c=r[e+2],(a&192)===128&&(c&192)===128&&(u=(s&15)<<12|(a&63)<<6|c&63,u>2047&&(u<55296||u>57343)&&(o=u));break;case 4:a=r[e+1],c=r[e+2],l=r[e+3],(a&192)===128&&(c&192)===128&&(l&192)===128&&(u=(s&15)<<18|(a&63)<<12|(c&63)<<6|l&63,u>65535&&u<1114112&&(o=u))}}o===null?(o=65533,i=1):o>65535&&(o-=65536,n.push(o>>>10&1023|55296),o=56320|o&1023),n.push(o),e+=i}return z4(n)}var RS=4096;function z4(r){let e=r.length;if(e<=RS)return String.fromCharCode.apply(String,r);let t="",n=0;for(;n<e;)t+=String.fromCharCode.apply(String,r.slice(n,n+=RS));return t}var _$=256,qh=class{constructor(e=_$){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){let s=t.length-(this.maxCursor-this.cursor)-1;t.set(e,s)}else{if(t){let s=t.length-(this.maxCursor-this.cursor)-1;s<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,s),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=kS(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){let n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=Wl(n,0,this.cursor)}else t=TS(this.chunks,this.cursor);return e&&this.reset(),t}};var de="CBOR decode error:",Yl="CBOR encode error:",Hh=[];Hh[23]=1;Hh[24]=2;Hh[25]=3;Hh[26]=5;Hh[27]=9;function Ho(r,e,t){if(r.length-e<t)throw new Error(`${de} not enough data for type`)}var fr=[24,256,65536,4294967296,BigInt("18446744073709551616")];function bn(r,e,t){Ho(r,e,1);let n=r[e];if(t.strict===!0&&n<fr[0])throw new Error(`${de} integer encoded in more bytes than necessary (strict decode)`);return n}function wn(r,e,t){Ho(r,e,2);let n=r[e]<<8|r[e+1];if(t.strict===!0&&n<fr[1])throw new Error(`${de} integer encoded in more bytes than necessary (strict decode)`);return n}function En(r,e,t){Ho(r,e,4);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3];if(t.strict===!0&&n<fr[2])throw new Error(`${de} integer encoded in more bytes than necessary (strict decode)`);return n}function vn(r,e,t){Ho(r,e,8);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3],s=r[e+4]*16777216+(r[e+5]<<16)+(r[e+6]<<8)+r[e+7],o=(BigInt(n)<<BigInt(32))+BigInt(s);if(t.strict===!0&&o<fr[3])throw new Error(`${de} integer encoded in more bytes than necessary (strict decode)`);if(o<=Number.MAX_SAFE_INTEGER)return Number(o);if(t.allowBigInt===!0)return o;throw new Error(`${de} integers outside of the safe integer range are not supported`)}function PS(r,e,t,n){return new j(P.uint,bn(r,e+1,n),2)}function CS(r,e,t,n){return new j(P.uint,wn(r,e+1,n),3)}function BS(r,e,t,n){return new j(P.uint,En(r,e+1,n),5)}function NS(r,e,t,n){return new j(P.uint,vn(r,e+1,n),9)}function Kn(r,e){return vr(r,0,e.value)}function vr(r,e,t){if(t<fr[0]){let n=Number(t);r.push([e|n])}else if(t<fr[1]){let n=Number(t);r.push([e|24,n])}else if(t<fr[2]){let n=Number(t);r.push([e|25,n>>>8,n&255])}else if(t<fr[3]){let n=Number(t);r.push([e|26,n>>>24&255,n>>>16&255,n>>>8&255,n&255])}else{let n=BigInt(t);if(n<fr[4]){let s=[e|27,0,0,0,0,0,0,0],o=Number(n&BigInt(4294967295)),i=Number(n>>BigInt(32)&BigInt(4294967295));s[8]=o&255,o=o>>8,s[7]=o&255,o=o>>8,s[6]=o&255,o=o>>8,s[5]=o&255,s[4]=i&255,i=i>>8,s[3]=i&255,i=i>>8,s[2]=i&255,i=i>>8,s[1]=i&255,r.push(s)}else throw new Error(`${de} encountered BigInt larger than allowable range`)}}Kn.encodedSize=function(e){return vr.encodedSize(e.value)};vr.encodedSize=function(e){return e<fr[0]?1:e<fr[1]?2:e<fr[2]?3:e<fr[3]?5:9};Kn.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function LS(r,e,t,n){return new j(P.negint,-1-bn(r,e+1,n),2)}function OS(r,e,t,n){return new j(P.negint,-1-wn(r,e+1,n),3)}function KS(r,e,t,n){return new j(P.negint,-1-En(r,e+1,n),5)}var $4=BigInt(-1),MS=BigInt(1);function US(r,e,t,n){let s=vn(r,e+1,n);if(typeof s!="bigint"){let o=-1-s;if(o>=Number.MIN_SAFE_INTEGER)return new j(P.negint,o,9)}if(n.allowBigInt!==!0)throw new Error(`${de} integers outside of the safe integer range are not supported`);return new j(P.negint,$4-BigInt(s),9)}function q0(r,e){let t=e.value,n=typeof t=="bigint"?t*$4-MS:t*-1-1;vr(r,e.type.majorEncoded,n)}q0.encodedSize=function(e){let t=e.value,n=typeof t=="bigint"?t*$4-MS:t*-1-1;return n<fr[0]?1:n<fr[1]?2:n<fr[2]?3:n<fr[3]?5:9};q0.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function zh(r,e,t,n){Ho(r,e,t+n);let s=Wl(r,e+t,e+t+n);return new j(P.bytes,s,t+n)}function FS(r,e,t,n){return zh(r,e,1,t)}function VS(r,e,t,n){return zh(r,e,2,bn(r,e+1,n))}function qS(r,e,t,n){return zh(r,e,3,wn(r,e+1,n))}function HS(r,e,t,n){return zh(r,e,5,En(r,e+1,n))}function zS(r,e,t,n){let s=vn(r,e+1,n);if(typeof s=="bigint")throw new Error(`${de} 64-bit integer bytes lengths not supported`);return zh(r,e,9,s)}function H0(r){return r.encodedBytes===void 0&&(r.encodedBytes=r.type===P.string?V0(r.value):r.value),r.encodedBytes}function jl(r,e){let t=H0(e);vr(r,e.type.majorEncoded,t.length),r.push(t)}jl.encodedSize=function(e){let t=H0(e);return vr.encodedSize(t.length)+t.length};jl.compareTokens=function(e,t){return R$(H0(e),H0(t))};function R$(r,e){return r.length<e.length?-1:r.length>e.length?1:DS(r,e)}function $h(r,e,t,n,s){let o=t+n;Ho(r,e,o);let i=new j(P.string,IS(r,e+t,e+o),o);return s.retainStringBytes===!0&&(i.byteValue=Wl(r,e+t,e+o)),i}function $S(r,e,t,n){return $h(r,e,1,t,n)}function GS(r,e,t,n){return $h(r,e,2,bn(r,e+1,n),n)}function WS(r,e,t,n){return $h(r,e,3,wn(r,e+1,n),n)}function YS(r,e,t,n){return $h(r,e,5,En(r,e+1,n),n)}function jS(r,e,t,n){let s=vn(r,e+1,n);if(typeof s=="bigint")throw new Error(`${de} 64-bit integer string lengths not supported`);return $h(r,e,9,s,n)}var QS=jl;function Ql(r,e,t,n){return new j(P.array,n,t)}function XS(r,e,t,n){return Ql(r,e,1,t)}function JS(r,e,t,n){return Ql(r,e,2,bn(r,e+1,n))}function ZS(r,e,t,n){return Ql(r,e,3,wn(r,e+1,n))}function e_(r,e,t,n){return Ql(r,e,5,En(r,e+1,n))}function t_(r,e,t,n){let s=vn(r,e+1,n);if(typeof s=="bigint")throw new Error(`${de} 64-bit integer array lengths not supported`);return Ql(r,e,9,s)}function r_(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${de} indefinite length items not allowed`);return Ql(r,e,1,1/0)}function z0(r,e){vr(r,P.array.majorEncoded,e.value)}z0.compareTokens=Kn.compareTokens;z0.encodedSize=function(e){return vr.encodedSize(e.value)};function Xl(r,e,t,n){return new j(P.map,n,t)}function n_(r,e,t,n){return Xl(r,e,1,t)}function s_(r,e,t,n){return Xl(r,e,2,bn(r,e+1,n))}function o_(r,e,t,n){return Xl(r,e,3,wn(r,e+1,n))}function i_(r,e,t,n){return Xl(r,e,5,En(r,e+1,n))}function a_(r,e,t,n){let s=vn(r,e+1,n);if(typeof s=="bigint")throw new Error(`${de} 64-bit integer map lengths not supported`);return Xl(r,e,9,s)}function c_(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${de} indefinite length items not allowed`);return Xl(r,e,1,1/0)}function $0(r,e){vr(r,P.map.majorEncoded,e.value)}$0.compareTokens=Kn.compareTokens;$0.encodedSize=function(e){return vr.encodedSize(e.value)};function l_(r,e,t,n){return new j(P.tag,t,1)}function u_(r,e,t,n){return new j(P.tag,bn(r,e+1,n),2)}function f_(r,e,t,n){return new j(P.tag,wn(r,e+1,n),3)}function h_(r,e,t,n){return new j(P.tag,En(r,e+1,n),5)}function p_(r,e,t,n){return new j(P.tag,vn(r,e+1,n),9)}function G0(r,e){vr(r,P.tag.majorEncoded,e.value)}G0.compareTokens=Kn.compareTokens;G0.encodedSize=function(e){return vr.encodedSize(e.value)};var C$=20,B$=21,N$=22,L$=23;function d_(r,e,t,n){if(n.allowUndefined===!1)throw new Error(`${de} undefined values are not supported`);return n.coerceUndefinedToNull===!0?new j(P.null,null,1):new j(P.undefined,void 0,1)}function m_(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${de} indefinite length items not allowed`);return new j(P.break,void 0,1)}function G4(r,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(r))throw new Error(`${de} NaN values are not supported`);if(t.allowInfinity===!1&&(r===1/0||r===-1/0))throw new Error(`${de} Infinity values are not supported`)}return new j(P.float,r,e)}function y_(r,e,t,n){return G4(W4(r,e+1),3,n)}function g_(r,e,t,n){return G4(Y4(r,e+1),5,n)}function b_(r,e,t,n){return G4(x_(r,e+1),9,n)}function W0(r,e,t){let n=e.value;if(n===!1)r.push([P.float.majorEncoded|C$]);else if(n===!0)r.push([P.float.majorEncoded|B$]);else if(n===null)r.push([P.float.majorEncoded|N$]);else if(n===void 0)r.push([P.float.majorEncoded|L$]);else{let s,o=!1;(!t||t.float64!==!0)&&(E_(n),s=W4(ms,1),n===s||Number.isNaN(n)?(ms[0]=249,r.push(ms.slice(0,3)),o=!0):(v_(n),s=Y4(ms,1),n===s&&(ms[0]=250,r.push(ms.slice(0,5)),o=!0))),o||(O$(n),s=x_(ms,1),ms[0]=251,r.push(ms.slice(0,9)))}}W0.encodedSize=function(e,t){let n=e.value;if(n===!1||n===!0||n===null||n===void 0)return 1;if(!t||t.float64!==!0){E_(n);let s=W4(ms,1);if(n===s||Number.isNaN(n))return 3;if(v_(n),s=Y4(ms,1),n===s)return 5}return 9};var w_=new ArrayBuffer(9),Mn=new DataView(w_,1),ms=new Uint8Array(w_,0);function E_(r){if(r===1/0)Mn.setUint16(0,31744,!1);else if(r===-1/0)Mn.setUint16(0,64512,!1);else if(Number.isNaN(r))Mn.setUint16(0,32256,!1);else{Mn.setFloat32(0,r);let e=Mn.getUint32(0),t=(e&2139095040)>>23,n=e&8388607;if(t===255)Mn.setUint16(0,31744,!1);else if(t===0)Mn.setUint16(0,(r&2147483648)>>16|n>>13,!1);else{let s=t-127;s<-24?Mn.setUint16(0,0):s<-14?Mn.setUint16(0,(e&2147483648)>>16|1<<24+s,!1):Mn.setUint16(0,(e&2147483648)>>16|s+15<<10|n>>13,!1)}}}function W4(r,e){if(r.length-e<2)throw new Error(`${de} not enough data for float16`);let t=(r[e]<<8)+r[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;let n=t>>10&31,s=t&1023,o;return n===0?o=s*2**-24:n!==31?o=(s+1024)*2**(n-25):o=s===0?1/0:NaN,t&32768?-o:o}function v_(r){Mn.setFloat32(0,r,!1)}function Y4(r,e){if(r.length-e<4)throw new Error(`${de} not enough data for float32`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,4).getFloat32(0,!1)}function O$(r){Mn.setFloat64(0,r,!1)}function x_(r,e){if(r.length-e<8)throw new Error(`${de} not enough data for float64`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,8).getFloat64(0,!1)}W0.compareTokens=Kn.compareTokens;function et(r,e,t){throw new Error(`${de} encountered invalid minor (${t}) for major ${r[e]>>>5}`)}function Y0(r){return()=>{throw new Error(`${de} ${r}`)}}var te=[];for(let r=0;r<=23;r++)te[r]=et;te[24]=PS;te[25]=CS;te[26]=BS;te[27]=NS;te[28]=et;te[29]=et;te[30]=et;te[31]=et;for(let r=32;r<=55;r++)te[r]=et;te[56]=LS;te[57]=OS;te[58]=KS;te[59]=US;te[60]=et;te[61]=et;te[62]=et;te[63]=et;for(let r=64;r<=87;r++)te[r]=FS;te[88]=VS;te[89]=qS;te[90]=HS;te[91]=zS;te[92]=et;te[93]=et;te[94]=et;te[95]=Y0("indefinite length bytes/strings are not supported");for(let r=96;r<=119;r++)te[r]=$S;te[120]=GS;te[121]=WS;te[122]=YS;te[123]=jS;te[124]=et;te[125]=et;te[126]=et;te[127]=Y0("indefinite length bytes/strings are not supported");for(let r=128;r<=151;r++)te[r]=XS;te[152]=JS;te[153]=ZS;te[154]=e_;te[155]=t_;te[156]=et;te[157]=et;te[158]=et;te[159]=r_;for(let r=160;r<=183;r++)te[r]=n_;te[184]=s_;te[185]=o_;te[186]=i_;te[187]=a_;te[188]=et;te[189]=et;te[190]=et;te[191]=c_;for(let r=192;r<=215;r++)te[r]=l_;te[216]=u_;te[217]=f_;te[218]=h_;te[219]=p_;te[220]=et;te[221]=et;te[222]=et;te[223]=et;for(let r=224;r<=243;r++)te[r]=Y0("simple values are not supported");te[244]=et;te[245]=et;te[246]=et;te[247]=d_;te[248]=Y0("simple values are not supported");te[249]=y_;te[250]=g_;te[251]=b_;te[252]=et;te[253]=et;te[254]=et;te[255]=m_;var ys=[];for(let r=0;r<24;r++)ys[r]=new j(P.uint,r,1);for(let r=-1;r>=-24;r--)ys[31-r]=new j(P.negint,r,1);ys[64]=new j(P.bytes,new Uint8Array(0),1);ys[96]=new j(P.string,"",1);ys[128]=new j(P.array,0,1);ys[160]=new j(P.map,0,1);ys[244]=new j(P.false,!1,1);ys[245]=new j(P.true,!0,1);ys[246]=new j(P.null,null,1);function S_(r){switch(r.type){case P.false:return Gs([244]);case P.true:return Gs([245]);case P.null:return Gs([246]);case P.bytes:return r.value.length?void 0:Gs([64]);case P.string:return r.value===""?Gs([96]):void 0;case P.array:return r.value===0?Gs([128]):void 0;case P.map:return r.value===0?Gs([160]):void 0;case P.uint:return r.value<24?Gs([Number(r.value)]):void 0;case P.negint:if(r.value>=-24)return Gs([31-Number(r.value)])}}var M$={float64:!1,mapSorter:V$,quickEncodeToken:S_};function U$(){let r=[];return r[P.uint.major]=Kn,r[P.negint.major]=q0,r[P.bytes.major]=jl,r[P.string.major]=QS,r[P.array.major]=z0,r[P.map.major]=$0,r[P.tag.major]=G0,r[P.float.major]=W0,r}var __=U$(),j4=new qh,Q0=class r{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${Yl} object contains circular references`);return new r(t,e)}},Gi={null:new j(P.null,null),undefined:new j(P.undefined,void 0),true:new j(P.true,!0),false:new j(P.false,!1),emptyArray:new j(P.array,0),emptyMap:new j(P.map,0)},Wi={number(r,e,t,n){return!Number.isInteger(r)||!Number.isSafeInteger(r)?new j(P.float,r):r>=0?new j(P.uint,r):new j(P.negint,r)},bigint(r,e,t,n){return r>=BigInt(0)?new j(P.uint,r):new j(P.negint,r)},Uint8Array(r,e,t,n){return new j(P.bytes,r)},string(r,e,t,n){return new j(P.string,r)},boolean(r,e,t,n){return r?Gi.true:Gi.false},null(r,e,t,n){return Gi.null},undefined(r,e,t,n){return Gi.undefined},ArrayBuffer(r,e,t,n){return new j(P.bytes,new Uint8Array(r))},DataView(r,e,t,n){return new j(P.bytes,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))},Array(r,e,t,n){if(!r.length)return t.addBreakTokens===!0?[Gi.emptyArray,new j(P.break)]:Gi.emptyArray;n=Q0.createCheck(n,r);let s=[],o=0;for(let i of r)s[o++]=j0(i,t,n);return t.addBreakTokens?[new j(P.array,r.length),s,new j(P.break)]:[new j(P.array,r.length),s]},Object(r,e,t,n){let s=e!=="Object",o=s?r.keys():Object.keys(r),i=s?r.size:o.length;if(!i)return t.addBreakTokens===!0?[Gi.emptyMap,new j(P.break)]:Gi.emptyMap;n=Q0.createCheck(n,r);let a=[],c=0;for(let l of o)a[c++]=[j0(l,t,n),j0(s?r.get(l):r[l],t,n)];return F$(a,t),t.addBreakTokens?[new j(P.map,i),a,new j(P.break)]:[new j(P.map,i),a]}};Wi.Map=Wi.Object;Wi.Buffer=Wi.Uint8Array;for(let r of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Wi[`${r}Array`]=Wi.DataView;function j0(r,e={},t){let n=SS(r),s=e&&e.typeEncoders&&e.typeEncoders[n]||Wi[n];if(typeof s=="function"){let i=s(r,n,e,t);if(i!=null)return i}let o=Wi[n];if(!o)throw new Error(`${Yl} unsupported type: ${n}`);return o(r,n,e,t)}function F$(r,e){e.mapSorter&&r.sort(e.mapSorter)}function V$(r,e){let t=Array.isArray(r[0])?r[0][0]:r[0],n=Array.isArray(e[0])?e[0][0]:e[0];if(t.type!==n.type)return t.type.compare(n.type);let s=t.type.major,o=__[s].compareTokens(t,n);return o===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),o}function A_(r,e,t,n){if(Array.isArray(e))for(let s of e)A_(r,s,t,n);else t[e.type.major](r,e,n)}function R_(r,e,t){let n=j0(r,t);if(!Array.isArray(n)&&t.quickEncodeToken){let s=t.quickEncodeToken(n);if(s)return s;let o=e[n.type.major];if(o.encodedSize){let i=o.encodedSize(n,t),a=new qh(i);if(o(a,n,t),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return Vh(a.chunks[0])}}return j4.reset(),A_(j4,n,e,t),j4.toBytes(!0)}function pc(r,e){return e=Object.assign({},M$,e),R_(r,__,e)}var q$={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0},Q4=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){let e=this.data[this._pos],t=ys[e];if(t===void 0){let n=te[e];if(!n)throw new Error(`${de} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);let s=e&31;t=n(this.data,this._pos,s,this.options)}return this._pos+=t.encodedLength,t}},Gh=Symbol.for("DONE"),X0=Symbol.for("BREAK");function H$(r,e,t){let n=[];for(let s=0;s<r.value;s++){let o=Wh(e,t);if(o===X0){if(r.value===1/0)break;throw new Error(`${de} got unexpected break to lengthed array`)}if(o===Gh)throw new Error(`${de} found array but not enough entries (got ${s}, expected ${r.value})`);n[s]=o}return n}function z$(r,e,t){let n=t.useMaps===!0,s=n?void 0:{},o=n?new Map:void 0;for(let i=0;i<r.value;i++){let a=Wh(e,t);if(a===X0){if(r.value===1/0)break;throw new Error(`${de} got unexpected break to lengthed map`)}if(a===Gh)throw new Error(`${de} found map but not enough entries (got ${i} [no key], expected ${r.value})`);if(n!==!0&&typeof a!="string")throw new Error(`${de} non-string keys not supported (got ${typeof a})`);if(t.rejectDuplicateMapKeys===!0&&(n&&o.has(a)||!n&&a in s))throw new Error(`${de} found repeat map key "${a}"`);let c=Wh(e,t);if(c===Gh)throw new Error(`${de} found map but not enough entries (got ${i} [no value], expected ${r.value})`);n?o.set(a,c):s[a]=c}return n?o:s}function Wh(r,e){if(r.done())return Gh;let t=r.next();if(t.type===P.break)return X0;if(t.type.terminal)return t.value;if(t.type===P.array)return H$(t,r,e);if(t.type===P.map)return z$(t,r,e);if(t.type===P.tag){if(e.tags&&typeof e.tags[t.value]=="function"){let n=Wh(r,e);return e.tags[t.value](n)}throw new Error(`${de} tag not supported (${t.value})`)}throw new Error("unsupported")}function X4(r,e){if(!(r instanceof Uint8Array))throw new Error(`${de} data to decode must be a Uint8Array`);e=Object.assign({},q$,e);let t=e.tokenizer||new Q4(r,e),n=Wh(t,e);if(n===Gh)throw new Error(`${de} did not find any content to decode`);if(n===X0)throw new Error(`${de} got unexpected break`);return[n,r.subarray(t.pos())]}function sn(r,e){let[t,n]=X4(r,e);if(n.length>0)throw new Error(`${de} too many terminals, data makes no sense`);return t}var $$=42;function G$(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return Ve.decode(r.subarray(1))}var W$={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};W$.tags[$$]=G$;var I_=113;var T_=class extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){let t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===P.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===P.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[P.uint.major](e,t){this.prefix(e);let n=String(t.value),s=[];for(let o=0;o<n.length;o++)s[o]=n.charCodeAt(o);e.push(s)}[P.negint.major](e,t){this[P.uint.major](e,t)}[P.bytes.major](e,t){throw new Error(`${Yl} unsupported type: Uint8Array`)}[P.string.major](e,t){this.prefix(e);let n=V0(JSON.stringify(t.value));e.push(n.length>32?Vh(n):n)}[P.array.major](e,t){this.prefix(e),this.inRecursive.push({type:P.array,elements:0}),e.push([91])}[P.map.major](e,t){this.prefix(e),this.inRecursive.push({type:P.map,elements:0}),e.push([123])}[P.tag.major](e,t){}[P.float.major](e,t){if(t.type.name==="break"){let i=this.inRecursive.pop();if(i){if(i.type===P.array)e.push([93]);else if(i.type===P.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${Yl} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}let n=String(t.value),s=[],o=!1;for(let i=0;i<n.length;i++)s[i]=n.charCodeAt(i),!o&&(s[i]===46||s[i]===101||s[i]===69)&&(o=!0);o||(s.push(46),s.push(48)),e.push(s)}};var dc=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${de} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${de} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){let e=this._pos,t=!1,n=!1,s=a=>{for(;!this.done();){let c=this.ch();if(a.includes(c))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,n=!0;else return new j(P.uint,0,this._pos-e);if(s([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${de} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${de} unexpected token at position ${this._pos}`);n=!0,this._pos++,s([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,s([48,49,50,51,52,53,54,55,56,57]));let o=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),i=parseFloat(o);return n?new j(P.float,i,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(i)?new j(i>=0?P.uint:P.negint,i,this._pos-e):new j(i>=0?P.uint:P.negint,BigInt(o),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${de} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let o=this._pos,i=0;o<this.data.length&&i<65536;o++,i++){let a=this.data[o];if(a===92||a<32||a>=128)break;if(a===34){let c=String.fromCharCode.apply(null,this.data.subarray(this._pos,o));return this._pos=o+1,new j(P.string,c,i)}}let e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${de} unexpected end of unicode escape sequence at position ${this._pos}`);let o=0;for(let i=0;i<4;i++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${de} unexpected unicode escape character at position ${this._pos}`);o=o*16+a,this._pos++}return o},s=()=>{let o=this.ch(),i=null,a=o>239?4:o>223?3:o>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${de} unexpected unicode sequence at position ${this._pos}`);let c,l,u,f;switch(a){case 1:o<128&&(i=o);break;case 2:c=this.data[this._pos+1],(c&192)===128&&(f=(o&31)<<6|c&63,f>127&&(i=f));break;case 3:c=this.data[this._pos+1],l=this.data[this._pos+2],(c&192)===128&&(l&192)===128&&(f=(o&15)<<12|(c&63)<<6|l&63,f>2047&&(f<55296||f>57343)&&(i=f));break;case 4:c=this.data[this._pos+1],l=this.data[this._pos+2],u=this.data[this._pos+3],(c&192)===128&&(l&192)===128&&(u&192)===128&&(f=(o&15)<<18|(c&63)<<12|(l&63)<<6|u&63,f>65535&&f<1114112&&(i=f))}i===null?(i=65533,a=1):i>65535&&(i-=65536,t.push(i>>>10&1023|55296),i=56320|i&1023),t.push(i),this._pos+=a};for(;!this.done();){let o=this.ch(),i;switch(o){case 92:if(this._pos++,this.done())throw new Error(`${de} unexpected string termination at position ${this._pos}`);switch(i=this.ch(),this._pos++,i){case 34:case 39:case 92:case 47:t.push(i);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${de} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new j(P.string,z4(t),this._pos-e);default:if(o<32)throw new Error(`${de} invalid control character at position ${this._pos}`);o<128?(t.push(o),this._pos++):s()}}throw new Error(`${de} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new j(P.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new j(P.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new j(P.null,null,4);case 102:return this.expect([102,97,108,115,101]),new j(P.false,!1,5);case 116:return this.expect([116,114,117,101]),new j(P.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${de} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new j(P.break,void 0,1);if(this.ch()!==44)throw new Error(`${de} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new j(P.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new j(P.break,void 0,1);if(this.ch()!==44)throw new Error(`${de} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new j(P.break,void 0,1);let e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${de} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${de} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}};function J0(r,e){return e=Object.assign({tokenizer:new dc(r,e)},e),sn(r,e)}var Q$={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};Q$.tags[42]=Ve.parse;var D_=297;var Gye=new TextDecoder;var Wye=new TextEncoder;var J$=new TextDecoder;function J4(r,e){let t=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(e>=r.length)throw new Error("protobuf: unexpected end of data");let s=r[e++];if(t+=n<28?(s&127)<<n:(s&127)*2**n,s<128)break}return[t,e]}function Z0(r,e){let t;[t,e]=J4(r,e);let n=e+t;if(t<0||n<0)throw new Error("protobuf: invalid length");if(n>r.length)throw new Error("protobuf: unexpected end of data");return[r.subarray(e,n),n]}function P_(r,e){let t;return[t,e]=J4(r,e),[t&7,t>>3,e]}function Z$(r){let e={},t=r.length,n=0;for(;n<t;){let s,o;if([s,o,n]=P_(r,n),o===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(s!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,n]=Z0(r,n)}else if(o===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(s!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let i;[i,n]=Z0(r,n),e.Name=J$.decode(i)}else if(o===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(s!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Tsize`);[e.Tsize,n]=J4(r,n)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${o}`)}if(n>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function C_(r){let e=r.length,t=0,n,s=!1,o;for(;t<e;){let a,c;if([a,c,t]=P_(r,t),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(c===1){if(o)throw new Error("protobuf: (PBNode) duplicate Data section");[o,t]=Z0(r,t),n&&(s=!0)}else if(c===2){if(s)throw new Error("protobuf: (PBNode) duplicate Links section");n||(n=[]);let l;[l,t]=Z0(r,t),n.push(Z$(l))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${c}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");let i={};return o&&(i.Data=o),i.Links=n||[],i}var jye=new TextEncoder,Qye=2**32,Xye=2**31;var ege=new TextEncoder;var B_=112;function N_(r){let e=C_(r),t={};return e.Data&&(t.Data=e.Data),e.Links&&(t.Links=e.Links.map(n=>{let s={};try{s.Hash=Ve.decode(n.Hash)}catch{}if(!s.Hash)throw new Error("Invalid Hash field found in link, expected CID");return n.Name!==void 0&&(s.Name=n.Name),n.Tsize!==void 0&&(s.Tsize=n.Tsize),s})),t}var L_={codec:B_,*walk(r){yield*N_(r).Links.map(t=>t.Hash)}},O_={codec:n0,*walk(){}},K_=42,M_={codec:I_,*walk(r){let e=[],t=[];t[K_]=n=>{if(n[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");let s=Ve.decode(n.subarray(1));return e.push(s),s},sn(r,{tags:t}),yield*e}},Z4=class extends dc{tokenBuffer;constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){let e=this._next();if(e.type===P.map){let t=this._next();if(t.type===P.string&&t.value==="/"){let n=this._next();if(n.type===P.string){if(this._next().type!==P.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new j(P.tag,42,0)}if(n.type===P.map){let s=this._next();if(s.type===P.string&&s.value==="bytes"){let o=this._next();if(o.type===P.string){for(let a=0;a<2;a++)if(this._next().type!==P.break)throw new Error("Invalid encoded Bytes form");let i=qe.decode(`m${o.value}`);return new j(P.bytes,i,o.value.length)}this.tokenBuffer.push(o)}this.tokenBuffer.push(s)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}},U_={codec:D_,*walk(r){let e=[],t=[];t[K_]=n=>{let s=Ve.parse(n);return e.push(s),s},J0(r,{tags:t,tokenizer:new Z4(r,{tags:t,allowIndefinite:!0,allowUndefined:!0,allowNaN:!0,allowInfinity:!0,allowBigInt:!0,strict:!1,rejectDuplicateMapKeys:!1})}),yield*e}},F_={codec:y9,*walk(){}};var tG=[O_,L_,M_,U_,F_],z_="/pin/",V_="/pinned-block/",e8=Ui,q_=1;function H_(r){return r.version===0&&(r=r.toV1()),new ct(`${z_}${r.toString(e8)}`)}var e1=class{datastore;blockstore;dagWalkers;constructor(e,t,n){this.datastore=e,this.blockstore=t,this.dagWalkers={},[...tG,...n].forEach(s=>{this.dagWalkers[s.codec]=s})}async*add(e,t={}){let n=H_(e);if(await this.datastore.has(n))throw new Error("Already pinned");let s=Math.round(t.depth??1/0);if(s<0)throw new Error("Depth must be greater than or equal to 0");let o=new qo({concurrency:q_});for await(let a of this.#e(e,o,{...t,depth:s}))await this.#t(a,c=>c.pinnedBy.find(l=>q(l,e.bytes))!=null?!1:(c.pinCount++,c.pinnedBy.push(e.bytes),!0),t),yield a;let i={depth:s,metadata:t.metadata??{}};await this.datastore.put(n,pc(i),t)}async*#e(e,t,n){if(n.depth===-1)return;let s=this.dagWalkers[e.code];if(s==null)throw new Error(`No dag walker found for cid codec ${e.code}`);let o=await this.blockstore.get(e,n);yield e;for await(let i of s.walk(o))yield*await t.add(async()=>this.#e(i,t,{...n,depth:n.depth-1}))}async#t(e,t,n){let s=new ct(`${V_}${e8.encode(e.multihash.bytes)}`),o={pinCount:0,pinnedBy:[]};try{o=sn(await this.datastore.get(s,n))}catch(a){if(a.code!=="ERR_NOT_FOUND")throw a}if(t(o)){if(o.pinCount===0&&await this.datastore.has(s)){await this.datastore.delete(s);return}await this.datastore.put(s,pc(o),n),n.onProgress?.(new $e("helia:pin:add",e))}}async*rm(e,t={}){let n=H_(e),s=await this.datastore.get(n,t),o=sn(s);await this.datastore.delete(n,t);let i=new qo({concurrency:q_});for await(let a of this.#e(e,i,{...t,depth:o.depth}))await this.#t(a,c=>(c.pinCount--,c.pinnedBy=c.pinnedBy.filter(l=>q(l,e.bytes)),!0),{...t,depth:o.depth}),yield a}async*ls(e={}){for await(let{key:t,value:n}of this.datastore.query({prefix:z_+(e.cid!=null?`${e.cid.toString(Ui)}`:"")},e)){let s=Ve.parse(t.toString().substring(5),Ui),o=sn(n);yield{cid:s,...o}}}async isPinned(e,t={}){let n=new ct(`${V_}${e8.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}};var Qh=fe(G_(),1);var Yi=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},r8=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},W_=r=>globalThis.DOMException===void 0?new r8(r):new DOMException(r),Y_=r=>{let e=r.reason===void 0?W_("This operation was aborted."):r.reason;return e instanceof Error?e:W_(e)};function gs(r,e){let{milliseconds:t,fallback:n,message:s,customTimers:o={setTimeout,clearTimeout}}=e,i,c=new Promise((l,u)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:h}=e;h.aborted&&u(Y_(h)),h.addEventListener("abort",()=>{u(Y_(h))})}if(t===Number.POSITIVE_INFINITY){r.then(l,u);return}let f=new Yi;i=o.setTimeout.call(void 0,()=>{if(n){try{l(n())}catch(h){u(h)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?l():s instanceof Error?u(s):(f.message=s??`Promise timed out after ${t} milliseconds`,u(f))},t),(async()=>{try{l(await r)}catch(h){u(h)}})()}).finally(()=>{c.clear()});return c.clear=()=>{o.clearTimeout.call(void 0,i),i=void 0},c}function n8(r,e,t){let n=0,s=r.length;for(;s>0;){let o=Math.trunc(s/2),i=n+o;t(r[i],e)<=0?(n=++i,s-=o+1):s=o}return n}var Xh=class{#e=[];enqueue(e,t){t={priority:0,...t};let n={priority:t.priority,run:e};if(this.size&&this.#e[this.size-1].priority>=t.priority){this.#e.push(n);return}let s=n8(this.#e,n,(o,i)=>i.priority-o.priority);this.#e.splice(s,0,n)}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}};var Ws=class extends Qh.default{#e;#t;#r=0;#i;#c;#d=0;#s;#l;#n;#m;#o=0;#u;#a;#y;timeout;constructor(e){if(super(),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:Xh,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#e=e.carryoverConcurrencyCount,this.#t=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#i=e.intervalCap,this.#c=e.interval,this.#n=new e.queueClass,this.#m=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#y=e.throwOnTimeout===!0,this.#a=e.autoStart===!1}get#w(){return this.#t||this.#r<this.#i}get#E(){return this.#o<this.#u}#v(){this.#o--,this.#f(),this.emit("next")}#x(){this.#b(),this.#g(),this.#l=void 0}get#S(){let e=Date.now();if(this.#s===void 0){let t=this.#d-e;if(t<0)this.#r=this.#e?this.#o:0;else return this.#l===void 0&&(this.#l=setTimeout(()=>{this.#x()},t)),!0}return!1}#f(){if(this.#n.size===0)return this.#s&&clearInterval(this.#s),this.#s=void 0,this.emit("empty"),this.#o===0&&this.emit("idle"),!1;if(!this.#a){let e=!this.#S;if(this.#w&&this.#E){let t=this.#n.dequeue();return t?(this.emit("active"),t(),e&&this.#g(),!0):!1}}return!1}#g(){this.#t||this.#s!==void 0||(this.#s=setInterval(()=>{this.#b()},this.#c),this.#d=Date.now()+this.#c)}#b(){this.#r===0&&this.#o===0&&this.#s&&(clearInterval(this.#s),this.#s=void 0),this.#r=this.#e?this.#o:0,this.#h()}#h(){for(;this.#f(););}get concurrency(){return this.#u}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#u=e,this.#h()}async#_(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(e.reason)},{once:!0})})}async add(e,t={}){return t={timeout:this.timeout,throwOnTimeout:this.#y,...t},new Promise((n,s)=>{this.#n.enqueue(async()=>{this.#o++,this.#r++;try{t.signal?.throwIfAborted();let o=e({signal:t.signal});t.timeout&&(o=gs(Promise.resolve(o),{milliseconds:t.timeout})),t.signal&&(o=Promise.race([o,this.#_(t.signal)]));let i=await o;n(i),this.emit("completed",i)}catch(o){if(o instanceof Yi&&!t.throwOnTimeout){n();return}s(o),this.emit("error",o)}finally{this.#v()}},t),this.emit("add"),this.#f()})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this.#a?(this.#a=!1,this.#h(),this):this}pause(){this.#a=!0}clear(){this.#n=new this.#m}async onEmpty(){this.#n.size!==0&&await this.#p("empty")}async onSizeLessThan(e){this.#n.size<e||await this.#p("next",()=>this.#n.size<e)}async onIdle(){this.#o===0&&this.#n.size===0||await this.#p("idle")}async#p(e,t){return new Promise(n=>{let s=()=>{t&&!t()||(this.off(e,s),n())};this.on(e,s)})}get size(){return this.#n.size}sizeBy(e){return this.#n.filter(e).length}get pending(){return this.#o}get isPaused(){return this.#a}};var ji={},Jl=r=>{r.addEventListener("message",e=>{Jl.dispatchEvent("message",r,e)}),r.port!=null&&r.port.addEventListener("message",e=>{Jl.dispatchEvent("message",r,e)})};Jl.addEventListener=(r,e)=>{ji[r]==null&&(ji[r]=[]),ji[r].push(e)};Jl.removeEventListener=(r,e)=>{ji[r]!=null&&(ji[r]=ji[r].filter(t=>t===e))};Jl.dispatchEvent=function(r,e,t){ji[r]!=null&&ji[r].forEach(n=>n(e,t))};var s8=Jl;var o8="lock:worker:request-read",i8="lock:worker:release-read",a8="lock:master:grant-read",c8="lock:worker:request-write",l8="lock:worker:release-write",u8="lock:master:grant-write";var j_=(r=21)=>Math.random().toString().substring(2);var Q_=(r,e,t,n,s)=>(o,i)=>{if(i.data.type!==t)return;let a={type:i.data.type,name:i.data.name,identifier:i.data.identifier};r.dispatchEvent(new MessageEvent(e,{data:{name:a.name,handler:async()=>{o.postMessage({type:s,name:a.name,identifier:a.identifier}),await new Promise(c=>{let l=u=>{if(u==null||u.data==null)return;let f={type:u.data.type,name:u.data.name,identifier:u.data.identifier};f.type===n&&f.identifier===a.identifier&&(o.removeEventListener("message",l),c())};o.addEventListener("message",l)})}}}))},X_=(r,e,t,n)=>async()=>{let s=j_();return globalThis.postMessage({type:e,identifier:s,name:r}),new Promise(o=>{let i=a=>{if(a==null||a.data==null)return;let c={type:a.data.type,identifier:a.data.identifier};c.type===t&&c.identifier===s&&(globalThis.removeEventListener("message",i),o(()=>{globalThis.postMessage({type:n,identifier:s,name:r})}))};globalThis.addEventListener("message",i)})},sG={singleProcess:!1},J_=r=>{if(r=Object.assign({},sG,r),!!globalThis.document||r.singleProcess){let t=new EventTarget;return s8.addEventListener("message",Q_(t,"requestReadLock",o8,i8,a8)),s8.addEventListener("message",Q_(t,"requestWriteLock",c8,l8,u8)),t}return{isWorker:!0,readLock:t=>X_(t,o8,a8,i8),writeLock:t=>X_(t,c8,u8,l8)}};var mc={},Qi;async function f8(r,e){let t,n=new Promise(s=>{t=s});return r.add(async()=>gs((async()=>{await new Promise(s=>{t(()=>{s()})})})(),{milliseconds:e.timeout})),n}var oG=(r,e)=>{if(Qi.isWorker===!0)return{readLock:Qi.readLock(r,e),writeLock:Qi.writeLock(r,e)};let t=new Ws({concurrency:1}),n;return{async readLock(){if(n!=null)return f8(n,e);n=new Ws({concurrency:e.concurrency,autoStart:!1});let s=n,o=f8(n,e);return t.add(async()=>{s.start(),await s.onIdle().then(()=>{n===s&&(n=null)})}),o},async writeLock(){return n=null,f8(t,e)}}},iG={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function Jh(r){let e=Object.assign({},iG,r);return Qi==null&&(Qi=J_(e),Qi.isWorker!==!0&&(Qi.addEventListener("requestReadLock",t=>{mc[t.data.name]!=null&&mc[t.data.name].readLock().then(async n=>t.data.handler().finally(()=>{n()}))}),Qi.addEventListener("requestWriteLock",async t=>{mc[t.data.name]!=null&&mc[t.data.name].writeLock().then(async n=>t.data.handler().finally(()=>{n()}))}))),mc[e.name]==null&&(mc[e.name]=oG(e.name,e)),mc[e.name]}var r1=class{lock;child;pins;started;constructor(e,t,n={}){this.child=e,this.pins=t,this.lock=Jh({singleProcess:n.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await Fl(this.child),this.started=!0}async stop(){await Vl(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){let s=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{s()}}async*putMany(e,t={}){let n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async get(e,t={}){let n=await this.lock.readLock();try{return await this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){let n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){let n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){let n=await this.lock.writeLock();try{let s=this;yield*this.child.deleteMany(async function*(){for await(let o of e){if(await s.pins.isPinned(o))throw new Error("CID was pinned");yield o}}(),t)}finally{n()}}async has(e,t={}){let n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){let t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}};var h8=new ct("/version"),Z_=1;async function eA(r){if(!await r.has(h8)){await r.put(h8,R(`${Z_}`));return}let e=await r.get(h8),t=T(e);if(parseInt(t,10)!==Z_)throw new Error("Unknown datastore version, a datastore migration may be required")}function tA(r=[]){return[$,O3,Lt,...r]}var n1=class{libp2p;blockstore;datastore;pins;logger;log;constructor(e){this.logger=e.libp2p.logger,this.log=this.logger.forComponent("helia");let t=tA(e.hashers),n={blockstore:e.blockstore,datastore:e.datastore,libp2p:e.libp2p,hashers:t,logger:e.libp2p.logger},s=e.blockBrokers?.map(i=>i(n))??[V4()(n),q4()(n)],o=new Fh(n,{blockBrokers:s,hashers:t});this.pins=new e1(e.datastore,o,e.dagWalkers??[]),this.libp2p=e.libp2p,this.blockstore=new r1(o,this.pins,{holdGcLock:e.holdGcLock}),this.datastore=e.datastore}async start(){await eA(this.datastore),await Fl(this.blockstore),await this.libp2p.start()}async stop(){await this.libp2p.stop(),await Vl(this.blockstore)}async gc(e={}){let t=await this.blockstore.lock.writeLock();try{let n=this,s=this.blockstore.unwrap();this.log("gc start"),await Nn(s.deleteMany(async function*(){for await(let{cid:o}of s.getAll())try{if(await n.pins.isPinned(o,e))continue;yield o,e.onProgress?.(new $e("helia:gc:deleted",o))}catch(i){n.log.error("Error during gc",i),e.onProgress?.(new $e("helia:gc:error",i))}}()))}finally{t()}this.log("gc finished")}};var aG=Symbol.for("nodejs.util.inspect.custom"),rA=Object.values(Ln).map(r=>r.decoder).reduce((r,e)=>r.or(e),Ln.identity.decoder),nA=114,p8=36,d8=37,Zh=class{type;multihash;privateKey;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[j3]=!0;toString(){return this.string==null&&(this.string=Fe.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return Ve.createV1(nA,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return q(this.multihash.bytes,e);if(typeof e=="string")return Ce(e).equals(this);if(e?.multihash?.bytes!=null)return q(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[aG](){return`PeerId(${this.toString()})`}},yc=class extends Zh{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},gc=class extends Zh{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.multihash.digest}},bc=class extends Zh{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.multihash.digest}};function sA(r){if(r.type==="RSA")return new yc(r);if(r.type==="Ed25519")return new gc(r);if(r.type==="secp256k1")return new bc(r);throw new g("Not a PeerId","ERR_INVALID_PARAMETERS")}function Ce(r,e){if(e=e??rA,r.charAt(0)==="1"||r.charAt(0)==="Q"){let t=qs(Fe.decode(`z${r}`));return r.startsWith("12D")?new gc({multihash:t}):r.startsWith("16U")?new bc({multihash:t}):new yc({multihash:t})}return dt(rA.decode(r))}function dt(r){try{let e=qs(r);if(e.code===Lt.code){if(e.digest.length===p8)return new gc({multihash:e});if(e.digest.length===d8)return new bc({multihash:e})}if(e.code===$.code)return new yc({multihash:e})}catch{return cG(Ve.decode(r))}throw new Error("Supplied PeerID CID is invalid")}function cG(r){if(r==null||r.multihash==null||r.version==null||r.version===1&&r.code!==nA)throw new Error("Supplied PeerID CID is invalid");let e=r.multihash;if(e.code===$.code)return new yc({multihash:r.multihash});if(e.code===Lt.code){if(e.digest.length===p8)return new gc({multihash:r.multihash});if(e.digest.length===d8)return new bc({multihash:r.multihash})}throw new Error("Supplied PeerID CID is invalid")}async function xr(r,e){return r.length===p8?new gc({multihash:as(Lt.code,r),privateKey:e}):r.length===d8?new bc({multihash:as(Lt.code,r),privateKey:e}):new yc({multihash:await $.digest(r),publicKey:r,privateKey:e})}var m8="/floodsub/1.0.0",y8="/meshsub/1.0.0",g8="/meshsub/1.1.0";var oA="ERR_TOPIC_VALIDATOR_REJECT",iA="ERR_TOPIC_VALIDATOR_IGNORE";var nR=fe(P8(),1),sR={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};function oR(r,e){e={...e};let t=nR.default.Reader.create(r),n=r.length,s=n===void 0?t.len:t.pos+n,o={};for(;t.pos<s;){let i=t.uint32();switch(i>>>3){case 1:o.subscriptions!=null&&o.subscriptions.length>0||(o.subscriptions=[]),o.subscriptions.length<e.maxSubscriptions?o.subscriptions.push(EG(t,t.uint32())):t.skipType(i&7);break;case 2:o.messages!=null&&o.messages.length>0||(o.messages=[]),o.messages.length<e.maxMessages?o.messages.push(vG(t,t.uint32())):t.skipType(i&7);break;case 3:o.control=xG(t,t.uint32(),e);break;default:t.skipType(i&7);break}}return o}function EG(r,e){let t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){let s=r.uint32();switch(s>>>3){case 1:n.subscribe=r.bool();break;case 2:n.topic=r.string();break;default:r.skipType(s&7);break}}return n}function vG(r,e){let t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){let s=r.uint32();switch(s>>>3){case 1:n.from=r.bytes();break;case 2:n.data=r.bytes();break;case 3:n.seqno=r.bytes();break;case 4:n.topic=r.string();break;case 5:n.signature=r.bytes();break;case 6:n.key=r.bytes();break;default:r.skipType(s&7);break}}if(!n.topic)throw Error("missing required 'topic'");return n}function xG(r,e,t){let n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){let o=r.uint32();switch(o>>>3){case 1:s.ihave!=null&&s.ihave.length>0||(s.ihave=[]),s.ihave.length<t.maxControlMessages?s.ihave.push(SG(r,r.uint32(),t)):r.skipType(o&7);break;case 2:s.iwant!=null&&s.iwant.length>0||(s.iwant=[]),s.iwant.length<t.maxControlMessages?s.iwant.push(_G(r,r.uint32(),t)):r.skipType(o&7);break;case 3:s.graft!=null&&s.graft.length>0||(s.graft=[]),s.graft.length<t.maxControlMessages?s.graft.push(AG(r,r.uint32())):r.skipType(o&7);break;case 4:s.prune!=null&&s.prune.length>0||(s.prune=[]),s.prune.length<t.maxControlMessages?s.prune.push(RG(r,r.uint32(),t)):r.skipType(o&7);break;default:r.skipType(o&7);break}}return s}function SG(r,e,t){let n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){let o=r.uint32();switch(o>>>3){case 1:s.topicID=r.string();break;case 2:s.messageIDs!=null&&s.messageIDs.length>0||(s.messageIDs=[]),t.maxIhaveMessageIDs-- >0?s.messageIDs.push(r.bytes()):r.skipType(o&7);break;default:r.skipType(o&7);break}}return s}function _G(r,e,t){let n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){let o=r.uint32();switch(o>>>3){case 1:s.messageIDs!=null&&s.messageIDs.length>0||(s.messageIDs=[]),t.maxIwantMessageIDs-- >0?s.messageIDs.push(r.bytes()):r.skipType(o&7);break;default:r.skipType(o&7);break}}return s}function AG(r,e){let t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){let s=r.uint32();switch(s>>>3){case 1:n.topicID=r.string();break;default:r.skipType(s&7);break}}return n}function RG(r,e,t){let n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){let o=r.uint32();switch(o>>>3){case 1:s.topicID=r.string();break;case 2:s.peers!=null&&s.peers.length>0||(s.peers=[]),t.maxPeerInfos-- >0?s.peers.push(IG(r,r.uint32())):r.skipType(o&7);break;case 3:s.backoff=r.uint64();break;default:r.skipType(o&7);break}}return s}function IG(r,e){let t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){let s=r.uint32();switch(s>>>3){case 1:n.peerID=r.bytes();break;case 2:n.signedPeerRecord=r.bytes();break;default:r.skipType(s&7);break}}return n}var cR=fe(aR(),1),{RPC:sp}=cR.default;var c1=class{gossip;msgs=new Map;msgIdToStrFn;history=[];notValidatedCount=0;constructor(e,t,n){this.gossip=e,this.msgIdToStrFn=n;for(let s=0;s<t;s++)this.history[s]=[]}get size(){return this.msgs.size}put(e,t,n=!1){let{msgIdStr:s}=e;return this.msgs.has(s)?!1:(this.msgs.set(s,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),n||this.notValidatedCount++,!0)}observeDuplicate(e,t){let n=this.msgs.get(e);n!=null&&!n.validated&&n.originatingPeers.add(t)}get(e){return this.msgs.get(this.msgIdToStrFn(e))?.message}getWithIWantCount(e,t){let n=this.msgs.get(e);if(n==null)return null;let s=(n.iwantCounts.get(t)??0)+1;return n.iwantCounts.set(t,s),{msg:n.message,count:s}}getGossipIDs(e){let t=new Map;for(let n=0;n<this.gossip;n++)this.history[n].forEach(s=>{if((this.msgs.get(s.msgIdStr)?.validated??!1)&&e.has(s.topic)){let i=t.get(s.topic);i==null&&(i=[],t.set(s.topic,i)),i.push(s.msgId)}});return t}validate(e){let t=this.msgs.get(e);if(t==null)return null;t.validated||this.notValidatedCount--;let{message:n,originatingPeers:s}=t;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:s}}shift(){this.history[this.history.length-1].forEach(t=>{let n=this.msgs.get(t.msgIdStr);n!=null&&(this.msgs.delete(t.msgIdStr),n.validated||this.notValidatedCount--)}),this.history.pop(),this.history.unshift([])}remove(e){let t=this.msgs.get(e);return t==null?null:(this.msgs.delete(e),t)}};var lR;(function(r){r.StrictSign="StrictSign",r.StrictNoSign="StrictNoSign"})(lR||(lR={}));var ea;(function(r){r[r.Signing=0]="Signing",r[r.Anonymous=1]="Anonymous"})(ea||(ea={}));var Gr;(function(r){r.Error="error",r.Ignore="ignore",r.Reject="reject",r.Blacklisted="blacklisted"})(Gr||(Gr={}));var Fr;(function(r){r.InvalidSignature="invalid_signature",r.InvalidSeqno="invalid_seqno",r.InvalidPeerId="invalid_peerid",r.SignaturePresent="signature_present",r.SeqnoPresent="seqno_present",r.FromPresent="from_present",r.TransformFailed="transform_failed"})(Fr||(Fr={}));var Vr;(function(r){r.duplicate="duplicate",r.invalid="invalid",r.valid="valid"})(Vr||(Vr={}));function C8(r){switch(r){case zr.Ignore:return Gr.Ignore;case zr.Reject:return Gr.Reject;default:throw new Error("Unreachable")}}var uR;(function(r){r.forward="forward",r.publish="publish"})(uR||(uR={}));var Wr;(function(r){r.Fanout="fanout",r.Random="random",r.Subscribed="subscribed",r.Outbound="outbound",r.NotEnough="not_enough",r.Opportunistic="opportunistic"})(Wr||(Wr={}));var vs;(function(r){r.Dc="disconnected",r.BadScore="bad_score",r.Prune="prune",r.Excess="excess"})(vs||(vs={}));var tu;(function(r){r.GraftBackoff="graft_backoff",r.BrokenPromise="broken_promise",r.MessageDeficit="message_deficit",r.IPColocation="IP_colocation"})(tu||(tu={}));var ru;(function(r){r.LowScore="low_score",r.MaxIhave="max_ihave",r.MaxIasked="max_iasked"})(ru||(ru={}));var eu;(function(r){r.graylist="graylist",r.publish="publish",r.gossip="gossip",r.mesh="mesh"})(eu||(eu={}));function fR(r,e,t){return{protocolsEnabled:r.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:r.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:r.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:r.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEventsFanout:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_fanout_total",help:"Number of times we include peers in a topic mesh for fanout reasons",labelNames:["topic"]}),meshPeerInclusionEventsRandom:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_random_total",help:"Number of times we include peers in a topic mesh for random reasons",labelNames:["topic"]}),meshPeerInclusionEventsSubscribed:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_subscribed_total",help:"Number of times we include peers in a topic mesh for subscribed reasons",labelNames:["topic"]}),meshPeerInclusionEventsOutbound:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_outbound_total",help:"Number of times we include peers in a topic mesh for outbound reasons",labelNames:["topic"]}),meshPeerInclusionEventsNotEnough:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_not_enough_total",help:"Number of times we include peers in a topic mesh for not_enough reasons",labelNames:["topic"]}),meshPeerInclusionEventsOpportunistic:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_opportunistic_total",help:"Number of times we include peers in a topic mesh for opportunistic reasons",labelNames:["topic"]}),meshPeerInclusionEventsUnknown:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_unknown_total",help:"Number of times we include peers in a topic mesh for unknown reasons",labelNames:["topic"]}),meshPeerChurnEventsDisconnected:r.gauge({name:"gossipsub_peer_churn_events_disconnected_total",help:"Number of times we remove peers in a topic mesh for disconnected reasons",labelNames:["topic"]}),meshPeerChurnEventsBadScore:r.gauge({name:"gossipsub_peer_churn_events_bad_score_total",help:"Number of times we remove peers in a topic mesh for bad_score reasons",labelNames:["topic"]}),meshPeerChurnEventsPrune:r.gauge({name:"gossipsub_peer_churn_events_prune_total",help:"Number of times we remove peers in a topic mesh for prune reasons",labelNames:["topic"]}),meshPeerChurnEventsExcess:r.gauge({name:"gossipsub_peer_churn_events_excess_total",help:"Number of times we remove peers in a topic mesh for excess reasons",labelNames:["topic"]}),meshPeerChurnEventsUnknown:r.gauge({name:"gossipsub_peer_churn_events_unknown_total",help:"Number of times we remove peers in a topic mesh for unknown reasons",labelNames:["topic"]}),peersPerProtocol:r.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:r.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:r.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),acceptedMessagesTotal:r.gauge({name:"gossipsub_accepted_messages_total",help:"Total accepted messages for each topic",labelNames:["topic"]}),ignoredMessagesTotal:r.gauge({name:"gossipsub_ignored_messages_total",help:"Total ignored messages for each topic",labelNames:["topic"]}),rejectedMessagesTotal:r.gauge({name:"gossipsub_rejected_messages_total",help:"Total rejected messages for each topic",labelNames:["topic"]}),unknownValidationResultsTotal:r.gauge({name:"gossipsub_unknown_validation_results_total",help:"Total unknown validation results for each topic",labelNames:["topic"]}),asyncValidationMcacheHit:r.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),asyncValidationDelayFromFirstSeenSec:r.histogram({name:"gossipsub_async_validation_delay_from_first_seen",help:"Async validation report delay from first seen in second",labelNames:["topic"],buckets:[.01,.03,.1,.3,1,3,10]}),asyncValidationUnknownFirstSeen:r.gauge({name:"gossipsub_async_validation_unknown_first_seen_count_total",help:"Async validation report unknown first seen value for message"}),peerReadStreamError:r.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:r.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:r.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:r.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:r.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:r.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:r.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:r.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:r.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:r.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:r.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:r.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:r.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:r.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:r.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:r.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:r.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:r.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:r.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:r.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:r.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:r.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),msgPublishCount:r.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeersByTopic:r.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),directPeersPublishedTotal:r.gauge({name:"gossipsub_direct_peers_published_total",help:"Total direct peers that we publish a msg to",labelNames:["topic"]}),floodsubPeersPublishedTotal:r.gauge({name:"gossipsub_floodsub_peers_published_total",help:"Total floodsub peers that we publish a msg to",labelNames:["topic"]}),meshPeersPublishedTotal:r.gauge({name:"gossipsub_mesh_peers_published_total",help:"Total mesh peers that we publish a msg to",labelNames:["topic"]}),fanoutPeersPublishedTotal:r.gauge({name:"gossipsub_fanout_peers_published_total",help:"Total fanout peers that we publish a msg to",labelNames:["topic"]}),msgPublishBytes:r.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgPublishTime:r.histogram({name:"gossipsub_msg_publish_seconds",help:"Total time in seconds to publish a message",buckets:[.001,.002,.005,.01,.1,.5,1],labelNames:["topic"]}),msgForwardCount:r.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:r.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:r.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:r.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),prevalidationInvalidTotal:r.gauge({name:"gossipsub_pre_validation_invalid_total",help:"Total count of invalid messages received",labelNames:["topic"]}),prevalidationValidTotal:r.gauge({name:"gossipsub_pre_validation_valid_total",help:"Total count of valid messages received",labelNames:["topic"]}),prevalidationDuplicateTotal:r.gauge({name:"gossipsub_pre_validation_duplicate_total",help:"Total count of duplicate messages received",labelNames:["topic"]}),prevalidationUnknownTotal:r.gauge({name:"gossipsub_pre_validation_unknown_status_total",help:"Total count of unknown_status messages received",labelNames:["topic"]}),msgReceivedInvalid:r.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["error"]}),msgReceivedInvalidByTopic:r.gauge({name:"gossipsub_msg_received_invalid_by_topic_total",help:"Tracks specific invalid message by topic",labelNames:["topic"]}),duplicateMsgDeliveryDelay:r.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*t.maxMeshMessageDeliveriesWindowSec,.5*t.maxMeshMessageDeliveriesWindowSec,Number(t.maxMeshMessageDeliveriesWindowSec),2*t.maxMeshMessageDeliveriesWindowSec,4*t.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:r.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:r.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:r.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:r.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:r.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:r.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:r.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores"}),scoreWeights:r.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:r.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:r.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:r.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*t.behaviourPenaltyThreshold,.5*t.behaviourPenaltyThreshold,Number(t.behaviourPenaltyThreshold),2*t.behaviourPenaltyThreshold,4*t.behaviourPenaltyThreshold]}),ihaveRcvIgnored:r.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:r.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:r.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:r.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),iwantPromiseStarted:r.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:r.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:r.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:r.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:r.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:r.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:r.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*t.gossipPromiseExpireSec,Number(t.gossipPromiseExpireSec),2*t.gossipPromiseExpireSec,4*t.gossipPromiseExpireSec]}),iwantPromiseUntracked:r.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),connectedPeersBackoffSec:r.histogram({name:"gossipsub_connected_peers_backoff_seconds",help:"Backoff time in seconds",buckets:[1,2,4,10,20,60,120]}),cacheSize:r.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:r.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:r.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:r.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:r.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:e,toTopic(n){return this.topicStrToLabel.get(n)??n},onJoin(n){this.topicSubscriptionStatus.set({topicStr:n},1),this.meshPeerCounts.set({topicStr:n},0)},onLeave(n){this.topicSubscriptionStatus.set({topicStr:n},0),this.meshPeerCounts.set({topicStr:n},0)},onAddToMesh(n,s,o){let i=this.toTopic(n);switch(s){case Wr.Fanout:this.meshPeerInclusionEventsFanout.inc({topic:i},o);break;case Wr.Random:this.meshPeerInclusionEventsRandom.inc({topic:i},o);break;case Wr.Subscribed:this.meshPeerInclusionEventsSubscribed.inc({topic:i},o);break;case Wr.Outbound:this.meshPeerInclusionEventsOutbound.inc({topic:i},o);break;case Wr.NotEnough:this.meshPeerInclusionEventsNotEnough.inc({topic:i},o);break;case Wr.Opportunistic:this.meshPeerInclusionEventsOpportunistic.inc({topic:i},o);break;default:this.meshPeerInclusionEventsUnknown.inc({topic:i},o);break}},onRemoveFromMesh(n,s,o){let i=this.toTopic(n);switch(s){case vs.Dc:this.meshPeerChurnEventsDisconnected.inc({topic:i},o);break;case vs.BadScore:this.meshPeerChurnEventsBadScore.inc({topic:i},o);break;case vs.Prune:this.meshPeerChurnEventsPrune.inc({topic:i},o);break;case vs.Excess:this.meshPeerChurnEventsExcess.inc({topic:i},o);break;default:this.meshPeerChurnEventsUnknown.inc({topic:i},o);break}},onReportValidation(n,s,o){if(this.asyncValidationMcacheHit.inc({hit:n!=null?"hit":"miss"}),n!=null){let i=this.toTopic(n.message.topic);switch(s){case zr.Accept:this.acceptedMessagesTotal.inc({topic:i});break;case zr.Ignore:this.ignoredMessagesTotal.inc({topic:i});break;case zr.Reject:this.rejectedMessagesTotal.inc({topic:i});break;default:this.unknownValidationResultsTotal.inc({topic:i});break}}o!=null?this.asyncValidationDelayFromFirstSeenSec.observe((Date.now()-o)/1e3):this.asyncValidationUnknownFirstSeen.inc()},onScorePenalty(n){this.scoringPenalties.inc({penalty:n},1)},onIhaveRcv(n,s,o){let i=this.toTopic(n);this.ihaveRcvMsgids.inc({topic:i},s),this.ihaveRcvNotSeenMsgids.inc({topic:i},o)},onIwantRcv(n,s){for(let[o,i]of n){let a=this.toTopic(o);this.iwantRcvMsgids.inc({topic:a},i)}this.iwantRcvDonthaveMsgids.inc(s)},onForwardMsg(n,s){let o=this.toTopic(n);this.msgForwardCount.inc({topic:o},1),this.msgForwardPeers.inc({topic:o},s)},onPublishMsg(n,s,o,i,a){let c=this.toTopic(n);this.msgPublishCount.inc({topic:c},1),this.msgPublishBytes.inc({topic:c},o*i),this.msgPublishPeersByTopic.inc({topic:c},o),this.directPeersPublishedTotal.inc({topic:c},s.direct),this.floodsubPeersPublishedTotal.inc({topic:c},s.floodsub),this.meshPeersPublishedTotal.inc({topic:c},s.mesh),this.fanoutPeersPublishedTotal.inc({topic:c},s.fanout),this.msgPublishTime.observe({topic:c},a/1e3)},onMsgRecvPreValidation(n){let s=this.toTopic(n);this.msgReceivedPreValidation.inc({topic:s},1)},onMsgRecvError(n){let s=this.toTopic(n);this.msgReceivedError.inc({topic:s},1)},onPrevalidationResult(n,s){let o=this.toTopic(n);switch(s){case Vr.duplicate:this.prevalidationDuplicateTotal.inc({topic:o});break;case Vr.invalid:this.prevalidationInvalidTotal.inc({topic:o});break;case Vr.valid:this.prevalidationValidTotal.inc({topic:o});break;default:this.prevalidationUnknownTotal.inc({topic:o});break}},onMsgRecvInvalid(n,s){let o=this.toTopic(n),i=s.reason===Gr.Error?s.error:s.reason;this.msgReceivedInvalid.inc({error:i},1),this.msgReceivedInvalidByTopic.inc({topic:o},1)},onDuplicateMsgDelivery(n,s,o){if(this.duplicateMsgDeliveryDelay.observe(s/1e3),o){let i=this.toTopic(n);this.duplicateMsgLateDelivery.inc({topic:i},1)}},onPublishDuplicateMsg(n){let s=this.toTopic(n);this.duplicateMsgIgnored.inc({topic:s},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(n,s){this.rpcRecvBytes.inc(s),this.rpcRecvCount.inc(1),n.subscriptions!=null&&this.rpcRecvSubscription.inc(n.subscriptions.length),n.messages!=null&&this.rpcRecvMessage.inc(n.messages.length),n.control!=null&&(this.rpcRecvControl.inc(1),n.control.ihave!=null&&this.rpcRecvIHave.inc(n.control.ihave.length),n.control.iwant!=null&&this.rpcRecvIWant.inc(n.control.iwant.length),n.control.graft!=null&&this.rpcRecvGraft.inc(n.control.graft.length),n.control.prune!=null&&this.rpcRecvPrune.inc(n.control.prune.length))},onRpcSent(n,s){if(this.rpcSentBytes.inc(s),this.rpcSentCount.inc(1),n.subscriptions!=null&&this.rpcSentSubscription.inc(n.subscriptions.length),n.messages!=null&&this.rpcSentMessage.inc(n.messages.length),n.control!=null){let o=n.control.ihave?.length??0,i=n.control.iwant?.length??0,a=n.control.graft?.length??0,c=n.control.prune?.length??0;o>0&&this.rpcSentIHave.inc(o),i>0&&this.rpcSentIWant.inc(i),a>0&&this.rpcSentGraft.inc(a),c>0&&this.rpcSentPrune.inc(c),(o>0||i>0||a>0||c>0)&&this.rpcSentControl.inc(1)}},registerScores(n,s){let o=0,i=0,a=0,c=0;for(let l of n)l>=s.graylistThreshold&&o++,l>=s.publishThreshold&&i++,l>=s.gossipThreshold&&a++,l>=0&&c++;this.peersByScoreThreshold.set({threshold:eu.graylist},o),this.peersByScoreThreshold.set({threshold:eu.publish},i),this.peersByScoreThreshold.set({threshold:eu.gossip},a),this.peersByScoreThreshold.set({threshold:eu.mesh},c),this.score.set(n)},registerScoreWeights(n){for(let[s,o]of n.byTopic)this.scoreWeights.set({topic:s,p:"p1"},o.p1w),this.scoreWeights.set({topic:s,p:"p2"},o.p2w),this.scoreWeights.set({topic:s,p:"p3"},o.p3w),this.scoreWeights.set({topic:s,p:"p3b"},o.p3bw),this.scoreWeights.set({topic:s,p:"p4"},o.p4w);this.scoreWeights.set({p:"p5"},n.p5w),this.scoreWeights.set({p:"p6"},n.p6w),this.scoreWeights.set({p:"p7"},n.p7w)},registerScorePerMesh(n,s){let o=new Map;n.forEach((i,a)=>{let c=this.topicStrToLabel.get(a)??"unknown",l=o.get(c);l==null&&(l=new Set,o.set(c,l)),i.forEach(u=>l?.add(u))});for(let[i,a]of o){let c=[];a.forEach(l=>{c.push(s.get(l)??0)}),this.scorePerMesh.set({topic:i},c)}}}}var ft="ERR_INVALID_PEER_SCORE_PARAMS";var TG={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:3600*1e3},kG={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function hR(r={}){return{...TG,...r,topics:r.topics!=null?Object.entries(r.topics).reduce((e,[t,n])=>(e[t]=DG(n),e),{}):{}}}function DG(r={}){return{...kG,...r}}function pR(r){for(let[e,t]of Object.entries(r.topics))try{PG(t)}catch(n){throw new g(`invalid score parameters for topic ${e}: ${n.message}`,ft)}if(r.topicScoreCap<0)throw new g("invalid topic score cap; must be positive (or 0 for no cap)",ft);if(r.appSpecificScore===null||r.appSpecificScore===void 0)throw new g("missing application specific score function",ft);if(r.IPColocationFactorWeight>0)throw new g("invalid IPColocationFactorWeight; must be negative (or 0 to disable)",ft);if(r.IPColocationFactorWeight!==0&&r.IPColocationFactorThreshold<1)throw new g("invalid IPColocationFactorThreshold; must be at least 1",ft);if(r.behaviourPenaltyWeight>0)throw new g("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)",ft);if(r.behaviourPenaltyWeight!==0&&(r.behaviourPenaltyDecay<=0||r.behaviourPenaltyDecay>=1))throw new g("invalid BehaviourPenaltyDecay; must be between 0 and 1",ft);if(r.decayInterval<1e3)throw new g("invalid DecayInterval; must be at least 1s",ft);if(r.decayToZero<=0||r.decayToZero>=1)throw new g("invalid DecayToZero; must be between 0 and 1",ft)}function PG(r){if(r.topicWeight<0)throw new g("invalid topic weight; must be >= 0",ft);if(r.timeInMeshQuantum===0)throw new g("invalid TimeInMeshQuantum; must be non zero",ft);if(r.timeInMeshWeight<0)throw new g("invalid TimeInMeshWeight; must be positive (or 0 to disable)",ft);if(r.timeInMeshWeight!==0&&r.timeInMeshQuantum<=0)throw new g("invalid TimeInMeshQuantum; must be positive",ft);if(r.timeInMeshWeight!==0&&r.timeInMeshCap<=0)throw new g("invalid TimeInMeshCap; must be positive",ft);if(r.firstMessageDeliveriesWeight<0)throw new g("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)",ft);if(r.firstMessageDeliveriesWeight!==0&&(r.firstMessageDeliveriesDecay<=0||r.firstMessageDeliveriesDecay>=1))throw new g("invalid FirstMessageDeliveriesDecay; must be between 0 and 1",ft);if(r.firstMessageDeliveriesWeight!==0&&r.firstMessageDeliveriesCap<=0)throw new g("invalid FirstMessageDeliveriesCap; must be positive",ft);if(r.meshMessageDeliveriesWeight>0)throw new g("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)",ft);if(r.meshMessageDeliveriesWeight!==0&&(r.meshMessageDeliveriesDecay<=0||r.meshMessageDeliveriesDecay>=1))throw new g("invalid MeshMessageDeliveriesDecay; must be between 0 and 1",ft);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesCap<=0)throw new g("invalid MeshMessageDeliveriesCap; must be positive",ft);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesThreshold<=0)throw new g("invalid MeshMessageDeliveriesThreshold; must be positive",ft);if(r.meshMessageDeliveriesWindow<0)throw new g("invalid MeshMessageDeliveriesWindow; must be non-negative",ft);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesActivation<1e3)throw new g("invalid MeshMessageDeliveriesActivation; must be at least 1s",ft);if(r.meshFailurePenaltyWeight>0)throw new g("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)",ft);if(r.meshFailurePenaltyWeight!==0&&(r.meshFailurePenaltyDecay<=0||r.meshFailurePenaltyDecay>=1))throw new g("invalid MeshFailurePenaltyDecay; must be between 0 and 1",ft);if(r.invalidMessageDeliveriesWeight>0)throw new g("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)",ft);if(r.invalidMessageDeliveriesDecay<=0||r.invalidMessageDeliveriesDecay>=1)throw new g("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1",ft)}var CG={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function dR(r={}){return{...CG,...r}}function u1(r,e,t=()=>!0){let n=new Set;if(e<=0)return n;for(let s of r){if(n.size>=e)break;t(s)&&(n.add(s),r.delete(s))}return n}function mR(r,e){return u1(r,e,()=>!0)}var l1=class extends Map{getDefault;constructor(e){super(),this.getDefault=e}getOrDefault(e){let t=super.get(e);return t===void 0&&(t=this.getDefault(),this.set(e,t)),t}};function yR(r,e,t,n){let s=0;Object.entries(e.topics).forEach(([i,a])=>{let c=t.topics[i];if(c===void 0)return;let l=0;if(a.inMesh){let d=a.meshTime/c.timeInMeshQuantum;d>c.timeInMeshCap&&(d=c.timeInMeshCap),l+=d*c.timeInMeshWeight}let u=a.firstMessageDeliveries;if(u>c.firstMessageDeliveriesCap&&(u=c.firstMessageDeliveriesCap),l+=u*c.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<c.meshMessageDeliveriesThreshold){let d=c.meshMessageDeliveriesThreshold-a.meshMessageDeliveries,p=d*d;l+=p*c.meshMessageDeliveriesWeight}let f=a.meshFailurePenalty;l+=f*c.meshFailurePenaltyWeight;let h=a.invalidMessageDeliveries*a.invalidMessageDeliveries;l+=h*c.invalidMessageDeliveriesWeight,s+=l*c.topicWeight}),t.topicScoreCap>0&&s>t.topicScoreCap&&(s=t.topicScoreCap);let o=t.appSpecificScore(r);if(s+=o*t.appSpecificWeight,e.knownIPs.forEach(i=>{if(t.IPColocationFactorWhitelist.has(i))return;let a=n.get(i),c=a!=null?a.size:0;if(c>t.IPColocationFactorThreshold){let l=c-t.IPColocationFactorThreshold,u=l*l;s+=u*t.IPColocationFactorWeight}}),e.behaviourPenalty>t.behaviourPenaltyThreshold){let i=e.behaviourPenalty-t.behaviourPenaltyThreshold,a=i*i;s+=a*t.behaviourPenaltyWeight}return s}var wR=fe(bR(),1);var Yr;(function(r){r[r.unknown=0]="unknown",r[r.valid=1]="valid",r[r.invalid=2]="invalid",r[r.ignored=3]="ignored"})(Yr||(Yr={}));var f1=class{records;queue;constructor(){this.records=new Map,this.queue=new wR.default}getRecord(e){return this.records.get(e)}ensureRecord(e){let t=this.records.get(e);if(t!=null)return t;t={status:Yr.unknown,firstSeenTsMs:Date.now(),validated:0,peers:new Set},this.records.set(e,t);let n={msgId:e,expire:Date.now()+12e4};return this.queue.push(n),t}gc(){let e=Date.now(),t=this.queue.peekFront();for(;t!=null&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}};var h1=class{params;metrics;peerStats=new Map;peerIPs=new l1(()=>new Set);scoreCache=new Map;deliveryRecords=new f1;_backgroundInterval;scoreCacheValidityMs;computeScore;log;constructor(e,t,n,s){this.params=e,this.metrics=t,pR(e),this.scoreCacheValidityMs=s.scoreCacheValidityMs,this.computeScore=s.computeScore??yR,this.log=n.forComponent("libp2p:gossipsub:score")}get size(){return this.peerStats.size}start(){if(this._backgroundInterval!=null){this.log("Peer score already running");return}this._backgroundInterval=setInterval(()=>{this.background()},this.params.decayInterval),this.log("started")}stop(){if(this._backgroundInterval==null){this.log("Peer score already stopped");return}clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),this.log("stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([e,t])=>[e,t]))}messageFirstSeenTimestampMs(e){let t=this.deliveryRecords.getRecord(e);return t!=null?t.firstSeenTsMs:null}refreshScores(){let e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach((n,s)=>{if(!n.connected){e>n.expire&&(this.removeIPsForPeer(s,n.knownIPs),this.peerStats.delete(s),this.scoreCache.delete(s));return}Object.entries(n.topics).forEach(([o,i])=>{let a=this.params.topics[o];a!==void 0&&(i.firstMessageDeliveries*=a.firstMessageDeliveriesDecay,i.firstMessageDeliveries<t&&(i.firstMessageDeliveries=0),i.meshMessageDeliveries*=a.meshMessageDeliveriesDecay,i.meshMessageDeliveries<t&&(i.meshMessageDeliveries=0),i.meshFailurePenalty*=a.meshFailurePenaltyDecay,i.meshFailurePenalty<t&&(i.meshFailurePenalty=0),i.invalidMessageDeliveries*=a.invalidMessageDeliveriesDecay,i.invalidMessageDeliveries<t&&(i.invalidMessageDeliveries=0),i.inMesh&&(i.meshTime=e-i.graftTime,i.meshTime>a.meshMessageDeliveriesActivation&&(i.meshMessageDeliveriesActive=!0)))}),n.behaviourPenalty*=this.params.behaviourPenaltyDecay,n.behaviourPenalty<t&&(n.behaviourPenalty=0)})}score(e){this.metrics?.scoreFnCalls.inc();let t=this.peerStats.get(e);if(t==null)return 0;let n=Date.now(),s=this.scoreCache.get(e);if(s!=null&&s.cacheUntil>n)return s.score;this.metrics?.scoreFnRuns.inc();let o=this.computeScore(e,t,this.params,this.peerIPs),i=n+this.scoreCacheValidityMs;return s!=null?(this.metrics?.scoreCachedDelta.observe(Math.abs(o-s.score)),s.score=o,s.cacheUntil=i):this.scoreCache.set(e,{score:o,cacheUntil:i}),o}addPenalty(e,t,n){let s=this.peerStats.get(e);s!=null&&(s.behaviourPenalty+=t,this.metrics?.onScorePenalty(n))}addPeer(e){let t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}addIP(e,t){let n=this.peerStats.get(e);n?.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}removeIP(e,t){let n=this.peerStats.get(e);n?.knownIPs.delete(t);let s=this.peerIPs.get(t);s!=null&&(s.delete(e),s.size===0&&this.peerIPs.delete(t))}removePeer(e){let t=this.peerStats.get(e);if(t!=null){if(this.score(e)>0){this.removeIPsForPeer(e,t.knownIPs),this.peerStats.delete(e);return}Object.entries(t.topics).forEach(([n,s])=>{s.firstMessageDeliveries=0;let o=this.params.topics[n].meshMessageDeliveriesThreshold;if(s.inMesh&&s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<o){let i=o-s.meshMessageDeliveries;s.meshFailurePenalty+=i*i}s.inMesh=!1,s.meshMessageDeliveriesActive=!1}),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){let n=this.peerStats.get(e);if(n!=null){let s=this.getPtopicStats(n,t);s!=null&&(s.inMesh=!0,s.graftTime=Date.now(),s.meshTime=0,s.meshMessageDeliveriesActive=!1)}}prune(e,t){let n=this.peerStats.get(e);if(n!=null){let s=this.getPtopicStats(n,t);if(s!=null){let o=this.params.topics[t].meshMessageDeliveriesThreshold;if(s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<o){let i=o-s.meshMessageDeliveries;s.meshFailurePenalty+=i*i}s.meshMessageDeliveriesActive=!1,s.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,n){this.markFirstMessageDelivery(e,n);let s=this.deliveryRecords.ensureRecord(t),o=Date.now();if(s.status!==Yr.unknown){this.log("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,o-s.firstSeenTsMs,Yr[s.status]);return}s.status=Yr.valid,s.validated=o,s.peers.forEach(i=>{i!==e.toString()&&this.markDuplicateMessageDelivery(i,n)})}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,n,s){switch(s){case Gr.Error:this.markInvalidMessageDelivery(e,n);return;case Gr.Blacklisted:return}let o=this.deliveryRecords.ensureRecord(t);if(o.status!==Yr.unknown){this.log("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-o.firstSeenTsMs,Yr[o.status]);return}if(s===Gr.Ignore){o.status=Yr.ignored,o.peers.clear();return}o.status=Yr.invalid,this.markInvalidMessageDelivery(e,n),o.peers.forEach(i=>{this.markInvalidMessageDelivery(i,n)}),o.peers.clear()}duplicateMessage(e,t,n){let s=this.deliveryRecords.ensureRecord(t);if(!s.peers.has(e))switch(s.status){case Yr.unknown:s.peers.add(e);break;case Yr.valid:s.peers.add(e),this.markDuplicateMessageDelivery(e,n,s.validated);break;case Yr.invalid:this.markInvalidMessageDelivery(e,n);break;case Yr.ignored:break}}markInvalidMessageDelivery(e,t){let n=this.peerStats.get(e);if(n!=null){let s=this.getPtopicStats(n,t);s!=null&&(s.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){let n=this.peerStats.get(e);if(n!=null){let s=this.getPtopicStats(n,t);if(s!=null){let o=this.params.topics[t].firstMessageDeliveriesCap;s.firstMessageDeliveries=Math.min(o,s.firstMessageDeliveries+1),s.inMesh&&(o=this.params.topics[t].meshMessageDeliveriesCap,s.meshMessageDeliveries=Math.min(o,s.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,n){let s=this.peerStats.get(e);if(s!=null){let o=n!==void 0?Date.now():0,i=this.getPtopicStats(s,t);if(i!=null&&i.inMesh){let a=this.params.topics[t];if(n!==void 0){let l=o-n,u=l>a.meshMessageDeliveriesWindow;if(this.metrics?.onDuplicateMsgDelivery(t,l,u),u)return}let c=a.meshMessageDeliveriesCap;i.meshMessageDeliveries=Math.min(c,i.meshMessageDeliveries+1)}}}removeIPsForPeer(e,t){for(let n of t){let s=this.peerIPs.get(n);s!=null&&(s.delete(e),s.size===0&&this.peerIPs.delete(n))}}getPtopicStats(e,t){let n=e.topics[t];return n!==void 0?n:this.params.topics[t]!==void 0?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}};function NG(r,e,t,n,s){let o=0,i=new Map;if(Object.entries(e.topics).forEach(([h,d])=>{let p=s.get(h)??"unknown",m=t.topics[h];if(m===void 0)return;let y=i.get(p);y==null&&(y={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},i.set(p,y));let b=0,w=0,E=0,x=0,v=0;if(d.inMesh){let D=Math.max(d.meshTime/m.timeInMeshQuantum,m.timeInMeshCap);b+=D*m.timeInMeshWeight}let S=d.firstMessageDeliveries;if(S>m.firstMessageDeliveriesCap&&(S=m.firstMessageDeliveriesCap),w+=S*m.firstMessageDeliveriesWeight,d.meshMessageDeliveriesActive&&d.meshMessageDeliveries<m.meshMessageDeliveriesThreshold){let D=m.meshMessageDeliveriesThreshold-d.meshMessageDeliveries,K=D*D;E+=K*m.meshMessageDeliveriesWeight}let A=d.meshFailurePenalty;x+=A*m.meshFailurePenaltyWeight;let _=d.invalidMessageDeliveries*d.invalidMessageDeliveries;v+=_*m.invalidMessageDeliveriesWeight,o+=(b+w+E+x+v)*m.topicWeight,y.p1w+=b,y.p2w+=w,y.p3w+=E,y.p3bw+=x,y.p4w+=v}),t.topicScoreCap>0&&o>t.topicScoreCap){o=t.topicScoreCap;let h=t.topicScoreCap/o;for(let d of i.values())d.p1w*=h,d.p2w*=h,d.p3w*=h,d.p3bw*=h,d.p4w*=h}let a=0,c=0,l=0,u=t.appSpecificScore(r);a+=u*t.appSpecificWeight,e.knownIPs.forEach(h=>{if(t.IPColocationFactorWhitelist.has(h))return;let d=n.get(h),p=d!=null?d.size:0;if(p>t.IPColocationFactorThreshold){let m=p-t.IPColocationFactorThreshold,y=m*m;c+=y*t.IPColocationFactorWeight}});let f=e.behaviourPenalty*e.behaviourPenalty;return l+=f*t.behaviourPenaltyWeight,o+=a+c+l,{byTopic:i,p5w:a,p6w:c,p7w:l,score:o}}function ER(r,e,t,n,s){let o={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(let i of r){let a=e.get(i);if(a!=null){let c=NG(i,a,t,n,s);for(let[l,u]of c.byTopic){let f=o.byTopic.get(l);f==null&&(f={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},o.byTopic.set(l,f)),f.p1w.push(u.p1w),f.p2w.push(u.p2w),f.p3w.push(u.p3w),f.p3bw.push(u.p3bw),f.p4w.push(u.p4w)}o.p5w.push(c.p5w),o.p6w.push(c.p6w),o.p7w.push(c.p7w),o.score.push(c.score)}else o.p5w.push(0),o.p6w.push(0),o.p7w.push(0),o.score.push(0)}return o}var op=class extends Error{constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function nu(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}function B8(r,e,t){let n=t??{},s=nu(r);async function*o(){let i,a=()=>{i?.()};for(e.addEventListener("abort",a);;){let c;try{if(e.aborted){let{abortMessage:u,abortCode:f}=n;throw new op(u,f)}let l=new Promise((u,f)=>{i=()=>{let{abortMessage:h,abortCode:d}=n;f(new op(h,d))}});c=await Promise.race([l,s.next()]),i=null}catch(l){e.removeEventListener("abort",a);let u=l.type==="aborted"&&e.aborted;if(u&&n.onAbort!=null&&n.onAbort(r),typeof s.return=="function")try{let f=s.return();f instanceof Promise&&f.catch(h=>{n.onReturnError!=null&&n.onReturnError(h)})}catch(f){n.onReturnError!=null&&n.onReturnError(f)}if(u&&n.returnOnAbort===!0)return;throw l}if(c.done===!0)break;yield c.value}e.removeEventListener("abort",a)}return o()}var p1=class{rawStream;pushable;closeController;maxBufferSize;constructor(e,t,n){this.rawStream=e,this.pushable=Tt({objectMode:!1}),this.closeController=new AbortController,this.maxBufferSize=n.maxBufferSize??1/0,lt(B8(this.pushable,this.closeController.signal,{returnOnAbort:!0}),s=>sr(s),this.rawStream).catch(t)}get protocol(){return this.rawStream.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(e)}async close(){this.closeController.abort(),await this.pushable.return(),await this.rawStream.close()}},d1=class{source;rawStream;closeController;constructor(e,t={}){this.rawStream=e,this.closeController=new AbortController,this.source=B8(lt(this.rawStream,n=>Mr(n,t)),this.closeController.signal,{returnOnAbort:!0})}async close(){this.closeController.abort(),await this.rawStream.close()}};var m1=class{gossipsubIWantFollowupMs;msgIdToStrFn;metrics;promises=new Map;requestMsByMsg=new Map;requestMsByMsgExpire;constructor(e,t,n){this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=n,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){let n=Math.floor(Math.random()*t.length),s=t[n],o=this.msgIdToStrFn(s),i=this.promises.get(o);i==null&&(i=new Map,this.promises.set(o,i));let a=Date.now();i.has(e)||(i.set(e,a+this.gossipsubIWantFollowupMs),this.metrics!=null&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(o)||this.requestMsByMsg.set(o,a)))}getBrokenPromises(){let e=Date.now(),t=new Map,n=0;return this.promises.forEach((s,o)=>{s.forEach((i,a)=>{i<e&&(t.set(a,(t.get(a)??0)+1),s.delete(a),n++)}),s.size===0&&this.promises.delete(o)}),this.metrics?.iwantPromiseBroken.inc(n),t}deliverMessage(e,t=!1){this.trackMessage(e);let n=this.promises.get(e);n!=null&&(this.promises.delete(e),this.metrics!=null&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(n.size)))}rejectMessage(e,t){switch(this.trackMessage(e),t){case Gr.Error:return;default:break}this.promises.delete(e)}clear(){this.promises.clear()}prune(){let e=Date.now()-this.requestMsByMsgExpire,t=0;for(let[n,s]of this.requestMsByMsg.entries())if(s<e)this.requestMsByMsg.delete(n),t++;else break;this.metrics?.iwantMessagePruned.inc(t)}trackMessage(e){if(this.metrics!=null){let t=this.requestMsByMsg.get(e);t!==void 0&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}};var B4e=fe(E1(),1),qG=fe(Ge(),1);var an={get(r=globalThis){let e=r.crypto;if(e==null||e.subtle==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}};var H6e=fe(xc(),1),z6e=fe(r5(),1);var zQ=fe(Ge(),1);var x5={};V(x5,{Ed25519PrivateKey:()=>Pc,Ed25519PublicKey:()=>gp,generateKeyPair:()=>mQ,generateKeyPairFromSeed:()=>hT,unmarshalEd25519PrivateKey:()=>pQ,unmarshalEd25519PublicKey:()=>dQ});var u8e=fe(Kt(),1),f8e=fe(fp(),1),OI=fe(Ge(),1);function _s(r,e){let t=Uint8Array.from(r.abs().toByteArray());if(t=t[0]===0?t.subarray(1):t,e!=null){if(t.length>e)throw new Error("byte array longer than desired length");t=le([new Uint8Array(e-t.length),t])}return T(t,"base64url")}function xn(r){let e=KI(r);return new OI.default.jsbn.BigInteger(T(e,"base16"),16)}function KI(r,e){let t=R(r,"base64urlpad");if(e!=null){if(t.length>e)throw new Error("byte array longer than desired length");t=le([new Uint8Array(e-t.length),t])}return t}function qn(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}function oa(r){if(!Number.isSafeInteger(r)||r<0)throw new Error(`Wrong positive integer: ${r}`)}function cj(r){return r instanceof Uint8Array||r!=null&&typeof r=="object"&&r.constructor.name==="Uint8Array"}function n5(r,...e){if(!cj(r))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(r.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${r.length}`)}function Ic(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");oa(r.outputLen),oa(r.blockLen)}function lu(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function MI(r,e){n5(r);let t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var B1=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function UI(r){return r instanceof Uint8Array||r!=null&&typeof r=="object"&&r.constructor.name==="Uint8Array"}var Tc=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),As=(r,e)=>r<<32-e|r>>>e,lj=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!lj)throw new Error("Non little-endian hardware is not supported");var uj=async()=>{};async function FI(r,e,t){let n=Date.now();for(let s=0;s<r;s++){t(s);let o=Date.now()-n;o>=0&&o<e||(await uj(),n+=o)}}function s5(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function Rs(r){if(typeof r=="string"&&(r=s5(r)),!UI(r))throw new Error(`expected Uint8Array, got ${typeof r}`);return r}function N1(...r){let e=0;for(let n=0;n<r.length;n++){let s=r[n];if(!UI(s))throw new Error("Uint8Array expected");e+=s.length}let t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){let o=r[n];t.set(o,s),s+=o.length}return t}var uu=class{clone(){return this._cloneInto()}},fj={}.toString;function VI(r,e){if(e!==void 0&&fj.call(e)!=="[object Object]")throw new Error("Options should be object or undefined");return Object.assign(r,e)}function fu(r){let e=n=>r().update(Rs(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function zt(r=32){if(B1&&typeof B1.getRandomValues=="function")return B1.getRandomValues(new Uint8Array(r));throw new Error("crypto.getRandomValues must be defined")}function hj(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let s=BigInt(32),o=BigInt(4294967295),i=Number(t>>s&o),a=Number(t&o),c=n?4:0,l=n?0:4;r.setUint32(e+c,i,n),r.setUint32(e+l,a,n)}var ia=class extends uu{constructor(e,t,n,s){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Tc(this.buffer)}update(e){lu(this);let{view:t,buffer:n,blockLen:s}=this;e=Rs(e);let o=e.length;for(let i=0;i<o;){let a=Math.min(s-this.pos,o-i);if(a===s){let c=Tc(e);for(;s<=o-i;i+=s)this.process(c,i);continue}n.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){lu(this),MI(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:s,isLE:o}=this,{pos:i}=this;t[i++]=128,this.buffer.subarray(i).fill(0),this.padOffset>s-i&&(this.process(n,0),i=0);for(let f=i;f<s;f++)t[f]=0;hj(n,s-8,BigInt(this.length*8),o),this.process(n,0);let a=Tc(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,u[f],o)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:s,finished:o,destroyed:i,pos:a}=this;return e.length=s,e.pos=a,e.finished=o,e.destroyed=i,s%t&&e.buffer.set(n),e}};var L1=BigInt(4294967295),o5=BigInt(32);function qI(r,e=!1){return e?{h:Number(r&L1),l:Number(r>>o5&L1)}:{h:Number(r>>o5&L1)|0,l:Number(r&L1)|0}}function pj(r,e=!1){let t=new Uint32Array(r.length),n=new Uint32Array(r.length);for(let s=0;s<r.length;s++){let{h:o,l:i}=qI(r[s],e);[t[s],n[s]]=[o,i]}return[t,n]}var dj=(r,e)=>BigInt(r>>>0)<<o5|BigInt(e>>>0),mj=(r,e,t)=>r>>>t,yj=(r,e,t)=>r<<32-t|e>>>t,gj=(r,e,t)=>r>>>t|e<<32-t,bj=(r,e,t)=>r<<32-t|e>>>t,wj=(r,e,t)=>r<<64-t|e>>>t-32,Ej=(r,e,t)=>r>>>t-32|e<<64-t,vj=(r,e)=>e,xj=(r,e)=>r,Sj=(r,e,t)=>r<<t|e>>>32-t,_j=(r,e,t)=>e<<t|r>>>32-t,Aj=(r,e,t)=>e<<t-32|r>>>64-t,Rj=(r,e,t)=>r<<t-32|e>>>64-t;function Ij(r,e,t,n){let s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}var Tj=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),kj=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,Dj=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),Pj=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,Cj=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),Bj=(r,e,t,n,s,o)=>e+t+n+s+o+(r/2**32|0)|0;var Nj={fromBig:qI,split:pj,toBig:dj,shrSH:mj,shrSL:yj,rotrSH:gj,rotrSL:bj,rotrBH:wj,rotrBL:Ej,rotr32H:vj,rotr32L:xj,rotlSH:Sj,rotlSL:_j,rotlBH:Aj,rotlBL:Rj,add:Ij,add3L:Tj,add3H:kj,add4L:Dj,add4H:Pj,add5H:Bj,add5L:Cj},Ne=Nj;var[Lj,Oj]=Ne.split(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),aa=new Uint32Array(80),ca=new Uint32Array(80),i5=class extends ia{constructor(){super(128,64,16,!1),this.Ah=1779033703,this.Al=-205731576,this.Bh=-1150833019,this.Bl=-2067093701,this.Ch=1013904242,this.Cl=-23791573,this.Dh=-1521486534,this.Dl=1595750129,this.Eh=1359893119,this.El=-1377402159,this.Fh=-1694144372,this.Fl=725511199,this.Gh=528734635,this.Gl=-79577749,this.Hh=1541459225,this.Hl=327033209}get(){let{Ah:e,Al:t,Bh:n,Bl:s,Ch:o,Cl:i,Dh:a,Dl:c,Eh:l,El:u,Fh:f,Fl:h,Gh:d,Gl:p,Hh:m,Hl:y}=this;return[e,t,n,s,o,i,a,c,l,u,f,h,d,p,m,y]}set(e,t,n,s,o,i,a,c,l,u,f,h,d,p,m,y){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=o|0,this.Cl=i|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=u|0,this.Fh=f|0,this.Fl=h|0,this.Gh=d|0,this.Gl=p|0,this.Hh=m|0,this.Hl=y|0}process(e,t){for(let E=0;E<16;E++,t+=4)aa[E]=e.getUint32(t),ca[E]=e.getUint32(t+=4);for(let E=16;E<80;E++){let x=aa[E-15]|0,v=ca[E-15]|0,S=Ne.rotrSH(x,v,1)^Ne.rotrSH(x,v,8)^Ne.shrSH(x,v,7),A=Ne.rotrSL(x,v,1)^Ne.rotrSL(x,v,8)^Ne.shrSL(x,v,7),_=aa[E-2]|0,D=ca[E-2]|0,K=Ne.rotrSH(_,D,19)^Ne.rotrBH(_,D,61)^Ne.shrSH(_,D,6),O=Ne.rotrSL(_,D,19)^Ne.rotrBL(_,D,61)^Ne.shrSL(_,D,6),F=Ne.add4L(A,O,ca[E-7],ca[E-16]),W=Ne.add4H(F,S,K,aa[E-7],aa[E-16]);aa[E]=W|0,ca[E]=F|0}let{Ah:n,Al:s,Bh:o,Bl:i,Ch:a,Cl:c,Dh:l,Dl:u,Eh:f,El:h,Fh:d,Fl:p,Gh:m,Gl:y,Hh:b,Hl:w}=this;for(let E=0;E<80;E++){let x=Ne.rotrSH(f,h,14)^Ne.rotrSH(f,h,18)^Ne.rotrBH(f,h,41),v=Ne.rotrSL(f,h,14)^Ne.rotrSL(f,h,18)^Ne.rotrBL(f,h,41),S=f&d^~f&m,A=h&p^~h&y,_=Ne.add5L(w,v,A,Oj[E],ca[E]),D=Ne.add5H(_,b,x,S,Lj[E],aa[E]),K=_|0,O=Ne.rotrSH(n,s,28)^Ne.rotrBH(n,s,34)^Ne.rotrBH(n,s,39),F=Ne.rotrSL(n,s,28)^Ne.rotrBL(n,s,34)^Ne.rotrBL(n,s,39),W=n&o^n&a^o&a,ce=s&i^s&c^i&c;b=m|0,w=y|0,m=d|0,y=p|0,d=f|0,p=h|0,{h:f,l:h}=Ne.add(l|0,u|0,D|0,K|0),l=a|0,u=c|0,a=o|0,c=i|0,o=n|0,i=s|0;let B=Ne.add3L(K,F,ce);n=Ne.add3H(B,D,O,W),s=B|0}({h:n,l:s}=Ne.add(this.Ah|0,this.Al|0,n|0,s|0)),{h:o,l:i}=Ne.add(this.Bh|0,this.Bl|0,o|0,i|0),{h:a,l:c}=Ne.add(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:u}=Ne.add(this.Dh|0,this.Dl|0,l|0,u|0),{h:f,l:h}=Ne.add(this.Eh|0,this.El|0,f|0,h|0),{h:d,l:p}=Ne.add(this.Fh|0,this.Fl|0,d|0,p|0),{h:m,l:y}=Ne.add(this.Gh|0,this.Gl|0,m|0,y|0),{h:b,l:w}=Ne.add(this.Hh|0,this.Hl|0,b|0,w|0),this.set(n,s,o,i,a,c,l,u,f,h,d,p,m,y,b,w)}roundClean(){aa.fill(0),ca.fill(0)}destroy(){this.buffer.fill(0),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}};var er=fu(()=>new i5);var K1={};V(K1,{bitGet:()=>Hj,bitLen:()=>qj,bitMask:()=>hp,bitSet:()=>zj,bytesToHex:()=>Yo,bytesToNumberBE:()=>jo,bytesToNumberLE:()=>Ts,concatBytes:()=>Xo,createHmacDrbg:()=>l5,ensureBytes:()=>bt,equalBytes:()=>Fj,hexToBytes:()=>kc,hexToNumber:()=>c5,isBytes:()=>Is,numberToBytesBE:()=>la,numberToBytesLE:()=>Qo,numberToHexUnpadded:()=>GI,numberToVarBytesBE:()=>Uj,utf8ToBytes:()=>Vj,validateObject:()=>Hn});var $I=BigInt(0),O1=BigInt(1),Kj=BigInt(2);function Is(r){return r instanceof Uint8Array||r!=null&&typeof r=="object"&&r.constructor.name==="Uint8Array"}var Mj=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function Yo(r){if(!Is(r))throw new Error("Uint8Array expected");let e="";for(let t=0;t<r.length;t++)e+=Mj[r[t]];return e}function GI(r){let e=r.toString(16);return e.length&1?`0${e}`:e}function c5(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return BigInt(r===""?"0":`0x${r}`)}var Wo={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function HI(r){if(r>=Wo._0&&r<=Wo._9)return r-Wo._0;if(r>=Wo._A&&r<=Wo._F)return r-(Wo._A-10);if(r>=Wo._a&&r<=Wo._f)return r-(Wo._a-10)}function kc(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);let e=r.length,t=e/2;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);let n=new Uint8Array(t);for(let s=0,o=0;s<t;s++,o+=2){let i=HI(r.charCodeAt(o)),a=HI(r.charCodeAt(o+1));if(i===void 0||a===void 0){let c=r[o]+r[o+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+o)}n[s]=i*16+a}return n}function jo(r){return c5(Yo(r))}function Ts(r){if(!Is(r))throw new Error("Uint8Array expected");return c5(Yo(Uint8Array.from(r).reverse()))}function la(r,e){return kc(r.toString(16).padStart(e*2,"0"))}function Qo(r,e){return la(r,e).reverse()}function Uj(r){return kc(GI(r))}function bt(r,e,t){let n;if(typeof e=="string")try{n=kc(e)}catch(o){throw new Error(`${r} must be valid hex string, got "${e}". Cause: ${o}`)}else if(Is(e))n=Uint8Array.from(e);else throw new Error(`${r} must be hex string or Uint8Array`);let s=n.length;if(typeof t=="number"&&s!==t)throw new Error(`${r} expected ${t} bytes, got ${s}`);return n}function Xo(...r){let e=0;for(let s=0;s<r.length;s++){let o=r[s];if(!Is(o))throw new Error("Uint8Array expected");e+=o.length}let t=new Uint8Array(e),n=0;for(let s=0;s<r.length;s++){let o=r[s];t.set(o,n),n+=o.length}return t}function Fj(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}function Vj(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function qj(r){let e;for(e=0;r>$I;r>>=O1,e+=1);return e}function Hj(r,e){return r>>BigInt(e)&O1}var zj=(r,e,t)=>r|(t?O1:$I)<<BigInt(e),hp=r=>(Kj<<BigInt(r-1))-O1,a5=r=>new Uint8Array(r),zI=r=>Uint8Array.from(r);function l5(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let n=a5(r),s=a5(r),o=0,i=()=>{n.fill(1),s.fill(0),o=0},a=(...f)=>t(s,n,...f),c=(f=a5())=>{s=a(zI([0]),f),n=a(),f.length!==0&&(s=a(zI([1]),f),n=a())},l=()=>{if(o++>=1e3)throw new Error("drbg: tried 1000 values");let f=0,h=[];for(;f<e;){n=a();let d=n.slice();h.push(d),f+=n.length}return Xo(...h)};return(f,h)=>{i(),c(f);let d;for(;!(d=h(l()));)c();return i(),d}}var $j={bigint:r=>typeof r=="bigint",function:r=>typeof r=="function",boolean:r=>typeof r=="boolean",string:r=>typeof r=="string",stringOrUint8Array:r=>typeof r=="string"||Is(r),isSafeInteger:r=>Number.isSafeInteger(r),array:r=>Array.isArray(r),field:(r,e)=>e.Fp.isValid(r),hash:r=>typeof r=="function"&&Number.isSafeInteger(r.outputLen)};function Hn(r,e,t={}){let n=(s,o,i)=>{let a=$j[o];if(typeof a!="function")throw new Error(`Invalid validator "${o}", expected function`);let c=r[s];if(!(i&&c===void 0)&&!a(c,r))throw new Error(`Invalid param ${String(s)}=${c} (${typeof c}), expected ${o}`)};for(let[s,o]of Object.entries(e))n(s,o,!1);for(let[s,o]of Object.entries(t))n(s,o,!0);return r}var or=BigInt(0),St=BigInt(1),Dc=BigInt(2),Gj=BigInt(3),u5=BigInt(4),WI=BigInt(5),YI=BigInt(8),Wj=BigInt(9),Yj=BigInt(16);function rt(r,e){let t=r%e;return t>=or?t:e+t}function f5(r,e,t){if(t<=or||e<or)throw new Error("Expected power/modulo > 0");if(t===St)return or;let n=St;for(;e>or;)e&St&&(n=n*r%t),r=r*r%t,e>>=St;return n}function wt(r,e,t){let n=r;for(;e-- >or;)n*=n,n%=t;return n}function M1(r,e){if(r===or||e<=or)throw new Error(`invert: expected positive integers, got n=${r} mod=${e}`);let t=rt(r,e),n=e,s=or,o=St,i=St,a=or;for(;t!==or;){let l=n/t,u=n%t,f=s-i*l,h=o-a*l;n=t,t=u,s=i,o=a,i=f,a=h}if(n!==St)throw new Error("invert: does not exist");return rt(s,e)}function jj(r){let e=(r-St)/Dc,t,n,s;for(t=r-St,n=0;t%Dc===or;t/=Dc,n++);for(s=Dc;s<r&&f5(s,e,r)!==r-St;s++);if(n===1){let i=(r+St)/u5;return function(c,l){let u=c.pow(l,i);if(!c.eql(c.sqr(u),l))throw new Error("Cannot find square root");return u}}let o=(t+St)/Dc;return function(a,c){if(a.pow(c,e)===a.neg(a.ONE))throw new Error("Cannot find square root");let l=n,u=a.pow(a.mul(a.ONE,s),t),f=a.pow(c,o),h=a.pow(c,t);for(;!a.eql(h,a.ONE);){if(a.eql(h,a.ZERO))return a.ZERO;let d=1;for(let m=a.sqr(h);d<l&&!a.eql(m,a.ONE);d++)m=a.sqr(m);let p=a.pow(u,St<<BigInt(l-d-1));u=a.sqr(p),f=a.mul(f,p),h=a.mul(h,u),l=d}return f}}function Qj(r){if(r%u5===Gj){let e=(r+St)/u5;return function(n,s){let o=n.pow(s,e);if(!n.eql(n.sqr(o),s))throw new Error("Cannot find square root");return o}}if(r%YI===WI){let e=(r-WI)/YI;return function(n,s){let o=n.mul(s,Dc),i=n.pow(o,e),a=n.mul(s,i),c=n.mul(n.mul(a,Dc),i),l=n.mul(a,n.sub(c,n.ONE));if(!n.eql(n.sqr(l),s))throw new Error("Cannot find square root");return l}}return r%Yj,jj(r)}var jI=(r,e)=>(rt(r,e)&St)===St,Xj=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function h5(r){let e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},t=Xj.reduce((n,s)=>(n[s]="function",n),e);return Hn(r,t)}function Jj(r,e,t){if(t<or)throw new Error("Expected power > 0");if(t===or)return r.ONE;if(t===St)return e;let n=r.ONE,s=e;for(;t>or;)t&St&&(n=r.mul(n,s)),s=r.sqr(s),t>>=St;return n}function Zj(r,e){let t=new Array(e.length),n=e.reduce((o,i,a)=>r.is0(i)?o:(t[a]=o,r.mul(o,i)),r.ONE),s=r.inv(n);return e.reduceRight((o,i,a)=>r.is0(i)?o:(t[a]=r.mul(o,t[a]),r.mul(o,i)),s),t}function p5(r,e){let t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function U1(r,e,t=!1,n={}){if(r<=or)throw new Error(`Expected Field ORDER > 0, got ${r}`);let{nBitLength:s,nByteLength:o}=p5(r,e);if(o>2048)throw new Error("Field lengths over 2048 bytes are not supported");let i=Qj(r),a=Object.freeze({ORDER:r,BITS:s,BYTES:o,MASK:hp(s),ZERO:or,ONE:St,create:c=>rt(c,r),isValid:c=>{if(typeof c!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof c}`);return or<=c&&c<r},is0:c=>c===or,isOdd:c=>(c&St)===St,neg:c=>rt(-c,r),eql:(c,l)=>c===l,sqr:c=>rt(c*c,r),add:(c,l)=>rt(c+l,r),sub:(c,l)=>rt(c-l,r),mul:(c,l)=>rt(c*l,r),pow:(c,l)=>Jj(a,c,l),div:(c,l)=>rt(c*M1(l,r),r),sqrN:c=>c*c,addN:(c,l)=>c+l,subN:(c,l)=>c-l,mulN:(c,l)=>c*l,inv:c=>M1(c,r),sqrt:n.sqrt||(c=>i(a,c)),invertBatch:c=>Zj(a,c),cmov:(c,l,u)=>u?l:c,toBytes:c=>t?Qo(c,o):la(c,o),fromBytes:c=>{if(c.length!==o)throw new Error(`Fp.fromBytes: expected ${o}, got ${c.length}`);return t?Ts(c):jo(c)}});return Object.freeze(a)}function QI(r,e){if(!r.isOdd)throw new Error("Field doesn't have isOdd");let t=r.sqrt(e);return r.isOdd(t)?r.neg(t):t}function XI(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let e=r.toString(2).length;return Math.ceil(e/8)}function d5(r){let e=XI(r);return e+Math.ceil(e/2)}function JI(r,e,t=!1){let n=r.length,s=XI(e),o=d5(e);if(n<16||n<o||n>1024)throw new Error(`expected ${o}-1024 bytes of input, got ${n}`);let i=t?jo(r):Ts(r),a=rt(i,e-St)+St;return t?Qo(a,s):la(a,s)}var tQ=BigInt(0),m5=BigInt(1);function F1(r,e){let t=(s,o)=>{let i=o.negate();return s?i:o},n=s=>{let o=Math.ceil(e/s)+1,i=2**(s-1);return{windows:o,windowSize:i}};return{constTimeNegate:t,unsafeLadder(s,o){let i=r.ZERO,a=s;for(;o>tQ;)o&m5&&(i=i.add(a)),a=a.double(),o>>=m5;return i},precomputeWindow(s,o){let{windows:i,windowSize:a}=n(o),c=[],l=s,u=l;for(let f=0;f<i;f++){u=l,c.push(u);for(let h=1;h<a;h++)u=u.add(l),c.push(u);l=u.double()}return c},wNAF(s,o,i){let{windows:a,windowSize:c}=n(s),l=r.ZERO,u=r.BASE,f=BigInt(2**s-1),h=2**s,d=BigInt(s);for(let p=0;p<a;p++){let m=p*c,y=Number(i&f);i>>=d,y>c&&(y-=h,i+=m5);let b=m,w=m+Math.abs(y)-1,E=p%2!==0,x=y<0;y===0?u=u.add(t(E,o[b])):l=l.add(t(x,o[w]))}return{p:l,f:u}},wNAFCached(s,o,i,a){let c=s._WINDOW_SIZE||1,l=o.get(s);return l||(l=this.precomputeWindow(s,c),c!==1&&o.set(s,a(l))),this.wNAF(c,l,i)}}}function pp(r){return h5(r.Fp),Hn(r,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...p5(r.n,r.nBitLength),...r,p:r.Fp.ORDER})}var ks=BigInt(0),Sn=BigInt(1),V1=BigInt(2),rQ=BigInt(8),nQ={zip215:!0};function sQ(r){let e=pp(r);return Hn(r,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...e})}function q1(r){let e=sQ(r),{Fp:t,n,prehash:s,hash:o,randomBytes:i,nByteLength:a,h:c}=e,l=V1<<BigInt(a*8)-Sn,u=t.create,f=e.uvRatio||((U,k)=>{try{return{isValid:!0,value:t.sqrt(U*t.inv(k))}}catch{return{isValid:!1,value:ks}}}),h=e.adjustScalarBytes||(U=>U),d=e.domain||((U,k,G)=>{if(k.length||G)throw new Error("Contexts/pre-hash are not supported");return U}),p=U=>typeof U=="bigint"&&ks<U,m=(U,k)=>p(U)&&p(k)&&U<k,y=U=>U===ks||m(U,l);function b(U,k){if(m(U,k))return U;throw new Error(`Expected valid scalar < ${k}, got ${typeof U} ${U}`)}function w(U){return U===ks?U:b(U,n)}let E=new Map;function x(U){if(!(U instanceof v))throw new Error("ExtendedPoint expected")}class v{constructor(k,G,Q,se){if(this.ex=k,this.ey=G,this.ez=Q,this.et=se,!y(k))throw new Error("x required");if(!y(G))throw new Error("y required");if(!y(Q))throw new Error("z required");if(!y(se))throw new Error("t required")}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(k){if(k instanceof v)throw new Error("extended point not allowed");let{x:G,y:Q}=k||{};if(!y(G)||!y(Q))throw new Error("invalid affine point");return new v(G,Q,Sn,u(G*Q))}static normalizeZ(k){let G=t.invertBatch(k.map(Q=>Q.ez));return k.map((Q,se)=>Q.toAffine(G[se])).map(v.fromAffine)}_setWindowSize(k){this._WINDOW_SIZE=k,E.delete(this)}assertValidity(){let{a:k,d:G}=e;if(this.is0())throw new Error("bad point: ZERO");let{ex:Q,ey:se,ez:Ee,et:Se}=this,Ke=u(Q*Q),_e=u(se*se),Ie=u(Ee*Ee),pt=u(Ie*Ie),at=u(Ke*k),br=u(Ie*u(at+_e)),wr=u(pt+u(G*u(Ke*_e)));if(br!==wr)throw new Error("bad point: equation left != right (1)");let rr=u(Q*se),Nr=u(Ee*Se);if(rr!==Nr)throw new Error("bad point: equation left != right (2)")}equals(k){x(k);let{ex:G,ey:Q,ez:se}=this,{ex:Ee,ey:Se,ez:Ke}=k,_e=u(G*Ke),Ie=u(Ee*se),pt=u(Q*Ke),at=u(Se*se);return _e===Ie&&pt===at}is0(){return this.equals(v.ZERO)}negate(){return new v(u(-this.ex),this.ey,this.ez,u(-this.et))}double(){let{a:k}=e,{ex:G,ey:Q,ez:se}=this,Ee=u(G*G),Se=u(Q*Q),Ke=u(V1*u(se*se)),_e=u(k*Ee),Ie=G+Q,pt=u(u(Ie*Ie)-Ee-Se),at=_e+Se,br=at-Ke,wr=_e-Se,rr=u(pt*br),Nr=u(at*wr),Bo=u(pt*wr),Ja=u(br*at);return new v(rr,Nr,Ja,Bo)}add(k){x(k);let{a:G,d:Q}=e,{ex:se,ey:Ee,ez:Se,et:Ke}=this,{ex:_e,ey:Ie,ez:pt,et:at}=k;if(G===BigInt(-1)){let Fv=u((Ee-se)*(Ie+_e)),Vv=u((Ee+se)*(Ie-_e)),f3=u(Vv-Fv);if(f3===ks)return this.double();let qv=u(Se*V1*at),Hv=u(Ke*V1*pt),zv=Hv+qv,$v=Vv+Fv,Gv=Hv-qv,jF=u(zv*f3),QF=u($v*Gv),XF=u(zv*Gv),JF=u(f3*$v);return new v(jF,QF,JF,XF)}let br=u(se*_e),wr=u(Ee*Ie),rr=u(Ke*Q*at),Nr=u(Se*pt),Bo=u((se+Ee)*(_e+Ie)-br-wr),Ja=Nr-rr,gh=Nr+rr,Uv=u(wr-G*br),$F=u(Bo*Ja),GF=u(gh*Uv),WF=u(Bo*Uv),YF=u(Ja*gh);return new v($F,GF,YF,WF)}subtract(k){return this.add(k.negate())}wNAF(k){return _.wNAFCached(this,E,k,v.normalizeZ)}multiply(k){let{p:G,f:Q}=this.wNAF(b(k,n));return v.normalizeZ([G,Q])[0]}multiplyUnsafe(k){let G=w(k);return G===ks?A:this.equals(A)||G===Sn?this:this.equals(S)?this.wNAF(G).p:_.unsafeLadder(this,G)}isSmallOrder(){return this.multiplyUnsafe(c).is0()}isTorsionFree(){return _.unsafeLadder(this,n).is0()}toAffine(k){let{ex:G,ey:Q,ez:se}=this,Ee=this.is0();k==null&&(k=Ee?rQ:t.inv(se));let Se=u(G*k),Ke=u(Q*k),_e=u(se*k);if(Ee)return{x:ks,y:Sn};if(_e!==Sn)throw new Error("invZ was invalid");return{x:Se,y:Ke}}clearCofactor(){let{h:k}=e;return k===Sn?this:this.multiplyUnsafe(k)}static fromHex(k,G=!1){let{d:Q,a:se}=e,Ee=t.BYTES;k=bt("pointHex",k,Ee);let Se=k.slice(),Ke=k[Ee-1];Se[Ee-1]=Ke&-129;let _e=Ts(Se);_e===ks||(G?b(_e,l):b(_e,t.ORDER));let Ie=u(_e*_e),pt=u(Ie-Sn),at=u(Q*Ie-se),{isValid:br,value:wr}=f(pt,at);if(!br)throw new Error("Point.fromHex: invalid y coordinate");let rr=(wr&Sn)===Sn,Nr=(Ke&128)!==0;if(!G&&wr===ks&&Nr)throw new Error("Point.fromHex: x=0 and x_0=1");return Nr!==rr&&(wr=u(-wr)),v.fromAffine({x:wr,y:_e})}static fromPrivateKey(k){return O(k).point}toRawBytes(){let{x:k,y:G}=this.toAffine(),Q=Qo(G,t.BYTES);return Q[Q.length-1]|=k&Sn?128:0,Q}toHex(){return Yo(this.toRawBytes())}}v.BASE=new v(e.Gx,e.Gy,Sn,u(e.Gx*e.Gy)),v.ZERO=new v(ks,Sn,Sn,ks);let{BASE:S,ZERO:A}=v,_=F1(v,a*8);function D(U){return rt(U,n)}function K(U){return D(Ts(U))}function O(U){let k=a;U=bt("private key",U,k);let G=bt("hashed private key",o(U),2*k),Q=h(G.slice(0,k)),se=G.slice(k,2*k),Ee=K(Q),Se=S.multiply(Ee),Ke=Se.toRawBytes();return{head:Q,prefix:se,scalar:Ee,point:Se,pointBytes:Ke}}function F(U){return O(U).pointBytes}function W(U=new Uint8Array,...k){let G=Xo(...k);return K(o(d(G,bt("context",U),!!s)))}function ce(U,k,G={}){U=bt("message",U),s&&(U=s(U));let{prefix:Q,scalar:se,pointBytes:Ee}=O(k),Se=W(G.context,Q,U),Ke=S.multiply(Se).toRawBytes(),_e=W(G.context,Ke,Ee,U),Ie=D(Se+_e*se);w(Ie);let pt=Xo(Ke,Qo(Ie,t.BYTES));return bt("result",pt,a*2)}let B=nQ;function N(U,k,G,Q=B){let{context:se,zip215:Ee}=Q,Se=t.BYTES;U=bt("signature",U,2*Se),k=bt("message",k),s&&(k=s(k));let Ke=Ts(U.slice(Se,2*Se)),_e,Ie,pt;try{_e=v.fromHex(G,Ee),Ie=v.fromHex(U.slice(0,Se),Ee),pt=S.multiplyUnsafe(Ke)}catch{return!1}if(!Ee&&_e.isSmallOrder())return!1;let at=W(se,Ie.toRawBytes(),_e.toRawBytes(),k);return Ie.add(_e.multiplyUnsafe(at)).subtract(pt).clearCofactor().equals(v.ZERO)}return S._setWindowSize(8),{CURVE:e,getPublicKey:F,sign:ce,verify:N,ExtendedPoint:v,utils:{getExtendedPublicKey:O,randomPrivateKey:()=>i(t.BYTES),precompute(U=8,k=v.BASE){return k._setWindowSize(U),k.multiply(BigInt(3)),k}}}}var dp=BigInt(0),y5=BigInt(1);function oQ(r){return Hn(r,{a:"bigint"},{montgomeryBits:"isSafeInteger",nByteLength:"isSafeInteger",adjustScalarBytes:"function",domain:"function",powPminus2:"function",Gu:"bigint"}),Object.freeze({...r})}function ZI(r){let e=oQ(r),{P:t}=e,n=E=>rt(E,t),s=e.montgomeryBits,o=Math.ceil(s/8),i=e.nByteLength,a=e.adjustScalarBytes||(E=>E),c=e.powPminus2||(E=>f5(E,t-BigInt(2),t));function l(E,x,v){let S=n(E*(x-v));return x=n(x-S),v=n(v+S),[x,v]}function u(E){if(typeof E=="bigint"&&dp<=E&&E<t)return E;throw new Error("Expected valid scalar 0 < scalar < CURVE.P")}let f=(e.a-BigInt(2))/BigInt(4);function h(E,x){let v=u(E),S=u(x),A=v,_=y5,D=dp,K=v,O=y5,F=dp,W;for(let B=BigInt(s-1);B>=dp;B--){let N=S>>B&y5;F^=N,W=l(F,_,K),_=W[0],K=W[1],W=l(F,D,O),D=W[0],O=W[1],F=N;let L=_+D,U=n(L*L),k=_-D,G=n(k*k),Q=U-G,se=K+O,Ee=K-O,Se=n(Ee*L),Ke=n(se*k),_e=Se+Ke,Ie=Se-Ke;K=n(_e*_e),O=n(A*n(Ie*Ie)),_=n(U*G),D=n(Q*(U+n(f*Q)))}W=l(F,_,K),_=W[0],K=W[1],W=l(F,D,O),D=W[0],O=W[1];let ce=c(D);return n(_*ce)}function d(E){return Qo(n(E),o)}function p(E){let x=bt("u coordinate",E,o);return i===32&&(x[31]&=127),Ts(x)}function m(E){let x=bt("scalar",E),v=x.length;if(v!==o&&v!==i)throw new Error(`Expected ${o} or ${i} bytes, got ${v}`);return Ts(a(x))}function y(E,x){let v=p(x),S=m(E),A=h(v,S);if(A===dp)throw new Error("Invalid private or public key received");return d(A)}let b=d(e.Gu);function w(E){return y(E,b)}return{scalarMult:y,scalarMultBase:w,getSharedSecret:(E,x)=>y(E,x),getPublicKey:E=>w(E),utils:{randomPrivateKey:()=>e.randomBytes(e.nByteLength)},GuBytes:b}}var mp=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),eT=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752"),z8e=BigInt(0),iQ=BigInt(1),g5=BigInt(2),aQ=BigInt(5),tT=BigInt(10),cQ=BigInt(20),lQ=BigInt(40),rT=BigInt(80);function nT(r){let e=mp,n=r*r%e*r%e,s=wt(n,g5,e)*n%e,o=wt(s,iQ,e)*r%e,i=wt(o,aQ,e)*o%e,a=wt(i,tT,e)*i%e,c=wt(a,cQ,e)*a%e,l=wt(c,lQ,e)*c%e,u=wt(l,rT,e)*l%e,f=wt(u,rT,e)*l%e,h=wt(f,tT,e)*i%e;return{pow_p_5_8:wt(h,g5,e)*r%e,b2:n}}function sT(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}function uQ(r,e){let t=mp,n=rt(e*e*e,t),s=rt(n*n*e,t),o=nT(r*s).pow_p_5_8,i=rt(r*n*o,t),a=rt(e*i*i,t),c=i,l=rt(i*eT,t),u=a===r,f=a===rt(-r,t),h=a===rt(-r*eT,t);return u&&(i=c),(f||h)&&(i=l),jI(i,t)&&(i=rt(-i,t)),{isValid:u||f,value:i}}var Jo=U1(mp,void 0,!0),b5={a:BigInt(-1),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),Fp:Jo,n:BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),h:BigInt(8),Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),hash:er,randomBytes:zt,adjustScalarBytes:sT,uvRatio:uQ},De=q1(b5);function oT(r,e,t){if(e.length>255)throw new Error("Context is too big");return N1(s5("SigEd25519 no Ed25519 collisions"),new Uint8Array([t?1:0,e.length]),e,r)}var $8e=q1({...b5,domain:oT}),G8e=q1({...b5,domain:oT,prehash:er}),yp=ZI({P:mp,a:BigInt(486662),montgomeryBits:255,nByteLength:32,Gu:BigInt(9),powPminus2:r=>{let e=mp,{pow_p_5_8:t,b2:n}=nT(r);return rt(wt(t,BigInt(3),e)*n,e)},adjustScalarBytes:sT,randomBytes:zt});var fQ=(Jo.ORDER+BigInt(3))/BigInt(8),W8e=Jo.pow(g5,fQ),Y8e=Jo.sqrt(Jo.neg(Jo.ONE)),j8e=(Jo.ORDER-BigInt(5))/BigInt(8),Q8e=BigInt(486662);var X8e=QI(Jo,Jo.neg(BigInt(486664)));var J8e=BigInt("25063068953384623474111414158702152701244531502492656460079210482610430750235"),Z8e=BigInt("54469307008909316920995813868745141605393597292927456921205312896311721017578"),e5e=BigInt("1159843021668779879193775521855586647937357759715417654439879720876111806838"),t5e=BigInt("40440834346308536858101042469323190826248399146238708352240133220865137265952");var r5e=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff");var hu=32,Zo=64,H1=32;function iT(){let r=De.utils.randomPrivateKey(),e=De.getPublicKey(r);return{privateKey:uT(r,e),publicKey:e}}function aT(r){if(r.length!==H1)throw new TypeError('"seed" must be 32 bytes in length.');if(!(r instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');let e=r,t=De.getPublicKey(e);return{privateKey:uT(e,t),publicKey:t}}function cT(r,e){let t=r.subarray(0,H1);return De.sign(e instanceof Uint8Array?e:e.subarray(),t)}function lT(r,e,t){return De.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}function uT(r,e){let t=new Uint8Array(Zo);for(let n=0;n<H1;n++)t[n]=r[n],t[H1+n]=e[n];return t}var w5={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function E5(r){let e=r?.algorithm??"AES-GCM",t=r?.keyLength??16,n=r?.nonceLength??12,s=r?.digest??"SHA-256",o=r?.saltLength??16,i=r?.iterations??32767,a=an.get();t*=8;async function c(f,h){let d=a.getRandomValues(new Uint8Array(o)),p=a.getRandomValues(new Uint8Array(n)),m={name:e,iv:p};typeof h=="string"&&(h=R(h));let y;if(h.length===0){y=await a.subtle.importKey("jwk",w5,{name:"AES-GCM"},!0,["encrypt"]);try{let w={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}catch{y=await a.subtle.importKey("jwk",w5,{name:"AES-GCM"},!0,["encrypt"])}}else{let w={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}let b=await a.subtle.encrypt(m,y,f);return le([d,m.iv,new Uint8Array(b)])}async function l(f,h){let d=f.subarray(0,o),p=f.subarray(o,o+n),m=f.subarray(o+n),y={name:e,iv:p};typeof h=="string"&&(h=R(h));let b;if(h.length===0)try{let E={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},x=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(E,x,{name:e,length:t},!0,["decrypt"])}catch{b=await a.subtle.importKey("jwk",w5,{name:"AES-GCM"},!0,["decrypt"])}else{let E={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},x=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(E,x,{name:e,length:t},!0,["decrypt"])}let w=await a.subtle.decrypt(y,b,m);return new Uint8Array(w)}return{encrypt:c,decrypt:l}}async function pu(r,e){let n=await E5().encrypt(r,e);return qe.encode(n)}var _t;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.Secp256k1="Secp256k1"})(_t||(_t={}));var v5;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.Secp256k1=2]="Secp256k1"})(v5||(v5={}));(function(r){r.codec=()=>Te(v5)})(_t||(_t={}));var to;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),_t.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=_t.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(to||(to={}));var ro;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),_t.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=_t.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(ro||(ro={}));var gp=class{_key;constructor(e){this._key=du(e,hu)}verify(e,t){return lT(this._key,t,e)}marshal(){return this._key}get bytes(){return to.encode({Type:_t.Ed25519,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return qn(e)?e.then(({bytes:t})=>t):e.bytes}},Pc=class{_key;_publicKey;constructor(e,t){this._key=du(e,Zo),this._publicKey=du(t,hu)}sign(e){return cT(this._key,e)}get public(){return new gp(this._publicKey)}marshal(){return this._key}get bytes(){return ro.encode({Type:_t.Ed25519,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}async hash(){let e=$.digest(this.bytes),t;return qn(e)?{bytes:t}=await e:t=e.bytes,t}async id(){let e=Lt.digest(this.public.bytes);return Fe.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if(t==="libp2p-key")return pu(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function pQ(r){if(r.length>Zo){r=du(r,Zo+hu);let n=r.subarray(0,Zo),s=r.subarray(Zo,r.length);return new Pc(n,s)}r=du(r,Zo);let e=r.subarray(0,Zo),t=r.subarray(hu);return new Pc(e,t)}function dQ(r){return r=du(r,hu),new gp(r)}async function mQ(){let{privateKey:r,publicKey:e}=iT();return new Pc(r,e)}async function hT(r){let{privateKey:e,publicKey:t}=aT(r);return new Pc(e,t)}function du(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new g(`Key must be a Uint8Array of length ${e}, got ${r.length}`,"ERR_INVALID_KEY_TYPE");return r}var yQ={"P-256":256,"P-384":384,"P-521":521},gQ=Object.keys(yQ),_5e=gQ.join(" / ");var T5={};V(T5,{MAX_KEY_SIZE:()=>vp,RsaPrivateKey:()=>mu,RsaPublicKey:()=>Ep,fromJwk:()=>IQ,generateKeyPair:()=>TQ,unmarshalRsaPrivateKey:()=>AQ,unmarshalRsaPublicKey:()=>RQ});var wp=fe(Ge(),1);var s6e=fe(A5(),1);function Bc(r){if(isNaN(r)||r<=0)throw new g("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return zt(r)}var F5e=fe(cu(),1),R5=fe(Ge(),1);function gT(r,e){return e.map(t=>xn(r[t]))}function bT(r){return R5.default.pki.setRsaPrivateKey(...gT(r,["n","e","d","p","q","dp","dq","qi"]))}function wT(r){return R5.default.pki.setRsaPublicKey(...gT(r,["n","e"]))}var Nc={};V(Nc,{jwkToPkcs1:()=>EQ,jwkToPkix:()=>xQ,pkcs1ToJwk:()=>wQ,pkixToJwk:()=>vQ});var H5e=fe(xc(),1),z5e=fe(cu(),1);var ei=fe(Ge(),1);function wQ(r){let e=ei.default.asn1.fromDer(T(r,"ascii")),t=ei.default.pki.privateKeyFromAsn1(e);return{kty:"RSA",n:_s(t.n),e:_s(t.e),d:_s(t.d),p:_s(t.p),q:_s(t.q),dp:_s(t.dP),dq:_s(t.dQ),qi:_s(t.qInv),alg:"RS256"}}function EQ(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new g("JWK was missing components","ERR_INVALID_PARAMETERS");let e=ei.default.pki.privateKeyToAsn1({n:xn(r.n),e:xn(r.e),d:xn(r.d),p:xn(r.p),q:xn(r.q),dP:xn(r.dp),dQ:xn(r.dq),qInv:xn(r.qi)});return R(ei.default.asn1.toDer(e).getBytes(),"ascii")}function vQ(r){let e=ei.default.asn1.fromDer(T(r,"ascii")),t=ei.default.pki.publicKeyFromAsn1(e);return{kty:"RSA",n:_s(t.n),e:_s(t.e)}}function xQ(r){if(r.n==null||r.e==null)throw new g("JWK was missing components","ERR_INVALID_PARAMETERS");let e=ei.default.pki.publicKeyToAsn1({n:xn(r.n),e:xn(r.e)});return R(ei.default.asn1.toDer(e).getBytes(),"ascii")}async function ET(r){let e=await an.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await ST(e);return{privateKey:t[0],publicKey:t[1]}}async function I5(r){let t=[await an.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await SQ(r)],n=await ST({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function vT(r,e){let t=await an.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await an.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(n,0,n.byteLength)}async function xT(r,e,t){let n=await an.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return an.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,e,t instanceof Uint8Array?t:t.subarray())}async function ST(r){if(r.privateKey==null||r.publicKey==null)throw new g("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([an.get().subtle.exportKey("jwk",r.privateKey),an.get().subtle.exportKey("jwk",r.publicKey)])}async function SQ(r){return an.get().subtle.importKey("jwk",{kty:r.kty,n:r.n,e:r.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function _T(r,e,t,n){let s=e?wT(r):bT(r),o=T(t instanceof Uint8Array?t:t.subarray(),"ascii"),i=n(o,s);return R(i,"ascii")}function AT(r,e){return _T(r,!0,e,(t,n)=>n.encrypt(t))}function RT(r,e){return _T(r,!1,e,(t,n)=>n.decrypt(t))}function $1(r){if(r.kty!=="RSA")throw new g("invalid key type","ERR_INVALID_KEY_TYPE");if(r.n==null)throw new g("invalid key modulus","ERR_INVALID_KEY_MODULUS");return R(r.n,"base64url").length*8}var vp=8192,Ep=class{_key;constructor(e){this._key=e}verify(e,t){return xT(this._key,t,e)}marshal(){return Nc.jwkToPkix(this._key)}get bytes(){return to.encode({Type:_t.RSA,Data:this.marshal()}).subarray()}encrypt(e){return AT(this._key,e)}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return qn(e)?e.then(({bytes:t})=>t):e.bytes}},mu=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t}genSecret(){return Bc(16)}sign(e){return vT(this._key,e)}get public(){if(this._publicKey==null)throw new g("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new Ep(this._publicKey)}decrypt(e){return RT(this._key,e)}marshal(){return Nc.jwkToPkcs1(this._key)}get bytes(){return ro.encode({Type:_t.RSA,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return qn(e)?e.then(({bytes:t})=>t):e.bytes}async id(){let e=await this.public.hash();return T(e,"base58btc")}async export(e,t="pkcs-8"){if(t==="pkcs-8"){let n=new wp.default.util.ByteBuffer(this.marshal()),s=wp.default.asn1.fromDer(n),o=wp.default.pki.privateKeyFromAsn1(s),i={algorithm:"aes256",count:1e4,saltSize:128/8,prfAlgorithm:"sha512"};return wp.default.pki.encryptRsaPrivateKey(o,e,i)}else{if(t==="libp2p-key")return pu(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}};async function AQ(r){let e=Nc.pkcs1ToJwk(r);if($1(e)>vp)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let t=await I5(e);return new mu(t.privateKey,t.publicKey)}function RQ(r){let e=Nc.pkixToJwk(r);if($1(e)>vp)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new Ep(e)}async function IQ(r){if($1(r)>vp)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await I5(r);return new mu(e.privateKey,e.publicKey)}async function TQ(r){if(r>vp)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await ET(r);return new mu(e.privateKey,e.publicKey)}var B5={};V(B5,{Secp256k1PrivateKey:()=>Sp,Secp256k1PublicKey:()=>xp,generateKeyPair:()=>HQ,unmarshalSecp256k1PrivateKey:()=>VQ,unmarshalSecp256k1PublicKey:()=>qQ});var kQ=(r,e,t)=>r&e^~r&t,DQ=(r,e,t)=>r&e^r&t^e&t,PQ=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ua=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),fa=new Uint32Array(64),k5=class extends ia{constructor(){super(64,32,8,!1),this.A=ua[0]|0,this.B=ua[1]|0,this.C=ua[2]|0,this.D=ua[3]|0,this.E=ua[4]|0,this.F=ua[5]|0,this.G=ua[6]|0,this.H=ua[7]|0}get(){let{A:e,B:t,C:n,D:s,E:o,F:i,G:a,H:c}=this;return[e,t,n,s,o,i,a,c]}set(e,t,n,s,o,i,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=c|0}process(e,t){for(let f=0;f<16;f++,t+=4)fa[f]=e.getUint32(t,!1);for(let f=16;f<64;f++){let h=fa[f-15],d=fa[f-2],p=As(h,7)^As(h,18)^h>>>3,m=As(d,17)^As(d,19)^d>>>10;fa[f]=m+fa[f-7]+p+fa[f-16]|0}let{A:n,B:s,C:o,D:i,E:a,F:c,G:l,H:u}=this;for(let f=0;f<64;f++){let h=As(a,6)^As(a,11)^As(a,25),d=u+h+kQ(a,c,l)+PQ[f]+fa[f]|0,m=(As(n,2)^As(n,13)^As(n,22))+DQ(n,s,o)|0;u=l,l=c,c=a,a=i+d|0,i=o,o=s,s=n,n=d+m|0}n=n+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(n,s,o,i,a,c,l,u)}roundClean(){fa.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var ha=fu(()=>new k5);function CQ(r){let e=pp(r);Hn(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});let{endo:t,Fp:n,a:s}=e;if(t){if(!n.eql(s,n.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof t!="object"||typeof t.beta!="bigint"||typeof t.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...e})}var{bytesToNumberBE:BQ,hexToBytes:NQ}=K1,Lc={Err:class extends Error{constructor(e=""){super(e)}},_parseInt(r){let{Err:e}=Lc;if(r.length<2||r[0]!==2)throw new e("Invalid signature integer tag");let t=r[1],n=r.subarray(2,t+2);if(!t||n.length!==t)throw new e("Invalid signature integer: wrong length");if(n[0]&128)throw new e("Invalid signature integer: negative");if(n[0]===0&&!(n[1]&128))throw new e("Invalid signature integer: unnecessary leading zero");return{d:BQ(n),l:r.subarray(t+2)}},toSig(r){let{Err:e}=Lc,t=typeof r=="string"?NQ(r):r;if(!Is(t))throw new Error("ui8a expected");let n=t.length;if(n<2||t[0]!=48)throw new e("Invalid signature tag");if(t[1]!==n-2)throw new e("Invalid signature: incorrect length");let{d:s,l:o}=Lc._parseInt(t.subarray(2)),{d:i,l:a}=Lc._parseInt(o);if(a.length)throw new e("Invalid signature: left bytes after parsing");return{r:s,s:i}},hexFromSig(r){let e=l=>Number.parseInt(l[0],16)&8?"00"+l:l,t=l=>{let u=l.toString(16);return u.length&1?`0${u}`:u},n=e(t(r.s)),s=e(t(r.r)),o=n.length/2,i=s.length/2,a=t(o),c=t(i);return`30${t(i+o+4)}02${c}${s}02${a}${n}`}},ti=BigInt(0),zn=BigInt(1),d6e=BigInt(2),IT=BigInt(3),m6e=BigInt(4);function LQ(r){let e=CQ(r),{Fp:t}=e,n=e.toBytes||((p,m,y)=>{let b=m.toAffine();return Xo(Uint8Array.from([4]),t.toBytes(b.x),t.toBytes(b.y))}),s=e.fromBytes||(p=>{let m=p.subarray(1),y=t.fromBytes(m.subarray(0,t.BYTES)),b=t.fromBytes(m.subarray(t.BYTES,2*t.BYTES));return{x:y,y:b}});function o(p){let{a:m,b:y}=e,b=t.sqr(p),w=t.mul(b,p);return t.add(t.add(w,t.mul(p,m)),y)}if(!t.eql(t.sqr(e.Gy),o(e.Gx)))throw new Error("bad generator point: equation left != right");function i(p){return typeof p=="bigint"&&ti<p&&p<e.n}function a(p){if(!i(p))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function c(p){let{allowedPrivateKeyLengths:m,nByteLength:y,wrapPrivateKey:b,n:w}=e;if(m&&typeof p!="bigint"){if(Is(p)&&(p=Yo(p)),typeof p!="string"||!m.includes(p.length))throw new Error("Invalid key");p=p.padStart(y*2,"0")}let E;try{E=typeof p=="bigint"?p:jo(bt("private key",p,y))}catch{throw new Error(`private key must be ${y} bytes, hex or bigint, not ${typeof p}`)}return b&&(E=rt(E,w)),a(E),E}let l=new Map;function u(p){if(!(p instanceof f))throw new Error("ProjectivePoint expected")}class f{constructor(m,y,b){if(this.px=m,this.py=y,this.pz=b,m==null||!t.isValid(m))throw new Error("x required");if(y==null||!t.isValid(y))throw new Error("y required");if(b==null||!t.isValid(b))throw new Error("z required")}static fromAffine(m){let{x:y,y:b}=m||{};if(!m||!t.isValid(y)||!t.isValid(b))throw new Error("invalid affine point");if(m instanceof f)throw new Error("projective point not allowed");let w=E=>t.eql(E,t.ZERO);return w(y)&&w(b)?f.ZERO:new f(y,b,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(m){let y=t.invertBatch(m.map(b=>b.pz));return m.map((b,w)=>b.toAffine(y[w])).map(f.fromAffine)}static fromHex(m){let y=f.fromAffine(s(bt("pointHex",m)));return y.assertValidity(),y}static fromPrivateKey(m){return f.BASE.multiply(c(m))}_setWindowSize(m){this._WINDOW_SIZE=m,l.delete(this)}assertValidity(){if(this.is0()){if(e.allowInfinityPoint&&!t.is0(this.py))return;throw new Error("bad point: ZERO")}let{x:m,y}=this.toAffine();if(!t.isValid(m)||!t.isValid(y))throw new Error("bad point: x or y not FE");let b=t.sqr(y),w=o(m);if(!t.eql(b,w))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){let{y:m}=this.toAffine();if(t.isOdd)return!t.isOdd(m);throw new Error("Field doesn't support isOdd")}equals(m){u(m);let{px:y,py:b,pz:w}=this,{px:E,py:x,pz:v}=m,S=t.eql(t.mul(y,v),t.mul(E,w)),A=t.eql(t.mul(b,v),t.mul(x,w));return S&&A}negate(){return new f(this.px,t.neg(this.py),this.pz)}double(){let{a:m,b:y}=e,b=t.mul(y,IT),{px:w,py:E,pz:x}=this,v=t.ZERO,S=t.ZERO,A=t.ZERO,_=t.mul(w,w),D=t.mul(E,E),K=t.mul(x,x),O=t.mul(w,E);return O=t.add(O,O),A=t.mul(w,x),A=t.add(A,A),v=t.mul(m,A),S=t.mul(b,K),S=t.add(v,S),v=t.sub(D,S),S=t.add(D,S),S=t.mul(v,S),v=t.mul(O,v),A=t.mul(b,A),K=t.mul(m,K),O=t.sub(_,K),O=t.mul(m,O),O=t.add(O,A),A=t.add(_,_),_=t.add(A,_),_=t.add(_,K),_=t.mul(_,O),S=t.add(S,_),K=t.mul(E,x),K=t.add(K,K),_=t.mul(K,O),v=t.sub(v,_),A=t.mul(K,D),A=t.add(A,A),A=t.add(A,A),new f(v,S,A)}add(m){u(m);let{px:y,py:b,pz:w}=this,{px:E,py:x,pz:v}=m,S=t.ZERO,A=t.ZERO,_=t.ZERO,D=e.a,K=t.mul(e.b,IT),O=t.mul(y,E),F=t.mul(b,x),W=t.mul(w,v),ce=t.add(y,b),B=t.add(E,x);ce=t.mul(ce,B),B=t.add(O,F),ce=t.sub(ce,B),B=t.add(y,w);let N=t.add(E,v);return B=t.mul(B,N),N=t.add(O,W),B=t.sub(B,N),N=t.add(b,w),S=t.add(x,v),N=t.mul(N,S),S=t.add(F,W),N=t.sub(N,S),_=t.mul(D,B),S=t.mul(K,W),_=t.add(S,_),S=t.sub(F,_),_=t.add(F,_),A=t.mul(S,_),F=t.add(O,O),F=t.add(F,O),W=t.mul(D,W),B=t.mul(K,B),F=t.add(F,W),W=t.sub(O,W),W=t.mul(D,W),B=t.add(B,W),O=t.mul(F,B),A=t.add(A,O),O=t.mul(N,B),S=t.mul(ce,S),S=t.sub(S,O),O=t.mul(ce,F),_=t.mul(N,_),_=t.add(_,O),new f(S,A,_)}subtract(m){return this.add(m.negate())}is0(){return this.equals(f.ZERO)}wNAF(m){return d.wNAFCached(this,l,m,y=>{let b=t.invertBatch(y.map(w=>w.pz));return y.map((w,E)=>w.toAffine(b[E])).map(f.fromAffine)})}multiplyUnsafe(m){let y=f.ZERO;if(m===ti)return y;if(a(m),m===zn)return this;let{endo:b}=e;if(!b)return d.unsafeLadder(this,m);let{k1neg:w,k1:E,k2neg:x,k2:v}=b.splitScalar(m),S=y,A=y,_=this;for(;E>ti||v>ti;)E&zn&&(S=S.add(_)),v&zn&&(A=A.add(_)),_=_.double(),E>>=zn,v>>=zn;return w&&(S=S.negate()),x&&(A=A.negate()),A=new f(t.mul(A.px,b.beta),A.py,A.pz),S.add(A)}multiply(m){a(m);let y=m,b,w,{endo:E}=e;if(E){let{k1neg:x,k1:v,k2neg:S,k2:A}=E.splitScalar(y),{p:_,f:D}=this.wNAF(v),{p:K,f:O}=this.wNAF(A);_=d.constTimeNegate(x,_),K=d.constTimeNegate(S,K),K=new f(t.mul(K.px,E.beta),K.py,K.pz),b=_.add(K),w=D.add(O)}else{let{p:x,f:v}=this.wNAF(y);b=x,w=v}return f.normalizeZ([b,w])[0]}multiplyAndAddUnsafe(m,y,b){let w=f.BASE,E=(v,S)=>S===ti||S===zn||!v.equals(w)?v.multiplyUnsafe(S):v.multiply(S),x=E(this,y).add(E(m,b));return x.is0()?void 0:x}toAffine(m){let{px:y,py:b,pz:w}=this,E=this.is0();m==null&&(m=E?t.ONE:t.inv(w));let x=t.mul(y,m),v=t.mul(b,m),S=t.mul(w,m);if(E)return{x:t.ZERO,y:t.ZERO};if(!t.eql(S,t.ONE))throw new Error("invZ was invalid");return{x,y:v}}isTorsionFree(){let{h:m,isTorsionFree:y}=e;if(m===zn)return!0;if(y)return y(f,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){let{h:m,clearCofactor:y}=e;return m===zn?this:y?y(f,this):this.multiplyUnsafe(e.h)}toRawBytes(m=!0){return this.assertValidity(),n(f,this,m)}toHex(m=!0){return Yo(this.toRawBytes(m))}}f.BASE=new f(e.Gx,e.Gy,t.ONE),f.ZERO=new f(t.ZERO,t.ONE,t.ZERO);let h=e.nBitLength,d=F1(f,e.endo?Math.ceil(h/2):h);return{CURVE:e,ProjectivePoint:f,normPrivateKeyToScalar:c,weierstrassEquation:o,isWithinCurveOrder:i}}function OQ(r){let e=pp(r);return Hn(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function TT(r){let e=OQ(r),{Fp:t,n}=e,s=t.BYTES+1,o=2*t.BYTES+1;function i(B){return ti<B&&B<t.ORDER}function a(B){return rt(B,n)}function c(B){return M1(B,n)}let{ProjectivePoint:l,normPrivateKeyToScalar:u,weierstrassEquation:f,isWithinCurveOrder:h}=LQ({...e,toBytes(B,N,L){let U=N.toAffine(),k=t.toBytes(U.x),G=Xo;return L?G(Uint8Array.from([N.hasEvenY()?2:3]),k):G(Uint8Array.from([4]),k,t.toBytes(U.y))},fromBytes(B){let N=B.length,L=B[0],U=B.subarray(1);if(N===s&&(L===2||L===3)){let k=jo(U);if(!i(k))throw new Error("Point is not on curve");let G=f(k),Q=t.sqrt(G),se=(Q&zn)===zn;return(L&1)===1!==se&&(Q=t.neg(Q)),{x:k,y:Q}}else if(N===o&&L===4){let k=t.fromBytes(U.subarray(0,t.BYTES)),G=t.fromBytes(U.subarray(t.BYTES,2*t.BYTES));return{x:k,y:G}}else throw new Error(`Point of length ${N} was invalid. Expected ${s} compressed bytes or ${o} uncompressed bytes`)}}),d=B=>Yo(la(B,e.nByteLength));function p(B){let N=n>>zn;return B>N}function m(B){return p(B)?a(-B):B}let y=(B,N,L)=>jo(B.slice(N,L));class b{constructor(N,L,U){this.r=N,this.s=L,this.recovery=U,this.assertValidity()}static fromCompact(N){let L=e.nByteLength;return N=bt("compactSignature",N,L*2),new b(y(N,0,L),y(N,L,2*L))}static fromDER(N){let{r:L,s:U}=Lc.toSig(bt("DER",N));return new b(L,U)}assertValidity(){if(!h(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!h(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(N){return new b(this.r,this.s,N)}recoverPublicKey(N){let{r:L,s:U,recovery:k}=this,G=A(bt("msgHash",N));if(k==null||![0,1,2,3].includes(k))throw new Error("recovery id invalid");let Q=k===2||k===3?L+e.n:L;if(Q>=t.ORDER)throw new Error("recovery id 2 or 3 invalid");let se=k&1?"03":"02",Ee=l.fromHex(se+d(Q)),Se=c(Q),Ke=a(-G*Se),_e=a(U*Se),Ie=l.BASE.multiplyAndAddUnsafe(Ee,Ke,_e);if(!Ie)throw new Error("point at infinify");return Ie.assertValidity(),Ie}hasHighS(){return p(this.s)}normalizeS(){return this.hasHighS()?new b(this.r,a(-this.s),this.recovery):this}toDERRawBytes(){return kc(this.toDERHex())}toDERHex(){return Lc.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return kc(this.toCompactHex())}toCompactHex(){return d(this.r)+d(this.s)}}let w={isValidPrivateKey(B){try{return u(B),!0}catch{return!1}},normPrivateKeyToScalar:u,randomPrivateKey:()=>{let B=d5(e.n);return JI(e.randomBytes(B),e.n)},precompute(B=8,N=l.BASE){return N._setWindowSize(B),N.multiply(BigInt(3)),N}};function E(B,N=!0){return l.fromPrivateKey(B).toRawBytes(N)}function x(B){let N=Is(B),L=typeof B=="string",U=(N||L)&&B.length;return N?U===s||U===o:L?U===2*s||U===2*o:B instanceof l}function v(B,N,L=!0){if(x(B))throw new Error("first arg must be private key");if(!x(N))throw new Error("second arg must be public key");return l.fromHex(N).multiply(u(B)).toRawBytes(L)}let S=e.bits2int||function(B){let N=jo(B),L=B.length*8-e.nBitLength;return L>0?N>>BigInt(L):N},A=e.bits2int_modN||function(B){return a(S(B))},_=hp(e.nBitLength);function D(B){if(typeof B!="bigint")throw new Error("bigint expected");if(!(ti<=B&&B<_))throw new Error(`bigint expected < 2^${e.nBitLength}`);return la(B,e.nByteLength)}function K(B,N,L=O){if(["recovered","canonical"].some(at=>at in L))throw new Error("sign() legacy options not supported");let{hash:U,randomBytes:k}=e,{lowS:G,prehash:Q,extraEntropy:se}=L;G==null&&(G=!0),B=bt("msgHash",B),Q&&(B=bt("prehashed msgHash",U(B)));let Ee=A(B),Se=u(N),Ke=[D(Se),D(Ee)];if(se!=null){let at=se===!0?k(t.BYTES):se;Ke.push(bt("extraEntropy",at))}let _e=Xo(...Ke),Ie=Ee;function pt(at){let br=S(at);if(!h(br))return;let wr=c(br),rr=l.BASE.multiply(br).toAffine(),Nr=a(rr.x);if(Nr===ti)return;let Bo=a(wr*a(Ie+Nr*Se));if(Bo===ti)return;let Ja=(rr.x===Nr?0:2)|Number(rr.y&zn),gh=Bo;return G&&p(Bo)&&(gh=m(Bo),Ja^=1),new b(Nr,gh,Ja)}return{seed:_e,k2sig:pt}}let O={lowS:e.lowS,prehash:!1},F={lowS:e.lowS,prehash:!1};function W(B,N,L=O){let{seed:U,k2sig:k}=K(B,N,L),G=e;return l5(G.hash.outputLen,G.nByteLength,G.hmac)(U,k)}l.BASE._setWindowSize(8);function ce(B,N,L,U=F){let k=B;if(N=bt("msgHash",N),L=bt("publicKey",L),"strict"in U)throw new Error("options.strict was renamed to lowS");let{lowS:G,prehash:Q}=U,se,Ee;try{if(typeof k=="string"||Is(k))try{se=b.fromDER(k)}catch(rr){if(!(rr instanceof Lc.Err))throw rr;se=b.fromCompact(k)}else if(typeof k=="object"&&typeof k.r=="bigint"&&typeof k.s=="bigint"){let{r:rr,s:Nr}=k;se=new b(rr,Nr)}else throw new Error("PARSE");Ee=l.fromHex(L)}catch(rr){if(rr.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(G&&se.hasHighS())return!1;Q&&(N=e.hash(N));let{r:Se,s:Ke}=se,_e=A(N),Ie=c(Ke),pt=a(_e*Ie),at=a(Se*Ie),br=l.BASE.multiplyAndAddUnsafe(Ee,pt,at)?.toAffine();return br?a(br.x)===Se:!1}return{CURVE:e,getPublicKey:E,getSharedSecret:v,sign:W,verify:ce,ProjectivePoint:l,Signature:b,utils:w}}var G1=class extends uu{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,Ic(e);let n=Rs(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let s=this.blockLen,o=new Uint8Array(s);o.set(n.length>s?e.create().update(n).digest():n);for(let i=0;i<o.length;i++)o[i]^=54;this.iHash.update(o),this.oHash=e.create();for(let i=0;i<o.length;i++)o[i]^=106;this.oHash.update(o),o.fill(0)}update(e){return lu(this),this.iHash.update(e),this}digestInto(e){lu(this),n5(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:t,iHash:n,finished:s,destroyed:o,blockLen:i,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=o,e.blockLen=i,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},pa=(r,e,t)=>new G1(r,e).update(t).digest();pa.create=(r,e)=>new G1(r,e);function KQ(r){return{hash:r,hmac:(e,...t)=>pa(r,e,N1(...t)),randomBytes:zt}}function kT(r,e){let t=n=>TT({...r,...KQ(n)});return Object.freeze({...t(e),create:t})}var CT=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),DT=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),MQ=BigInt(1),D5=BigInt(2),PT=(r,e)=>(r+e/D5)/e;function UQ(r){let e=CT,t=BigInt(3),n=BigInt(6),s=BigInt(11),o=BigInt(22),i=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,u=l*l*r%e,f=wt(u,t,e)*u%e,h=wt(f,t,e)*u%e,d=wt(h,D5,e)*l%e,p=wt(d,s,e)*d%e,m=wt(p,o,e)*p%e,y=wt(m,a,e)*m%e,b=wt(y,c,e)*y%e,w=wt(b,a,e)*m%e,E=wt(w,t,e)*u%e,x=wt(E,i,e)*p%e,v=wt(x,n,e)*l%e,S=wt(v,D5,e);if(!P5.eql(P5.sqr(S),r))throw new Error("Cannot find square root");return S}var P5=U1(CT,void 0,void 0,{sqrt:UQ}),ae=kT({a:BigInt(0),b:BigInt(7),Fp:P5,n:DT,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:r=>{let e=DT,t=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),n=-MQ*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),o=t,i=BigInt("0x100000000000000000000000000000000"),a=PT(o*r,e),c=PT(-n*r,e),l=rt(r-a*t-c*s,e),u=rt(-a*n-c*o,e),f=l>i,h=u>i;if(f&&(l=e-l),h&&(u=e-u),l>i||u>i)throw new Error("splitScalar: Endomorphism failed, k="+r);return{k1neg:f,k1:l,k2neg:h,k2:u}}}},ha),I6e=BigInt(0);var T6e=ae.ProjectivePoint;function BT(){return ae.utils.randomPrivateKey()}function NT(r,e){let t=$.digest(e instanceof Uint8Array?e:e.subarray());if(qn(t))return t.then(({digest:n})=>ae.sign(n,r).toDERRawBytes()).catch(n=>{throw new g(String(n),"ERR_INVALID_INPUT")});try{return ae.sign(t.digest,r).toDERRawBytes()}catch(n){throw new g(String(n),"ERR_INVALID_INPUT")}}function LT(r,e,t){let n=$.digest(t instanceof Uint8Array?t:t.subarray());if(qn(n))return n.then(({digest:s})=>ae.verify(e,s,r)).catch(s=>{throw new g(String(s),"ERR_INVALID_INPUT")});try{return ae.verify(e,n.digest,r)}catch(s){throw new g(String(s),"ERR_INVALID_INPUT")}}function OT(r){return ae.ProjectivePoint.fromHex(r).toRawBytes(!0)}function KT(r){try{ae.getPublicKey(r,!0)}catch(e){throw new g(String(e),"ERR_INVALID_PRIVATE_KEY")}}function C5(r){try{ae.ProjectivePoint.fromHex(r)}catch(e){throw new g(String(e),"ERR_INVALID_PUBLIC_KEY")}}function MT(r){try{return ae.getPublicKey(r,!0)}catch(e){throw new g(String(e),"ERR_INVALID_PRIVATE_KEY")}}var xp=class{_key;constructor(e){C5(e),this._key=e}verify(e,t){return LT(this._key,t,e)}marshal(){return OT(this._key)}get bytes(){return to.encode({Type:_t.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}async hash(){let e=$.digest(this.bytes),t;return qn(e)?{bytes:t}=await e:t=e.bytes,t}},Sp=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t??MT(e),KT(this._key),C5(this._publicKey)}sign(e){return NT(this._key,e)}get public(){return new xp(this._publicKey)}marshal(){return this._key}get bytes(){return ro.encode({Type:_t.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return qn(e)?e.then(({bytes:t})=>t):e.bytes}async id(){let e=await this.public.hash();return T(e,"base58btc")}async export(e,t="libp2p-key"){if(t==="libp2p-key")return pu(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function VQ(r){return new Sp(r)}function qQ(r){return new xp(r)}async function HQ(){let r=BT();return new Sp(r)}var da={rsa:T5,ed25519:x5,secp256k1:B5};function N5(r){let e=Object.keys(da).join(" / ");return new g(`invalid or unsupported key type ${r}. Must be ${e}`,"ERR_UNSUPPORTED_KEY_TYPE")}function $Q(r){if(r=r.toLowerCase(),r==="rsa"||r==="ed25519"||r==="secp256k1")return da[r];throw N5(r)}function ma(r){let e=to.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case _t.RSA:return da.rsa.unmarshalRsaPublicKey(t);case _t.Ed25519:return da.ed25519.unmarshalEd25519PublicKey(t);case _t.Secp256k1:return da.secp256k1.unmarshalSecp256k1PublicKey(t);default:throw N5(e.Type??"unknown")}}function UT(r,e){return e=(e??"rsa").toLowerCase(),$Q(e),r.bytes}async function W1(r){let e=ro.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case _t.RSA:return da.rsa.unmarshalRsaPrivateKey(t);case _t.Ed25519:return da.ed25519.unmarshalEd25519PrivateKey(t);case _t.Secp256k1:return da.secp256k1.unmarshalSecp256k1PrivateKey(t);default:throw N5(e.Type??"RSA")}}var WQ=fe(G8(),1),YQ=fe(Kt(),1);function yu(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}function Y1(r=0){return globalThis.Buffer?.allocUnsafe!=null?yu(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function L5(r,e){e==null&&(e=r.reduce((s,o)=>s+o.length,0));let t=Y1(e),n=0;for(let s of r)t.set(s,n),n+=s.length;return yu(t)}function FT(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}var F5={};V(F5,{base10:()=>eX});function jQ(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var o=r.charAt(s),i=o.charCodeAt(0);if(t[i]!==255)throw new TypeError(o+" is ambiguous");t[i]=s}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function f(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var m=0,y=0,b=0,w=p.length;b!==w&&p[b]===0;)b++,m++;for(var E=(w-b)*u+1>>>0,x=new Uint8Array(E);b!==w;){for(var v=p[b],S=0,A=E-1;(v!==0||S<y)&&A!==-1;A--,S++)v+=256*x[A]>>>0,x[A]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");y=S,b++}for(var _=E-y;_!==E&&x[_]===0;)_++;for(var D=c.repeat(m);_<E;++_)D+=r.charAt(x[_]);return D}function h(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var m=0;if(p[m]!==" "){for(var y=0,b=0;p[m]===c;)y++,m++;for(var w=(p.length-m)*l+1>>>0,E=new Uint8Array(w);p[m];){var x=t[p.charCodeAt(m)];if(x===255)return;for(var v=0,S=w-1;(x!==0||v<b)&&S!==-1;S--,v++)x+=a*E[S]>>>0,E[S]=x%256>>>0,x=x/256>>>0;if(x!==0)throw new Error("Non-zero carry");b=v,m++}if(p[m]!==" "){for(var A=w-b;A!==w&&E[A]===0;)A++;for(var _=new Uint8Array(y+(w-A)),D=y;A!==w;)_[D++]=E[A++];return _}}}function d(p){var m=h(p);if(m)return m;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:h,decode:d}}var QQ=jQ,XQ=QQ,VT=XQ;var ube=new Uint8Array(0);var qT=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},ri=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var HT=r=>new TextEncoder().encode(r),zT=r=>new TextDecoder().decode(r);var O5=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},K5=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return GT(this,e)}},M5=class{constructor(e){this.decoders=e}or(e){return GT(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},GT=(r,e)=>new M5({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}}),U5=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new O5(e,t,n),this.decoder=new K5(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},gu=({name:r,prefix:e,encode:t,decode:n})=>new U5(r,e,t,n),ya=({prefix:r,name:e,alphabet:t})=>{let{encode:n,decode:s}=VT(t,e);return gu({prefix:r,name:e,encode:n,decode:o=>ri(s(o))})},JQ=(r,e,t,n)=>{let s={};for(let u=0;u<e.length;++u)s[e[u]]=u;let o=r.length;for(;r[o-1]==="=";)--o;let i=new Uint8Array(o*t/8|0),a=0,c=0,l=0;for(let u=0;u<o;++u){let f=s[r[u]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|f,a+=t,a>=8&&(a-=8,i[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return i},ZQ=(r,e,t)=>{let n=e[e.length-1]==="=",s=(1<<t)-1,o="",i=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],i+=8;i>t;)i-=t,o+=e[s&a>>i];if(i&&(o+=e[s&a<<t-i]),n)for(;o.length*t&7;)o+="=";return o},Mt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>gu({prefix:e,name:r,encode(s){return ZQ(s,n,t)},decode(s){return JQ(s,n,t,r)}});var eX=ya({prefix:"9",name:"base10",alphabet:"0123456789"});var V5={};V(V5,{base16:()=>tX,base16upper:()=>rX});var tX=Mt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),rX=Mt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var q5={};V(q5,{base2:()=>nX});var nX=Mt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var H5={};V(H5,{base256emoji:()=>cX});var WT=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),sX=WT.reduce((r,e,t)=>(r[t]=e,r),[]),oX=WT.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function iX(r){return r.reduce((e,t)=>(e+=sX[t],e),"")}function aX(r){let e=[];for(let t of r){let n=oX[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}var cX=gu({prefix:"\u{1F680}",name:"base256emoji",encode:iX,decode:aX});var z5={};V(z5,{base32:()=>bu,base32hex:()=>hX,base32hexpad:()=>dX,base32hexpadupper:()=>mX,base32hexupper:()=>pX,base32pad:()=>uX,base32padupper:()=>fX,base32upper:()=>lX,base32z:()=>yX});var bu=Mt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),lX=Mt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),uX=Mt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),fX=Mt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),hX=Mt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),pX=Mt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),dX=Mt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),mX=Mt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),yX=Mt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var $5={};V($5,{base36:()=>gX,base36upper:()=>bX});var gX=ya({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),bX=ya({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var G5={};V(G5,{base58btc:()=>no,base58flickr:()=>wX});var no=ya({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),wX=ya({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var W5={};V(W5,{base64:()=>EX,base64pad:()=>vX,base64url:()=>xX,base64urlpad:()=>SX});var EX=Mt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),vX=Mt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),xX=Mt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),SX=Mt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var Y5={};V(Y5,{base8:()=>_X});var _X=Mt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var j5={};V(j5,{identity:()=>AX});var AX=gu({prefix:"\0",name:"identity",encode:r=>zT(r),decode:r=>HT(r)});var Abe=new TextEncoder,Rbe=new TextDecoder;var X5={};V(X5,{identity:()=>YX});var TX=QT,YT=128,kX=127,DX=~kX,PX=Math.pow(2,31);function QT(r,e,t){e=e||[],t=t||0;for(var n=t;r>=PX;)e[t++]=r&255|YT,r/=128;for(;r&DX;)e[t++]=r&255|YT,r>>>=7;return e[t]=r|0,QT.bytes=t-n+1,e}var CX=Q5,BX=128,jT=127;function Q5(r,n){var t=0,n=n||0,s=0,o=n,i,a=r.length;do{if(o>=a)throw Q5.bytes=0,new RangeError("Could not decode varint");i=r[o++],t+=s<28?(i&jT)<<s:(i&jT)*Math.pow(2,s),s+=7}while(i>=BX);return Q5.bytes=o-n,t}var NX=Math.pow(2,7),LX=Math.pow(2,14),OX=Math.pow(2,21),KX=Math.pow(2,28),MX=Math.pow(2,35),UX=Math.pow(2,42),FX=Math.pow(2,49),VX=Math.pow(2,56),qX=Math.pow(2,63),HX=function(r){return r<NX?1:r<LX?2:r<OX?3:r<KX?4:r<MX?5:r<UX?6:r<FX?7:r<VX?8:r<qX?9:10},zX={encode:TX,decode:CX,encodingLength:HX},$X=zX,_p=$X;var Ap=(r,e=0)=>[_p.decode(r,e),_p.decode.bytes],wu=(r,e,t=0)=>(_p.encode(r,e,t),e),Eu=r=>_p.encodingLength(r);var Oc=(r,e)=>{let t=e.byteLength,n=Eu(r),s=n+Eu(t),o=new Uint8Array(s+t);return wu(r,o,0),wu(t,o,n),o.set(e,s),new vu(r,t,e,o)},XT=r=>{let e=ri(r),[t,n]=Ap(e),[s,o]=Ap(e.subarray(n)),i=e.subarray(n+o);if(i.byteLength!==s)throw new Error("Incorrect length");return new vu(t,s,i,e)},JT=(r,e)=>{if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&qT(r.bytes,t.bytes)}},vu=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};var ZT=0,GX="identity",ek=ri,WX=r=>Oc(ZT,ek(r)),YX={code:ZT,name:GX,encode:ek,digest:WX};var t6={};V(t6,{sha256:()=>e6,sha512:()=>jX});var Z5=({name:r,code:e,encode:t})=>new J5(r,e,t),J5=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?Oc(this.code,t):t.then(n=>Oc(this.code,n))}else throw Error("Unknown type, must be binary type")}};var rk=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),e6=Z5({name:"sha2-256",code:18,encode:rk("SHA-256")}),jX=Z5({name:"sha2-512",code:19,encode:rk("SHA-512")});var nk=(r,e)=>{let{bytes:t,version:n}=r;switch(n){case 0:return XX(t,r6(r),e||no.encoder);default:return JX(t,r6(r),e||bu.encoder)}};var sk=new WeakMap,r6=r=>{let e=sk.get(r);if(e==null){let t=new Map;return sk.set(r,t),t}return e},Q1=class r{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==Ip)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==ZX)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=Oc(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n&&e.code===n.code&&e.version===n.version&&JT(e.multihash,n.multihash)}toString(e){return nk(this,e)}toJSON(){return{"/":nk(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:s,multihash:o,bytes:i}=t;return new r(n,s,o,i||ok(n,s,o.bytes))}else if(t[eJ]===!0){let{version:n,multihash:s,code:o}=t,i=XT(s);return r.create(n,o,i)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Ip)throw new Error(`Version 0 CID must use dag-pb (code: ${Ip}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let s=ok(e,t,n.bytes);return new r(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,Ip,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,s=ri(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");let o=s.subarray(t.multihashSize-t.digestSize),i=new vu(t.multihashCode,t.digestSize,o,s);return[t.version===0?r.createV0(i):r.createV1(t.codec,i),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[f,h]=Ap(e.subarray(t));return t+=h,f},s=n(),o=Ip;if(s===18?(s=0,t=0):o=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);let i=t,a=n(),c=n(),l=t+c,u=l-i;return{version:s,codec:o,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){let[n,s]=QX(e,t),o=r.decode(s);if(o.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return r6(o).set(n,e),o}},QX=(r,e)=>{switch(r[0]){case"Q":{let t=e||no;return[no.prefix,t.decode(`${no.prefix}${r}`)]}case no.prefix:{let t=e||no;return[no.prefix,t.decode(r)]}case bu.prefix:{let t=e||bu;return[bu.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},XX=(r,e,t)=>{let{prefix:n}=t;if(n!==no.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let s=e.get(n);if(s==null){let o=t.encode(r).slice(1);return e.set(n,o),o}else return s},JX=(r,e,t)=>{let{prefix:n}=t,s=e.get(n);if(s==null){let o=t.encode(r);return e.set(n,o),o}else return s},Ip=112,ZX=18,ok=(r,e,t)=>{let n=Eu(r),s=n+Eu(e),o=new Uint8Array(s+t.byteLength);return wu(r,o,0),wu(e,o,n),o.set(t,s),o},eJ=Symbol.for("@ipld/js-cid/CID");var n6={...j5,...q5,...Y5,...F5,...V5,...z5,...$5,...G5,...W5,...H5},qbe={...t6,...X5};function ak(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var ik=ak("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),s6=ak("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=Y1(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),tJ={utf8:ik,"utf-8":ik,hex:n6.base16,latin1:s6,ascii:s6,binary:s6,...n6},X1=tJ;function ck(r,e="utf8"){let t=X1[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?yu(globalThis.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}function Tp(r,e="utf8"){let t=X1[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):t.encoder.encode(r).substring(1)}var lk=ck("libp2p-pubsub:");async function uk(r,e,t,n){switch(r.type){case ea.Signing:{let s={from:r.author.toBytes(),data:n,seqno:Bc(8),topic:e,signature:void 0,key:void 0},o=L5([lk,sp.Message.encode(s).finish()]);s.signature=await r.privateKey.sign(o),s.key=r.key;let i={type:"signed",from:r.author,data:t,sequenceNumber:BigInt(`0x${Tp(s.seqno,"base16")}`),topic:e,signature:s.signature,key:s.key};return{raw:s,msg:i}}case ea.Anonymous:return{raw:{from:void 0,data:n,seqno:void 0,topic:e,signature:void 0,key:void 0},msg:{type:"unsigned",data:t,topic:e}};default:throw new Error("Unreachable")}}async function fk(r,e){switch(r){case Ul:return e.signature!=null?{valid:!1,error:Fr.SignaturePresent}:e.seqno!=null?{valid:!1,error:Fr.SeqnoPresent}:e.key!=null?{valid:!1,error:Fr.FromPresent}:{valid:!0,message:{type:"unsigned",topic:e.topic,data:e.data??new Uint8Array(0)}};case ic:{if(e.seqno==null)return{valid:!1,error:Fr.InvalidSeqno};if(e.seqno.length!==8)return{valid:!1,error:Fr.InvalidSeqno};if(e.signature==null)return{valid:!1,error:Fr.InvalidSignature};if(e.from==null)return{valid:!1,error:Fr.InvalidPeerId};let t;try{t=dt(e.from)}catch{return{valid:!1,error:Fr.InvalidPeerId}}let n;if(e.key!=null){if(n=ma(e.key),t.publicKey!==void 0&&!FT(n.bytes,t.publicKey))return{valid:!1,error:Fr.InvalidPeerId}}else{if(t.publicKey==null)return{valid:!1,error:Fr.InvalidPeerId};n=ma(t.publicKey)}let s={from:e.from,data:e.data,seqno:e.seqno,topic:e.topic,signature:void 0,key:void 0},o=L5([lk,sp.Message.encode(s).finish()]);return await n.verify(o,e.signature)?{valid:!0,message:{type:"signed",from:t,data:e.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${Tp(e.seqno,"base16")}`),topic:e.topic,signature:e.signature,key:e.key??UT(n)}}:{valid:!1,error:Fr.InvalidSignature}}default:throw new Error("Unreachable")}}function so(r){if(r.length<=1)return r;let e=()=>Math.floor(Math.random()*Math.floor(r.length));for(let t=0;t<r.length;t++){let n=e(),s=r[t];r[t]=r[n],r[n]=s}return r}function hk(r){return Tp(r,"base64")}async function o6(r,e){switch(r){case ic:{if(e==null)throw Error("Must provide PeerId");if(e.privateKey==null)throw Error("Cannot sign message, no private key present");if(e.publicKey==null)throw Error("Cannot sign message, no public key present");let t=await W1(e.privateKey);return{type:ea.Signing,author:e,key:e.publicKey,privateKey:t}}case Ul:return{type:ea.Anonymous};default:throw new Error(`Unknown signature policy "${r}"`)}}var $n;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.Secp256k1="Secp256k1"})($n||($n={}));var i6;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.Secp256k1=2]="Secp256k1"})(i6||(i6={}));(function(r){r.codec=()=>Te(i6)})($n||($n={}));var xu;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),$n.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=$n.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(xu||(xu={}));var Su;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),$n.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=$n.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(Su||(Su={}));var oJ={"P-256":256,"P-384":384,"P-521":521},iJ=Object.keys(oJ),eEe=iJ.join(" / ");function yk(r,e,t,n){Ic(r);let s=VI({dkLen:32,asyncTick:10},n),{c:o,dkLen:i,asyncTick:a}=s;if(oa(o),oa(i),oa(a),o<1)throw new Error("PBKDF2: iterations (c) should be >= 1");let c=Rs(e),l=Rs(t),u=new Uint8Array(i),f=pa.create(r,c),h=f._cloneInto().update(l);return{c:o,dkLen:i,asyncTick:a,DK:u,PRF:f,PRFSalt:h}}function gk(r,e,t,n,s){return r.destroy(),e.destroy(),n&&n.destroy(),s.fill(0),t}function bk(r,e,t,n){let{c:s,dkLen:o,DK:i,PRF:a,PRFSalt:c}=yk(r,e,t,n),l,u=new Uint8Array(4),f=Tc(u),h=new Uint8Array(a.outputLen);for(let d=1,p=0;p<o;d++,p+=a.outputLen){let m=i.subarray(p,p+a.outputLen);f.setInt32(0,d,!1),(l=c._cloneInto(l)).update(u).digestInto(h),m.set(h.subarray(0,m.length));for(let y=1;y<s;y++){a._cloneInto(l).update(h).digestInto(h);for(let b=0;b<m.length;b++)m[b]^=h[b]}}return gk(a,c,i,l,h)}async function Xr(r,e,t,n){let{c:s,dkLen:o,asyncTick:i,DK:a,PRF:c,PRFSalt:l}=yk(r,e,t,n),u,f=new Uint8Array(4),h=Tc(f),d=new Uint8Array(c.outputLen);for(let p=1,m=0;m<o;p++,m+=c.outputLen){let y=a.subarray(m,m+c.outputLen);h.setInt32(0,p,!1),(u=l._cloneInto(u)).update(f).digestInto(d),y.set(d.subarray(0,y.length)),await FI(s-1,i,()=>{c._cloneInto(u).update(d).digestInto(d);for(let b=0;b<y.length;b++)y[b]^=d[b]})}return gk(c,l,a,u,d)}var He=fe(wk());function Kc(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function ga(r,e,t=-1){let n=t,s=r,o=0,i=Math.pow(2,e);for(let a=1;a<8;a++){if(r<i){let c;if(n<0)c=new ArrayBuffer(a),o=a;else{if(n<a)return new ArrayBuffer(0);c=new ArrayBuffer(n),o=n}let l=new Uint8Array(c);for(let u=a-1;u>=0;u--){let f=Math.pow(2,u*e);l[o-u-1]=Math.floor(s/f),s-=l[o-u-1]*f}return c}i*=Math.pow(2,e)}return new ArrayBuffer(0)}function r2(...r){let e=0,t=0;for(let o of r)e+=o.length;let n=new ArrayBuffer(e),s=new Uint8Array(n);for(let o of r)s.set(o,t),t+=o.length;return s}function l6(){let r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){let a=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}let e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=r[0]&128;let n=Kc(t,8),s=new ArrayBuffer(this.valueHex.byteLength),o=new Uint8Array(s);for(let a=0;a<this.valueHex.byteLength;a++)o[a]=r[a];return o[0]&=127,Kc(o,8)-n}function Ek(r){let e=r<0?r*-1:r,t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){let i=t-e,a=ga(i,8,n),c=new Uint8Array(a);return c[0]|=128,a}let s=ga(e,8,n),o=new Uint8Array(s);if(o[0]&128){let i=s.slice(0),a=new Uint8Array(i);s=new ArrayBuffer(s.byteLength+1),o=new Uint8Array(s);for(let c=0;c<i.byteLength;c++)o[c+1]=a[c];o[0]=0}return s}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function vk(r,e){if(r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let s=0;s<t.length;s++)if(t[s]!==n[s])return!1;return!0}function ln(r,e){let t=r.toString(10);if(e<t.length)return"";let n=e-t.length,s=new Array(n);for(let i=0;i<n;i++)s[i]="0";return s.join("").concat(t)}var wEe=Math.log(2);function n2(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function u6(r){let e=0,t=0;for(let s=0;s<r.length;s++){let o=r[s];e+=o.byteLength}let n=new Uint8Array(e);for(let s=0;s<r.length;s++){let o=r[s];n.set(new Uint8Array(o),t),t+=o.byteLength}return n.buffer}function ii(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}var Dp=class{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return u6(this.items)}},kp=[new Uint8Array([1])],xk="0123456789";var Au="",Ds=new ArrayBuffer(0),f6=new Uint8Array(0),Pp="EndOfContent",_k="OCTET STRING",Ak="BIT STRING";function ai(r){var e;return e=class extends r{constructor(...n){var s;super(...n);let o=n[0]||{};this.isHexOnly=(s=o.isHexOnly)!==null&&s!==void 0?s:!1,this.valueHexView=o.valueHex?He.BufferSourceConverter.toUint8Array(o.valueHex):f6}get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}fromBER(n,s,o){let i=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!ii(this,i,s,o))return-1;let a=s+o;return this.valueHexView=i.subarray(s,a),this.valueHexView.length?(this.blockLength=o,a):(this.warnings.push("Zero buffer length"),s)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",Ds)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:He.Convert.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}var si=class{constructor({blockLength:e=0,error:t=Au,warnings:n=[],valueBeforeDecode:s=f6}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=He.BufferSourceConverter.toUint8Array(s)}static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:He.Convert.ToHex(this.valueBeforeDecodeView)}}};si.NAME="baseBlock";var qr=class extends si{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}};qr.NAME="valueBlock";var s2=class extends ai(si){constructor({idBlock:e={}}={}){var t,n,s,o;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?He.BufferSourceConverter.toUint8Array(e.valueHex):f6,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(s=e.tagNumber)!==null&&s!==void 0?s:-1,this.isConstructed=(o=e.isConstructed)!==null&&o!==void 0?o:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",Ds}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){let s=new Uint8Array(1);if(!e){let o=this.tagNumber;o&=31,t|=o,s[0]=t}return s.buffer}if(!this.isHexOnly){let s=ga(this.tagNumber,7),o=new Uint8Array(s),i=s.byteLength,a=new Uint8Array(i+1);if(a[0]=t|31,!e){for(let c=0;c<i-1;c++)a[c+1]=o[c]|128;a[i]=o[i-1]}return a.buffer}let n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){let s=this.valueHexView;for(let o=0;o<s.length-1;o++)n[o+1]=s[o]|128;n[this.valueHexView.byteLength]=s[s.length-1]}return n.buffer}fromBER(e,t,n){let s=He.BufferSourceConverter.toUint8Array(e);if(!ii(this,s,t,n))return-1;let o=s.subarray(t,t+n);if(o.length===0)return this.error="Zero buffer length",-1;switch(o[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(o[0]&32)===32,this.isHexOnly=!1;let a=o[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,l=this.valueHexView=new Uint8Array(255),u=255;for(;o[c]&128;){if(l[c-1]=o[c]&127,c++,c>=o.length)return this.error="End of input reached before message was fully decoded",-1;if(c===u){u+=255;let h=new Uint8Array(u);for(let d=0;d<l.length;d++)h[d]=l[d];l=this.valueHexView=new Uint8Array(u)}}this.blockLength=c+1,l[c-1]=o[c]&127;let f=new Uint8Array(c);for(let h=0;h<c;h++)f[h]=l[h];l=this.valueHexView=new Uint8Array(c),l.set(f),this.blockLength<=9?this.tagNumber=Kc(l,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}};s2.NAME="identificationBlock";var o2=class extends si{constructor({lenBlock:e={}}={}){var t,n,s;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(s=e.length)!==null&&s!==void 0?s:0}fromBER(e,t,n){let s=He.BufferSourceConverter.toUint8Array(e);if(!ii(this,s,t,n))return-1;let o=s.subarray(t,t+n);if(o.length===0)return this.error="Zero buffer length",-1;if(o[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=o[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(o[0]&128),this.longFormUsed===!1)return this.length=o[0],this.blockLength=1,t+this.blockLength;let i=o[0]&127;if(i>8)return this.error="Too big integer",-1;if(i+1>o.length)return this.error="End of input reached before message was fully decoded",-1;let a=t+1,c=s.subarray(a,a+i);return c[i-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=Kc(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=i+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){let s=ga(this.length,8);if(s.byteLength>127)return this.error="Too big length",Ds;if(t=new ArrayBuffer(s.byteLength+1),e)return t;let o=new Uint8Array(s);n=new Uint8Array(t),n[0]=s.byteLength|128;for(let i=0;i<s.byteLength;i++)n[i+1]=o[i];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}};o2.NAME="lengthBlock";var ue={},Sr=class extends si{constructor({name:e=Au,optional:t=!1,primitiveSchema:n,...s}={},o){super(s),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new s2(s),this.lenBlock=new o2(s),this.valueBlock=o?new o(s):new qr(s)}fromBER(e,t,n){let s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}toBER(e,t){let n=t||new Dp;t||Rk(this);let s=this.idBlock.toBER(e);if(n.write(s),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{let o=this.valueBlock.toBER(e);this.lenBlock.length=o.byteLength;let i=this.lenBlock.toBER(e);n.write(i),n.write(o)}return t?Ds:n.final()}toJSON(){let e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():He.Convert.ToHex(this.toBER())}onAsciiEncoding(){return`${this.constructor.NAME} : ${He.Convert.ToHex(this.valueBlock.valueBeforeDecodeView)}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;let t=this.toBER(),n=e.toBER();return vk(t,n)}};Sr.NAME="BaseBlock";function Rk(r){if(r instanceof ue.Constructed)for(let e of r.valueBlock.value)Rk(e)&&(r.lenBlock.isIndefiniteForm=!0);return!!r.lenBlock.isIndefiniteForm}var i2=class extends Sr{constructor({value:e=Au,...t}={},n){super(t,n),e&&this.fromString(e)}getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}fromBER(e,t,n){let s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}};i2.NAME="BaseStringBlock";var a2=class extends ai(qr){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}};a2.NAME="PrimitiveValueBlock";var Ik,c2=class extends Sr{constructor(e={}){super(e,a2),this.idBlock.isConstructed=!1}};Ik=c2;ue.Primitive=Ik;c2.NAME="PRIMITIVE";function mJ(r,e){if(r instanceof e)return r;let t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function V2(r,e=0,t=r.length){let n=e,s=new Sr({},qr),o=new si;if(!ii(o,r,e,t))return s.error=o.error,{offset:-1,result:s};if(!r.subarray(e,e+t).length)return s.error="Zero buffer length",{offset:-1,result:s};let a=s.idBlock.fromBER(r,e,t);if(s.idBlock.warnings.length&&s.warnings.concat(s.idBlock.warnings),a===-1)return s.error=s.idBlock.error,{offset:-1,result:s};if(e=a,t-=s.idBlock.blockLength,a=s.lenBlock.fromBER(r,e,t),s.lenBlock.warnings.length&&s.warnings.concat(s.lenBlock.warnings),a===-1)return s.error=s.lenBlock.error,{offset:-1,result:s};if(e=a,t-=s.lenBlock.blockLength,!s.idBlock.isConstructed&&s.lenBlock.isIndefiniteForm)return s.error="Indefinite length form used for primitive encoding form",{offset:-1,result:s};let c=Sr;switch(s.idBlock.tagClass){case 1:if(s.idBlock.tagNumber>=37&&s.idBlock.isHexOnly===!1)return s.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:s};switch(s.idBlock.tagNumber){case 0:if(s.idBlock.isConstructed&&s.lenBlock.length>0)return s.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:s};c=ue.EndOfContent;break;case 1:c=ue.Boolean;break;case 2:c=ue.Integer;break;case 3:c=ue.BitString;break;case 4:c=ue.OctetString;break;case 5:c=ue.Null;break;case 6:c=ue.ObjectIdentifier;break;case 10:c=ue.Enumerated;break;case 12:c=ue.Utf8String;break;case 13:c=ue.RelativeObjectIdentifier;break;case 14:c=ue.TIME;break;case 15:return s.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:s};case 16:c=ue.Sequence;break;case 17:c=ue.Set;break;case 18:c=ue.NumericString;break;case 19:c=ue.PrintableString;break;case 20:c=ue.TeletexString;break;case 21:c=ue.VideotexString;break;case 22:c=ue.IA5String;break;case 23:c=ue.UTCTime;break;case 24:c=ue.GeneralizedTime;break;case 25:c=ue.GraphicString;break;case 26:c=ue.VisibleString;break;case 27:c=ue.GeneralString;break;case 28:c=ue.UniversalString;break;case 29:c=ue.CharacterString;break;case 30:c=ue.BmpString;break;case 31:c=ue.DATE;break;case 32:c=ue.TimeOfDay;break;case 33:c=ue.DateTime;break;case 34:c=ue.Duration;break;default:{let l=s.idBlock.isConstructed?new ue.Constructed:new ue.Primitive;l.idBlock=s.idBlock,l.lenBlock=s.lenBlock,l.warnings=s.warnings,s=l}}break;case 2:case 3:case 4:default:c=s.idBlock.isConstructed?ue.Constructed:ue.Primitive}return s=mJ(s,c),a=s.fromBER(r,e,s.lenBlock.isIndefiniteForm?t:s.lenBlock.length),s.valueBeforeDecodeView=r.subarray(n,n+s.blockLength),{offset:a,result:s}}function tt(r){if(!r.byteLength){let e=new Sr({},qr);return e.error="Input buffer has zero length",{offset:-1,result:e}}return V2(He.BufferSourceConverter.toUint8Array(r).slice(),0,r.byteLength)}function yJ(r,e){return r?1:e}var oo=class extends qr{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){let s=He.BufferSourceConverter.toUint8Array(e);if(!ii(this,s,t,n))return-1;if(this.valueBeforeDecodeView=s.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let o=t;for(;yJ(this.isIndefiniteForm,n)>0;){let i=V2(s,o,n);if(i.offset===-1)return this.error=i.result.error,this.warnings.concat(i.result.warnings),-1;if(o=i.offset,this.blockLength+=i.result.blockLength,n-=i.result.blockLength,this.value.push(i.result),this.isIndefiniteForm&&i.result.constructor.NAME===Pp)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===Pp?this.value.pop():this.warnings.push("No EndOfContent block encoded")),o}toBER(e,t){let n=t||new Dp;for(let s=0;s<this.value.length;s++)this.value[s].toBER(e,n);return t?Ds:n.final()}toJSON(){let e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(let t of this.value)e.value.push(t.toJSON());return e}};oo.NAME="ConstructedValueBlock";var Tk,ba=class extends Sr{constructor(e={}){super(e,oo),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;let s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){let e=[];for(let n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(s=>`  ${s}`).join(`
`));let t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}};Tk=ba;ue.Constructed=Tk;ba.NAME="CONSTRUCTED";var l2=class extends qr{fromBER(e,t,n){return t}toBER(e){return Ds}};l2.override="EndOfContentValueBlock";var kk,u2=class extends Sr{constructor(e={}){super(e,l2),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}};kk=u2;ue.EndOfContent=kk;u2.NAME=Pp;var Dk,yt=class extends Sr{constructor(e={}){super(e,qr),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){let n=new ArrayBuffer(2);if(!e){let s=new Uint8Array(n);s[0]=5,s[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}};Dk=yt;ue.Null=Dk;yt.NAME="NULL";var f2=class extends ai(qr){constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=He.BufferSourceConverter.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}get value(){for(let e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}fromBER(e,t,n){let s=He.BufferSourceConverter.toUint8Array(e);return ii(this,s,t,n)?(this.valueHexView=s.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,l6.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}};f2.NAME="BooleanValueBlock";var Pk,h2=class extends Sr{constructor(e={}){super(e,f2),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};Pk=h2;ue.Boolean=Pk;h2.NAME="BOOLEAN";var p2=class extends ai(oo){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let s=0;if(this.isConstructed){if(this.isHexOnly=!1,s=oo.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(let o=0;o<this.value.length;o++){let i=this.value[o].constructor.NAME;if(i===Pp){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(i!==_k)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,s=super.fromBER(e,t,n),this.blockLength=n;return s}toBER(e,t){return this.isConstructed?oo.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}};p2.NAME="OctetStringValueBlock";var Ck,nt=class r extends Sr{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,o;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((o=n.value)===null||o===void 0)&&o.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},p2),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){let o=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(o.byteLength){let i=V2(o,0,o.byteLength);i.offset!==-1&&i.offset===n&&(this.valueBlock.value=[i.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){return this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length?ba.prototype.onAsciiEncoding.call(this):`${this.constructor.NAME} : ${He.Convert.ToHex(this.valueBlock.valueHexView)}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;let e=[];for(let t of this.valueBlock.value)t instanceof r&&e.push(t.valueBlock.valueHexView);return He.BufferSourceConverter.concat(e)}};Ck=nt;ue.OctetString=Ck;nt.NAME=_k;var d2=class extends ai(oo){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let s=-1;if(this.isConstructed){if(s=oo.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(let a of this.value){let c=a.constructor.NAME;if(c===Pp){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==Ak)return this.error="BIT STRING may consists of BIT STRINGs only",-1;let l=a.valueBlock;if(this.unusedBits>0&&l.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=l.unusedBits}return s}let o=He.BufferSourceConverter.toUint8Array(e);if(!ii(this,o,t,n))return-1;let i=o.subarray(t,t+n);if(this.unusedBits=i[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){let a=i.subarray(1);try{if(a.byteLength){let c=V2(a,0,a.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=i.subarray(1),this.blockLength=i.length,t+n}toBER(e,t){if(this.isConstructed)return oo.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return Ds;let n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}};d2.NAME="BitStringValueBlock";var Bk,Hr=class extends Sr{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,o;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((o=n.value)===null||o===void 0)&&o.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},d2),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return ba.prototype.onAsciiEncoding.call(this);{let e=[],t=this.valueBlock.valueHexView;for(let s of t)e.push(s.toString(2).padStart(8,"0"));let n=e.join("");return`${this.constructor.NAME} : ${n.substring(0,n.length-this.valueBlock.unusedBits)}`}}};Bk=Hr;ue.BitString=Bk;Hr.NAME=Ak;var Nk;function gJ(r,e){let t=new Uint8Array([0]),n=new Uint8Array(r),s=new Uint8Array(e),o=n.slice(0),i=o.length-1,a=s.slice(0),c=a.length-1,l=0,u=c<i?i:c,f=0;for(let h=u;h>=0;h--,f++){switch(!0){case f<a.length:l=o[i-f]+a[c-f]+t[0];break;default:l=o[i-f]+t[0]}switch(t[0]=l/10,!0){case f>=o.length:o=r2(new Uint8Array([l%10]),o);break;default:o[i-f]=l%10}}return t[0]>0&&(o=r2(t,o)),o}function Sk(r){if(r>=kp.length)for(let e=kp.length;e<=r;e++){let t=new Uint8Array([0]),n=kp[e-1].slice(0);for(let s=n.length-1;s>=0;s--){let o=new Uint8Array([(n[s]<<1)+t[0]]);t[0]=o[0]/10,n[s]=o[0]%10}t[0]>0&&(n=r2(t,n)),kp.push(n)}return kp[r]}function bJ(r,e){let t=0,n=new Uint8Array(r),s=new Uint8Array(e),o=n.slice(0),i=o.length-1,a=s.slice(0),c=a.length-1,l,u=0;for(let f=c;f>=0;f--,u++)switch(l=o[i-u]-a[c-u]-t,!0){case l<0:t=1,o[i-u]=l+10;break;default:t=0,o[i-u]=l}if(t>0)for(let f=i-c+1;f>=0;f--,u++)if(l=o[i-u]-t,l<0)t=1,o[i-u]=l+10;else{t=0,o[i-u]=l;break}return o.slice()}var Cp=class extends ai(qr){constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=l6.call(this)))}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(Ek(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,s=0){let o=this.fromBER(e,t,n);if(o===-1)return o;let i=this.valueHexView;return i[0]===0&&i[1]&128?this.valueHexView=i.subarray(1):s!==0&&i.length<s&&(s-i.length>1&&(s=i.length+1),this.valueHexView=i.subarray(s-i.length)),o}toDER(e=!1){let t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{let n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){let s=super.fromBER(e,t,n);return s===-1||this.setValueHex(),s}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){let e=this.valueHexView.length*8-1,t=new Uint8Array(this.valueHexView.length*8/3),n=0,s,o=this.valueHexView,i="",a=!1;for(let c=o.byteLength-1;c>=0;c--){s=o[c];for(let l=0;l<8;l++){if((s&1)===1)switch(n){case e:t=bJ(Sk(n),t),i="-";break;default:t=gJ(t,Sk(n))}n++,s>>=1}}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(i+=xk.charAt(t[c]));return a===!1&&(i+=xk.charAt(0)),i}};Nk=Cp;Cp.NAME="IntegerValueBlock";Object.defineProperty(Nk.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var Lk,X=class r extends Sr{constructor(e={}){super(e,Cp),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return n2(),BigInt(this.valueBlock.toString())}static fromBigInt(e){n2();let t=BigInt(e),n=new Dp,s=t.toString(16).replace(/^-/,""),o=new Uint8Array(He.Convert.FromHex(s));if(t<0){let a=new Uint8Array(o.length+(o[0]&128?1:0));a[0]|=128;let l=BigInt(`0x${He.Convert.ToHex(a)}`)+t,u=He.BufferSourceConverter.toUint8Array(He.Convert.FromHex(l.toString(16)));u[0]|=128,n.write(u)}else o[0]&128&&n.write(new Uint8Array([0])),n.write(o);return new r({valueHex:n.final()})}convertToDER(){let e=new r({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new r({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}};Lk=X;ue.Integer=Lk;X.NAME="INTEGER";var Ok,m2=class extends X{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}};Ok=m2;ue.Enumerated=Ok;m2.NAME="ENUMERATED";var Bp=class extends ai(qr){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;let s=He.BufferSourceConverter.toUint8Array(e);if(!ii(this,s,t,n))return-1;let o=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=o[a]&127,this.blockLength++,!!(o[a]&128));a++);let i=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)i[a]=this.valueHexView[a];return this.valueHexView=i,o[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Kc(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){n2();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;let n=new Uint8Array(t.length/7);for(let s=0;s<n.length;s++)n[s]=parseInt(t.slice(s*7,s*7+7),2)+(s+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let s=this.valueHexView,o=new Uint8Array(this.blockLength);for(let i=0;i<this.blockLength-1;i++)o[i]=s[i]|128;return o[this.blockLength-1]=s[this.blockLength-1],o.buffer}let t=ga(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Ds;let n=new Uint8Array(t.byteLength);if(!e){let s=new Uint8Array(t),o=t.byteLength-1;for(let i=0;i<o;i++)n[i]=s[i]|128;n[o]=s[o]}return n}toString(){let e="";if(this.isHexOnly)e=He.Convert.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}};Bp.NAME="sidBlock";var y2=class extends qr{constructor({value:e=Au,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){let o=new Bp;if(s=o.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=o.error,s;this.value.length===0&&(o.isFirstSid=!0),this.blockLength+=o.blockLength,n-=o.blockLength,this.value.push(o)}return s}toBER(e){let t=[];for(let n=0;n<this.value.length;n++){let s=this.value[n].toBER(e);if(s.byteLength===0)return this.error=this.value[n].error,Ds;t.push(s)}return u6(t)}fromString(e){this.value=[];let t=0,n=0,s="",o=!1;do if(n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1,o){let i=this.value[0],a=0;switch(i.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}let c=parseInt(s,10);if(isNaN(c))return;i.valueDec=c+a,o=!1}else{let i=new Bp;if(s>Number.MAX_SAFE_INTEGER){n2();let a=BigInt(s);i.valueBigInt=a}else if(i.valueDec=parseInt(s,10),isNaN(i.valueDec))return;this.value.length||(i.isFirstSid=!0,o=!0),this.value.push(i)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t?(s=`{${s}}`,this.value[n].isFirstSid?e=`2.{${s} - 80}`:e+=s):e+=s}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};y2.NAME="ObjectIdentifierValueBlock";var Kk,Le=class extends Sr{constructor(e={}){super(e,y2),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};Kk=Le;ue.ObjectIdentifier=Kk;Le.NAME="OBJECT IDENTIFIER";var Np=class extends ai(si){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;let s=He.BufferSourceConverter.toUint8Array(e);if(!ii(this,s,t,n))return-1;let o=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=o[a]&127,this.blockLength++,!!(o[a]&128));a++);let i=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)i[a]=this.valueHexView[a];return this.valueHexView=i,o[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Kc(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let s=this.valueHexView,o=new Uint8Array(this.blockLength);for(let i=0;i<this.blockLength-1;i++)o[i]=s[i]|128;return o[this.blockLength-1]=s[this.blockLength-1],o.buffer}let t=ga(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Ds;let n=new Uint8Array(t.byteLength);if(!e){let s=new Uint8Array(t),o=t.byteLength-1;for(let i=0;i<o;i++)n[i]=s[i]|128;n[o]=s[o]}return n.buffer}toString(){let e="";return this.isHexOnly?e=He.Convert.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}};Np.NAME="relativeSidBlock";var g2=class extends qr{constructor({value:e=Au,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){let o=new Np;if(s=o.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=o.error,s;this.blockLength+=o.blockLength,n-=o.blockLength,this.value.push(o)}return s}toBER(e,t){let n=[];for(let s=0;s<this.value.length;s++){let o=this.value[s].toBER(e);if(o.byteLength===0)return this.error=this.value[s].error,Ds;n.push(o)}return u6(n)}fromString(e){this.value=[];let t=0,n=0,s="";do{n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1;let o=new Np;if(o.valueDec=parseInt(s,10),isNaN(o.valueDec))return!0;this.value.push(o)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(s=`{${s}}`),e+=s}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};g2.NAME="RelativeObjectIdentifierValueBlock";var Mk,b2=class extends Sr{constructor(e={}){super(e,g2),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};Mk=b2;ue.RelativeObjectIdentifier=Mk;b2.NAME="RelativeObjectIdentifier";var Uk,re=class extends ba{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}};Uk=re;ue.Sequence=Uk;re.NAME="SEQUENCE";var Fk,w2=class extends ba{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};Fk=w2;ue.Set=Fk;w2.NAME="SET";var E2=class extends ai(qr){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=Au}toJSON(){return{...super.toJSON(),value:this.value}}};E2.NAME="StringValueBlock";var v2=class extends E2{};v2.NAME="SimpleStringValueBlock";var Jr=class extends i2{constructor({...e}={}){super(e,v2)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,He.BufferSourceConverter.toUint8Array(e))}fromString(e){let t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);this.valueBlock.value=e}};Jr.NAME="SIMPLE STRING";var x2=class extends Jr{fromBuffer(e){this.valueBlock.valueHexView=He.BufferSourceConverter.toUint8Array(e);try{this.valueBlock.value=He.Convert.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=He.Convert.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(He.Convert.FromUtf8String(e)),this.valueBlock.value=e}};x2.NAME="Utf8StringValueBlock";var Vk,oi=class extends x2{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}};Vk=oi;ue.Utf8String=Vk;oi.NAME="UTF8String";var S2=class extends Jr{fromBuffer(e){this.valueBlock.value=He.Convert.ToUtf16String(e),this.valueBlock.valueHexView=He.BufferSourceConverter.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(He.Convert.FromUtf16String(e))}};S2.NAME="BmpStringValueBlock";var qk,_2=class extends S2{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}};qk=_2;ue.BmpString=qk;_2.NAME="BMPString";var A2=class extends Jr{fromBuffer(e){let t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let s=0;s<n.length;s+=4)n[s]=n[s+3],n[s+1]=n[s+2],n[s+2]=0,n[s+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){let t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let s=0;s<t;s++){let o=ga(e.charCodeAt(s),8),i=new Uint8Array(o);if(i.length>4)continue;let a=4-i.length;for(let c=i.length-1;c>=0;c--)n[s*4+c+a]=i[c]}this.valueBlock.value=e}};A2.NAME="UniversalStringValueBlock";var Hk,R2=class extends A2{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}};Hk=R2;ue.UniversalString=Hk;R2.NAME="UniversalString";var zk,I2=class extends Jr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}};zk=I2;ue.NumericString=zk;I2.NAME="NumericString";var $k,T2=class extends Jr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}};$k=T2;ue.PrintableString=$k;T2.NAME="PrintableString";var Gk,k2=class extends Jr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}};Gk=k2;ue.TeletexString=Gk;k2.NAME="TeletexString";var Wk,D2=class extends Jr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}};Wk=D2;ue.VideotexString=Wk;D2.NAME="VideotexString";var Yk,P2=class extends Jr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}};Yk=P2;ue.IA5String=Yk;P2.NAME="IA5String";var jk,C2=class extends Jr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}};jk=C2;ue.GraphicString=jk;C2.NAME="GraphicString";var Qk,Lp=class extends Jr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}};Qk=Lp;ue.VisibleString=Qk;Lp.NAME="VisibleString";var Xk,B2=class extends Jr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}};Xk=B2;ue.GeneralString=Xk;B2.NAME="GeneralString";var Jk,N2=class extends Jr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}};Jk=N2;ue.CharacterString=Jk;N2.NAME="CharacterString";var Zk,Op=class extends Lp{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let s=0;s<e.length;s++)this.valueBlock.valueHexView[s]=e.charCodeAt(s)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,He.BufferSourceConverter.toUint8Array(e)))}toBuffer(){let e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let s=0;s<e.length;s++)n[s]=e.charCodeAt(s);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){let n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}let s=parseInt(n[1],10);s>=50?this.year=1900+s:this.year=2e3+s,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){let t=new Array(7);return t[0]=ln(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=ln(this.month,2),t[2]=ln(this.day,2),t[3]=ln(this.hour,2),t[4]=ln(this.minute,2),t[5]=ln(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}};Zk=Op;ue.UTCTime=Zk;Op.NAME="UTCTime";var eD,L2=class extends Op{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond))}fromString(e){let t=!1,n="",s="",o=0,i,a=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{let f=new Number(e[e.length-1]);if(isNaN(f.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let f=1,h=n.indexOf("+"),d="";if(h===-1&&(h=n.indexOf("-"),f=-1),h!==-1){if(d=n.substring(h+1),n=n.substring(0,h),d.length!==2&&d.length!==4)throw new Error("Wrong input string for conversion");let p=parseInt(d.substring(0,2),10);if(isNaN(p.valueOf()))throw new Error("Wrong input string for conversion");if(a=f*p,d.length===4){if(p=parseInt(d.substring(2,4),10),isNaN(p.valueOf()))throw new Error("Wrong input string for conversion");c=f*p}}}let l=n.indexOf(".");if(l===-1&&(l=n.indexOf(",")),l!==-1){let f=new Number(`0${n.substring(l)}`);if(isNaN(f.valueOf()))throw new Error("Wrong input string for conversion");o=f.valueOf(),s=n.substring(0,l)}else s=n;switch(!0){case s.length===8:if(i=/(\d{4})(\d{2})(\d{2})/ig,l!==-1)throw new Error("Wrong input string for conversion");break;case s.length===10:if(i=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let f=60*o;this.minute=Math.floor(f),f=60*(f-this.minute),this.second=Math.floor(f),f=1e3*(f-this.second),this.millisecond=Math.floor(f)}break;case s.length===12:if(i=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let f=60*o;this.second=Math.floor(f),f=1e3*(f-this.second),this.millisecond=Math.floor(f)}break;case s.length===14:if(i=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let f=1e3*o;this.millisecond=Math.floor(f)}break;default:throw new Error("Wrong input string for conversion")}let u=i.exec(s);if(u===null)throw new Error("Wrong input string for conversion");for(let f=1;f<u.length;f++)switch(f){case 1:this.year=parseInt(u[f],10);break;case 2:this.month=parseInt(u[f],10);break;case 3:this.day=parseInt(u[f],10);break;case 4:this.hour=parseInt(u[f],10)+a;break;case 5:this.minute=parseInt(u[f],10)+c;break;case 6:this.second=parseInt(u[f],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){let f=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=f.getUTCFullYear(),this.month=f.getUTCMonth(),this.day=f.getUTCDay(),this.hour=f.getUTCHours(),this.minute=f.getUTCMinutes(),this.second=f.getUTCSeconds(),this.millisecond=f.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){let t=[];return t.push(ln(this.year,4)),t.push(ln(this.month,2)),t.push(ln(this.day,2)),t.push(ln(this.hour,2)),t.push(ln(this.minute,2)),t.push(ln(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(ln(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}};eD=L2;ue.GeneralizedTime=eD;L2.NAME="GeneralizedTime";var tD,O2=class extends oi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}};tD=O2;ue.DATE=tD;O2.NAME="DATE";var rD,K2=class extends oi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}};rD=K2;ue.TimeOfDay=rD;K2.NAME="TimeOfDay";var nD,M2=class extends oi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}};nD=M2;ue.DateTime=nD;M2.NAME="DateTime";var sD,U2=class extends oi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}};sD=U2;ue.Duration=sD;U2.NAME="Duration";var oD,F2=class extends oi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}};oD=F2;ue.TIME=oD;F2.NAME="TIME";var h6=(r,e)=>r<<e|r>>>32-e>>>0,_J=(r,e,t)=>r&e^~r&t,AJ=(r,e,t)=>r&e^r&t^e&t,Kp=new Uint32Array([1732584193,4023233417,2562383102,271733878,3285377520]),wa=new Uint32Array(80),p6=class extends ia{constructor(){super(64,20,8,!1),this.A=Kp[0]|0,this.B=Kp[1]|0,this.C=Kp[2]|0,this.D=Kp[3]|0,this.E=Kp[4]|0}get(){let{A:e,B:t,C:n,D:s,E:o}=this;return[e,t,n,s,o]}set(e,t,n,s,o){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=o|0}process(e,t){for(let c=0;c<16;c++,t+=4)wa[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)wa[c]=h6(wa[c-3]^wa[c-8]^wa[c-14]^wa[c-16],1);let{A:n,B:s,C:o,D:i,E:a}=this;for(let c=0;c<80;c++){let l,u;c<20?(l=_J(s,o,i),u=1518500249):c<40?(l=s^o^i,u=1859775393):c<60?(l=AJ(s,o,i),u=2400959708):(l=s^o^i,u=3395469782);let f=h6(n,5)+l+a+u+wa[c]|0;a=i,i=o,o=h6(s,30),s=n,n=f}n=n+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,this.set(n,s,o,i,a)}roundClean(){wa.fill(0)}destroy(){this.set(0,0,0,0,0),this.buffer.fill(0)}},aD=fu(()=>new p6);var cD=(r,e)=>{let t=R(e.toString(16).padStart(16,"0"),"base16"),n=new Uint8Array(r.length+t.length);return n.set(r,0),n.set(t,r.length),n};function lD(r){if(r.type!=="signed")throw new Error("expected signed message type");if(r.sequenceNumber==null)throw Error("missing seqno field");return cD(r.from.toBytes(),r.sequenceNumber)}async function uD(r){return e6.encode(r.data)}var H2=class{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){let t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){let t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{let t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,s){return this.readAtomically(()=>{let o=0,i=0,a=this.peekChar();if(a===void 0)return;let c=a==="0",l=2**(8*s)-1;for(;;){let u=this.readAtomically(()=>{let f=this.readChar();if(f===void 0)return;let h=Number.parseInt(f,e);if(!Number.isNaN(h))return h});if(u===void 0)break;if(o*=e,o+=u,o>l||(i+=1,t!==void 0&&i>t))return}if(i!==0)return!n&&c&&i>1?void 0:o})}readIPv4Addr(){return this.readAtomically(()=>{let e=new Uint8Array(4);for(let t=0;t<e.length;t++){let n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){let e=t=>{for(let n=0;n<t.length/2;n++){let s=n*2;if(n<t.length-3){let i=this.readSeparator(":",n,()=>this.readIPv4Addr());if(i!==void 0)return t[s]=i[0],t[s+1]=i[1],t[s+2]=i[2],t[s+3]=i[3],[s+4,!0]}let o=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(o===void 0)return[s,!1];t[s]=o>>8,t[s+1]=o&255}return[t.length,!1]};return this.readAtomically(()=>{let t=new Uint8Array(16),[n,s]=e(t);if(n===16)return t;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;let o=new Uint8Array(14),i=16-(n+2),[a]=e(o.subarray(0,i));return t.set(o.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};var fD=45,RJ=15,Ru=new H2;function d6(r){if(!(r.length>RJ))return Ru.new(r).parseWith(()=>Ru.readIPv4Addr())}function m6(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>fD))return Ru.new(r).parseWith(()=>Ru.readIPv6Addr())}function z2(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>fD))return Ru.new(r).parseWith(()=>Ru.readIPAddr())}var nve=parseInt("0xFFFF",16),sve=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function $2(r){return!!d6(r)}function G2(r){return!!m6(r)}function Iu(r){return!!z2(r)}var dD=$2,PJ=G2,y6=function(r){let e=0;if(r=r.toString().trim(),dD(r)){let t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(PJ(r)){let t=r.split(":",8),n;for(n=0;n<t.length;n++){let o=dD(t[n]),i;o&&(i=y6(t[n]),t[n]=T(i.slice(0,2),"base16")),i!=null&&++n<8&&t.splice(n,0,T(i.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);let o=[n,1];for(n=9-t.length;n>0;n--)o.push("0");t.splice.apply(t,o)}let s=new Uint8Array(e+16);for(n=0;n<t.length;n++){let o=parseInt(t[n],16);s[e++]=o>>8&255,s[e++]=o&255}return s}throw new Error("invalid ip address")},mD=function(r,e=0,t){e=~~e,t=t??r.length-e;let n=new DataView(r.buffer);if(t===4){let s=[];for(let o=0;o<t;o++)s.push(r[e+o]);return s.join(".")}if(t===16){let s=[];for(let o=0;o<t;o+=2)s.push(n.getUint16(e+o).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""};var Tu={},g6={},BJ=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,-1,"ip6zone"],[43,8,"ipcidr"],[53,-1,"dns",!0],[54,-1,"dns4",!0],[55,-1,"dns6",!0],[56,-1,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,-1,"unix",!1,!0],[421,-1,"ipfs"],[421,-1,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,-1,"garlic64"],[448,0,"tls"],[449,-1,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,-1,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,-1,"memory"]];BJ.forEach(r=>{let e=NJ(...r);g6[e.code]=e,Tu[e.name]=e});function NJ(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function ve(r){if(typeof r=="number"){if(g6[r]!=null)return g6[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(Tu[r]!=null)return Tu[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}var Vve=ve("ip4"),qve=ve("ip6"),Hve=ve("ipcidr");function Mp(r,e){switch(ve(r).code){case 4:case 41:return OJ(e);case 42:return bD(e);case 6:case 273:case 33:case 132:return ED(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return bD(e);case 421:return FJ(e);case 444:return wD(e);case 445:return wD(e);case 466:return UJ(e);default:return T(e,"base16")}}function w6(r,e){switch(ve(r).code){case 4:return yD(e);case 41:return yD(e);case 42:return gD(e);case 6:case 273:case 33:case 132:return E6(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return gD(e);case 421:return KJ(e);case 444:return VJ(e);case 445:return qJ(e);case 466:return MJ(e);default:return R(e,"base16")}}var b6=Object.values(Ln).map(r=>r.decoder),LJ=function(){let r=b6[0].or(b6[1]);return b6.slice(2).forEach(e=>r=r.or(e)),r}();function yD(r){if(!Iu(r))throw new Error("invalid ip address");return y6(r)}function OJ(r){let e=mD(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!Iu(e))throw new Error("invalid ip address");return e}function E6(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function ED(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function gD(r){let e=R(r),t=Uint8Array.from(Zt(e.length));return le([t,e],t.length+e.length)}function bD(r){let e=gn(r);if(r=r.slice(Jt(e)),r.length!==e)throw new Error("inconsistent lengths");return T(r)}function KJ(r){let e;r[0]==="Q"||r[0]==="1"?e=qs(Fe.decode(`z${r}`)).bytes:e=Ve.parse(r).multihash.bytes;let t=Uint8Array.from(Zt(e.length));return le([t,e],t.length+e.length)}function MJ(r){let e=LJ.decode(r),t=Uint8Array.from(Zt(e.length));return le([t,e],t.length+e.length)}function UJ(r){let e=gn(r),t=r.slice(Jt(e));if(t.length!==e)throw new Error("inconsistent lengths");return"u"+T(t,"base64url")}function FJ(r){let e=gn(r),t=r.slice(Jt(e));if(t.length!==e)throw new Error("inconsistent lengths");return T(t,"base58btc")}function VJ(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);let t=nr.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let s=E6(n);return le([t,s],t.length+s.length)}function qJ(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);let t=nr.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let s=E6(n);return le([t,s],t.length+s.length)}function wD(r){let e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=T(e,"base32"),s=ED(t);return`${n}:${s}`}var W2;(function(r){r[r.ip4=4]="ip4",r[r.ip6=41]="ip6"})(W2||(W2={}));function vD(r){for(let e of r.tuples())switch(e[0]){case W2.ip4:case W2.ip6:return Mp(e[0],e[1]);default:break}return null}var ku=class{entries=new Map;validityMs;constructor(e){this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){return this.entries.has(e)?!0:(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){let e=Date.now();for(let[t,n]of this.entries.entries())if(n.validUntilMs<e)this.entries.delete(t);else break}has(e){return this.entries.has(e)}get(e){let t=this.entries.get(e);return t!=null&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}};var _n;(function(r){r[r.started=0]="started",r[r.stopped=1]="stopped"})(_n||(_n={}));var v6=class extends je{globalSignaturePolicy;multicodecs=[g8,y8];publishConfig;dataTransform;peers=new Set;streamsInbound=new Map;streamsOutbound=new Map;outboundInflightQueue=Tt({objectMode:!0});direct=new Set;floodsubPeers=new Set;seenCache;acceptFromWhitelist=new Map;topics=new Map;subscriptions=new Set;mesh=new Map;fanout=new Map;fanoutLastpub=new Map;gossip=new Map;control=new Map;peerhave=new Map;iasked=new Map;backoff=new Map;outbound=new Map;msgIdFn;fastMsgIdFn;msgIdToStrFn;fastMsgIdCache;publishedMessageIds;mcache;score;topicValidators=new Map;log;heartbeatTicks=0;gossipTracer;components;directPeerInitial=null;static multicodec=g8;opts;decodeRpcLimits;metrics;status={code:_n.stopped};maxInboundStreams;maxOutboundStreams;allowedTopics;heartbeatTimer=null;constructor(e,t={}){super();let n={fallbackToFloodsub:!0,floodPublish:!0,doPX:!1,directPeers:[],D:6,Dlo:4,Dhi:12,Dscore:4,Dout:2,Dlazy:6,heartbeatInterval:1e3,fanoutTTL:6e4,mcacheLength:5,mcacheGossip:3,seenTTL:12e4,gossipsubIWantFollowupMs:3e3,prunePeers:16,pruneBackoff:6e4,unsubcribeBackoff:1e4,graftFloodThreshold:1e4,opportunisticGraftPeers:2,opportunisticGraftTicks:60,directConnectTicks:300,...t,scoreParams:hR(t.scoreParams),scoreThresholds:dR(t.scoreThresholds)};if(this.components=e,this.decodeRpcLimits=n.decodeRpcLimits??sR,this.globalSignaturePolicy=n.globalSignaturePolicy??ic,n.fallbackToFloodsub&&this.multicodecs.push(m8),this.log=e.logger.forComponent(n.debugName??"libp2p:gossipsub"),this.opts=n,this.direct=new Set(n.directPeers.map(s=>s.id.toString())),this.seenCache=new ku({validityMs:n.seenTTL}),this.publishedMessageIds=new ku({validityMs:n.seenTTL}),t.msgIdFn!=null)this.msgIdFn=t.msgIdFn;else switch(this.globalSignaturePolicy){case ic:this.msgIdFn=lD;break;case Ul:this.msgIdFn=uD;break;default:throw new Error(`Invalid globalSignaturePolicy: ${this.globalSignaturePolicy}`)}if(t.fastMsgIdFn!=null&&(this.fastMsgIdFn=t.fastMsgIdFn,this.fastMsgIdCache=new ku({validityMs:n.seenTTL})),this.msgIdToStrFn=t.msgIdToStrFn??hk,this.mcache=t.messageCache??new c1(n.mcacheGossip,n.mcacheLength,this.msgIdToStrFn),t.dataTransform!=null&&(this.dataTransform=t.dataTransform),t.metricsRegister!=null){if(t.metricsTopicStrToLabel==null)throw Error("Must set metricsTopicStrToLabel with metrics");let s=Math.max(...Object.values(n.scoreParams.topics).map(i=>i.meshMessageDeliveriesWindow),1e3),o=fR(t.metricsRegister,t.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:n.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:s/1e3});o.mcacheSize.addCollect(()=>{this.onScrapeMetrics(o)});for(let i of this.multicodecs)o.protocolsEnabled.set({protocol:i},1);this.metrics=o}else this.metrics=null;this.gossipTracer=new m1(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new h1(this.opts.scoreParams,this.metrics,this.components.logger,{scoreCacheValidityMs:n.heartbeatInterval}),this.maxInboundStreams=t.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams,this.allowedTopics=n.allowedTopics!=null?new Set(n.allowedTopics):null}getPeers(){return[...this.peers.keys()].map(e=>Ce(e))}isStarted(){return this.status.code===_n.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=await o6(this.globalSignaturePolicy,this.components.peerId),this.outboundInflightQueue=Tt({objectMode:!0}),lt(this.outboundInflightQueue,async o=>{for await(let{peerId:i,connection:a}of o)await this.createOutboundStream(i,a)}).catch(o=>{this.log.error("outbound inflight queue error",o)}),await Promise.all(this.opts.directPeers.map(async o=>{await this.components.peerStore.merge(o.id,{multiaddrs:o.addrs})}));let e=this.components.registrar;await Promise.all(this.multicodecs.map(async o=>e.handle(o,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams})));let t={onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this)},n=await Promise.all(this.multicodecs.map(async o=>e.register(o,t))),s=setTimeout(this.runHeartbeat,100);this.status={code:_n.started,registrarTopologyIds:n,heartbeatTimeout:s,hearbeatStartMs:Date.now()+100},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async o=>this.connect(o)))}).catch(o=>{this.log(o)})},1e3),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==_n.started)return;let{registrarTopologyIds:e}=this.status;this.status={code:_n.stopped};let t=this.components.registrar;await Promise.all(this.multicodecs.map(async s=>t.unhandle(s))),e.forEach(s=>{t.unregister(s)}),this.outboundInflightQueue.end();let n=[];for(let s of this.streamsOutbound.values())n.push(s.close());this.streamsOutbound.clear();for(let s of this.streamsInbound.values())n.push(s.close());this.streamsInbound.clear(),await Promise.all(n),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer!=null&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache!=null&&this.fastMsgIdCache.clear(),this.directPeerInitial!=null&&clearTimeout(this.directPeerInitial),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:e,connection:t}){if(!this.isStarted())return;let n=t.remotePeer;this.addPeer(n,t.direction,t.remoteAddr),this.createInboundStream(n,e),this.outboundInflightQueue.push({peerId:n,connection:t})}onPeerConnected(e,t){this.metrics?.newConnectionCount.inc({status:t.status}),!(!this.isStarted()||t.status!=="open")&&(this.addPeer(e,t.direction,t.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:t}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,t){if(!this.isStarted())return;let n=e.toString();if(this.peers.has(n)&&!this.streamsOutbound.has(n))try{let s=new p1(await t.newStream(this.multicodecs),i=>{this.log.error("outbound pipe error",i)},{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(n,s);let o=s.protocol;o===m8&&this.floodsubPeers.add(n),this.metrics?.peersPerProtocol.inc({protocol:o},1),this.subscriptions.size>0&&(this.log("send subscriptions to",n),this.sendSubscriptions(n,Array.from(this.subscriptions),!0))}catch(s){this.log.error("createOutboundStream error",s)}}createInboundStream(e,t){if(!this.isStarted())return;let n=e.toString();if(!this.peers.has(n))return;let s=this.streamsInbound.get(n);s!==void 0&&(this.log("replacing existing inbound steam %s",n),s.close().catch(i=>{this.log.error(i)})),this.log("create inbound stream %s",n);let o=new d1(t,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(n,o),this.pipePeerReadStream(e,o.source).catch(i=>{this.log(i)})}addPeer(e,t,n){let s=e.toString();if(!this.peers.has(s)){this.log("new peer %p",e),this.peers.add(s),this.score.addPeer(s);let o=vD(n);o!==null?this.score.addIP(s,o):this.log("Added peer has no IP in current address %s %s",s,n.toString()),this.outbound.has(s)||this.outbound.set(s,t==="outbound")}}removePeer(e){let t=e.toString();if(!this.peers.has(t))return;this.log("delete peer %p",e),this.peers.delete(t);let n=this.streamsOutbound.get(t),s=this.streamsInbound.get(t);n!=null&&this.metrics?.peersPerProtocol.inc({protocol:n.protocol},-1),n?.close().catch(o=>{this.log.error(o)}),s?.close().catch(o=>{this.log.error(o)}),this.streamsOutbound.delete(t),this.streamsInbound.delete(t);for(let o of this.topics.values())o.delete(t);for(let[o,i]of this.mesh)i.delete(t)&&this.metrics?.onRemoveFromMesh(o,vs.Dc,1);for(let o of this.fanout.values())o.delete(t);this.floodsubPeers.delete(t),this.gossip.delete(t),this.control.delete(t),this.outbound.delete(t),this.score.removePeer(t),this.acceptFromWhitelist.delete(t)}get started(){return this.status.code===_n.started}getMeshPeers(e){let t=this.mesh.get(e);return t!=null?Array.from(t):[]}getSubscribers(e){let t=this.topics.get(e);return(t!=null?Array.from(t):[]).map(n=>Ce(n))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,t){try{await lt(t,async n=>{for await(let s of n)try{let o=s.subarray(),i=oR(o,this.decodeRpcLimits);if(this.metrics?.onRpcRecv(i,o.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(e,i)}catch(a){this.metrics?.onRpcRecvError(),this.log(a)}else this.handleReceivedRpc(e,i).catch(a=>{this.metrics?.onRpcRecvError(),this.log(a)})}catch(o){this.metrics?.onRpcDataError(),this.log(o)}})}catch(n){this.metrics?.onPeerReadStreamError(),this.handlePeerReadStreamError(n,e)}}handlePeerReadStreamError(e,t){this.log.error(e),this.onPeerDisconnected(t)}async handleReceivedRpc(e,t){if(!this.acceptFrom(e.toString())){this.log("received message from unacceptable peer %p",e),this.metrics?.rpcRecvNotAccepted.inc();return}let n=t.subscriptions!=null?t.subscriptions.length:0,s=t.messages!=null?t.messages.length:0,o=0,i=0,a=0,c=0;if(t.control!=null&&(t.control.ihave!=null&&(o=t.control.ihave.length),t.control.iwant!=null&&(i=t.control.iwant.length),t.control.graft!=null&&(a=t.control.graft.length),t.control.prune!=null&&(c=t.control.prune.length)),this.log(`rpc.from ${e.toString()} subscriptions ${n} messages ${s} ihave ${o} iwant ${i} graft ${a} prune ${c}`),t.subscriptions!=null&&t.subscriptions.length>0){let l=[];t.subscriptions.forEach(u=>{let f=u.topic,h=u.subscribe===!0;if(f!=null){if(this.allowedTopics!=null&&!this.allowedTopics.has(f))return;this.handleReceivedSubscription(e,f,h),l.push({topic:f,subscribe:h})}}),this.safeDispatchEvent("subscription-change",{detail:{peerId:e,subscriptions:l}})}if(t.messages!=null)for(let l of t.messages){if(this.allowedTopics!=null&&!this.allowedTopics.has(l.topic))continue;let u=this.handleReceivedMessage(e,l).catch(f=>{this.metrics?.onMsgRecvError(l.topic),this.log(f)});this.opts.awaitRpcMessageHandler&&await u}t.control!=null&&await this.handleControlMessage(e.toString(),t.control)}handleReceivedSubscription(e,t,n){this.log("subscription update from %p topic %s",e,t);let s=this.topics.get(t);s==null&&(s=new Set,this.topics.set(t,s)),n?s.add(e.toString()):s.delete(e.toString())}async handleReceivedMessage(e,t){this.metrics?.onMsgRecvPreValidation(t.topic);let n=await this.validateReceivedMessage(e,t);this.metrics?.onPrevalidationResult(t.topic,n.code);let s=n.code;switch(s){case Vr.duplicate:this.score.duplicateMessage(e.toString(),n.msgIdStr,t.topic),this.gossipTracer.deliverMessage(n.msgIdStr,!0),this.mcache.observeDuplicate(n.msgIdStr,e.toString());return;case Vr.invalid:if(n.msgIdStr!=null){let o=n.msgIdStr;this.score.rejectMessage(e.toString(),o,t.topic,n.reason),this.gossipTracer.rejectMessage(o,n.reason)}else this.score.rejectInvalidMessage(e.toString(),t.topic);this.metrics?.onMsgRecvInvalid(t.topic,n);return;case Vr.valid:this.score.validateMessage(n.messageId.msgIdStr),this.gossipTracer.deliverMessage(n.messageId.msgIdStr),this.mcache.put(n.messageId,t,!this.opts.asyncValidation),this.subscriptions.has(t.topic)&&(!this.components.peerId.equals(e)||this.opts.emitSelf)&&(super.dispatchEvent(new Dt("gossipsub:message",{detail:{propagationSource:e,msgId:n.messageId.msgIdStr,msg:n.msg}})),super.dispatchEvent(new Dt("message",{detail:n.msg}))),this.opts.asyncValidation||this.forwardMessage(n.messageId.msgIdStr,t,e.toString());break;default:throw new Error(`Invalid validation result: ${s}`)}}async validateReceivedMessage(e,t){let n=this.fastMsgIdFn?.(t),s=n!==void 0?this.fastMsgIdCache?.get(n):void 0;if(s!=null)return{code:Vr.duplicate,msgIdStr:s};let o=await fk(this.globalSignaturePolicy,t);if(!o.valid)return{code:Vr.invalid,reason:Gr.Error,error:o.error};let i=o.message;try{this.dataTransform!=null&&(i.data=this.dataTransform.inboundTransform(t.topic,i.data))}catch(f){return this.log("Invalid message, transform failed",f),{code:Vr.invalid,reason:Gr.Error,error:Fr.TransformFailed}}let a=await this.msgIdFn(i),c=this.msgIdToStrFn(a),l={msgId:a,msgIdStr:c};if(n!==void 0&&this.fastMsgIdCache!=null&&this.fastMsgIdCache.put(n,c)&&this.metrics?.fastMsgIdCacheCollision.inc(),this.seenCache.has(c))return{code:Vr.duplicate,msgIdStr:c};this.seenCache.put(c);let u=this.topicValidators.get(t.topic);if(u!=null){let f;try{f=await u(e,i)}catch(h){let d=h.code;d===iA&&(f=zr.Ignore),d===oA?f=zr.Reject:f=zr.Ignore}if(f!==zr.Accept)return{code:Vr.invalid,reason:C8(f),msgIdStr:c}}return{code:Vr.valid,messageId:l,msg:i}}getScore(e){return this.score.score(e)}sendSubscriptions(e,t,n){this.sendRpc(e,{subscriptions:t.map(s=>({topic:s,subscribe:n}))})}async handleControlMessage(e,t){if(t===void 0)return;let n=t.ihave!=null?this.handleIHave(e,t.ihave):[],s=t.iwant!=null?this.handleIWant(e,t.iwant):[],o=t.graft!=null?await this.handleGraft(e,t.graft):[];if(t.prune!=null&&await this.handlePrune(e,t.prune),n.length===0&&s.length===0&&o.length===0)return;let i=this.sendRpc(e,{messages:s,control:{iwant:n,prune:o}}),a=n[0]?.messageIDs;a!=null&&(i?this.gossipTracer.addPromise(e,a):this.metrics?.iwantPromiseUntracked.inc(1))}acceptFrom(e){if(this.direct.has(e))return!0;let t=Date.now(),n=this.acceptFromWhitelist.get(e);if(n!=null&&n.messagesAccepted<128&&n.acceptUntil>=t)return n.messagesAccepted+=1,!0;let s=this.score.score(e);return s>=0?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:t+1e3}):this.acceptFromWhitelist.delete(e),s>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,t){if(t.length===0)return[];let n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,n),this.metrics?.ihaveRcvIgnored.inc({reason:ru.LowScore}),[];let s=(this.peerhave.get(e)??0)+1;if(this.peerhave.set(e,s),s>10)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,s),this.metrics?.ihaveRcvIgnored.inc({reason:ru.MaxIhave}),[];let o=this.iasked.get(e)??0;if(o>=5e3)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,o),this.metrics?.ihaveRcvIgnored.inc({reason:ru.MaxIasked}),[];let i=new Map;if(t.forEach(({topicID:l,messageIDs:u})=>{if(l==null||u==null||!this.mesh.has(l))return;let f=0;u.forEach(h=>{let d=this.msgIdToStrFn(h);this.seenCache.has(d)||(i.set(d,h),f++)}),this.metrics?.onIhaveRcv(l,u.length,f)}),i.size===0)return[];let a=i.size;a+o>5e3&&(a=5e3-o),this.log("IHAVE: Asking for %d out of %d messages from %s",a,i.size,e);let c=Array.from(i.values());return so(c),c=c.slice(0,a),this.iasked.set(e,o+a),[{messageIDs:c}]}handleIWant(e,t){if(t.length===0)return[];let n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,n),[];let s=new Map,o=new Map,i=0;return t.forEach(({messageIDs:a})=>{a?.forEach(c=>{let l=this.msgIdToStrFn(c),u=this.mcache.getWithIWantCount(l,e);if(u==null){i++;return}if(o.set(u.msg.topic,1+(o.get(u.msg.topic)??0)),u.count>3){this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,c);return}s.set(l,u.msg)})}),this.metrics?.onIwantRcv(o,i),s.size===0?(this.log("IWANT: Could not provide any wanted messages to %s",e),[]):(this.log("IWANT: Sending %d messages to %s",s.size,e),Array.from(s.values()))}async handleGraft(e,t){let n=[],s=this.score.score(e),o=Date.now(),i=this.opts.doPX;if(t.forEach(({topicID:c})=>{if(c==null)return;let l=this.mesh.get(c);if(l==null){i=!1;return}if(l.has(e))return;if(this.direct.has(e)){this.log("GRAFT: ignoring request from direct peer %s",e),n.push(c),i=!1;return}let u=this.backoff.get(c)?.get(e);if(typeof u=="number"&&o<u){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,tu.GraftBackoff),i=!1;let f=u+this.opts.graftFloodThreshold-this.opts.pruneBackoff;o<f&&this.score.addPenalty(e,1,tu.GraftBackoff),this.addBackoff(e,c),n.push(c);return}if(s<0){this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,s,c),n.push(c),i=!1,this.addBackoff(e,c);return}if(l.size>=this.opts.Dhi&&!(this.outbound.get(e)??!1)){n.push(c),this.addBackoff(e,c);return}this.log("GRAFT: Add mesh link from %s in %s",e,c),this.score.graft(e,c),l.add(e),this.metrics?.onAddToMesh(c,Wr.Subscribed,1)}),n.length===0)return[];let a=!1;return Promise.all(n.map(async c=>this.makePrune(e,c,i,a)))}async handlePrune(e,t){let n=this.score.score(e);for(let{topicID:s,backoff:o,peers:i}of t){if(s==null)continue;let a=this.mesh.get(s);if(a==null)return;if(this.log("PRUNE: Remove mesh link to %s in %s",e,s),this.score.prune(e,s),a.has(e)&&(a.delete(e),this.metrics?.onRemoveFromMesh(s,vs.Prune,1)),typeof o=="number"&&o>0?this.doAddBackoff(e,s,o*1e3):this.addBackoff(e,s),i!=null&&i.length>0){if(n<this.opts.scoreThresholds.acceptPXThreshold){this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,n,s);continue}await this.pxConnect(i)}}}addBackoff(e,t){this.doAddBackoff(e,t,this.opts.pruneBackoff)}doAddBackoff(e,t,n){let s=this.backoff.get(t);s==null&&(s=new Map,this.backoff.set(t,s));let o=Date.now()+n;(s.get(e)??0)<o&&s.set(e,o)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((e,t)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",t,e),this.score.addPenalty(t,e,tu.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%15!==0)return;let e=Date.now();this.backoff.forEach((t,n)=>{t.forEach((s,o)=>{s+1*this.opts.heartbeatInterval<e&&t.delete(o)}),t.size===0&&this.backoff.delete(n)})}async directConnect(){let e=[];this.direct.forEach(t=>{this.streamsOutbound.has(t)||e.push(t)}),await Promise.all(e.map(async t=>this.connect(t)))}async pxConnect(e){e.length>this.opts.prunePeers&&(so(e),e=e.slice(0,this.opts.prunePeers));let t=[];await Promise.all(e.map(async n=>{if(n.peerID==null)return;let s=dt(n.peerID),o=s.toString();if(!this.peers.has(o)){if(n.signedPeerRecord==null){t.push(o);return}try{if(!await this.components.peerStore.consumePeerRecord(n.signedPeerRecord,s)){this.log("bogus peer record obtained through px: could not add peer record to address book");return}t.push(o)}catch{this.log("bogus peer record obtained through px: invalid signature or not a peer record")}}})),t.length!==0&&await Promise.all(t.map(async n=>this.connect(n)))}async connect(e){this.log("Initiating connection with %s",e);let t=Ce(e),n=await this.components.connectionManager.openConnection(t);for(let s of this.multicodecs)for(let o of this.components.registrar.getTopologies(s))o.onConnect?.(t,n)}subscribe(e){if(this.status.code!==_n.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(let t of this.peers.keys())this.sendSubscriptions(t,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==_n.started)throw new Error("Pubsub is not started");let t=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,t),t)for(let n of this.peers.keys())this.sendSubscriptions(n,[e],!1);this.leave(e)}join(e){if(this.status.code!==_n.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),this.metrics?.onJoin(e);let t=new Set,n=this.backoff.get(e),s=this.fanout.get(e);if(s!=null&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),s.forEach(o=>{!this.direct.has(o)&&this.score.score(o)>=0&&(n==null||!n.has(o))&&t.add(o)}),this.metrics?.onAddToMesh(e,Wr.Fanout,t.size)),t.size<this.opts.D){let o=t.size;this.getRandomGossipPeers(e,this.opts.D,a=>!t.has(a)&&!this.direct.has(a)&&this.score.score(a)>=0&&(n==null||!n.has(a))).forEach(a=>{t.add(a)}),this.metrics?.onAddToMesh(e,Wr.Random,t.size-o)}this.mesh.set(e,t),t.forEach(o=>{this.log("JOIN: Add mesh link to %s in %s",o,e),this.sendGraft(o,e)})}leave(e){if(this.status.code!==_n.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),this.metrics?.onLeave(e);let t=this.mesh.get(e);t!=null&&(Promise.all(Array.from(t).map(async n=>{this.log("LEAVE: Remove mesh link to %s in %s",n,e),await this.sendPrune(n,e)})).catch(n=>{this.log("Error sending prunes to mesh peers",n)}),this.mesh.delete(e))}selectPeersToForward(e,t,n){let s=new Set,o=this.topics.get(e);o!=null&&(this.direct.forEach(a=>{o.has(a)&&t!==a&&!(n?.has(a)??!1)&&s.add(a)}),this.floodsubPeers.forEach(a=>{o.has(a)&&t!==a&&!(n?.has(a)??!1)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold&&s.add(a)}));let i=this.mesh.get(e);return i!=null&&i.size>0&&i.forEach(a=>{t!==a&&!(n?.has(a)??!1)&&s.add(a)}),s}selectPeersToPublish(e){let t=new Set,n={direct:0,floodsub:0,mesh:0,fanout:0},s=this.topics.get(e);if(s!=null)if(this.opts.floodPublish)s.forEach(o=>{this.direct.has(o)?(t.add(o),n.direct++):this.score.score(o)>=this.opts.scoreThresholds.publishThreshold&&(t.add(o),n.floodsub++)});else{this.direct.forEach(i=>{s.has(i)&&(t.add(i),n.direct++)}),this.floodsubPeers.forEach(i=>{s.has(i)&&this.score.score(i)>=this.opts.scoreThresholds.publishThreshold&&(t.add(i),n.floodsub++)});let o=this.mesh.get(e);if(o!=null&&o.size>0)o.forEach(i=>{t.add(i),n.mesh++});else{let i=this.fanout.get(e);if(i!=null&&i.size>0)i.forEach(a=>{t.add(a),n.fanout++});else{let a=this.getRandomGossipPeers(e,this.opts.D,c=>this.score.score(c)>=this.opts.scoreThresholds.publishThreshold);a.size>0&&(this.fanout.set(e,a),a.forEach(c=>{t.add(c),n.fanout++}))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:t,tosendCount:n}}forwardMessage(e,t,n,s){n!=null&&this.score.deliverMessage(n,e,t.topic);let o=this.selectPeersToForward(t.topic,n,s);o.forEach(i=>{this.sendRpc(i,{messages:[t]})}),this.metrics?.onForwardMsg(t.topic,o.size)}async publish(e,t,n){let s=Date.now(),o=this.dataTransform!=null?this.dataTransform.outboundTransform(e,t):t;if(this.publishConfig==null)throw Error("PublishError.Uninitialized");let{raw:i,msg:a}=await uk(this.publishConfig,e,t,o),c=await this.msgIdFn(a),l=this.msgIdToStrFn(c),u=n?.ignoreDuplicatePublishError??this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(l)){if(u)return this.metrics?.onPublishDuplicateMsg(e),{recipients:[]};throw Error("PublishError.Duplicate")}let{tosend:f,tosendCount:h}=this.selectPeersToPublish(e),d=this.opts.emitSelf&&this.subscriptions.has(e),p=n?.allowPublishToZeroPeers??this.opts.allowPublishToZeroPeers;if(f.size===0&&!p&&!d)throw Error("PublishError.InsufficientPeers");this.seenCache.put(l),this.mcache.put({msgId:c,msgIdStr:l},i,!0),this.publishedMessageIds.put(l);for(let y of f)this.sendRpc(y,{messages:[i]})||f.delete(y);let m=Date.now()-s;return this.metrics?.onPublishMsg(e,h,f.size,i.data!=null?i.data.length:0,m),d&&(f.add(this.components.peerId.toString()),super.dispatchEvent(new Dt("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:l,msg:a}})),super.dispatchEvent(new Dt("message",{detail:a}))),{recipients:Array.from(f.values()).map(y=>Ce(y))}}reportMessageValidationResult(e,t,n){let s;if(n===zr.Accept){if(s=this.mcache.validate(e),s!=null){let{message:i,originatingPeers:a}=s;this.score.deliverMessage(t,e,i.topic),this.forwardMessage(e,s.message,t,a)}}else if(s=this.mcache.remove(e),s!=null){let i=C8(n),{message:a,originatingPeers:c}=s;this.score.rejectMessage(t,e,a.topic,i);for(let l of c)this.score.rejectMessage(l,e,a.topic,i)}let o=this.score.messageFirstSeenTimestampMs(e);this.metrics?.onReportValidation(s,n,o)}sendGraft(e,t){let n=[{topicID:t}];this.sendRpc(e,{control:{graft:n}})}async sendPrune(e,t){let s=[await this.makePrune(e,t,this.opts.doPX,!0)];this.sendRpc(e,{control:{prune:s}})}sendRpc(e,t){let n=this.streamsOutbound.get(e);if(n==null)return this.log(`Cannot send RPC to ${e} as there is no open stream to it available`),!1;let s=this.control.get(e);s!=null&&(this.piggybackControl(e,t,s),this.control.delete(e));let o=this.gossip.get(e);o!=null&&(this.piggybackGossip(e,t,o),this.gossip.delete(e));let i=sp.encode(t).finish();try{n.push(i)}catch(a){return this.log.error(`Cannot send rpc to ${e}`,a),s!=null&&this.control.set(e,s),o!=null&&this.gossip.set(e,o),!1}return this.metrics?.onRpcSent(t,i.length),!0}piggybackControl(e,t,n){if(n.graft!=null){t.control==null&&(t.control={}),t.control.graft==null&&(t.control.graft=[]);for(let s of n.graft)s.topicID!=null&&(this.mesh.get(s.topicID)?.has(e)??!1)&&t.control.graft.push(s)}if(n.prune!=null){t.control==null&&(t.control={}),t.control.prune==null&&(t.control.prune=[]);for(let s of n.prune)s.topicID!=null&&!(this.mesh.get(s.topicID)?.has(e)??!1)&&t.control.prune.push(s)}}piggybackGossip(e,t,n){t.control==null&&(t.control={}),t.control.ihave=n}async sendGraftPrune(e,t,n){let s=this.opts.doPX,o=!1;for(let[i,a]of e){let c=a.map(f=>({topicID:f})),l=[],u=t.get(i);u!=null&&(l=await Promise.all(u.map(async f=>this.makePrune(i,f,s&&!(n.get(i)??!1),o))),t.delete(i)),this.sendRpc(i,{control:{graft:c,prune:l}})}for(let[i,a]of t){let c=await Promise.all(a.map(async l=>this.makePrune(i,l,s&&!(n.get(i)??!1),o)));this.sendRpc(i,{control:{prune:c}})}}emitGossip(e){let t=this.mcache.getGossipIDs(new Set(e.keys()));for(let[n,s]of e)this.doEmitGossip(n,s,t.get(n)??[])}doEmitGossip(e,t,n){if(n.length===0||(so(n),n.length>5e3&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",n.length),t.size===0))return;let s=this.opts.Dlazy,o=.25*t.size,i=t;o>s&&(s=o),s>i.size?s=i.size:i=so(Array.from(i)).slice(0,s),i.forEach(a=>{let c=n;n.length>5e3&&(c=so(c.slice()).slice(0,5e3)),this.pushGossip(a,{topicID:e,messageIDs:c})})}flush(){for(let[e,t]of this.gossip.entries())this.gossip.delete(e),this.sendRpc(e,{control:{ihave:t}});for(let[e,t]of this.control.entries())this.control.delete(e),this.sendRpc(e,{control:{graft:t.graft,prune:t.prune}})}pushGossip(e,t){this.log("Add gossip to %s",e);let n=this.gossip.get(e)??[];this.gossip.set(e,n.concat(t))}async makePrune(e,t,n,s){if(this.score.prune(e,t),this.streamsOutbound.get(e)?.protocol===y8)return{topicID:t,peers:[]};let o=s?this.opts.unsubcribeBackoff:this.opts.pruneBackoff,i=o/1e3;if(this.doAddBackoff(e,t,o),!n)return{topicID:t,peers:[],backoff:i};let a=this.getRandomGossipPeers(t,this.opts.prunePeers,l=>l!==e&&this.score.score(l)>=0),c=await Promise.all(Array.from(a).map(async l=>{let u=Ce(l),f;try{f=await this.components.peerStore.get(u)}catch(h){if(h.code!=="ERR_NOT_FOUND")throw h}return{peerID:u.toBytes(),signedPeerRecord:f?.peerRecordEnvelope}}));return{topicID:t,peers:c,backoff:i}}runHeartbeat=()=>{let e=this.metrics?.heartbeatDuration.startTimer();this.heartbeat().catch(t=>{this.log("Error running heartbeat",t)}).finally(()=>{if(e?.(),this.status.code===_n.started){clearTimeout(this.status.heartbeatTimeout);let t=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;t<this.opts.heartbeatInterval*.25&&(t+=this.opts.heartbeatInterval,this.metrics?.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,t)}})};async heartbeat(){let{D:e,Dlo:t,Dhi:n,Dscore:s,Dout:o,fanoutTTL:i}=this.opts;this.heartbeatTicks++;let a=new Map,c=p=>{let m=a.get(p);return m===void 0&&(m=this.score.score(p),a.set(p,m)),m},l=new Map,u=new Map,f=new Map;this.clearBackoff(),this.peerhave.clear(),this.metrics?.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),this.fastMsgIdCache?.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();let h=new Map;this.mesh.forEach((p,m)=>{let y=this.topics.get(m),b=new Set,w=new Set;if(h.set(m,w),y!=null){let v=so(Array.from(y)),S=this.backoff.get(m);for(let A of v){let _=this.streamsOutbound.get(A);if(_!=null&&this.multicodecs.includes(_.protocol)&&!p.has(A)&&!this.direct.has(A)){let D=c(A);(S==null||!S.has(A))&&D>=0&&b.add(A),D>=this.opts.scoreThresholds.gossipThreshold&&w.add(A)}}}let E=(v,S)=>{this.log("HEARTBEAT: Remove mesh link to %s in %s",v,m),this.addBackoff(v,m),p.delete(v),c(v)>=this.opts.scoreThresholds.gossipThreshold&&w.add(v),this.metrics?.onRemoveFromMesh(m,S,1);let A=u.get(v);A==null?u.set(v,[m]):A.push(m)},x=(v,S)=>{this.log("HEARTBEAT: Add mesh link to %s in %s",v,m),this.score.graft(v,m),p.add(v),w.delete(v),this.metrics?.onAddToMesh(m,S,1);let A=l.get(v);A==null?l.set(v,[m]):A.push(m)};if(p.forEach(v=>{let S=c(v);S<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",v,S,m),E(v,vs.BadScore),f.set(v,!0))}),p.size<t){let v=e-p.size;mR(b,v).forEach(A=>{x(A,Wr.NotEnough)})}if(p.size>n){let v=Array.from(p);v.sort((A,_)=>c(_)-c(A)),v=v.slice(0,s).concat(so(v.slice(s)));let S=0;if(v.slice(0,e).forEach(A=>{(this.outbound.get(A)??!1)&&S++}),S<o){let A=D=>{let K=v[D];for(let O=D;O>0;O--)v[O]=v[O-1];v[0]=K};if(S>0){let D=S;for(let K=1;K<e&&D>0;K++)(this.outbound.get(v[K])??!1)&&(A(K),D--)}let _=e-S;for(let D=e;D<v.length&&_>0;D++)(this.outbound.get(v[D])??!1)&&(A(D),_--)}v.slice(e).forEach(A=>{E(A,vs.Excess)})}if(p.size>=t){let v=0;if(p.forEach(S=>{(this.outbound.get(S)??!1)&&v++}),v<o){let S=o-v;u1(b,S,_=>this.outbound.get(_)===!0).forEach(_=>{x(_,Wr.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&p.size>1){let v=Array.from(p).sort((_,D)=>c(_)-c(D)),S=Math.floor(p.size/2),A=c(v[S]);if(A<this.opts.scoreThresholds.opportunisticGraftThreshold){let _=this.opts.opportunisticGraftPeers,D=u1(b,_,K=>c(K)>A);for(let K of D)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",K,m),x(K,Wr.Opportunistic)}}});let d=Date.now();this.fanoutLastpub.forEach((p,m)=>{p+i<d&&(this.fanout.delete(m),this.fanoutLastpub.delete(m))}),this.fanout.forEach((p,m)=>{let y=this.topics.get(m);p.forEach(x=>{(!(y?.has(x)??!1)||c(x)<this.opts.scoreThresholds.publishThreshold)&&p.delete(x)});let b=this.topics.get(m),w=[],E=new Set;if(h.set(m,E),b!=null){let x=so(Array.from(b));for(let v of x){let S=this.streamsOutbound.get(v);if(S!=null&&this.multicodecs.includes(S.protocol)&&!p.has(v)&&!this.direct.has(v)){let A=c(v);A>=this.opts.scoreThresholds.publishThreshold&&w.push(v),A>=this.opts.scoreThresholds.gossipThreshold&&E.add(v)}}}if(p.size<e){let x=e-p.size;w.slice(0,x).forEach(v=>{p.add(v),E?.delete(v)})}}),this.emitGossip(h),await this.sendGraftPrune(l,u,f),this.flush(),this.mcache.shift(),this.dispatchEvent(new Dt("gossipsub:heartbeat"))}getRandomGossipPeers(e,t,n=()=>!0){let s=this.topics.get(e);if(s==null)return new Set;let o=[];return s.forEach(i=>{let a=this.streamsOutbound.get(i);a!=null&&this.multicodecs.includes(a.protocol)&&n(i)&&o.push(i)}),o=so(o),t>0&&o.length>t&&(o=o.slice(0,t)),new Set(o)}onScrapeMetrics(e){e.mcacheSize.set(this.mcache.size),e.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),e.cacheSize.set({cache:"direct"},this.direct.size),e.cacheSize.set({cache:"seenCache"},this.seenCache.size),e.cacheSize.set({cache:"fastMsgIdCache"},this.fastMsgIdCache?.size??0),e.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),e.cacheSize.set({cache:"mcache"},this.mcache.size),e.cacheSize.set({cache:"score"},this.score.size),e.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),e.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),e.cacheSize.set({cache:"topics"},this.topics.size),e.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),e.cacheSize.set({cache:"mesh"},this.mesh.size),e.cacheSize.set({cache:"fanout"},this.fanout.size),e.cacheSize.set({cache:"peers"},this.peers.size),e.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),e.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),e.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),e.cacheSize.set({cache:"gossip"},this.gossip.size),e.cacheSize.set({cache:"control"},this.control.size),e.cacheSize.set({cache:"peerhave"},this.peerhave.size),e.cacheSize.set({cache:"outbound"},this.outbound.size);let t=0,n=Date.now();e.connectedPeersBackoffSec.reset();for(let a of this.backoff.values()){t+=a.size;for(let[c,l]of a.entries())this.peers.has(c)&&e.connectedPeersBackoffSec.observe(Math.max(0,l-n)/1e3)}e.cacheSize.set({cache:"backoff"},t);for(let[a,c]of this.topics)e.topicPeersCount.set({topicStr:a},c.size);for(let[a,c]of this.mesh)e.meshPeerCounts.set({topicStr:a},c.size);let s=[],o=new Map;e.behaviourPenalty.reset();for(let a of this.peers.keys()){let c=this.score.score(a);s.push(c),o.set(a,c),e.behaviourPenalty.observe(this.score.peerStats.get(a)?.behaviourPenalty??0)}e.registerScores(s,this.opts.scoreThresholds),e.registerScorePerMesh(this.mesh,o);let i=ER(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,e.topicStrToLabel);e.registerScoreWeights(i)}};function SD(r={}){return e=>new v6(e,r)}var x6=class{needNext;haveNext;ended;nextResult;constructor(){this.ended=!1,this.needNext=xe(),this.haveNext=xe()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("Have next but next was undefined");let e=this.nextResult;return this.nextResult=void 0,this.needNext.resolve(),this.needNext=xe(),e}async throw(e){return this.ended=!0,e!=null&&this.haveNext.reject(e),{done:!0,value:void 0}}async return(){let e={done:!0,value:void 0};return await this._push(void 0),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw new Error("Cannot push value onto an ended pushable");this.nextResult!=null&&await this.needNext.promise,e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=xe(),await nn(this.needNext.promise,t?.signal,t)}};function _D(){return new x6}var Y2=class extends Error{code;constructor(e,t){super(e),this.code=t}},S6=class extends Y2{type;constructor(e){super(e,"ABORT_ERR"),this.type="aborted"}};function AD(r,e){let t=_D();r.sink(t).catch(async i=>{await t.end(i)}),r.sink=async i=>{for await(let a of i)await t.push(a);await t.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());let s=new ke;return{read:async(i,a)=>{a?.signal?.throwIfAborted();let c,l=new Promise((u,f)=>{c=()=>{f(new S6("Read aborted"))},a?.signal?.addEventListener("abort",c)});try{if(i==null){let{done:f,value:h}=await Promise.race([n.next(),l]);return f===!0?new ke:h}for(;s.byteLength<i;){let{value:f,done:h}=await Promise.race([n.next(),l]);if(h===!0)throw new Y2("unexpected end of input","ERR_UNEXPECTED_EOF");s.append(f)}let u=s.sublist(0,i);return s.consume(i),u}finally{c!=null&&a?.signal?.removeEventListener("abort",c)}},write:async(i,a)=>{a?.signal?.throwIfAborted(),i instanceof Uint8Array?await t.push(i,a):await t.push(i.subarray(),a)},unwrap:()=>{if(s.byteLength>0){let i=r.source;r.source=async function*(){e?.yieldBytes===!1?yield s:yield*s,yield*i}()}return r}}}var j2=class extends Error{code;constructor(e,t){super(e),this.code=t}},RD=r=>gn(r);RD.bytes=0;function io(r,e={}){let t=AD(r,e);return e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=Jt(e.maxDataLength)),{read:async s=>{let o=-1,i=new ke,a=e?.lengthDecoder??RD;for(;;){i.append(await t.read(1,s));try{o=a(i)}catch(c){if(c instanceof RangeError)continue;throw c}if(e?.maxLengthLength!=null&&i.byteLength>e.maxLengthLength)throw new j2("message length length too long","ERR_MSG_LENGTH_TOO_LONG");if(o>-1)break}if(e?.maxDataLength!=null&&o>e.maxDataLength)throw new j2("message length too long","ERR_MSG_DATA_TOO_LONG");return t.read(o,s)},write:async(s,o)=>{await t.write(sr.single(s,e),o)},writeV:async(s,o)=>{let i=new ke(...s.map(a=>sr.single(a,e)));await t.write(i,o)},unwrap:()=>t.unwrap()}}function _6(){let r=xe(),e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:async function*(){yield*await r.promise}()}}function ID(){let r=_6(),e=_6();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}var Pu=!!globalThis.process?.env?.DUMP_SESSION_KEYS;var ci=r=>new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4));function TD(r){return r instanceof Uint8Array||r!=null&&typeof r=="object"&&r.constructor.name==="Uint8Array"}var kD=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),bZ=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!bZ)throw new Error("Non little-endian hardware is not supported");function Q2(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function X2(r){if(typeof r=="string")r=Q2(r);else if(TD(r))r=r.slice();else throw new Error(`expected Uint8Array, got ${typeof r}`);return r}var wZ=r=>Object.prototype.toString.call(r)==="[object Object]"&&r.constructor===Object;function DD(r,e){if(e!==void 0&&(typeof e!="object"||!wZ(e)))throw new Error("options must be object or undefined");return Object.assign(r,e)}function Uc(r,e){if(!TD(r))throw new Error("Uint8Array expected");if(typeof e=="number"&&r.length!==e)throw new Error(`Uint8Array length ${e} expected`)}function PD(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}var A6=(r,e)=>(Object.assign(e,r),e);function R6(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let s=BigInt(32),o=BigInt(4294967295),i=Number(t>>s&o),a=Number(t&o),c=n?4:0,l=n?0:4;r.setUint32(e+c,i,n),r.setUint32(e+l,a,n)}function J2(r){if(!Number.isSafeInteger(r)||r<0)throw new Error(`wrong positive integer: ${r}`)}function I6(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}function EZ(r){return r!=null&&typeof r=="object"&&(r instanceof Uint8Array||r.constructor.name==="Uint8Array")}function Cu(r,...e){if(!EZ(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${r.length}`)}function T6(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function CD(r,e){Cu(r);let t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var _r=(r,e)=>r[e++]&255|(r[e++]&255)<<8,k6=class{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=X2(e),Uc(e,32);let t=_r(e,0),n=_r(e,2),s=_r(e,4),o=_r(e,6),i=_r(e,8),a=_r(e,10),c=_r(e,12),l=_r(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|s<<6)&7939,this.r[3]=(s>>>7|o<<9)&8191,this.r[4]=(o>>>4|i<<12)&255,this.r[5]=i>>>1&8190,this.r[6]=(i>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let u=0;u<8;u++)this.pad[u]=_r(e,16+2*u)}process(e,t,n=!1){let s=n?0:2048,{h:o,r:i}=this,a=i[0],c=i[1],l=i[2],u=i[3],f=i[4],h=i[5],d=i[6],p=i[7],m=i[8],y=i[9],b=_r(e,t+0),w=_r(e,t+2),E=_r(e,t+4),x=_r(e,t+6),v=_r(e,t+8),S=_r(e,t+10),A=_r(e,t+12),_=_r(e,t+14),D=o[0]+(b&8191),K=o[1]+((b>>>13|w<<3)&8191),O=o[2]+((w>>>10|E<<6)&8191),F=o[3]+((E>>>7|x<<9)&8191),W=o[4]+((x>>>4|v<<12)&8191),ce=o[5]+(v>>>1&8191),B=o[6]+((v>>>14|S<<2)&8191),N=o[7]+((S>>>11|A<<5)&8191),L=o[8]+((A>>>8|_<<8)&8191),U=o[9]+(_>>>5|s),k=0,G=k+D*a+K*(5*y)+O*(5*m)+F*(5*p)+W*(5*d);k=G>>>13,G&=8191,G+=ce*(5*h)+B*(5*f)+N*(5*u)+L*(5*l)+U*(5*c),k+=G>>>13,G&=8191;let Q=k+D*c+K*a+O*(5*y)+F*(5*m)+W*(5*p);k=Q>>>13,Q&=8191,Q+=ce*(5*d)+B*(5*h)+N*(5*f)+L*(5*u)+U*(5*l),k+=Q>>>13,Q&=8191;let se=k+D*l+K*c+O*a+F*(5*y)+W*(5*m);k=se>>>13,se&=8191,se+=ce*(5*p)+B*(5*d)+N*(5*h)+L*(5*f)+U*(5*u),k+=se>>>13,se&=8191;let Ee=k+D*u+K*l+O*c+F*a+W*(5*y);k=Ee>>>13,Ee&=8191,Ee+=ce*(5*m)+B*(5*p)+N*(5*d)+L*(5*h)+U*(5*f),k+=Ee>>>13,Ee&=8191;let Se=k+D*f+K*u+O*l+F*c+W*a;k=Se>>>13,Se&=8191,Se+=ce*(5*y)+B*(5*m)+N*(5*p)+L*(5*d)+U*(5*h),k+=Se>>>13,Se&=8191;let Ke=k+D*h+K*f+O*u+F*l+W*c;k=Ke>>>13,Ke&=8191,Ke+=ce*a+B*(5*y)+N*(5*m)+L*(5*p)+U*(5*d),k+=Ke>>>13,Ke&=8191;let _e=k+D*d+K*h+O*f+F*u+W*l;k=_e>>>13,_e&=8191,_e+=ce*c+B*a+N*(5*y)+L*(5*m)+U*(5*p),k+=_e>>>13,_e&=8191;let Ie=k+D*p+K*d+O*h+F*f+W*u;k=Ie>>>13,Ie&=8191,Ie+=ce*l+B*c+N*a+L*(5*y)+U*(5*m),k+=Ie>>>13,Ie&=8191;let pt=k+D*m+K*p+O*d+F*h+W*f;k=pt>>>13,pt&=8191,pt+=ce*u+B*l+N*c+L*a+U*(5*y),k+=pt>>>13,pt&=8191;let at=k+D*y+K*m+O*p+F*d+W*h;k=at>>>13,at&=8191,at+=ce*f+B*u+N*l+L*c+U*a,k+=at>>>13,at&=8191,k=(k<<2)+k|0,k=k+G|0,G=k&8191,k=k>>>13,Q+=k,o[0]=G,o[1]=Q,o[2]=se,o[3]=Ee,o[4]=Se,o[5]=Ke,o[6]=_e,o[7]=Ie,o[8]=pt,o[9]=at}finalize(){let{h:e,pad:t}=this,n=new Uint16Array(10),s=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=s,s=e[a]>>>13,e[a]&=8191;e[0]+=s*5,s=e[0]>>>13,e[0]&=8191,e[1]+=s,s=e[1]>>>13,e[1]&=8191,e[2]+=s,n[0]=e[0]+5,s=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+s,s=n[a]>>>13,n[a]&=8191;n[9]-=8192;let o=(s^1)-1;for(let a=0;a<10;a++)n[a]&=o;o=~o;for(let a=0;a<10;a++)e[a]=e[a]&o|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let i=e[0]+t[0];e[0]=i&65535;for(let a=1;a<8;a++)i=(e[a]+t[a]|0)+(i>>>16)|0,e[a]=i&65535}update(e){T6(this);let{buffer:t,blockLen:n}=this;e=X2(e);let s=e.length;for(let o=0;o<s;){let i=Math.min(n-this.pos,s-o);if(i===n){for(;n<=s-o;o+=n)this.process(e,o);continue}t.set(e.subarray(o,o+i),this.pos),this.pos+=i,o+=i,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){this.h.fill(0),this.r.fill(0),this.buffer.fill(0),this.pad.fill(0)}digestInto(e){T6(this),CD(e,this),this.finished=!0;let{buffer:t,h:n}=this,{pos:s}=this;if(s){for(t[s++]=1;s<16;s++)t[s]=0;this.process(t,0,!0)}this.finalize();let o=0;for(let i=0;i<8;i++)e[o++]=n[i]>>>0,e[o++]=n[i]>>>8;return e}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}};function vZ(r){let e=(n,s)=>r(s).update(X2(n)).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}var BD=vZ(r=>new k6(r));var xZ=Q2("expand 16-byte k"),SZ=Q2("expand 32-byte k"),_Z=ci(xZ),AZ=ci(SZ);function he(r,e){return r<<e|r>>>32-e}function D6(r){return r.byteOffset%4===0}var Z2=64,RZ=16,LD=2**32-1,ND=new Uint32Array;function IZ(r,e,t,n,s,o,i,a){let c=s.length,l=new Uint8Array(Z2),u=ci(l),f=D6(s)&&D6(o),h=f?ci(s):ND,d=f?ci(o):ND;for(let p=0;p<c;i++){if(r(e,t,n,u,i,a),i>=LD)throw new Error("arx: counter overflow");let m=Math.min(Z2,c-p);if(f&&m===Z2){let y=p/4;if(p%4!==0)throw new Error("arx: invalid block position");for(let b=0,w;b<RZ;b++)w=y+b,d[w]=h[w]^u[b];p+=Z2;continue}for(let y=0,b;y<m;y++)b=p+y,o[b]=s[b]^l[y];p+=m}}function P6(r,e){let{allowShortKeys:t,extendNonceFn:n,counterLength:s,counterRight:o,rounds:i}=DD({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return J2(s),J2(i),I6(o),I6(t),(a,c,l,u,f=0)=>{Cu(a),Cu(c),Cu(l);let h=l.length;if(u||(u=new Uint8Array(h)),Cu(u),J2(f),f<0||f>=LD)throw new Error("arx: counter overflow");if(u.length<h)throw new Error(`arx: output (${u.length}) is shorter than data (${h})`);let d=[],p=a.length,m,y;if(p===32)m=a.slice(),d.push(m),y=AZ;else if(p===16&&t)m=new Uint8Array(32),m.set(a),m.set(a,16),y=_Z,d.push(m);else throw new Error(`arx: invalid 32-byte key, got length=${p}`);D6(c)||(c=c.slice(),d.push(c));let b=ci(m);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(y,b,ci(c.subarray(0,16)),b),c=c.subarray(16)}let w=16-s;if(w!==c.length)throw new Error(`arx: nonce must be ${w} or 16 bytes`);if(w!==12){let x=new Uint8Array(12);x.set(c,o?0:12-c.length),c=x,d.push(c)}let E=ci(c);for(IZ(r,y,b,E,l,u,f,i);d.length>0;)d.pop().fill(0);return u}}function MD(r,e,t,n,s,o=20){let i=r[0],a=r[1],c=r[2],l=r[3],u=e[0],f=e[1],h=e[2],d=e[3],p=e[4],m=e[5],y=e[6],b=e[7],w=s,E=t[0],x=t[1],v=t[2],S=i,A=a,_=c,D=l,K=u,O=f,F=h,W=d,ce=p,B=m,N=y,L=b,U=w,k=E,G=x,Q=v;for(let Ee=0;Ee<o;Ee+=2)S=S+K|0,U=he(U^S,16),ce=ce+U|0,K=he(K^ce,12),S=S+K|0,U=he(U^S,8),ce=ce+U|0,K=he(K^ce,7),A=A+O|0,k=he(k^A,16),B=B+k|0,O=he(O^B,12),A=A+O|0,k=he(k^A,8),B=B+k|0,O=he(O^B,7),_=_+F|0,G=he(G^_,16),N=N+G|0,F=he(F^N,12),_=_+F|0,G=he(G^_,8),N=N+G|0,F=he(F^N,7),D=D+W|0,Q=he(Q^D,16),L=L+Q|0,W=he(W^L,12),D=D+W|0,Q=he(Q^D,8),L=L+Q|0,W=he(W^L,7),S=S+O|0,Q=he(Q^S,16),N=N+Q|0,O=he(O^N,12),S=S+O|0,Q=he(Q^S,8),N=N+Q|0,O=he(O^N,7),A=A+F|0,U=he(U^A,16),L=L+U|0,F=he(F^L,12),A=A+F|0,U=he(U^A,8),L=L+U|0,F=he(F^L,7),_=_+W|0,k=he(k^_,16),ce=ce+k|0,W=he(W^ce,12),_=_+W|0,k=he(k^_,8),ce=ce+k|0,W=he(W^ce,7),D=D+K|0,G=he(G^D,16),B=B+G|0,K=he(K^B,12),D=D+K|0,G=he(G^D,8),B=B+G|0,K=he(K^B,7);let se=0;n[se++]=i+S|0,n[se++]=a+A|0,n[se++]=c+_|0,n[se++]=l+D|0,n[se++]=u+K|0,n[se++]=f+O|0,n[se++]=h+F|0,n[se++]=d+W|0,n[se++]=p+ce|0,n[se++]=m+B|0,n[se++]=y+N|0,n[se++]=b+L|0,n[se++]=w+U|0,n[se++]=E+k|0,n[se++]=x+G|0,n[se++]=v+Q|0}function TZ(r,e,t,n){let s=r[0],o=r[1],i=r[2],a=r[3],c=e[0],l=e[1],u=e[2],f=e[3],h=e[4],d=e[5],p=e[6],m=e[7],y=t[0],b=t[1],w=t[2],E=t[3];for(let v=0;v<20;v+=2)s=s+c|0,y=he(y^s,16),h=h+y|0,c=he(c^h,12),s=s+c|0,y=he(y^s,8),h=h+y|0,c=he(c^h,7),o=o+l|0,b=he(b^o,16),d=d+b|0,l=he(l^d,12),o=o+l|0,b=he(b^o,8),d=d+b|0,l=he(l^d,7),i=i+u|0,w=he(w^i,16),p=p+w|0,u=he(u^p,12),i=i+u|0,w=he(w^i,8),p=p+w|0,u=he(u^p,7),a=a+f|0,E=he(E^a,16),m=m+E|0,f=he(f^m,12),a=a+f|0,E=he(E^a,8),m=m+E|0,f=he(f^m,7),s=s+l|0,E=he(E^s,16),p=p+E|0,l=he(l^p,12),s=s+l|0,E=he(E^s,8),p=p+E|0,l=he(l^p,7),o=o+u|0,y=he(y^o,16),m=m+y|0,u=he(u^m,12),o=o+u|0,y=he(y^o,8),m=m+y|0,u=he(u^m,7),i=i+f|0,b=he(b^i,16),h=h+b|0,f=he(f^h,12),i=i+f|0,b=he(b^i,8),h=h+b|0,f=he(f^h,7),a=a+c|0,w=he(w^a,16),d=d+w|0,c=he(c^d,12),a=a+c|0,w=he(w^a,8),d=d+w|0,c=he(c^d,7);let x=0;n[x++]=s,n[x++]=o,n[x++]=i,n[x++]=a,n[x++]=y,n[x++]=b,n[x++]=w,n[x++]=E}var kZ=P6(MD,{counterRight:!1,counterLength:4,allowShortKeys:!1}),DZ=P6(MD,{counterRight:!1,counterLength:8,extendNonceFn:TZ,allowShortKeys:!1});var PZ=new Uint8Array(16),OD=(r,e)=>{r.update(e);let t=e.length%16;t&&r.update(PZ.subarray(t))},CZ=new Uint8Array(32);function KD(r,e,t,n,s){let o=r(e,t,CZ),i=BD.create(o);s&&OD(i,s),OD(i,n);let a=new Uint8Array(16),c=kD(a);R6(c,0,BigInt(s?s.length:0),!0),R6(c,8,BigInt(n.length),!0),i.update(a);let l=i.digest();return o.fill(0),l}var UD=r=>(e,t,n)=>(Uc(e,32),Uc(t),{encrypt:(o,i)=>{let a=o.length,c=a+16;i?Uc(i,c):i=new Uint8Array(c),r(e,t,o,i,1);let l=KD(r,e,t,i.subarray(0,-16),n);return i.set(l,a),i},decrypt:(o,i)=>{let a=o.length,c=a-16;if(a<16)throw new Error("encrypted data must be at least 16 bytes");i?Uc(i,c):i=new Uint8Array(c);let l=o.subarray(0,-16),u=o.subarray(-16),f=KD(r,e,t,l,n);if(!PD(u,f))throw new Error("invalid tag");return r(e,t,l,i,1),i}}),C6=A6({blockSize:64,nonceLength:12,tagLength:16},UD(kZ)),q9e=A6({blockSize:64,nonceLength:24,tagLength:16},UD(DZ));function VD(r,e,t){return Ic(r),t===void 0&&(t=new Uint8Array(r.outputLen)),pa(r,Rs(t),Rs(e))}var B6=new Uint8Array([0]),FD=new Uint8Array;function qD(r,e,t,n=32){if(Ic(r),oa(n),n>255*r.outputLen)throw new Error("Length should be <= 255*HashLen");let s=Math.ceil(n/r.outputLen);t===void 0&&(t=FD);let o=new Uint8Array(s*r.outputLen),i=pa.create(r,e),a=i._cloneInto(),c=new Uint8Array(i.outputLen);for(let l=0;l<s;l++)B6[0]=l+1,a.update(l===0?FD:c).update(t).update(B6).digestInto(c),o.set(c,r.outputLen*l),i._cloneInto(a);return i.destroy(),a.destroy(),c.fill(0),B6.fill(0),o.slice(0,n)}var N6={hashSHA256(r){return ha(r.subarray())},getHKDF(r,e){let t=VD(ha,e,r),s=qD(ha,t,void 0,96),o=s.subarray(0,32),i=s.subarray(32,64),a=s.subarray(64,96);return[o,i,a]},generateX25519KeyPair(){let r=yp.utils.randomPrivateKey();return{publicKey:yp.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:yp.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return yp.getSharedSecret(r.subarray(),e.subarray())},chaCha20Poly1305Encrypt(r,e,t,n){return C6(n,e,t).encrypt(r.subarray())},chaCha20Poly1305Decrypt(r,e,t,n,s){return C6(n,e,t).decrypt(r.subarray(),s)}};var HD=N6;var Bu=r=>{let e=kt(2);return new DataView(e.buffer,e.byteOffset,e.byteLength).setUint16(0,r,!1),e};Bu.bytes=2;var Up=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");return r instanceof Uint8Array?new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,!1):r.getUint16(0)};Up.bytes=2;function zD(r){return new ke(r.ne,r.ciphertext)}function $D(r){return new ke(r.ne,r.ns,r.ciphertext)}function GD(r){return new ke(r.ns,r.ciphertext)}function WD(r){if(r.length<32)throw new Error("Cannot decode stage 0 MessageBuffer: length less than 32 bytes.");return{ne:r.subarray(0,32),ciphertext:r.subarray(32,r.length),ns:Pe(0)}}function YD(r){if(r.length<80)throw new Error("Cannot decode stage 1 MessageBuffer: length less than 80 bytes.");return{ne:r.subarray(0,32),ns:r.subarray(32,80),ciphertext:r.subarray(80,r.length)}}function jD(r){if(r.length<48)throw new Error("Cannot decode stage 2 MessageBuffer: length less than 48 bytes.");return{ne:Pe(0),ns:r.subarray(0,48),ciphertext:r.subarray(48,r.length)}}var XD=16;function JD(r,e){return async function*(t){for await(let n of t)for(let s=0;s<n.length;s+=65519){let o=s+65519;o>n.length&&(o=n.length);let i;n instanceof Uint8Array?i=r.encrypt(n.subarray(s,o),r.session):i=r.encrypt(n.sublist(s,o),r.session),e?.encryptedPackets.increment(),yield new ke(Bu(i.byteLength),i)}}}function ZD(r,e){return async function*(t){for await(let n of t)for(let s=0;s<n.length;s+=65535){let o=s+65535;if(o>n.length&&(o=n.length),o-XD<s)throw new Error("Invalid chunk");let i=n.sublist(s,o),a=n.subarray(s,o-XD),{plaintext:c,valid:l}=r.decrypt(i,r.session,a);if(!l)throw e?.decryptErrors.increment(),new Error("Failed to validate decrypted chunk");e?.decryptedPackets.increment(),yield c}}}var Vp=class r extends Error{code;constructor(e="Unexpected Peer"){super(e),this.code=r.code}static code="ERR_UNEXPECTED_PEER"},Fc=class r extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=r.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"};var em;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(let o of t.webtransportCerthashes)n.uint32(10),n.bytes(o);s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={webtransportCerthashes:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:{s.webtransportCerthashes.push(t.bytes());break}default:{t.skipType(i&7);break}}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(em||(em={}));var qp;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(n.uint32(10),n.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(n.uint32(18),n.bytes(t.identitySig)),t.extensions!=null&&(n.uint32(34),em.codec().encode(t.extensions,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={identityKey:Pe(0),identitySig:Pe(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:{s.identityKey=t.bytes();break}case 2:{s.identitySig=t.bytes();break}case 4:{s.extensions=em.codec().decode(t,t.uint32());break}default:{t.skipType(i&7);break}}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(qp||(qp={}));async function eP(r,e,t){let n=await NZ(r,tP(e));if(r.publicKey==null)throw new Error("PublicKey was missing from local PeerId");return BZ(r.publicKey,n,t)}function BZ(r,e,t){return qp.encode({identityKey:r,identitySig:e,extensions:t??{webtransportCerthashes:[]}}).subarray()}async function NZ(r,e){if(r.privateKey==null)throw new Error("PrivateKey was missing from PeerId");return(await W1(r.privateKey)).sign(e)}async function L6(r){return xr(r.identityKey)}function O6(r){return qp.decode(r)}function tP(r){let e=R("noise-libp2p-static-key:");return r instanceof Uint8Array?le([e,r],e.length+r.length):(r.prepend(e),r)}async function K6(r,e,t){let n=await xr(e.identityKey);if(!n.equals(t))throw new Error(`Payload identity key ${n.toString()} does not match expected remote peer ${t.toString()}`);let s=tP(r);if(n.publicKey==null)throw new Error("PublicKey was missing from PeerId");if(e.identitySig==null)throw new Error("Signature was missing from message");if(!await ma(n.publicKey).verify(s,e.identitySig))throw new Error("Static key doesn't match to peer that signed payload!");return n}function Hp(r){return!(!(r instanceof Uint8Array)&&!Hl(r)||r.byteLength!==32)}function tm(r,e){if(globalThis.Buffer!=null)return globalThis.Buffer.compare(r,e);for(let t=0;t<r.byteLength;t++){if(r[t]<e[t])return-1;if(r[t]>e[t])return 1}return r.byteLength>e.byteLength?1:r.byteLength<e.byteLength?-1:0}function li(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");let t=kt(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return Hs(t)}var LZ=0,OZ=4294967295,KZ="Cipherstate has reached maximum n, a new handshake must be performed",rm=class{n;bytes;view;constructor(e=LZ){this.n=e,this.bytes=Pe(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>OZ)throw new Error(KZ)}};var nm=class{crypto;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:noise:abstract-handshake"),this.crypto=t}encryptWithAd(e,t,n){let s=this.encrypt(e.k,e.n,t,n);return e.n.increment(),s}decryptWithAd(e,t,n,s){let{plaintext:o,valid:i}=this.decrypt(e.k,e.n,t,n,s);return i&&e.n.increment(),{plaintext:o,valid:i}}hasKey(e){return!this.isEmptyKey(e.k)}createEmptyKey(){return Pe(32)}isEmptyKey(e){let t=this.createEmptyKey();return q(t,e)}encrypt(e,t,n,s){return t.assertValue(),this.crypto.chaCha20Poly1305Encrypt(s,t.getBytes(),n,e)}encryptAndHash(e,t){let n;return this.hasKey(e.cs)?n=this.encryptWithAd(e.cs,e.h,t):n=t,this.mixHash(e,n),n}decrypt(e,t,n,s,o){t.assertValue();let i=this.crypto.chaCha20Poly1305Decrypt(s,t.getBytes(),n,e,o);return i?{plaintext:i,valid:!0}:{plaintext:Pe(0),valid:!1}}decryptAndHash(e,t){let n,s=!0;return this.hasKey(e.cs)?{plaintext:n,valid:s}=this.decryptWithAd(e.cs,e.h,t):n=t,this.mixHash(e,t),{plaintext:n,valid:s}}dh(e,t){try{let n=this.crypto.generateX25519SharedKey(e,t);return n.length===32?n:n.subarray(0,32)}catch(n){let s=n;return this.log.error("error deriving shared key",s),Pe(32)}}mixHash(e,t){e.h=this.getHash(e.h,t)}getHash(e,t){return this.crypto.hashSHA256(new ke(e,t))}mixKey(e,t){let[n,s]=this.crypto.getHKDF(e.ck,t);e.cs=this.initializeKey(s),e.ck=n}initializeKey(e){return{k:e,n:new rm}}initializeSymmetric(e){let t=R(e,"utf-8"),n=this.hashProtocolName(t),s=n,o=this.createEmptyKey();return{cs:this.initializeKey(o),ck:s,h:n}}hashProtocolName(e){if(e.length<=32){let t=Pe(32);return t.set(e),t}else return this.getHash(e,Pe(0))}split(e){let[t,n]=this.crypto.getHKDF(e.ck,Pe(0)),s=this.initializeKey(t),o=this.initializeKey(n);return{cs1:s,cs2:o}}writeMessageRegular(e,t){let n=this.encryptWithAd(e,Pe(0),t),s=this.createEmptyKey(),o=Pe(0);return{ne:s,ns:o,ciphertext:n}}readMessageRegular(e,t){return this.decryptWithAd(e,Pe(0),t.ciphertext)}};var sm=class extends nm{initializeInitiator(e,t,n,s){let i=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");this.mixHash(i,e);let a=Pe(32);return{ss:i,s:t,rs:n,psk:s,re:a}}initializeResponder(e,t,n,s){let i=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");this.mixHash(i,e);let a=Pe(32);return{ss:i,s:t,rs:n,psk:s,re:a}}writeMessageA(e,t,n){let s=Pe(0);n!==void 0?e.e=n:e.e=this.crypto.generateX25519KeyPair();let o=e.e.publicKey;this.mixHash(e.ss,o);let i=this.encryptAndHash(e.ss,t);return{ne:o,ns:s,ciphertext:i}}writeMessageB(e,t){e.e=this.crypto.generateX25519KeyPair();let n=e.e.publicKey;this.mixHash(e.ss,n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));let s=e.s.publicKey,o=this.encryptAndHash(e.ss,s);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));let i=this.encryptAndHash(e.ss,t);return{ne:n,ns:o,ciphertext:i}}writeMessageC(e,t){let n=e.s.publicKey,s=this.encryptAndHash(e.ss,n);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));let o=this.encryptAndHash(e.ss,t),a={ne:this.createEmptyKey(),ns:s,ciphertext:o},{cs1:c,cs2:l}=this.split(e.ss);return{h:e.ss.h,messageBuffer:a,cs1:c,cs2:l}}readMessageA(e,t){return Hp(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),this.decryptAndHash(e.ss,t.ciphertext)}readMessageB(e,t){if(Hp(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));let{plaintext:n,valid:s}=this.decryptAndHash(e.ss,t.ns);s&&Hp(n)&&(e.rs=n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));let{plaintext:o,valid:i}=this.decryptAndHash(e.ss,t.ciphertext);return{plaintext:o,valid:s&&i}}readMessageC(e,t){let{plaintext:n,valid:s}=this.decryptAndHash(e.ss,t.ns);if(s&&Hp(n)&&(e.rs=n),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));let{plaintext:o,valid:i}=this.decryptAndHash(e.ss,t.ciphertext),{cs1:a,cs2:c}=this.split(e.ss);return{h:e.ss.h,plaintext:o,valid:s&&i,cs1:a,cs2:c}}initSession(e,t,n){let s=this.createEmptyKey(),o=Pe(32),i;return e?i=this.initializeInitiator(t,n,o,s):i=this.initializeResponder(t,n,o,s),{hs:i,i:e,mc:0}}sendMessage(e,t,n){let s;if(e.mc===0)s=this.writeMessageA(e.hs,t,n);else if(e.mc===1)s=this.writeMessageB(e.hs,t);else if(e.mc===2){let{h:o,messageBuffer:i,cs1:a,cs2:c}=this.writeMessageC(e.hs,t);s=i,e.h=o,e.cs1=a,e.cs2=c}else if(e.mc>2)if(e.i){if(!e.cs1)throw new Error("CS1 (cipher state) is not defined");s=this.writeMessageRegular(e.cs1,t)}else{if(!e.cs2)throw new Error("CS2 (cipher state) is not defined");s=this.writeMessageRegular(e.cs2,t)}else throw new Error("Session invalid.");return e.mc++,s}recvMessage(e,t){let n=Pe(0),s=!1;if(e.mc===0)({plaintext:n,valid:s}=this.readMessageA(e.hs,t));else if(e.mc===1)({plaintext:n,valid:s}=this.readMessageB(e.hs,t));else if(e.mc===2){let{h:o,plaintext:i,valid:a,cs1:c,cs2:l}=this.readMessageC(e.hs,t);n=i,s=a,e.h=o,e.cs1=c,e.cs2=l}return e.mc++,{plaintext:n,valid:s}}};function rP(r,e){!e.enabled||!Pu||(e(`LOCAL_STATIC_PUBLIC_KEY ${T(r.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${T(r.privateKey,"hex")}`))}function M6(r,e){!e.enabled||!Pu||(r?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${T(r.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${T(r.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function nP(r,e){!e.enabled||!Pu||e(`REMOTE_STATIC_PUBLIC_KEY ${T(r.subarray(),"hex")}`)}function U6(r,e){!e.enabled||!Pu||e(`REMOTE_EPHEMERAL_PUBLIC_KEY ${T(r.subarray(),"hex")}`)}function sP(r,e){!e.enabled||!Pu||(r.cs1&&r.cs2?(e(`CIPHER_STATE_1 ${r.cs1.n.getUint64()} ${T(r.cs1.k,"hex")}`),e(`CIPHER_STATE_2 ${r.cs2.n.getUint64()} ${T(r.cs2.k,"hex")}`)):e("Missing cipher state."))}var om=class{isInitiator;session;remotePeer;remoteExtensions={webtransportCerthashes:[]};payload;connection;xx;staticKeypair;prologue;log;constructor(e,t,n,s,o,i,a,c,l){this.log=e.logger.forComponent("libp2p:noise:xxhandshake"),this.isInitiator=t,this.payload=n,this.prologue=s,this.staticKeypair=i,this.connection=a,c&&(this.remotePeer=c),this.xx=l??new sm(e,o),this.session=this.xx.initSession(this.isInitiator,this.prologue,this.staticKeypair)}async propose(){if(rP(this.session.hs.s,this.log),this.isInitiator){this.log.trace("Stage 0 - Initiator starting to send first message.");let e=this.xx.sendMessage(this.session,Pe(0));await this.connection.write(zD(e)),this.log.trace("Stage 0 - Initiator finished sending first message."),M6(this.session.hs.e,this.log)}else{this.log.trace("Stage 0 - Responder waiting to receive first message...");let e=WD((await this.connection.read()).subarray()),{valid:t}=this.xx.recvMessage(this.session,e);if(!t)throw new Fc("xx handshake stage 0 validation fail");this.log.trace("Stage 0 - Responder received first message."),U6(this.session.hs.re,this.log)}}async exchange(){if(this.isInitiator){this.log.trace("Stage 1 - Initiator waiting to receive first message from responder...");let e=YD((await this.connection.read()).subarray()),{plaintext:t,valid:n}=this.xx.recvMessage(this.session,e);if(!n)throw new Fc("xx handshake stage 1 validation fail");this.log.trace("Stage 1 - Initiator received the message."),U6(this.session.hs.re,this.log),nP(this.session.hs.rs,this.log),this.log.trace("Initiator going to check remote's signature...");try{let s=O6(t);this.remotePeer=this.remotePeer||await L6(s),await K6(this.session.hs.rs,s,this.remotePeer),this.setRemoteNoiseExtension(s.extensions)}catch(s){let o=s;throw new Vp(`Error occurred while verifying signed payload: ${o.message}`)}this.log.trace("All good with the signature!")}else{this.log.trace("Stage 1 - Responder sending out first message with signed payload and static key.");let e=this.xx.sendMessage(this.session,this.payload);await this.connection.write($D(e)),this.log.trace("Stage 1 - Responder sent the second handshake message with signed payload."),M6(this.session.hs.e,this.log)}}async finish(){if(this.isInitiator){this.log.trace("Stage 2 - Initiator sending third handshake message.");let e=this.xx.sendMessage(this.session,this.payload);await this.connection.write(GD(e)),this.log.trace("Stage 2 - Initiator sent message with signed payload.")}else{this.log.trace("Stage 2 - Responder waiting for third handshake message...");let e=jD((await this.connection.read()).subarray()),{plaintext:t,valid:n}=this.xx.recvMessage(this.session,e);if(!n)throw new Fc("xx handshake stage 2 validation fail");this.log.trace("Stage 2 - Responder received the message, finished handshake.");try{let s=O6(t);this.remotePeer=this.remotePeer||await L6(s),await K6(this.session.hs.rs,s,this.remotePeer),this.setRemoteNoiseExtension(s.extensions)}catch(s){let o=s;throw new Vp(`Error occurred while verifying signed payload: ${o.message}`)}}sP(this.session,this.log)}encrypt(e,t){let n=this.getCS(t);return this.xx.encryptWithAd(n,Pe(0),e)}decrypt(e,t,n){let s=this.getCS(t,!1);return this.xx.decryptWithAd(s,Pe(0),e,n)}getRemoteStaticKey(){return this.session.hs.rs}getCS(e,t=!0){if(!e.cs1||!e.cs2)throw new Fc("Handshake not completed properly, cipher state does not exist.");return this.isInitiator?t?e.cs1:e.cs2:t?e.cs2:e.cs1}setRemoteNoiseExtension(e){e&&(this.remoteExtensions=e)}};function oP(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}var im=class{protocol="/noise";crypto;prologue;staticKeys;extensions;metrics;components;constructor(e,t={}){let{staticNoiseKey:n,extensions:s,crypto:o,prologueBytes:i}=t,{metrics:a}=e;this.components=e,this.crypto=o??HD,this.extensions=s,this.metrics=a?oP(a):void 0,n?this.staticKeys=this.crypto.generateX25519KeyPairFromSeed(n):this.staticKeys=this.crypto.generateX25519KeyPair(),this.prologue=i??Pe(0)}async secureOutbound(e,t,n){let s=io(t,{lengthEncoder:Bu,lengthDecoder:Up,maxDataLength:65535}),o=await this.performHandshake({connection:s,isInitiator:!0,localPeer:e,remotePeer:n}),i=await this.createSecureConnection(s,o);return t.source=i.source,t.sink=i.sink,{conn:t,remoteExtensions:o.remoteExtensions,remotePeer:o.remotePeer}}async secureInbound(e,t,n){let s=io(t,{lengthEncoder:Bu,lengthDecoder:Up,maxDataLength:65535}),o=await this.performHandshake({connection:s,isInitiator:!1,localPeer:e,remotePeer:n}),i=await this.createSecureConnection(s,o);return t.source=i.source,t.sink=i.sink,{conn:t,remotePeer:o.remotePeer,remoteExtensions:o.remoteExtensions}}async performHandshake(e){let t=await eP(e.localPeer,this.staticKeys.publicKey,this.extensions);return this.performXXHandshake(e,t)}async performXXHandshake(e,t){let{isInitiator:n,remotePeer:s,connection:o}=e,i=new om(this.components,n,t,this.prologue,this.crypto,this.staticKeys,o,s);try{await i.propose(),await i.exchange(),await i.finish(),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){if(this.metrics?.xxHandshakeErrors.increment(),a instanceof Error)throw a.message=`Error occurred during XX handshake: ${a.message}`,a}return i}async createSecureConnection(e,t){let[n,s]=ID(),o=e.unwrap();return await lt(n,JD(t,this.metrics),o,i=>Mr(i,{lengthDecoder:Up}),ZD(t,this.metrics),n),s}};function Nu(r={}){return e=>new im(e,r)}var Lu="ERR_INVALID_FRAME",F6="ERR_UNREQUESTED_PING",V6="ERR_NOT_MATCHING_PING",q6="ERR_STREAM_ALREADY_EXISTS",H6="ERR_DECODE_INVALID_VERSION",z6="ERR_BOTH_CLIENTS",$6="ERR_RECV_WINDOW_EXCEEDED",iP=new Set([Lu,F6,V6,q6,H6,z6,$6]),Ea="ERR_INVALID_CONFIG",am="ERR_MUXER_LOCAL_CLOSED",G6="ERR_MUXER_REMOTE_CLOSED";var aP="ERR_STREAM_ABORT",cP="ERROR_MAX_OUTBOUND_STREAMS_EXCEEDED",lP="ERR_DECODE_IN_PROGRESS",zp=256*1024,uP=16*1024*1024;var fP={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:zp,maxStreamWindowSize:uP,maxMessageSize:64*1024};function hP(r){if(r.keepAliveInterval<=0)throw new g("keep-alive interval must be positive",Ea);if(r.maxInboundStreams<0)throw new g("max inbound streams must be larger or equal 0",Ea);if(r.maxOutboundStreams<0)throw new g("max outbound streams must be larger or equal 0",Ea);if(r.initialStreamWindowSize<zp)throw new g("InitialStreamWindowSize must be larger or equal 256 kB",Ea);if(r.maxStreamWindowSize<r.initialStreamWindowSize)throw new g("MaxStreamWindowSize must be larger than the InitialStreamWindowSize",Ea);if(r.maxStreamWindowSize>2**32-1)throw new g("MaxStreamWindowSize must be less than equal MAX_UINT32",Ea);if(r.maxMessageSize<1024)throw new g("MaxMessageSize must be greater than a kilobyte",Ea)}var Ut;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(Ut||(Ut={}));var At;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(At||(At={}));var wSe=Object.values(At).filter(r=>typeof r!="string"),pP=0,Wn;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(Wn||(Wn={}));var va=12;var dP=2**24;function MZ(r){if(r[0]!==pP)throw new g("Invalid frame version",H6);return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*dP+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*dP+(r[9]<<16)+(r[10]<<8)+r[11]}}var cm=class{source;buffer;frameInProgress;constructor(e){this.source=UZ(e),this.buffer=new ke,this.frameInProgress=!1}async*emitFrames(){for await(let e of this.source)for(this.buffer.append(e);;){let t=this.readHeader();if(t===void 0)break;let{type:n,length:s}=t;n===Ut.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,s)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new g("decoding frame already in progress",lP);if(this.buffer.length<va)return;let e=MZ(this.buffer.subarray(0,va));return this.buffer.consume(va),e}async readBytes(e){if(this.buffer.length<e){for await(let n of this.source)if(this.buffer.append(n),this.buffer.length>=e)break}let t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function UZ(r){if(r[Symbol.iterator]!==void 0){let e=r[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(r[Symbol.asyncIterator]!==void 0){let e=r[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function W6(r){let e=new Uint8Array(va);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}function mP(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}function lm(r,e){let t=nu(r).return?.();mP(t)&&t.catch(n=>{e.error("could not cause iterator to return",n)})}var FZ="ERR_STREAM_RESET",VZ="ERR_SINK_INVALID_STATE",qZ=5e3;function Y6(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var xa=class{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;log;sinkController;sinkEnd;closed;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;constructor(e){this.sinkController=new AbortController,this.sinkEnd=xe(),this.closed=xe(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??qZ,this.onEnd=e.onEnd,this.onCloseRead=e?.onCloseRead,this.onCloseWrite=e?.onCloseWrite,this.onReset=e?.onReset,this.onAbort=e?.onAbort,this.source=this.streamSource=Tt({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new g(`writable end state is "${this.writeStatus}" not "ready"`,VZ);try{this.writeStatus="writing";let t={signal:this.sinkController.signal};if(this.direction==="outbound"){let s=this.sendNewStream(t);Y6(s)&&await s}let n=()=>{lm(e,this.log)};try{this.sinkController.signal.addEventListener("abort",n),this.log.trace("sink reading from source");for await(let s of e){s=s instanceof Uint8Array?new ke(s):s;let o=this.sendData(s,t);Y6(o)&&await o}}finally{this.sinkController.signal.removeEventListener("abort",n)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.log.trace("closing gracefully"),this.status="closing",await Promise.all([this.closeRead(e),this.closeWrite(e)]),await nn(this.closed.promise,e?.signal),this.status="closed",this.log.trace("closed gracefully")}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);let t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await nn(this.sink([]),e.signal)),this.writeStatus==="writing"&&await new Promise((t,n)=>{queueMicrotask(()=>{this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),nn(this.sinkEnd.promise,e.signal).then(t,n)})}),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");let t=this.sendReset();Y6(t)&&t.catch(n=>{this.log.error("error sending reset message",n)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;let e=new g("stream reset",FZ);this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}};var Yn;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished"})(Yn||(Yn={}));var um=class extends xa{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=Yn.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=zp,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=nc(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&await this.waitForSendWindowCapacity(t),this.status!=="open")return;let n=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-va,e.length),s=this.getSendFlags();this.sendFrame({type:Ut.Data,flag:s,streamID:this._id,length:n},e.sublist(0,n)),this.sendWindowCapacity-=n,e.consume(n)}}async sendReset(){this.sendFrame({type:Ut.WindowUpdate,flag:At.RST,streamID:this._id,length:0})}async sendCloseWrite(){let e=this.getSendFlags()|At.FIN;this.sendFrame({type:Ut.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,n,s=()=>{this.status==="open"?n(new g("stream aborted",aP)):t()};e.signal?.addEventListener("abort",s);try{await new Promise((o,i)=>{this.sendWindowCapacityUpdate=()=>{o()},n=i,t=o})}finally{e.signal?.removeEventListener("abort",s)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);let t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,t===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new g("receive window exceeded",$6,{available:this.recvWindowCapacity,recv:e.length});let n=await t();this.recvWindowCapacity-=e.length,this.sourcePush(n)}processFlags(e){(e&At.ACK)===At.ACK&&this.state===Yn.SYNSent&&(this.state=Yn.Established),(e&At.FIN)===At.FIN&&this.remoteCloseWrite(),(e&At.RST)===At.RST&&this.reset()}getSendFlags(){switch(this.state){case Yn.Init:return this.state=Yn.SYNSent,At.SYN;case Yn.SYNReceived:return this.state=Yn.Established,At.ACK;default:return 0}}sendWindowUpdate(){let e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>-1&&t-this.epochStart<n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;let s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:Ut.WindowUpdate,flag:e,streamID:this._id,length:s})}};var yP="/yamux/1.0.0",HZ=500,fm=class{protocol=yP;_components;_init;constructor(e,t={}){this._components=e,this._init=t}createStreamMuxer(e){return new j6(this._components,{...this._init,...e})}},j6=class{protocol=yP;source;sink;config;log;logger;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e,t){this.client=t.direction==="outbound",this.config={...fP,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),hP(this.config),this.closeController=new AbortController,Ze(1/0,this.closeController.signal),this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=Tt({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(n=>{n.destroy()})}}),this.sink=async n=>{let s=()=>{let a=nu(n);if(a.return!=null){let c=a.return();zZ(c)&&c.catch(l=>{this.log?.("could not cause sink source to return",l)})}},o,i;try{let a=new cm(n);try{this.closeController.signal.addEventListener("abort",s);for await(let c of a.emitFrames())await this.handleFrame(c.header,c.readData)}finally{this.closeController.signal.removeEventListener("abort",s)}o=Wn.NormalTermination}catch(a){let c=a.code;iP.has(c)?(this.log?.error("protocol error in sink",a),o=Wn.ProtocolError):(this.log?.error("internal error in sink",a),o=Wn.InternalError),i=a}this.log?.trace("muxer sink ended"),i!=null?this.abort(i,o):await this.close({reason:o})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(n=>this.log?.error("keepalive error: %s",n)),this.ping().catch(n=>this.log?.error("ping error: %s",n))}get streams(){return Array.from(this._streams.values())}newStream(e){if(this.remoteGoAway!==void 0)throw new g("muxer closed remotely",G6);if(this.localGoAway!==void 0)throw new g("muxer closed locally",am);let t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new g("max outbound streams exceeded",cP);this.log?.trace("new outgoing stream id=%s",t);let n=this._newStream(t,e,Yn.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(this.remoteGoAway!==void 0)throw new g("muxer closed remotely",G6);if(this.localGoAway!==void 0)throw new g("muxer closed locally",am);if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((s,o)=>{let i=()=>{o(new g("muxer closed locally",am))};this.closeController.signal.addEventListener("abort",i,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",i),s()}}),resolve:e};let t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}let n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;let t=e?.reason??Wn.NormalTermination;if(this.log?.trace("muxer close reason=%s",t),e.signal==null){let n=AbortSignal.timeout(HZ);Ze(1/0,n),e={...e,signal:n}}try{await Promise.all([...this._streams.values()].map(async n=>n.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(n){this.abort(n)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??Wn.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(let n of this._streams.values())n.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,s){if(this._streams.get(e)!=null)throw new g("Stream already exists",q6,{id:e});let o=new um({id:e.toString(),name:t,state:n,direction:s,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(o)},log:this.logger.forComponent(`libp2p:yamux:${s}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return o}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){let e=new Promise((t,n)=>{this.closeController.signal.addEventListener("abort",n,{once:!0})});for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let t;try{await Promise.race([e,new Promise(n=>{t=setTimeout(n,this.config.keepAliveInterval)})]),this.ping().catch(n=>this.log?.error("ping error: %s",n))}catch{clearInterval(t);return}}}async handleFrame(e,t){let{streamID:n,type:s,length:o}=e;if(this.log?.trace("received frame %o",e),n===0)switch(s){case Ut.Ping:{this.handlePing(e);return}case Ut.GoAway:{this.handleGoAway(o);return}default:throw new g("Invalid frame type",Lu,{header:e})}else switch(e.type){case Ut.Data:case Ut.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new g("Invalid frame type",Lu,{header:e})}}handlePing(e){if(e.flag===At.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,At.ACK);else if(e.flag===At.ACK)this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new g("Invalid frame flag",Lu,{header:e})}handlePingResponse(e){if(this.activePing===void 0)throw new g("ping not requested",F6);if(this.activePing.id!==e)throw new g("ping doesn't match our id",V6);this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",Wn[e]??"unknown"),this.remoteGoAway=e;for(let t of this._streams.values())t.reset();this._closeMuxer()}async handleStreamMessage(e,t){let{streamID:n,flag:s,type:o}=e;(s&At.SYN)===At.SYN&&this.incomingStream(n);let i=this._streams.get(n);if(i===void 0){if(o===Ut.Data){if(this.log?.("discarding data for stream id=%s",n),t===void 0)throw new Error("unreachable");await t()}else this.log?.("frame for missing stream id=%s",n);return}switch(o){case Ut.WindowUpdate:{i.handleWindowUpdate(e);return}case Ut.Data:{if(t===void 0)throw new Error("unreachable");await i.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new g("both endpoints are clients",z6);if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:Ut.WindowUpdate,flag:At.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:Ut.WindowUpdate,flag:At.RST,streamID:e,length:0});return}let t=this._newStream(e,void 0,Yn.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %o",e),e.type===Ut.Data){if(t===void 0)throw new g("invalid frame",Lu);this.source.push(new ke(W6(e),t))}else this.source.push(W6(e))}sendPing(e,t=At.SYN){t===At.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:Ut.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=Wn.NormalTermination){this.log?.("sending GoAway reason=%s",Wn[e]),this.localGoAway=e,this.sendFrame({type:Ut.GoAway,flag:0,streamID:0,length:e})}};function zZ(r){return r!=null&&typeof r.then=="function"}function gP(r={}){return e=>new fm(e,r)}var bP=Symbol.for("@libp2p/content-routing");var Re=class extends Error{code;props;constructor(e,t,n){super(e),this.code=t,this.name=n?.name??"CodeError",this.props=n??{}}};var Q6=class extends Event{detail;constructor(e,t){super(e,t),this.detail=t?.detail}},u_e=globalThis.CustomEvent??Q6;var wP=(r,...e)=>{try{[...e]}catch{}};var EP=Symbol.for("@libp2p/peer-routing");var An=fe(i0(),1);var tb={};V(tb,{base32:()=>_a,base32hex:()=>JZ,base32hexpad:()=>eee,base32hexpadupper:()=>tee,base32hexupper:()=>ZZ,base32pad:()=>QZ,base32padupper:()=>XZ,base32upper:()=>IP,base32z:()=>ree});function $Z(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var o=r.charAt(s),i=o.charCodeAt(0);if(t[i]!==255)throw new TypeError(o+" is ambiguous");t[i]=s}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function f(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var m=0,y=0,b=0,w=p.length;b!==w&&p[b]===0;)b++,m++;for(var E=(w-b)*u+1>>>0,x=new Uint8Array(E);b!==w;){for(var v=p[b],S=0,A=E-1;(v!==0||S<y)&&A!==-1;A--,S++)v+=256*x[A]>>>0,x[A]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");y=S,b++}for(var _=E-y;_!==E&&x[_]===0;)_++;for(var D=c.repeat(m);_<E;++_)D+=r.charAt(x[_]);return D}function h(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var m=0;if(p[m]!==" "){for(var y=0,b=0;p[m]===c;)y++,m++;for(var w=(p.length-m)*l+1>>>0,E=new Uint8Array(w);p[m];){var x=t[p.charCodeAt(m)];if(x===255)return;for(var v=0,S=w-1;(x!==0||v<b)&&S!==-1;S--,v++)x+=a*E[S]>>>0,E[S]=x%256>>>0,x=x/256>>>0;if(x!==0)throw new Error("Non-zero carry");b=v,m++}if(p[m]!==" "){for(var A=w-b;A!==w&&E[A]===0;)A++;for(var _=new Uint8Array(y+(w-A)),D=y;A!==w;)_[D++]=E[A++];return _}}}function d(p){var m=h(p);if(m)return m;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:h,decode:d}}var GZ=$Z,WZ=GZ,vP=WZ;var d_e=new Uint8Array(0);var xP=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},ui=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var SP=r=>new TextEncoder().encode(r),_P=r=>new TextDecoder().decode(r);var X6=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},J6=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return RP(this,e)}},Z6=class{constructor(e){this.decoders=e}or(e){return RP(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},RP=(r,e)=>new Z6({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}}),eb=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new X6(e,t,n),this.decoder=new J6(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},Ou=({name:r,prefix:e,encode:t,decode:n})=>new eb(r,e,t,n),Sa=({prefix:r,name:e,alphabet:t})=>{let{encode:n,decode:s}=vP(t,e);return Ou({prefix:r,name:e,encode:n,decode:o=>ui(s(o))})},YZ=(r,e,t,n)=>{let s={};for(let u=0;u<e.length;++u)s[e[u]]=u;let o=r.length;for(;r[o-1]==="=";)--o;let i=new Uint8Array(o*t/8|0),a=0,c=0,l=0;for(let u=0;u<o;++u){let f=s[r[u]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|f,a+=t,a>=8&&(a-=8,i[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return i},jZ=(r,e,t)=>{let n=e[e.length-1]==="=",s=(1<<t)-1,o="",i=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],i+=8;i>t;)i-=t,o+=e[s&a>>i];if(i&&(o+=e[s&a<<t-i]),n)for(;o.length*t&7;)o+="=";return o},Ft=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Ou({prefix:e,name:r,encode(s){return jZ(s,n,t)},decode(s){return YZ(s,n,t,r)}});var _a=Ft({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),IP=Ft({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),QZ=Ft({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),XZ=Ft({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),JZ=Ft({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),ZZ=Ft({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),eee=Ft({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),tee=Ft({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),ree=Ft({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var rb={};V(rb,{base58btc:()=>Ar,base58flickr:()=>nee});var Ar=Sa({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),nee=Sa({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var nb={};V(nb,{base64:()=>Ku,base64pad:()=>see,base64url:()=>oee,base64urlpad:()=>iee});var Ku=Ft({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),see=Ft({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),oee=Ft({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),iee=Ft({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});An.default.formatters.b=r=>r==null?"undefined":Ar.baseEncode(r);An.default.formatters.t=r=>r==null?"undefined":_a.baseEncode(r);An.default.formatters.m=r=>r==null?"undefined":Ku.baseEncode(r);An.default.formatters.p=r=>r==null?"undefined":r.toString();An.default.formatters.c=r=>r==null?"undefined":r.toString();An.default.formatters.k=r=>r==null?"undefined":r.toString();An.default.formatters.a=r=>r==null?"undefined":r.toString();function aee(r){let e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function Aa(r){let e=aee(`${r}:trace`);return An.default.enabled(`${r}:trace`)&&An.default.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=(0,An.default)(`${r}:trace`)),Object.assign((0,An.default)(r),{error:(0,An.default)(`${r}:error`),trace:e})}var sb=Symbol.for("@libp2p/peer-id");function TP(r){return r!=null&&!!r[sb]}var ob={};V(ob,{base10:()=>cee});var cee=Sa({prefix:"9",name:"base10",alphabet:"0123456789"});var ib={};V(ib,{base16:()=>lee,base16upper:()=>uee});var lee=Ft({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),uee=Ft({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var ab={};V(ab,{base2:()=>fee});var fee=Ft({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var cb={};V(cb,{base256emoji:()=>yee});var kP=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),hee=kP.reduce((r,e,t)=>(r[t]=e,r),[]),pee=kP.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function dee(r){return r.reduce((e,t)=>(e+=hee[t],e),"")}function mee(r){let e=[];for(let t of r){let n=pee[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}var yee=Ou({prefix:"\u{1F680}",name:"base256emoji",encode:dee,decode:mee});var lb={};V(lb,{base36:()=>hm,base36upper:()=>gee});var hm=Sa({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),gee=Sa({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var ub={};V(ub,{base8:()=>bee});var bee=Ft({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var fb={};V(fb,{identity:()=>wee});var wee=Ou({prefix:"\0",name:"identity",encode:r=>_P(r),decode:r=>SP(r)});var K_e=new TextEncoder,M_e=new TextDecoder;var pb={};V(pb,{identity:()=>co});var xee=CP,DP=128,See=127,_ee=~See,Aee=Math.pow(2,31);function CP(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Aee;)e[t++]=r&255|DP,r/=128;for(;r&_ee;)e[t++]=r&255|DP,r>>>=7;return e[t]=r|0,CP.bytes=t-n+1,e}var Ree=hb,Iee=128,PP=127;function hb(r,n){var t=0,n=n||0,s=0,o=n,i,a=r.length;do{if(o>=a)throw hb.bytes=0,new RangeError("Could not decode varint");i=r[o++],t+=s<28?(i&PP)<<s:(i&PP)*Math.pow(2,s),s+=7}while(i>=Iee);return hb.bytes=o-n,t}var Tee=Math.pow(2,7),kee=Math.pow(2,14),Dee=Math.pow(2,21),Pee=Math.pow(2,28),Cee=Math.pow(2,35),Bee=Math.pow(2,42),Nee=Math.pow(2,49),Lee=Math.pow(2,56),Oee=Math.pow(2,63),Kee=function(r){return r<Tee?1:r<kee?2:r<Dee?3:r<Pee?4:r<Cee?5:r<Bee?6:r<Nee?7:r<Lee?8:r<Oee?9:10},Mee={encode:xee,decode:Ree,encodingLength:Kee},Uee=Mee,$p=Uee;var Gp=(r,e=0)=>[$p.decode(r,e),$p.decode.bytes],Mu=(r,e,t=0)=>($p.encode(r,e,t),e),Uu=r=>$p.encodingLength(r);var ao=(r,e)=>{let t=e.byteLength,n=Uu(r),s=n+Uu(t),o=new Uint8Array(s+t);return Mu(r,o,0),Mu(t,o,n),o.set(e,s),new Fu(r,t,e,o)},Vu=r=>{let e=ui(r),[t,n]=Gp(e),[s,o]=Gp(e.subarray(n)),i=e.subarray(n+o);if(i.byteLength!==s)throw new Error("Incorrect length");return new Fu(t,s,i,e)},BP=(r,e)=>{if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&xP(r.bytes,t.bytes)}},Fu=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};var NP=0,Fee="identity",LP=ui,Vee=r=>ao(NP,LP(r)),co={code:NP,name:Fee,encode:LP,digest:Vee};var yb={};V(yb,{sha256:()=>Rr,sha512:()=>qee});var mb=({name:r,code:e,encode:t})=>new db(r,e,t),db=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?ao(this.code,t):t.then(n=>ao(this.code,n))}else throw Error("Unknown type, must be binary type")}};var KP=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Rr=mb({name:"sha2-256",code:18,encode:KP("SHA-256")}),qee=mb({name:"sha2-512",code:19,encode:KP("SHA-512")});var MP=(r,e)=>{let{bytes:t,version:n}=r;switch(n){case 0:return zee(t,gb(r),e||Ar.encoder);default:return $ee(t,gb(r),e||_a.encoder)}};var UP=new WeakMap,gb=r=>{let e=UP.get(r);if(e==null){let t=new Map;return UP.set(r,t),t}return e},Ps=class r{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==Wp)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Gee)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=ao(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n&&e.code===n.code&&e.version===n.version&&BP(e.multihash,n.multihash)}toString(e){return MP(this,e)}toJSON(){return{"/":MP(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:s,multihash:o,bytes:i}=t;return new r(n,s,o,i||FP(n,s,o.bytes))}else if(t[Wee]===!0){let{version:n,multihash:s,code:o}=t,i=Vu(s);return r.create(n,o,i)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Wp)throw new Error(`Version 0 CID must use dag-pb (code: ${Wp}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let s=FP(e,t,n.bytes);return new r(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,Wp,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,s=ui(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");let o=s.subarray(t.multihashSize-t.digestSize),i=new Fu(t.multihashCode,t.digestSize,o,s);return[t.version===0?r.createV0(i):r.createV1(t.codec,i),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[f,h]=Gp(e.subarray(t));return t+=h,f},s=n(),o=Wp;if(s===18?(s=0,t=0):o=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);let i=t,a=n(),c=n(),l=t+c,u=l-i;return{version:s,codec:o,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){let[n,s]=Hee(e,t),o=r.decode(s);if(o.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return gb(o).set(n,e),o}},Hee=(r,e)=>{switch(r[0]){case"Q":{let t=e||Ar;return[Ar.prefix,t.decode(`${Ar.prefix}${r}`)]}case Ar.prefix:{let t=e||Ar;return[Ar.prefix,t.decode(r)]}case _a.prefix:{let t=e||_a;return[_a.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},zee=(r,e,t)=>{let{prefix:n}=t;if(n!==Ar.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let s=e.get(n);if(s==null){let o=t.encode(r).slice(1);return e.set(n,o),o}else return s},$ee=(r,e,t)=>{let{prefix:n}=t,s=e.get(n);if(s==null){let o=t.encode(r);return e.set(n,o),o}else return s},Wp=112,Gee=18,FP=(r,e,t)=>{let n=Uu(r),s=n+Uu(e),o=new Uint8Array(s+t.byteLength);return Mu(r,o,0),Mu(e,o,n),o.set(t,s),o},Wee=Symbol.for("@ipld/js-cid/CID");var qu={...fb,...ab,...ub,...ob,...ib,...tb,...lb,...rb,...nb,...cb},eAe={...yb,...pb};function Zr(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}var Yee=Symbol.for("nodejs.util.inspect.custom"),VP=Object.values(qu).map(r=>r.decoder).reduce((r,e)=>r.or(e),qu.identity.decoder),qP=114,bb=36,wb=37,Yp=class{type;multihash;privateKey;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[sb]=!0;toString(){return this.string==null&&(this.string=Ar.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return Ps.createV1(qP,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){if(e instanceof Uint8Array)return Zr(this.multihash.bytes,e);if(typeof e=="string")return Gu(e).equals(this);if(e?.multihash?.bytes!=null)return Zr(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[Yee](){return`PeerId(${this.toString()})`}},Hu=class extends Yp{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},zu=class extends Yp{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.multihash.digest}},$u=class extends Yp{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.multihash.digest}};function Gu(r,e){if(e=e??VP,r.charAt(0)==="1"||r.charAt(0)==="Q"){let t=Vu(Ar.decode(`z${r}`));return r.startsWith("12D")?new zu({multihash:t}):r.startsWith("16U")?new $u({multihash:t}):new Hu({multihash:t})}return jp(VP.decode(r))}function jp(r){try{let e=Vu(r);if(e.code===co.code){if(e.digest.length===bb)return new zu({multihash:e});if(e.digest.length===wb)return new $u({multihash:e})}if(e.code===Rr.code)return new Hu({multihash:e})}catch{return jee(Ps.decode(r))}throw new Error("Supplied PeerID CID is invalid")}function jee(r){if(r==null||r.multihash==null||r.version==null||r.version===1&&r.code!==qP)throw new Error("Supplied PeerID CID is invalid");let e=r.multihash;if(e.code===Rr.code)return new Hu({multihash:r.multihash});if(e.code===co.code){if(e.digest.length===bb)return new zu({multihash:r.multihash});if(e.digest.length===wb)return new $u({multihash:r.multihash})}throw new Error("Supplied PeerID CID is invalid")}async function HP(r,e){return r.length===bb?new zu({multihash:ao(co.code,r),privateKey:e}):r.length===wb?new $u({multihash:ao(co.code,r),privateKey:e}):new Hu({multihash:await Rr.digest(r),publicKey:r,privateKey:e})}function zP(r){r=Eb(r);let e=[],t=[],n=null,s=r.split("/").slice(1);if(s.length===1&&s[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let o=0;o<s.length;o++){let i=s[o],a=ve(i);if(a.size===0){e.push([a.code]),t.push([a.code]);continue}if(o++,o>=s.length)throw GP("invalid address: "+r);if(a.path===!0){n=Eb(s.slice(o).join("/")),e.push([a.code,w6(a.code,n)]),t.push([a.code,n]);break}let c=w6(a.code,s[o]);e.push([a.code,c]),t.push([a.code,Mp(a.code,c)])}return{string:$P(t),bytes:xb(e),tuples:e,stringTuples:t,path:n}}function vb(r){let e=[],t=[],n=null,s=0;for(;s<r.length;){let o=gn(r,s),i=Jt(o),a=ve(o),c=Qee(a,r.slice(s+i));if(c===0){e.push([o]),t.push([o]),s+=i;continue}let l=r.slice(s+i,s+i+c);if(s+=c+i,s>r.length)throw GP("Invalid address Uint8Array: "+T(r,"base16"));e.push([o,l]);let u=Mp(o,l);if(t.push([o,u]),a.path===!0){n=u;break}}return{bytes:Uint8Array.from(r),string:$P(t),tuples:e,stringTuples:t,path:n}}function $P(r){let e=[];return r.map(t=>{let n=ve(t[0]);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),Eb(e.join("/"))}function xb(r){return le(r.map(e=>{let t=ve(e[0]),n=Uint8Array.from(Zt(t.code));return e.length>1&&e[1]!=null&&(n=le([n,e[1]])),n}))}function Qee(r,e){if(r.size>0)return r.size/8;if(r.size===0)return 0;{let t=gn(e instanceof Uint8Array?e:Uint8Array.from(e));return t+Jt(t)}}function Eb(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function GP(r){return new Error("Error parsing address: "+r)}var Xee=Symbol.for("nodejs.util.inspect.custom"),Sb=Symbol.for("@multiformats/js-multiaddr/multiaddr"),Jee=[ve("dns").code,ve("dns4").code,ve("dns6").code,ve("dnsaddr").code],dm=class r{bytes;#e;#t;#r;#i;[Sb]=!0;constructor(e){e==null&&(e="");let t;if(e instanceof Uint8Array)t=vb(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);t=zP(e)}else if(Ra(e))t=vb(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=t.bytes,this.#e=t.string,this.#t=t.tuples,this.#r=t.stringTuples,this.#i=t.path}toString(){return this.#e}toJSON(){return this.toString()}toOptions(){let e,t,n,s,o="",i=ve("tcp"),a=ve("udp"),c=ve("ip4"),l=ve("ip6"),u=ve("dns6"),f=ve("ip6zone");for(let[d,p]of this.stringTuples())d===f.code&&(o=`%${p??""}`),Jee.includes(d)&&(t=i.name,s=443,n=`${p??""}${o}`,e=d===u.code?6:4),(d===i.code||d===a.code)&&(t=ve(d).name,s=parseInt(p??"")),(d===c.code||d===l.code)&&(t=ve(d).name,n=`${p??""}${o}`,e=d===l.code?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return this.#t.map(([e])=>Object.assign({},ve(e)))}protoCodes(){return this.#t.map(([e])=>e)}protoNames(){return this.#t.map(([e])=>ve(e).name)}tuples(){return this.#t}stringTuples(){return this.#r}encapsulate(e){return e=new r(e),new r(this.toString()+e.toString())}decapsulate(e){let t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new r(n.slice(0,s))}decapsulateCode(e){let t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new r(xb(t.slice(0,n)));return this}getPeerId(){try{let e=[];this.stringTuples().forEach(([n,s])=>{n===Tu.p2p.code&&e.push([n,s]),n===Tu["p2p-circuit"].code&&(e=[])});let t=e.pop();if(t?.[1]!=null){let n=t[1];return n[0]==="Q"||n[0]==="1"?T(Fe.decode(`z${n}`),"base58btc"):T(Ve.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return this.#i}equals(e){return q(this.bytes,e.bytes)}async resolve(e){let t=this.protos().find(o=>o.resolvable);if(t==null)return[this];let n=mm.get(t.name);if(n==null)throw new g(`no available resolver for ${t.name}`,"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(o=>new r(o))}nodeAddress(){let e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){let t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[Xee](){return`Multiaddr(${this.#e})`}};var mm=new Map;function Ra(r){return!!r?.[Sb]}function me(r){return new dm(r)}async function*ym(r,e={}){let t=r.getReader();try{for(;;){let n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}var wIe=fe(xc(),1),EIe=fe(r5(),1);var vte=fe(Ge(),1);function Wu(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}function gm(r=0){return globalThis.Buffer?.allocUnsafe!=null?Wu(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function YP(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var WP=YP("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),_b=YP("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=gm(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),Zee={utf8:WP,"utf-8":WP,hex:qu.base16,latin1:_b,ascii:_b,binary:_b,...qu},bm=Zee;function en(r,e="utf8"){let t=bm[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?Wu(globalThis.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}var Tb={};V(Tb,{Ed25519PrivateKey:()=>Hc,Ed25519PublicKey:()=>Qp,generateKeyPair:()=>nte,generateKeyPairFromSeed:()=>tC,unmarshalEd25519PrivateKey:()=>tte,unmarshalEd25519PublicKey:()=>rte});var Yu=32,fi=64,wm=32;async function jP(){let r=De.utils.randomPrivateKey(),e=De.getPublicKey(r);return{privateKey:ZP(r,e),publicKey:e}}async function QP(r){if(r.length!==wm)throw new TypeError('"seed" must be 32 bytes in length.');if(!(r instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');let e=r,t=De.getPublicKey(e);return{privateKey:ZP(e,t),publicKey:t}}async function XP(r,e){let t=r.subarray(0,wm);return De.sign(e,t)}async function JP(r,e,t){return De.verify(e,t,r)}function ZP(r,e){let t=new Uint8Array(fi);for(let n=0;n<wm;n++)t[n]=r[n],t[wm+n]=e[n];return t}function qc(r,e){e==null&&(e=r.reduce((s,o)=>s+o.length,0));let t=gm(e),n=0;for(let s of r)t.set(s,n),n+=s.length;return Wu(t)}var un={get(r=globalThis){let e=r.crypto;if(e==null||e.subtle==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p-crypto/blob/master/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}};var Ab={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function Rb(r){let e=r?.algorithm??"AES-GCM",t=r?.keyLength??16,n=r?.nonceLength??12,s=r?.digest??"SHA-256",o=r?.saltLength??16,i=r?.iterations??32767,a=un.get();t*=8;async function c(f,h){let d=a.getRandomValues(new Uint8Array(o)),p=a.getRandomValues(new Uint8Array(n)),m={name:e,iv:p};typeof h=="string"&&(h=en(h));let y;if(h.length===0){y=await a.subtle.importKey("jwk",Ab,{name:"AES-GCM"},!0,["encrypt"]);try{let w={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}catch{y=await a.subtle.importKey("jwk",Ab,{name:"AES-GCM"},!0,["encrypt"])}}else{let w={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}let b=await a.subtle.encrypt(m,y,f);return qc([d,m.iv,new Uint8Array(b)])}async function l(f,h){let d=f.subarray(0,o),p=f.subarray(o,o+n),m=f.subarray(o+n),y={name:e,iv:p};typeof h=="string"&&(h=en(h));let b;if(h.length===0)try{let E={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},x=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(E,x,{name:e,length:t},!0,["decrypt"])}catch{b=await a.subtle.importKey("jwk",Ab,{name:"AES-GCM"},!0,["decrypt"])}else{let E={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},x=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(E,x,{name:e,length:t},!0,["decrypt"])}let w=await a.subtle.decrypt(y,b,m);return new Uint8Array(w)}return{encrypt:c,decrypt:l}}async function ju(r,e){let n=await Rb().encrypt(r,e);return Ku.encode(n)}var $t;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.Secp256k1="Secp256k1"})($t||($t={}));var Ib;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.Secp256k1=2]="Secp256k1"})(Ib||(Ib={}));(function(r){r.codec=()=>Te(Ib)})($t||($t={}));var lo;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),$t.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=$t.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(lo||(lo={}));var hi;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),$t.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=$t.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(hi||(hi={}));var Qp=class{_key;constructor(e){this._key=Qu(e,Yu)}async verify(e,t){return JP(this._key,t,e)}marshal(){return this._key}get bytes(){return lo.encode({Type:$t.Ed25519,Data:this.marshal()}).subarray()}equals(e){return Zr(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Rr.digest(this.bytes);return e}},Hc=class{_key;_publicKey;constructor(e,t){this._key=Qu(e,fi),this._publicKey=Qu(t,Yu)}async sign(e){return XP(this._key,e)}get public(){return new Qp(this._publicKey)}marshal(){return this._key}get bytes(){return hi.encode({Type:$t.Ed25519,Data:this.marshal()}).subarray()}equals(e){return Zr(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Rr.digest(this.bytes);return e}async id(){let e=co.digest(this.public.bytes);return Ar.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if(t==="libp2p-key")return ju(this.bytes,e);throw new Re(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function tte(r){if(r.length>fi){r=Qu(r,fi+Yu);let n=r.subarray(0,fi),s=r.subarray(fi,r.length);return new Hc(n,s)}r=Qu(r,fi);let e=r.subarray(0,fi),t=r.subarray(Yu);return new Hc(e,t)}function rte(r){return r=Qu(r,Yu),new Qp(r)}async function nte(){let{privateKey:r,publicKey:e}=await jP();return new Hc(r,e)}async function tC(r){let{privateKey:e,publicKey:t}=await QP(r);return new Hc(e,t)}function Qu(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new Re(`Key must be a Uint8Array of length ${e}, got ${r.length}`,"ERR_INVALID_KEY_TYPE");return r}function Rn(r,e="utf8"){let t=bm[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):t.encoder.encode(r).substring(1)}var uRe=fe(Kt(),1),fRe=fe(fp(),1),rC=fe(Ge(),1);function Cs(r,e){let t=Uint8Array.from(r.abs().toByteArray());if(t=t[0]===0?t.subarray(1):t,e!=null){if(t.length>e)throw new Error("byte array longer than desired length");t=qc([new Uint8Array(e-t.length),t])}return Rn(t,"base64url")}function In(r){let e=nC(r);return new rC.default.jsbn.BigInteger(Rn(e,"base16"),16)}function nC(r,e){let t=en(r,"base64urlpad");if(e!=null){if(t.length>e)throw new Error("byte array longer than desired length");t=qc([new Uint8Array(e-t.length),t])}return t}var ste={"P-256":256,"P-384":384,"P-521":521},ote=Object.keys(ste),xRe=ote.join(" / ");var Pb={};V(Pb,{MAX_KEY_SIZE:()=>Zp,RsaPrivateKey:()=>Xu,RsaPublicKey:()=>Jp,fromJwk:()=>mte,generateKeyPair:()=>yte,unmarshalRsaPrivateKey:()=>pte,unmarshalRsaPublicKey:()=>dte});var Xp=fe(Ge(),1);var oIe=fe(A5(),1);function vm(r){if(isNaN(r)||r<=0)throw new Re("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return zt(r)}var VRe=fe(cu(),1),kb=fe(Ge(),1);function sC(r,e){return e.map(t=>In(r[t]))}function oC(r){return kb.default.pki.setRsaPrivateKey(...sC(r,["n","e","d","p","q","dp","dq","qi"]))}function iC(r){return kb.default.pki.setRsaPublicKey(...sC(r,["n","e"]))}var zc={};V(zc,{jwkToPkcs1:()=>cte,jwkToPkix:()=>ute,pkcs1ToJwk:()=>ate,pkixToJwk:()=>lte});var zRe=fe(xc(),1),$Re=fe(cu(),1);var pi=fe(Ge(),1);function ate(r){let e=pi.default.asn1.fromDer(Rn(r,"ascii")),t=pi.default.pki.privateKeyFromAsn1(e);return{kty:"RSA",n:Cs(t.n),e:Cs(t.e),d:Cs(t.d),p:Cs(t.p),q:Cs(t.q),dp:Cs(t.dP),dq:Cs(t.dQ),qi:Cs(t.qInv),alg:"RS256"}}function cte(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new Re("JWK was missing components","ERR_INVALID_PARAMETERS");let e=pi.default.pki.privateKeyToAsn1({n:In(r.n),e:In(r.e),d:In(r.d),p:In(r.p),q:In(r.q),dP:In(r.dp),dQ:In(r.dq),qInv:In(r.qi)});return en(pi.default.asn1.toDer(e).getBytes(),"ascii")}function lte(r){let e=pi.default.asn1.fromDer(Rn(r,"ascii")),t=pi.default.pki.publicKeyFromAsn1(e);return{kty:"RSA",n:Cs(t.n),e:Cs(t.e)}}function ute(r){if(r.n==null||r.e==null)throw new Re("JWK was missing components","ERR_INVALID_PARAMETERS");let e=pi.default.pki.publicKeyToAsn1({n:In(r.n),e:In(r.e)});return en(pi.default.asn1.toDer(e).getBytes(),"ascii")}async function aC(r){let e=await un.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await uC(e);return{privateKey:t[0],publicKey:t[1]}}async function Db(r){let t=[await un.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await fte(r)],n=await uC({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function cC(r,e){let t=await un.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await un.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,Uint8Array.from(e));return new Uint8Array(n,0,n.byteLength)}async function lC(r,e,t){let n=await un.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return un.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,e,t)}async function uC(r){if(r.privateKey==null||r.publicKey==null)throw new Re("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([un.get().subtle.exportKey("jwk",r.privateKey),un.get().subtle.exportKey("jwk",r.publicKey)])}async function fte(r){return un.get().subtle.importKey("jwk",{kty:r.kty,n:r.n,e:r.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function fC(r,e,t,n){let s=e?iC(r):oC(r),o=Rn(Uint8Array.from(t),"ascii"),i=n(o,s);return en(i,"ascii")}function hC(r,e){return fC(r,!0,e,(t,n)=>n.encrypt(t))}function pC(r,e){return fC(r,!1,e,(t,n)=>n.decrypt(t))}function xm(r){if(r.kty!=="RSA")throw new Re("invalid key type","ERR_INVALID_KEY_TYPE");if(r.n==null)throw new Re("invalid key modulus","ERR_INVALID_KEY_MODULUS");return en(r.n,"base64url").length*8}var Zp=8192,Jp=class{_key;constructor(e){this._key=e}async verify(e,t){return lC(this._key,t,e)}marshal(){return zc.jwkToPkix(this._key)}get bytes(){return lo.encode({Type:$t.RSA,Data:this.marshal()}).subarray()}encrypt(e){return hC(this._key,e)}equals(e){return Zr(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Rr.digest(this.bytes);return e}},Xu=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t}genSecret(){return vm(16)}async sign(e){return cC(this._key,e)}get public(){if(this._publicKey==null)throw new Re("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new Jp(this._publicKey)}decrypt(e){return pC(this._key,e)}marshal(){return zc.jwkToPkcs1(this._key)}get bytes(){return hi.encode({Type:$t.RSA,Data:this.marshal()}).subarray()}equals(e){return Zr(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Rr.digest(this.bytes);return e}async id(){let e=await this.public.hash();return Rn(e,"base58btc")}async export(e,t="pkcs-8"){if(t==="pkcs-8"){let n=new Xp.default.util.ByteBuffer(this.marshal()),s=Xp.default.asn1.fromDer(n),o=Xp.default.pki.privateKeyFromAsn1(s),i={algorithm:"aes256",count:1e4,saltSize:128/8,prfAlgorithm:"sha512"};return Xp.default.pki.encryptRsaPrivateKey(o,e,i)}else{if(t==="libp2p-key")return ju(this.bytes,e);throw new Re(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}};async function pte(r){let e=zc.pkcs1ToJwk(r);if(xm(e)>Zp)throw new Re("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let t=await Db(e);return new Xu(t.privateKey,t.publicKey)}function dte(r){let e=zc.pkixToJwk(r);if(xm(e)>Zp)throw new Re("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new Jp(e)}async function mte(r){if(xm(r)>Zp)throw new Re("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await Db(r);return new Xu(e.privateKey,e.publicKey)}async function yte(r){if(r>Zp)throw new Re("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await aC(r);return new Xu(e.privateKey,e.publicKey)}var Bb={};V(Bb,{Secp256k1PrivateKey:()=>td,Secp256k1PublicKey:()=>ed,generateKeyPair:()=>Ete,unmarshalSecp256k1PrivateKey:()=>bte,unmarshalSecp256k1PublicKey:()=>wte});function dC(){return ae.utils.randomPrivateKey()}async function mC(r,e){let{digest:t}=await Rr.digest(e);try{return ae.sign(t,r).toDERRawBytes()}catch(n){throw new Re(String(n),"ERR_INVALID_INPUT")}}async function yC(r,e,t){try{let{digest:n}=await Rr.digest(t);return ae.verify(e,n,r)}catch(n){throw new Re(String(n),"ERR_INVALID_INPUT")}}function gC(r){return ae.ProjectivePoint.fromHex(r).toRawBytes(!0)}function bC(r){try{ae.getPublicKey(r,!0)}catch(e){throw new Re(String(e),"ERR_INVALID_PRIVATE_KEY")}}function Cb(r){try{ae.ProjectivePoint.fromHex(r)}catch(e){throw new Re(String(e),"ERR_INVALID_PUBLIC_KEY")}}function wC(r){try{return ae.getPublicKey(r,!0)}catch(e){throw new Re(String(e),"ERR_INVALID_PRIVATE_KEY")}}var ed=class{_key;constructor(e){Cb(e),this._key=e}async verify(e,t){return yC(this._key,t,e)}marshal(){return gC(this._key)}get bytes(){return lo.encode({Type:$t.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return Zr(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Rr.digest(this.bytes);return e}},td=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t??wC(e),bC(this._key),Cb(this._publicKey)}async sign(e){return mC(this._key,e)}get public(){return new ed(this._publicKey)}marshal(){return this._key}get bytes(){return hi.encode({Type:$t.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return Zr(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Rr.digest(this.bytes);return e}async id(){let e=await this.public.hash();return Rn(e,"base58btc")}async export(e,t="libp2p-key"){if(t==="libp2p-key")return ju(this.bytes,e);throw new Re(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function bte(r){return new td(r)}function wte(r){return new ed(r)}async function Ete(){let r=dC();return new td(r)}var Sm={rsa:Pb,ed25519:Tb,secp256k1:Bb};function xte(r){let e=Object.keys(Sm).join(" / ");return new Re(`invalid or unsupported key type ${r}. Must be ${e}`,"ERR_UNSUPPORTED_KEY_TYPE")}function Nb(r){let e=lo.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case $t.RSA:return Sm.rsa.unmarshalRsaPublicKey(t);case $t.Ed25519:return Sm.ed25519.unmarshalEd25519PublicKey(t);case $t.Secp256k1:return Sm.secp256k1.unmarshalSecp256k1PublicKey(t);default:throw xte(e.Type??"unknown")}}var Nre=fe(No(),1);var Lre=fe(_m(),1);function Am(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function $c(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}var Fb={};V(Fb,{base10:()=>Tte});var PIe=new Uint8Array(0);function EC(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function di(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function vC(r){return new TextEncoder().encode(r)}function xC(r){return new TextDecoder().decode(r)}function Ste(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var o=r.charAt(s),i=o.charCodeAt(0);if(t[i]!==255)throw new TypeError(o+" is ambiguous");t[i]=s}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function f(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var m=0,y=0,b=0,w=p.length;b!==w&&p[b]===0;)b++,m++;for(var E=(w-b)*u+1>>>0,x=new Uint8Array(E);b!==w;){for(var v=p[b],S=0,A=E-1;(v!==0||S<y)&&A!==-1;A--,S++)v+=256*x[A]>>>0,x[A]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");y=S,b++}for(var _=E-y;_!==E&&x[_]===0;)_++;for(var D=c.repeat(m);_<E;++_)D+=r.charAt(x[_]);return D}function h(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var m=0;if(p[m]!==" "){for(var y=0,b=0;p[m]===c;)y++,m++;for(var w=(p.length-m)*l+1>>>0,E=new Uint8Array(w);p[m];){var x=t[p.charCodeAt(m)];if(x===255)return;for(var v=0,S=w-1;(x!==0||v<b)&&S!==-1;S--,v++)x+=a*E[S]>>>0,E[S]=x%256>>>0,x=x/256>>>0;if(x!==0)throw new Error("Non-zero carry");b=v,m++}if(p[m]!==" "){for(var A=w-b;A!==w&&E[A]===0;)A++;for(var _=new Uint8Array(y+(w-A)),D=y;A!==w;)_[D++]=E[A++];return _}}}function d(p){var m=h(p);if(m)return m;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:h,decode:d}}var _te=Ste,Ate=_te,_C=Ate;var Ob=class{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Kb=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return AC(this,e)}},Mb=class{decoders;constructor(e){this.decoders=e}or(e){return AC(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function AC(r,e){return new Mb({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}var Ub=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new Ob(e,t,n),this.decoder=new Kb(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function Ju({name:r,prefix:e,encode:t,decode:n}){return new Ub(r,e,t,n)}function Ia({name:r,prefix:e,alphabet:t}){let{encode:n,decode:s}=_C(t,r);return Ju({prefix:e,name:r,encode:n,decode:o=>di(s(o))})}function Rte(r,e,t,n){let s={};for(let u=0;u<e.length;++u)s[e[u]]=u;let o=r.length;for(;r[o-1]==="=";)--o;let i=new Uint8Array(o*t/8|0),a=0,c=0,l=0;for(let u=0;u<o;++u){let f=s[r[u]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|f,a+=t,a>=8&&(a-=8,i[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return i}function Ite(r,e,t){let n=e[e.length-1]==="=",s=(1<<t)-1,o="",i=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],i+=8;i>t;)i-=t,o+=e[s&a>>i];if(i!==0&&(o+=e[s&a<<t-i]),n)for(;o.length*t&7;)o+="=";return o}function Vt({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return Ju({prefix:e,name:r,encode(s){return Ite(s,n,t)},decode(s){return Rte(s,n,t,r)}})}var Tte=Ia({prefix:"9",name:"base10",alphabet:"0123456789"});var Vb={};V(Vb,{base16:()=>kte,base16upper:()=>Dte});var kte=Vt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Dte=Vt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var qb={};V(qb,{base2:()=>Pte});var Pte=Vt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Hb={};V(Hb,{base256emoji:()=>Ote});var RC=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),Cte=RC.reduce((r,e,t)=>(r[t]=e,r),[]),Bte=RC.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function Nte(r){return r.reduce((e,t)=>(e+=Cte[t],e),"")}function Lte(r){let e=[];for(let t of r){let n=Bte[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}var Ote=Ju({prefix:"\u{1F680}",name:"base256emoji",encode:Nte,decode:Lte});var zb={};V(zb,{base32:()=>Zu,base32hex:()=>Fte,base32hexpad:()=>qte,base32hexpadupper:()=>Hte,base32hexupper:()=>Vte,base32pad:()=>Mte,base32padupper:()=>Ute,base32upper:()=>Kte,base32z:()=>zte});var Zu=Vt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Kte=Vt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Mte=Vt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Ute=Vt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Fte=Vt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Vte=Vt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),qte=Vt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Hte=Vt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),zte=Vt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var $b={};V($b,{base36:()=>$te,base36upper:()=>Gte});var $te=Ia({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Gte=Ia({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var Gb={};V(Gb,{base58btc:()=>uo,base58flickr:()=>Wte});var uo=Ia({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Wte=Ia({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Wb={};V(Wb,{base64:()=>Yte,base64pad:()=>jte,base64url:()=>Qte,base64urlpad:()=>Xte});var Yte=Vt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),jte=Vt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Qte=Vt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Xte=Vt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var Yb={};V(Yb,{base8:()=>Jte});var Jte=Vt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var jb={};V(jb,{identity:()=>Zte});var Zte=Ju({prefix:"\0",name:"identity",encode:r=>xC(r),decode:r=>vC(r)});var WIe=new TextEncoder,YIe=new TextDecoder;var Xb={};V(Xb,{identity:()=>xre});var rre=kC,IC=128,nre=127,sre=~nre,ore=Math.pow(2,31);function kC(r,e,t){e=e||[],t=t||0;for(var n=t;r>=ore;)e[t++]=r&255|IC,r/=128;for(;r&sre;)e[t++]=r&255|IC,r>>>=7;return e[t]=r|0,kC.bytes=t-n+1,e}var ire=Qb,are=128,TC=127;function Qb(r,n){var t=0,n=n||0,s=0,o=n,i,a=r.length;do{if(o>=a)throw Qb.bytes=0,new RangeError("Could not decode varint");i=r[o++],t+=s<28?(i&TC)<<s:(i&TC)*Math.pow(2,s),s+=7}while(i>=are);return Qb.bytes=o-n,t}var cre=Math.pow(2,7),lre=Math.pow(2,14),ure=Math.pow(2,21),fre=Math.pow(2,28),hre=Math.pow(2,35),pre=Math.pow(2,42),dre=Math.pow(2,49),mre=Math.pow(2,56),yre=Math.pow(2,63),gre=function(r){return r<cre?1:r<lre?2:r<ure?3:r<fre?4:r<hre?5:r<pre?6:r<dre?7:r<mre?8:r<yre?9:10},bre={encode:rre,decode:ire,encodingLength:gre},wre=bre,rd=wre;function nd(r,e=0){return[rd.decode(r,e),rd.decode.bytes]}function ef(r,e,t=0){return rd.encode(r,e,t),e}function tf(r){return rd.encodingLength(r)}function Gc(r,e){let t=e.byteLength,n=tf(r),s=n+tf(t),o=new Uint8Array(s+t);return ef(r,o,0),ef(t,o,n),o.set(e,s),new rf(r,t,e,o)}function DC(r){let e=di(r),[t,n]=nd(e),[s,o]=nd(e.subarray(n)),i=e.subarray(n+o);if(i.byteLength!==s)throw new Error("Incorrect length");return new rf(t,s,i,e)}function PC(r,e){if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&EC(r.bytes,t.bytes)}}var rf=class{code;size;digest;bytes;constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};var CC=0,Ere="identity",BC=di;function vre(r){return Gc(CC,BC(r))}var xre={code:CC,name:Ere,encode:BC,digest:vre};var ew={};V(ew,{sha256:()=>Sre,sha512:()=>_re});function Zb({name:r,code:e,encode:t}){return new Jb(r,e,t)}var Jb=class{name;code;encode;constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?Gc(this.code,t):t.then(n=>Gc(this.code,n))}else throw Error("Unknown type, must be binary type")}};function LC(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}var Sre=Zb({name:"sha2-256",code:18,encode:LC("SHA-256")}),_re=Zb({name:"sha2-512",code:19,encode:LC("SHA-512")});function OC(r,e){let{bytes:t,version:n}=r;switch(n){case 0:return Rre(t,tw(r),e??uo.encoder);default:return Ire(t,tw(r),e??Zu.encoder)}}var KC=new WeakMap;function tw(r){let e=KC.get(r);if(e==null){let t=new Map;return KC.set(r,t),t}return e}var Im=class r{code;version;multihash;bytes;"/";constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==od)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Tre)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=Gc(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n!=null&&e.code===n.code&&e.version===n.version&&PC(e.multihash,n.multihash)}toString(e){return OC(this,e)}toJSON(){return{"/":OC(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:s,multihash:o,bytes:i}=t;return new r(n,s,o,i??MC(n,s,o.bytes))}else if(t[kre]===!0){let{version:n,multihash:s,code:o}=t,i=DC(s);return r.create(n,o,i)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==od)throw new Error(`Version 0 CID must use dag-pb (code: ${od}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let s=MC(e,t,n.bytes);return new r(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,od,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,s=di(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");let o=s.subarray(t.multihashSize-t.digestSize),i=new rf(t.multihashCode,t.digestSize,o,s);return[t.version===0?r.createV0(i):r.createV1(t.codec,i),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[f,h]=nd(e.subarray(t));return t+=h,f},s=n(),o=od;if(s===18?(s=0,t=0):o=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);let i=t,a=n(),c=n(),l=t+c,u=l-i;return{version:s,codec:o,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){let[n,s]=Are(e,t),o=r.decode(s);if(o.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return tw(o).set(n,e),o}};function Are(r,e){switch(r[0]){case"Q":{let t=e??uo;return[uo.prefix,t.decode(`${uo.prefix}${r}`)]}case uo.prefix:{let t=e??uo;return[uo.prefix,t.decode(r)]}case Zu.prefix:{let t=e??Zu;return[Zu.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function Rre(r,e,t){let{prefix:n}=t;if(n!==uo.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let s=e.get(n);if(s==null){let o=t.encode(r).slice(1);return e.set(n,o),o}else return s}function Ire(r,e,t){let{prefix:n}=t,s=e.get(n);if(s==null){let o=t.encode(r);return e.set(n,o),o}else return s}var od=112,Tre=18;function MC(r,e,t){let n=tf(r),s=n+tf(e),o=new Uint8Array(s+t.byteLength);return ef(r,o,0),ef(e,o,n),o.set(t,s),o}var kre=Symbol.for("@ipld/js-cid/CID");var rw={...jb,...qb,...Yb,...Fb,...Vb,...zb,...$b,...Gb,...Wb,...Hb},mTe={...ew,...Xb};function Tm(r=0){return globalThis.Buffer?.allocUnsafe!=null?$c(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function FC(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var UC=FC("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),nw=FC("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=Tm(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),Dre={utf8:UC,"utf-8":UC,hex:rw.base16,latin1:nw,ascii:nw,binary:nw,...rw},km=Dre;function nf(r,e="utf8"){let t=km[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?$c(globalThis.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}var VC="ERR_IPNS_EXPIRED_RECORD",Dm="ERR_UNRECOGNIZED_VALIDITY";var mi="ERR_SIGNATURE_VERIFICATION",qC="ERR_UNRECOGNIZED_FORMAT";var sw="ERR_UNDEFINED_PARAMETER",HC="ERR_INVALID_RECORD_DATA",zC="ERR_INVALID_VALUE",$C="ERR_INVALID_EMBEDDED_KEY";var GC="ERR_RECORD_TOO_LARGE";var jn;(function(r){let e;(function(s){s.EOL="EOL"})(e=r.ValidityType||(r.ValidityType={}));let t;(function(s){s[s.EOL=0]="EOL"})(t||(t={})),function(s){s.codec=()=>Te(t)}(e=r.ValidityType||(r.ValidityType={}));let n;r.codec=()=>(n==null&&(n=ee((s,o,i={})=>{i.lengthDelimited!==!1&&o.fork(),s.value!=null&&(o.uint32(10),o.bytes(s.value)),s.signatureV1!=null&&(o.uint32(18),o.bytes(s.signatureV1)),s.validityType!=null&&(o.uint32(24),r.ValidityType.codec().encode(s.validityType,o)),s.validity!=null&&(o.uint32(34),o.bytes(s.validity)),s.sequence!=null&&(o.uint32(40),o.uint64(s.sequence)),s.ttl!=null&&(o.uint32(48),o.uint64(s.ttl)),s.pubKey!=null&&(o.uint32(58),o.bytes(s.pubKey)),s.signatureV2!=null&&(o.uint32(66),o.bytes(s.signatureV2)),s.data!=null&&(o.uint32(74),o.bytes(s.data)),i.lengthDelimited!==!1&&o.ldelim()},(s,o)=>{let i={},a=o==null?s.len:s.pos+o;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:i.value=s.bytes();break;case 2:i.signatureV1=s.bytes();break;case 3:i.validityType=r.ValidityType.codec().decode(s);break;case 4:i.validity=s.bytes();break;case 5:i.sequence=s.uint64();break;case 6:i.ttl=s.uint64();break;case 7:i.pubKey=s.bytes();break;case 8:i.signatureV2=s.bytes();break;case 9:i.data=s.bytes();break;default:s.skipType(c&7);break}}return i})),n),r.encode=s=>Z(s,r.codec()),r.decode=s=>J(s,r.codec())})(jn||(jn={}));var fn=fe(No(),1);var WC=fe(_m(),1);function iw(r,e){if(globalThis.Buffer!=null)return $c(globalThis.Buffer.concat(r,e));e==null&&(e=r.reduce((s,o)=>s+o.length,0));let t=Tm(e),n=0;for(let s of r)t.set(s,n),n+=s.length;return $c(t)}function aw(r,e="utf8"){let t=km[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):t.encoder.encode(r).substring(1)}var cw=Aa("ipns:utils"),YC=nf("/ipns/"),Pre=114;function Cre(r){let e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");let n=parseInt(t[1],10),s=parseInt(t[2],10)-1,o=parseInt(t[3],10),i=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].padEnd(6,"0").slice(0,3),10);return new Date(Date.UTC(n,s,o,i,a,c,l))}var lw=async(r,e)=>{if(e==null||r==null){let n=new Error("one or more of the provided parameters are not defined");throw cw.error(n),(0,fn.default)(n,sw)}let t;if(e.pubKey!=null){try{t=Nb(e.pubKey)}catch(s){throw cw.error(s),s}if(!(await HP(e.pubKey)).equals(r))throw(0,fn.default)(new Error("Embedded public key did not match PeerID"),$C)}else r.publicKey!=null&&(t=Nb(r.publicKey));if(t!=null)return t;throw(0,fn.default)(new Error("no public key is available"),sw)};var uw=r=>{let e=nf("ipns-signature:");return iw([e,r])},id=r=>"signatureV1"in r?jn.encode({value:nf(r.value),signatureV1:r.signatureV1,validityType:r.validityType,validity:nf(r.validity.toString()),sequence:r.sequence,ttl:r.ttl,pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data}):jn.encode({pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data});function Ta(r){let e=jn.decode(r);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw(0,fn.default)(new Error("missing data or signatureV2"),mi);let t=jC(e.data),n=QC(t.Value),s;try{s=WC.default.fromDate(Cre(aw(t.Validity)))}catch{throw cw.error("unrecognized validity format (not an rfc3339 format)"),(0,fn.default)(new Error("unrecognized validity format (not an rfc3339 format)"),qC)}if(e.value!=null&&e.signatureV1!=null)return Bre(e),{value:n,validityType:jn.ValidityType.EOL,validity:s,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:n,validityType:jn.ValidityType.EOL,validity:s,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}var fw=r=>iw([YC,r.toBytes()]),hw=r=>jp(r.slice(YC.length));var jC=r=>{let e=sn(r);if(e.ValidityType===0)e.ValidityType=jn.ValidityType.EOL;else throw(0,fn.default)(new Error("Unknown validity type"),Dm);return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e},QC=r=>{if(r!=null){if(TP(r))return`/ipns/${r.toCID().toString(hm)}`;if(r instanceof Uint8Array){let n=aw(r);n.startsWith("/")&&(r=n)}let e=r.toString().trim();if(e.startsWith("/")&&e.length>1)return e;let t=Ps.asCID(r);if(t!=null)return t.code===Pre?`/ipns/${t.toString(hm)}`:`/ipfs/${t.toV1().toString()}`;try{return r instanceof Uint8Array?`/ipfs/${Ps.decode(r).toV1().toString()}`:`/ipfs/${Ps.parse(e).toV1().toString()}`}catch{}}throw(0,fn.default)(new Error("Value must be a valid content path starting with /"),zC)},Bre=r=>{if(r.data==null)throw(0,fn.default)(new Error("Record data is missing"),HC);let e=jC(r.data);if(!Am(e.Value,r.value??new Uint8Array(0)))throw(0,fn.default)(new Error('Field "value" did not match between protobuf and CBOR'),mi);if(!Am(e.Validity,r.validity??new Uint8Array(0)))throw(0,fn.default)(new Error('Field "validity" did not match between protobuf and CBOR'),mi);if(e.ValidityType!==r.validityType)throw(0,fn.default)(new Error('Field "validityType" did not match between protobuf and CBOR'),mi);if(e.Sequence!==r.sequence)throw(0,fn.default)(new Error('Field "sequence" did not match between protobuf and CBOR'),mi);if(e.TTL!==r.ttl)throw(0,fn.default)(new Error('Field "ttl" did not match between protobuf and CBOR'),mi)};var ske=Aa("ipns"),oke=co.code,Ore="/ipns/",ike=Ore.length;var ad=fe(No(),1);var Pm=Aa("ipns:validator"),Kre=1024*10,Mre=async(r,e)=>{let t=Ta(e),n;try{let s=uw(t.data);n=await r.verify(s,t.signatureV2)}catch{n=!1}if(!n)throw Pm.error("record signature verification failed"),(0,ad.default)(new Error("record signature verification failed"),mi);if(t.validityType===jn.ValidityType.EOL){if(t.validity.toDate().getTime()<Date.now())throw Pm.error("record has expired"),(0,ad.default)(new Error("record has expired"),VC)}else if(t.validityType!=null)throw Pm.error("unrecognized validity type"),(0,ad.default)(new Error("unrecognized validity type"),Dm);Pm("ipns record for %b is valid",t.value)};async function XC(r,e){if(e.byteLength>Kre)throw(0,ad.default)(new Error("record too large"),GC);let t=hw(r),n=Ta(e),s=await lw(t,n);await Mre(s,e)}async function*cd(r){let e=/\r?\n/,t=new TextDecoder("utf8"),n="";for await(let s of r){typeof s=="string"&&(s=new TextEncoder().encode(s)),n+=t.decode(s,{stream:!0});let o=n.split(e);n=o.pop()??"";for(let i=0;i<o.length;i++)yield JSON.parse(o[i])}n+=t.decode(),n!==""&&(yield JSON.parse(n))}var ld=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},pw=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},JC=r=>globalThis.DOMException===void 0?new pw(r):new DOMException(r),ZC=r=>{let e=r.reason===void 0?JC("This operation was aborted."):r.reason;return e instanceof Error?e:JC(e)};function dw(r,e,t,n){let s,o=new Promise((i,a)=>{if(typeof e!="number"||Math.sign(e)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(e===Number.POSITIVE_INFINITY){i(r);return}if(n={customTimers:{setTimeout,clearTimeout},...n},n.signal){let{signal:c}=n;c.aborted&&a(ZC(c)),c.addEventListener("abort",()=>{a(ZC(c))})}s=n.customTimers.setTimeout.call(void 0,()=>{if(typeof t=="function"){try{i(t())}catch(u){a(u)}return}let c=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,l=t instanceof Error?t:new ld(c);typeof r.cancel=="function"&&r.cancel(),a(l)},e),(async()=>{try{i(await r)}catch(c){a(c)}finally{n.customTimers.clearTimeout.call(void 0,s)}})()});return o.clear=()=>{clearTimeout(s),s=void 0},o}function mw(r,e,t){let n=0,s=r.length;for(;s>0;){let o=Math.trunc(s/2),i=n+o;t(r[i],e)<=0?(n=++i,s-=o+1):s=o}return n}var Wc=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},yi,yw=class{constructor(){yi.set(this,[])}enqueue(e,t){t={priority:0,...t};let n={priority:t.priority,run:e};if(this.size&&Wc(this,yi,"f")[this.size-1].priority>=t.priority){Wc(this,yi,"f").push(n);return}let s=mw(Wc(this,yi,"f"),n,(o,i)=>i.priority-o.priority);Wc(this,yi,"f").splice(s,0,n)}dequeue(){let e=Wc(this,yi,"f").shift();return e?.run}filter(e){return Wc(this,yi,"f").filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return Wc(this,yi,"f").length}};yi=new WeakMap;var eB=yw;var Ct=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},ye=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Gt,fd,hd,Da,Km,pd,Cm,Bs,ud,Tn,Bm,kn,dd,ka,Nm,tB,rB,oB,nB,sB,Lm,gw,bw,Mm,iB,Om,Um=class extends Error{},ww=class extends Qh.default{constructor(e){var t,n,s,o;if(super(),Gt.add(this),fd.set(this,void 0),hd.set(this,void 0),Da.set(this,0),Km.set(this,void 0),pd.set(this,void 0),Cm.set(this,0),Bs.set(this,void 0),ud.set(this,void 0),Tn.set(this,void 0),Bm.set(this,void 0),kn.set(this,0),dd.set(this,void 0),ka.set(this,void 0),Nm.set(this,void 0),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:eB,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(n=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(o=(s=e.interval)===null||s===void 0?void 0:s.toString())!==null&&o!==void 0?o:""}\` (${typeof e.interval})`);Ct(this,fd,e.carryoverConcurrencyCount,"f"),Ct(this,hd,e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,"f"),Ct(this,Km,e.intervalCap,"f"),Ct(this,pd,e.interval,"f"),Ct(this,Tn,new e.queueClass,"f"),Ct(this,Bm,e.queueClass,"f"),this.concurrency=e.concurrency,this.timeout=e.timeout,Ct(this,Nm,e.throwOnTimeout===!0,"f"),Ct(this,ka,e.autoStart===!1,"f")}get concurrency(){return ye(this,dd,"f")}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);Ct(this,dd,e,"f"),ye(this,Gt,"m",Mm).call(this)}async add(e,t={}){return t={timeout:this.timeout,throwOnTimeout:ye(this,Nm,"f"),...t},new Promise((n,s)=>{ye(this,Tn,"f").enqueue(async()=>{var o,i,a;Ct(this,kn,(i=ye(this,kn,"f"),i++,i),"f"),Ct(this,Da,(a=ye(this,Da,"f"),a++,a),"f");try{if(!((o=t.signal)===null||o===void 0)&&o.aborted)throw new Um("The task was aborted.");let c=e({signal:t.signal});t.timeout&&(c=dw(Promise.resolve(c),t.timeout)),t.signal&&(c=Promise.race([c,ye(this,Gt,"m",iB).call(this,t.signal)]));let l=await c;n(l),this.emit("completed",l)}catch(c){if(c instanceof ld&&!t.throwOnTimeout){n();return}s(c),this.emit("error",c)}finally{ye(this,Gt,"m",oB).call(this)}},t),this.emit("add"),ye(this,Gt,"m",Lm).call(this)})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return ye(this,ka,"f")?(Ct(this,ka,!1,"f"),ye(this,Gt,"m",Mm).call(this),this):this}pause(){Ct(this,ka,!0,"f")}clear(){Ct(this,Tn,new(ye(this,Bm,"f")),"f")}async onEmpty(){ye(this,Tn,"f").size!==0&&await ye(this,Gt,"m",Om).call(this,"empty")}async onSizeLessThan(e){ye(this,Tn,"f").size<e||await ye(this,Gt,"m",Om).call(this,"next",()=>ye(this,Tn,"f").size<e)}async onIdle(){ye(this,kn,"f")===0&&ye(this,Tn,"f").size===0||await ye(this,Gt,"m",Om).call(this,"idle")}get size(){return ye(this,Tn,"f").size}sizeBy(e){return ye(this,Tn,"f").filter(e).length}get pending(){return ye(this,kn,"f")}get isPaused(){return ye(this,ka,"f")}};fd=new WeakMap,hd=new WeakMap,Da=new WeakMap,Km=new WeakMap,pd=new WeakMap,Cm=new WeakMap,Bs=new WeakMap,ud=new WeakMap,Tn=new WeakMap,Bm=new WeakMap,kn=new WeakMap,dd=new WeakMap,ka=new WeakMap,Nm=new WeakMap,Gt=new WeakSet,tB=function(){return ye(this,hd,"f")||ye(this,Da,"f")<ye(this,Km,"f")},rB=function(){return ye(this,kn,"f")<ye(this,dd,"f")},oB=function(){var e;Ct(this,kn,(e=ye(this,kn,"f"),e--,e),"f"),ye(this,Gt,"m",Lm).call(this),this.emit("next")},nB=function(){ye(this,Gt,"m",bw).call(this),ye(this,Gt,"m",gw).call(this),Ct(this,ud,void 0,"f")},sB=function(){let e=Date.now();if(ye(this,Bs,"f")===void 0){let t=ye(this,Cm,"f")-e;if(t<0)Ct(this,Da,ye(this,fd,"f")?ye(this,kn,"f"):0,"f");else return ye(this,ud,"f")===void 0&&Ct(this,ud,setTimeout(()=>{ye(this,Gt,"m",nB).call(this)},t),"f"),!0}return!1},Lm=function(){if(ye(this,Tn,"f").size===0)return ye(this,Bs,"f")&&clearInterval(ye(this,Bs,"f")),Ct(this,Bs,void 0,"f"),this.emit("empty"),ye(this,kn,"f")===0&&this.emit("idle"),!1;if(!ye(this,ka,"f")){let e=!ye(this,Gt,"a",sB);if(ye(this,Gt,"a",tB)&&ye(this,Gt,"a",rB)){let t=ye(this,Tn,"f").dequeue();return t?(this.emit("active"),t(),e&&ye(this,Gt,"m",gw).call(this),!0):!1}}return!1},gw=function(){ye(this,hd,"f")||ye(this,Bs,"f")!==void 0||(Ct(this,Bs,setInterval(()=>{ye(this,Gt,"m",bw).call(this)},ye(this,pd,"f")),"f"),Ct(this,Cm,Date.now()+ye(this,pd,"f"),"f"))},bw=function(){ye(this,Da,"f")===0&&ye(this,kn,"f")===0&&ye(this,Bs,"f")&&(clearInterval(ye(this,Bs,"f")),Ct(this,Bs,void 0,"f")),Ct(this,Da,ye(this,fd,"f")?ye(this,kn,"f"):0,"f"),ye(this,Gt,"m",Mm).call(this)},Mm=function(){for(;ye(this,Gt,"m",Lm).call(this););},iB=async function(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(new Um("The task was aborted."))},{once:!0})})},Om=async function(e,t){return new Promise(n=>{let s=()=>{t&&!t()||(this.off(e,s),n())};this.on(e,s)})};var aB=ww;function Ure(r){return r[Symbol.asyncIterator]!=null}function Fre(r){if(Ure(r))return(async()=>{for await(let e of r)return e})();for(let e of r)return e}var Yc=Fre;var Ew=en("/ipns/");function cB(r){return Zr(r.subarray(0,Ew.byteLength),Ew)}var lB=r=>jp(r.slice(Ew.length)),Fm=class{client;constructor(e){this.client=e}async*findProviders(e,t={}){yield*hs(this.client.getProviders(e,t),n=>({id:n.ID,multiaddrs:n.Addrs??[],protocols:[]}))}async provide(){}async put(e,t,n){if(!cB(e))return;let s=lB(e),o=Ta(t);await this.client.putIPNS(s,o,n)}async get(e,t){if(!cB(e))throw new Re("Not found","ERR_NOT_FOUND");let n=lB(e);try{let s=await this.client.getIPNS(n,t);return id(s)}catch(s){throw s.code==="ERR_BAD_RESPONSE"?new Re("Not found","ERR_NOT_FOUND"):s}}},Vm=class{client;constructor(e){this.client=e}async findPeer(e,t={}){let n=await Yc(this.client.getPeers(e,t));if(n!=null)return{id:n.ID,multiaddrs:n.Addrs,protocols:[]};throw new Re("Not found","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){}};var fo=Aa("delegated-routing-v1-http-api-client"),uB={concurrentRequests:4,timeout:3e4},qm=class{started;httpQueue;shutDownController;clientUrl;timeout;contentRouting;peerRouting;constructor(e,t={}){this.started=!1,this.shutDownController=new AbortController,wP(1/0,this.shutDownController.signal),this.httpQueue=new aB({concurrency:t.concurrentRequests??uB.concurrentRequests}),this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??uB.timeout,this.contentRouting=new Fm(this),this.peerRouting=new Vm(this)}get[bP](){return this.contentRouting}get[EP](){return this.peerRouting}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.shutDownController.abort(),this.started=!1}async*getProviders(e,t={}){fo("getProviders starts: %c",e);let n=ur([this.shutDownController.signal,t.signal,AbortSignal.timeout(this.timeout)]),s=xe(),o=xe();this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;let i=`${this.clientUrl}routing/v1/providers/${e.toString()}`,c=await fetch(i,{headers:{Accept:"application/x-ndjson"},signal:n});if(c.body==null)throw new Re("Routing response had no body","ERR_BAD_RESPONSE");if(c.headers.get("Content-Type")==="application/json"){let u=await c.json();for(let f of u.Providers){let h=this.#e(f);h!=null&&(yield h)}}else for await(let u of cd(ym(c.body))){let f=this.#e(u);f!=null&&(yield f)}}catch(i){fo.error("getProviders errored:",i)}finally{n.clear(),o.resolve(),fo("getProviders finished: %c",e)}}async*getPeers(e,t={}){fo("getPeers starts: %c",e);let n=ur([this.shutDownController.signal,t.signal,AbortSignal.timeout(this.timeout)]),s=xe(),o=xe();this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;let i=`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`,c=await fetch(i,{headers:{Accept:"application/x-ndjson"},signal:n});if(c.body==null)throw new Re("Routing response had no body","ERR_BAD_RESPONSE");if(c.headers.get("Content-Type")==="application/json"){let u=await c.json();for(let f of u.Peers){let h=this.#t(e,f);h!=null&&(yield h)}}else for await(let u of cd(ym(c.body))){let f=this.#t(e,u);f!=null&&(yield f)}}catch(i){fo.error("getPeers errored:",i)}finally{n.clear(),o.resolve(),fo("getPeers finished: %c",e)}}async getIPNS(e,t={}){fo("getIPNS starts: %c",e);let n=ur([this.shutDownController.signal,t.signal,AbortSignal.timeout(this.timeout)]),s=xe(),o=xe();this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;let i=`${this.clientUrl}routing/v1/ipns/${e.toCID().toString()}`,c=await fetch(i,{headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:n});if(c.body==null)throw new Re("GET ipns response had no body","ERR_BAD_RESPONSE");let l=new Uint8Array(await c.arrayBuffer());return await XC(fw(e),l),Ta(l)}finally{n.clear(),o.resolve(),fo("getIPNS finished: %c",e)}}async putIPNS(e,t,n={}){fo("getIPNS starts: %c",e);let s=ur([this.shutDownController.signal,n.signal,AbortSignal.timeout(this.timeout)]),o=xe(),i=xe();this.httpQueue.add(async()=>(o.resolve(),i.promise));try{await o.promise;let a=id(t),c=`${this.clientUrl}routing/v1/ipns/${e.toCID().toString()}`;if((await fetch(c,{method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:a,signal:s})).status!==200)throw new Re("PUT ipns response had status other than 200","ERR_BAD_RESPONSE")}finally{s.clear(),i.resolve(),fo("getIPNS finished: %c",e)}}#e(e){if(e.Schema==="peer")return e.ID=Gu(e.ID),e.Addrs=e.Addrs.map(me),e.Protocols=e.Protocols??[],e;if(e.Schema==="bitswap")return{Schema:"peer",ID:Gu(e.ID),Addrs:e.Addrs.map(me),Protocols:e.Protocol!=null?[e.Protocol]:[]};if(e.ID!=null&&Array.isArray(e.Addrs))return{Schema:"peer",ID:Gu(e.ID),Addrs:e.Addrs.map(me),Protocols:Array.isArray(e.Protocols)?e.Protocols:[]}}#t(e,t){if(t.Schema==="peer"&&(t.ID=Gu(t.ID),t.Addrs=t.Addrs.map(me),e.equals(t.ID)))return t}};function fB(r,e={}){return new qm(new URL(r),e)}var _w={};V(_w,{Ed25519PrivateKey:()=>Pa,Ed25519PublicKey:()=>af,generateKeyPair:()=>zre,generateKeyPairFromSeed:()=>bB,unmarshalEd25519PrivateKey:()=>qre,unmarshalEd25519PublicKey:()=>Hre});function Qn(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var sf=32,gi=64,Hm=32;function hB(){let r=De.utils.randomPrivateKey(),e=De.getPublicKey(r);return{privateKey:yB(r,e),publicKey:e}}function pB(r){if(r.length!==Hm)throw new TypeError('"seed" must be 32 bytes in length.');if(!(r instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');let e=r,t=De.getPublicKey(e);return{privateKey:yB(e,t),publicKey:t}}function dB(r,e){let t=r.subarray(0,Hm);return De.sign(e instanceof Uint8Array?e:e.subarray(),t)}function mB(r,e,t){return De.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}function yB(r,e){let t=new Uint8Array(gi);for(let n=0;n<Hm;n++)t[n]=r[n],t[Hm+n]=e[n];return t}var Ir={get(r=globalThis){let e=r.crypto;if(e==null||e.subtle==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}};var vw={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function xw(r){let e=r?.algorithm??"AES-GCM",t=r?.keyLength??16,n=r?.nonceLength??12,s=r?.digest??"SHA-256",o=r?.saltLength??16,i=r?.iterations??32767,a=Ir.get();t*=8;async function c(f,h){let d=a.getRandomValues(new Uint8Array(o)),p=a.getRandomValues(new Uint8Array(n)),m={name:e,iv:p};typeof h=="string"&&(h=R(h));let y;if(h.length===0){y=await a.subtle.importKey("jwk",vw,{name:"AES-GCM"},!0,["encrypt"]);try{let w={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}catch{y=await a.subtle.importKey("jwk",vw,{name:"AES-GCM"},!0,["encrypt"])}}else{let w={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}let b=await a.subtle.encrypt(m,y,f);return le([d,m.iv,new Uint8Array(b)])}async function l(f,h){let d=f.subarray(0,o),p=f.subarray(o,o+n),m=f.subarray(o+n),y={name:e,iv:p};typeof h=="string"&&(h=R(h));let b;if(h.length===0)try{let E={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},x=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(E,x,{name:e,length:t},!0,["decrypt"])}catch{b=await a.subtle.importKey("jwk",vw,{name:"AES-GCM"},!0,["decrypt"])}else{let E={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},x=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(E,x,{name:e,length:t},!0,["decrypt"])}let w=await a.subtle.decrypt(y,b,m);return new Uint8Array(w)}return{encrypt:c,decrypt:l}}async function of(r,e){let n=await xw().encrypt(r,e);return qe.encode(n)}var yr;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.Secp256k1="Secp256k1"})(yr||(yr={}));var Sw;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.Secp256k1=2]="Secp256k1"})(Sw||(Sw={}));(function(r){r.codec=()=>Te(Sw)})(yr||(yr={}));var bi;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),yr.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=yr.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(bi||(bi={}));var wi;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),yr.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=yr.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(wi||(wi={}));var af=class{_key;constructor(e){this._key=cf(e,sf)}verify(e,t){return mB(this._key,t,e)}marshal(){return this._key}get bytes(){return bi.encode({Type:yr.Ed25519,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return Qn(e)?e.then(({bytes:t})=>t):e.bytes}},Pa=class{_key;_publicKey;constructor(e,t){this._key=cf(e,gi),this._publicKey=cf(t,sf)}sign(e){return dB(this._key,e)}get public(){return new af(this._publicKey)}marshal(){return this._key}get bytes(){return wi.encode({Type:yr.Ed25519,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}async hash(){let e=$.digest(this.bytes),t;return Qn(e)?{bytes:t}=await e:t=e.bytes,t}async id(){let e=Lt.digest(this.public.bytes);return Fe.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if(t==="libp2p-key")return of(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function qre(r){if(r.length>gi){r=cf(r,gi+sf);let n=r.subarray(0,gi),s=r.subarray(gi,r.length);return new Pa(n,s)}r=cf(r,gi);let e=r.subarray(0,gi),t=r.subarray(sf);return new Pa(e,t)}function Hre(r){return r=cf(r,sf),new af(r)}async function zre(){let{privateKey:r,publicKey:e}=hB();return new Pa(r,e)}async function bB(r){let{privateKey:e,publicKey:t}=pB(r);return new Pa(e,t)}function cf(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new g(`Key must be a Uint8Array of length ${e}, got ${r.length}`,"ERR_INVALID_KEY_TYPE");return r}var $re={"P-256":256,"P-384":384,"P-521":521},Gre=Object.keys($re),PDe=Gre.join(" / ");var kw={};V(kw,{MAX_RSA_KEY_SIZE:()=>uf,RsaPrivateKey:()=>Qc,RsaPublicKey:()=>lf,fromJwk:()=>sne,generateKeyPair:()=>one,unmarshalRsaPrivateKey:()=>Iw,unmarshalRsaPublicKey:()=>nne});function jc(r){if(isNaN(r)||r<=0)throw new g("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return zt(r)}var Ca={};V(Ca,{exportToPem:()=>Zre,importFromPem:()=>EB,jwkToPkcs1:()=>jre,jwkToPkix:()=>Xre,pkcs1ToJwk:()=>Yre,pkixToJwk:()=>Qre});function Yre(r){let{result:e}=tt(r),t=e.valueBlock.value;return{n:T(ho(t[1].toBigInt()),"base64url"),e:T(ho(t[2].toBigInt()),"base64url"),d:T(ho(t[3].toBigInt()),"base64url"),p:T(ho(t[4].toBigInt()),"base64url"),q:T(ho(t[5].toBigInt()),"base64url"),dp:T(ho(t[6].toBigInt()),"base64url"),dq:T(ho(t[7].toBigInt()),"base64url"),qi:T(ho(t[8].toBigInt()),"base64url"),kty:"RSA",alg:"RS256"}}function jre(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new g("JWK was missing components","ERR_INVALID_PARAMETERS");let t=new re({value:[new X({value:0}),X.fromBigInt(po(R(r.n,"base64url"))),X.fromBigInt(po(R(r.e,"base64url"))),X.fromBigInt(po(R(r.d,"base64url"))),X.fromBigInt(po(R(r.p,"base64url"))),X.fromBigInt(po(R(r.q,"base64url"))),X.fromBigInt(po(R(r.dp,"base64url"))),X.fromBigInt(po(R(r.dq,"base64url"))),X.fromBigInt(po(R(r.qi,"base64url")))]}).toBER();return new Uint8Array(t,0,t.byteLength)}function Qre(r){let{result:e}=tt(r),t=e.valueBlock.value[1].valueBlock.value[0].valueBlock.value;return{kty:"RSA",n:T(ho(t[0].toBigInt()),"base64url"),e:T(ho(t[1].toBigInt()),"base64url")}}function Xre(r){if(r.n==null||r.e==null)throw new g("JWK was missing components","ERR_INVALID_PARAMETERS");let t=new re({value:[new re({value:[new Le({value:"1.2.840.113549.1.1.1"}),new yt]}),new Hr({valueHex:new re({value:[X.fromBigInt(po(R(r.n,"base64url"))),X.fromBigInt(po(R(r.e,"base64url")))]}).toBER()})]}).toBER();return new Uint8Array(t,0,t.byteLength)}function ho(r){let e=r.toString(16);e.length%2>0&&(e=`0${e}`);let t=e.length/2,n=new Uint8Array(t),s=0,o=0;for(;s<t;)n[s]=parseInt(e.slice(o,o+2),16),s+=1,o+=2;return n}function po(r){let e=[];return r.forEach(function(t){let n=t.toString(16);n.length%2>0&&(n=`0${n}`),e.push(n)}),BigInt("0x"+e.join(""))}var Jre=16,Aw=32,Rw=1e4;async function Zre(r,e){let t=Ir.get(),s=new re({value:[new X({value:0}),new re({value:[new Le({value:"1.2.840.113549.1.1.1"}),new yt]}),new nt({valueHex:r.marshal()})]}).toBER(),o=new Uint8Array(s,0,s.byteLength),i=jc(Jre),a=await Xr(er,e,i,{c:Rw,dkLen:Aw}),c=jc(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,o),f=new re({value:[new nt({valueHex:i}),new X({value:Rw}),new X({value:Aw}),new re({value:[new Le({value:"1.2.840.113549.2.11"}),new yt]})]}),h=new re({value:[new Le({value:"1.2.840.113549.1.5.13"}),new re({value:[new re({value:[new Le({value:"1.2.840.113549.1.5.12"}),f]}),new re({value:[new Le({value:"2.16.840.1.101.3.4.1.42"}),new nt({valueHex:c})]})]})]}),p=new re({value:[h,new nt({valueHex:u})]}).toBER(),m=new Uint8Array(p,0,p.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...T(m,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function EB(r,e){let t=Ir.get(),n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){let s=R(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=tt(s),{iv:i,salt:a,iterations:c,keySize:l,cipherText:u}=ene(o),f=await Xr(er,e,a,{c,dkLen:l}),h=await t.subtle.importKey("raw",f,"AES-CBC",!1,["decrypt"]),d=md(await t.subtle.decrypt({name:"AES-CBC",iv:i},h,u)),{result:p}=tt(d);n=wB(p)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){let s=R(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=tt(s);n=wB(o)}else throw new g("Could not parse private key from PEM data","ERR_INVALID_PARAMETERS");return Iw(n)}function ene(r){let e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new g("Only pkcs5PBES2 encrypted private keys are supported","ERR_INVALID_PARAMS");let n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new g("Only pkcs5PBKDF2 key derivation functions are supported","ERR_INVALID_PARAMS");let o=n.valueBlock.value[1],i=md(o.valueBlock.value[0].getValue()),a=Rw,c=Aw;if(o.valueBlock.value.length===3)a=Number(o.valueBlock.value[1].toBigInt()),c=Number(o.valueBlock.value[2].toBigInt());else if(o.valueBlock.value.length===2)throw new g("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key","ERR_INVALID_PARAMS");let l=e.valueBlock.value[1].valueBlock.value[1],u=l.valueBlock.value[0].toString();if(u!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(u!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new g("Only AES-CBC encryption schemes are supported","ERR_INVALID_PARAMS")}}}}let f=md(l.valueBlock.value[1].getValue());return{cipherText:md(r.valueBlock.value[1].getValue()),salt:i,iterations:a,keySize:c,iv:f}}function wB(r){return md(r.valueBlock.value[2].getValue())}function md(r){return new Uint8Array(r,0,r.byteLength)}async function vB(r){let e=await Ir.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await _B(e);return{privateKey:t[0],publicKey:t[1]}}async function Tw(r){let t=[await Ir.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await tne(r)],n=await _B({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function xB(r,e){let t=await Ir.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await Ir.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(n,0,n.byteLength)}async function SB(r,e,t){let n=await Ir.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return Ir.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,e,t instanceof Uint8Array?t:t.subarray())}async function _B(r){if(r.privateKey==null||r.publicKey==null)throw new g("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([Ir.get().subtle.exportKey("jwk",r.privateKey),Ir.get().subtle.exportKey("jwk",r.publicKey)])}async function tne(r){return Ir.get().subtle.importKey("jwk",{kty:r.kty,n:r.n,e:r.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function $m(r){if(r.kty!=="RSA")throw new g("invalid key type","ERR_INVALID_KEY_TYPE");if(r.n==null)throw new g("invalid key modulus","ERR_INVALID_KEY_MODULUS");return R(r.n,"base64url").length*8}var uf=8192,lf=class{_key;constructor(e){this._key=e}verify(e,t){return SB(this._key,t,e)}marshal(){return Ca.jwkToPkix(this._key)}get bytes(){return bi.encode({Type:yr.RSA,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return Qn(e)?e.then(({bytes:t})=>t):e.bytes}},Qc=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t}genSecret(){return jc(16)}sign(e){return xB(this._key,e)}get public(){if(this._publicKey==null)throw new g("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new lf(this._publicKey)}marshal(){return Ca.jwkToPkcs1(this._key)}get bytes(){return wi.encode({Type:yr.RSA,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return Qn(e)?e.then(({bytes:t})=>t):e.bytes}async id(){let e=await this.public.hash();return T(e,"base58btc")}async export(e,t="pkcs-8"){if(t==="pkcs-8")return Ca.exportToPem(this,e);if(t==="libp2p-key")return of(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};async function Iw(r){let e=Ca.pkcs1ToJwk(r);if($m(e)>uf)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let t=await Tw(e);return new Qc(t.privateKey,t.publicKey)}function nne(r){let e=Ca.pkixToJwk(r);if($m(e)>uf)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new lf(e)}async function sne(r){if($m(r)>uf)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await Tw(r);return new Qc(e.privateKey,e.publicKey)}async function one(r){if(r>uf)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await vB(r);return new Qc(e.privateKey,e.publicKey)}var Pw={};V(Pw,{Secp256k1PrivateKey:()=>hf,Secp256k1PublicKey:()=>ff,generateKeyPair:()=>lne,unmarshalSecp256k1PrivateKey:()=>ane,unmarshalSecp256k1PublicKey:()=>cne});function AB(){return ae.utils.randomPrivateKey()}function RB(r,e){let t=$.digest(e instanceof Uint8Array?e:e.subarray());if(Qn(t))return t.then(({digest:n})=>ae.sign(n,r).toDERRawBytes()).catch(n=>{throw new g(String(n),"ERR_INVALID_INPUT")});try{return ae.sign(t.digest,r).toDERRawBytes()}catch(n){throw new g(String(n),"ERR_INVALID_INPUT")}}function IB(r,e,t){let n=$.digest(t instanceof Uint8Array?t:t.subarray());if(Qn(n))return n.then(({digest:s})=>ae.verify(e,s,r)).catch(s=>{throw new g(String(s),"ERR_INVALID_INPUT")});try{return ae.verify(e,n.digest,r)}catch(s){throw new g(String(s),"ERR_INVALID_INPUT")}}function TB(r){return ae.ProjectivePoint.fromHex(r).toRawBytes(!0)}function kB(r){try{ae.getPublicKey(r,!0)}catch(e){throw new g(String(e),"ERR_INVALID_PRIVATE_KEY")}}function Dw(r){try{ae.ProjectivePoint.fromHex(r)}catch(e){throw new g(String(e),"ERR_INVALID_PUBLIC_KEY")}}function DB(r){try{return ae.getPublicKey(r,!0)}catch(e){throw new g(String(e),"ERR_INVALID_PRIVATE_KEY")}}var ff=class{_key;constructor(e){Dw(e),this._key=e}verify(e,t){return IB(this._key,t,e)}marshal(){return TB(this._key)}get bytes(){return bi.encode({Type:yr.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}async hash(){let e=$.digest(this.bytes),t;return Qn(e)?{bytes:t}=await e:t=e.bytes,t}},hf=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t??DB(e),kB(this._key),Dw(this._publicKey)}sign(e){return RB(this._key,e)}get public(){return new ff(this._publicKey)}marshal(){return this._key}get bytes(){return wi.encode({Type:yr.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return Qn(e)?e.then(({bytes:t})=>t):e.bytes}async id(){let e=await this.public.hash();return T(e,"base58btc")}async export(e,t="libp2p-key"){if(t==="libp2p-key")return of(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function ane(r){return new hf(r)}function cne(r){return new ff(r)}async function lne(){let r=AB();return new hf(r)}var PB={rsa:kw,ed25519:_w,secp256k1:Pw};function une(r){let e=Object.keys(PB).join(" / ");return new g(`invalid or unsupported key type ${r}. Must be ${e}`,"ERR_UNSUPPORTED_KEY_TYPE")}function Cw(r){if(r=r.toLowerCase(),r==="rsa"||r==="ed25519"||r==="secp256k1")return PB[r];throw une(r)}async function CB(r,e){return Cw(r).generateKeyPair(e??2048)}function BB(r,e){return e=(e??"rsa").toLowerCase(),Cw(e),r.bytes}function NB(r,e){return e=(e??"rsa").toLowerCase(),Cw(e),r.bytes}var Bw;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.id!=null&&(n.uint32(10),n.bytes(t.id)),t.pubKey!=null&&(n.uint32(18),n.bytes(t.pubKey)),t.privKey!=null&&(n.uint32(26),n.bytes(t.privKey)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.id=t.bytes();break;case 2:s.pubKey=t.bytes();break;case 3:s.privKey=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(Bw||(Bw={}));var Gm=async()=>{let r=await CB("Ed25519"),e=await fne(r);if(e.type==="Ed25519")return e;throw new Error(`Generated unexpected PeerId type "${e.type}"`)};async function fne(r){return xr(BB(r.public),NB(r))}var Wm=globalThis.CustomEvent??Event;async function*Ei(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);let n=e.ordered==null?!1:e.ordered,s=new EventTarget,o=[],i=xe(),a=xe(),c=!1,l,u=!1;s.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(let p of r){if(o.length===t&&(i=xe(),await i.promise),u)break;let m={done:!1};o.push(m),p().then(y=>{m.done=!0,m.ok=!0,m.value=y,s.dispatchEvent(new Wm("task-complete"))},y=>{m.done=!0,m.err=y,s.dispatchEvent(new Wm("task-complete"))})}c=!0,s.dispatchEvent(new Wm("task-complete"))}catch(p){l=p,s.dispatchEvent(new Wm("task-complete"))}});function f(){return n?o[0]?.done:!!o.find(p=>p.done)}function*h(){for(;o.length>0&&o[0].done;){let p=o[0];if(o.shift(),p.ok)yield p.value;else throw u=!0,i.resolve(),p.err;i.resolve()}}function*d(){for(;f();)for(let p=0;p<o.length;p++)if(o[p].done){let m=o[p];if(o.splice(p,1),p--,m.ok)yield m.value;else throw u=!0,i.resolve(),m.err;i.resolve()}}for(;;){if(f()||(a=xe(),await a.promise),l!=null)throw l;if(n?yield*h():yield*d(),c&&o.length===0)break}}var VB=fe(LB(),1);var OB="[a-fA-F\\d:]",Ba=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${OB})|(?<=${OB})(?=\\s|$))`:"",Ns="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",tr="[a-fA-F\\d]{1,4}",Ym=`
(?:
(?:${tr}:){7}(?:${tr}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${tr}:){6}(?:${Ns}|:${tr}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${tr}:){5}(?::${Ns}|(?::${tr}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${tr}:){4}(?:(?::${tr}){0,1}:${Ns}|(?::${tr}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${tr}:){3}(?:(?::${tr}){0,2}:${Ns}|(?::${tr}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${tr}:){2}(?:(?::${tr}){0,3}:${Ns}|(?::${tr}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${tr}:){1}(?:(?::${tr}){0,4}:${Ns}|(?::${tr}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${tr}){0,5}:${Ns}|(?::${tr}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),hne=new RegExp(`(?:^${Ns}$)|(?:^${Ym}$)`),pne=new RegExp(`^${Ns}$`),dne=new RegExp(`^${Ym}$`),Nw=r=>r&&r.exact?hne:new RegExp(`(?:${Ba(r)}${Ns}${Ba(r)})|(?:${Ba(r)}${Ym}${Ba(r)})`,"g");Nw.v4=r=>r&&r.exact?pne:new RegExp(`${Ba(r)}${Ns}${Ba(r)}`,"g");Nw.v6=r=>r&&r.exact?dne:new RegExp(`${Ba(r)}${Ym}${Ba(r)}`,"g");var KB=Nw;var qB=fe(UB(),1),{isValid:mne,parse:yne}=qB.default,gne=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],bne=gne.map(r=>new VB.Netmask(r));function wne(r){for(let e of bne)if(e.contains(r))return!0;return!1}function FB(r){return/^::$/.test(r)||/^::1$/.test(r)||/^::f{4}:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^::f{4}:0.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}var HB=r=>{if(mne(r)){let e=yne(r);if(e.kind()==="ipv4")return wne(e.toNormalizedString());if(e.kind()==="ipv6")return FB(r)}else if(Iu(r)&&KB.v6().test(r))return FB(r)};var Xn=HB;var zB="libp2p",$B="autonat",GB="1.0.0";var Oe;(function(r){let e;(function(l){l.DIAL="DIAL",l.DIAL_RESPONSE="DIAL_RESPONSE"})(e=r.MessageType||(r.MessageType={}));let t;(function(l){l[l.DIAL=0]="DIAL",l[l.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(t||(t={})),function(l){l.codec=()=>Te(t)}(e=r.MessageType||(r.MessageType={}));let n;(function(l){l.OK="OK",l.E_DIAL_ERROR="E_DIAL_ERROR",l.E_DIAL_REFUSED="E_DIAL_REFUSED",l.E_BAD_REQUEST="E_BAD_REQUEST",l.E_INTERNAL_ERROR="E_INTERNAL_ERROR"})(n=r.ResponseStatus||(r.ResponseStatus={}));let s;(function(l){l[l.OK=0]="OK",l[l.E_DIAL_ERROR=100]="E_DIAL_ERROR",l[l.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",l[l.E_BAD_REQUEST=200]="E_BAD_REQUEST",l[l.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(s||(s={})),function(l){l.codec=()=>Te(s)}(n=r.ResponseStatus||(r.ResponseStatus={}));let o;(function(l){let u;l.codec=()=>(u==null&&(u=ee((f,h,d={})=>{if(d.lengthDelimited!==!1&&h.fork(),f.id!=null&&(h.uint32(10),h.bytes(f.id)),f.addrs!=null)for(let p of f.addrs)h.uint32(18),h.bytes(p);d.lengthDelimited!==!1&&h.ldelim()},(f,h)=>{let d={addrs:[]},p=h==null?f.len:f.pos+h;for(;f.pos<p;){let m=f.uint32();switch(m>>>3){case 1:d.id=f.bytes();break;case 2:d.addrs.push(f.bytes());break;default:f.skipType(m&7);break}}return d})),u),l.encode=f=>Z(f,l.codec()),l.decode=f=>J(f,l.codec())})(o=r.PeerInfo||(r.PeerInfo={}));let i;(function(l){let u;l.codec=()=>(u==null&&(u=ee((f,h,d={})=>{d.lengthDelimited!==!1&&h.fork(),f.peer!=null&&(h.uint32(10),r.PeerInfo.codec().encode(f.peer,h)),d.lengthDelimited!==!1&&h.ldelim()},(f,h)=>{let d={},p=h==null?f.len:f.pos+h;for(;f.pos<p;){let m=f.uint32();switch(m>>>3){case 1:d.peer=r.PeerInfo.codec().decode(f,f.uint32());break;default:f.skipType(m&7);break}}return d})),u),l.encode=f=>Z(f,l.codec()),l.decode=f=>J(f,l.codec())})(i=r.Dial||(r.Dial={}));let a;(function(l){let u;l.codec=()=>(u==null&&(u=ee((f,h,d={})=>{d.lengthDelimited!==!1&&h.fork(),f.status!=null&&(h.uint32(8),r.ResponseStatus.codec().encode(f.status,h)),f.statusText!=null&&(h.uint32(18),h.string(f.statusText)),f.addr!=null&&(h.uint32(26),h.bytes(f.addr)),d.lengthDelimited!==!1&&h.ldelim()},(f,h)=>{let d={},p=h==null?f.len:f.pos+h;for(;f.pos<p;){let m=f.uint32();switch(m>>>3){case 1:d.status=r.ResponseStatus.codec().decode(f);break;case 2:d.statusText=f.string();break;case 3:d.addr=f.bytes();break;default:f.skipType(m&7);break}}return d})),u),l.encode=f=>Z(f,l.codec()),l.decode=f=>J(f,l.codec())})(a=r.DialResponse||(r.DialResponse={}));let c;r.codec=()=>(c==null&&(c=ee((l,u,f={})=>{f.lengthDelimited!==!1&&u.fork(),l.type!=null&&(u.uint32(8),r.MessageType.codec().encode(l.type,u)),l.dial!=null&&(u.uint32(18),r.Dial.codec().encode(l.dial,u)),l.dialResponse!=null&&(u.uint32(26),r.DialResponse.codec().encode(l.dialResponse,u)),f.lengthDelimited!==!1&&u.ldelim()},(l,u)=>{let f={},h=u==null?l.len:l.pos+u;for(;l.pos<h;){let d=l.uint32();switch(d>>>3){case 1:f.type=r.MessageType.codec().decode(l);break;case 2:f.dial=r.Dial.codec().decode(l,l.uint32());break;case 3:f.dialResponse=r.DialResponse.codec().decode(l,l.uint32());break;default:l.skipType(d&7);break}}return f})),c),r.encode=l=>Z(l,r.codec()),r.decode=l=>J(l,r.codec())})(Oe||(Oe={}));var Lw=4,Qm=class{components;startupDelay;refreshInterval;protocol;timeout;maxInboundStreams;maxOutboundStreams;verifyAddressTimeout;started;log;constructor(e,t){this.components=e,this.log=e.logger.forComponent("libp2p:autonat"),this.started=!1,this.protocol=`/${t.protocolPrefix??zB}/${$B}/${GB}`,this.timeout=t.timeout??3e4,this.maxInboundStreams=t.maxInboundStreams??1,this.maxOutboundStreams=t.maxOutboundStreams??1,this.startupDelay=t.startupDelay??5e3,this.refreshInterval=t.refreshInterval??6e4,this._verifyExternalAddresses=this._verifyExternalAddresses.bind(this)}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,e=>{this.handleIncomingAutonatStream(e).catch(t=>{this.log.error("error handling incoming autonat stream",t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.startupDelay),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),clearTimeout(this.verifyAddressTimeout),this.started=!1}async handleIncomingAutonatStream(e){let t=AbortSignal.timeout(this.timeout),n=()=>{e.stream.abort(new g("handleIncomingAutonatStream timeout",Fo))};t.addEventListener("abort",n,{once:!0}),Ze(1/0,t);let s=this.components.addressManager.getAddresses().map(o=>o.toOptions().host);try{let o=this;await lt(e.stream,i=>Mr(i),async function*(i){let a=await Yc(i);if(a==null){o.log("no message received"),yield Oe.encode({type:Oe.MessageType.DIAL_RESPONSE,dialResponse:{status:Oe.ResponseStatus.E_BAD_REQUEST,statusText:"No message was sent"}});return}let c;try{c=Oe.decode(a)}catch(m){o.log.error("could not decode message",m),yield Oe.encode({type:Oe.MessageType.DIAL_RESPONSE,dialResponse:{status:Oe.ResponseStatus.E_BAD_REQUEST,statusText:"Could not decode message"}});return}let l=c.dial;if(l==null){o.log.error("dial was missing from message"),yield Oe.encode({type:Oe.MessageType.DIAL_RESPONSE,dialResponse:{status:Oe.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}});return}let u,f=l.peer;if(f==null||f.id==null){o.log.error("PeerId missing from message"),yield Oe.encode({type:Oe.MessageType.DIAL_RESPONSE,dialResponse:{status:Oe.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}});return}try{u=dt(f.id)}catch(m){o.log.error("invalid PeerId",m),yield Oe.encode({type:Oe.MessageType.DIAL_RESPONSE,dialResponse:{status:Oe.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}});return}if(o.log("incoming request from %p",u),!e.connection.remotePeer.equals(u)){o.log("target peer %p did not equal sending peer %p",u,e.connection.remotePeer),yield Oe.encode({type:Oe.MessageType.DIAL_RESPONSE,dialResponse:{status:Oe.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}});return}let h=f.addrs.map(m=>me(m)).filter(m=>{let y=m.toOptions().host===e.connection.remoteAddr.toOptions().host;return o.log.trace("request to dial %a was sent from %a is same host %s",m,e.connection.remoteAddr,y),y}).filter(m=>{let y=m.toOptions().host,b=!(Xn(y)??!1);return o.log.trace("host %s was public %s",y,b),b}).filter(m=>{let y=m.toOptions().host,b=!s.includes(y);return o.log.trace("host %s was not our host %s",y,b),b}).filter(m=>{let y=!!o.components.transportManager.transportForMultiaddr(m);return o.log.trace("transport for %a is supported %s",m,y),y}).map(m=>(m.getPeerId()==null&&(m=m.encapsulate(`/p2p/${u.toString()}`)),m));if(h.length===0){o.log("no valid multiaddrs for %p in message",u),yield Oe.encode({type:Oe.MessageType.DIAL_RESPONSE,dialResponse:{status:Oe.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}});return}o.log("dial multiaddrs %s for peer %p",h.map(m=>m.toString()).join(", "),u);let d="",p=h[0];for await(let m of h){let y;p=m;try{if(y=await o.components.connectionManager.openConnection(m,{signal:t}),!y.remoteAddr.equals(m))throw o.log.error("tried to dial %a but dialed %a",m,y.remoteAddr),new Error("Unexpected remote address");o.log("Success %p",u),yield Oe.encode({type:Oe.MessageType.DIAL_RESPONSE,dialResponse:{status:Oe.ResponseStatus.OK,addr:y.remoteAddr.decapsulateCode(ve("p2p").code).bytes}});return}catch(b){o.log("could not dial %p",u,b),d=b.message}finally{y!=null&&await y.close()}}yield Oe.encode({type:Oe.MessageType.DIAL_RESPONSE,dialResponse:{status:Oe.ResponseStatus.E_DIAL_ERROR,statusText:d,addr:p.bytes}})},i=>sr(i),e.stream)}catch(o){this.log.error("error handling incoming autonat stream",o)}finally{t.removeEventListener("abort",n)}}_verifyExternalAddresses(){this.verifyExternalAddresses().catch(e=>{this.log.error("error verifying external address",e)})}async verifyExternalAddresses(){if(clearTimeout(this.verifyAddressTimeout),!this.isStarted())return;let e=this.components.addressManager,t=e.getObservedAddrs().filter(o=>{let i=o.toOptions();return!(Xn(i.host)??!1)});if(t.length===0){this.log("no public addresses found, not requesting verification"),this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval);return}let n=AbortSignal.timeout(this.timeout);Ze(1/0,n);let s=this;try{this.log("verify multiaddrs %s",t.map(f=>f.toString()).join(", "));let o=Oe.encode({type:Oe.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toBytes(),addrs:t.map(f=>f.bytes)}}}),a=(await Gm()).toBytes(),c={},l=[],u=async f=>{let h=()=>{};try{this.log("asking %p to verify multiaddr",f.id);let d=await s.components.connectionManager.openConnection(f.id,{signal:n}),p=await d.newStream(this.protocol,{signal:n});h=()=>{p.abort(new g("verifyAddress timeout",Fo))},n.addEventListener("abort",h,{once:!0});let m=await lt([o],b=>sr(b),p,b=>Mr(b),async b=>Yc(b));if(m==null){this.log("no response received from %p",d.remotePeer);return}let y=Oe.decode(m);if(y.type!==Oe.MessageType.DIAL_RESPONSE||y.dialResponse==null){this.log("invalid autonat response from %p",d.remotePeer);return}if(y.dialResponse.status===Oe.ResponseStatus.OK){let b=d.remoteAddr.toOptions(),w;if(b.family===4)w=b.host.split(".")[0];else if(b.family===6)w=b.host.split(":")[0];else{this.log('remote address "%s" was not IP4 or IP6?',b.host);return}if(l.includes(w)){this.log("already have response from network segment %d - %s",w,b.host);return}l.push(w)}return y.dialResponse}catch(d){this.log.error("error asking remote to verify multiaddr",d)}finally{n.removeEventListener("abort",h)}};for await(let f of Ei(hs(this.components.peerRouting.getClosestPeers(a,{signal:n}),h=>async()=>u(h)),{concurrency:Lw}))try{if(f==null)continue;let h=f.addr==null?t[0]:me(f.addr);if(this.log("autonat response for %a is %s",h,f.status),f.status===Oe.ResponseStatus.E_BAD_REQUEST||f.status===Oe.ResponseStatus.E_DIAL_REFUSED||f.addr==null&&t.length>1)continue;if(!t.some(p=>p.equals(h))){this.log("peer reported %a as %s but it was not in our observed address list",h,f.status);continue}let d=h.toString();if(c[d]==null&&(c[d]={success:0,failure:0}),f.status===Oe.ResponseStatus.OK?c[d].success++:f.status===Oe.ResponseStatus.E_DIAL_ERROR&&c[d].failure++,c[d].success===Lw){this.log("%a is externally dialable",h),e.confirmObservedAddr(h);return}if(c[d].failure===Lw){this.log("%a is not externally dialable",h),e.removeObservedAddr(h);return}}catch(h){this.log.error("could not verify external address",h)}}finally{this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval)}}};function WB(r={}){return e=>new Qm(e,r)}var Ane=oe("dns4"),Rne=oe("dns6"),Ine=oe("dnsaddr"),La=Wt(oe("dns"),Ine,Ane,Rne),Xm=Wt(oe("ip4"),oe("ip6")),pf=Wt(we(Xm,oe("tcp")),we(La,oe("tcp"))),Jm=we(Xm,oe("udp")),Tne=we(Jm,oe("utp")),kne=we(Jm,oe("quic")),Dne=we(Jm,oe("quic-v1")),Ow=Wt(we(pf,oe("ws")),we(La,oe("ws"))),df=Wt(we(Ow,oe("p2p")),Ow),Kw=Wt(we(pf,oe("wss")),we(La,oe("wss")),we(pf,oe("tls"),oe("ws")),we(La,oe("tls"),oe("ws"))),Xc=Wt(we(Kw,oe("p2p")),Kw),Mw=Wt(we(pf,oe("http")),we(Xm,oe("http")),we(La,oe("http"))),Uw=Wt(we(pf,oe("https")),we(Xm,oe("https")),we(La,oe("https"))),YB=we(Jm,oe("webrtc-direct"),oe("certhash")),XB=Wt(we(YB,oe("p2p")),YB),jB=we(Dne,oe("webtransport"),oe("certhash"),oe("certhash")),JB=Wt(we(jB,oe("p2p")),jB),ZB=Wt(we(df,oe("p2p-webrtc-star"),oe("p2p")),we(Xc,oe("p2p-webrtc-star"),oe("p2p")),we(df,oe("p2p-webrtc-star")),we(Xc,oe("p2p-webrtc-star"))),bCe=Wt(we(df,oe("p2p-websocket-star"),oe("p2p")),we(Xc,oe("p2p-websocket-star"),oe("p2p")),we(df,oe("p2p-websocket-star")),we(Xc,oe("p2p-websocket-star"))),eN=Wt(we(Mw,oe("p2p-webrtc-direct"),oe("p2p")),we(Uw,oe("p2p-webrtc-direct"),oe("p2p")),we(Mw,oe("p2p-webrtc-direct")),we(Uw,oe("p2p-webrtc-direct"))),Jc=Wt(Ow,Kw,Mw,Uw,ZB,eN,pf,Tne,kne,La,XB,JB),wCe=Wt(we(Jc,oe("p2p-stardust"),oe("p2p")),we(Jc,oe("p2p-stardust"))),Na=Wt(we(Jc,oe("p2p")),ZB,eN,XB,JB,oe("p2p")),QB=Wt(we(Na,oe("p2p-circuit"),Na),we(Na,oe("p2p-circuit")),we(oe("p2p-circuit"),Na),we(Jc,oe("p2p-circuit")),we(oe("p2p-circuit"),Jc),oe("p2p-circuit")),tN=()=>Wt(we(QB,tN),QB),Ls=tN(),rN=Wt(we(Ls,Na,Ls),we(Na,Ls),we(Ls,Na),Ls,Na);var ECe=Wt(we(Ls,oe("webrtc"),oe("p2p")),we(Ls,oe("webrtc")),we(Jc,oe("webrtc"),oe("p2p")),we(Jc,oe("webrtc")),oe("webrtc"));function nN(r){function e(t){let n;try{n=me(t)}catch{return!1}let s=r(n.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return e}function we(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(s=>(n=typeof s=="function"?s().partialMatch(t):s.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:nN(e),partialMatch:e}}function Wt(...r){function e(n){let s=null;return r.some(o=>{let i=typeof o=="function"?o().partialMatch(n):o.partialMatch(n);return i!=null?(s=i,!0):!1}),s}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:nN(e),partialMatch:e}}function oe(r){let e=r;function t(s){let o;try{o=me(s)}catch{return!1}let i=o.protoNames();return i.length===1&&i[0]===e}function n(s){return s.length===0?null:s[0]===e?s.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}var Pne="bootstrap",Cne=50,Bne=12e4,Nne=1e3,Fw=class extends je{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??Nne,this.list=[];for(let n of t.list){if(!rN.matches(n)){this.log.error("Invalid multiaddr");continue}let s=me(n),o=s.getPeerId();if(o==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}let i={id:Ce(o),multiaddrs:[s]};this.list.push(i)}this._init=t}[oc]=this;[Symbol.toStringTag]="@libp2p/bootstrap";isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(let e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??Pne]:{value:this._init.tagValue??Cne,ttl:this._init.tagTTL??Bne}}}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}};function oN(r){return e=>new Fw(e,r)}var zw={};V(zw,{Ed25519PrivateKey:()=>Oa,Ed25519PublicKey:()=>gf,generateKeyPair:()=>Mne,generateKeyPairFromSeed:()=>hN,unmarshalEd25519PrivateKey:()=>One,unmarshalEd25519PublicKey:()=>Kne});function Jn(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var mf=32,vi=64,Zm=32;function iN(){let r=De.utils.randomPrivateKey(),e=De.getPublicKey(r);return{privateKey:uN(r,e),publicKey:e}}function aN(r){if(r.length!==Zm)throw new TypeError('"seed" must be 32 bytes in length.');if(!(r instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');let e=r,t=De.getPublicKey(e);return{privateKey:uN(e,t),publicKey:t}}function cN(r,e){let t=r.subarray(0,Zm);return De.sign(e instanceof Uint8Array?e:e.subarray(),t)}function lN(r,e,t){return De.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}function uN(r,e){let t=new Uint8Array(vi);for(let n=0;n<Zm;n++)t[n]=r[n],t[Zm+n]=e[n];return t}var Tr={get(r=globalThis){let e=r.crypto;if(e==null||e.subtle==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}};var Vw={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function qw(r){let e=r?.algorithm??"AES-GCM",t=r?.keyLength??16,n=r?.nonceLength??12,s=r?.digest??"SHA-256",o=r?.saltLength??16,i=r?.iterations??32767,a=Tr.get();t*=8;async function c(f,h){let d=a.getRandomValues(new Uint8Array(o)),p=a.getRandomValues(new Uint8Array(n)),m={name:e,iv:p};typeof h=="string"&&(h=R(h));let y;if(h.length===0){y=await a.subtle.importKey("jwk",Vw,{name:"AES-GCM"},!0,["encrypt"]);try{let w={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}catch{y=await a.subtle.importKey("jwk",Vw,{name:"AES-GCM"},!0,["encrypt"])}}else{let w={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}let b=await a.subtle.encrypt(m,y,f);return le([d,m.iv,new Uint8Array(b)])}async function l(f,h){let d=f.subarray(0,o),p=f.subarray(o,o+n),m=f.subarray(o+n),y={name:e,iv:p};typeof h=="string"&&(h=R(h));let b;if(h.length===0)try{let E={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},x=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(E,x,{name:e,length:t},!0,["decrypt"])}catch{b=await a.subtle.importKey("jwk",Vw,{name:"AES-GCM"},!0,["decrypt"])}else{let E={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},x=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(E,x,{name:e,length:t},!0,["decrypt"])}let w=await a.subtle.decrypt(y,b,m);return new Uint8Array(w)}return{encrypt:c,decrypt:l}}async function yf(r,e){let n=await qw().encrypt(r,e);return qe.encode(n)}var Rt;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.Secp256k1="Secp256k1"})(Rt||(Rt={}));var Hw;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.Secp256k1=2]="Secp256k1"})(Hw||(Hw={}));(function(r){r.codec=()=>Te(Hw)})(Rt||(Rt={}));var mo;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Rt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=Rt.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(mo||(mo={}));var yo;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Rt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=Rt.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(yo||(yo={}));var gf=class{_key;constructor(e){this._key=bf(e,mf)}verify(e,t){return lN(this._key,t,e)}marshal(){return this._key}get bytes(){return mo.encode({Type:Rt.Ed25519,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return Jn(e)?e.then(({bytes:t})=>t):e.bytes}},Oa=class{_key;_publicKey;constructor(e,t){this._key=bf(e,vi),this._publicKey=bf(t,mf)}sign(e){return cN(this._key,e)}get public(){return new gf(this._publicKey)}marshal(){return this._key}get bytes(){return yo.encode({Type:Rt.Ed25519,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}async hash(){let e=$.digest(this.bytes),t;return Jn(e)?{bytes:t}=await e:t=e.bytes,t}async id(){let e=Lt.digest(this.public.bytes);return Fe.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if(t==="libp2p-key")return yf(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function One(r){if(r.length>vi){r=bf(r,vi+mf);let n=r.subarray(0,vi),s=r.subarray(vi,r.length);return new Oa(n,s)}r=bf(r,vi);let e=r.subarray(0,vi),t=r.subarray(mf);return new Oa(e,t)}function Kne(r){return r=bf(r,mf),new gf(r)}async function Mne(){let{privateKey:r,publicKey:e}=iN();return new Oa(r,e)}async function hN(r){let{privateKey:e,publicKey:t}=aN(r);return new Oa(e,t)}function bf(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new g(`Key must be a Uint8Array of length ${e}, got ${r.length}`,"ERR_INVALID_KEY_TYPE");return r}var Une={"P-256":256,"P-384":384,"P-521":521},Fne=Object.keys(Une),XCe=Fne.join(" / ");var jw={};V(jw,{MAX_RSA_KEY_SIZE:()=>Ef,RsaPrivateKey:()=>el,RsaPublicKey:()=>wf,fromJwk:()=>Jne,generateKeyPair:()=>Zne,unmarshalRsaPrivateKey:()=>Ww,unmarshalRsaPublicKey:()=>Xne});function Zc(r){if(isNaN(r)||r<=0)throw new g("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return zt(r)}var Ka={};V(Ka,{exportToPem:()=>Wne,importFromPem:()=>dN,jwkToPkcs1:()=>Hne,jwkToPkix:()=>$ne,pkcs1ToJwk:()=>qne,pkixToJwk:()=>zne});function qne(r){let{result:e}=tt(r),t=e.valueBlock.value;return{n:T(go(t[1].toBigInt()),"base64url"),e:T(go(t[2].toBigInt()),"base64url"),d:T(go(t[3].toBigInt()),"base64url"),p:T(go(t[4].toBigInt()),"base64url"),q:T(go(t[5].toBigInt()),"base64url"),dp:T(go(t[6].toBigInt()),"base64url"),dq:T(go(t[7].toBigInt()),"base64url"),qi:T(go(t[8].toBigInt()),"base64url"),kty:"RSA",alg:"RS256"}}function Hne(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new g("JWK was missing components","ERR_INVALID_PARAMETERS");let t=new re({value:[new X({value:0}),X.fromBigInt(bo(R(r.n,"base64url"))),X.fromBigInt(bo(R(r.e,"base64url"))),X.fromBigInt(bo(R(r.d,"base64url"))),X.fromBigInt(bo(R(r.p,"base64url"))),X.fromBigInt(bo(R(r.q,"base64url"))),X.fromBigInt(bo(R(r.dp,"base64url"))),X.fromBigInt(bo(R(r.dq,"base64url"))),X.fromBigInt(bo(R(r.qi,"base64url")))]}).toBER();return new Uint8Array(t,0,t.byteLength)}function zne(r){let{result:e}=tt(r),t=e.valueBlock.value[1].valueBlock.value[0].valueBlock.value;return{kty:"RSA",n:T(go(t[0].toBigInt()),"base64url"),e:T(go(t[1].toBigInt()),"base64url")}}function $ne(r){if(r.n==null||r.e==null)throw new g("JWK was missing components","ERR_INVALID_PARAMETERS");let t=new re({value:[new re({value:[new Le({value:"1.2.840.113549.1.1.1"}),new yt]}),new Hr({valueHex:new re({value:[X.fromBigInt(bo(R(r.n,"base64url"))),X.fromBigInt(bo(R(r.e,"base64url")))]}).toBER()})]}).toBER();return new Uint8Array(t,0,t.byteLength)}function go(r){let e=r.toString(16);e.length%2>0&&(e=`0${e}`);let t=e.length/2,n=new Uint8Array(t),s=0,o=0;for(;s<t;)n[s]=parseInt(e.slice(o,o+2),16),s+=1,o+=2;return n}function bo(r){let e=[];return r.forEach(function(t){let n=t.toString(16);n.length%2>0&&(n=`0${n}`),e.push(n)}),BigInt("0x"+e.join(""))}var Gne=16,$w=32,Gw=1e4;async function Wne(r,e){let t=Tr.get(),s=new re({value:[new X({value:0}),new re({value:[new Le({value:"1.2.840.113549.1.1.1"}),new yt]}),new nt({valueHex:r.marshal()})]}).toBER(),o=new Uint8Array(s,0,s.byteLength),i=Zc(Gne),a=await Xr(er,e,i,{c:Gw,dkLen:$w}),c=Zc(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,o),f=new re({value:[new nt({valueHex:i}),new X({value:Gw}),new X({value:$w}),new re({value:[new Le({value:"1.2.840.113549.2.11"}),new yt]})]}),h=new re({value:[new Le({value:"1.2.840.113549.1.5.13"}),new re({value:[new re({value:[new Le({value:"1.2.840.113549.1.5.12"}),f]}),new re({value:[new Le({value:"2.16.840.1.101.3.4.1.42"}),new nt({valueHex:c})]})]})]}),p=new re({value:[h,new nt({valueHex:u})]}).toBER(),m=new Uint8Array(p,0,p.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...T(m,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function dN(r,e){let t=Tr.get(),n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){let s=R(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=tt(s),{iv:i,salt:a,iterations:c,keySize:l,cipherText:u}=Yne(o),f=await Xr(er,e,a,{c,dkLen:l}),h=await t.subtle.importKey("raw",f,"AES-CBC",!1,["decrypt"]),d=gd(await t.subtle.decrypt({name:"AES-CBC",iv:i},h,u)),{result:p}=tt(d);n=pN(p)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){let s=R(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=tt(s);n=pN(o)}else throw new g("Could not parse private key from PEM data","ERR_INVALID_PARAMETERS");return Ww(n)}function Yne(r){let e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new g("Only pkcs5PBES2 encrypted private keys are supported","ERR_INVALID_PARAMS");let n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new g("Only pkcs5PBKDF2 key derivation functions are supported","ERR_INVALID_PARAMS");let o=n.valueBlock.value[1],i=gd(o.valueBlock.value[0].getValue()),a=Gw,c=$w;if(o.valueBlock.value.length===3)a=Number(o.valueBlock.value[1].toBigInt()),c=Number(o.valueBlock.value[2].toBigInt());else if(o.valueBlock.value.length===2)throw new g("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key","ERR_INVALID_PARAMS");let l=e.valueBlock.value[1].valueBlock.value[1],u=l.valueBlock.value[0].toString();if(u!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(u!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new g("Only AES-CBC encryption schemes are supported","ERR_INVALID_PARAMS")}}}}let f=gd(l.valueBlock.value[1].getValue());return{cipherText:gd(r.valueBlock.value[1].getValue()),salt:i,iterations:a,keySize:c,iv:f}}function pN(r){return gd(r.valueBlock.value[2].getValue())}function gd(r){return new Uint8Array(r,0,r.byteLength)}async function mN(r){let e=await Tr.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await bN(e);return{privateKey:t[0],publicKey:t[1]}}async function Yw(r){let t=[await Tr.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await jne(r)],n=await bN({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function yN(r,e){let t=await Tr.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await Tr.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(n,0,n.byteLength)}async function gN(r,e,t){let n=await Tr.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return Tr.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,e,t instanceof Uint8Array?t:t.subarray())}async function bN(r){if(r.privateKey==null||r.publicKey==null)throw new g("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([Tr.get().subtle.exportKey("jwk",r.privateKey),Tr.get().subtle.exportKey("jwk",r.publicKey)])}async function jne(r){return Tr.get().subtle.importKey("jwk",{kty:r.kty,n:r.n,e:r.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function ty(r){if(r.kty!=="RSA")throw new g("invalid key type","ERR_INVALID_KEY_TYPE");if(r.n==null)throw new g("invalid key modulus","ERR_INVALID_KEY_MODULUS");return R(r.n,"base64url").length*8}var Ef=8192,wf=class{_key;constructor(e){this._key=e}verify(e,t){return gN(this._key,t,e)}marshal(){return Ka.jwkToPkix(this._key)}get bytes(){return mo.encode({Type:Rt.RSA,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return Jn(e)?e.then(({bytes:t})=>t):e.bytes}},el=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t}genSecret(){return Zc(16)}sign(e){return yN(this._key,e)}get public(){if(this._publicKey==null)throw new g("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new wf(this._publicKey)}marshal(){return Ka.jwkToPkcs1(this._key)}get bytes(){return yo.encode({Type:Rt.RSA,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return Jn(e)?e.then(({bytes:t})=>t):e.bytes}async id(){let e=await this.public.hash();return T(e,"base58btc")}async export(e,t="pkcs-8"){if(t==="pkcs-8")return Ka.exportToPem(this,e);if(t==="libp2p-key")return yf(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};async function Ww(r){let e=Ka.pkcs1ToJwk(r);if(ty(e)>Ef)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let t=await Yw(e);return new el(t.privateKey,t.publicKey)}function Xne(r){let e=Ka.pkixToJwk(r);if(ty(e)>Ef)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new wf(e)}async function Jne(r){if(ty(r)>Ef)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await Yw(r);return new el(e.privateKey,e.publicKey)}async function Zne(r){if(r>Ef)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await mN(r);return new el(e.privateKey,e.publicKey)}var Xw={};V(Xw,{Secp256k1PrivateKey:()=>xf,Secp256k1PublicKey:()=>vf,generateKeyPair:()=>nse,unmarshalSecp256k1PrivateKey:()=>tse,unmarshalSecp256k1PublicKey:()=>rse});function wN(){return ae.utils.randomPrivateKey()}function EN(r,e){let t=$.digest(e instanceof Uint8Array?e:e.subarray());if(Jn(t))return t.then(({digest:n})=>ae.sign(n,r).toDERRawBytes()).catch(n=>{throw new g(String(n),"ERR_INVALID_INPUT")});try{return ae.sign(t.digest,r).toDERRawBytes()}catch(n){throw new g(String(n),"ERR_INVALID_INPUT")}}function vN(r,e,t){let n=$.digest(t instanceof Uint8Array?t:t.subarray());if(Jn(n))return n.then(({digest:s})=>ae.verify(e,s,r)).catch(s=>{throw new g(String(s),"ERR_INVALID_INPUT")});try{return ae.verify(e,n.digest,r)}catch(s){throw new g(String(s),"ERR_INVALID_INPUT")}}function xN(r){return ae.ProjectivePoint.fromHex(r).toRawBytes(!0)}function SN(r){try{ae.getPublicKey(r,!0)}catch(e){throw new g(String(e),"ERR_INVALID_PRIVATE_KEY")}}function Qw(r){try{ae.ProjectivePoint.fromHex(r)}catch(e){throw new g(String(e),"ERR_INVALID_PUBLIC_KEY")}}function _N(r){try{return ae.getPublicKey(r,!0)}catch(e){throw new g(String(e),"ERR_INVALID_PRIVATE_KEY")}}var vf=class{_key;constructor(e){Qw(e),this._key=e}verify(e,t){return vN(this._key,t,e)}marshal(){return xN(this._key)}get bytes(){return mo.encode({Type:Rt.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}async hash(){let e=$.digest(this.bytes),t;return Jn(e)?{bytes:t}=await e:t=e.bytes,t}},xf=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t??_N(e),SN(this._key),Qw(this._publicKey)}sign(e){return EN(this._key,e)}get public(){return new vf(this._publicKey)}marshal(){return this._key}get bytes(){return yo.encode({Type:Rt.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return Jn(e)?e.then(({bytes:t})=>t):e.bytes}async id(){let e=await this.public.hash();return T(e,"base58btc")}async export(e,t="libp2p-key"){if(t==="libp2p-key")return yf(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function tse(r){return new xf(r)}function rse(r){return new vf(r)}async function nse(){let r=wN();return new xf(r)}var tl={rsa:jw,ed25519:zw,secp256k1:Xw};function AN(r){let e=Object.keys(tl).join(" / ");return new g(`invalid or unsupported key type ${r}. Must be ${e}`,"ERR_UNSUPPORTED_KEY_TYPE")}function RN(r){let e=mo.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case Rt.RSA:return tl.rsa.unmarshalRsaPublicKey(t);case Rt.Ed25519:return tl.ed25519.unmarshalEd25519PublicKey(t);case Rt.Secp256k1:return tl.secp256k1.unmarshalSecp256k1PublicKey(t);default:throw AN(e.Type??"unknown")}}async function IN(r){let e=yo.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case Rt.RSA:return tl.rsa.unmarshalRsaPrivateKey(t);case Rt.Ed25519:return tl.ed25519.unmarshalEd25519PrivateKey(t);case Rt.Secp256k1:return tl.secp256k1.unmarshalSecp256k1PrivateKey(t);default:throw AN(e.Type??"RSA")}}var TN={ERR_SIGNATURE_NOT_VALID:"ERR_SIGNATURE_NOT_VALID"};var bd;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.publicKey=t.bytes();break;case 2:s.payloadType=t.bytes();break;case 3:s.payload=t.bytes();break;case 5:s.signature=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(bd||(bd={}));var Zn=class r{static createFromProtobuf=async e=>{let t=bd.decode(e),n=await xr(t.publicKey);return new r({peerId:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t)=>{if(t.privateKey==null)throw new Error("Missing private key");let n=e.domain,s=e.codec,o=e.marshal(),i=kN(n,s,o),c=await(await IN(t.privateKey)).sign(i.subarray());return new r({peerId:t,payloadType:s,payload:o,signature:c})};static openAndCertify=async(e,t)=>{let n=await r.createFromProtobuf(e);if(!await n.validate(t))throw new g("envelope signature is not valid for the given domain",TN.ERR_SIGNATURE_NOT_VALID);return n};peerId;payloadType;payload;signature;marshaled;constructor(e){let{peerId:t,payloadType:n,payload:s,signature:o}=e;this.peerId=t,this.payloadType=n,this.payload=s,this.signature=o}marshal(){if(this.peerId.publicKey==null)throw new Error("Missing public key");return this.marshaled==null&&(this.marshaled=bd.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return q(this.marshal(),e.marshal())}async validate(e){let t=kN(e,this.payloadType,this.payload);if(this.peerId.publicKey==null)throw new Error("Missing public key");return RN(this.peerId.publicKey).verify(t.subarray(),this.signature)}},kN=(r,e,t)=>{let n=R(r),s=Zt(n.byteLength),o=Zt(e.length),i=Zt(t.length);return new ke(s,n,o,e,i,t)};function DN(r,e){let t=(n,s)=>n.toString().localeCompare(s.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,s)=>e[s].equals(n)))}var PN="libp2p-peer-record",CN=Uint8Array.from([3,1]);var wd;(function(r){let e;(function(n){let s;n.codec=()=>(s==null&&(s=ee((o,i,a={})=>{a.lengthDelimited!==!1&&i.fork(),o.multiaddr!=null&&o.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(o.multiaddr)),a.lengthDelimited!==!1&&i.ldelim()},(o,i)=>{let a={multiaddr:new Uint8Array(0)},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:a.multiaddr=o.bytes();break;default:o.skipType(l&7);break}}return a})),s),n.encode=o=>Z(o,n.codec()),n.decode=o=>J(o,n.codec())})(e=r.AddressInfo||(r.AddressInfo={}));let t;r.codec=()=>(t==null&&(t=ee((n,s,o={})=>{if(o.lengthDelimited!==!1&&s.fork(),n.peerId!=null&&n.peerId.byteLength>0&&(s.uint32(10),s.bytes(n.peerId)),n.seq!=null&&n.seq!==0n&&(s.uint32(16),s.uint64(n.seq)),n.addresses!=null)for(let i of n.addresses)s.uint32(26),r.AddressInfo.codec().encode(i,s);o.lengthDelimited!==!1&&s.ldelim()},(n,s)=>{let o={peerId:new Uint8Array(0),seq:0n,addresses:[]},i=s==null?n.len:n.pos+s;for(;n.pos<i;){let a=n.uint32();switch(a>>>3){case 1:o.peerId=n.bytes();break;case 2:o.seq=n.uint64();break;case 3:o.addresses.push(r.AddressInfo.codec().decode(n,n.uint32()));break;default:n.skipType(a&7);break}}return o})),t),r.encode=n=>Z(n,r.codec()),r.decode=n=>J(n,r.codec())})(wd||(wd={}));var Dn=class r{static createFromProtobuf=e=>{let t=wd.decode(e),n=dt(t.peerId),s=(t.addresses??[]).map(i=>me(i.multiaddr)),o=t.seq;return new r({peerId:n,multiaddrs:s,seqNumber:o})};static DOMAIN=PN;static CODEC=CN;peerId;multiaddrs;seqNumber;domain=r.DOMAIN;codec=r.CODEC;marshaled;constructor(e){let{peerId:t,multiaddrs:n,seqNumber:s}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=wd.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof r)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!DN(this.multiaddrs,e.multiaddrs))}};function Bt(r,e){let t=io(r,e),n={read:async(s,o)=>{let i=await t.read(o);return s.decode(i)},write:async(s,o,i)=>{await t.write(o.encode(s),i)},writeV:async(s,o,i)=>{await t.writeV(s.map(a=>o.encode(a)),i)},pb:s=>({read:async o=>n.read(s,o),write:async(o,i)=>n.write(o,s,i),writeV:async(o,i)=>n.writeV(o,s,i),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}var Jw="/libp2p/relay";var BN="circuit-relay-relay";var sse=BigInt(131072),xi="/libp2p/circuit/relay/0.2.0/hop",Ed="/libp2p/circuit/relay/0.2.0/stop",ose=30*1e3,ise=30*1e3,ry=300;var Zw="ERR_RELAYED_DIAL",NN="ERR_HOP_REQUEST_FAILED";var Si;(function(r){let e;(function(s){s.RESERVE="RESERVE",s.CONNECT="CONNECT",s.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(s){s[s.RESERVE=0]="RESERVE",s[s.CONNECT=1]="CONNECT",s[s.STATUS=2]="STATUS"})(t||(t={})),function(s){s.codec=()=>Te(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=ee((s,o,i={})=>{i.lengthDelimited!==!1&&o.fork(),s.type!=null&&(o.uint32(8),r.Type.codec().encode(s.type,o)),s.peer!=null&&(o.uint32(18),Sf.codec().encode(s.peer,o)),s.reservation!=null&&(o.uint32(26),ny.codec().encode(s.reservation,o)),s.limit!=null&&(o.uint32(34),_f.codec().encode(s.limit,o)),s.status!=null&&(o.uint32(40),ir.codec().encode(s.status,o)),i.lengthDelimited!==!1&&o.ldelim()},(s,o)=>{let i={},a=o==null?s.len:s.pos+o;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:i.type=r.Type.codec().decode(s);break;case 2:i.peer=Sf.codec().decode(s,s.uint32());break;case 3:i.reservation=ny.codec().decode(s,s.uint32());break;case 4:i.limit=_f.codec().decode(s,s.uint32());break;case 5:i.status=ir.codec().decode(s);break;default:s.skipType(c&7);break}}return i})),n),r.encode=s=>Z(s,r.codec()),r.decode=s=>J(s,r.codec())})(Si||(Si={}));var Os;(function(r){let e;(function(s){s.CONNECT="CONNECT",s.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(s){s[s.CONNECT=0]="CONNECT",s[s.STATUS=1]="STATUS"})(t||(t={})),function(s){s.codec=()=>Te(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=ee((s,o,i={})=>{i.lengthDelimited!==!1&&o.fork(),s.type!=null&&(o.uint32(8),r.Type.codec().encode(s.type,o)),s.peer!=null&&(o.uint32(18),Sf.codec().encode(s.peer,o)),s.limit!=null&&(o.uint32(26),_f.codec().encode(s.limit,o)),s.status!=null&&(o.uint32(32),ir.codec().encode(s.status,o)),i.lengthDelimited!==!1&&o.ldelim()},(s,o)=>{let i={},a=o==null?s.len:s.pos+o;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:i.type=r.Type.codec().decode(s);break;case 2:i.peer=Sf.codec().decode(s,s.uint32());break;case 3:i.limit=_f.codec().decode(s,s.uint32());break;case 4:i.status=ir.codec().decode(s);break;default:s.skipType(c&7);break}}return i})),n),r.encode=s=>Z(s,r.codec()),r.decode=s=>J(s,r.codec())})(Os||(Os={}));var Sf;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(let o of t.addrs)n.uint32(18),n.bytes(o);s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={id:new Uint8Array(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.id=t.bytes();break;case 2:s.addrs.push(t.bytes());break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(Sf||(Sf={}));var ny;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(let o of t.addrs)n.uint32(18),n.bytes(o);t.voucher!=null&&(n.uint32(26),n.bytes(t.voucher)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={expire:0n,addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.expire=t.uint64();break;case 2:s.addrs.push(t.bytes());break;case 3:s.voucher=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(ny||(ny={}));var _f;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.duration=t.uint32();break;case 2:s.data=t.uint64();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(_f||(_f={}));var ir;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(ir||(ir={}));var eE;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(eE||(eE={}));(function(r){r.codec=()=>Te(eE)})(ir||(ir={}));var tE;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={relay:new Uint8Array(0),peer:new Uint8Array(0),expiration:0n},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.relay=t.bytes();break;case 2:s.peer=t.bytes();break;case 3:s.expiration=t.uint64();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(tE||(tE={}));async function rE(r){let e=new TextEncoder().encode(r),t=await $.digest(e);return Ve.createV0(t)}function nE(r){let e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}function rl(r,e){let t={[Symbol.iterator]:()=>t,next:()=>{let n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}var ar=class{map;constructor(e){if(this.map=new Map,e!=null)for(let[t,n]of e.entries())this.map.set(t.toString(),n)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return rl(this.map.entries(),e=>[Ce(e[0]),e[1]])}forEach(e){this.map.forEach((t,n)=>{e(t,Ce(n),this)})}get(e){return this.map.get(e.toString())}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),t)}keys(){return rl(this.map.keys(),e=>Ce(e))}values(){return this.map.values()}get size(){return this.map.size}};var cr=class r{set;constructor(e){if(this.set=new Set,e!=null)for(let t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return rl(this.set.entries(),e=>{let t=Ce(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{let n=Ce(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return rl(this.set.values(),e=>Ce(e))}intersection(e){let t=new r;for(let n of e)this.has(n)&&t.add(n);return t}difference(e){let t=new r;for(let n of this)e.has(n)||t.add(n);return t}union(e){let t=new r;for(let n of e)t.add(n);for(let n of this)t.add(n);return t}};var sy=class extends je{peerId;peerStore;contentRouting;registrar;started;topologyId;log;constructor(e){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.contentRouting=e.contentRouting,this.registrar=e.registrar}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(xi,{notifyOnTransient:!0,onConnect:e=>{this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}afterStart(){this.discover().catch(e=>{this.log.error("error discovering relays",e)})}stop(){this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async discover(){this.log("searching peer store for relays");let e=await this.peerStore.all({filters:[t=>t.protocols.includes(xi)],orders:[()=>Math.random()<.5?1:-1]});for(let t of e)this.log("found relay peer %p in content peer store",t.id),this.safeDispatchEvent("relay:discover",{detail:t.id});this.log("found %d relay peers in peer store",e.length);try{this.log("searching content routing for relays");let t=await rE(Jw),n=0;for await(let s of this.contentRouting.findProviders(t))if(s.multiaddrs.length>0&&!s.id.equals(this.peerId)){let o=s.id;n++,await this.peerStore.merge(o,{multiaddrs:s.multiaddrs}),this.log("found relay peer %p in content routing",o),this.safeDispatchEvent("relay:discover",{detail:o})}this.log("found %d relay peers in content routing",n)}catch(t){this.log.error("failed when finding relays on the network",t)}}};var Ma=class extends qo{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}};var lse=60*1e3*10,use=60*1e3*5,fse=30*1e3,oy=class extends je{peerId;connectionManager;transportManager;peerStore;events;reserveQueue;reservations;maxDiscoveredRelays;maxReservationQueueLength;reservationCompletionTimeout;started;log;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new ar,this.maxDiscoveredRelays=t?.discoverRelays??0,this.maxReservationQueueLength=t?.maxReservationQueueLength??100,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??1e4,this.started=!1,this.reserveQueue=new Ma({concurrency:t?.reservationConcurrency??1,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("peer:disconnect",n=>{this.#t(n.detail)})}isStarted(){return this.started}start(){this.started=!0}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}async addRelay(e,t){if(this.peerId.equals(e)){this.log("not trying to use self as relay");return}if(this.reserveQueue.size>this.maxReservationQueueLength){this.log("not adding relay as the queue is full");return}if(this.reserveQueue.has(e)){this.log("relay peer is already in the reservation queue");return}this.log("add relay %p",e),await this.reserveQueue.add(async()=>{try{let n=this.reservations.get(e);if(n!=null){if(nE(n.reservation.expire)>lse){this.log("already have reservation on relay peer %p and it expires in more than 10 minutes",e);return}clearTimeout(n.timeout),this.reservations.delete(e)}if(t==="discovered"&&[...this.reservations.values()].reduce((u,f)=>(f.type==="discovered"&&u++,u),0)>=this.maxDiscoveredRelays){this.log("already have enough discovered relays");return}let s=AbortSignal.timeout(this.reservationCompletionTimeout),o=await this.connectionManager.openConnection(e,{signal:s});if(o.remoteAddr.protoNames().includes("p2p-circuit")){this.log("not creating reservation over relayed connection");return}let i=await this.#e(o,{signal:s});this.log("created reservation on relay peer %p",e);let a=nE(i.expire),c=Math.min(Math.max(a-use,fse),Math.pow(2,31)-1),l=setTimeout(()=>{this.addRelay(e,t).catch(u=>{this.log.error("could not refresh reservation to relay %p",e,u)})},c);this.reservations.set(e,{timeout:l,reservation:i,type:t}),await this.peerStore.merge(e,{tags:{[BN]:{value:1,ttl:a}}}),await this.transportManager.listen([me(`/p2p/${e.toString()}/p2p-circuit`)])}catch(n){this.log.error("could not reserve slot on %p",e,n);let s=this.reservations.get(e);s!=null&&clearTimeout(s.timeout),this.reservations.delete(e)}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);let n=await e.newStream(xi,t),o=Bt(n).pb(Si);await o.write({type:Si.Type.RESERVE},t);let i;try{i=await o.read(t)}catch(c){throw this.log.error("error parsing reserve message response from %p because",e.remotePeer,c),n.abort(c),c}finally{await n.close()}if(i.status===ir.OK&&i.reservation!=null){let c=!1,l=e.remoteAddr.bytes;for(let u of i.reservation.addrs)if(q(l,u)){c=!0;break}return c||i.reservation.addrs.push(l),i.reservation}let a=`reservation failed with status ${i.status??"undefined"}`;throw this.log.error(a),new Error(a)}#t(e){let t=this.reservations.get(e);t!=null&&(this.log("connection to relay %p closed, removing reservation from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),this.safeDispatchEvent("relay:removed",{detail:e}),this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{})))}};function sE(r){let{stream:e,remoteAddr:t,logger:n}=r,s=n.forComponent("libp2p:stream:converter"),o=!1,i=!1,a=e.close.bind(e);e.close=async h=>{await a(h),f(!0)};let c=e.abort.bind(e);e.abort=h=>{c(h),f(!0)};let l=e.sink.bind(e);e.sink=async h=>{try{await l(h)}catch(d){d.type!=="aborted"&&s.error("%s error in sink",t,d)}finally{i=!0,f()}};let u={log:s,sink:e.sink,source:async function*(){try{for await(let h of e.source)h instanceof Uint8Array?yield h:yield*h}finally{o=!0,f()}}(),remoteAddr:t,timeline:{open:Date.now(),close:void 0},close:e.close,abort:e.abort};function f(h){h===!0&&(o=!0,i=!0),o&&i&&u.timeline.close==null&&(u.timeline.close=Date.now())}return u}var oE=class extends je{connectionManager;relayStore;listeningAddrs;log;constructor(e){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.relayStore=e.relayStore,this.listeningAddrs=new ar,this.relayStore.addEventListener("relay:removed",this._onRemoveRelayPeer)}_onRemoveRelayPeer=e=>{this.#e(e.detail)};async listen(e){this.log("listen on %a",e);let t=e.decapsulate("/p2p-circuit"),n=await this.connectionManager.openConnection(t);if(!this.relayStore.hasReservation(n.remotePeer)){this.log("making reservation on peer %p",n.remotePeer),await this.relayStore.addRelay(n.remotePeer,"configured");return}let s=this.relayStore.getReservation(n.remotePeer);if(s==null)throw new g("Did not have reservation after making reservation","ERR_NO_RESERVATION");if(this.listeningAddrs.has(n.remotePeer)){this.log("already listening on relay %p",n.remotePeer);return}this.listeningAddrs.set(n.remotePeer,s.addrs.map(o=>me(o).encapsulate("/p2p-circuit"))),this.safeDispatchEvent("listening",{})}getAddrs(){return[...this.listeningAddrs.values()].flat()}async close(){}#e(e){let t=this.listeningAddrs.has(e);this.log("relay peer removed %p - had reservation",e,t),this.listeningAddrs.delete(e),t&&(this.log.trace("removing relay event listener for peer %p",e),this.relayStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),this.safeDispatchEvent("close",{}))}};function ON(r){return new oE(r)}var hse=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(me)}catch{return!1}return!0},iE={maxInboundStopStreams:ry,maxOutboundStopStreams:ry,stopTimeout:3e4},iy=class{discovery;registrar;peerStore;connectionManager;transportManager;peerId;upgrader;addressManager;connectionGater;reservationStore;logger;maxInboundStopStreams;maxOutboundStopStreams;stopTimeout;started;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??iE.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??iE.maxOutboundStopStreams,this.stopTimeout=t.stopTimeout??iE.stopTimeout,t.discoverRelays!=null&&t.discoverRelays>0&&(this.discovery=new sy(e),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(s=>{this.log.error("could not add discovered relay %p",n.detail,s)})})),this.reservationStore=new oy(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.discover().catch(n=>{this.log.error("could not discover relays",n)})}),this.started=!1}isStarted(){return this.started}async start(){this.reservationStore.start(),await this.registrar.handle(Ed,e=>{this.onStop(e).catch(t=>{this.log.error("error while handling STOP protocol",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnTransientConnection:!0}),await this.discovery?.start(),this.started=!0}afterStart(){this.discovery?.afterStart()}async stop(){this.discovery?.stop(),this.reservationStore.stop(),await this.registrar.unhandle(Ed),this.started=!1}[$s]=!0;[Symbol.toStringTag]="libp2p/circuit-relay-v2";async dial(e,t={}){if(e.protoCodes().filter(p=>p===290).length!==1){let p="Invalid circuit relay address";throw this.log.error(p,e),new g(p,Zw)}let n=e.toString().split("/p2p-circuit"),s=me(n[0]),o=me(n[n.length-1]),i=s.getPeerId(),a=o.getPeerId();if(i==null||a==null){let p=`Circuit relay dial to ${e.toString()} failed as address did not have peer ids`;throw this.log.error(p),new g(p,Zw)}let c=Ce(i),l=Ce(a),u=!1,h=this.connectionManager.getConnections(c)[0];h==null&&(await this.peerStore.merge(c,{multiaddrs:[s]}),h=await this.connectionManager.openConnection(c,t),u=!0);let d;try{return d=await h.newStream(xi),await this.connectV2({stream:d,connection:h,destinationPeer:l,destinationAddr:o,relayAddr:s,ma:e,disconnectOnFailure:u})}catch(p){throw this.log.error("circuit relay dial to destination %p via relay %p failed",l,c,p),d?.abort(p),u&&await h.close(),p}}async connectV2({stream:e,connection:t,destinationPeer:n,destinationAddr:s,relayAddr:o,ma:i,disconnectOnFailure:a}){try{let c=Bt(e),l=c.pb(Si);await l.write({type:Si.Type.CONNECT,peer:{id:n.toBytes(),addrs:[me(s).bytes]}});let u=await l.read();if(u.status!==ir.OK)throw new g(`failed to connect via relay with status ${u?.status?.toString()??"undefined"}`,NN);let f=sE({stream:c.unwrap(),remoteAddr:i,localAddr:o.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger});return this.log("new outbound transient connection %a",f.remoteAddr),await this.upgrader.upgradeOutbound(f,{transient:!0})}catch(c){throw this.log.error(`Circuit relay dial to destination ${n.toString()} via relay ${t.remotePeer.toString()} failed`,c),a&&await t.close(),c}}createListener(e){return ON({connectionManager:this.connectionManager,relayStore:this.reservationStore,logger:this.logger})}filter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>Ls.matches(t))}async onStop({connection:e,stream:t}){if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(u){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",u)}let n=AbortSignal.timeout(this.stopTimeout),s=Bt(t).pb(Os),o=await s.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,o.type),o?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await s.write({type:Os.Type.STATUS,status:ir.MALFORMED_MESSAGE},{signal:n}),await t.close();return}if(o.type!==Os.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:Os.Type.STATUS,status:ir.UNEXPECTED_MESSAGE},{signal:n}),await t.close();return}if(!hse(o)){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:Os.Type.STATUS,status:ir.MALFORMED_MESSAGE},{signal:n}),await t.close();return}let i=dt(o.peer.id);if(await this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,i)===!0){this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await s.write({type:Os.Type.STATUS,status:ir.PERMISSION_DENIED},{signal:n}),await t.close();return}this.log.trace("sending success response to %p",e.remotePeer),await s.write({type:Os.Type.STATUS,status:ir.OK},{signal:n});let a=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${i.toString()}`),c=this.addressManager.getAddresses()[0],l=sE({stream:s.unwrap().unwrap(),remoteAddr:a,localAddr:c,logger:this.logger});this.log("new inbound transient connection %a",l.remoteAddr),await this.upgrader.upgradeInbound(l,{transient:!0}),this.log("%s connection %a upgraded","inbound",l.remoteAddr)}};function aE(r={}){return e=>new iy(e,r)}var KN=()=>{let r=new Error("Delay aborted");return r.name="AbortError",r},pse=new WeakMap;function dse({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:s}={})=>{if(s?.aborted)return Promise.reject(KN());let o,i,a,c=r??clearTimeout,l=()=>{c(o),a(KN())},u=()=>{s&&s.removeEventListener("abort",l)},f=new Promise((h,d)=>{i=()=>{u(),h(n)},a=d,o=(e??setTimeout)(i,t)});return s&&s.addEventListener("abort",l,{once:!0}),pse.set(f,()=>{c(o),o=null,i()}),f}}var mse=dse(),ay=mse;var Ks;(function(r){let e;(function(s){s.UNUSED="UNUSED",s.CONNECT="CONNECT",s.SYNC="SYNC"})(e=r.Type||(r.Type={}));let t;(function(s){s[s.UNUSED=0]="UNUSED",s[s.CONNECT=100]="CONNECT",s[s.SYNC=300]="SYNC"})(t||(t={})),function(s){s.codec=()=>Te(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=ee((s,o,i={})=>{if(i.lengthDelimited!==!1&&o.fork(),s.type!=null&&(o.uint32(8),r.Type.codec().encode(s.type,o)),s.observedAddresses!=null)for(let a of s.observedAddresses)o.uint32(18),o.bytes(a);i.lengthDelimited!==!1&&o.ldelim()},(s,o)=>{let i={observedAddresses:[]},a=o==null?s.len:s.pos+o;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:i.type=r.Type.codec().decode(s);break;case 2:i.observedAddresses.push(s.bytes());break;default:s.skipType(c&7);break}}return i})),n),r.encode=s=>Z(s,r.codec()),r.decode=s=>J(s,r.codec())})(Ks||(Ks={}));var yse=r=>r.toString().split("/").slice(1),vd=r=>({match:e=>e.length<1?!1:r(e[0])?e.slice(1):!1,pattern:"fn"}),Yt=r=>({match:e=>vd(t=>t===r).match(e),pattern:r}),uy=()=>({match:r=>vd(e=>typeof e=="string").match(r),pattern:"{string}"}),MN=()=>({match:r=>vd(e=>!isNaN(parseInt(e))).match(r),pattern:"{number}"}),es=()=>({match:r=>{if(r.length<2||r[0]!=="p2p"&&r[0]!=="ipfs")return!1;if(r[1].startsWith("Q")||r[1].startsWith("1"))try{Fe.decode(`z${r[1]}`)}catch{return!1}else return!1;return r.slice(2)},pattern:"/p2p/{peerid}"}),cy=()=>({match:r=>{if(r.length<2||r[0]!=="certhash")return!1;try{S3.decode(r[1])}catch{return!1}return r.slice(2)},pattern:"/certhash/{certhash}"}),wo=r=>({match:e=>{let t=r.match(e);return t===!1?e:t},pattern:`optional(${r.pattern})`}),Eo=(...r)=>({match:e=>{let t;for(let n of r){let s=n.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1},pattern:`or(${r.map(e=>e.pattern).join(", ")})`}),jt=(...r)=>({match:e=>{for(let t of r){let n=t.match(e);if(n===!1)return!1;e=n}return e},pattern:`and(${r.map(e=>e.pattern).join(", ")})`});function lr(...r){function e(s){let o=yse(s);for(let i of r){let a=i.match(o);if(a===!1)return!1;o=a}return o}function t(s){return e(s)!==!1}function n(s){let o=e(s);return o===!1?!1:o.length===0}return{matches:t,exactMatch:n}}var lE=jt(Yt("dns4"),uy()),uE=jt(Yt("dns6"),uy()),fE=jt(Yt("dnsaddr"),uy()),UN=jt(Yt("dns"),uy()),HOe=lr(lE),zOe=lr(uE),$Oe=lr(fE),FN=lr(Eo(UN,fE,lE,uE)),VN=jt(Yt("ip4"),vd($2)),qN=jt(Yt("ip6"),vd(G2)),HN=Eo(VN,qN),xd=Eo(HN,UN,lE,uE,fE),zN=lr(xd),GOe=lr(VN),WOe=lr(qN),$N=lr(HN),fy=jt(xd,Yt("tcp"),MN()),Sd=jt(xd,Yt("udp"),MN()),gse=Eo(fy,Sd),YOe=lr(fy),jOe=lr(Sd),hE=jt(Sd,Yt("quic")),hy=jt(Sd,Yt("quic-v1")),bse=Eo(hE,hy),QOe=lr(hE),XOe=lr(hy),cE=Eo(xd,fy,Sd,hE,hy),GN=Eo(jt(cE,Yt("ws"),wo(es()))),JOe=lr(GN),WN=Eo(jt(cE,Yt("wss"),wo(es())),jt(cE,Yt("tls"),Yt("ws"),wo(es()))),ZOe=lr(WN),YN=jt(gse,Yt("webrtc-direct"),cy(),wo(cy()),wo(es())),jN=lr(YN),QN=jt(hy,Yt("webtransport"),cy(),cy(),wo(es())),py=lr(QN),ly=Eo(GN,WN,jt(fy,wo(es())),jt(bse,wo(es())),jt(xd,wo(es())),YN,QN,es()),eKe=lr(ly),wse=jt(ly,Yt("p2p-circuit"),es()),_d=lr(wse),Ese=Eo(jt(ly,Yt("p2p-circuit"),Yt("webrtc"),es()),jt(ly,Yt("webrtc"),wo(es())),Yt("webrtc")),XN=lr(Ese);function pE(r,e){return _d.matches(r)||e.transportForMultiaddr(r)==null?!1:FN.matches(r)?!0:$N.matches(r)?Xn(r.toOptions().host)===!1:!1}var JN=1024*4,ZN=100,dy={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1},my=class{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??dy.timeout,this.retries=t.retries??dy.retries,this.maxInboundStreams=t.maxInboundStreams??dy.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??dy.maxOutboundStreams}isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(Ad,{notifyOnTransient:!0,onConnect:(e,t)=>{t.transient&&t.direction==="inbound"&&this.upgradeInbound(t).catch(n=>{this.log.error("error during outgoing DCUtR attempt",n)})}}),await this.registrar.handle(Ad,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(Ad),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){let s={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([Ad],{signal:s.signal,runOnTransientConnection:!0});let o=Bt(t,{maxDataLength:JN}).pb(Ks);this.log("B sending connect to %p",e.remotePeer);let i=Date.now();await o.write({type:Ks.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(f=>f.bytes)},s),this.log("B receiving connect from %p",e.remotePeer);let a=await o.read(s);if(a.type!==Ks.Type.CONNECT)throw this.log("A sent wrong message type"),new g("DCUtR message type was incorrect",ac);let c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new g("DCUtR connect message had no multiaddrs",ac);let l=Date.now()-i;this.log("A sending sync, rtt %dms",l),await o.write({type:Ks.Type.SYNC,observedAddresses:[]},s),this.log("A waiting for half RTT"),await ay(l/2),this.log("B dialing",c);let u=await this.connectionManager.openConnection(c,{signal:s.signal,priority:ZN});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,u.remoteAddr),await e.close(s);break}catch(o){if(this.log.error("error while attempting DCUtR on attempt %d of %d",n+1,this.retries,o),t?.abort(o),n===this.retries)throw o}finally{t!=null&&await t.close(s)}}}async attemptUnilateralConnectionUpgrade(e){let n=(await this.peerStore.get(e.remotePeer)).addresses.map(s=>{let o=s.multiaddr;return o.getPeerId()==null?o.encapsulate(`/p2p/${e.remotePeer}`):o}).filter(s=>pE(s,this.transportManager));if(n.length>0){let s=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",n);let o=await this.connectionManager.openConnection(n,{signal:s,force:!0});if(o.transient)throw new Error("Could not open a new, non-transient, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,o.remoteAddr),await e.close({signal:s}),!0}catch(o){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,n,o)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){let n={signal:AbortSignal.timeout(this.timeout)};try{let s=Bt(e,{maxDataLength:JN}).pb(Ks);this.log("A receiving connect");let o=await s.read(n);if(o.type!==Ks.Type.CONNECT)throw this.log("B sent wrong message type"),new g("DCUtR message type was incorrect",ac);if(o.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new g("DCUtR connect message had no multiaddrs",ac);let i=this.getDialableMultiaddrs(o.observedAddresses);if(i.length===0)throw this.log("B had no dialable multiaddrs"),new g("DCUtR connect message had no dialable multiaddrs",ac);if(this.log("A sending connect"),await s.write({type:Ks.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),this.log("A receiving sync"),(await s.read(n)).type!==Ks.Type.SYNC)throw new g("DCUtR message type was incorrect",ac);this.log("A dialing",i);let c=await this.connectionManager.openConnection(i,{signal:n.signal,priority:ZN,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(n)}catch(s){this.log.error("incoming DCUtR from %p failed",t.remotePeer,s),e.abort(s)}finally{await e.close(n)}}getDialableMultiaddrs(e){let t=[];for(let n of e)if(!(n==null||n.length===0))try{let s=me(n);if(!pE(s,this.transportManager))continue;t.push(s)}catch{}return t}};var Ad="/libp2p/dcutr";function eL(r={}){return e=>new my(e,r)}var tL="0.1.0",rL="id",nL="id/push",sL="1.0.0",oL="1.0.0";var cL=fe(aL(),1),dE=typeof window=="object"&&typeof document=="object"&&document.nodeType===9,yy=(0,cL.default)(),gy=dE&&!yy,lL=yy&&!dE,uL=yy&&dE,fL=typeof globalThis.process<"u"&&typeof globalThis.process.release<"u"&&globalThis.process.release.name==="node"&&!yy,by=typeof importScripts=="function"&&typeof self<"u"&&typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope,bKe=typeof globalThis.process<"u"&&typeof globalThis.process.env<"u"&&globalThis.process.env["NODE"+"_"+"ENV"]==="test",hL=typeof navigator<"u"&&navigator.product==="ReactNative";var nl;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(let o of t.listenAddrs)n.uint32(18),n.bytes(o);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(let o of t.protocols)n.uint32(26),n.string(o);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={listenAddrs:[],protocols:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 5:s.protocolVersion=t.string();break;case 6:s.agentVersion=t.string();break;case 1:s.publicKey=t.bytes();break;case 2:s.listenAddrs.push(t.bytes());break;case 4:s.observedAddr=t.bytes();break;case 3:s.protocols.push(t.string());break;case 8:s.signedPeerRecord=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(nl||(nl={}));var mE=1024*8,ts={protocolPrefix:"ipfs",timeout:6e4,maxInboundStreams:1,maxOutboundStreams:1,maxPushIncomingStreams:1,maxPushOutgoingStreams:1,maxObservedAddresses:10,maxIdentifyMessageSize:8192,runOnConnectionOpen:!0,runOnTransientConnection:!0},wy=class{identifyProtocolStr;identifyPushProtocolStr;host;started;timeout;peerId;peerStore;registrar;connectionManager;addressManager;maxInboundStreams;maxOutboundStreams;maxPushIncomingStreams;maxPushOutgoingStreams;maxIdentifyMessageSize;maxObservedAddresses;events;runOnTransientConnection;log;constructor(e,t={}){this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.events=e.events,this.log=e.logger.forComponent("libp2p:identify"),this.identifyProtocolStr=`/${t.protocolPrefix??ts.protocolPrefix}/${rL}/${sL}`,this.identifyPushProtocolStr=`/${t.protocolPrefix??ts.protocolPrefix}/${nL}/${oL}`,this.timeout=t.timeout??ts.timeout,this.maxInboundStreams=t.maxInboundStreams??ts.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??ts.maxOutboundStreams,this.maxPushIncomingStreams=t.maxPushIncomingStreams??ts.maxPushIncomingStreams,this.maxPushOutgoingStreams=t.maxPushOutgoingStreams??ts.maxPushOutgoingStreams,this.maxIdentifyMessageSize=t.maxIdentifyMessageSize??ts.maxIdentifyMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??ts.maxObservedAddresses,this.runOnTransientConnection=t.runOnTransientConnection??ts.runOnTransientConnection,this.host={protocolVersion:`${t.protocolPrefix??ts.protocolPrefix}/${tL}`,agentVersion:t.agentVersion??`${e.nodeInfo.name}/${e.nodeInfo.version}`},(t.runOnConnectionOpen??ts.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{let s=n.detail;this.identify(s).catch(o=>{this.log.error("error during identify trigged by connection:open",o)})}),e.events.addEventListener("self:peer:update",n=>{this.push().catch(s=>{this.log.error(s)})}),this.host.agentVersion===`${e.nodeInfo.name}/${e.nodeInfo.version}`&&(fL||lL?this.host.agentVersion+=` UserAgent=${globalThis.process.version}`:(gy||by||uL||hL)&&(this.host.agentVersion+=` UserAgent=${globalThis.navigator.userAgent}`))}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:R(this.host.agentVersion),ProtocolVersion:R(this.host.protocolVersion)}}),await this.registrar.handle(this.identifyProtocolStr,e=>{this._handleIdentify(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),await this.registrar.handle(this.identifyPushProtocolStr,e=>{this._handlePush(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxPushIncomingStreams,maxOutboundStreams:this.maxPushOutgoingStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.identifyProtocolStr),await this.registrar.unhandle(this.identifyPushProtocolStr),this.started=!1}async pushToConnections(e){let t=this.addressManager.getAddresses().map(u=>u.decapsulateCode(ve("p2p").code)),n=new Dn({peerId:this.peerId,multiaddrs:t}),s=await Zn.seal(n,this.peerId),o=this.registrar.getProtocols(),i=await this.peerStore.get(this.peerId),a=T(i.metadata.get("AgentVersion")??R(this.host.agentVersion)),c=T(i.metadata.get("ProtocolVersion")??R(this.host.protocolVersion)),l=e.map(async u=>{let f,h=AbortSignal.timeout(this.timeout);Ze(1/0,h);try{f=await u.newStream(this.identifyPushProtocolStr,{signal:h,runOnTransientConnection:this.runOnTransientConnection}),await Bt(f,{maxDataLength:this.maxIdentifyMessageSize??mE}).pb(nl).write({listenAddrs:t.map(p=>p.bytes),signedPeerRecord:s.marshal(),protocols:o,agentVersion:a,protocolVersion:c},{signal:h}),await f.close({signal:h})}catch(d){this.log.error("could not push identify update to peer",d),f?.abort(d)}});await Promise.all(l)}async push(){if(!this.isStarted())return;let e=[];await Promise.all(this.connectionManager.getConnections().map(async t=>{try{if(!(await this.peerStore.get(t.remotePeer)).protocols.includes(this.identifyPushProtocolStr))return;e.push(t)}catch(n){if(n.code!==G9)throw n}})),await this.pushToConnections(e)}async _identify(e,t={}){let n;if(t.signal==null){let s=AbortSignal.timeout(this.timeout);Ze(1/0,s),t={...t,signal:s}}try{n=await e.newStream(this.identifyProtocolStr,{...t,runOnTransientConnection:this.runOnTransientConnection});let o=await Bt(n,{maxDataLength:this.maxIdentifyMessageSize??mE}).pb(nl).read(t);return await n.close(t),o}catch(s){throw this.log.error("error while reading identify message",s),n?.abort(s),s}}async identify(e,t={}){let n=await this._identify(e,t),{publicKey:s,protocols:o,observedAddr:i}=n;if(s==null)throw new g("public key was missing from identify message","ERR_MISSING_PUBLIC_KEY");let a=await xr(s);if(!e.remotePeer.equals(a))throw new g("identified peer does not match the expected peer","ERR_INVALID_PEER");if(this.peerId.equals(a))throw new g("identified peer is our own peer id?","ERR_INVALID_PEER");let c=xse(i);return this.log("identify completed for peer %p and protocols %o",a,o),this.log("our observed address is %a",c),c!=null&&this.addressManager.getObservedAddrs().length<(this.maxObservedAddresses??1/0)&&(this.log("storing our observed address %a",c),this.addressManager.addObservedAddr(c)),this.#e(e,n)}async _handleIdentify(e){let{connection:t,stream:n}=e,s=AbortSignal.timeout(this.timeout);Ze(1/0,s);try{let o=this.peerId.publicKey??new Uint8Array(0),i=await this.peerStore.get(this.peerId),a=this.addressManager.getAddresses().map(f=>f.decapsulateCode(ve("p2p").code)),c=i.peerRecordEnvelope;if(a.length>0&&c==null){let f=new Dn({peerId:this.peerId,multiaddrs:a});c=(await Zn.seal(f,this.peerId)).marshal().subarray()}let l=t.remoteAddr.bytes;zN.matches(t.remoteAddr)||(l=void 0),await Bt(n).pb(nl).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:o,listenAddrs:a.map(f=>f.bytes),signedPeerRecord:c,observedAddr:l,protocols:i.protocols},{signal:s}),await n.close({signal:s})}catch(o){this.log.error("could not respond to identify request",o),n.abort(o)}}async _handlePush(e){let{connection:t,stream:n}=e;try{if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");let s={signal:AbortSignal.timeout(this.timeout)},i=await Bt(n,{maxDataLength:this.maxIdentifyMessageSize??mE}).pb(nl).read(s);await n.close(s),await this.#e(t,i)}catch(s){this.log.error("received invalid message",s),n.abort(s);return}this.log("handled push from %p",t.remotePeer)}async#e(e,t){if(this.log("received identify from %p",e.remotePeer),t==null)throw new g("message was null or undefined","ERR_INVALID_MESSAGE");let n={};if(t.listenAddrs.length>0&&(n.addresses=t.listenAddrs.map(i=>({isCertified:!1,multiaddr:me(i)}))),t.protocols.length>0&&(n.protocols=t.protocols),t.publicKey!=null&&(n.publicKey=t.publicKey,!(await xr(t.publicKey)).equals(e.remotePeer)))throw new g("public key did not match remote PeerId","ERR_INVALID_PUBLIC_KEY");let s;if(t.signedPeerRecord!=null){this.log("received signedPeerRecord from %p",e.remotePeer);let i=t.signedPeerRecord,a=await Zn.openAndCertify(i,Dn.DOMAIN),c=Dn.createFromProtobuf(a.payload);if(!c.peerId.equals(a.peerId))throw new g("signing key does not match PeerId in the PeerRecord","ERR_INVALID_SIGNING_KEY");if(!e.remotePeer.equals(c.peerId))throw new g("signing key does not match remote PeerId","ERR_INVALID_PEER_RECORD_KEY");let l;try{l=await this.peerStore.get(c.peerId)}catch(u){if(u.code!=="ERR_NOT_FOUND")throw u}if(l!=null&&(n.metadata=l.metadata,l.peerRecordEnvelope!=null)){let u=await Zn.createFromProtobuf(l.peerRecordEnvelope),f=Dn.createFromProtobuf(u.payload);f.seqNumber>=c.seqNumber&&(this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",f.seqNumber,c.seqNumber),c=f,i=l.peerRecordEnvelope)}n.peerRecordEnvelope=i,n.addresses=c.multiaddrs.map(u=>({isCertified:!0,multiaddr:u})),s={seq:c.seqNumber,addresses:c.multiaddrs}}else this.log("%p did not send a signed peer record",e.remotePeer);if(this.log("patching %p with",e.remotePeer,n),await this.peerStore.patch(e.remotePeer,n),t.agentVersion!=null||t.protocolVersion!=null){let i={};t.agentVersion!=null&&(i.AgentVersion=R(t.agentVersion)),t.protocolVersion!=null&&(i.ProtocolVersion=R(t.protocolVersion)),this.log("merging %p metadata",e.remotePeer,i),await this.peerStore.merge(e.remotePeer,{metadata:i})}let o={peerId:e.remotePeer,protocolVersion:t.protocolVersion,agentVersion:t.agentVersion,publicKey:t.publicKey,listenAddrs:t.listenAddrs.map(i=>me(i)),observedAddr:t.observedAddr==null?void 0:me(t.observedAddr),protocols:t.protocols,signedPeerRecord:s,connection:e};return this.events.safeDispatchEvent("peer:identify",{detail:o}),o}};function xse(r){if(r!=null&&r.length>0)try{return me(r)}catch{}}function pL(r={}){return e=>new wy(e,r)}var dL="/ipfs/kad/1.0.0",mL="/dht/record",yE="/dht/provider";var yL;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:{s.key=t.bytes();break}case 2:{s.value=t.bytes();break}case 3:{s.author=t.bytes();break}case 4:{s.signature=t.bytes();break}case 5:{s.timeReceived=t.string();break}default:{t.skipType(i&7);break}}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(yL||(yL={}));var Ue;(function(r){r.PUT_VALUE="PUT_VALUE",r.GET_VALUE="GET_VALUE",r.ADD_PROVIDER="ADD_PROVIDER",r.GET_PROVIDERS="GET_PROVIDERS",r.FIND_NODE="FIND_NODE",r.PING="PING"})(Ue||(Ue={}));var Ey;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(Ey||(Ey={}));(function(r){r.codec=()=>Te(Ey)})(Ue||(Ue={}));var Rf;(function(r){r.NOT_CONNECTED="NOT_CONNECTED",r.CONNECTED="CONNECTED",r.CAN_CONNECT="CAN_CONNECT",r.CANNOT_CONNECT="CANNOT_CONNECT"})(Rf||(Rf={}));var gE;(function(r){r[r.NOT_CONNECTED=0]="NOT_CONNECTED",r[r.CONNECTED=1]="CONNECTED",r[r.CAN_CONNECT=2]="CAN_CONNECT",r[r.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(gE||(gE={}));(function(r){r.codec=()=>Te(gE)})(Rf||(Rf={}));var Af;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.multiaddrs!=null)for(let o of t.multiaddrs)n.uint32(18),n.bytes(o);t.connection!=null&&(n.uint32(24),Rf.codec().encode(t.connection,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={id:Pe(0),multiaddrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:{s.id=t.bytes();break}case 2:{s.multiaddrs.push(t.bytes());break}case 3:{s.connection=Rf.codec().decode(t);break}default:{t.skipType(i&7);break}}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(Af||(Af={}));var rs;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.type!=null&&Ey[t.type]!==0&&(n.uint32(8),Ue.codec().encode(t.type,n)),t.clusterLevel!=null&&(n.uint32(80),n.int32(t.clusterLevel)),t.key!=null&&(n.uint32(18),n.bytes(t.key)),t.record!=null&&(n.uint32(26),n.bytes(t.record)),t.closer!=null)for(let o of t.closer)n.uint32(66),Af.codec().encode(o,n);if(t.providers!=null)for(let o of t.providers)n.uint32(74),Af.codec().encode(o,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={type:Ue.PUT_VALUE,closer:[],providers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:{s.type=Ue.codec().decode(t);break}case 10:{s.clusterLevel=t.int32();break}case 2:{s.key=t.bytes();break}case 3:{s.record=t.bytes();break}case 8:{s.closer.push(Af.codec().decode(t,t.uint32()));break}case 9:{s.providers.push(Af.codec().decode(t,t.uint32()));break}default:{t.skipType(i&7);break}}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(rs||(rs={}));function bE(r,e={}){let t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:Ue[r.type]};return e.onProgress?.(new Dt("kad-dht:query:send-query",{detail:t})),t}function Rd(r,e={}){let t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer!=null?r.closer:[],providers:r.providers!=null?r.providers:[]};return e.onProgress?.(new Dt("kad-dht:query:peer-response",{detail:t})),t}function vy(r,e={}){let t={...r,name:"FINAL_PEER",type:2};return e.onProgress?.(new Dt("kad-dht:query:final-peer",{detail:t})),t}function Pn(r,e={}){let t={...r,name:"QUERY_ERROR",type:3};return e.onProgress?.(new Dt("kad-dht:query:query-error",{detail:t})),t}function wE(r,e={}){let t={...r,name:"PROVIDER",type:4};return e.onProgress?.(new Dt("kad-dht:query:provider",{detail:t})),t}function Id(r,e={}){let t={...r,name:"VALUE",type:5};return e.onProgress?.(new Dt("kad-dht:query:value",{detail:t})),t}function EE(r,e={}){let t={...r,name:"DIAL_PEER",type:7};return e.onProgress?.(new Dt("kad-dht:query:dial-peer",{detail:t})),t}var Td;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={key:new Uint8Array(0),value:new Uint8Array(0),timeReceived:""},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.key=t.bytes();break;case 2:s.value=t.bytes();break;case 5:s.timeReceived=t.string();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(Td||(Td={}));function gL(r){let e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),s=String(r.getUTCHours()).padStart(2,"0"),o=String(r.getUTCMinutes()).padStart(2,"0"),i=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${s}:${o}:${i}.${c}Z`}function bL(r){let e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");let n=parseInt(t[1],10),s=parseInt(t[2],10)-1,o=parseInt(t[3],10),i=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,s,o,i,a,c,l))}var gr=class r{key;value;timeReceived;constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return Td.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:gL(this.timeReceived)}}static deserialize(e){let t=Td.decode(e);return new r(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){let t=bL(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new r(e.key,e.value,t)}};function wL(r,e,t){if(t.length===0){let i="No records given";throw new g(i,"ERR_NO_RECORDS_RECEIVED")}let s=T(e).split("/");if(s.length<3){let i="Record key does not have a selector function";throw new g(i,"ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")}let o=r[s[1].toString()];if(o==null){let i=`No selector function configured for key type "${s[1]}"`;throw new g(i,"ERR_UNRECOGNIZED_KEY_PREFIX")}return t.length===1?0:o(e,t)}function _se(r,e){return 0}var EL={pk:_se};async function If(r,e){let t=e.key,s=T(t).split("/");if(s.length<3)return;let o=r[s[1].toString()];if(o==null){let i=`No validator available for key type "${s[1]}"`;throw new g(i,"ERR_INVALID_RECORD_KEY_TYPE")}await o(t,e.value)}var Ase=async(r,e)=>{if(!(r instanceof Uint8Array))throw new g('"key" must be a Uint8Array',"ERR_INVALID_RECORD_KEY_NOT_BUFFER");if(r.byteLength<5)throw new g("invalid public key record","ERR_INVALID_RECORD_KEY_TOO_SHORT");if(T(r.subarray(0,4))!=="/pk/")throw new g("key was not prefixed with /pk/","ERR_INVALID_RECORD_KEY_BAD_PREFIX");let n=r.slice(4),s=await $.digest(e);if(!q(n,s.bytes))throw new g("public key does not match passed in key","ERR_INVALID_RECORD_HASH_MISMATCH")},vL={pk:Ase};var Rse=R("/pk/");function vE(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{let[[t,n]]=e.stringTuples();if(t===53||t===54||t===55)return n!=="localhost";if(t!==4&&t!==6||n==null)return!1;let s=Xn(n);return s==null?!0:!s})}}async function Ua(r){return(await $.digest(r)).digest}async function Ms(r){return Ua(r.toBytes())}function _i(r){return new ct(`${mL}/${T(r,"base32")}`,!1)}function xL(r){return le([Rse,r.toBytes()])}function SL(r){return T(r.subarray(0,4))==="/pk/"}function _L(r){return dt(r.subarray(4))}function xE(r,e){let t=new Date;return new gr(r,e,t).serialize()}function AL(r,e=100){let t;return()=>{clearTimeout(t),t=setTimeout(()=>{r()},e)}}var Ise=290,Tse=54,kse=55,Dse=56,Pse=4,Cse=41;function RL(r){let e=r.stringTuples();for(let t of e)if(t[0]===Ise)return!1;if(e[0][0]===Tse||e[0][0]===kse||e[0][0]===Dse)return!0;if(e[0][0]===Pse||e[0][0]===Cse){let t=Xn(`${e[0][1]}`);return t==null||!t}return!1}var xy=class{log;components;validators;selectors;peerRouting;queryManager;network;constructor(e,t){let{validators:n,selectors:s,peerRouting:o,queryManager:i,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.validators=n,this.selectors=s,this.peerRouting=o,this.queryManager=i,this.network=a}async putLocal(e,t){let n=_i(e);await this.components.datastore.put(n,t)}async getLocal(e){this.log("getLocal %b",e);let t=_i(e);this.log("fetching record for key %k",t);let n=await this.components.datastore.get(t);this.log("found %k in local datastore",t);let s=gr.deserialize(n);return await If(this.validators,s),s}async*sendCorrectionRecord(e,t,n,s={}){this.log("sendCorrection for %b",e);let o=xE(e,n);for(let{value:i,from:a}of t){if(q(i,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{let u=_i(e);this.log(`Storing corrected record for key ${u.toString()}`),await this.components.datastore.put(u,o.subarray())}catch(u){this.log.error("Failed error correcting self",u)}continue}let c=!1,l={type:Ue.PUT_VALUE,key:e,record:o};for await(let u of this.network.sendRequest(a,l,s))u.name==="PEER_RESPONSE"&&u.record!=null&&q(u.record.value,gr.deserialize(o).value)&&(c=!0),yield u;c||(yield Pn({from:a,error:new g("value not put correctly","ERR_PUT_VALUE_INVALID")},s)),this.log.error("Failed error correcting entry")}}async*put(e,t,n={}){this.log("put key %b value %b",e,t);let s=xE(e,t),o=_i(e);this.log(`storing record for key ${o.toString()}`),await this.components.datastore.put(o,s.subarray()),yield*lt(this.peerRouting.getClosestPeers(e,{signal:n.signal}),i=>hs(i,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];let c=[],l={type:Ue.PUT_VALUE,key:e,record:s};this.log("send put to %p",a.peer.id);for await(let u of this.network.sendRequest(a.peer.id,l,n))c.push(u),u.name==="PEER_RESPONSE"&&(u.record!=null&&q(u.record.value,gr.deserialize(s).value)||c.push(Pn({from:a.peer.id,error:new g("value not put correctly","ERR_PUT_VALUE_INVALID")},n)));return c}),i=>Ei(i,{ordered:!1,concurrency:3}),async function*(i){for await(let a of i)yield*a})}async*get(e,t={}){this.log("get %b",e);let n=[];for await(let a of this.getMany(e,t))a.name==="VALUE"&&n.push(a),yield a;if(n.length===0)return;let s=n.map(a=>a.value),o=0;try{o=wL(this.selectors,e,s)}catch(a){if(a.code!=="ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")throw a}let i=s[o];if(this.log("GetValue %b %b",e,i),i==null)throw new g("best value was not found","ERR_NOT_FOUND");yield*this.sendCorrectionRecord(e,n,i,t),yield n[o]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{let o=await this.getLocal(e);yield Id({value:o.value,from:this.components.peerId},t)}catch(o){this.log("error getting local value for %b",e,o)}let n=this,s=async function*({peer:o,signal:i}){for await(let a of n.peerRouting.getValueOrPeers(o,e,{signal:i}))yield a,a.name==="PEER_RESPONSE"&&a.record!=null&&(yield Id({from:o,value:a.record.value},t))};yield*this.queryManager.run(e,s,t)}};function IL(r,e){return{id:r.id.toBytes(),multiaddrs:(r.multiaddrs??[]).map(n=>n.bytes),connection:e}}function kd(r){if(r.id==null)throw new Error("Invalid peer in message");return{id:dt(r.id),multiaddrs:(r.multiaddrs??[]).map(e=>me(e))}}var Sy=class{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){let{network:n,peerRouting:s,queryManager:o,routingTable:i,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=n,this.peerRouting=s,this.queryManager=o,this.routingTable=i,this.providers=a}async*provide(e,t,n={}){this.log("provide %s",e),await this.providers.addProvider(e,this.components.peerId);let s={type:Ue.ADD_PROVIDER,key:e.multihash.bytes,providers:[IL({id:this.components.peerId,multiaddrs:t})]},o=0,i=a=>async()=>{if(a.name!=="FINAL_PEER")return[a];let c=[];this.log("putProvider %s to %p",e,a.peer.id);try{this.log("sending provider record for %s to %p",e,a.peer.id);for await(let l of this.network.sendMessage(a.peer.id,s,n))l.name==="PEER_RESPONSE"&&(this.log("sent provider record for %s to %p",e,a.peer.id),o++),c.push(l)}catch(l){this.log.error("error sending provide record to peer %p",a.peer.id,l),c.push(Pn({from:a.peer.id,error:l},n))}return c};yield*lt(this.peerRouting.getClosestPeers(e.multihash.bytes,n),a=>hs(a,c=>i(c)),a=>Ei(a,{ordered:!1,concurrency:3}),async function*(a){for await(let c of a)yield*c}),this.log("sent provider records to %d peers",o)}async*findProviders(e,t){let n=this.routingTable.kBucketSize,s=e.multihash.bytes,o=this;this.log("findProviders %c",e);let i=await this.providers.getProviders(e);if(i.length>0){let l=[];for(let u of i.slice(0,n))try{let f=await this.components.peerStore.get(u);l.push({id:u,multiaddrs:f.addresses.map(({multiaddr:h})=>h)})}catch(f){if(f.code!=="ERR_NOT_FOUND")throw f;this.log("no peer store entry for %p",u)}yield Rd({from:this.components.peerId,messageType:Ue.GET_PROVIDERS,providers:l},t),yield wE({from:this.components.peerId,providers:l},t)}if(i.length>=n)return;let a=async function*({peer:l,signal:u}){let f={type:Ue.GET_PROVIDERS,key:s};yield*o.network.sendRequest(l,f,{...t,signal:u})},c=new cr(i);for await(let l of this.queryManager.run(s,a,t))if(yield l,l.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",l.providers.length,e,l.closer.length);let u=[];for(let f of l.providers)c.has(f.id)||(c.add(f.id),u.push(f));if(u.length>0&&(yield wE({from:l.from,providers:u},t)),c.size===n)return}}};var _y=class extends je{log;protocol;running;components;constructor(e,t){super();let{protocol:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=n}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n={}){if(!this.running)return;let s=t.type;if(s==null)throw new Oh("Message type was missing","ERR_INVALID_PARAMETERS");this.log("sending %s to %p",t.type,e),yield EE({peer:e},n),yield bE({to:e,type:s},n);let o;try{let a=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),c=await this._writeReadMessage(a,t,n);yield Rd({from:e,messageType:c.type,closer:c.closer.map(kd),providers:c.providers.map(kd),record:c.record==null?void 0:gr.deserialize(c.record)},n)}catch(i){this.log.error("could not send %s to %p",t.type,e,i),yield Pn({from:e,error:i},n)}finally{o!=null&&await o.close()}}async*sendMessage(e,t,n={}){if(!this.running)return;let s=t.type;if(s==null)throw new Oh("Message type was missing","ERR_INVALID_PARAMETERS");this.log("sending %s to %p",t.type,e),yield EE({peer:e},n),yield bE({to:e,type:s},n);let o;try{let a=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n);await this._writeMessage(a,t,n),yield Rd({from:e,messageType:s},n)}catch(i){yield Pn({from:e,error:i},n)}finally{o!=null&&await o.close()}}async _writeMessage(e,t,n){let s=Bt(e);await s.write(t,rs,n),await s.unwrap().close(n)}async _writeReadMessage(e,t,n){let s=Bt(e);await s.write(t,rs,n);let o=await s.read(rs,n);return await s.unwrap().close(n),o.closer.forEach(i=>{this.safeDispatchEvent("peer",{detail:kd(i)})}),o.providers.forEach(i=>{this.safeDispatchEvent("peer",{detail:kd(i)})}),o}};var It={get(r=globalThis){let e=r.crypto;if(e==null||e.subtle==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}};var TL={SHA1:20,SHA256:32,SHA512:64};var Bse={SHA1:"SHA-1",SHA256:"SHA-256",SHA512:"SHA-512"},Nse=async(r,e)=>{let t=await It.get().subtle.sign({name:"HMAC"},r,e);return new Uint8Array(t,0,t.byteLength)};async function kL(r,e){let t=Bse[r],n=await It.get().subtle.importKey("raw",e,{name:"HMAC",hash:{name:t}},!1,["sign"]);return{async digest(s){return Nse(n,s)},length:TL[r]}}var Ty={};V(Ty,{Ed25519PrivateKey:()=>Ri,Ed25519PublicKey:()=>sl,MAX_RSA_KEY_SIZE:()=>il,RsaPrivateKey:()=>Va,RsaPublicKey:()=>ol,Secp256k1PrivateKey:()=>cl,Secp256k1PublicKey:()=>al,generateEphemeralKeyPair:()=>VL,generateKeyPair:()=>soe,generateKeyPairFromSeed:()=>ooe,importKey:()=>loe,keyStretcher:()=>zL,keysPBM:()=>Pf,marshalPrivateKey:()=>coe,marshalPublicKey:()=>aoe,supportedKeys:()=>Ii,unmarshalPrivateKey:()=>rO,unmarshalPublicKey:()=>ioe});var TE={};V(TE,{Ed25519PrivateKey:()=>Ri,Ed25519PublicKey:()=>sl,generateKeyPair:()=>Mse,generateKeyPairFromSeed:()=>IE,unmarshalEd25519PrivateKey:()=>Ose,unmarshalEd25519PublicKey:()=>Kse});function _E(r,e){let t=R(r,"base64urlpad");if(e!=null){if(t.length>e)throw new Error("byte array longer than desired length");t=le([new Uint8Array(e-t.length),t])}return t}function ns(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var kf=32,Ai=64,Ay=32;function PL(){let r=De.utils.randomPrivateKey(),e=De.getPublicKey(r);return{privateKey:LL(r,e),publicKey:e}}function CL(r){if(r.length!==Ay)throw new TypeError('"seed" must be 32 bytes in length.');if(!(r instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');let e=r,t=De.getPublicKey(e);return{privateKey:LL(e,t),publicKey:t}}function BL(r,e){let t=r.subarray(0,Ay);return De.sign(e instanceof Uint8Array?e:e.subarray(),t)}function NL(r,e,t){return De.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}function LL(r,e){let t=new Uint8Array(Ai);for(let n=0;n<Ay;n++)t[n]=r[n],t[Ay+n]=e[n];return t}var AE={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function Ry(r){let e=r?.algorithm??"AES-GCM",t=r?.keyLength??16,n=r?.nonceLength??12,s=r?.digest??"SHA-256",o=r?.saltLength??16,i=r?.iterations??32767,a=It.get();t*=8;async function c(f,h){let d=a.getRandomValues(new Uint8Array(o)),p=a.getRandomValues(new Uint8Array(n)),m={name:e,iv:p};typeof h=="string"&&(h=R(h));let y;if(h.length===0){y=await a.subtle.importKey("jwk",AE,{name:"AES-GCM"},!0,["encrypt"]);try{let w={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}catch{y=await a.subtle.importKey("jwk",AE,{name:"AES-GCM"},!0,["encrypt"])}}else{let w={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}let b=await a.subtle.encrypt(m,y,f);return le([d,m.iv,new Uint8Array(b)])}async function l(f,h){let d=f.subarray(0,o),p=f.subarray(o,o+n),m=f.subarray(o+n),y={name:e,iv:p};typeof h=="string"&&(h=R(h));let b;if(h.length===0)try{let E={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},x=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(E,x,{name:e,length:t},!0,["decrypt"])}catch{b=await a.subtle.importKey("jwk",AE,{name:"AES-GCM"},!0,["decrypt"])}else{let E={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},x=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(E,x,{name:e,length:t},!0,["decrypt"])}let w=await a.subtle.decrypt(y,b,m);return new Uint8Array(w)}return{encrypt:c,decrypt:l}}async function Df(r,e){let n=await Ry().encrypt(r,e);return qe.encode(n)}var Pf={};V(Pf,{KeyType:()=>vt,PrivateKey:()=>Fs,PublicKey:()=>Us});var vt;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.Secp256k1="Secp256k1"})(vt||(vt={}));var RE;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.Secp256k1=2]="Secp256k1"})(RE||(RE={}));(function(r){r.codec=()=>Te(RE)})(vt||(vt={}));var Us;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),vt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=vt.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(Us||(Us={}));var Fs;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),vt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=vt.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(Fs||(Fs={}));var sl=class{_key;constructor(e){this._key=Cf(e,kf)}verify(e,t){return NL(this._key,t,e)}marshal(){return this._key}get bytes(){return Us.encode({Type:vt.Ed25519,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return ns(e)?e.then(({bytes:t})=>t):e.bytes}},Ri=class{_key;_publicKey;constructor(e,t){this._key=Cf(e,Ai),this._publicKey=Cf(t,kf)}sign(e){return BL(this._key,e)}get public(){return new sl(this._publicKey)}marshal(){return this._key}get bytes(){return Fs.encode({Type:vt.Ed25519,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}async hash(){let e=$.digest(this.bytes),t;return ns(e)?{bytes:t}=await e:t=e.bytes,t}async id(){let e=Lt.digest(this.public.bytes);return Fe.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if(t==="libp2p-key")return Df(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function Ose(r){if(r.length>Ai){r=Cf(r,Ai+kf);let n=r.subarray(0,Ai),s=r.subarray(Ai,r.length);return new Ri(n,s)}r=Cf(r,Ai);let e=r.subarray(0,Ai),t=r.subarray(kf);return new Ri(e,t)}function Kse(r){return r=Cf(r,kf),new sl(r)}async function Mse(){let{privateKey:r,publicKey:e}=PL();return new Ri(r,e)}async function IE(r){let{privateKey:e,publicKey:t}=CL(r);return new Ri(e,t)}function Cf(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new g(`Key must be a Uint8Array of length ${e}, got ${r.length}`,"ERR_INVALID_KEY_TYPE");return r}var KL={"P-256":256,"P-384":384,"P-521":521},Use=Object.keys(KL),kE=Use.join(" / ");async function ML(r){if(r!=="P-256"&&r!=="P-384"&&r!=="P-521")throw new g(`Unknown curve: ${r}. Must be ${kE}`,"ERR_INVALID_CURVE");let e=await It.get().subtle.generateKey({name:"ECDH",namedCurve:r},!0,["deriveBits"]),t=async(o,i)=>{let a;i!=null?a=await It.get().subtle.importKey("jwk",Vse(r,i),{name:"ECDH",namedCurve:r},!1,["deriveBits"]):a=e.privateKey;let c=await It.get().subtle.importKey("jwk",FL(r,o),{name:"ECDH",namedCurve:r},!1,[]),l=await It.get().subtle.deriveBits({name:"ECDH",namedCurve:r,public:c},a,KL[r]);return new Uint8Array(l,0,l.byteLength)},n=await It.get().subtle.exportKey("jwk",e.publicKey);return{key:Fse(n),genSharedKey:t}}var UL={"P-256":32,"P-384":48,"P-521":66};function Fse(r){if(r.crv==null||r.x==null||r.y==null)throw new g("JWK was missing components","ERR_INVALID_PARAMETERS");if(r.crv!=="P-256"&&r.crv!=="P-384"&&r.crv!=="P-521")throw new g(`Unknown curve: ${r.crv}. Must be ${kE}`,"ERR_INVALID_CURVE");let e=UL[r.crv];return le([Uint8Array.from([4]),_E(r.x,e),_E(r.y,e)],1+e*2)}function FL(r,e){if(r!=="P-256"&&r!=="P-384"&&r!=="P-521")throw new g(`Unknown curve: ${r}. Must be ${kE}`,"ERR_INVALID_CURVE");let t=UL[r];if(!q(e.subarray(0,1),Uint8Array.from([4])))throw new g("Cannot unmarshal public key - invalid key format","ERR_INVALID_KEY_FORMAT");return{kty:"EC",crv:r,x:T(e.subarray(1,t+1),"base64url"),y:T(e.subarray(1+t),"base64url"),ext:!0}}var Vse=(r,e)=>({...FL(r,e.public),d:T(e.private,"base64url")});var VL=ML;async function qL(r,e){let t=qe.decode(r);return Ry().decrypt(t,e)}var HL={"AES-128":{ivSize:16,keySize:16},"AES-256":{ivSize:16,keySize:32},Blowfish:{ivSize:8,keySize:32}};async function zL(r,e,t){let n=HL[r];if(n==null){let w=Object.keys(HL).join(" / ");throw new g(`unknown cipher type '${r}'. Must be ${w}`,"ERR_INVALID_CIPHER_TYPE")}if(e==null)throw new g("missing hash type","ERR_MISSING_HASH_TYPE");let s=n.keySize,o=n.ivSize,i=20,a=R("key expansion"),c=2*(o+s+i),l=await kL(e,t),u=await l.digest(a),f=[],h=0;for(;h<c;){let w=await l.digest(le([u,a])),E=w.length;h+E>c&&(E=c-h),f.push(w),h+=E,u=await l.digest(u)}let d=c/2,p=le(f),m=p.subarray(0,d),y=p.subarray(d,c),b=w=>({iv:w.subarray(0,o),cipherKey:w.subarray(o,o+s),macKey:w.subarray(o+s)});return{k1:b(m),k2:b(y)}}var LE={};V(LE,{MAX_RSA_KEY_SIZE:()=>il,RsaPrivateKey:()=>Va,RsaPublicKey:()=>ol,fromJwk:()=>Jse,generateKeyPair:()=>Zse,unmarshalRsaPrivateKey:()=>BE,unmarshalRsaPublicKey:()=>Xse});function vo(r){if(isNaN(r)||r<=0)throw new g("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return zt(r)}var Fa={};V(Fa,{exportToPem:()=>Wse,importFromPem:()=>CE,jwkToPkcs1:()=>Hse,jwkToPkix:()=>$se,pkcs1ToJwk:()=>qse,pkixToJwk:()=>zse});function qse(r){let{result:e}=tt(r),t=e.valueBlock.value;return{n:T(xo(t[1].toBigInt()),"base64url"),e:T(xo(t[2].toBigInt()),"base64url"),d:T(xo(t[3].toBigInt()),"base64url"),p:T(xo(t[4].toBigInt()),"base64url"),q:T(xo(t[5].toBigInt()),"base64url"),dp:T(xo(t[6].toBigInt()),"base64url"),dq:T(xo(t[7].toBigInt()),"base64url"),qi:T(xo(t[8].toBigInt()),"base64url"),kty:"RSA",alg:"RS256"}}function Hse(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new g("JWK was missing components","ERR_INVALID_PARAMETERS");let t=new re({value:[new X({value:0}),X.fromBigInt(So(R(r.n,"base64url"))),X.fromBigInt(So(R(r.e,"base64url"))),X.fromBigInt(So(R(r.d,"base64url"))),X.fromBigInt(So(R(r.p,"base64url"))),X.fromBigInt(So(R(r.q,"base64url"))),X.fromBigInt(So(R(r.dp,"base64url"))),X.fromBigInt(So(R(r.dq,"base64url"))),X.fromBigInt(So(R(r.qi,"base64url")))]}).toBER();return new Uint8Array(t,0,t.byteLength)}function zse(r){let{result:e}=tt(r),t=e.valueBlock.value[1].valueBlock.value[0].valueBlock.value;return{kty:"RSA",n:T(xo(t[0].toBigInt()),"base64url"),e:T(xo(t[1].toBigInt()),"base64url")}}function $se(r){if(r.n==null||r.e==null)throw new g("JWK was missing components","ERR_INVALID_PARAMETERS");let t=new re({value:[new re({value:[new Le({value:"1.2.840.113549.1.1.1"}),new yt]}),new Hr({valueHex:new re({value:[X.fromBigInt(So(R(r.n,"base64url"))),X.fromBigInt(So(R(r.e,"base64url")))]}).toBER()})]}).toBER();return new Uint8Array(t,0,t.byteLength)}function xo(r){let e=r.toString(16);e.length%2>0&&(e=`0${e}`);let t=e.length/2,n=new Uint8Array(t),s=0,o=0;for(;s<t;)n[s]=parseInt(e.slice(o,o+2),16),s+=1,o+=2;return n}function So(r){let e=[];return r.forEach(function(t){let n=t.toString(16);n.length%2>0&&(n=`0${n}`),e.push(n)}),BigInt("0x"+e.join(""))}var Gse=16,DE=32,PE=1e4;async function Wse(r,e){let t=It.get(),s=new re({value:[new X({value:0}),new re({value:[new Le({value:"1.2.840.113549.1.1.1"}),new yt]}),new nt({valueHex:r.marshal()})]}).toBER(),o=new Uint8Array(s,0,s.byteLength),i=vo(Gse),a=await Xr(er,e,i,{c:PE,dkLen:DE}),c=vo(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,o),f=new re({value:[new nt({valueHex:i}),new X({value:PE}),new X({value:DE}),new re({value:[new Le({value:"1.2.840.113549.2.11"}),new yt]})]}),h=new re({value:[new Le({value:"1.2.840.113549.1.5.13"}),new re({value:[new re({value:[new Le({value:"1.2.840.113549.1.5.12"}),f]}),new re({value:[new Le({value:"2.16.840.1.101.3.4.1.42"}),new nt({valueHex:c})]})]})]}),p=new re({value:[h,new nt({valueHex:u})]}).toBER(),m=new Uint8Array(p,0,p.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...T(m,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function CE(r,e){let t=It.get(),n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){let s=R(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=tt(s),{iv:i,salt:a,iterations:c,keySize:l,cipherText:u}=Yse(o),f=await Xr(er,e,a,{c,dkLen:l}),h=await t.subtle.importKey("raw",f,"AES-CBC",!1,["decrypt"]),d=Dd(await t.subtle.decrypt({name:"AES-CBC",iv:i},h,u)),{result:p}=tt(d);n=$L(p)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){let s=R(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=tt(s);n=$L(o)}else throw new g("Could not parse private key from PEM data","ERR_INVALID_PARAMETERS");return BE(n)}function Yse(r){let e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new g("Only pkcs5PBES2 encrypted private keys are supported","ERR_INVALID_PARAMS");let n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new g("Only pkcs5PBKDF2 key derivation functions are supported","ERR_INVALID_PARAMS");let o=n.valueBlock.value[1],i=Dd(o.valueBlock.value[0].getValue()),a=PE,c=DE;if(o.valueBlock.value.length===3)a=Number(o.valueBlock.value[1].toBigInt()),c=Number(o.valueBlock.value[2].toBigInt());else if(o.valueBlock.value.length===2)throw new g("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key","ERR_INVALID_PARAMS");let l=e.valueBlock.value[1].valueBlock.value[1],u=l.valueBlock.value[0].toString();if(u!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(u!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new g("Only AES-CBC encryption schemes are supported","ERR_INVALID_PARAMS")}}}}let f=Dd(l.valueBlock.value[1].getValue());return{cipherText:Dd(r.valueBlock.value[1].getValue()),salt:i,iterations:a,keySize:c,iv:f}}function $L(r){return Dd(r.valueBlock.value[2].getValue())}function Dd(r){return new Uint8Array(r,0,r.byteLength)}async function GL(r){let e=await It.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await jL(e);return{privateKey:t[0],publicKey:t[1]}}async function NE(r){let t=[await It.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await jse(r)],n=await jL({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function WL(r,e){let t=await It.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await It.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(n,0,n.byteLength)}async function YL(r,e,t){let n=await It.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return It.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,e,t instanceof Uint8Array?t:t.subarray())}async function jL(r){if(r.privateKey==null||r.publicKey==null)throw new g("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([It.get().subtle.exportKey("jwk",r.privateKey),It.get().subtle.exportKey("jwk",r.publicKey)])}async function jse(r){return It.get().subtle.importKey("jwk",{kty:r.kty,n:r.n,e:r.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function Iy(r){if(r.kty!=="RSA")throw new g("invalid key type","ERR_INVALID_KEY_TYPE");if(r.n==null)throw new g("invalid key modulus","ERR_INVALID_KEY_MODULUS");return R(r.n,"base64url").length*8}var il=8192,ol=class{_key;constructor(e){this._key=e}verify(e,t){return YL(this._key,t,e)}marshal(){return Fa.jwkToPkix(this._key)}get bytes(){return Us.encode({Type:vt.RSA,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return ns(e)?e.then(({bytes:t})=>t):e.bytes}},Va=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t}genSecret(){return vo(16)}sign(e){return WL(this._key,e)}get public(){if(this._publicKey==null)throw new g("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new ol(this._publicKey)}marshal(){return Fa.jwkToPkcs1(this._key)}get bytes(){return Fs.encode({Type:vt.RSA,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return ns(e)?e.then(({bytes:t})=>t):e.bytes}async id(){let e=await this.public.hash();return T(e,"base58btc")}async export(e,t="pkcs-8"){if(t==="pkcs-8")return Fa.exportToPem(this,e);if(t==="libp2p-key")return Df(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};async function BE(r){let e=Fa.pkcs1ToJwk(r);if(Iy(e)>il)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let t=await NE(e);return new Va(t.privateKey,t.publicKey)}function Xse(r){let e=Fa.pkixToJwk(r);if(Iy(e)>il)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new ol(e)}async function Jse(r){if(Iy(r)>il)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await NE(r);return new Va(e.privateKey,e.publicKey)}async function Zse(r){if(r>il)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await GL(r);return new Va(e.privateKey,e.publicKey)}var KE={};V(KE,{Secp256k1PrivateKey:()=>cl,Secp256k1PublicKey:()=>al,generateKeyPair:()=>noe,unmarshalSecp256k1PrivateKey:()=>toe,unmarshalSecp256k1PublicKey:()=>roe});function QL(){return ae.utils.randomPrivateKey()}function XL(r,e){let t=$.digest(e instanceof Uint8Array?e:e.subarray());if(ns(t))return t.then(({digest:n})=>ae.sign(n,r).toDERRawBytes()).catch(n=>{throw new g(String(n),"ERR_INVALID_INPUT")});try{return ae.sign(t.digest,r).toDERRawBytes()}catch(n){throw new g(String(n),"ERR_INVALID_INPUT")}}function JL(r,e,t){let n=$.digest(t instanceof Uint8Array?t:t.subarray());if(ns(n))return n.then(({digest:s})=>ae.verify(e,s,r)).catch(s=>{throw new g(String(s),"ERR_INVALID_INPUT")});try{return ae.verify(e,n.digest,r)}catch(s){throw new g(String(s),"ERR_INVALID_INPUT")}}function ZL(r){return ae.ProjectivePoint.fromHex(r).toRawBytes(!0)}function eO(r){try{ae.getPublicKey(r,!0)}catch(e){throw new g(String(e),"ERR_INVALID_PRIVATE_KEY")}}function OE(r){try{ae.ProjectivePoint.fromHex(r)}catch(e){throw new g(String(e),"ERR_INVALID_PUBLIC_KEY")}}function tO(r){try{return ae.getPublicKey(r,!0)}catch(e){throw new g(String(e),"ERR_INVALID_PRIVATE_KEY")}}var al=class{_key;constructor(e){OE(e),this._key=e}verify(e,t){return JL(this._key,t,e)}marshal(){return ZL(this._key)}get bytes(){return Us.encode({Type:vt.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}async hash(){let e=$.digest(this.bytes),t;return ns(e)?{bytes:t}=await e:t=e.bytes,t}},cl=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t??tO(e),eO(this._key),OE(this._publicKey)}sign(e){return XL(this._key,e)}get public(){return new al(this._publicKey)}marshal(){return this._key}get bytes(){return Fs.encode({Type:vt.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return ns(e)?e.then(({bytes:t})=>t):e.bytes}async id(){let e=await this.public.hash();return T(e,"base58btc")}async export(e,t="libp2p-key"){if(t==="libp2p-key")return Df(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function toe(r){return new cl(r)}function roe(r){return new al(r)}async function noe(){let r=QL();return new cl(r)}var Ii={rsa:LE,ed25519:TE,secp256k1:KE};function ME(r){let e=Object.keys(Ii).join(" / ");return new g(`invalid or unsupported key type ${r}. Must be ${e}`,"ERR_UNSUPPORTED_KEY_TYPE")}function UE(r){if(r=r.toLowerCase(),r==="rsa"||r==="ed25519"||r==="secp256k1")return Ii[r];throw ME(r)}async function soe(r,e){return UE(r).generateKeyPair(e??2048)}async function ooe(r,e,t){if(r.toLowerCase()!=="ed25519")throw new g("Seed key derivation is unimplemented for RSA or secp256k1","ERR_UNSUPPORTED_KEY_DERIVATION_TYPE");return IE(e)}function ioe(r){let e=Us.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case vt.RSA:return Ii.rsa.unmarshalRsaPublicKey(t);case vt.Ed25519:return Ii.ed25519.unmarshalEd25519PublicKey(t);case vt.Secp256k1:return Ii.secp256k1.unmarshalSecp256k1PublicKey(t);default:throw ME(e.Type??"unknown")}}function aoe(r,e){return e=(e??"rsa").toLowerCase(),UE(e),r.bytes}async function rO(r){let e=Fs.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case vt.RSA:return Ii.rsa.unmarshalRsaPrivateKey(t);case vt.Ed25519:return Ii.ed25519.unmarshalEd25519PrivateKey(t);case vt.Secp256k1:return Ii.secp256k1.unmarshalSecp256k1PrivateKey(t);default:throw ME(e.Type??"RSA")}}function coe(r,e){return e=(e??"rsa").toLowerCase(),UE(e),r.bytes}async function loe(r,e){try{let t=await qL(r,e);return await rO(t)}catch{}if(!r.includes("BEGIN"))throw new g("Encrypted key was not a libp2p-key or a PEM file","ERR_INVALID_IMPORT_FORMAT");return CE(r,e)}var ky=class{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(e=>e.peerId)}async add(e){if(this.peerDistances.find(s=>s.peerId.equals(e))!=null)return;let t=await Ms(e),n={peerId:e,distance:li(this.originDhtKey,t)};this.peerDistances.push(n),this.peerDistances.sort((s,o)=>tm(s.distance,o.distance)),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async anyCloser(e){if(e.length===0)return!1;if(this.length===0)return!0;let t=await Promise.all(e.map(Ms)),n=this.peerDistances[this.peerDistances.length-1].distance;for(let s of t){let o=li(this.originDhtKey,s);if(tm(o,n)<0)return!0}return!1}};var Dy=class{log;routingTable;network;validators;queryManager;peerStore;peerId;constructor(e,t){let{routingTable:n,network:s,validators:o,queryManager:i,logPrefix:a}=t;this.routingTable=n,this.network=s,this.validators=o,this.queryManager=i,this.peerStore=e.peerStore,this.peerId=e.peerId,this.log=e.logger.forComponent(`${a}:peer-routing`)}async findPeerLocal(e){let t,n=await this.routingTable.find(e);if(n!=null){this.log("findPeerLocal found %p in routing table",e);try{t=await this.peerStore.get(n)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}}if(t==null)try{t=await this.peerStore.get(e)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}if(t!=null)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map(s=>s.multiaddr)}}async*_getValueSingle(e,t,n={}){let s={type:Ue.GET_VALUE,key:t};yield*this.network.sendRequest(e,s,n)}async*getPublicKeyFromNode(e,t={}){let n=xL(e);for await(let s of this._getValueSingle(e,n,t))if(yield s,s.name==="PEER_RESPONSE"&&s.record!=null){let o=await xr(Ty.marshalPublicKey({bytes:s.record.value}));if(!o.equals(e))throw new g("public key does not match id","ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(o.publicKey==null)throw new g("public key missing","ERR_PUBLIC_KEY_MISSING");yield Id({from:e,value:o.publicKey},t)}throw new g(`Node not responding with its public key: ${e.toString()}`,"ERR_INVALID_RECORD")}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){let s=await this.findPeerLocal(e);if(s!=null){this.log("found local"),yield vy({from:this.peerId,peer:s},t);return}}let n=!1;if(t.useNetwork!==!1){let s=this,o=async function*({peer:i,signal:a}){let c={type:Ue.FIND_NODE,key:e.toBytes()};for await(let l of s.network.sendRequest(i,c,{...t,signal:a}))if(yield l,l.name==="PEER_RESPONSE"){let u=l.closer.find(f=>f.id.equals(e));u!=null&&(yield vy({from:l.from,peer:u},t))}};for await(let i of this.queryManager.run(e.toBytes(),o,t))i.name==="FINAL_PEER"&&(n=!0),yield i}n||(yield Pn({from:this.peerId,error:new g("Not found","ERR_NOT_FOUND")},t))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);let n=await Ua(e),s=this.routingTable.closestPeers(n),o=this,i=new ky(n,this.routingTable.kBucketSize);await Promise.all(s.map(async c=>{await i.add(c)}));let a=async function*({peer:c,signal:l}){o.log("closerPeersSingle %s from %p",T(e,"base32"),c);let u={type:Ue.FIND_NODE,key:e};yield*o.network.sendRequest(c,u,{...t,signal:l})};for await(let c of this.queryManager.run(e,a,t))yield c,c.name==="PEER_RESPONSE"&&await Promise.all(c.closer.map(async l=>{await i.add(l.id)}));this.log("found %d peers close to %b",i.length,e);for(let c of i.peers)try{let l=await this.peerStore.get(c);yield vy({from:this.peerId,peer:{id:c,multiaddrs:l.addresses.map(({multiaddr:u})=>u)}},t)}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}}async*getValueOrPeers(e,t,n={}){for await(let s of this._getValueSingle(e,t,n)){if(s.name==="PEER_RESPONSE"&&s.record!=null)try{await this._verifyRecordOnline(s.record)}catch{let i="invalid record received, discarded";this.log(i),yield Pn({from:s.from,error:new g(i,"ERR_INVALID_RECORD")},n);continue}yield s}}async _verifyRecordOnline(e){if(e.timeReceived==null)throw new g("invalid record received","ERR_INVALID_RECORD");await If(this.validators,new gr(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){let n=await Ua(e),s=this.routingTable.closestPeers(n),o=[];for(let i of s)if(!i.equals(t))try{let a=await this.peerStore.get(i);o.push({id:i,multiaddrs:a.addresses.map(({multiaddr:c})=>c)})}catch(a){if(a.code!=="ERR_NOT_FOUND")throw a}return o.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",o.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p",e,t),o}};var oO=fe(sO(),1);var Py=class{log;datastore;cache;cleanupInterval;provideValidity;syncQueue;started;cleaner;constructor(e,t={}){let{cacheSize:n,cleanupInterval:s,provideValidity:o}=t;this.log=e.logger.forComponent("libp2p:kad-dht:providers"),this.datastore=e.datastore,this.cleanupInterval=s??36e5,this.provideValidity=o??864e5,this.cache=(0,oO.default)(n??256),this.syncQueue=new Ws({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval(()=>{this._cleanup().catch(e=>{this.log.error(e)})},this.cleanupInterval))}async stop(){this.started=!1,this.cleaner!=null&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){await this.syncQueue.add(async()=>{let e=Date.now(),t=0,n=0,s=new Map,o=this.datastore.batch(),i=this.datastore.query({prefix:yE});for await(let a of i)try{let{cid:c,peerId:l}=iO(a.key),u=aO(a.value).getTime(),f=Date.now(),h=f-u,d=h>this.provideValidity;if(this.log("comparing: %d - %d = %d > %d %s",f,u,h,this.provideValidity,d?"(expired)":""),d){n++,o.delete(a.key);let p=s.get(c)??new Set;p.add(l),s.set(c,p)}t++}catch(c){this.log.error(c.message)}s.size>0?(this.log("deleting %d / %d entries",n,t),await o.commit()):this.log("nothing to delete");for(let[a,c]of s){let l=Pd(a),u=this.cache.get(l);if(u!=null){for(let f of c)u.delete(f);u.size===0?this.cache.remove(l):this.cache.set(l,u)}}this.log("Cleanup successful (%dms)",Date.now()-e)})}async _getProvidersMap(e){let t=Pd(e),n=this.cache.get(t);return n==null&&(n=await doe(this.datastore,e),this.cache.set(t,n)),n}async addProvider(e,t){await this.syncQueue.add(async()=>{this.log("%p provides %s",t,e);let n=await this._getProvidersMap(e);this.log("loaded %s provs",n.size);let s=new Date;n.set(t.toString(),s);let o=Pd(e);this.cache.set(o,n),await poe(this.datastore,e,t,s)})}async getProviders(e){return this.syncQueue.add(async()=>(this.log("get providers for %s",e),[...(await this._getProvidersMap(e)).keys()].map(n=>Ce(n))),{throwOnTimeout:!0})}};function Pd(r){let e=typeof r=="string"?r:T(r.multihash.bytes,"base32");return`${yE}/${e}`}async function poe(r,e,t,n){let s=[Pd(e),"/",t.toString()].join(""),o=new ct(s),i=Zt(n.getTime());await r.put(o,i)}function iO(r){let e=r.toString().split("/");if(e.length!==5)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:e[3],peerId:e[4]}}async function doe(r,e){let t=new Map,n=r.query({prefix:Pd(e)});for await(let s of n){let{peerId:o}=iO(s.key);t.set(o,aO(s.value))}return t}function aO(r){return new Date(gn(r))}async function*cO(r,e,t,n){let s=Tt({objectMode:!0}),o=f=>{n("clean up queue, results %d, queue size %d, pending tasks %d",s.readableLength,r.size,r.pending),r.clear(),s.end(f)},i=f=>{f!=null&&s.push(f)},a=f=>{n("queue error",f),o(f)},c=()=>{n("queue idle"),o()},l=()=>{n("abort queue"),o(new g("Query aborted","ERR_QUERY_ABORTED"))},u=()=>{o()};r.on("completed",i),r.on("error",a),r.on("idle",c),e.addEventListener("abort",l),t.addEventListener("cleanup",u);try{yield*s}finally{r.removeListener("completed",i),r.removeListener("error",a),r.removeListener("idle",c),e.removeEventListener("abort",l),t.removeEventListener("cleanup",u)}}var moe=BigInt("0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");async function*lO(r){let{key:e,startingPeer:t,ourPeerId:n,signal:s,query:o,alpha:i,pathIndex:a,numPaths:c,cleanUp:l,queryFuncTimeout:u,log:f,peersSeen:h}=r,d=new Ws({concurrency:i}),p=await Ua(e);function m(y,b){if(y==null)return;h.add(y);let w=BigInt("0x"+T(li(b,p),"base16"));d.add(async()=>{let E=[s];u!=null&&E.push(AbortSignal.timeout(u));let x=ur(E);try{for await(let v of o({key:e,peer:y,signal:x,pathIndex:a,numPaths:c})){if(x.aborted)return;if(v.name==="PEER_RESPONSE")for(let S of v.closer){if(h.has(S.id)){f("already seen %p in query",S.id);continue}if(n.equals(S.id)){f("not querying ourselves");continue}let A=await Ms(S.id);if(BigInt("0x"+T(li(A,p),"base16"))>w){f("skipping %p as they are not closer to %b than %p",S.id,e,y);continue}f("querying closer peer %p",S.id),m(S.id,A)}d.emit("completed",v)}}catch(v){if(!s.aborted)return Pn({from:y,error:v},r)}finally{x.clear()}},{priority:moe-w}).catch(E=>{f.error(E)})}m(t,await Ms(t)),yield*cO(d,s,l,f)}var By=class{disjointPaths;alpha;shutDownController;running;queries;logger;peerId;routingTable;initialQuerySelfHasRun;logPrefix;metrics;constructor(e,t){let{disjointPaths:n=20,alpha:s=3,logPrefix:o}=t;this.logPrefix=o,this.disjointPaths=n??20,this.running=!1,this.alpha=s??3,this.queries=0,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,e.metrics!=null&&(this.metrics={runningQueries:e.metrics.registerMetric(`${o.replaceAll(":","_")}_running_queries`),queryTime:e.metrics.registerMetric(`${o.replaceAll(":","_")}_query_time_seconds`)}),this.shutDownController=new AbortController,Ze(1/0,this.shutDownController.signal)}isStarted(){return this.running}async start(){this.running=!0}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");let s=this.metrics?.queryTime.timer();if(n.signal==null){let f=AbortSignal.timeout(3e4);Ze(1/0,f),n={...n,signal:f}}let o=new AbortController;Ze(1/0,o.signal);let i=ur([this.shutDownController.signal,o.signal,n.signal]);Ze(1/0,i);let a=this.logger.forComponent(`${this.logPrefix}:query:`+T(e,"base58btc")),c=Date.now(),l=new je,u=!1;try{n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(a("waiting for initial query-self query before continuing"),await nn(this.initialQuerySelfHasRun.promise,i),this.initialQuerySelfHasRun=void 0),a("query:start"),this.queries++,this.metrics?.runningQueries.update(this.queries);let f=await Ua(e),h=this.routingTable.closestPeers(f),d=h.slice(0,Math.min(this.disjointPaths,h.length));if(h.length===0){a.error("Running query with no peers");return}let p=new cr,m=d.map((y,b)=>lO({key:e,startingPeer:y,ourPeerId:this.peerId,signal:i,query:t,pathIndex:b,numPaths:d.length,alpha:this.alpha,cleanUp:l,queryFuncTimeout:n.queryFuncTimeout,log:a,peersSeen:p,onProgress:n.onProgress}));for await(let y of fs(...m))y.name==="QUERY_ERROR"&&a.error("query error",y.error),yield y;u=!0}catch(f){if(!(!this.running&&f.code==="ERR_QUERY_ABORTED"))throw f}finally{u||(a("query exited early"),o.abort()),i.clear(),this.queries--,this.metrics?.runningQueries.update(this.queries),s?.(),l.dispatchEvent(new Dt("cleanup")),a("query:done in %dms",Date.now()-c)}}};function goe(r){return r[Symbol.asyncIterator]!=null}function boe(r){if(goe(r))return(async()=>{let e=0;for await(let t of r)e++;return e})();{let e=0;for(let t of r)e++;return e}}var Ny=boe;var woe=r=>{let e=r.on||r.addListener||r.addEventListener,t=r.off||r.removeListener||r.removeEventListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function Eoe(r,e,t){let n,s=new Promise((o,i)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:l,removeListener:u}=woe(r),f=(...d)=>{let p=t.multiArgs?d:d[0];t.filter&&!t.filter(p)||(c.push(p),t.count===c.length&&(n(),o(c)))},h=d=>{n(),i(d)};n=()=>{for(let d of a)u(d,f);for(let d of t.rejectionEvents)u(d,h)};for(let d of a)l(d,f);for(let d of t.rejectionEvents)l(d,h);t.signal&&t.signal.addEventListener("abort",()=>{h(t.signal.reason)},{once:!0}),t.resolveImmediately&&o(c)});if(s.cancel=n,typeof t.timeout=="number"){let o=gs(s,{milliseconds:t.timeout});return o.cancel=n,o}return s}function Cd(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=Eoe(r,e,t),s=n.then(o=>o[0]);return s.cancel=n.cancel,s}var Ly=class{log;peerId;peerRouting;routingTable;count;interval;initialInterval;queryTimeout;started;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){let{peerRouting:n,logPrefix:s,count:o,interval:i,queryTimeout:a,routingTable:c}=t;this.peerId=e.peerId,this.log=e.logger.forComponent(`${s}:query-self`),this.started=!1,this.peerRouting=n,this.routingTable=c,this.count=o??20,this.interval=i??3e5,this.initialInterval=t.initialInterval??1e3,this.queryTimeout=a??5e3,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun}isStarted(){return this.started}start(){this.started||(this.started=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.started=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.started){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=xe(),this.started){this.controller=new AbortController;let e=ur([this.controller.signal,AbortSignal.timeout(this.queryTimeout)]);Ze(1/0,e);try{this.routingTable.size===0&&(this.log("routing table was empty, waiting for some peers before running query"),await Cd(this.routingTable,"peer:add",{signal:e})),this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);let t=Date.now(),n=await lt(this.peerRouting.getClosestPeers(this.peerId.toBytes(),{signal:e,isSelfQuery:!0}),s=>Fi(s,this.count),async s=>Ny(s));this.log("self-query found %d peers in %dms",n,Date.now()-t)}catch(t){this.log.error("self-query error",t)}finally{e.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.started&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}};function uO(r,e){if(r===e)return!0;if(r.length!==e.length)return!1;for(let t=0,n=r.length;t<n;++t)if(r[t]!==e[t])return!1;return!0}function FE(){return{contacts:[],dontSplit:!1,left:null,right:null}}function Bd(r,e){if(!(e instanceof Uint8Array))throw new TypeError(r+" is not a Uint8Array")}var Oy=class r extends je{localNodeId;root;numberOfNodesPerKBucket;numberOfNodesToPing;distance;arbiter;constructor(e){super(),this.localNodeId=e.localNodeId,this.numberOfNodesPerKBucket=e.numberOfNodesPerKBucket??20,this.numberOfNodesToPing=e.numberOfNodesToPing??3,this.distance=e.distance??r.distance,this.arbiter=e.arbiter??r.arbiter,Bd("option.localNodeId as parameter 1",this.localNodeId),this.root=FE()}static arbiter(e,t){return(e.vectorClock??0)>(t.vectorClock??0)?e:t}static distance(e,t){let n=0,s=0,o=Math.min(e.length,t.length),i=Math.max(e.length,t.length);for(;s<o;++s)n=n*256+(e[s]^t[s]);for(;s<i;++s)n=n*256+255;return n}add(e){Bd("contact.id",e?.id);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e.id,t++);let s=this._indexOf(n,e.id);return s>=0?(this._update(n,s,e),this):n.contacts.length<this.numberOfNodesPerKBucket?(n.contacts.push(e),this.safeDispatchEvent("added",{detail:e}),this):n.dontSplit?(this.safeDispatchEvent("ping",{detail:{oldContacts:n.contacts.slice(0,this.numberOfNodesToPing),newContact:e}}),this):(this._split(n,t),this.add(e))}closest(e,t=1/0){if(Bd("id",e),!Number.isInteger(t)&&t!==1/0||t<=0)throw new TypeError("n is not positive number");let n=[];for(let s=[this.root],o=0;s.length>0&&n.length<t;){let i=s.pop();if(i!=null)if(i.contacts===null){let a=this._determineNode(i,e,o++);s.push(i.left===a?i.right:i.left),s.push(a)}else n=n.concat(i.contacts)}return n.map(s=>({distance:this.distance(s.id,e),contact:s})).sort((s,o)=>s.distance-o.distance).slice(0,t).map(s=>s.contact)}count(){let e=0;for(let t=[this.root];t.length>0;){let n=t.pop();n!=null&&(n.contacts===null?t.push(n.right,n.left):e+=n.contacts.length)}return e}_determineNode(e,t,n){let s=n>>3,o=n%8;return t.length<=s&&o!==0?e.left:t[s]&1<<7-o?e.right:e.left}get(e){Bd("id",e);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e,t++);let s=this._indexOf(n,e);return s>=0?n.contacts[s]:void 0}_indexOf(e,t){for(let n=0;n<e.contacts.length;++n)if(uO(e.contacts[n].id,t))return n;return-1}remove(e){Bd("the id as parameter 1",e);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e,t++);let s=this._indexOf(n,e);if(s>=0){let o=n.contacts.splice(s,1)[0];this.safeDispatchEvent("removed",{detail:o})}return this}_split(e,t){e.left=FE(),e.right=FE();for(let o of e.contacts)this._determineNode(e,o.id,t).contacts.push(o);e.contacts=null;let n=this._determineNode(e,this.localNodeId,t),s=e.left===n?e.right:e.left;s.dontSplit=!0}toArray(){let e=[];for(let t=[this.root];t.length>0;){let n=t.pop();n!=null&&(n.contacts===null?t.push(n.right,n.left):e=e.concat(n.contacts))}return e}*toIterable(){for(let e=[this.root];e.length>0;){let t=e.pop();t!=null&&(t.contacts===null?e.push(t.right,t.left):yield*t.contacts)}}_update(e,t,n){if(!uO(e.contacts[t].id,n.id))throw new Error("wrong index for _update");let s=e.contacts[t],o=this.arbiter(s,n);o===s&&s!==n||(e.contacts.splice(t,1),e.contacts.push(o),this.safeDispatchEvent("updated",{detail:{incumbent:s,selection:o}}))}};var _oe="kad-close",Aoe=50,fO=20,Roe=1e4,Ioe=10,Ky=class extends je{kBucketSize;kb;pingQueue;log;components;pingTimeout;pingConcurrency;running;protocol;tagName;tagValue;metrics;constructor(e,t){super();let{kBucketSize:n,pingTimeout:s,logPrefix:o,pingConcurrency:i,protocol:a,tagName:c,tagValue:l}=t;this.components=e,this.log=e.logger.forComponent(`${o}:routing-table`),this.kBucketSize=n??fO,this.pingTimeout=s??Roe,this.pingConcurrency=i??Ioe,this.running=!1,this.protocol=a,this.tagName=c??_oe,this.tagValue=l??Aoe,this.pingQueue=new Ma({concurrency:this.pingConcurrency,metricName:`${o.replaceAll(":","_")}_ping_queue`,metrics:this.components.metrics}),this.pingQueue.addEventListener("error",u=>{this.log.error("error pinging peer",u.detail)}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${o.replaceAll(":","_")}_routing_table_size`)})}isStarted(){return this.running}async start(){this.running=!0;let e=new Oy({localNodeId:await Ms(this.components.peerId),numberOfNodesPerKBucket:this.kBucketSize,numberOfNodesToPing:1});this.kb=e,e.addEventListener("ping",t=>{this._onPing(t).catch(n=>{this.log.error("could not process k-bucket ping event",n)})}),this._tagPeers(e)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(e){let t=new cr,n=AL(()=>{let s=new cr(e.closest(e.localNodeId,fO).map(a=>a.peer)),o=s.difference(t),i=t.difference(s);Promise.resolve().then(async()=>{for(let a of o)await this.components.peerStore.merge(a,{tags:{[this.tagName]:{value:this.tagValue}}});for(let a of i)await this.components.peerStore.merge(a,{tags:{[this.tagName]:void 0}})}).catch(a=>{this.log.error("Could not update peer tags",a)}),t=s});e.addEventListener("added",s=>{n(),this.safeDispatchEvent("peer:add",{detail:s.detail.peer})}),e.addEventListener("removed",s=>{n(),this.safeDispatchEvent("peer:remove",{detail:s.detail.peer})})}async _onPing(e){if(!this.running)return;let{oldContacts:t,newContact:n}=e.detail,o=(await Promise.all(t.map(async i=>{let a=this.pingQueue.find(i.peer);return a!=null?a.join():this.pingQueue.add(async()=>{let c;try{let l={signal:AbortSignal.timeout(this.pingTimeout)};this.log("pinging old contact %p",i.peer),c=await(await this.components.connectionManager.openConnection(i.peer,l)).newStream(this.protocol,l);let f=Bt(c);await f.write({type:Ue.PING},rs,l);let h=await f.read(rs,l);if(await f.unwrap().close(),h.type!==Ue.PING)throw new g(`Incorrect message type received, expected PING got ${h.type}`,"ERR_BAD_PING_RESPONSE");return!0}catch(l){return this.running&&this.kb!=null&&(this.log.error("could not ping peer %p",i.peer,l),this.log("evicting old contact after ping failed %p",i.peer),this.kb.remove(i.id)),c?.abort(l),!1}finally{this.metrics?.routingTableSize.update(this.size)}},{peerId:i.peer})}))).filter(i=>i).length;this.running&&o<t.length&&this.kb!=null&&(this.log("adding new contact %p",n.peer),this.kb.add(n))}get size(){return this.kb==null?0:this.kb.count()}async find(e){let t=await Ms(e),n=this.closestPeer(t);if(n!=null&&e.equals(n))return n}closestPeer(e){let t=this.closestPeers(e,1);if(t.length>0)return t[0]}closestPeers(e,t=this.kBucketSize){return this.kb==null?[]:this.kb.closest(e,t).map(s=>s.peer)}async add(e){if(this.kb==null)throw new Error("RoutingTable is not started");let t=await Ms(e);this.kb.add({id:t,peer:e}),this.log("added %p with kad id %b",e,t),this.metrics?.routingTableSize.update(this.size)}async remove(e){if(this.kb==null)throw new Error("RoutingTable is not started");let t=await Ms(e);this.kb.remove(t),this.metrics?.routingTableSize.update(this.size)}};var hO=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782];var My=15,Uy=class{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){let{peerRouting:n,routingTable:s,refreshInterval:o,refreshQueryTimeout:i,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=n,this.routingTable=s,this.refreshInterval=o??3e5,this.refreshQueryTimeout=i??3e4,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async start(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");let t=this._maxCommonPrefix(),n=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${n.map(s=>s.toISOString()).join(", ")} ]`),Promise.all(n.map(async(s,o)=>{try{if(await this._refreshCommonPrefixLength(o,s,e),this._numPeersForCpl(t)===0){let i=Math.min(2*(o+1),n.length-1);for(let a=o+1;a<i+1;a++)try{await this._refreshCommonPrefixLength(a,s,e)}catch(c){this.log.error(c)}}}catch(i){this.log.error(i)}})).catch(s=>{this.log.error(s)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(s=>{this.log.error(s)})}async _refreshCommonPrefixLength(e,t,n){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}let s=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,s,this.routingTable.size);let o=await Ny(this.peerRouting.getClosestPeers(s.toBytes(),{signal:AbortSignal.timeout(this.refreshQueryTimeout)}));this.log(`found ${o} peers that were close to imaginary peer %p`,s),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,s,this.routingTable.size)}_getTrackedCommonPrefixLengthsForRefresh(e){e>My&&(e=My);let t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}async _generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");let t=vo(2),n=(t[1]<<8)+t[0],s=await this._makePeerId(this.routingTable.kb.localNodeId,n,e);return dt(s)}async _makePeerId(e,t,n){if(n>My)throw new Error(`Cannot generate peer ID for common prefix length greater than ${My}`);let i=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=i&a|t&~a,l=hO[c],u=new ArrayBuffer(34),f=new DataView(u,0,u.byteLength);return f.setUint8(0,$.code),f.setUint8(1,32),f.setUint32(2,l,!1),new Uint8Array(f.buffer,f.byteOffset,f.byteLength)}_maxCommonPrefix(){let e=0;for(let t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(let n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb!=null)for(let{id:e}of this.routingTable.kb.toIterable()){let t=li(this.routingTable.kb.localNodeId,e),n=0;for(let s of t)if(s===0)n++;else break;yield n}}};var Fy=class{providers;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.providers=t.providers}async handle(e,t){if(this.log("start"),t.key==null||t.key.length===0)throw new g("Missing key","ERR_MISSING_KEY");let n;try{n=Ve.decode(t.key)}catch{throw new g("Invalid CID","ERR_INVALID_CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),await Promise.all(t.providers.map(async s=>{if(!e.equals(s.id)){this.log("invalid provider peer %p from %p",s.id,e);return}if(s.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log("received provider %p for %s (addrs %s)",e,n,s.multiaddrs.map(o=>me(o).toString())),await this.providers.addProvider(n,dt(s.id))}))}};var Vy=class{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){let{peerRouting:n,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){this.log("incoming request from %p for peers closer to %b",e,t.key);let n=[];if(t.key==null)throw new g("Invalid FIND_NODE message received - key was missing","ERR_INVALID_MESSAGE");q(this.peerId.toBytes(),t.key)?n=[{id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(o=>o.decapsulateCode(ve("p2p").code))}]:n=await this.peerRouting.getCloserPeersOffline(t.key,e);let s={type:Ue.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({multiaddrs:o})=>o.length).map(o=>({id:o.id.toBytes(),multiaddrs:o.multiaddrs.map(i=>i.bytes)})),providers:[]};return s.closer.length===0&&this.log("could not find any peers closer to %b than %p",t.key,e),s}};var qy=class{peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){let{peerRouting:n,providers:s,logPrefix:o}=t;this.log=e.logger.forComponent(`${o}:rpc:handlers:get-providers`),this.peerStore=e.peerStore,this.peerRouting=n,this.providers=s,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new g("Invalid FIND_NODE message received - key was missing","ERR_INVALID_MESSAGE");let n;try{n=Ve.decode(t.key)}catch{throw new g("Invalid CID","ERR_INVALID_CID")}this.log("%p asking for providers for %s",e,n);let[s,o]=await Promise.all([this.providers.getProviders(n),this.peerRouting.getCloserPeersOffline(t.key,e)]),i=await this._getPeers(s),a=await this._getPeers(o.map(({id:l})=>l)),c={type:Ue.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:a.map(this.peerInfoMapper).filter(({multiaddrs:l})=>l.length).map(l=>({id:l.id.toBytes(),multiaddrs:l.multiaddrs.map(u=>u.bytes)})),providers:i.map(this.peerInfoMapper).filter(({multiaddrs:l})=>l.length).map(l=>({id:l.id.toBytes(),multiaddrs:l.multiaddrs.map(u=>u.bytes)}))};return this.log("got %s providers %s closerPeers",c.providers.length,c.closer.length),c}async _getAddresses(e){return[]}async _getPeers(e){let t=[];for(let n of e)try{let s=await this.peerStore.get(n),o=this.peerInfoMapper({id:n,multiaddrs:s.addresses.map(({multiaddr:i})=>i)});o.multiaddrs.length>0&&t.push(o)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}return t}};var Hy=class{peerStore;datastore;peerRouting;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){let n=t.key;if(this.log("%p asked for key %b",e,n),n==null||n.length===0)throw new g("Invalid key","ERR_INVALID_KEY");let s={type:Ue.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(SL(n)){this.log("is public key");let a=_L(n),c;try{let l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new g("No public key found in key book","ERR_NOT_FOUND");c=l.id.publicKey}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}if(c!=null)return this.log("returning found public key"),s.record=new gr(n,c,new Date).serialize(),s}let[o,i]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getCloserPeersOffline(n,e)]);return o!=null&&(this.log("had record for %b in local datastore",n),s.record=o.serialize()),i.length>0&&(this.log("had %s closer peers in routing table",i.length),s.closer=i.map(a=>({id:a.id.toBytes(),multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),s}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);let t=_i(e),n;try{n=await this.datastore.get(t)}catch(o){if(o.code==="ERR_NOT_FOUND")return;throw o}let s=gr.deserialize(n);if(s==null)throw new g("Invalid record","ERR_INVALID_RECORD");if(s.timeReceived==null||Date.now()-s.timeReceived.getTime()>1296e5){await this.datastore.delete(t);return}return s}};var zy=class{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}};var $y=class{components;validators;log;constructor(e,t){let{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.validators=n}async handle(e,t){let n=t.key;if(this.log("%p asked us to store value for key %b",e,n),t.record==null){let s=`Empty record from: ${e.toString()}`;throw this.log.error(s),new g(s,"ERR_EMPTY_RECORD")}try{let s=gr.deserialize(t.record);await If(this.validators,s),s.timeReceived=new Date;let o=_i(s.key);await this.components.datastore.put(o,s.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,o)}catch(s){this.log("did not put record for key %b into datastore %o",n,s)}return t}};var Gy=class{handlers;routingTable;log;constructor(e,t){let{providers:n,peerRouting:s,validators:o,logPrefix:i,peerInfoMapper:a}=t;this.log=e.logger.forComponent(`${i}:rpc`),this.routingTable=t.routingTable,this.handlers={[Ue.GET_VALUE.toString()]:new Hy(e,{peerRouting:s,logPrefix:i}),[Ue.PUT_VALUE.toString()]:new $y(e,{validators:o,logPrefix:i}),[Ue.FIND_NODE.toString()]:new Vy(e,{peerRouting:s,logPrefix:i,peerInfoMapper:a}),[Ue.ADD_PROVIDER.toString()]:new Fy(e,{providers:n,logPrefix:i}),[Ue.GET_PROVIDERS.toString()]:new qy(e,{peerRouting:s,providers:n,logPrefix:i,peerInfoMapper:a}),[Ue.PING.toString()]:new zy(e,{logPrefix:i})}}async handleMessage(e,t){try{await this.routingTable.add(e)}catch(s){this.log.error("Failed to update the kbucket store",s)}let n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}return n.handle(e,t)}onIncomingStream(e){Promise.resolve().then(async()=>{let{stream:t,connection:n}=e,s=n.remotePeer;try{await this.routingTable.add(s)}catch(i){this.log.error(i)}let o=this;await lt(t,i=>Mr(i),async function*(i){for await(let a of i){let c=rs.decode(a);o.log("incoming %s from %p",c.type,s);let l=await o.handleMessage(s,c);l!=null&&(yield rs.encode(l))}},i=>sr(i),t)}).catch(t=>{this.log.error(t)})}};var Wy=class extends je{log;components;protocol;running;registrarId;constructor(e,t){super();let{protocol:n,logPrefix:s}=t;this.components=e,this.log=e.logger.forComponent(`${s}:topology-listener`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new Dt("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}};var VE=class{dht;constructor(e){this.dht=e}async provide(e,t={}){await Nn(this.dht.provide(e,t))}async*findProviders(e,t={}){for await(let n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await Nn(this.dht.put(e,t,n))}async get(e,t){for await(let n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new g("Not found","ERR_NOT_FOUND")}},qE=class{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(let n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new g("Not found","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){for await(let n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}},Poe=32,Coe=64,Yy=class extends je{protocol;routingTable;providers;network;peerRouting;components;log;running;kBucketSize;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;constructor(e,t){super();let{kBucketSize:n,clientMode:s,validators:o,selectors:i,querySelfInterval:a,protocol:c,logPrefix:l,pingTimeout:u,pingConcurrency:f,maxInboundStreams:h,maxOutboundStreams:d,providers:p}=t,m=l??"libp2p:kad-dht";this.running=!1,this.components=e,this.log=e.logger.forComponent(m),this.protocol=c??dL,this.kBucketSize=n??20,this.clientMode=s??!0,this.maxInboundStreams=h??Poe,this.maxOutboundStreams=d??Coe,this.peerInfoMapper=t.peerInfoMapper??vE,this.routingTable=new Ky(e,{kBucketSize:n,pingTimeout:u,pingConcurrency:f,protocol:this.protocol,logPrefix:m}),this.providers=new Py(e,p??{}),this.validators={...vL,...o},this.selectors={...EL,...i},this.network=new _y(e,{protocol:this.protocol,logPrefix:m});let y=xe();t.allowQueryWithZeroPeers===!0&&y.resolve(),this.queryManager=new By(e,{disjointPaths:Math.ceil(this.kBucketSize/2),logPrefix:m,initialQuerySelfHasRun:y,routingTable:this.routingTable}),this.peerRouting=new Dy(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:m}),this.contentFetching=new xy(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:m}),this.contentRouting=new Sy(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:m}),this.routingTableRefresh=new Uy(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:m}),this.rpc=new Gy(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:m,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new Wy(e,{protocol:this.protocol,logPrefix:m}),this.querySelf=new Ly(e,{peerRouting:this.peerRouting,interval:a,initialInterval:t.initialQuerySelfInterval,logPrefix:m,initialQuerySelfHasRun:y,routingTable:this.routingTable}),this.network.addEventListener("peer",b=>{let w=b.detail;this.onPeerConnect(w).catch(E=>{this.log.error("could not add %p to routing table",w.id,E)}),this.dispatchEvent(new Dt("peer",{detail:w}))}),this.topologyListener.addEventListener("peer",b=>{let w=b.detail;Promise.resolve().then(async()=>{let E=await this.components.peerStore.get(w),x={id:w,multiaddrs:E.addresses.map(({multiaddr:v})=>v),protocols:E.protocols};await this.onPeerConnect(x)}).catch(E=>{this.log.error("could not add %p to routing table",w,E)})}),this.dhtPeerRouting=new qE(this),this.dhtContentRouting=new VE(this),t.clientMode==null&&e.events.addEventListener("self:peer:update",b=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{let w=b.detail.peer.addresses.some(({multiaddr:x})=>RL(x)),E=this.getMode();w&&E==="client"?await this.setMode("server"):E==="server"&&!w&&await this.setMode("client")}).catch(w=>{this.log.error("error setting dht server mode",w)})})}get[kh](){return this.dhtContentRouting}get[Dh](){return this.dhtPeerRouting}get[oc](){return this}async onPeerConnect(e){if(this.log("peer %p connected",e.id),e=this.peerInfoMapper(e),e.multiaddrs.length===0){this.log("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(t=>t.toString()));return}try{await this.routingTable.add(e.id)}catch(t){this.log.error("could not add %p to routing table",e.id,t)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e){await this.components.registrar.unhandle(this.protocol),e==="client"?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),this.querySelf.start(),await Promise.all([this.providers.start(),this.queryManager.start(),this.network.start(),this.routingTable.start(),this.topologyListener.start(),this.routingTableRefresh.start()])}async stop(){this.running=!1,this.querySelf.stop(),await Promise.all([this.providers.stop(),this.queryManager.stop(),this.network.stop(),this.routingTable.stop(),this.routingTableRefresh.stop(),this.topologyListener.stop()])}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}};var pO;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER"})(pO||(pO={}));var dO;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(dO||(dO={}));function mO(r){return e=>new Yy(e,r)}var kr={get(r=globalThis){let e=r.crypto;if(e==null||e.subtle==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}};var $E={};V($E,{Ed25519PrivateKey:()=>qa,Ed25519PublicKey:()=>Lf,generateKeyPair:()=>Ooe,generateKeyPairFromSeed:()=>SO,unmarshalEd25519PrivateKey:()=>Noe,unmarshalEd25519PublicKey:()=>Loe});function ss(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var Bf=32,Ti=64,jy=32;function gO(){let r=De.utils.randomPrivateKey(),e=De.getPublicKey(r);return{privateKey:vO(r,e),publicKey:e}}function bO(r){if(r.length!==jy)throw new TypeError('"seed" must be 32 bytes in length.');if(!(r instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');let e=r,t=De.getPublicKey(e);return{privateKey:vO(e,t),publicKey:t}}function wO(r,e){let t=r.subarray(0,jy);return De.sign(e instanceof Uint8Array?e:e.subarray(),t)}function EO(r,e,t){return De.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}function vO(r,e){let t=new Uint8Array(Ti);for(let n=0;n<jy;n++)t[n]=r[n],t[jy+n]=e[n];return t}var HE={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function Qy(r){let e=r?.algorithm??"AES-GCM",t=r?.keyLength??16,n=r?.nonceLength??12,s=r?.digest??"SHA-256",o=r?.saltLength??16,i=r?.iterations??32767,a=kr.get();t*=8;async function c(f,h){let d=a.getRandomValues(new Uint8Array(o)),p=a.getRandomValues(new Uint8Array(n)),m={name:e,iv:p};typeof h=="string"&&(h=R(h));let y;if(h.length===0){y=await a.subtle.importKey("jwk",HE,{name:"AES-GCM"},!0,["encrypt"]);try{let w={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}catch{y=await a.subtle.importKey("jwk",HE,{name:"AES-GCM"},!0,["encrypt"])}}else{let w={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}let b=await a.subtle.encrypt(m,y,f);return le([d,m.iv,new Uint8Array(b)])}async function l(f,h){let d=f.subarray(0,o),p=f.subarray(o,o+n),m=f.subarray(o+n),y={name:e,iv:p};typeof h=="string"&&(h=R(h));let b;if(h.length===0)try{let E={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},x=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(E,x,{name:e,length:t},!0,["decrypt"])}catch{b=await a.subtle.importKey("jwk",HE,{name:"AES-GCM"},!0,["decrypt"])}else{let E={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},x=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(E,x,{name:e,length:t},!0,["decrypt"])}let w=await a.subtle.decrypt(y,b,m);return new Uint8Array(w)}return{encrypt:c,decrypt:l}}async function Nf(r,e){let n=await Qy().encrypt(r,e);return qe.encode(n)}var Qt;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.Secp256k1="Secp256k1"})(Qt||(Qt={}));var zE;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.Secp256k1=2]="Secp256k1"})(zE||(zE={}));(function(r){r.codec=()=>Te(zE)})(Qt||(Qt={}));var ki;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Qt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=Qt.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(ki||(ki={}));var _o;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Qt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=Qt.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(_o||(_o={}));var Lf=class{_key;constructor(e){this._key=Of(e,Bf)}verify(e,t){return EO(this._key,t,e)}marshal(){return this._key}get bytes(){return ki.encode({Type:Qt.Ed25519,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return ss(e)?e.then(({bytes:t})=>t):e.bytes}},qa=class{_key;_publicKey;constructor(e,t){this._key=Of(e,Ti),this._publicKey=Of(t,Bf)}sign(e){return wO(this._key,e)}get public(){return new Lf(this._publicKey)}marshal(){return this._key}get bytes(){return _o.encode({Type:Qt.Ed25519,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}async hash(){let e=$.digest(this.bytes),t;return ss(e)?{bytes:t}=await e:t=e.bytes,t}async id(){let e=Lt.digest(this.public.bytes);return Fe.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if(t==="libp2p-key")return Nf(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function Noe(r){if(r.length>Ti){r=Of(r,Ti+Bf);let n=r.subarray(0,Ti),s=r.subarray(Ti,r.length);return new qa(n,s)}r=Of(r,Ti);let e=r.subarray(0,Ti),t=r.subarray(Bf);return new qa(e,t)}function Loe(r){return r=Of(r,Bf),new Lf(r)}async function Ooe(){let{privateKey:r,publicKey:e}=gO();return new qa(r,e)}async function SO(r){let{privateKey:e,publicKey:t}=bO(r);return new qa(e,t)}function Of(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new g(`Key must be a Uint8Array of length ${e}, got ${r.length}`,"ERR_INVALID_KEY_TYPE");return r}var Koe={"P-256":256,"P-384":384,"P-521":521},Moe=Object.keys(Koe),vHe=Moe.join(" / ");async function _O(r,e){let t=qe.decode(r);return Qy().decrypt(t,e)}var XE={};V(XE,{MAX_RSA_KEY_SIZE:()=>Mf,RsaPrivateKey:()=>ll,RsaPublicKey:()=>Kf,fromJwk:()=>joe,generateKeyPair:()=>Qoe,unmarshalRsaPrivateKey:()=>jE,unmarshalRsaPublicKey:()=>Yoe});function Ao(r){if(isNaN(r)||r<=0)throw new g("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return zt(r)}var Ha={};V(Ha,{exportToPem:()=>zoe,importFromPem:()=>YE,jwkToPkcs1:()=>Foe,jwkToPkix:()=>qoe,pkcs1ToJwk:()=>Uoe,pkixToJwk:()=>Voe});function Uoe(r){let{result:e}=tt(r),t=e.valueBlock.value;return{n:T(Ro(t[1].toBigInt()),"base64url"),e:T(Ro(t[2].toBigInt()),"base64url"),d:T(Ro(t[3].toBigInt()),"base64url"),p:T(Ro(t[4].toBigInt()),"base64url"),q:T(Ro(t[5].toBigInt()),"base64url"),dp:T(Ro(t[6].toBigInt()),"base64url"),dq:T(Ro(t[7].toBigInt()),"base64url"),qi:T(Ro(t[8].toBigInt()),"base64url"),kty:"RSA",alg:"RS256"}}function Foe(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new g("JWK was missing components","ERR_INVALID_PARAMETERS");let t=new re({value:[new X({value:0}),X.fromBigInt(Io(R(r.n,"base64url"))),X.fromBigInt(Io(R(r.e,"base64url"))),X.fromBigInt(Io(R(r.d,"base64url"))),X.fromBigInt(Io(R(r.p,"base64url"))),X.fromBigInt(Io(R(r.q,"base64url"))),X.fromBigInt(Io(R(r.dp,"base64url"))),X.fromBigInt(Io(R(r.dq,"base64url"))),X.fromBigInt(Io(R(r.qi,"base64url")))]}).toBER();return new Uint8Array(t,0,t.byteLength)}function Voe(r){let{result:e}=tt(r),t=e.valueBlock.value[1].valueBlock.value[0].valueBlock.value;return{kty:"RSA",n:T(Ro(t[0].toBigInt()),"base64url"),e:T(Ro(t[1].toBigInt()),"base64url")}}function qoe(r){if(r.n==null||r.e==null)throw new g("JWK was missing components","ERR_INVALID_PARAMETERS");let t=new re({value:[new re({value:[new Le({value:"1.2.840.113549.1.1.1"}),new yt]}),new Hr({valueHex:new re({value:[X.fromBigInt(Io(R(r.n,"base64url"))),X.fromBigInt(Io(R(r.e,"base64url")))]}).toBER()})]}).toBER();return new Uint8Array(t,0,t.byteLength)}function Ro(r){let e=r.toString(16);e.length%2>0&&(e=`0${e}`);let t=e.length/2,n=new Uint8Array(t),s=0,o=0;for(;s<t;)n[s]=parseInt(e.slice(o,o+2),16),s+=1,o+=2;return n}function Io(r){let e=[];return r.forEach(function(t){let n=t.toString(16);n.length%2>0&&(n=`0${n}`),e.push(n)}),BigInt("0x"+e.join(""))}var Hoe=16,GE=32,WE=1e4;async function zoe(r,e){let t=kr.get(),s=new re({value:[new X({value:0}),new re({value:[new Le({value:"1.2.840.113549.1.1.1"}),new yt]}),new nt({valueHex:r.marshal()})]}).toBER(),o=new Uint8Array(s,0,s.byteLength),i=Ao(Hoe),a=await Xr(er,e,i,{c:WE,dkLen:GE}),c=Ao(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,o),f=new re({value:[new nt({valueHex:i}),new X({value:WE}),new X({value:GE}),new re({value:[new Le({value:"1.2.840.113549.2.11"}),new yt]})]}),h=new re({value:[new Le({value:"1.2.840.113549.1.5.13"}),new re({value:[new re({value:[new Le({value:"1.2.840.113549.1.5.12"}),f]}),new re({value:[new Le({value:"2.16.840.1.101.3.4.1.42"}),new nt({valueHex:c})]})]})]}),p=new re({value:[h,new nt({valueHex:u})]}).toBER(),m=new Uint8Array(p,0,p.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...T(m,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function YE(r,e){let t=kr.get(),n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){let s=R(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=tt(s),{iv:i,salt:a,iterations:c,keySize:l,cipherText:u}=$oe(o),f=await Xr(er,e,a,{c,dkLen:l}),h=await t.subtle.importKey("raw",f,"AES-CBC",!1,["decrypt"]),d=Nd(await t.subtle.decrypt({name:"AES-CBC",iv:i},h,u)),{result:p}=tt(d);n=AO(p)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){let s=R(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=tt(s);n=AO(o)}else throw new g("Could not parse private key from PEM data","ERR_INVALID_PARAMETERS");return jE(n)}function $oe(r){let e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new g("Only pkcs5PBES2 encrypted private keys are supported","ERR_INVALID_PARAMS");let n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new g("Only pkcs5PBKDF2 key derivation functions are supported","ERR_INVALID_PARAMS");let o=n.valueBlock.value[1],i=Nd(o.valueBlock.value[0].getValue()),a=WE,c=GE;if(o.valueBlock.value.length===3)a=Number(o.valueBlock.value[1].toBigInt()),c=Number(o.valueBlock.value[2].toBigInt());else if(o.valueBlock.value.length===2)throw new g("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key","ERR_INVALID_PARAMS");let l=e.valueBlock.value[1].valueBlock.value[1],u=l.valueBlock.value[0].toString();if(u!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(u!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new g("Only AES-CBC encryption schemes are supported","ERR_INVALID_PARAMS")}}}}let f=Nd(l.valueBlock.value[1].getValue());return{cipherText:Nd(r.valueBlock.value[1].getValue()),salt:i,iterations:a,keySize:c,iv:f}}function AO(r){return Nd(r.valueBlock.value[2].getValue())}function Nd(r){return new Uint8Array(r,0,r.byteLength)}async function RO(r){let e=await kr.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await kO(e);return{privateKey:t[0],publicKey:t[1]}}async function QE(r){let t=[await kr.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await Goe(r)],n=await kO({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function IO(r,e){let t=await kr.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await kr.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(n,0,n.byteLength)}async function TO(r,e,t){let n=await kr.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return kr.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,e,t instanceof Uint8Array?t:t.subarray())}async function kO(r){if(r.privateKey==null||r.publicKey==null)throw new g("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([kr.get().subtle.exportKey("jwk",r.privateKey),kr.get().subtle.exportKey("jwk",r.publicKey)])}async function Goe(r){return kr.get().subtle.importKey("jwk",{kty:r.kty,n:r.n,e:r.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function Jy(r){if(r.kty!=="RSA")throw new g("invalid key type","ERR_INVALID_KEY_TYPE");if(r.n==null)throw new g("invalid key modulus","ERR_INVALID_KEY_MODULUS");return R(r.n,"base64url").length*8}var Mf=8192,Kf=class{_key;constructor(e){this._key=e}verify(e,t){return TO(this._key,t,e)}marshal(){return Ha.jwkToPkix(this._key)}get bytes(){return ki.encode({Type:Qt.RSA,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return ss(e)?e.then(({bytes:t})=>t):e.bytes}},ll=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t}genSecret(){return Ao(16)}sign(e){return IO(this._key,e)}get public(){if(this._publicKey==null)throw new g("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new Kf(this._publicKey)}marshal(){return Ha.jwkToPkcs1(this._key)}get bytes(){return _o.encode({Type:Qt.RSA,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return ss(e)?e.then(({bytes:t})=>t):e.bytes}async id(){let e=await this.public.hash();return T(e,"base58btc")}async export(e,t="pkcs-8"){if(t==="pkcs-8")return Ha.exportToPem(this,e);if(t==="libp2p-key")return Nf(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};async function jE(r){let e=Ha.pkcs1ToJwk(r);if(Jy(e)>Mf)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let t=await QE(e);return new ll(t.privateKey,t.publicKey)}function Yoe(r){let e=Ha.pkixToJwk(r);if(Jy(e)>Mf)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new Kf(e)}async function joe(r){if(Jy(r)>Mf)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await QE(r);return new ll(e.privateKey,e.publicKey)}async function Qoe(r){if(r>Mf)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await RO(r);return new ll(e.privateKey,e.publicKey)}var ZE={};V(ZE,{Secp256k1PrivateKey:()=>Ff,Secp256k1PublicKey:()=>Uf,generateKeyPair:()=>eie,unmarshalSecp256k1PrivateKey:()=>Joe,unmarshalSecp256k1PublicKey:()=>Zoe});function DO(){return ae.utils.randomPrivateKey()}function PO(r,e){let t=$.digest(e instanceof Uint8Array?e:e.subarray());if(ss(t))return t.then(({digest:n})=>ae.sign(n,r).toDERRawBytes()).catch(n=>{throw new g(String(n),"ERR_INVALID_INPUT")});try{return ae.sign(t.digest,r).toDERRawBytes()}catch(n){throw new g(String(n),"ERR_INVALID_INPUT")}}function CO(r,e,t){let n=$.digest(t instanceof Uint8Array?t:t.subarray());if(ss(n))return n.then(({digest:s})=>ae.verify(e,s,r)).catch(s=>{throw new g(String(s),"ERR_INVALID_INPUT")});try{return ae.verify(e,n.digest,r)}catch(s){throw new g(String(s),"ERR_INVALID_INPUT")}}function BO(r){return ae.ProjectivePoint.fromHex(r).toRawBytes(!0)}function NO(r){try{ae.getPublicKey(r,!0)}catch(e){throw new g(String(e),"ERR_INVALID_PRIVATE_KEY")}}function JE(r){try{ae.ProjectivePoint.fromHex(r)}catch(e){throw new g(String(e),"ERR_INVALID_PUBLIC_KEY")}}function LO(r){try{return ae.getPublicKey(r,!0)}catch(e){throw new g(String(e),"ERR_INVALID_PRIVATE_KEY")}}var Uf=class{_key;constructor(e){JE(e),this._key=e}verify(e,t){return CO(this._key,t,e)}marshal(){return BO(this._key)}get bytes(){return ki.encode({Type:Qt.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}async hash(){let e=$.digest(this.bytes),t;return ss(e)?{bytes:t}=await e:t=e.bytes,t}},Ff=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t??LO(e),NO(this._key),JE(this._publicKey)}sign(e){return PO(this._key,e)}get public(){return new Uf(this._publicKey)}marshal(){return this._key}get bytes(){return _o.encode({Type:Qt.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return ss(e)?e.then(({bytes:t})=>t):e.bytes}async id(){let e=await this.public.hash();return T(e,"base58btc")}async export(e,t="libp2p-key"){if(t==="libp2p-key")return Nf(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function Joe(r){return new Ff(r)}function Zoe(r){return new Uf(r)}async function eie(){let r=DO();return new Ff(r)}var Ld={rsa:XE,ed25519:$E,secp256k1:ZE};function OO(r){let e=Object.keys(Ld).join(" / ");return new g(`invalid or unsupported key type ${r}. Must be ${e}`,"ERR_UNSUPPORTED_KEY_TYPE")}function tie(r){if(r=r.toLowerCase(),r==="rsa"||r==="ed25519"||r==="secp256k1")return Ld[r];throw OO(r)}async function KO(r,e){return tie(r).generateKeyPair(e??2048)}async function e7(r){let e=_o.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case Qt.RSA:return Ld.rsa.unmarshalRsaPrivateKey(t);case Qt.Ed25519:return Ld.ed25519.unmarshalEd25519PrivateKey(t);case Qt.Secp256k1:return Ld.secp256k1.unmarshalSecp256k1PrivateKey(t);default:throw OO(e.Type??"RSA")}}async function Od(r,e){try{let t=await _O(r,e);return await e7(t)}catch{}if(!r.includes("BEGIN"))throw new g("Encrypted key was not a libp2p-key or a PEM file","ERR_INVALID_IMPORT_FORMAT");return YE(r,e)}var MO={sha1:aD,"sha2-256":ha,"sha2-512":er};function Kd(r,e,t,n,s){if(s!=="sha1"&&s!=="sha2-256"&&s!=="sha2-512"){let a=Object.keys(MO).join(" / ");throw new g(`Hash '${s}' is unknown or not supported. Must be ${a}`,"ERR_UNSUPPORTED_HASH_TYPE")}let o=MO[s],i=bk(o,r,e,{c:t,dkLen:n});return qe.encode(i).substring(1)}var WO=fe(GO(),1),Hf=WO.default;var nK=fe(rK(),1);var Ye;(function(r){r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",r.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",r.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",r.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",r.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",r.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",r.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",r.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",r.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",r.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",r.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",r.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",r.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",r.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH"})(Ye||(Ye={}));var Eie="/pkcs8/",sK="/info/",ul=new WeakMap,fl={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},r7={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function Di(r){return r==null||typeof r!="string"?!1:r===(0,nK.default)(r.trim())&&r.length>0}async function ht(){let t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function To(r){return new ct(Eie+r)}function za(r){return new ct(sK+r)}var tg=class{components;init;log;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init=Hf(r7,t),this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<fl.minKeyLength)throw new Error(`dek.keyLength must be least ${fl.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<fl.minSaltLength)throw new Error(`dek.saltLength must be least ${fl.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<fl.minIterationCount)throw new Error(`dek.iterationCount must be least ${fl.minIterationCount}`);let n=this.init.pass!=null&&this.init.dek?.salt!=null?Kd(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";ul.set(this,{dek:n})}static generateOptions(){let e=Object.assign({},r7),t=Math.ceil(fl.minSaltLength/3)*3;return e.dek.salt=T(Ao(t),"base64"),e}static get options(){return r7}async createKey(e,t,n=2048){if(!Di(e)||e==="self")throw await ht(),new g("Invalid key name",Ye.ERR_INVALID_KEY_NAME);if(typeof t!="string")throw await ht(),new g("Invalid key type",Ye.ERR_INVALID_KEY_TYPE);let s=To(e);if(await this.components.datastore.has(s))throw await ht(),new g("Key name already exists",Ye.ERR_KEY_ALREADY_EXISTS);switch(t.toLowerCase()){case"rsa":if(!Number.isSafeInteger(n)||n<2048)throw await ht(),new g("Invalid RSA key size",Ye.ERR_INVALID_KEY_SIZE);break;default:break}let i;try{let a=await KO(t,n),c=await a.id(),l=ul.get(this);if(l==null)throw new g("dek missing",Ye.ERR_INVALID_PARAMETERS);let u=l.dek,f=await a.export(u);i={name:e,id:c};let h=this.components.datastore.batch();h.put(s,R(f)),h.put(za(e),R(JSON.stringify(i))),await h.commit()}catch(a){throw await ht(),a}return i}async listKeys(){let e={prefix:sK},t=[];for await(let n of this.components.datastore.query(e))t.push(JSON.parse(T(n.value)));return t}async findKeyById(e){try{let n=(await this.listKeys()).find(s=>s.id===e);if(n==null)throw new g(`Key with id '${e}' does not exist.`,Ye.ERR_KEY_NOT_FOUND);return n}catch(t){throw await ht(),t}}async findKeyByName(e){if(!Di(e))throw await ht(),new g(`Invalid key name '${e}'`,Ye.ERR_INVALID_KEY_NAME);let t=za(e);try{let n=await this.components.datastore.get(t);return JSON.parse(T(n))}catch(n){throw await ht(),this.log.error(n),new g(`Key '${e}' does not exist.`,Ye.ERR_KEY_NOT_FOUND)}}async removeKey(e){if(!Di(e)||e==="self")throw await ht(),new g(`Invalid key name '${e}'`,Ye.ERR_INVALID_KEY_NAME);let t=To(e),n=await this.findKeyByName(e),s=this.components.datastore.batch();return s.delete(t),s.delete(za(e)),await s.commit(),n}async renameKey(e,t){if(!Di(e)||e==="self")throw await ht(),new g(`Invalid old key name '${e}'`,Ye.ERR_OLD_KEY_NAME_INVALID);if(!Di(t)||t==="self")throw await ht(),new g(`Invalid new key name '${t}'`,Ye.ERR_NEW_KEY_NAME_INVALID);let n=To(e),s=To(t),o=za(e),i=za(t);if(await this.components.datastore.has(s))throw await ht(),new g(`Key '${t}' already exists`,Ye.ERR_KEY_ALREADY_EXISTS);try{let c=await this.components.datastore.get(n),l=await this.components.datastore.get(o),u=JSON.parse(T(l));u.name=t;let f=this.components.datastore.batch();return f.put(s,c),f.put(i,R(JSON.stringify(u))),f.delete(n),f.delete(o),await f.commit(),u}catch(c){throw await ht(),c}}async exportKey(e,t){if(!Di(e))throw await ht(),new g(`Invalid key name '${e}'`,Ye.ERR_INVALID_KEY_NAME);if(t==null)throw await ht(),new g("Password is required",Ye.ERR_PASSWORD_REQUIRED);let n=To(e);try{let s=await this.components.datastore.get(n),o=T(s),i=ul.get(this);if(i==null)throw new g("dek missing",Ye.ERR_INVALID_PARAMETERS);let a=i.dek;return await(await Od(o,a)).export(t)}catch(s){throw await ht(),s}}async exportPeerId(e){let t="temporary-password",n=await this.exportKey(e,t),s=await Od(n,t);return xr(s.public.bytes,s.bytes)}async importKey(e,t,n){if(!Di(e)||e==="self")throw await ht(),new g(`Invalid key name '${e}'`,Ye.ERR_INVALID_KEY_NAME);if(t==null)throw await ht(),new g("PEM encoded key is required",Ye.ERR_PEM_REQUIRED);let s=To(e);if(await this.components.datastore.has(s))throw await ht(),new g(`Key '${e}' already exists`,Ye.ERR_KEY_ALREADY_EXISTS);let i;try{i=await Od(t,n)}catch{throw await ht(),new g("Cannot read the key, most likely the password is wrong",Ye.ERR_CANNOT_READ_KEY)}let a;try{a=await i.id();let u=ul.get(this);if(u==null)throw new g("dek missing",Ye.ERR_INVALID_PARAMETERS);let f=u.dek;t=await i.export(f)}catch(u){throw await ht(),u}let c={name:e,id:a},l=this.components.datastore.batch();return l.put(s,R(t)),l.put(za(e),R(JSON.stringify(c))),await l.commit(),c}async importPeer(e,t){try{if(!Di(e))throw new g(`Invalid key name '${e}'`,Ye.ERR_INVALID_KEY_NAME);if(t==null)throw new g("PeerId is required",Ye.ERR_MISSING_PRIVATE_KEY);if(t.privateKey==null)throw new g("PeerId.privKey is required",Ye.ERR_MISSING_PRIVATE_KEY);let n=await e7(t.privateKey),s=To(e);if(await this.components.datastore.has(s))throw await ht(),new g(`Key '${e}' already exists`,Ye.ERR_KEY_ALREADY_EXISTS);let i=ul.get(this);if(i==null)throw new g("dek missing",Ye.ERR_INVALID_PARAMETERS);let a=i.dek,c=await n.export(a),l={name:e,id:t.toString()},u=this.components.datastore.batch();return u.put(s,R(c)),u.put(za(e),R(JSON.stringify(l))),await u.commit(),l}catch(n){throw await ht(),n}}async getPrivateKey(e){if(!Di(e))throw await ht(),new g(`Invalid key name '${e}'`,Ye.ERR_INVALID_KEY_NAME);try{let t=To(e),n=await this.components.datastore.get(t);return T(n)}catch(t){throw await ht(),this.log.error(t),new g(`Key '${e}' does not exist.`,Ye.ERR_KEY_NOT_FOUND)}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await ht(),new g(`Invalid old pass type '${typeof e}'`,Ye.ERR_INVALID_OLD_PASS_TYPE);if(typeof t!="string")throw await ht(),new g(`Invalid new pass type '${typeof t}'`,Ye.ERR_INVALID_NEW_PASS_TYPE);if(t.length<20)throw await ht(),new g(`Invalid pass length ${t.length}`,Ye.ERR_INVALID_PASS_LENGTH);this.log("recreating keychain");let n=ul.get(this);if(n==null)throw new g("dek missing",Ye.ERR_INVALID_PARAMETERS);let s=n.dek;this.init.pass=t;let o=t!=null&&this.init.dek?.salt!=null?Kd(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";ul.set(this,{dek:o});let i=await this.listKeys();for(let a of i){let c=await this.components.datastore.get(To(a.name)),l=T(c),u=await Od(l,s),f=o.toString(),h=await u.export(f),d=this.components.datastore.batch(),p={name:a.name,id:a.id};d.put(To(a.name),R(h)),d.put(za(a.name),R(JSON.stringify(p))),await d.commit()}this.log("keychain reconstructed")}};function rg(r={}){return e=>new tg(e,r)}var zf=class{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new n7}async consume(e,t=1,n={}){let s=this.getKey(e),o=this._getKeySecDuration(n),i=this.memoryStorage.incrby(s,t,o);if(i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.consumedPoints>this.points)throw this.blockDuration>0&&i.consumedPoints<=this.points+t&&(i=this.memoryStorage.set(s,i.consumedPoints,this.blockDuration)),new g("Rate limit exceeded","ERR_RATE_LIMIT_EXCEEDED",i);if(this.execEvenly&&i.msBeforeNext>0&&!i.isFirstInDuration){let a=Math.ceil(i.msBeforeNext/(i.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=i.consumedPoints*this.execEvenlyMinDelayMs),await ay(a)}return i}penalty(e,t=1,n={}){let s=this.getKey(e),o=this._getKeySecDuration(n),i=this.memoryStorage.incrby(s,t,o);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}reward(e,t=1,n={}){let s=this.getKey(e),o=this._getKeySecDuration(n),i=this.memoryStorage.incrby(s,-t,o);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}block(e,t){let n=t*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(e),s,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:s,isFirstInDuration:!1}}set(e,t,n=0){let s=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:t,isFirstInDuration:!1}}get(e){let t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}},n7=class{storage;constructor(){this.storage=new Map}incrby(e,t,n){let s=this.storage.get(e);if(s!=null){let o=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||o>0?(s.value+=t,{remainingPoints:0,msBeforeNext:o,consumedPoints:s.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){let s=n*1e3,o=this.storage.get(e);o!=null&&clearTimeout(o.timeoutId);let i={value:t,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(e,i),s>0&&(i.timeoutId=setTimeout(()=>{this.storage.delete(e)},s),i.timeoutId.unref!=null&&i.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:i.value,isFirstInDuration:!0}}get(e){let t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){let t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}};var ze;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(ze||(ze={}));var Md=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),s7=Object.freeze({NEW_STREAM:ze.NEW_STREAM,MESSAGE:ze.MESSAGE_INITIATOR,CLOSE:ze.CLOSE_INITIATOR,RESET:ze.RESET_INITIATOR}),oK=Object.freeze({MESSAGE:ze.MESSAGE_RECEIVER,CLOSE:ze.CLOSE_RECEIVER,RESET:ze.RESET_RECEIVER});var o7=1<<20,vie=4<<20,ng=class{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=o7,t=vie){this._buffer=new ke,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw Object.assign(new Error("unprocessed message queue size too large!"),{code:"ERR_MSG_QUEUE_TOO_BIG"});let t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(l){if(l.code==="ERR_MSG_TOO_BIG")throw l;break}let{id:n,type:s,length:o,offset:i}=this._headerInfo;if(this._buffer.length-i<o)break;let c={id:n,type:s};(s===ze.NEW_STREAM||s===ze.MESSAGE_INITIATOR||s===ze.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(i,i+o)),t.push(c),this._buffer.consume(i+o),this._headerInfo=null}return t}_decodeHeader(e){let{value:t,offset:n}=aK(e),{value:s,offset:o}=aK(e,n),i=t&7;if(Md[i]==null)throw new Error(`Invalid type received: ${i}`);if(s>this._maxMessageSize)throw Object.assign(new Error("message size too large!"),{code:"ERR_MSG_TOO_BIG"});return{id:t>>3,type:i,offset:n+o,length:s}}},xie=128,iK=127;function aK(r,e=0){let t=0,n=0,s=e,o,i=r.length;do{if(s>=i||n>49)throw e=0,new RangeError("Could not decode varint");o=r.get(s++),t+=n<28?(o&iK)<<n:(o&iK)*Math.pow(2,n),n+=7}while(o>=xie);return e=s-e,{value:t,offset:e}}var i7=10*1024,a7=class{_pool;_poolOffset;constructor(){this._pool=kt(i7),this._poolOffset=0}write(e,t){let n=this._pool,s=this._poolOffset;Zt(e.id<<3|e.type,n,s),s+=Jt(e.id<<3|e.type),(e.type===ze.NEW_STREAM||e.type===ze.MESSAGE_INITIATOR||e.type===ze.MESSAGE_RECEIVER)&&e.data!=null?(Zt(e.data.length,n,s),s+=Jt(e.data.length)):(Zt(0,n,s),s+=Jt(0));let o=n.subarray(this._poolOffset,s);i7-s<100?(this._pool=kt(i7),this._poolOffset=0):this._poolOffset=s,t.append(o),(e.type===ze.NEW_STREAM||e.type===ze.MESSAGE_INITIATOR||e.type===ze.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}},Sie=new a7;async function*cK(r){for await(let e of r){let t=new ke;Sie.write(e,t),yield t}}var c7=class extends xa{name;streamId;send;types;maxDataSize;constructor(e){super(e),this.types=e.direction==="outbound"?s7:oK,this.send=e.send,this.name=e.name,this.streamId=e.streamId,this.maxDataSize=e.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:s7.NEW_STREAM,data:new ke(R(this.name))})}async sendData(e){for(e=e.sublist();e.byteLength>0;){let t=Math.min(e.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:e.sublist(0,t)}),e.consume(t)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}};function lK(r){let{id:e,name:t,send:n,onEnd:s,type:o="initiator",maxMsgSize:i=o7}=r;return new c7({id:o==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:o==="initiator"?"outbound":"inbound",maxDataSize:i,onEnd:s,send:n,log:r.logger.forComponent(`libp2p:mplex:stream:${o}:${e}`)})}var _ie=1024,Aie=1024,Rie=1024*1024*4,Iie=5,Tie=500;function uK(r){let e={...r,type:`${Md[r.type]} (${r.type})`};return r.type===ze.NEW_STREAM&&(e.data=T(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===ze.MESSAGE_INITIATOR||r.type===ze.MESSAGE_RECEIVER)&&(e.data=T(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}var sg=class{protocol="/mplex/6.7.0";sink;source;log;_streamId;_streams;_init;_source;closeController;rateLimiter;closeTimeout;logger;constructor(e,t){t=t??{},this.log=e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??Tie,this.sink=this._createSink(),this._source=Tt({objectMode:!0,onEnd:()=>{for(let n of this._streams.initiators.values())n.destroy();for(let n of this._streams.receivers.values())n.destroy()}}),this.source=lt(this._source,n=>cK(n)),this.closeController=new AbortController,this.rateLimiter=new zf({points:t.disconnectThreshold??Iie,duration:1})}get streams(){let e=[];for(let t of this._streams.initiators.values())e.push(t);for(let t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Error("Muxer already closed");let t=this._streamId++;e=e==null?t.toString():e.toString();let n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}async close(e){if(this.closeController.signal.aborted)return;let t=e?.signal??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async n=>n.close({signal:t}))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(n){this.abort(n)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach(t=>{t.abort(e)}),this.closeController.abort(e))}_newReceiverStream(e){let{id:t,name:n}=e,s=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:s})}_newStream(e){let{id:t,name:n,type:s,registry:o}=e;if(this.log("new %s stream %s",s,t),s==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??Aie))throw new g("Too many outbound streams open","ERR_TOO_MANY_OUTBOUND_STREAMS");if(o.has(t))throw new Error(`${s} stream ${t} already exists!`);let c=lK({id:t,name:n,send:async l=>{this.log.enabled&&this.log.trace("%s stream %s send",s,t,uK(l)),this._source.push(l)},type:s,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",s,t,c.protocol),o.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize,logger:this.logger});return o.set(t,c),c}_createSink(){return async t=>{let n=()=>{lm(t,this.log)};this.closeController.signal.addEventListener("abort",n);try{let s=new ng(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(let o of t)for(let i of s.write(o))await this._handleIncoming(i);this._source.end()}catch(s){this.log("error in sink",s),this._source.end(s)}finally{this.closeController.signal.removeEventListener("abort",n)}}}async _handleIncoming(e){let{id:t,type:n}=e;if(this.log.enabled&&this.log.trace("incoming message",uK(e)),e.type===ze.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??_ie)){this.log("too many inbound streams open"),this._source.push({id:t,type:ze.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}return}let a=this._newReceiverStream({id:t,name:T(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}let o=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(o==null){this.log("missing stream %s for message type %s",t,Md[n]);try{await this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}let i=this._init.maxStreamBufferSize??Rie;try{switch(n){case ze.MESSAGE_INITIATOR:case ze.MESSAGE_RECEIVER:if(o.sourceReadableLength()>i)throw this._source.push({id:e.id,type:n===ze.MESSAGE_INITIATOR?ze.RESET_RECEIVER:ze.RESET_INITIATOR}),new g("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers","ERR_STREAM_INPUT_BUFFER_FULL");o.sourcePush(e.data);break;case ze.CLOSE_INITIATOR:case ze.CLOSE_RECEIVER:o.remoteCloseWrite();break;case ze.RESET_INITIATOR:case ze.RESET_RECEIVER:o.reset();break;default:this.log("unknown message type %s",n)}}catch(a){this.log.error("error while processing message",a),o.abort(a)}}};var l7=class{protocol="/mplex/6.7.0";_init;components;constructor(e,t={}){this.components=e,this._init=t}createStreamMuxer(e={}){return new sg(this.components,{...e,...this._init})}};function fK(r={}){return e=>new l7(e,r)}var os;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.Secp256k1="Secp256k1"})(os||(os={}));var u7;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.Secp256k1=2]="Secp256k1"})(u7||(u7={}));(function(r){r.codec=()=>Te(u7)})(os||(os={}));var $f;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),os.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=os.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})($f||($f={}));var Gf;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),os.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=os.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(Gf||(Gf={}));var Cie={"P-256":256,"P-384":384,"P-521":521},Bie=Object.keys(Cie),oGe=Bie.join(" / ");function hl(r){if(isNaN(r)||r<=0)throw new g("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return zt(r)}var yK="1.0.0",gK="ping",bK="ipfs";var h7="ERR_WRONG_PING_ACK";var ag=class{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnTransientConnection;log;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??bK}/${gK}/${yK}`,this.timeout=t.timeout??1e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??1,this.runOnTransientConnection=t.runOnTransientConnection??!0,this.handleMessage=this.handleMessage.bind(this)}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);let{stream:t}=e,n=Date.now();lt(t,t).catch(s=>{this.log.error("incoming ping from %p failed with error",e.connection.remotePeer,s)}).finally(()=>{let s=Date.now()-n;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,s)})}async ping(e,t={}){this.log("pinging %p",e);let n=Date.now(),s=hl(32),o=await this.components.connectionManager.openConnection(e,t),i,a=()=>{};if(t.signal==null){let c=AbortSignal.timeout(this.timeout);t={...t,signal:c}}try{i=await o.newStream(this.protocol,{...t,runOnTransientConnection:this.runOnTransientConnection}),a=()=>{i?.abort(new g("ping timeout",Fo))},t.signal?.addEventListener("abort",a,{once:!0});let c=await lt([s],i,async u=>Yc(u)),l=Date.now()-n;if(c==null)throw new g(`Did not receive a ping ack after ${l}ms`,h7);if(!q(s,c.subarray()))throw new g(`Received wrong ping ack after ${l}ms`,h7);return this.log("ping %p complete in %dms",o.remotePeer,l),l}catch(c){throw this.log.error("error while pinging %p",o.remotePeer,c),i?.abort(c),c}finally{t.signal?.removeEventListener("abort",a),i!=null&&await i.close()}}};function wK(r={}){return e=>new ag(e,r)}var Cn;(function(r){r.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",r.ERR_DATA_CHANNEL="ERR_DATA_CHANNEL",r.ERR_CONNECTION_CLOSED="ERR_CONNECTION_CLOSED",r.ERR_HASH_NOT_SUPPORTED="ERR_HASH_NOT_SUPPORTED",r.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",r.ERR_INVALID_FINGERPRINT="ERR_INVALID_FINGERPRINT",r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",r.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",r.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS"})(Cn||(Cn={}));var $a=class extends g{constructor(e,t){super(`WebRTC transport error: ${e}`,t??""),this.name="WebRTCTransportError"}};var p7=class extends $a{constructor(e,t){super(`[stream: ${e}] data channel error: ${t}`,Cn.ERR_DATA_CHANNEL),this.name="WebRTC/DataChannelError"}};function w7(r,e){return new p7(r,e)}var d7=class extends $a{constructor(e){super(`There was a problem with the Multiaddr which was passed in: ${e}`,Cn.ERR_INVALID_MULTIADDR),this.name="WebRTC/InappropriateMultiaddrError"}};function cg(r){return new d7(r)}var m7=class extends $a{constructor(e){super(`There was a problem with a provided argument: ${e}`,Cn.ERR_INVALID_PARAMETERS),this.name="WebRTC/InvalidArgumentError"}};function Ud(r){return new m7(r)}var y7=class extends $a{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`,Cn.ERR_INVALID_FINGERPRINT),this.name="WebRTC/InvalidFingerprintError"}};function E7(r,e){return new y7(r,e)}var g7=class extends $a{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`,Cn.ERR_NOT_IMPLEMENTED),this.name="WebRTC/UnimplementedError"}};function EK(r){return new g7(r)}var b7=class extends $a{constructor(e){super(`unsupported hash algorithm: ${e}`,Cn.ERR_HASH_NOT_SUPPORTED),this.name="WebRTC/UnsupportedHashAlgorithmError"}};function vK(r){return new b7(r)}var xK=function(r,e,t){if(t||arguments.length===2)for(var n=0,s=e.length,o;n<s;n++)(o||!(n in e))&&(o||(o=Array.prototype.slice.call(e,0,n)),o[n]=e[n]);return r.concat(o||Array.prototype.slice.call(e))},Hie=function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r}();var zie=function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=process.platform}return r}();var $ie=function(){function r(e,t,n,s){this.name=e,this.version=t,this.os=n,this.bot=s,this.type="bot-device"}return r}();var Gie=function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r}();var Wie=function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r}();var Yie=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,jie=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,SK=3,Qie=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",Yie]],_K=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function RK(r){return r?AK(r):typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new Wie:typeof navigator<"u"?AK(navigator.userAgent):Zie()}function Xie(r){return r!==""&&Qie.reduce(function(e,t){var n=t[0],s=t[1];if(e)return e;var o=s.exec(r);return!!o&&[n,o]},!1)}function AK(r){var e=Xie(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new Gie;var s=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);s?s.length<SK&&(s=xK(xK([],s,!0),eae(SK-s.length),!0)):s=[];var o=s.join("."),i=Jie(r),a=jie.exec(r);return a&&a[1]?new $ie(t,o,i,a[1]):new Hie(t,o,i)}function Jie(r){for(var e=0,t=_K.length;e<t;e++){var n=_K[e],s=n[0],o=n[1],i=o.exec(r);if(i)return s}return null}function Zie(){var r=typeof process<"u"&&process.version;return r?new zie(process.version.slice(1)):null}function eae(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}var IK=RK(),Fd=IK!=null&&IK.name==="firefox",lg=async function*(){},ug=async r=>{},tae=30*1e3;function TK(r,e,t=tae,n){r.readyState==="open"&&Promise.resolve().then(async()=>{if(r.bufferedAmount>0){n.log("%s drain channel with %d buffered bytes",e,r.bufferedAmount);let s=xe(),o=!1;r.bufferedAmountLowThreshold=0;let i=()=>{o||(n.log("%s drain channel closed before drain",e),s.resolve())};r.addEventListener("close",i,{once:!0}),r.addEventListener("bufferedamountlow",()=>{o=!0,r.removeEventListener("close",i),s.resolve()}),await gs(s.promise,{milliseconds:t})}}).then(async()=>{r.readyState==="open"&&r.close()}).catch(s=>{n.log.error("error closing outbound stream",s)})}var pl=class{log;peerConnection;remoteAddr;timeline;metrics;source=lg();sink=ug;constructor(e,t){this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;let n=this.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",this.peerConnection.connectionState,"initial state",n),(this.peerConnection.connectionState==="disconnected"||this.peerConnection.connectionState==="failed"||this.peerConnection.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}};var hn;(function(r){let e;(function(s){s.FIN="FIN",s.STOP_SENDING="STOP_SENDING",s.RESET="RESET",s.FIN_ACK="FIN_ACK"})(e=r.Flag||(r.Flag={}));let t;(function(s){s[s.FIN=0]="FIN",s[s.STOP_SENDING=1]="STOP_SENDING",s[s.RESET=2]="RESET",s[s.FIN_ACK=3]="FIN_ACK"})(t||(t={})),function(s){s.codec=()=>Te(t)}(e=r.Flag||(r.Flag={}));let n;r.codec=()=>(n==null&&(n=ee((s,o,i={})=>{i.lengthDelimited!==!1&&o.fork(),s.flag!=null&&(o.uint32(8),r.Flag.codec().encode(s.flag,o)),s.message!=null&&(o.uint32(18),o.bytes(s.message)),i.lengthDelimited!==!1&&o.ldelim()},(s,o)=>{let i={},a=o==null?s.len:s.pos+o;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:i.flag=r.Flag.codec().decode(s);break;case 2:i.message=s.bytes();break;default:s.skipType(c&7);break}}return i})),n),r.encode=s=>Z(s,r.codec()),r.decode=s=>J(s,r.codec())})(hn||(hn={}));var rae=16*1024*1024,nae=30*1e3,sae=5,oae=2,iae=16*1024,aae=5e3,cae=5e3,v7=class extends xa{channel;incomingData;maxBufferedAmount;bufferedAmountLowEventTimeout;maxMessageSize;receiveFinAck;finAckTimeout;openTimeout;constructor(e){let t=e.onEnd;switch(e.onEnd=s=>{this.log.trace("readable and writeable ends closed",this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await gs(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(o){this.log.error("error receiving FIN_ACK",o)}}).then(()=>{this.incomingData.end(),t?.(s)}).catch(o=>{this.log.error("error ending stream",o)})},super(e),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=Tt(),this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??nae,this.maxBufferedAmount=e.maxBufferedAmount??rae,this.maxMessageSize=(e.maxMessageSize??iae)-sae-oae,this.receiveFinAck=xe(),this.finAckTimeout=e.closeTimeout??aae,this.openTimeout=e.openTimeout??cae,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new g("Unknown datachannel state","ERR_INVALID_STATE")}this.channel.onopen=s=>{this.timeline.open=new Date().getTime()},this.channel.onclose=s=>{this.receiveFinAck.resolve(),this.close().catch(o=>{this.log.error("error closing stream after channel closed",o)})},this.channel.onerror=s=>{let o=s.error;this.abort(o)},this.channel.onmessage=async s=>{let{data:o}=s;o===null||o.byteLength===0||this.incomingData.push(new Uint8Array(o,0,o.byteLength))};let n=this;Promise.resolve().then(async()=>{for await(let s of Mr(this.incomingData)){let o=n.processIncomingProtobuf(s);o!=null&&n.sourcePush(new ke(o))}}).catch(s=>{this.log.error("error processing incoming data channel messages",s)})}sendNewStream(){}async _sendMessage(e,t=!0){if(t&&this.channel.bufferedAmount>this.maxBufferedAmount)try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await Cd(this.channel,"bufferedamountlow",{timeout:this.bufferedAmountLowEventTimeout})}catch(n){throw n instanceof Yi?new g(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`,"ERR_BUFFER_CLEAR_TIMEOUT"):n}if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new g(`Invalid datachannel state - ${this.channel.readyState}`,"ERR_INVALID_STATE");this.channel.readyState!=="open"&&(this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await Cd(this.channel,"open",{timeout:this.openTimeout}),this.log('channel state is now "%s", sending data',this.channel.readyState)),this.channel.send(e.subarray())}async sendData(e){for(e=e.sublist();e.byteLength>0;){let t=Math.min(e.byteLength,this.maxMessageSize),n=e.subarray(0,t),s=hn.encode({message:n}),o=sr.single(s);await this._sendMessage(o),e.consume(t)}}async sendReset(){await this._sendFlag(hn.Flag.RESET)}async sendCloseWrite(e){if(await this._sendFlag(hn.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await nn(this.receiveFinAck.promise,e?.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorCode:"ERR_FIN_ACK_NOT_RECEIVED"})}catch(n){this.log.error("failed to await FIN_ACK",n)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){await this._sendFlag(hn.Flag.STOP_SENDING)}processIncomingProtobuf(e){let t=hn.decode(e);if(t.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===hn.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(hn.Flag.FIN_ACK).catch(n=>{this.log.error("error sending FIN_ACK immediately",n)})),t.flag===hn.Flag.RESET&&this.reset(),t.flag===hn.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===hn.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return t.message}async _sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',this.channel.readyState,e.toString()),!1;this.log.trace("sending flag %s",e.toString());let t=hn.encode({flag:e}),n=sr.single(t);try{return await this._sendMessage(n,!1),!0}catch(s){this.log.error("could not send flag %s",e.toString(),s)}return!1}};function Wf(r){let{channel:e,direction:t}=r;return new v7({id:t==="inbound"?`i${e.id}`:`r${e.id}`,log:r.logger.forComponent(`libp2p:webrtc:stream:${t}:${e.id}`),...r})}var kK="/webrtc",dl=class{protocol;peerConnection;bufferedStreams=[];metrics;dataChannelOptions;components;log;constructor(e,t){this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??kK,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:datachannelmuxerfactory"),this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',n.id),n.label==="init"){this.log.trace("closing early init channel"),n.close();return}let s={},o=Wf({channel:n,direction:"inbound",onEnd:i=>{s.onEnd(i)},logger:e.logger,...this.dataChannelOptions});s.stream=o,s.channel=n,s.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(i=>i.stream.id!==o.id)},this.bufferedStreams.push(s)}}createStreamMuxer(e){return new x7(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}},x7=class{init;streams;protocol;log;peerConnection;dataChannelOptions;metrics;logger;constructor(e,t){this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map(n=>n.stream),this.peerConnection=t.peerConnection,this.protocol=t.protocol??kK,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace("incoming datachannel with channel id %d",n.id),n.label==="init"){this.log.trace("closing init channel"),n.close();return}let s=Wf({channel:n,direction:"inbound",onEnd:()=>{this.log("incoming channel %s ended with state %s",n.id,n.readyState),this.#e(s,n)},logger:this.logger,...this.dataChannelOptions});this.streams.push(s),this.metrics?.increment({incoming_stream:!0}),t?.onIncomingStream?.(s)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(n=>{n.onEnd=()=>{this.log("incoming early channel %s ended with state %s",n.channel.id,n.channel.readyState),this.#e(n.stream,n.channel)},this.metrics?.increment({incoming_stream:!0}),this.init?.onIncomingStream?.(n.stream)})})}#e(e,t){this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),TK(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(n=>n.id!==e.id),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(e)}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(let t of this.streams)t.abort(e)}source=lg();sink=ug;newStream(){let e=this.peerConnection.createDataChannel("");this.log.trace("opened outgoing datachannel with channel id %s",e.id);let t=Wf({channel:e,direction:"outbound",onEnd:()=>{this.log("outgoing channel %s ended with state %s",e.id,e.readyState),this.#e(t,e)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(t),this.metrics?.increment({outgoing_stream:!0}),t}};var Yf=globalThis.RTCPeerConnection,fg=globalThis.RTCSessionDescription,DK=globalThis.RTCIceCandidate;var pn;(function(r){let e;(function(s){s.SDP_OFFER="SDP_OFFER",s.SDP_ANSWER="SDP_ANSWER",s.ICE_CANDIDATE="ICE_CANDIDATE"})(e=r.Type||(r.Type={}));let t;(function(s){s[s.SDP_OFFER=0]="SDP_OFFER",s[s.SDP_ANSWER=1]="SDP_ANSWER",s[s.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(t||(t={})),function(s){s.codec=()=>Te(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=ee((s,o,i={})=>{i.lengthDelimited!==!1&&o.fork(),s.type!=null&&(o.uint32(8),r.Type.codec().encode(s.type,o)),s.data!=null&&(o.uint32(18),o.string(s.data)),i.lengthDelimited!==!1&&o.ldelim()},(s,o)=>{let i={},a=o==null?s.len:s.pos+o;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:i.type=r.Type.codec().decode(s);break;case 2:i.data=s.string();break;default:s.skipType(c&7);break}}return i})),n),r.encode=s=>Z(s,r.codec()),r.decode=s=>J(s,r.codec())})(pn||(pn={}));var hg=async(r,e,t)=>{try{let n=xe();for(uae(r,n);;){let s=await Promise.race([n.promise,e.read({signal:t.signal})]);if(s==null)break;if(s.type!==pn.Type.ICE_CANDIDATE)throw new g("ICE candidate message expected","ERR_NOT_ICE_CANDIDATE");let o=JSON.parse(s.data??"null");if(o===""||o===null){t.log.trace("end-of-candidates received");continue}let i=new DK(o);t.log.trace("%s received new ICE candidate",t.direction,i);try{await r.addIceCandidate(i)}catch(a){t.log.error("%s bad candidate received",t.direction,o,a)}}}catch(n){if(t.log.error("%s error parsing ICE candidate",t.direction,n),t.signal?.aborted===!0)throw n}};function lae(r){return Fd?r.iceConnectionState:r.connectionState}function uae(r,e){r[Fd?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(lae(r)){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new g("RTCPeerConnection was closed","ERR_CONNECTION_CLOSED_BEFORE_CONNECTED"));break;default:break}}}async function PK({peerConnection:r,signal:e,metrics:t,multiaddr:n,connectionManager:s,transportManager:o,log:i}){let{baseAddr:a}=CK(n);t?.dialerEvents.increment({open:!0}),i.trace("dialing base address: %a",a);let c=a.getPeerId();if(c==null)throw new g("Relay peer was missing","ERR_INVALID_ADDRESS");let l=s.getConnections(Ce(c)),u,f=!1;l.length===0?(u=await o.dial(a,{signal:e}),f=!0):u=l[0];try{let h=await u.newStream(pg,{signal:e,runOnTransientConnection:!0}),d=Bt(h).pb(pn);try{let p=r.createDataChannel("init");r.onicecandidate=({candidate:w})=>{let E=JSON.stringify(w?.toJSON()??null);i.trace("initiator sending ICE candidate %s",E),d.write({type:pn.Type.ICE_CANDIDATE,data:E},{signal:e}).catch(x=>{i.error("error sending ICE candidate",x)})},r.onicecandidateerror=w=>{i.error("initiator ICE candidate error",w)};let m=await r.createOffer().catch(w=>{throw i.error("could not execute createOffer",w),new g("Failed to set createOffer","ERR_SDP_HANDSHAKE_FAILED")});i.trace("initiator send SDP offer %s",m.sdp),await d.write({type:pn.Type.SDP_OFFER,data:m.sdp},{signal:e}),await r.setLocalDescription(m).catch(w=>{throw i.error("could not execute setLocalDescription",w),new g("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")});let y=await d.read({signal:e});if(y.type!==pn.Type.SDP_ANSWER)throw new g("Remote should send an SDP answer","ERR_SDP_HANDSHAKE_FAILED");i.trace("initiator receive SDP answer %s",y.data);let b=new fg({type:"answer",sdp:y.data});return await r.setRemoteDescription(b).catch(w=>{throw i.error("could not execute setRemoteDescription",w),new g("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")}),i.trace("initiator read candidates until connected"),await hg(r,d,{direction:"initiator",signal:e,log:i}),i.trace("initiator connected, closing init channel"),p.close(),i.trace("initiator closing signalling stream"),await d.unwrap().unwrap().close({signal:e}),i.trace("initiator connected to remote address %s",n),{remoteAddress:n}}catch(p){throw r.close(),h.abort(p),p}finally{r.onicecandidate=null,r.onicecandidateerror=null}}finally{if(f)try{await u.close({signal:e})}catch(h){u.abort(h)}}}var dg=class extends je{peerId;transportManager;shutdownController;constructor(e,t){super(),this.peerId=e.peerId,this.transportManager=e.transportManager,this.shutdownController=t.shutdownController}async listen(){this.safeDispatchEvent("listening",{})}getAddrs(){return this.transportManager.getListeners().filter(e=>e!==this).map(e=>e.getAddrs().filter(t=>Ls.matches(t)).map(t=>t.encapsulate(`/webrtc/p2p/${this.peerId}`))).flat()}async close(){this.shutdownController.abort(),this.safeDispatchEvent("close",{})}};async function BK({peerConnection:r,stream:e,signal:t,connection:n,log:s}){s.trace("new inbound signaling stream");let o=Bt(e).pb(pn);try{r.onicecandidate=({candidate:u})=>{let f=JSON.stringify(u?.toJSON()??null);s.trace("recipient sending ICE candidate %s",f),o.write({type:pn.Type.ICE_CANDIDATE,data:f},{signal:t}).catch(h=>{s.error("error sending ICE candidate",h)})};let a=await o.read({signal:t});if(a.type!==pn.Type.SDP_OFFER)throw new g(`expected message type SDP_OFFER, received: ${a.type??"undefined"} `,"ERR_SDP_HANDSHAKE_FAILED");s.trace("recipient receive SDP offer %s",a.data);let c=new fg({type:"offer",sdp:a.data});await r.setRemoteDescription(c).catch(u=>{throw s.error("could not execute setRemoteDescription",u),new g("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")});let l=await r.createAnswer().catch(u=>{throw s.error("could not execute createAnswer",u),new g("Failed to create answer","ERR_SDP_HANDSHAKE_FAILED")});s.trace("recipient send SDP answer %s",l.sdp),await o.write({type:pn.Type.SDP_ANSWER,data:l.sdp},{signal:t}),await r.setLocalDescription(l).catch(u=>{throw s.error("could not execute setLocalDescription",u),new g("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")}),s.trace("recipient read candidates until connected"),await hg(r,o,{direction:"recipient",signal:t,log:s})}catch(a){if(r.connectionState!=="connected")throw s.error("error while handling signaling stream from peer %a",n.remoteAddr,a),r.close(),a;s("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",n.remoteAddr,a)}let i=me(`/webrtc/p2p/${n.remoteAddr.getPeerId()}`);return s.trace("recipient connected to remote address %s",i),{remoteAddress:i}}var fae="/webrtc",hae="/p2p-circuit",pg="/webrtc-signaling/0.0.1",pae=30*1e3,mg=class{components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,Ze(1/0,this.shutdownController.signal),e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}isStarted(){return this._started}async start(){await this.components.registrar.handle(pg,e=>{this._onProtocol(e).catch(t=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,t)})},{runOnTransientConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(pg),this._started=!1}createListener(e){return new dg(this.components,{shutdownController:this.shutdownController})}[Symbol.toStringTag]="@libp2p/webrtc";[$s]=!0;filter(e){return e.filter(XN.exactMatch)}async dial(e,t){this.log.trace("dialing address: %a",e);let n=new Yf(this.init.rtcConfiguration),s=new dl(this.components,{peerConnection:n,dataChannelOptions:this.init.dataChannel}),{remoteAddress:o}=await PK({peerConnection:n,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log}),i=new pl(this.components,{peerConnection:n,timeline:{open:Date.now()},remoteAddr:o,metrics:this.metrics?.dialerEvents}),a=await t.upgrader.upgradeOutbound(i,{skipProtection:!0,skipEncryption:!0,muxerFactory:s});return this._closeOnShutdown(n,i),a}async _onProtocol({connection:e,stream:t}){let n=AbortSignal.timeout(this.init.inboundConnectionTimeout??pae),s=new Yf(this.init.rtcConfiguration),o=new dl(this.components,{peerConnection:s,dataChannelOptions:this.init.dataChannel});try{let{remoteAddress:i}=await BK({peerConnection:s,connection:e,stream:t,signal:n,log:this.log}),a=new pl(this.components,{peerConnection:s,timeline:{open:new Date().getTime()},remoteAddr:i,metrics:this.metrics?.listenerEvents});this._closeOnShutdown(s,a),await this.components.upgrader.upgradeInbound(a,{skipEncryption:!0,skipProtection:!0,muxerFactory:o}),await t.close({signal:n})}catch(i){throw t.abort(i),i}}_closeOnShutdown(e,t){let n=()=>{t.close().catch(s=>{this.log.error("could not close WebRTCMultiaddrConnection",s)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}};function CK(r){let e=r.toString().split(fae+"/");if(e.length!==2)throw new g("webrtc protocol was not present in multiaddr",Cn.ERR_INVALID_MULTIADDR);if(!e[0].includes(hae))throw new g("p2p-circuit protocol was not present in multiaddr",Cn.ERR_INVALID_MULTIADDR);let t=me(e[0]),s=me("/"+e[1]).getPeerId();if(s==null)throw new g("destination peer id was missing",Cn.ERR_INVALID_MULTIADDR);let o=t.protos().pop();if(o===void 0)throw new g("invalid multiaddr",Cn.ERR_INVALID_MULTIADDR);return o.name!=="p2p"&&(t=t.encapsulate(`/p2p/${s}`)),{baseAddr:t,peerId:Ce(s)}}var lU=fe(J7(),1);var rU=fe(J7(),1);var Z7=Object.values(Ln).map(r=>r.decoder).reduce((r,e)=>r.or(e));function nU(r,e){let t=r.getConfiguration().certificates?.at(0);if(t==null||t.getFingerprints==null){e.log.trace("fetching fingerprint from local SDP");let s=r.localDescription;return s==null?void 0:Ele(s.sdp)}if(e.log.trace("fetching fingerprint from local certificate"),t.getFingerprints().length===0)return;let n=t.getFingerprints()[0].value;if(n==null)throw E7("","no fingerprint on local certificate");return n}var wle=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function Ele(r){return r.match(wle)?.groups?.fingerprint}function vle(r){for(let e of r.protoNames())if(e.startsWith("ip"))return e.toUpperCase();return"IP6"}function Ig(r){let t=r.stringTuples().filter(n=>n[0]===iU).map(n=>n[1])[0];if(t===void 0||t==="")throw cg(`Couldn't find a certhash component of multiaddr: ${r.toString()}`);return t}function ev(r){let e=Z7.decode(r);return rU.decode(e)}function xle(r){let e=ev(Ig(r)),t=tv(e.name),n=e.digest.reduce((o,i)=>o+i.toString(16).padStart(2,"0"),""),s=n.match(/.{1,2}/g);if(s==null)throw E7(n,r.toString());return[`${t.toUpperCase()} ${s.join(":").toUpperCase()}`,n]}function tv(r){switch(r){case"sha1":return"sha-1";case"sha2-256":return"sha-256";case"sha2-512":return"sha-512";default:throw vK(r)}}function Sle(r,e){let{host:t,port:n}=r.toOptions(),s=vle(r),[o]=xle(r);return`v=0
o=- 0 0 IN ${s} ${t}
s=-
c=IN ${s} ${t}
t=0 0
a=ice-lite
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:passive
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${o}
a=sctp-port:5000
a=max-message-size:16384
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host\r
`}function sU(r,e){return{type:"answer",sdp:Sle(r,e)}}function oU(r,e){if(r.sdp===void 0)throw Ud("Can't munge a missing SDP");return r.sdp=r.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+`
`).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+`
`),r}var aU=Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),cU=r=>[...Array(r)].map(()=>aU.at(Math.floor(Math.random()*aU.length))).join("");var Ale=1e4,bQe=ve("webrtc-direct").code,iU=ve("certhash").code,Tg=class{log;metrics;components;init;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}async dial(e,t){let n=await this._connect(e,t);return this.log("dialing address: %a",e),n}createListener(e){throw EK("WebRTCTransport.createListener")}filter(e){return e.filter(jN.exactMatch)}[Symbol.toStringTag]="@libp2p/webrtc-direct";[$s]=!0;async _connect(e,t){let n=new AbortController,s=n.signal,o=e.getPeerId();if(o===null)throw cg("we need to have the remote's PeerId");let i=Ce(o),a=ev(Ig(e)),c=await Yf.generateCertificate({name:"ECDSA",namedCurve:"P-256",hash:tv(a.name)}),l=new Yf({certificates:[c]});try{let u=new Promise((_,D)=>{let K=l.createDataChannel("",{negotiated:!0,id:0}),O=setTimeout(()=>{let F=`Data channel was never opened: state: ${K.readyState}`;this.log.error(F),this.metrics?.dialerEvents.increment({open_error:!0}),D(w7("data",F))},Ale);K.onopen=F=>{clearTimeout(O),_(K)},K.onerror=F=>{clearTimeout(O);let ce=`Error opening a data channel for handshaking: ${F.target?.toString()??"not specified"}`;this.log.error(ce),this.metrics?.dialerEvents.increment({unknown_error:!0}),D(w7("data",ce))}}),f="libp2p+webrtc+v1/"+cU(32),h=await l.createOffer(),d=oU(h,f);await l.setLocalDescription(d);let p=sU(e,f);await l.setRemoteDescription(p);let m=await u,y=this.components.peerId,b=this.generateNoisePrologue(l,a.code,e),w=Nu({prologueBytes:b})(this.components),E=Wf({channel:m,direction:"inbound",logger:this.components.logger,...this.init.dataChannel??{}}),x={...E,sink:E.sink.bind(E),source:async function*(){for await(let _ of E.source)for(let D of _)yield D}()},v=new pl(this.components,{peerConnection:l,remoteAddr:e,timeline:{open:Date.now()},metrics:this.metrics?.dialerEvents}),S=Fd?"iceconnectionstatechange":"connectionstatechange";l.addEventListener(S,()=>{switch(l.connectionState){case"failed":case"disconnected":case"closed":v.close().catch(_=>{this.log.error("error closing connection",_)}).finally(()=>{n.abort()});break;default:break}},{signal:s}),this.metrics?.dialerEvents.increment({peer_connection:!0});let A=new dl(this.components,{peerConnection:l,metrics:this.metrics?.dialerEvents,dataChannelOptions:this.init.dataChannel});return await w.secureInbound(y,x,i),await t.upgrader.upgradeOutbound(v,{skipProtection:!0,skipEncryption:!0,muxerFactory:A})}catch(u){throw l.close(),u}}generateNoisePrologue(e,t,n){if(e.getConfiguration().certificates?.length===0)throw Ud("no local certificate");let s=nU(e,{log:this.log});if(s==null)throw Ud("no local fingerprint found");let o=s.trim().toLowerCase().replaceAll(":",""),i=R(o,"hex"),a=lU.encode(i,t),c=Z7.decode(Ig(n)),l=R("libp2p-webrtc-noise:");return le([l,a,c])}};function uU(r){return e=>new Tg(e,r)}function fU(r){return e=>new mg(e,r)}function hU(r){let e;try{e=ve("sni").code}catch{return null}for(let[t,n]of r)if(t===e&&n!==void 0)return n;return null}function pU(r){return r.some(([e,t])=>e===ve("tls").code)}function Bn(r,e,t){let n=dU[ve(r).name];if(n===void 0)throw new Error(`Can't interpret protocol ${ve(r).name}`);let s=n(e,t);return r===ve("ip6").code?`[${s}]`:s}var dU={ip4:(r,e)=>r,ip6:(r,e)=>e.length===0?r:`[${r}]`,tcp:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`tcp://${Bn(t[0],t[1]??"",e)}:${r}`},udp:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`udp://${Bn(t[0],t[1]??"",e)}:${r}`},dnsaddr:(r,e)=>r,dns4:(r,e)=>r,dns6:(r,e)=>r,dns:(r,e)=>r,ipfs:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${Bn(t[0],t[1]??"",e)}/ipfs/${r}`},p2p:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${Bn(t[0],t[1]??"",e)}/p2p/${r}`},http:(r,e)=>{let t=pU(e),n=hU(e);if(t&&n!==null)return`https://${n}`;let s=t?"https://":"http://",o=e.pop();if(o===void 0)throw new Error("Unexpected end of multiaddr");let i=Bn(o[0],o[1]??"",e);return i=i.replace("tcp://",""),`${s}${i}`},tls:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return Bn(t[0],t[1]??"",e)},sni:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return Bn(t[0],t[1]??"",e)},https:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");let n=Bn(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{let t=pU(e),n=hU(e);if(t&&n!==null)return`wss://${n}`;let s=t?"wss://":"ws://",o=e.pop();if(o===void 0)throw new Error("Unexpected end of multiaddr");let i=Bn(o[0],o[1]??"",e);return i=i.replace("tcp://",""),`${s}${i}`},wss:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");let n=Bn(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`wss://${n}`},"p2p-websocket-star":(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${Bn(t[0],t[1]??"",e)}/p2p-websocket-star`},"p2p-webrtc-star":(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${Bn(t[0],t[1]??"",e)}/p2p-webrtc-star`},"p2p-webrtc-direct":(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${Bn(t[0],t[1]??"",e)}/p2p-webrtc-direct`}};function mU(r,e){let n=me(r).stringTuples(),s=n.pop();if(s===void 0)throw new Error("Unexpected end of multiaddr");let o=ve(s[0]),i=dU[o.name];if(i==null)throw new Error(`No interpreter found for ${o.name}`);let a=i(s[1]??"",n);return e?.assumeHttp!==!1&&s[0]===ve("tcp").code&&(a=a.replace("tcp://","http://"),(s[1]==="443"||s[1]==="80")&&(s[1]==="443"&&(a=a.replace("http://","https://")),a=a.substring(0,a.lastIndexOf(":")))),a}var yU=async r=>{if(r.readyState>=2)throw new Error("socket closed");r.readyState!==1&&await new Promise((e,t)=>{function n(){r.removeEventListener("open",s),r.removeEventListener("error",o)}function s(){n(),e()}function o(i){n(),t(i.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",s),r.addEventListener("error",o)})};var gU=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(let s of n){try{await yU(r)}catch(o){if(o.message==="socket closed")break;throw o}if(r.readyState===r.CLOSING||r.readyState===r.CLOSED)break;r.send(s)}e.closeOnEnd!=null&&r.readyState<=1&&await new Promise((s,o)=>{r.addEventListener("close",i=>{if(i.wasClean||i.code===1006)s();else{let a=Object.assign(new Error("ws error"),{event:i});o(a)}}),setTimeout(()=>{r.close()})})});var vU=fe(wU(),1);function EU(r){return r instanceof ArrayBuffer||r?.constructor?.name==="ArrayBuffer"&&typeof r?.byteLength=="number"}var xU=r=>{r.binaryType="arraybuffer";let e=async()=>{await new Promise((o,i)=>{if(n){o();return}if(s!=null){i(s);return}let a=u=>{r.removeEventListener("open",c),r.removeEventListener("error",l),u()},c=()=>{a(o)},l=u=>{a(()=>{i(u.error??new Error(`connect ECONNREFUSED ${r.url}`))})};r.addEventListener("open",c),r.addEventListener("error",l)})},t=async function*(){let o=new vU.EventIterator(({push:i,stop:a,fail:c})=>{let l=f=>{let h=null;typeof f.data=="string"&&(h=R(f.data)),EU(f.data)&&(h=new Uint8Array(f.data)),f.data instanceof Uint8Array&&(h=f.data),h!=null&&i(h)},u=f=>{c(f.error??new Error("Socket error"))};return r.addEventListener("message",l),r.addEventListener("error",u),r.addEventListener("close",a),()=>{r.removeEventListener("message",l),r.removeEventListener("error",u),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(let i of o)yield EU(i)?new Uint8Array(i):i}(),n=r.readyState===1,s;return r.addEventListener("open",()=>{n=!0,s=null}),r.addEventListener("close",()=>{n=!1,s=null}),r.addEventListener("error",o=>{n||(s=o.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})};var SU=(r,e)=>{e=e??{};let t=xU(r),n=e.remoteAddress,s=e.remotePort;if(r.url!=null)try{let i=new URL(r.url);n=i.hostname,s=parseInt(i.port,10)}catch{}if(n==null||s==null)throw new Error("Remote connection did not have address and/or port");return{sink:gU(r,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(i=>{r.addEventListener("close",()=>{i()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:s,socket:r}};var _U=WebSocket;var Ile={"http:":"ws:","https:":"wss:"},AU="ws:",RU=(r,e)=>{if(r.startsWith("//")&&(r=`${e?.protocol??AU}${r}`),r.startsWith("/")&&e!=null){let n=e.protocol??AU,s=e.host,o=e.port!=null&&s?.endsWith(`:${e.port}`)!==!0?`:${e.port}`:"";r=`${n}//${s}${o}${r}`}let t=new URL(r);for(let[n,s]of Object.entries(Ile))t.protocol===n&&(t.protocol=s);return t};function IU(r,e){let t=typeof window>"u"?void 0:window.location;e=e??{};let n=RU(r,t),s=new _U(n.toString(),e.websocket);return SU(s,e)}function DU(r){return r.filter(e=>{if(e.protoCodes().includes(290))return!1;let t=e.decapsulateCode(421);return df.matches(t)||Xc.matches(t)})}function PU(r){return r.filter(e=>{if(e.protoCodes().includes(290))return!1;let t=e.decapsulateCode(421);return Xc.matches(t)})}function CU(){throw new Error("WebSocket Servers can not be created in the browser!")}function BU(r,e,t){let n=t.logger.forComponent("libp2p:websockets:maconn"),s={log:n,async sink(o){try{await r.sink(async function*(){for await(let i of o)i instanceof Uint8Array?yield i:yield i.subarray()}())}catch(i){i.type!=="aborted"&&n.error(i)}},source:r.source,remoteAddr:e,timeline:{open:Date.now()},async close(o={}){let i=Date.now();if(o.signal==null){let c=AbortSignal.timeout(500);o={...o,signal:c}}let a=()=>{let{host:c,port:l}=s.remoteAddr.toOptions();n("timeout closing stream to %s:%s after %dms, destroying it manually",c,l,Date.now()-i),this.abort(new g("Socket close timeout","ERR_SOCKET_CLOSE_TIMEOUT"))};o.signal?.addEventListener("abort",a);try{await r.close()}catch(c){n.error("error closing WebSocket gracefully",c),this.abort(c)}finally{o.signal?.removeEventListener("abort",a),s.timeline.close=Date.now()}},abort(o){let{host:i,port:a}=s.remoteAddr.toOptions();n("timeout closing stream to %s:%s due to error",i,a,o),r.destroy(),s.timeline.close=Date.now()}};return r.socket.addEventListener("close",()=>{s.timeline.close==null&&(s.timeline.close=Date.now())},{once:!0}),s}var sv=class{log;init;logger;constructor(e,t){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.init=t}[Symbol.toStringTag]="@libp2p/websockets";[$s]=!0;async dial(e,t){this.log("dialing %s",e),t=t??{};let n=await this._connect(e,t),s=BU(n,e,{logger:this.logger});this.log("new outbound connection %s",s.remoteAddr);let o=await t.upgrader.upgradeOutbound(s);return this.log("outbound connection %s upgraded",s.remoteAddr),o}async _connect(e,t){if(t?.signal?.aborted===!0)throw new ps;let n=e.toOptions();this.log("dialing %s:%s",n.host,n.port);let s=xe(),o=IU(mU(e),this.init);if(o.socket.addEventListener("error",()=>{let c=new g(`Could not connect to ${e.toString()}`,"ERR_CONNECTION_FAILED");this.log.error("connection error:",c),s.reject(c)}),t.signal==null)return await Promise.race([o.connected(),s.promise]),this.log("connected %s",e),o;let i,a=new Promise((c,l)=>{if(i=()=>{l(new ps),o.close().catch(u=>{this.log.error("error closing raw socket",u)})},t?.signal?.aborted===!0){i();return}t?.signal?.addEventListener("abort",i)});try{await Promise.race([a,s.promise,o.connected()])}finally{i!=null&&t?.signal?.removeEventListener("abort",i)}return this.log("connected %s",e),o}createListener(e){return CU({logger:this.logger},{...this.init,...e})}filter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):gy||by?PU(e):DU(e)}};function NU(r={}){return e=>new sv(e,r)}async function ov(r,e,t,n,s,o){let i=o.forComponent(`libp2p:webtransport:stream:${t}:${e}`),a=r.writable.getWriter(),c=r.readable.getReader();await a.ready;function l(){let p=n.findIndex(m=>m===d);p!==-1&&(n.splice(p,1),d.timeline.close=Date.now(),s?.(d))}let u=!1,f=!1;(async function(){let p=await a.closed.catch(m=>m);if(p!=null){let m=p.message;m.includes("aborted by the remote server")||m.includes("STOP_SENDING")||i.error(`WebTransport writer closed unexpectedly: streamId=${e} err=${p.message}`)}u=!0,u&&f&&l()})().catch(()=>{i.error("WebTransport failed to cleanup closed stream")}),async function(){let p=await c.closed.catch(m=>m);p!=null&&i.error(`WebTransport reader closed unexpectedly: streamId=${e} err=${p.message}`),f=!0,u&&f&&l()}().catch(()=>{i.error("WebTransport failed to cleanup closed stream")});let h=!1,d={id:e,status:"open",writeStatus:"ready",readStatus:"ready",abort(p){u||(a.abort(p).catch(m=>{i.error("could not abort stream",m)}),u=!0),f=!0,this.status="aborted",this.writeStatus="closed",this.readStatus="closed",this.timeline.reset=this.timeline.close=this.timeline.closeRead=this.timeline.closeWrite=Date.now(),l()},async close(p){this.status="closing",await Promise.all([d.closeRead(p),d.closeWrite(p)]),l(),this.status="closed",this.timeline.close=Date.now()},async closeRead(p){if(!f){this.readStatus="closing";try{await c.cancel()}catch(m){m.toString().includes("RESET_STREAM")===!0&&(u=!0)}this.timeline.closeRead=Date.now(),this.readStatus="closed",f=!0}u&&l()},async closeWrite(p){if(!u){u=!0,this.writeStatus="closing";try{await a.close()}catch(m){m.toString().includes("RESET_STREAM")===!0&&(f=!0)}this.timeline.closeWrite=Date.now(),this.writeStatus="closed"}f&&l()},direction:t,timeline:{open:Date.now()},metadata:{},source:async function*(){for(;;){let p=await c.read();if(p.done){f=!0,u&&l();return}yield new ke(p.value)}}(),sink:async function(p){if(h)throw new Error("sink already called on stream");h=!0;try{this.writeStatus="writing";for await(let m of p)if(m instanceof Uint8Array)await a.write(m);else for(let y of m)await a.write(y);this.writeStatus="done"}finally{this.timeline.closeWrite=Date.now(),this.writeStatus="closed",await d.closeWrite()}},log:i};return d}function iv(){return{source:{[Symbol.asyncIterator](){return{async next(){return new Promise(()=>{})}}}},sink:async r=>new Promise(()=>{})}}function LU(r,e){return e.filter(n=>!!r.find(s=>q(n,s))).length===e.length}var Dle=Object.values(Ln).map(r=>r.decoder).reduce((r,e)=>r.or(e));function Ple(r){return cs.decode(Dle.decode(r))}function OU(r){if(!py.matches(r))throw new g("Invalid multiaddr, was not a WebTransport address","ERR_INVALID_MULTIADDR");let e=r.stringTuples(),t=e.filter(([i,a])=>i===ve("certhash").code).map(([i,a])=>Ple(a??"")),n=e.filter(([i,a])=>i===ve("p2p").code).map(([i,a])=>Ce(a??""))[0],s=r.toOptions(),o=s.host;return s.family===6&&o?.includes(":")&&(o=`[${o}]`),{url:`https://${o}:${s.port}`,certhashes:t,remotePeer:n}}var av=class{log;components;config;metrics;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:webtransport"),this.components=e,this.config={maxInboundStreams:t.maxInboundStreams??1e3},e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webtransport_dialer_events_total",{label:"event",help:"Total count of WebTransport dialer events by type"})})}[Symbol.toStringTag]="@libp2p/webtransport";[$s]=!0;async dial(e,t){t?.signal?.throwIfAborted(),this.log("dialing %s",e);let n=this.components.peerId;if(n===void 0)throw new Error("Need a local peerid");t=t??{};let{url:s,certhashes:o,remotePeer:i}=OU(e);if(i==null)throw new Error("Need a target peerid");if(o.length===0)throw new Error("Expected multiaddr to contain certhashes");let a,c,l=()=>{},u=!1,f=!1,h=!1;try{this.metrics?.dialerEvents.increment({pending:!0});let d=new WebTransport(`${s}/.well-known/libp2p-webtransport?type=noise`,{serverCertificateHashes:o.map(p=>({algorithm:"sha-256",value:p.digest}))});if(l=p=>{if(!u)try{this.metrics?.dialerEvents.increment({[p]:!0}),d.close()}catch(m){this.log.error("error closing wt session",m)}finally{c!=null&&(c.timeline.close=Date.now()),u=!0}},a=()=>{l(f?"noise_timeout":"ready_timeout")},t.signal?.addEventListener("abort",a,{once:!0}),await Promise.race([d.closed,d.ready]),f=!0,this.metrics?.dialerEvents.increment({ready:!0}),d.closed.catch(p=>{this.log.error("error on remote wt session close",p)}).finally(()=>{l("remote_close")}),!await this.authenticateWebTransport(d,n,i,o))throw new Error("Failed to authenticate webtransport");return this.metrics?.dialerEvents.increment({open:!0}),c={close:async()=>{this.log("Closing webtransport"),l("close")},abort:p=>{this.log("aborting webtransport due to passed err",p),l("abort")},remoteAddr:e,timeline:{open:Date.now()},log:this.components.logger.forComponent("libp2p:webtransport:maconn"),...iv()},h=!0,await t.upgrader.upgradeOutbound(c,{skipEncryption:!0,muxerFactory:this.webtransportMuxer(d),skipProtection:!0})}catch(d){throw this.log.error("caught wt session err",d),l(h?"upgrade_error":f?"noise_error":"ready_error"),d}finally{a!=null&&t.signal?.removeEventListener("abort",a)}}async authenticateWebTransport(e,t,n,s){let o=await e.createBidirectionalStream(),i=o.writable.getWriter(),a=o.readable.getReader();await i.ready;let c={source:async function*(){for(;;){let f=await a.read();if(f.value!=null&&(yield f.value),f.done)break}}(),sink:async function(f){for await(let h of f)h instanceof Uint8Array?await i.write(h):await i.write(h.subarray())}},l=Nu()(this.components),{remoteExtensions:u}=await l.secureOutbound(t,c,n);if(i.close().catch(f=>{this.log.error(`Failed to close authentication stream writer: ${f.message}`)}),a.cancel().catch(f=>{this.log.error(`Failed to close authentication stream reader: ${f.message}`)}),!LU(u?.webtransportCerthashes??[],s.map(f=>f.bytes)))throw new Error("Our certhashes are not a subset of the remote's reported certhashes");return!0}webtransportMuxer(e){let t=0,n=this.config,s=this;return{protocol:"webtransport",createStreamMuxer:o=>{typeof o=="function"&&(o={onIncomingStream:o});let i=[];return async function(){let c=e.incomingBidirectionalStreams.getReader();for(;;){let{done:l,value:u}=await c.read();if(l)break;if(i.length>=n.maxInboundStreams)u.writable.close().catch(f=>{s.log.error(`Failed to close inbound stream that crossed our maxInboundStream limit: ${f.message}`)}),u.readable.cancel().catch(f=>{s.log.error(`Failed to close inbound stream that crossed our maxInboundStream limit: ${f.message}`)});else{let f=await ov(u,String(t++),"inbound",i,o?.onStreamEnd,s.components.logger);i.push(f),o?.onIncomingStream?.(f)}}}().catch(()=>{this.log.error("WebTransport failed to receive incoming stream")}),{protocol:"webtransport",streams:i,newStream:async c=>{let l=await e.createBidirectionalStream(),u=await ov(l,String(t++),o?.direction??"outbound",i,o?.onStreamEnd,s.components.logger);return i.push(u),u},close:async c=>{this.log("Closing webtransport muxer"),await Promise.all(i.map(async l=>l.close(c)))},abort:c=>{this.log("Aborting webtransport muxer with err:",c);for(let l of i)l.abort(c)},...iv()}}}}createListener(e){throw new Error("Webtransport servers are not supported in Node or the browser")}filter(e){return e.filter(py.exactMatch)}};function KU(r={}){return e=>new av(e,r)}var dn=fe(No(),1);var $U=fe(_m(),1);var MU="ERR_IPNS_EXPIRED_RECORD",Pg="ERR_UNRECOGNIZED_VALIDITY";var Bi="ERR_SIGNATURE_VERIFICATION",UU="ERR_UNRECOGNIZED_FORMAT";var cv="ERR_UNDEFINED_PARAMETER",FU="ERR_INVALID_RECORD_DATA",VU="ERR_INVALID_VALUE",qU="ERR_INVALID_EMBEDDED_KEY";var HU="ERR_RECORD_TOO_LARGE";var Ni;(function(r){let e;(function(s){s.EOL="EOL"})(e=r.ValidityType||(r.ValidityType={}));let t;(function(s){s[s.EOL=0]="EOL"})(t||(t={})),function(s){s.codec=()=>Te(t)}(e=r.ValidityType||(r.ValidityType={}));let n;r.codec=()=>(n==null&&(n=ee((s,o,i={})=>{i.lengthDelimited!==!1&&o.fork(),s.value!=null&&(o.uint32(10),o.bytes(s.value)),s.signatureV1!=null&&(o.uint32(18),o.bytes(s.signatureV1)),s.validityType!=null&&(o.uint32(24),r.ValidityType.codec().encode(s.validityType,o)),s.validity!=null&&(o.uint32(34),o.bytes(s.validity)),s.sequence!=null&&(o.uint32(40),o.uint64(s.sequence)),s.ttl!=null&&(o.uint32(48),o.uint64(s.ttl)),s.pubKey!=null&&(o.uint32(58),o.bytes(s.pubKey)),s.signatureV2!=null&&(o.uint32(66),o.bytes(s.signatureV2)),s.data!=null&&(o.uint32(74),o.bytes(s.data)),i.lengthDelimited!==!1&&o.ldelim()},(s,o)=>{let i={},a=o==null?s.len:s.pos+o;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:i.value=s.bytes();break;case 2:i.signatureV1=s.bytes();break;case 3:i.validityType=r.ValidityType.codec().decode(s);break;case 4:i.validity=s.bytes();break;case 5:i.sequence=s.uint64();break;case 6:i.ttl=s.uint64();break;case 7:i.pubKey=s.bytes();break;case 8:i.signatureV2=s.bytes();break;case 9:i.data=s.bytes();break;default:s.skipType(c&7);break}}return i})),n),r.encode=s=>Z(s,r.codec()),r.decode=s=>J(s,r.codec())})(Ni||(Ni={}));var lv=ls("ipns:utils"),Cle=R("/ipns/"),Ble=114;function Nle(r){let e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");let n=parseInt(t[1],10),s=parseInt(t[2],10)-1,o=parseInt(t[3],10),i=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].padEnd(6,"0").slice(0,3),10);return new Date(Date.UTC(n,s,o,i,a,c,l))}var GU=async(r,e)=>{if(e==null||r==null){let n=new Error("one or more of the provided parameters are not defined");throw lv.error(n),(0,dn.default)(n,cv)}let t;if(e.pubKey!=null){try{t=ma(e.pubKey)}catch(s){throw lv.error(s),s}if(!(await xr(e.pubKey)).equals(r))throw(0,dn.default)(new Error("Embedded public key did not match PeerID"),qU)}else r.publicKey!=null&&(t=ma(r.publicKey));if(t!=null)return t;throw(0,dn.default)(new Error("no public key is available"),cv)};var WU=r=>{let e=R("ipns-signature:");return le([e,r])};function jd(r){let e=Ni.decode(r);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw(0,dn.default)(new Error("missing data or signatureV2"),Bi);let t=jU(e.data),n=Lle(t.Value),s;try{s=$U.default.fromDate(Nle(T(t.Validity)))}catch{throw lv.error("unrecognized validity format (not an rfc3339 format)"),(0,dn.default)(new Error("unrecognized validity format (not an rfc3339 format)"),UU)}if(e.value!=null&&e.signatureV1!=null)return Ole(e),{value:n,validityType:Ni.ValidityType.EOL,validity:s,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:n,validityType:Ni.ValidityType.EOL,validity:s,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}var YU=r=>dt(r.slice(Cle.length));var jU=r=>{let e=sn(r);if(e.ValidityType===0)e.ValidityType=Ni.ValidityType.EOL;else throw(0,dn.default)(new Error("Unknown validity type"),Pg);return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e},Lle=r=>{if(r!=null){if(Ml(r))return`/ipns/${r.toCID().toString(Ui)}`;if(r instanceof Uint8Array){let n=T(r);n.startsWith("/")&&(r=n)}let e=r.toString().trim();if(e.startsWith("/")&&e.length>1)return e;let t=Ve.asCID(r);if(t!=null)return t.code===Ble?`/ipns/${t.toString(Ui)}`:`/ipfs/${t.toV1().toString()}`;try{return r instanceof Uint8Array?`/ipfs/${Ve.decode(r).toV1().toString()}`:`/ipfs/${Ve.parse(e).toV1().toString()}`}catch{}}throw(0,dn.default)(new Error("Value must be a valid content path starting with /"),VU)},Ole=r=>{if(r.data==null)throw(0,dn.default)(new Error("Record data is missing"),FU);let e=jU(r.data);if(!q(e.Value,r.value??new Uint8Array(0)))throw(0,dn.default)(new Error('Field "value" did not match between protobuf and CBOR'),Bi);if(!q(e.Validity,r.validity??new Uint8Array(0)))throw(0,dn.default)(new Error('Field "validity" did not match between protobuf and CBOR'),Bi);if(e.ValidityType!==r.validityType)throw(0,dn.default)(new Error('Field "validityType" did not match between protobuf and CBOR'),Bi);if(e.Sequence!==r.sequence)throw(0,dn.default)(new Error('Field "sequence" did not match between protobuf and CBOR'),Bi);if(e.TTL!==r.ttl)throw(0,dn.default)(new Error('Field "ttl" did not match between protobuf and CBOR'),Bi)};function QU(r,e){let t=e.map((n,s)=>({record:jd(n),index:s}));return t.sort((n,s)=>{let o=n.record.sequence,i=s.record.sequence;if(o>i)return-1;if(o<i)return 1;let a=n.record.validity.toDate(),c=s.record.validity.toDate();return a.getTime()>c.getTime()?-1:a.getTime()<c.getTime()?1:0}),t[0].index}var Qd=fe(No(),1);var Cg=ls("ipns:validator"),Kle=1024*10,Mle=async(r,e)=>{let t=jd(e),n;try{let s=WU(t.data);n=await r.verify(s,t.signatureV2)}catch{n=!1}if(!n)throw Cg.error("record signature verification failed"),(0,Qd.default)(new Error("record signature verification failed"),Bi);if(t.validityType===Ni.ValidityType.EOL){if(t.validity.toDate().getTime()<Date.now())throw Cg.error("record has expired"),(0,Qd.default)(new Error("record has expired"),MU)}else if(t.validityType!=null)throw Cg.error("unrecognized validity type"),(0,Qd.default)(new Error("unrecognized validity type"),Pg);Cg("ipns record for %b is valid",t.value)};async function XU(r,e){if(e.byteLength>Kle)throw(0,Qd.default)(new Error("record too large"),HU);let t=YU(r),n=jd(e),s=await GU(t,n);await Mle(s,e)}var Bg="1.1.2",Ng="libp2p";var ZU="3.0.1",eF="helia";var tF={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function Lg(r={}){return{peerId:r.peerId,addresses:{listen:["/webrtc"]},transports:[aE({discoverRelays:1}),fU(),uU(),KU(),NU()],connectionEncryption:[Nu()],streamMuxers:[gP(),fK()],peerDiscovery:[oN(tF)],services:{autoNAT:WB(),dcutr:eL(),delegatedRouting:()=>fB("https://delegated-ipfs.dev"),dht:mO({clientMode:!0,validators:{ipns:XU},selectors:{ipns:QU}}),identify:pL({agentVersion:`${eF}/${ZU} ${Ng}/${Bg} UserAgent=${globalThis.navigator.userAgent}`}),keychain:rg(r.keychain),ping:wK(),pubsub:SD()}}}var pv={};V(pv,{Ed25519PrivateKey:()=>Ya,Ed25519PublicKey:()=>ih,generateKeyPair:()=>qle,generateKeyPairFromSeed:()=>cF,unmarshalEd25519PrivateKey:()=>Fle,unmarshalEd25519PublicKey:()=>Vle});function is(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var sh=32,Li=64,Og=32;function rF(){let r=De.utils.randomPrivateKey(),e=De.getPublicKey(r);return{privateKey:iF(r,e),publicKey:e}}function nF(r){if(r.length!==Og)throw new TypeError('"seed" must be 32 bytes in length.');if(!(r instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');let e=r,t=De.getPublicKey(e);return{privateKey:iF(e,t),publicKey:t}}function sF(r,e){let t=r.subarray(0,Og);return De.sign(e instanceof Uint8Array?e:e.subarray(),t)}function oF(r,e,t){return De.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}function iF(r,e){let t=new Uint8Array(Li);for(let n=0;n<Og;n++)t[n]=r[n],t[Og+n]=e[n];return t}var Pr={get(r=globalThis){let e=r.crypto;if(e==null||e.subtle==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}};var uv={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function fv(r){let e=r?.algorithm??"AES-GCM",t=r?.keyLength??16,n=r?.nonceLength??12,s=r?.digest??"SHA-256",o=r?.saltLength??16,i=r?.iterations??32767,a=Pr.get();t*=8;async function c(f,h){let d=a.getRandomValues(new Uint8Array(o)),p=a.getRandomValues(new Uint8Array(n)),m={name:e,iv:p};typeof h=="string"&&(h=R(h));let y;if(h.length===0){y=await a.subtle.importKey("jwk",uv,{name:"AES-GCM"},!0,["encrypt"]);try{let w={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}catch{y=await a.subtle.importKey("jwk",uv,{name:"AES-GCM"},!0,["encrypt"])}}else{let w={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}let b=await a.subtle.encrypt(m,y,f);return le([d,m.iv,new Uint8Array(b)])}async function l(f,h){let d=f.subarray(0,o),p=f.subarray(o,o+n),m=f.subarray(o+n),y={name:e,iv:p};typeof h=="string"&&(h=R(h));let b;if(h.length===0)try{let E={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},x=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(E,x,{name:e,length:t},!0,["decrypt"])}catch{b=await a.subtle.importKey("jwk",uv,{name:"AES-GCM"},!0,["decrypt"])}else{let E={name:"PBKDF2",salt:d,iterations:i,hash:{name:s}},x=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(E,x,{name:e,length:t},!0,["decrypt"])}let w=await a.subtle.decrypt(y,b,m);return new Uint8Array(w)}return{encrypt:c,decrypt:l}}async function oh(r,e){let n=await fv().encrypt(r,e);return qe.encode(n)}var Xt;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.Secp256k1="Secp256k1"})(Xt||(Xt={}));var hv;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.Secp256k1=2]="Secp256k1"})(hv||(hv={}));(function(r){r.codec=()=>Te(hv)})(Xt||(Xt={}));var Do;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Xt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=Xt.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(Do||(Do={}));var Oi;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Xt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.Type=Xt.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(Oi||(Oi={}));var ih=class{_key;constructor(e){this._key=ah(e,sh)}verify(e,t){return oF(this._key,t,e)}marshal(){return this._key}get bytes(){return Do.encode({Type:Xt.Ed25519,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return is(e)?e.then(({bytes:t})=>t):e.bytes}},Ya=class{_key;_publicKey;constructor(e,t){this._key=ah(e,Li),this._publicKey=ah(t,sh)}sign(e){return sF(this._key,e)}get public(){return new ih(this._publicKey)}marshal(){return this._key}get bytes(){return Oi.encode({Type:Xt.Ed25519,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}async hash(){let e=$.digest(this.bytes),t;return is(e)?{bytes:t}=await e:t=e.bytes,t}async id(){let e=Lt.digest(this.public.bytes);return Fe.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if(t==="libp2p-key")return oh(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function Fle(r){if(r.length>Li){r=ah(r,Li+sh);let n=r.subarray(0,Li),s=r.subarray(Li,r.length);return new Ya(n,s)}r=ah(r,Li);let e=r.subarray(0,Li),t=r.subarray(sh);return new Ya(e,t)}function Vle(r){return r=ah(r,sh),new ih(r)}async function qle(){let{privateKey:r,publicKey:e}=rF();return new Ya(r,e)}async function cF(r){let{privateKey:e,publicKey:t}=nF(r);return new Ya(e,t)}function ah(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new g(`Key must be a Uint8Array of length ${e}, got ${r.length}`,"ERR_INVALID_KEY_TYPE");return r}var Hle={"P-256":256,"P-384":384,"P-521":521},zle=Object.keys(Hle),UJe=zle.join(" / ");var bv={};V(bv,{MAX_RSA_KEY_SIZE:()=>lh,RsaPrivateKey:()=>bl,RsaPublicKey:()=>ch,fromJwk:()=>rue,generateKeyPair:()=>nue,unmarshalRsaPrivateKey:()=>yv,unmarshalRsaPublicKey:()=>tue});function gl(r){if(isNaN(r)||r<=0)throw new g("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return zt(r)}var ja={};V(ja,{exportToPem:()=>Xle,importFromPem:()=>uF,jwkToPkcs1:()=>Wle,jwkToPkix:()=>jle,pkcs1ToJwk:()=>Gle,pkixToJwk:()=>Yle});function Gle(r){let{result:e}=tt(r),t=e.valueBlock.value;return{n:T(Po(t[1].toBigInt()),"base64url"),e:T(Po(t[2].toBigInt()),"base64url"),d:T(Po(t[3].toBigInt()),"base64url"),p:T(Po(t[4].toBigInt()),"base64url"),q:T(Po(t[5].toBigInt()),"base64url"),dp:T(Po(t[6].toBigInt()),"base64url"),dq:T(Po(t[7].toBigInt()),"base64url"),qi:T(Po(t[8].toBigInt()),"base64url"),kty:"RSA",alg:"RS256"}}function Wle(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new g("JWK was missing components","ERR_INVALID_PARAMETERS");let t=new re({value:[new X({value:0}),X.fromBigInt(Co(R(r.n,"base64url"))),X.fromBigInt(Co(R(r.e,"base64url"))),X.fromBigInt(Co(R(r.d,"base64url"))),X.fromBigInt(Co(R(r.p,"base64url"))),X.fromBigInt(Co(R(r.q,"base64url"))),X.fromBigInt(Co(R(r.dp,"base64url"))),X.fromBigInt(Co(R(r.dq,"base64url"))),X.fromBigInt(Co(R(r.qi,"base64url")))]}).toBER();return new Uint8Array(t,0,t.byteLength)}function Yle(r){let{result:e}=tt(r),t=e.valueBlock.value[1].valueBlock.value[0].valueBlock.value;return{kty:"RSA",n:T(Po(t[0].toBigInt()),"base64url"),e:T(Po(t[1].toBigInt()),"base64url")}}function jle(r){if(r.n==null||r.e==null)throw new g("JWK was missing components","ERR_INVALID_PARAMETERS");let t=new re({value:[new re({value:[new Le({value:"1.2.840.113549.1.1.1"}),new yt]}),new Hr({valueHex:new re({value:[X.fromBigInt(Co(R(r.n,"base64url"))),X.fromBigInt(Co(R(r.e,"base64url")))]}).toBER()})]}).toBER();return new Uint8Array(t,0,t.byteLength)}function Po(r){let e=r.toString(16);e.length%2>0&&(e=`0${e}`);let t=e.length/2,n=new Uint8Array(t),s=0,o=0;for(;s<t;)n[s]=parseInt(e.slice(o,o+2),16),s+=1,o+=2;return n}function Co(r){let e=[];return r.forEach(function(t){let n=t.toString(16);n.length%2>0&&(n=`0${n}`),e.push(n)}),BigInt("0x"+e.join(""))}var Qle=16,dv=32,mv=1e4;async function Xle(r,e){let t=Pr.get(),s=new re({value:[new X({value:0}),new re({value:[new Le({value:"1.2.840.113549.1.1.1"}),new yt]}),new nt({valueHex:r.marshal()})]}).toBER(),o=new Uint8Array(s,0,s.byteLength),i=gl(Qle),a=await Xr(er,e,i,{c:mv,dkLen:dv}),c=gl(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,o),f=new re({value:[new nt({valueHex:i}),new X({value:mv}),new X({value:dv}),new re({value:[new Le({value:"1.2.840.113549.2.11"}),new yt]})]}),h=new re({value:[new Le({value:"1.2.840.113549.1.5.13"}),new re({value:[new re({value:[new Le({value:"1.2.840.113549.1.5.12"}),f]}),new re({value:[new Le({value:"2.16.840.1.101.3.4.1.42"}),new nt({valueHex:c})]})]})]}),p=new re({value:[h,new nt({valueHex:u})]}).toBER(),m=new Uint8Array(p,0,p.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...T(m,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function uF(r,e){let t=Pr.get(),n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){let s=R(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=tt(s),{iv:i,salt:a,iterations:c,keySize:l,cipherText:u}=Jle(o),f=await Xr(er,e,a,{c,dkLen:l}),h=await t.subtle.importKey("raw",f,"AES-CBC",!1,["decrypt"]),d=Xd(await t.subtle.decrypt({name:"AES-CBC",iv:i},h,u)),{result:p}=tt(d);n=lF(p)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){let s=R(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=tt(s);n=lF(o)}else throw new g("Could not parse private key from PEM data","ERR_INVALID_PARAMETERS");return yv(n)}function Jle(r){let e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new g("Only pkcs5PBES2 encrypted private keys are supported","ERR_INVALID_PARAMS");let n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new g("Only pkcs5PBKDF2 key derivation functions are supported","ERR_INVALID_PARAMS");let o=n.valueBlock.value[1],i=Xd(o.valueBlock.value[0].getValue()),a=mv,c=dv;if(o.valueBlock.value.length===3)a=Number(o.valueBlock.value[1].toBigInt()),c=Number(o.valueBlock.value[2].toBigInt());else if(o.valueBlock.value.length===2)throw new g("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key","ERR_INVALID_PARAMS");let l=e.valueBlock.value[1].valueBlock.value[1],u=l.valueBlock.value[0].toString();if(u!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(u!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new g("Only AES-CBC encryption schemes are supported","ERR_INVALID_PARAMS")}}}}let f=Xd(l.valueBlock.value[1].getValue());return{cipherText:Xd(r.valueBlock.value[1].getValue()),salt:i,iterations:a,keySize:c,iv:f}}function lF(r){return Xd(r.valueBlock.value[2].getValue())}function Xd(r){return new Uint8Array(r,0,r.byteLength)}async function fF(r){let e=await Pr.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await dF(e);return{privateKey:t[0],publicKey:t[1]}}async function gv(r){let t=[await Pr.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await Zle(r)],n=await dF({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function hF(r,e){let t=await Pr.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await Pr.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(n,0,n.byteLength)}async function pF(r,e,t){let n=await Pr.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return Pr.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,e,t instanceof Uint8Array?t:t.subarray())}async function dF(r){if(r.privateKey==null||r.publicKey==null)throw new g("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([Pr.get().subtle.exportKey("jwk",r.privateKey),Pr.get().subtle.exportKey("jwk",r.publicKey)])}async function Zle(r){return Pr.get().subtle.importKey("jwk",{kty:r.kty,n:r.n,e:r.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function Mg(r){if(r.kty!=="RSA")throw new g("invalid key type","ERR_INVALID_KEY_TYPE");if(r.n==null)throw new g("invalid key modulus","ERR_INVALID_KEY_MODULUS");return R(r.n,"base64url").length*8}var lh=8192,ch=class{_key;constructor(e){this._key=e}verify(e,t){return pF(this._key,t,e)}marshal(){return ja.jwkToPkix(this._key)}get bytes(){return Do.encode({Type:Xt.RSA,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return is(e)?e.then(({bytes:t})=>t):e.bytes}},bl=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t}genSecret(){return gl(16)}sign(e){return hF(this._key,e)}get public(){if(this._publicKey==null)throw new g("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new ch(this._publicKey)}marshal(){return ja.jwkToPkcs1(this._key)}get bytes(){return Oi.encode({Type:Xt.RSA,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return is(e)?e.then(({bytes:t})=>t):e.bytes}async id(){let e=await this.public.hash();return T(e,"base58btc")}async export(e,t="pkcs-8"){if(t==="pkcs-8")return ja.exportToPem(this,e);if(t==="libp2p-key")return oh(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};async function yv(r){let e=ja.pkcs1ToJwk(r);if(Mg(e)>lh)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let t=await gv(e);return new bl(t.privateKey,t.publicKey)}function tue(r){let e=ja.pkixToJwk(r);if(Mg(e)>lh)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new ch(e)}async function rue(r){if(Mg(r)>lh)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await gv(r);return new bl(e.privateKey,e.publicKey)}async function nue(r){if(r>lh)throw new g("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await fF(r);return new bl(e.privateKey,e.publicKey)}var Ev={};V(Ev,{Secp256k1PrivateKey:()=>fh,Secp256k1PublicKey:()=>uh,generateKeyPair:()=>aue,unmarshalSecp256k1PrivateKey:()=>oue,unmarshalSecp256k1PublicKey:()=>iue});function mF(){return ae.utils.randomPrivateKey()}function yF(r,e){let t=$.digest(e instanceof Uint8Array?e:e.subarray());if(is(t))return t.then(({digest:n})=>ae.sign(n,r).toDERRawBytes()).catch(n=>{throw new g(String(n),"ERR_INVALID_INPUT")});try{return ae.sign(t.digest,r).toDERRawBytes()}catch(n){throw new g(String(n),"ERR_INVALID_INPUT")}}function gF(r,e,t){let n=$.digest(t instanceof Uint8Array?t:t.subarray());if(is(n))return n.then(({digest:s})=>ae.verify(e,s,r)).catch(s=>{throw new g(String(s),"ERR_INVALID_INPUT")});try{return ae.verify(e,n.digest,r)}catch(s){throw new g(String(s),"ERR_INVALID_INPUT")}}function bF(r){return ae.ProjectivePoint.fromHex(r).toRawBytes(!0)}function wF(r){try{ae.getPublicKey(r,!0)}catch(e){throw new g(String(e),"ERR_INVALID_PRIVATE_KEY")}}function wv(r){try{ae.ProjectivePoint.fromHex(r)}catch(e){throw new g(String(e),"ERR_INVALID_PUBLIC_KEY")}}function EF(r){try{return ae.getPublicKey(r,!0)}catch(e){throw new g(String(e),"ERR_INVALID_PRIVATE_KEY")}}var uh=class{_key;constructor(e){wv(e),this._key=e}verify(e,t){return gF(this._key,t,e)}marshal(){return bF(this._key)}get bytes(){return Do.encode({Type:Xt.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}async hash(){let e=$.digest(this.bytes),t;return is(e)?{bytes:t}=await e:t=e.bytes,t}},fh=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t??EF(e),wF(this._key),wv(this._publicKey)}sign(e){return yF(this._key,e)}get public(){return new uh(this._publicKey)}marshal(){return this._key}get bytes(){return Oi.encode({Type:Xt.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return q(this.bytes,e.bytes)}hash(){let e=$.digest(this.bytes);return is(e)?e.then(({bytes:t})=>t):e.bytes}async id(){let e=await this.public.hash();return T(e,"base58btc")}async export(e,t="libp2p-key"){if(t==="libp2p-key")return oh(this.bytes,e);throw new g(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function oue(r){return new fh(r)}function iue(r){return new uh(r)}async function aue(){let r=mF();return new fh(r)}var Ug={rsa:bv,ed25519:pv,secp256k1:Ev};function cue(r){let e=Object.keys(Ug).join(" / ");return new g(`invalid or unsupported key type ${r}. Must be ${e}`,"ERR_UNSUPPORTED_KEY_TYPE")}function vF(r){let e=Do.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case Xt.RSA:return Ug.rsa.unmarshalRsaPublicKey(t);case Xt.Ed25519:return Ug.ed25519.unmarshalEd25519PublicKey(t);case Xt.Secp256k1:return Ug.secp256k1.unmarshalSecp256k1PublicKey(t);default:throw cue(e.Type??"unknown")}}var Cr={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS"};var hh;(function(r){let e;(function(s){let o;s.codec=()=>(o==null&&(o=ee((i,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),i.key!=null&&i.key!==""&&(a.uint32(10),a.string(i.key)),i.value!=null&&i.value.byteLength>0&&(a.uint32(18),a.bytes(i.value)),c.lengthDelimited!==!1&&a.ldelim()},(i,a)=>{let c={key:"",value:new Uint8Array(0)},l=a==null?i.len:i.pos+a;for(;i.pos<l;){let u=i.uint32();switch(u>>>3){case 1:c.key=i.string();break;case 2:c.value=i.bytes();break;default:i.skipType(u&7);break}}return c})),o),s.encode=i=>Z(i,s.codec()),s.decode=i=>J(i,s.codec())})(e=r.Peer$metadataEntry||(r.Peer$metadataEntry={}));let t;(function(s){let o;s.codec=()=>(o==null&&(o=ee((i,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),i.key!=null&&i.key!==""&&(a.uint32(10),a.string(i.key)),i.value!=null&&(a.uint32(18),Vg.codec().encode(i.value,a)),c.lengthDelimited!==!1&&a.ldelim()},(i,a)=>{let c={key:""},l=a==null?i.len:i.pos+a;for(;i.pos<l;){let u=i.uint32();switch(u>>>3){case 1:c.key=i.string();break;case 2:c.value=Vg.codec().decode(i,i.uint32());break;default:i.skipType(u&7);break}}return c})),o),s.encode=i=>Z(i,s.codec()),s.decode=i=>J(i,s.codec())})(t=r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let n;r.codec=()=>(n==null&&(n=ee((s,o,i={})=>{if(i.lengthDelimited!==!1&&o.fork(),s.addresses!=null)for(let a of s.addresses)o.uint32(10),Fg.codec().encode(a,o);if(s.protocols!=null)for(let a of s.protocols)o.uint32(18),o.string(a);if(s.publicKey!=null&&(o.uint32(34),o.bytes(s.publicKey)),s.peerRecordEnvelope!=null&&(o.uint32(42),o.bytes(s.peerRecordEnvelope)),s.metadata!=null&&s.metadata.size!==0)for(let[a,c]of s.metadata.entries())o.uint32(50),r.Peer$metadataEntry.codec().encode({key:a,value:c},o);if(s.tags!=null&&s.tags.size!==0)for(let[a,c]of s.tags.entries())o.uint32(58),r.Peer$tagsEntry.codec().encode({key:a,value:c},o);i.lengthDelimited!==!1&&o.ldelim()},(s,o)=>{let i={addresses:[],protocols:[],metadata:new Map,tags:new Map},a=o==null?s.len:s.pos+o;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:i.addresses.push(Fg.codec().decode(s,s.uint32()));break;case 2:i.protocols.push(s.string());break;case 4:i.publicKey=s.bytes();break;case 5:i.peerRecordEnvelope=s.bytes();break;case 6:{let l=r.Peer$metadataEntry.codec().decode(s,s.uint32());i.metadata.set(l.key,l.value);break}case 7:{let l=r.Peer$tagsEntry.codec().decode(s,s.uint32());i.tags.set(l.key,l.value);break}default:s.skipType(c&7);break}}return i})),n),r.encode=s=>Z(s,r.codec()),r.decode=s=>J(s,r.codec())})(hh||(hh={}));var Fg;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={multiaddr:new Uint8Array(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.multiaddr=t.bytes();break;case 2:s.isCertified=t.bool();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(Fg||(Fg={}));var Vg;(function(r){let e;r.codec=()=>(e==null&&(e=ee((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={value:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let i=t.uint32();switch(i>>>3){case 1:s.value=t.uint32();break;case 2:s.expiry=t.uint64();break;default:t.skipType(i&7);break}}return s})),e),r.encode=t=>Z(t,r.codec()),r.decode=t=>J(t,r.codec())})(Vg||(Vg={}));function ph(r,e){let t=hh.decode(e);t.publicKey!=null&&r.publicKey==null&&(r=sA({...r,publicKey:r.publicKey}));let n=new Map,s=BigInt(Date.now());for(let[o,i]of t.tags.entries())i.expiry!=null&&i.expiry<s||n.set(o,i);return{...t,id:r,addresses:t.addresses.map(({multiaddr:o,isCertified:i})=>({multiaddr:me(o),isCertified:i??!1})),metadata:t.metadata,peerRecordEnvelope:t.peerRecordEnvelope??void 0,tags:n}}var vv="/peers/";function dh(r){if(!Ml(r)||r.type==null)throw new g("Invalid PeerId",Cr.ERR_INVALID_PARAMETERS);let e=r.toCID().toString();return new ct(`${vv}${e}`)}async function xF(r,e,t){let n=new Map;for(let s of t){if(s==null)continue;if(s.multiaddr instanceof Uint8Array&&(s.multiaddr=me(s.multiaddr)),!Ra(s.multiaddr))throw new g("Multiaddr was invalid",Cr.ERR_INVALID_PARAMETERS);if(!await e(r,s.multiaddr))continue;let o=s.isCertified??!1,i=s.multiaddr.toString(),a=n.get(i);a!=null?s.isCertified=a.isCertified||o:n.set(i,{multiaddr:s.multiaddr,isCertified:o})}return[...n.values()].sort((s,o)=>s.multiaddr.toString().localeCompare(o.multiaddr.toString())).map(({isCertified:s,multiaddr:o})=>({isCertified:s,multiaddr:o.bytes}))}async function Hg(r,e,t,n){if(e==null)throw new g("Invalid PeerData",Cr.ERR_INVALID_PARAMETERS);if(e.publicKey!=null&&r.publicKey!=null&&!q(e.publicKey,r.publicKey))throw new g("publicKey bytes do not match peer id publicKey bytes",Cr.ERR_INVALID_PARAMETERS);let s=n.existingPeer;if(s!=null&&!r.equals(s.id))throw new g("peer id did not match existing peer id",Cr.ERR_INVALID_PARAMETERS);let o=s?.addresses??[],i=new Set(s?.protocols??[]),a=s?.metadata??new Map,c=s?.tags??new Map,l=s?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(o=[],e.multiaddrs!=null&&o.push(...e.multiaddrs.map(f=>({isCertified:!1,multiaddr:f}))),e.addresses!=null&&o.push(...e.addresses)),e.protocols!=null&&(i=new Set(e.protocols)),e.metadata!=null){let f=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=qg(f,{validate:SF})}if(e.tags!=null){let f=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=qg(f,{validate:_F,map:AF})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&o.push(...e.multiaddrs.map(f=>({isCertified:!1,multiaddr:f}))),e.addresses!=null&&o.push(...e.addresses),e.protocols!=null&&(i=new Set([...i,...e.protocols])),e.metadata!=null){let f=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(let[h,d]of f)d==null?a.delete(h):a.set(h,d);a=qg([...a.entries()],{validate:SF})}if(e.tags!=null){let f=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),h=new Map(c);for(let[d,p]of f)p==null?h.delete(d):h.set(d,p);c=qg([...h.entries()],{validate:_F,map:AF})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let u={addresses:await xF(r,n.addressFilter??(async()=>!0),o),protocols:[...i.values()].sort((f,h)=>f.localeCompare(h)),metadata:a,tags:c,publicKey:s?.id.publicKey??e.publicKey??r.publicKey,peerRecordEnvelope:l};return r.type!=="RSA"&&delete u.publicKey,u}function qg(r,e){let t=new Map;for(let[n,s]of r)s!=null&&e.validate(n,s);for(let[n,s]of r.sort(([o],[i])=>o.localeCompare(i)))s!=null&&t.set(n,e.map?.(n,s)??s);return t}function SF(r,e){if(typeof r!="string")throw new g("Metadata key must be a string",Cr.ERR_INVALID_PARAMETERS);if(!(e instanceof Uint8Array))throw new g("Metadata value must be a Uint8Array",Cr.ERR_INVALID_PARAMETERS)}function _F(r,e){if(typeof r!="string")throw new g("Tag name must be a string",Cr.ERR_INVALID_PARAMETERS);if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new g("Tag value must be an integer",Cr.ERR_INVALID_PARAMETERS);if(e.value<0||e.value>100)throw new g("Tag value must be between 0-100",Cr.ERR_INVALID_PARAMETERS)}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new g("Tag ttl must be an integer",Cr.ERR_INVALID_PARAMETERS);if(e.ttl<0)throw new g("Tag ttl must be between greater than 0",Cr.ERR_INVALID_PARAMETERS)}}function AF(r,e){let t;return e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl))),{value:e.value??0,expiry:t}}function zg(r,e,t){let n=r.toString().split("/")[2],s=nr.decode(n),o=dt(s),i=t.get(o);if(i!=null)return i;let a=ph(o,e);return t.set(o,a),a}function lue(r,e){return r==null?{}:{prefix:vv,filters:(r.filters??[]).map(t=>({key:n,value:s})=>t(zg(n,s,e))),orders:(r.orders??[]).map(t=>(n,s)=>t(zg(n.key,n.value,e),zg(s.key,s.value,e)))}}var $g=class{peerId;datastore;lock;addressFilter;constructor(e,t={}){this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.lock=Jh({name:"peer-store",singleProcess:!0})}async has(e){return this.datastore.has(dh(e))}async delete(e){if(this.peerId.equals(e))throw new g("Cannot delete self peer",Cr.ERR_INVALID_PARAMETERS);await this.datastore.delete(dh(e))}async load(e){let t=await this.datastore.get(dh(e));return ph(e,t)}async save(e,t){let{existingBuf:n,existingPeer:s}=await this.#e(e),o=await Hg(e,t,"patch",{addressFilter:this.addressFilter});return this.#t(e,o,n,s)}async patch(e,t){let{existingBuf:n,existingPeer:s}=await this.#e(e),o=await Hg(e,t,"patch",{addressFilter:this.addressFilter,existingPeer:s});return this.#t(e,o,n,s)}async merge(e,t){let{existingBuf:n,existingPeer:s}=await this.#e(e),o=await Hg(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:s});return this.#t(e,o,n,s)}async*all(e){let t=new ar;for await(let{key:n,value:s}of this.datastore.query(lue(e??{},t))){let o=zg(n,s,t);o.id.equals(this.peerId)||(yield o)}}async#e(e){try{let t=await this.datastore.get(dh(e)),n=ph(e,t);return{existingBuf:t,existingPeer:n}}catch(t){if(t.code!=="ERR_NOT_FOUND")throw t}return{}}async#t(e,t,n,s){let o=hh.encode(t);return n!=null&&q(o,n)?{peer:ph(e,o),previous:s,updated:!1}:(await this.datastore.put(dh(e),o),{peer:ph(e,o),previous:s,updated:!0})}};var Gg=class{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new $g(e,t)}async forEach(e,t){this.log.trace("forEach await read lock");let n=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(let s of this.store.all(t))e(s)}finally{this.log.trace("forEach release read lock"),n()}}async all(e){this.log.trace("all await read lock");let t=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await _h(this.store.all(e))}finally{this.log.trace("all release read lock"),t()}}async delete(e){this.log.trace("delete await write lock");let t=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(e)}finally{this.log.trace("delete release write lock"),t()}}async has(e){this.log.trace("has await read lock");let t=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(e)}finally{this.log.trace("has release read lock"),t()}}async get(e){this.log.trace("get await read lock");let t=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(e)}finally{this.log.trace("get release read lock"),t()}}async save(e,t){this.log.trace("save await write lock");let n=await this.store.lock.writeLock();this.log.trace("save got write lock");try{let s=await this.store.save(e,t);return this.#e(e,s),s.peer}finally{this.log.trace("save release write lock"),n()}}async patch(e,t){this.log.trace("patch await write lock");let n=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{let s=await this.store.patch(e,t);return this.#e(e,s),s.peer}finally{this.log.trace("patch release write lock"),n()}}async merge(e,t){this.log.trace("merge await write lock");let n=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{let s=await this.store.merge(e,t);return this.#e(e,s),s.peer}finally{this.log.trace("merge release write lock"),n()}}async consumePeerRecord(e,t){let n=await Zn.openAndCertify(e,Dn.DOMAIN);if(t?.equals(n.peerId)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",t,n.peerId),!1;let s=Dn.createFromProtobuf(n.payload),o;try{o=await this.get(n.peerId)}catch(i){if(i.code!=="ERR_NOT_FOUND")throw i}if(o?.peerRecordEnvelope!=null){let i=await Zn.createFromProtobuf(o.peerRecordEnvelope),a=Dn.createFromProtobuf(i.payload);if(a.seqNumber>=s.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",a.seqNumber,s.seqNumber),!1}return await this.patch(s.peerId,{peerRecordEnvelope:e,addresses:s.multiaddrs.map(i=>({isCertified:!0,multiaddr:i}))}),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}};function RF(r,e){let t;return function(){let n=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(n,e)}}var uue=r=>r;function xv(r,e){let t=r.getPeerId();return t!=null&&Ce(t).equals(e)&&(r=r.decapsulate(me(`/p2p/${e.toString()}`))),r}var Wg=class{log;components;listen;announce;observed;announceFilter;constructor(e,t={}){let{listen:n=[],announce:s=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(o=>o.toString()),this.announce=new Set(s.map(o=>o.toString())),this.observed=new Map,this.announceFilter=t.announceFilter??uue,this._updatePeerStoreAddresses=RF(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}_updatePeerStoreAddresses(){let e=this.getAnnounceAddrs().concat(this.components.transportManager.getAddrs()).concat([...this.observed.entries()].filter(([t,n])=>n.confident).map(([t])=>me(t))).map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>me(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>me(e))}getObservedAddrs(){return Array.from(this.observed).map(([e])=>me(e))}addObservedAddr(e){e=xv(e,this.components.peerId);let t=e.toString();this.observed.has(t)||this.observed.set(t,{confident:!1})}confirmObservedAddr(e){e=xv(e,this.components.peerId);let t=e.toString(),s=(this.observed.get(t)??{confident:!1}).confident;this.observed.set(t,{confident:!0}),s||this._updatePeerStoreAddresses()}removeObservedAddr(e){e=xv(e,this.components.peerId);let t=e.toString();this.observed.delete(t)}getAddresses(){let e=this.getAnnounceAddrs().map(n=>n.toString());e.length===0&&(e=this.components.transportManager.getAddrs().map(n=>n.toString())),e=e.concat(Array.from(this.observed).filter(([n,s])=>s.confident).map(([n])=>n));let t=new Set(e);return this.announceFilter(Array.from(t).map(n=>me(n))).map(n=>n.protos().pop()?.path===!0||n.getPeerId()===this.components.peerId.toString()?n:n.encapsulate(`/p2p/${this.components.peerId.toString()}`))}};var Sv=class{components={};_started=!1;constructor(e={}){this.components={};for(let[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=Dl())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>d0(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}},fue=["metrics","connectionProtector"],hue=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function IF(r={}){let e=new Sv(r);return new Proxy(e,{get(n,s,o){if(typeof s=="string"&&!hue.includes(s)){let i=e.components[s];if(i==null&&!fue.includes(s))throw new g(`${s} not set`,"ERR_SERVICE_MISSING");return i}return Reflect.get(n,s,o)},set(n,s,o){return typeof s=="string"?e.components[s]=o:Reflect.set(n,s,o),!0}})}function TF(r={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{let t=e.stringTuples();return t[0][0]===4||t[0][0]===41?!!Xn(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...r}}function _v(r){try{let{address:e}=r.nodeAddress();return!!Xn(e)}catch{return!0}}function pue(r,e){let t=_v(r.multiaddr),n=_v(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function due(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function mue(r,e){let t=_d.exactMatch(r.multiaddr),n=_d.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function mh(r,e){let t=pue(r,e);if(t!==0)return t;let n=mue(r,e);return n!==0?n:due(r,e)}var Rv=fe(i0(),1),Iv=fe(PF(),1);function Yg(r,e,t){return`${r}?name=${e}&type=${t}`}async function CF(r,e){return await(await fetch(r,{headers:new Headers({accept:"application/dns-json"}),signal:e})).json()}function wl(r,e){return`${e}_${r}`}var Av=Object.assign((0,Rv.default)("dns-over-http-resolver"),{error:(0,Rv.default)("dns-over-http-resolver:error")}),Tv=class{_cache;_TXTcache;_servers;_request;_abortControllers;constructor(e={}){this._cache=new Iv.default({max:e?.maxCache??100}),this._TXTcache=new Iv.default({max:e?.maxCache??100}),this._servers=["https://cloudflare-dns.com/dns-query","https://dns.google/resolve"],this._request=e.request??CF,this._abortControllers=[]}cancel(){this._abortControllers.forEach(e=>{e.abort()})}getServers(){return this._servers}_getShuffledServers(){let e=[...this._servers];for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*t),s=e[t];e[t]=e[n],e[n]=s}return e}setServers(e){this._servers=e}async resolve(e,t="A"){switch(t){case"A":return this.resolve4(e);case"AAAA":return this.resolve6(e);case"TXT":return this.resolveTxt(e);default:throw new Error(`${t} is not supported`)}}async resolve4(e){let t="A",n=this._cache.get(wl(e,t));if(n!=null)return n;let s=!1;for(let o of this._getShuffledServers()){let i=new AbortController;this._abortControllers.push(i);try{let a=await this._request(Yg(o,e,t),i.signal),c=a.Answer.map(u=>u.data),l=Math.min(...a.Answer.map(u=>u.TTL));return this._cache.set(wl(e,t),c,{ttl:l}),c}catch{i.signal.aborted&&(s=!0),Av.error(`${o} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==i)}}throw s?Object.assign(new Error("queryA ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}async resolve6(e){let t="AAAA",n=this._cache.get(wl(e,t));if(n!=null)return n;let s=!1;for(let o of this._getShuffledServers()){let i=new AbortController;this._abortControllers.push(i);try{let a=await this._request(Yg(o,e,t),i.signal),c=a.Answer.map(u=>u.data),l=Math.min(...a.Answer.map(u=>u.TTL));return this._cache.set(wl(e,t),c,{ttl:l}),c}catch{i.signal.aborted&&(s=!0),Av.error(`${o} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==i)}}throw s?Object.assign(new Error("queryAaaa ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}async resolveTxt(e){let t="TXT",n=this._TXTcache.get(wl(e,t));if(n!=null)return n;let s=!1;for(let o of this._getShuffledServers()){let i=new AbortController;this._abortControllers.push(i);try{let a=await this._request(Yg(o,e,t),i.signal),c=a.Answer.map(u=>[u.data.replace(/['"]+/g,"")]),l=Math.min(...a.Answer.map(u=>u.TTL));return this._TXTcache.set(wl(e,t),c,{ttl:l}),c}catch{i.signal.aborted&&(s=!0),Av.error(`${o} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==i)}}throw s?Object.assign(new Error("queryTxt ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}clearCache(){this._cache.clear(),this._TXTcache.clear()}},BF=Tv;var NF=BF;var{code:Eue}=ve("dnsaddr");async function yh(r,e={}){let t=new NF;e.signal!=null&&e.signal.addEventListener("abort",()=>{t.cancel()});let n=r.getPeerId(),[,s]=r.stringTuples().find(([a])=>a===Eue)??[];if(s==null)throw new Error("No hostname found in multiaddr");let i=(await t.resolveTxt(`_dnsaddr.${s}`)).flat().map(a=>a.split("=")[1]).filter(Boolean);return n!=null&&(i=i.filter(a=>a.includes(n))),i}var Ki;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",r.NOT_FOUND="Not found"})(Ki||(Ki={}));var pe;(function(r){r.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",r.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",r.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",r.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",r.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",r.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",r.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",r.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",r.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",r.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",r.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",r.ERR_DIALED_SELF="ERR_DIALED_SELF",r.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",r.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",r.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",r.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",r.ERR_INVALID_KEY="ERR_INVALID_KEY",r.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_INVALID_PEER="ERR_INVALID_PEER",r.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",r.ERR_NOT_FOUND="ERR_NOT_FOUND",r.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",r.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",r.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",r.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",r.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",r.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",r.ERR_FIND_SELF="ERR_FIND_SELF",r.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",r.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",r.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",r.ERR_INVALID_CMS="ERR_INVALID_CMS",r.ERR_MISSING_KEYS="ERR_MISSING_KEYS",r.ERR_NO_KEY="ERR_NO_KEY",r.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",r.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",r.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",r.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",r.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",r.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",r.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",r.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",r.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",r.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",r.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",r.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",r.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",r.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",r.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",r.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",r.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",r.ERR_INVALID_RECORD="ERR_INVALID_RECORD",r.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",r.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",r.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",r.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",r.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED",r.ERR_TRANSFER_LIMIT_EXCEEDED="ERR_TRANSFER_LIMIT_EXCEEDED"})(pe||(pe={}));var vue={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{resolvers:{dnsaddr:yh},addressSorter:mh},transportManager:{faultTolerance:qi.FATAL_ALL}};function LF(r){let e=Hf(vue,r);if(e.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new g(Ki.ERR_PROTECTOR_REQUIRED,pe.ERR_PROTECTOR_REQUIRED);return e}function jg(r){if(Ml(r))return{peerId:r,multiaddrs:[]};Array.isArray(r)||(r=[r]);let e;if(r.length>0){let t=r[0].getPeerId();e=t==null?void 0:Ce(t),r.forEach(n=>{if(!Ra(n))throw new g("Invalid Multiaddr",pe.ERR_INVALID_MULTIADDR);let s=n.getPeerId();if(s==null){if(e!=null)throw new g("Multiaddrs must all have the same peer id or have no peer id",pe.ERR_INVALID_PARAMETERS)}else{let o=Ce(s);if(e==null||!e.equals(o))throw new g("Multiaddrs must all have the same peer id or have no peer id",pe.ERR_INVALID_PARAMETERS)}})}return{peerId:e,multiaddrs:r}}var Qg="last-dial-failure";var Xg=5,Jg=100,Zg=50,OF=1e3*60*7;var El={minConnections:Xg,maxQueueLength:100,autoDialConcurrency:25,autoDialPriority:0,autoDialInterval:5e3,autoDialPeerRetryThreshold:OF,autoDialDiscoveredPeersDebounce:10},e3=class{connectionManager;peerStore;queue;minConnections;autoDialPriority;autoDialIntervalMs;autoDialMaxQueueLength;autoDialPeerRetryThresholdMs;autoDialDiscoveredPeersDebounce;autoDialInterval;started;running;log;constructor(e,t){this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.minConnections=t.minConnections??El.minConnections,this.autoDialPriority=t.autoDialPriority??El.autoDialPriority,this.autoDialIntervalMs=t.autoDialInterval??El.autoDialInterval,this.autoDialMaxQueueLength=t.maxQueueLength??El.maxQueueLength,this.autoDialPeerRetryThresholdMs=t.autoDialPeerRetryThreshold??El.autoDialPeerRetryThreshold,this.autoDialDiscoveredPeersDebounce=t.autoDialDiscoveredPeersDebounce??El.autoDialDiscoveredPeersDebounce,this.log=e.logger.forComponent("libp2p:connection-manager:auto-dial"),this.started=!1,this.running=!1,this.queue=new Ma({concurrency:t.autoDialConcurrency??El.autoDialConcurrency,metricName:"libp2p_autodial_queue",metrics:e.metrics}),this.queue.addEventListener("error",s=>{this.log.error("error during auto-dial",s.detail)}),e.events.addEventListener("connection:close",()=>{this.autoDial().catch(s=>{this.log.error(s)})});let n;e.events.addEventListener("peer:discovery",()=>{clearTimeout(n),n=setTimeout(()=>{this.autoDial().catch(s=>{this.log.error(s)})},this.autoDialDiscoveredPeersDebounce)})}isStarted(){return this.started}start(){this.started=!0}afterStart(){this.autoDial().catch(e=>{this.log.error("error while autodialing",e)})}stop(){this.queue.clear(),clearTimeout(this.autoDialInterval),this.started=!1,this.running=!1}async autoDial(){if(!this.started||this.running)return;let e=this.connectionManager.getConnectionsMap(),t=e.size;if(t>=this.minConnections){this.minConnections>0&&this.log.trace("have enough connections %d/%d",t,this.minConnections);return}if(this.queue.size>this.autoDialMaxQueueLength){this.log("not enough connections %d/%d but auto dial queue is full",t,this.minConnections),this.sheduleNextAutodial();return}this.running=!0,this.log("not enough connections %d/%d - will dial peers to increase the number of connections",t,this.minConnections);let n=new cr(this.connectionManager.getDialQueue().map(l=>l.peerId).filter(Boolean)),s=await this.peerStore.all({filters:[l=>l.addresses.length===0?(this.log.trace("not autodialing %p because they have no addresses",l.id),!1):e.has(l.id)?(this.log.trace("not autodialing %p because they are already connected",l.id),!1):n.has(l.id)?(this.log.trace("not autodialing %p because they are already being dialed",l.id),!1):this.queue.has(l.id)?(this.log.trace("not autodialing %p because they are already being autodialed",l.id),!1):!0]}),o=s.sort(()=>Math.random()>.5?1:-1),i=new ar;for(let l of o)i.has(l.id)||i.set(l.id,[...l.tags.values()].reduce((u,f)=>u+f.value,0));let c=o.sort((l,u)=>{let f=i.get(l.id)??0,h=i.get(u.id)??0;return f>h?-1:f<h?1:0}).filter(l=>{let u=l.metadata.get(Qg);if(u==null)return!0;let f=parseInt(T(u));return isNaN(f)?!0:Date.now()-f>this.autoDialPeerRetryThresholdMs});this.log("selected %d/%d peers to dial",c.length,s.length);for(let l of c)this.queue.add(async()=>{let u=this.connectionManager.getConnectionsMap().size;if(u>=this.minConnections){this.log("got enough connections now %d/%d",u,this.minConnections),this.queue.clear();return}this.log("connecting to a peerStore stored peer %p",l.id),await this.connectionManager.openConnection(l.id,{priority:this.autoDialPriority})},{peerId:l.id}).catch(u=>{this.log.error("could not connect to peerStore stored peer",u)});this.running=!1,this.sheduleNextAutodial()}sheduleNextAutodial(){this.started&&(this.autoDialInterval=setTimeout(()=>{this.autoDial().catch(e=>{this.log.error("error while autodialing",e)})},this.autoDialIntervalMs))}};var KF={maxConnections:Jg,allow:[]},t3=class{maxConnections;connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.maxConnections=t.maxConnections??KF.maxConnections,this.allow=t.allow??KF.allow,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),e.events.addEventListener("connection:open",()=>{this.maybePruneConnections().catch(n=>{this.log.error(n)})})}async maybePruneConnections(){let e=this.connectionManager.getConnections(),t=e.length,n=Math.max(t-this.maxConnections,0);if(this.log("checking max connections limit %d/%d",t,this.maxConnections),t<=this.maxConnections)return;this.log("max connections limit exceeded %d/%d, pruning %d connection(s)",t,this.maxConnections,n);let s=new ar;for(let a of e){let c=a.remotePeer;if(!s.has(c)){s.set(c,0);try{let l=await this.peerStore.get(c);s.set(c,[...l.tags.values()].reduce((u,f)=>u+f.value,0))}catch(l){l.code!=="ERR_NOT_FOUND"&&this.log.error("error loading peer tags",l)}}}let o=e.sort((a,c)=>{let l=s.get(a.remotePeer)??0,u=s.get(c.remotePeer)??0;if(l>u)return 1;if(l<u)return-1;let f=a.timeline.open,h=c.timeline.open;return f<h?1:f>h?-1:0}),i=[];for(let a of o)if(this.log("too many connections open - closing a connection to %p",a.remotePeer),this.allow.some(l=>a.remoteAddr.toString().startsWith(l.toString()))||i.push(a),i.length===n)break;await Promise.all(i.map(async a=>{try{await a.close()}catch(c){this.log.error(c)}})),this.events.safeDispatchEvent("connection:prune",{detail:i})}};async function Cv(r,e){if(!r.protoNames().includes("dnsaddr"))return[r];let n=await _ue(r,e),i=(await Promise.all(n.map(async a=>Cv(a,e)))).flat().reduce((a,c)=>(a.find(l=>l.equals(c))==null&&a.push(c),a),[]);return e.log("resolved %s to",r,i.map(a=>a.toString())),i}async function _ue(r,e){try{return r=me(r.toString()),await r.resolve(e)}catch(t){return e.log.error(`multiaddr ${r.toString()} could not be resolved`,t),[]}}var r3={addressSorter:mh,maxParallelDials:Zg,maxPeerAddrsToDial:25,dialTimeout:3e4,resolvers:{dnsaddr:yh}},n3=class{queue;components;addressSorter;maxPeerAddrsToDial;dialTimeout;shutDownController;connections;log;constructor(e,t={}){this.addressSorter=t.addressSorter??r3.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??r3.maxPeerAddrsToDial,this.dialTimeout=t.dialTimeout??r3.dialTimeout,this.connections=t.connections??new ar,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.shutDownController=new AbortController,Ze(1/0,this.shutDownController.signal);for(let[n,s]of Object.entries(t.resolvers??{}))mm.set(n,s);this.queue=new qo({concurrency:t.maxParallelDials??r3.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",n=>{this.log.error("error in dial queue",n.detail)})}start(){this.shutDownController=new AbortController}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){let{peerId:n,multiaddrs:s}=jg(e),o=Array.from(this.connections.values()).flat().find(a=>t.force===!0?!1:a.remotePeer.equals(n)?!0:s.find(c=>c.equals(a.remoteAddr)));if(o!=null)return this.log("already connected to %a",o.remoteAddr),o;let i=this.queue.queue.find(a=>{if(n?.equals(a.options.peerId)===!0)return!0;let c=a.options.multiaddrs;if(c==null)return!1;for(let l of s)if(c.has(l.toString()))return!0;return!1});if(i!=null){this.log("joining existing dial target for %p",n);for(let a of s)i.options.multiaddrs.add(a.toString());return i.join(t)}return this.log("creating dial target for %p",n,s.map(a=>a.toString())),this.queue.add(async a=>{let c=this.createDialAbortController(a?.signal),l;try{l=await this.calculateMultiaddrs(n,a?.multiaddrs,{...a,signal:c}),l.map(({multiaddr:u})=>u.toString()).forEach(u=>{a?.multiaddrs.add(u)})}catch(u){throw c.clear(),u}try{let u=0,f=[];for(let h of l){if(u===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",u,n),new g("Peer had more than maxPeerAddrsToDial",pe.ERR_TOO_MANY_ADDRESSES);u++;try{let d=await this.components.transportManager.dial(h.multiaddr,{...a,signal:c});return this.log("dial to %a succeeded",h.multiaddr),d}catch(d){if(this.log.error("dial failed to %a",h.multiaddr,d),n!=null)try{await this.components.peerStore.patch(n,{metadata:{[Qg]:R(Date.now().toString())}})}catch(p){this.log.error("could not update last dial failure key for %p",n,p)}if(c.aborted)throw new g(d.message,Fo);f.push(d)}}throw f.length===1?f[0]:new p0(f,"All multiaddr dials failed",pe.ERR_TRANSPORT_DIAL_FAILED)}finally{c.clear()}},{peerId:n,priority:t.priority,multiaddrs:new Set(s.map(a=>a.toString())),signal:t.signal})}createDialAbortController(e){let t=ur([AbortSignal.timeout(this.dialTimeout),this.shutDownController.signal,e]);return Ze(1/0,t),t}async calculateMultiaddrs(e,t=new Set,n={}){let s=[...t].map(f=>({multiaddr:me(f),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new g("Tried to dial self",pe.ERR_DIALED_SELF);if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new g("The dial request is blocked by gater.allowDialPeer",pe.ERR_PEER_DIAL_INTERCEPTED);if(s.length===0){this.log("loading multiaddrs for %p",e);try{let f=await this.components.peerStore.get(e);s.push(...f.addresses),this.log("loaded multiaddrs for %p",e,s.map(({multiaddr:h})=>h.toString()))}catch(f){if(f.code!==pe.ERR_NOT_FOUND)throw f}}if(s.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{let f=await this.components.peerRouting.findPeer(e);this.log("found multiaddrs for %p in the peer routing",e,s.map(({multiaddr:h})=>h.toString())),s.push(...f.multiaddrs.map(h=>({multiaddr:h,isCertified:!1})))}catch(f){f.code!==pe.ERR_NO_ROUTERS_AVAILABLE&&this.log.error("looking up multiaddrs for %p in the peer routing failed",e,f)}}}let o=(await Promise.all(s.map(async f=>{let h=await Cv(f.multiaddr,{...n,log:this.log});return h.length===1&&h[0].equals(f.multiaddr)?f:h.map(d=>({multiaddr:d,isCertified:!1}))}))).flat();if(e!=null){let f=`/p2p/${e.toString()}`;o=o.map(h=>h.multiaddr.protos().pop()?.path===!0?h:h.multiaddr.getPeerId()==null?{multiaddr:h.multiaddr.encapsulate(f),isCertified:h.isCertified}:h)}let i=o.filter(f=>{if(this.components.transportManager.transportForMultiaddr(f.multiaddr)==null)return!1;let h=f.multiaddr.getPeerId();return e!=null&&h!=null?e.equals(h):!0}),a=new Map;for(let f of i){let h=f.multiaddr.toString(),d=a.get(h);if(d!=null){d.isCertified=d.isCertified||f.isCertified||!1;continue}a.set(h,f)}let c=[...a.values()];if(c.length===0)throw new g("The dial request has no valid addresses",pe.ERR_NO_VALID_ADDRESSES);let l=[];for(let f of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(f.multiaddr)||l.push(f);let u=l.sort(this.addressSorter);if(u.length===0)throw new g("The connection gater denied all addresses in the dial request",pe.ERR_NO_VALID_ADDRESSES);return this.log.trace("addresses for %p before filtering",e??"unknown peer",o.map(({multiaddr:f})=>f.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",u.map(({multiaddr:f})=>f.toString())),u}};var Iue=50,vl={minConnections:Xg,maxConnections:Jg,inboundConnectionThreshold:5,maxIncomingPendingConnections:10,autoDialConcurrency:25,autoDialPriority:0,autoDialMaxQueueLength:100},s3=class{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;maxConnections;dialQueue;autoDial;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;constructor(e,t={}){this.maxConnections=t.maxConnections??vl.maxConnections;let n=t.minConnections??vl.minConnections;if(this.maxConnections<n)throw new g("Connection Manager maxConnections must be greater than minConnections",pe.ERR_INVALID_PARAMETERS);this.connections=new ar,this.started=!1,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),this.allow=(t.allow??[]).map(s=>me(s)),this.deny=(t.deny??[]).map(s=>me(s)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??vl.maxIncomingPendingConnections,this.inboundConnectionRateLimiter=new zf({points:t.inboundConnectionThreshold??vl.inboundConnectionThreshold,duration:1}),this.autoDial=new e3({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{minConnections:n,autoDialConcurrency:t.autoDialConcurrency??vl.autoDialConcurrency,autoDialPriority:t.autoDialPriority??vl.autoDialPriority,maxQueueLength:t.autoDialMaxQueueLength??vl.autoDialMaxQueueLength}),this.connectionPruner=new t3({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{maxConnections:this.maxConnections,allow:this.allow}),this.dialQueue=new n3(e,{addressSorter:t.addressSorter??mh,maxParallelDials:t.maxParallelDials??Zg,maxPeerAddrsToDial:t.maxPeerAddrsToDial??25,dialTimeout:t.dialTimeout??3e4,resolvers:t.resolvers??{dnsaddr:yh},connections:this.connections})}isStarted(){return this.started}async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{let e={inbound:0,outbound:0};for(let t of this.connections.values())for(let n of t)n.direction==="inbound"?e.inbound++:e.outbound++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{let e={};for(let t of this.connections.values())for(let n of t)for(let s of n.streams){let o=`${s.direction} ${s.protocol??"unnegotiated"}`;e[o]=(e[o]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{let e={};for(let n of this.connections.values())for(let s of n){let o={};for(let i of s.streams){let a=`${i.direction} ${i.protocol??"unnegotiated"}`;o[a]=(o[a]??0)+1}for(let[i,a]of Object.entries(o))e[i]=e[i]??[],e[i].push(a)}let t={};for(let[n,s]of Object.entries(e)){s=s.sort((i,a)=>i-a);let o=Math.floor(s.length*.9);t[n]=s[o]}return t}}),this.dialQueue.start(),this.autoDial.start(),this.started=!0,this.log("started")}async afterStart(){Promise.resolve().then(async()=>{let e=await this.peerStore.all({filters:[t=>t.tags.has($9)]});await Promise.all(e.map(async t=>{await this.openConnection(t.id).catch(n=>{this.log.error(n)})}))}).catch(e=>{this.log.error(e)}),this.autoDial.afterStart()}async stop(){this.dialQueue.stop(),this.autoDial.stop();let e=[];for(let t of this.connections.values())for(let n of t)e.push((async()=>{try{await n.close()}catch(s){this.log.error(s)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}onConnect(e){this._onConnect(e).catch(t=>{this.log.error(t)})}async _onConnect(e){let{detail:t}=e;if(!this.started){await t.close();return}let n=t.remotePeer,s=this.connections.get(n),o=!1;s!=null?s.push(t):(o=!0,this.connections.set(n,[t])),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),o&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){let{detail:t}=e;if(!this.started)return;let n=t.remotePeer,s=this.connections.get(n);s!=null&&s.length>1?(s=s.filter(o=>o.id!==t.id),this.connections.set(n,s)):s!=null&&(this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(let n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.isStarted())throw new g("Not started",pe.ERR_NODE_NOT_STARTED);t.signal?.throwIfAborted();let{peerId:n}=jg(e);if(n!=null&&t.force!==!0){this.log("dial %p",n);let a=this.getConnections(n).find(c=>!c.transient);if(a!=null)return this.log("had an existing non-transient connection to %p",n),a}let s=await this.dialQueue.dial(e,{...t,priority:t.priority??Iue}),o=this.connections.get(s.remotePeer);o==null&&(o=[],this.connections.set(s.remotePeer,o));let i=!1;for(let a of o)a.id===s.id&&(i=!0);return i||o.push(s),s}async closeConnections(e,t={}){let n=this.connections.get(e)??[];await Promise.all(n.map(async s=>{try{await s.close(t)}catch(o){s.abort(o)}}))}async acceptIncomingConnection(e){if(this.deny.some(s=>e.remoteAddr.toString().startsWith(s.toString())))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(s=>e.remoteAddr.toString().startsWith(s.toString())))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){let s=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(s,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,s),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){let e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>me(n))}))}};var o3=class{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new g("No content routers available",pe.ERR_NO_ROUTERS_AVAILABLE);let n=this,s=new cr;for await(let o of fs(...n.routers.map(i=>i.findProviders(e,t))))o!=null&&(o.multiaddrs.length>0&&await this.components.peerStore.merge(o.id,{multiaddrs:o.multiaddrs}),!s.has(o.id)&&(s.add(o.id),yield o))}async provide(e,t={}){if(this.routers.length===0)throw new g("No content routers available",pe.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map(async n=>{await n.provide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new g(Ki.NOT_STARTED_YET,pe.ERR_NODE_NOT_STARTED);await Promise.all(this.routers.map(async s=>{await s.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new g(Ki.NOT_STARTED_YET,pe.ERR_NODE_NOT_STARTED);return Promise.any(this.routers.map(async n=>n.get(e,t)))}};var i3=class{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[]}async findPeer(e,t){if(this.routers.length===0)throw new g("No peer routers available",pe.ERR_NO_ROUTERS_AVAILABLE);if(e.toString()===this.peerId.toString())throw new g("Should not try to find self",pe.ERR_FIND_SELF);let n=this,s=fs(...this.routers.map(o=>async function*(){try{yield await o.findPeer(e,t)}catch(i){n.log.error(i)}}()));for await(let o of s)if(o!=null)return o.multiaddrs.length>0&&await this.peerStore.merge(o.id,{multiaddrs:o.multiaddrs}),o;throw new g(Ki.NOT_FOUND,pe.ERR_NOT_FOUND)}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new g("No peer routers available",pe.ERR_NO_ROUTERS_AVAILABLE);let n=this,s=new cr;for await(let o of Ei(async function*(){let i=fs(...n.routers.map(a=>a.getClosestPeers(e,t)));for await(let a of i)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs",c);return}return a}}()))o!=null&&(o.multiaddrs.length>0&&await this.peerStore.merge(o.id,{multiaddrs:o.multiaddrs}),!s.has(o.id)&&(s.add(o.id),yield o))}};var Lv=32,Ov=64,a3=class{log;topologies;handlers;components;constructor(e){this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){let t=this.handlers.get(e);if(t==null)throw new g(`No handler registered for protocol ${e}`,pe.ERR_NO_HANDLER_FOR_PROTOCOL);return t}getTopologies(e){let t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e))throw new g(`Handler already registered for protocol ${e}`,pe.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);let s=Hf.bind({ignoreUndefined:!0})({maxInboundStreams:Lv,maxOutboundStreams:Ov},n);this.handlers.set(e,{handler:t,options:s}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]})}async unhandle(e){(Array.isArray(e)?e:[e]).forEach(n=>{this.handlers.delete(n)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(e,t){if(t==null)throw new g("invalid topology",pe.ERR_INVALID_PARAMETERS);let n=`${(Math.random()*1e9).toString(36)}${Date.now()}`,s=this.topologies.get(e);return s==null&&(s=new Map,this.topologies.set(e,s)),s.set(n,t),n}unregister(e){for(let[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){let t=e.detail;this.components.peerStore.get(t).then(n=>{for(let s of n.protocols){let o=this.topologies.get(s);if(o!=null)for(let i of o.values())i.onDisconnect?.(t)}}).catch(n=>{n.code!==pe.ERR_NOT_FOUND&&this.log.error("could not inform topologies of disconnecting peer %p",t,n)})}_onPeerUpdate(e){let{peer:t,previous:n}=e.detail,s=(n?.protocols??[]).filter(o=>!t.protocols.includes(o));for(let o of s){let i=this.topologies.get(o);if(i!=null)for(let a of i.values())a.onDisconnect?.(t.id)}}_onPeerIdentify(e){let t=e.detail.protocols,n=e.detail.connection,s=e.detail.peerId;for(let o of t){let i=this.topologies.get(o);if(i!=null)for(let a of i.values())n.transient&&a.notifyOnTransient!==!0||a.onConnect?.(s,n)}}};var c3=class{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=new Map,this.listeners=zs({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??qi.FATAL_ALL}add(e){let t=e[Symbol.toStringTag];if(t==null)throw new g("Transport must have a valid tag",pe.ERR_INVALID_KEY);if(this.transports.has(t))throw new g(`There is already a transport with the tag ${t}`,pe.ERR_DUPLICATE_TRANSPORT);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){let e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){let e=[];for(let[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){let s=n.pop();s!=null&&e.push(s.close())}await Promise.all(e),this.log("all listeners closed");for(let t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){let n=this.transportForMultiaddr(e);if(n==null)throw new g(`No transport available for address ${String(e)}`,pe.ERR_TRANSPORT_UNAVAILABLE);try{return await n.dial(e,{...t,upgrader:this.components.upgrader})}catch(s){throw s.code==null&&(s.code=pe.ERR_TRANSPORT_DIAL_FAILED),s}}getAddrs(){let e=[];for(let t of this.listeners.values())for(let n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}transportForMultiaddr(e){for(let t of this.transports.values())if(t.filter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new g("Not started",pe.ERR_NODE_NOT_STARTED);if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}let t=[];for(let[n,s]of this.transports.entries()){let o=s.filter(e),i=[];for(let l of o){this.log("creating listener for %s on %a",n,l);let u=s.createListener({upgrader:this.components.upgrader}),f=this.listeners.get(n)??[];f==null&&(f=[],this.listeners.set(n,f)),f.push(u),u.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:u})}),u.addEventListener("close",()=>{let h=f.findIndex(d=>d===u);f.splice(h,1),this.components.events.safeDispatchEvent("transport:close",{detail:u})}),i.push(u.listen(l))}if(i.length===0){t.push(n);continue}if((await Promise.allSettled(i)).find(l=>l.status==="fulfilled")==null&&this.faultTolerance!==qi.NO_FATAL)throw new g(`Transport (${n}) could not listen on any available address`,pe.ERR_NO_VALID_ADDRESSES)}if(t.length===this.transports.size){let n=`no valid addresses were provided for transports [${t.join(", ")}]`;if(this.faultTolerance===qi.FATAL_ALL)throw new g(n,pe.ERR_NO_VALID_ADDRESSES);this.log(`libp2p in dial mode only: ${n}`)}}async remove(e){let t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);let n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){let s=t.pop();s!=null&&n.push(s.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){let e=[];for(let t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}};var Br="/multistream/1.0.0";var Tue=R(`
`);async function xl(r,e,t){await r.write(e,t)}async function MF(r,e,t){await r.writeV(e,t)}async function kue(r,e){let t=await r.read(e);if(t.byteLength===0||t.get(t.byteLength-1)!==Tue[0])throw e.log.error("Invalid mss message - missing newline",t),new g("missing newline","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return t.sublist(0,-1)}async function Xa(r,e){let t=await kue(r,e);return T(t.subarray())}async function Jd(r,e,t){if(e=Array.isArray(e)?[...e]:[e],e.length===1&&t.negotiateFully===!1)return Due(r,e[0],t);let n=io(r,{...t,maxDataLength:1024}),s=e.shift();if(s==null)throw new Error("At least one protocol must be specified");t.log.trace('select: write ["%s", "%s"]',Br,s);let o=R(`${Br}
`),i=R(`${s}
`);await MF(n,[o,i],t),t.log.trace("select: reading multistream-select header");let a=await Xa(n,t);if(t.log.trace('select: read "%s"',a),a===Br&&(t.log.trace("select: reading protocol response"),a=await Xa(n,t),t.log.trace('select: read "%s"',a)),a===s)return{stream:n.unwrap(),protocol:s};for(let c of e){t.log.trace('select: write "%s"',c),await xl(n,R(`${c}
`),t),t.log.trace("select: reading protocol response");let l=await Xa(n,t);if(t.log.trace('select: read "%s" for "%s"',l,c),l===c)return{stream:n.unwrap(),protocol:c}}throw new g("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}function Due(r,e,t){let n=r.sink.bind(r),s=r.source,o=!1,i=!1,a=xe(),c=!1,l=!1,u=xe(),f=!1,h=!1,d=xe(),p=io({sink:n,source:s},{...t,maxDataLength:1024});r.sink=async w=>{let{sink:E}=p.unwrap();await E(async function*(){let x=!1;for await(let v of w){if(l&&await u.promise,c)yield v;else{l=!0,t.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',Br,e,v.byteLength);let S=`${e}
`;yield new ke(Uint8Array.from([19]),R(`${Br}
`),Zt(S.length),R(S),v).subarray(),t.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',Br,e,v.byteLength),c=!0,l=!1,u.resolve(),m().catch(A=>{t.log.error("could not finish optimistic protocol negotiation of %s",e,A)})}x=!0}x||await m()}())};async function m(){if(i){t.log.trace("optimistic: already negotiating %s stream",e),await a.promise;return}i=!0;try{c||(t.log.trace("optimistic: doing send protocol for %s stream",e),await y()),f||(t.log.trace("optimistic: doing read protocol for %s stream",e),await b())}finally{i=!1,o=!0,a.resolve()}}async function y(){if(l){await u.promise;return}l=!0;try{t.log.trace('optimistic: write ["%s", "%s", data] in source',Br,e),await p.writeV([R(`${Br}
`),R(`${e}
`)]),t.log.trace('optimistic: wrote ["%s", "%s", data] in source',Br,e)}finally{c=!0,l=!1,u.resolve()}}async function b(){if(h){await d.promise;return}h=!0;try{t.log.trace("optimistic: reading multistream select header");let w=await Xa(p,t);if(t.log.trace('optimistic: read multistream select header "%s"',w),w===Br&&(w=await Xa(p,t)),t.log.trace('optimistic: read protocol "%s", expecting "%s"',w,e),w!==e)throw new g("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}finally{f=!0,h=!1,d.resolve()}}if(r.source=async function*(){await m(),t.log.trace('optimistic: reading data from "%s" stream',e),yield*p.unwrap().source}(),r.closeRead!=null){let w=r.closeRead.bind(r);r.closeRead=async E=>{o||await m().catch(x=>{t.log.error("could not negotiate protocol before close read",x)}),await w(E)}}if(r.closeWrite!=null){let w=r.closeWrite.bind(r);r.closeWrite=async E=>{o||await m().catch(x=>{t.log.error("could not negotiate protocol before close write",x)}),await w(E)}}if(r.close!=null){let w=r.close.bind(r);r.close=async E=>{let x=[];l&&x.push(u.promise),h&&x.push(d.promise),x.length>0?await nn(Promise.all(x),E?.signal):(o=!0,i=!1,a.resolve()),await w(E)}}return{stream:r,protocol:e}}async function Zd(r,e,t){e=Array.isArray(e)?e:[e],t.log.trace("handle: available protocols %s",e);let n=io(r,{...t,maxDataLength:1024,maxLengthLength:2});for(;;){t.log.trace("handle: reading incoming string");let s=await Xa(n,t);if(t.log.trace('handle: read "%s"',s),s===Br){t.log.trace('handle: respond with "%s" for "%s"',Br,s),await xl(n,R(`${Br}
`),t),t.log.trace('handle: responded with "%s" for "%s"',Br,s);continue}if(e.includes(s))return t.log.trace('handle: respond with "%s" for "%s"',s,s),await xl(n,R(`${s}
`),t),t.log.trace('handle: responded with "%s" for "%s"',s,s),{stream:n.unwrap(),protocol:s};if(s==="ls"){let o=new ke(...e.map(i=>sr.single(R(`${i}
`))),R(`
`));t.log.trace('handle: respond with "%s" for %s',e,s),await xl(n,o,t),t.log.trace('handle: responded with "%s" for %s',e,s);continue}t.log('handle: respond with "na" for "%s"',s),await xl(n,R(`na
`),t),t.log('handle: responded with "na" for "%s"',s)}}var Cue=500,Kv=class{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;transient;log;tags;_newStream;_close;_abort;_getStreams;constructor(e){let{remoteAddr:t,remotePeer:n,newStream:s,close:o,abort:i,getStreams:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.transient=e.transient??!1,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=s,this._close=o,this._abort=i,this._getStreams=a,this.tags=[]}[Symbol.toStringTag]="Connection";[z9]=!0;get streams(){return this._getStreams()}async newStream(e,t){if(this.status==="closing")throw new g("the connection is being closed","ERR_CONNECTION_BEING_CLOSED");if(this.status==="closed")throw new g("the connection is closed","ERR_CONNECTION_CLOSED");if(Array.isArray(e)||(e=[e]),this.transient&&t?.runOnTransientConnection!==!0)throw new g("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");let n=await this._newStream(e,t);return n.direction="outbound",n}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",e.signal==null){let t=AbortSignal.timeout(Cue);Ze(1/0,t),e={...e,signal:t}}try{this.log.trace("closing all streams"),await Promise.all(this.streams.map(async t=>t.close(e))),this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this.streams.forEach(t=>{t.abort(e)}),this.log.error("all streams aborted",this.streams.length),this._abort(e),this.timeline.close=Date.now(),this.status="closed"}};function FF(r){return new Kv(r)}var Nue=3e4;function Lue(r,e){try{let{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.code!==pe.ERR_NO_HANDLER_FOR_PROTOCOL)throw t}return Lv}function Oue(r,e,t={}){try{let{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.code!==pe.ERR_NO_HANDLER_FOR_PROTOCOL)throw n}return t.maxOutboundStreams??Ov}function VF(r,e,t){let n=0;return t.streams.forEach(s=>{s.direction===e&&s.protocol===r&&n++}),n}var u3=class{components;connectionEncryption;muxers;inboundUpgradeTimeout;events;constructor(e,t){this.components=e,this.connectionEncryption=new Map,t.connectionEncryption.forEach(n=>{this.connectionEncryption.set(n.protocol,n)}),this.muxers=new Map,t.muxers.forEach(n=>{this.muxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??3e4,this.events=e.events}async shouldBlockConnection(e,t,n){let s=this.components.connectionGater[n];if(s!==void 0&&await s(e,t))throw new g(`The multiaddr connection is blocked by gater.${n}`,pe.ERR_CONNECTION_INTERCEPTED)}async upgradeInbound(e,t){if(!await this.components.connectionManager.acceptIncomingConnection(e))throw new g("connection denied",pe.ERR_CONNECTION_DENIED);let s,o,i,a,c,l=AbortSignal.timeout(this.inboundUpgradeTimeout),u=()=>{e.abort(new g("inbound upgrade timeout",Fo))};l.addEventListener("abort",u,{once:!0}),Ze(1/0,l);try{if(await this.components.connectionGater.denyInboundConnection?.(e)===!0)throw new g("The multiaddr connection is blocked by gater.acceptConnection",pe.ERR_CONNECTION_INTERCEPTED);this.components.metrics?.trackMultiaddrConnection(e),e.log("starting the inbound connection upgrade");let f=e;if(t?.skipProtection!==!0){let h=this.components.connectionProtector;h!=null&&(e.log("protecting the inbound connection"),f=await h.protect(e))}try{if(s=f,t?.skipEncryption!==!0){({conn:s,remotePeer:o,protocol:c}=await this._encryptInbound(f));let h={...f,...s};await this.shouldBlockConnection(o,h,"denyInboundEncryptedConnection")}else{let h=e.remoteAddr.getPeerId();if(h==null)throw new g("inbound connection that skipped encryption must have a peer id",pe.ERR_INVALID_MULTIADDR);let d=Ce(h);c="native",o=d}if(i=s,t?.muxerFactory!=null)a=t.muxerFactory;else if(this.muxers.size>0){let h=await this._multiplexInbound({...f,...s},this.muxers);a=h.muxerFactory,i=h.stream}}catch(h){throw e.log.error("failed to upgrade inbound connection",h),h}return await this.shouldBlockConnection(o,e,"denyInboundUpgradedConnection"),e.log("successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:c,direction:"inbound",maConn:e,upgradedConn:i,muxerFactory:a,remotePeer:o,transient:t?.transient})}finally{l.removeEventListener("abort",u),this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){let n=e.remoteAddr.getPeerId(),s;n!=null&&(s=Ce(n),await this.shouldBlockConnection(s,e,"denyOutboundConnection"));let o,i,a,c,l;this.components.metrics?.trackMultiaddrConnection(e),e.log("starting the outbound connection upgrade");let u=e;if(t?.skipProtection!==!0){let f=this.components.connectionProtector;f!=null&&(u=await f.protect(e))}try{if(o=u,t?.skipEncryption!==!0){({conn:o,remotePeer:i,protocol:c}=await this._encryptOutbound(u,s));let f={...u,...o};await this.shouldBlockConnection(i,f,"denyOutboundEncryptedConnection")}else{if(s==null)throw new g("Encryption was skipped but no peer id was passed",pe.ERR_INVALID_PEER);c="native",i=s}if(a=o,t?.muxerFactory!=null)l=t.muxerFactory;else if(this.muxers.size>0){let f=await this._multiplexOutbound({...u,...o},this.muxers);l=f.muxerFactory,a=f.stream}}catch(f){throw e.log.error("failed to upgrade outbound connection",f),await e.close(f),f}return await this.shouldBlockConnection(i,e,"denyOutboundUpgradedConnection"),e.log("successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:c,direction:"outbound",maConn:e,upgradedConn:a,muxerFactory:l,remotePeer:i,transient:t?.transient})}_createConnection(e){let{cryptoProtocol:t,direction:n,maConn:s,upgradedConn:o,remotePeer:i,muxerFactory:a,transient:c}=e,l,u,f;a!=null&&(l=a.createStreamMuxer({direction:n,onIncomingStream:p=>{f!=null&&Promise.resolve().then(async()=>{let m=this.components.registrar.getProtocols(),{stream:y,protocol:b}=await Zd(p,m,{log:p.log,yieldBytes:!1});if(f==null)return;f.log("incoming stream opened on %s",b);let w=Lue(b,this.components.registrar);if(VF(b,"inbound",f)===w){let x=new g(`Too many inbound protocol streams for protocol "${b}" - limit ${w}`,pe.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS);throw p.abort(x),x}p.source=y.source,p.sink=y.sink,p.protocol=b,y.closeWrite!=null&&(p.closeWrite=y.closeWrite),y.closeRead!=null&&(p.closeRead=y.closeRead),y.close!=null&&(p.close=y.close),await this.components.peerStore.merge(i,{protocols:[b]}),this.components.metrics?.trackProtocolStream(p,f),this._onStream({connection:f,stream:p,protocol:b})}).catch(async m=>{f.log.error("error handling incoming stream id %s",p.id,m.message,m.code,m.stack),p.timeline.close==null&&await p.close()})}}),u=async(p,m={})=>{if(l==null)throw new g("Stream is not multiplexed",pe.ERR_MUXER_UNAVAILABLE);f.log("starting new stream for protocols %s",p);let y=await l.newStream();f.log.trace("started new stream %s for protocols %s",y.id,p);try{if(m.signal==null){y.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",p);let v=AbortSignal.timeout(Nue);Ze(1/0,v),m={...m,signal:v}}y.log.trace("selecting protocol from protocols %s",p);let{stream:b,protocol:w}=await Jd(y,p,{...m,log:y.log,yieldBytes:!0});y.log("selected protocol %s",w);let E=Oue(w,this.components.registrar,m);if(VF(w,"outbound",f)>=E){let v=new g(`Too many outbound protocol streams for protocol "${w}" - limit ${E}`,pe.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw y.abort(v),v}return await this.components.peerStore.merge(i,{protocols:[w]}),y.source=b.source,y.sink=b.sink,y.protocol=w,b.closeWrite!=null&&(y.closeWrite=b.closeWrite),b.closeRead!=null&&(y.closeRead=b.closeRead),b.close!=null&&(y.close=b.close),this.components.metrics?.trackProtocolStream(y,f),y}catch(b){throw f.log.error("could not create new stream for protocols %s",p,b),y.timeline.close==null&&y.abort(b),b.code!=null?b:new g(String(b),pe.ERR_UNSUPPORTED_PROTOCOL)}},Promise.all([l.sink(o.source),o.sink(l.source)]).catch(p=>{f.log.error("error piping data through muxer",p)}));let h=s.timeline;s.timeline=new Proxy(h,{set:(...p)=>(f!=null&&p[1]==="close"&&p[2]!=null&&h.close==null&&(async()=>{try{f.status==="open"&&await f.close()}catch(m){f.log.error("error closing connection after timeline close",m)}finally{this.events.safeDispatchEvent("connection:close",{detail:f})}})().catch(m=>{f.log.error("error thrown while dispatching connection:close event",m)}),Reflect.set(...p))}),s.timeline.upgraded=Date.now();let d=()=>{throw new g("connection is not multiplexed",pe.ERR_CONNECTION_NOT_MULTIPLEXED)};return f=FF({remoteAddr:s.remoteAddr,remotePeer:i,status:"open",direction:n,timeline:s.timeline,multiplexer:l?.protocol,encryption:t,transient:c,logger:this.components.logger,newStream:u??d,getStreams:()=>l!=null?l.streams:[],close:async p=>{l!=null&&(f.log.trace("close muxer"),await l.close(p)),f.log.trace("close maconn"),await s.close(p),f.log.trace("closed maconn")},abort:p=>{s.abort(p),l?.abort(p)}}),this.events.safeDispatchEvent("connection:open",{detail:f}),f}_onStream(e){let{connection:t,stream:n,protocol:s}=e,{handler:o,options:i}=this.components.registrar.getHandler(s);if(t.transient&&i.runOnTransientConnection!==!0)throw new g("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");o({connection:t,stream:n})}async _encryptInbound(e){let t=Array.from(this.connectionEncryption.keys());e.log("handling inbound crypto protocol selection",t);try{let{stream:n,protocol:s}=await Zd(e,t,{log:e.log}),o=this.connectionEncryption.get(s);if(o==null)throw new Error(`no crypto module found for ${s}`);return e.log("encrypting inbound connection using",s),{...await o.secureInbound(this.components.peerId,n),protocol:s}}catch(n){throw e.log.error("encrypting inbound connection to %p failed",n),new g(n.message,pe.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(e,t){let n=Array.from(this.connectionEncryption.keys());e.log("selecting outbound crypto protocol",n);try{e.log.trace("selecting encrypter from %s",n);let{stream:s,protocol:o}=await Jd(e,n,{log:e.log,yieldBytes:!0}),i=this.connectionEncryption.get(o);if(i==null)throw new Error(`no crypto module found for ${o}`);return e.log("encrypting outbound connection to %p using %p",t),{...await i.secureOutbound(this.components.peerId,s,t),protocol:o}}catch(s){throw e.log.error("encrypting outbound connection to %p failed",s),new g(s.message,pe.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(e,t){let n=Array.from(t.keys());e.log("outbound selecting muxer %s",n);try{e.log.trace("selecting stream muxer from %s",n);let{stream:s,protocol:o}=await Jd(e,n,{log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",o);let i=t.get(o);return{stream:s,muxerFactory:i}}catch(s){throw e.log.error("error multiplexing outbound connection",s),new g(String(s),pe.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(e,t){let n=Array.from(t.keys());e.log("inbound handling muxers %s",n);try{let{stream:s,protocol:o}=await Zd(e,n,{log:e.log}),i=t.get(o);return{stream:s,muxerFactory:i}}catch(s){throw e.log.error("error multiplexing inbound connection",s),new g(String(s),pe.ERR_MUXER_UNAVAILABLE)}}};var Mv=class extends je{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";let t=new je,n=t.dispatchEvent.bind(t);t.dispatchEvent=a=>{let c=n(a),l=this.dispatchEvent(new Dt(a.type,{detail:a.detail}));return c||l},Ze(1/0,t),this.peerId=e.peerId,this.logger=e.logger??Dl(),this.log=this.logger.forComponent("libp2p"),this.services={};let s=this.components=IF({peerId:e.peerId,nodeInfo:e.nodeInfo??{name:Ng,version:Bg},logger:this.logger,events:t,datastore:e.datastore??new rc,connectionGater:TF(e.connectionGater)});this.peerStore=this.configureComponent("peerStore",new Gg(s,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),s.events.addEventListener("peer:update",a=>{if(a.detail.previous==null){let c={id:a.detail.peer.id,multiaddrs:a.detail.peer.addresses.map(l=>l.multiaddr)};s.events.safeDispatchEvent("peer:discovery",{detail:c})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(s)),this.components.upgrader=new u3(this.components,{connectionEncryption:(e.connectionEncryption??[]).map((a,c)=>this.configureComponent(`connection-encryption-${c}`,a(this.components))),muxers:(e.streamMuxers??[]).map((a,c)=>this.configureComponent(`stream-muxers-${c}`,a(this.components))),inboundUpgradeTimeout:e.connectionManager.inboundUpgradeTimeout}),this.configureComponent("transportManager",new c3(this.components,e.transportManager)),this.configureComponent("connectionManager",new s3(this.components,e.connectionManager)),this.configureComponent("registrar",new a3(this.components)),this.configureComponent("addressManager",new Wg(this.components,e.addresses));let o=(e.peerRouters??[]).map((a,c)=>this.configureComponent(`peer-router-${c}`,a(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new i3(this.components,{routers:o}));let i=(e.contentRouters??[]).map((a,c)=>this.configureComponent(`content-router-${c}`,a(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new o3(this.components,{routers:i})),(e.peerDiscovery??[]).forEach((a,c)=>{this.configureComponent(`peer-discovery-${c}`,a(this.components)).addEventListener("peer",u=>{this.#e(u)})}),e.transports?.forEach((a,c)=>{this.components.transportManager.add(this.configureComponent(`transport-${c}`,a(this.components)))}),e.services!=null)for(let a of Object.keys(e.services)){let c=e.services[a],l=c(this.components);if(l==null){this.log.error("service factory %s returned null or undefined instance",a);continue}this.services[a]=l,this.configureComponent(a,l),l[kh]!=null&&(this.log("registering service %s for content routing",a),i.push(l[kh])),l[Dh]!=null&&(this.log("registering service %s for peer routing",a),o.push(l[Dh])),l[oc]!=null&&(this.log("registering service %s for peer discovery",a),l[oc].addEventListener?.("peer",u=>{this.#e(u)}))}}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){let e=new cr;for(let t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(t==null)throw new g("no protocols were provided to open a stream",pe.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(t=Array.isArray(t)?t:[t],t.length===0)throw new g("no protocols were provided to open a stream",pe.ERR_INVALID_PROTOCOLS_FOR_STREAM);return(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){Ra(e)&&(e=Ce(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{let o=await this.peerStore.get(e);if(o.id.publicKey!=null)return o.id.publicKey}catch(o){if(o.code!==pe.ERR_NOT_FOUND)throw o}let n=le([R("/pk/"),e.multihash.digest]),s=await this.contentRouting.get(n,t);return vF(s),await this.peerStore.patch(e,{publicKey:s}),s}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async s=>{await this.components.registrar.handle(s,t,n)}))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async t=>{await this.components.registrar.unhandle(t)}))}async register(e,t){return this.components.registrar.register(e,t)}unregister(e){this.components.registrar.unregister(e)}#e(e){let{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error(new Error(pe.ERR_DISCOVERED_SELF));return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(n=>{this.log.error(n)})}};async function qF(r={}){return r.peerId??=await Gm(),new Mv(LF(r))}async function HF(r={}){let e=await qF(r);return r.start!==!1&&await e.start(),e}async function zF(r){let e=r.libp2p?.peerId,t=r.logger??Dl();if(e==null){let s=rg(r.keychain)({datastore:r.datastore,logger:t}),o=new ct("/pkcs8/self");await r.datastore.has(o)&&(e=await s.exportPeerId("self"))}let n=Lg(r);return r=r??{},HF({...n,...r.libp2p,start:!1})}async function Kue(r={}){let e=r.datastore??new rc,t=r.blockstore??new xh,n;Mue(r.libp2p)?n=r.libp2p:n=await zF({...r,libp2p:r.libp2p,datastore:e});let s=new n1({...r,libp2p:n,datastore:e,blockstore:t});return r.start!==!1&&await s.start(),s}function Mue(r){return r==null?!1:["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every(t=>typeof r[t]=="function")}return t0(Uue);})();
/*! Bundled license information:

pvtsutils/build/index.js:
  (*!
   * MIT License
   * 
   * Copyright (c) 2017-2022 Peculiar Ventures, LLC
   * 
   * Permission is hereby granted, free of charge, to any person obtaining a copy
   * of this software and associated documentation files (the "Software"), to deal
   * in the Software without restriction, including without limitation the rights
   * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   * copies of the Software, and to permit persons to whom the Software is
   * furnished to do so, subject to the following conditions:
   * 
   * The above copyright notice and this permission notice shall be included in all
   * copies or substantial portions of the Software.
   * 
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   * SOFTWARE.
   * 
   *)

@noble/hashes/esm/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/utils.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/modular.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/curve.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/edwards.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/montgomery.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/ed25519.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/weierstrass.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/_shortw_utils.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

pvutils/build/utils.es.js:
  (*!
   Copyright (c) Peculiar Ventures, LLC
  *)

asn1js/build/index.es.js:
  (*!
   * Copyright (c) 2014, GMO GlobalSign
   * Copyright (c) 2015-2022, Peculiar Ventures
   * All rights reserved.
   * 
   * Author 2014-2019, Yury Strozhevsky
   * 
   * Redistribution and use in source and binary forms, with or without modification,
   * are permitted provided that the following conditions are met:
   * 
   * * Redistributions of source code must retain the above copyright notice, this
   *   list of conditions and the following disclaimer.
   * 
   * * Redistributions in binary form must reproduce the above copyright notice, this
   *   list of conditions and the following disclaimer in the documentation and/or
   *   other materials provided with the distribution.
   * 
   * * Neither the name of the copyright holder nor the names of its
   *   contributors may be used to endorse or promote products derived from
   *   this software without specific prior written permission.
   * 
   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
   * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
   * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
   * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
   * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
   * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
   * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
   * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
   * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
   * 
   *)

@noble/ciphers/esm/utils.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)

@libp2p/webtransport/dist/src/index.js:
  (*! TODO unclear how to add backpressure here? *)
*/
return Helia}));
